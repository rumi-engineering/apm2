# APM2 Restricted Policy
#
# A highly restrictive policy for security-sensitive environments.
# This policy provides minimal permissions and is suitable for
# auditing or reviewing code without allowing modifications.
#
# Use this policy when you want maximum safety at the cost of
# functionality.

policy:
  version: "1.0.0"
  name: "apm2-restricted"
  description: "Highly restrictive read-only policy"

  rules:
    # ========================================================================
    # FILESYSTEM RULES - Read Only
    # ========================================================================

    # Allow reading from workspace only
    - id: "fs-read-workspace"
      type: filesystem
      paths:
        - "./**"
      decision: allow
      reason: "Allow reading workspace files only"
      rationale_code: "RESTRICTED_FS_READ"

    # ========================================================================
    # TOOL RULES - Read Only
    # ========================================================================

    # Allow read-only filesystem operations
    - id: "tool-fs-read"
      type: tool_allow
      tool: "fs.read"
      paths:
        - "./**"
      decision: allow
      rationale_code: "RESTRICTED_FS_READ_TOOL"

    # Allow glob/search operations
    - id: "tool-fs-glob"
      type: tool_allow
      tool: "fs.glob"
      paths:
        - "./**"
      decision: allow

    # Allow grep/search operations
    - id: "tool-fs-grep"
      type: tool_allow
      tool: "fs.grep"
      paths:
        - "./**"
      decision: allow

    # Explicitly deny all write operations
    - id: "deny-fs-write"
      type: tool_deny
      tool: "fs.write"
      decision: deny
      rationale_code: "RESTRICTED_NO_WRITE"

    - id: "deny-fs-edit"
      type: tool_deny
      tool: "fs.edit"
      decision: deny
      rationale_code: "RESTRICTED_NO_EDIT"

    # Deny shell execution
    - id: "deny-shell"
      type: tool_deny
      tool: "shell.exec"
      decision: deny
      rationale_code: "RESTRICTED_NO_SHELL"

    # ========================================================================
    # NETWORK RULES - Deny All
    # ========================================================================

    # Network access is completely disabled in restricted mode
    # (Handled by default_decision: deny)

    # ========================================================================
    # BUDGET RULES - Minimal
    # ========================================================================

    # Minimal token budget (10K tokens)
    - id: "budget-tokens"
      type: budget
      budget_type: token
      limit: 10000
      decision: allow
      reason: "Minimal token budget for analysis"

    # Short time budget (15 minutes)
    - id: "budget-time"
      type: budget
      budget_type: time
      limit: 900000
      decision: allow
      reason: "Short time budget (15 minutes)"

    # Low tool call budget (100 calls)
    - id: "budget-tool-calls"
      type: budget
      budget_type: tool_calls
      limit: 100
      decision: allow
      reason: "Minimal tool call budget"

    # ========================================================================
    # SECRETS RULES - Deny All
    # ========================================================================

    - id: "deny-secrets"
      type: secrets
      decision: deny
      rationale_code: "RESTRICTED_NO_SECRETS"

    # ========================================================================
    # INFERENCE RULES - Limited
    # ========================================================================

    - id: "inference-limited"
      type: inference
      decision: allow
      reason: "Allow limited inference for analysis"
      rationale_code: "RESTRICTED_INFERENCE"

  # Default decision: DENY everything not explicitly allowed
  default_decision: deny

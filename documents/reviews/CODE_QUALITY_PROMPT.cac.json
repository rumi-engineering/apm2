{
  "schema": "apm2.review.prompt.v1",
  "schema_version": "2.0.0",
  "kind": "review.executable_prompt",
  "meta": {
    "stable_id": "dcp://apm2.review/prompt/code-quality-review@2",
    "status": "ACTIVE",
    "classification": "INTERNAL",
    "owners": ["engineering"],
    "provenance": {
      "actor_id": "HOLON-ENGINEERING-GOVERNANCE",
      "work_id": "TCK-00605-REVIEW-PROMPT-REFACTOR",
      "source_receipts": []
    }
  },
  "payload": {
    "title": "Code Quality Review Prompt",
    "protocol": {
      "id": "CODE-QUALITY-REVIEW",
      "version": "4.0.0",
      "type": "executable_specification",
      "purpose": "Evaluate PR code quality from FAC-prepared local inputs, emit structured findings, and set a verdict. The CLI manages all SHA binding and state — the reviewer focuses exclusively on analysis."
    },
    "inputs": ["OPTIONAL_CONTEXT"],
    "outputs": ["FindingsProjection", "DecisionProjection"],
    "commands": {
      "description": "The reviewer uses exactly 3 CLI commands via `cargo run -p apm2-cli --`. This ensures the workspace-built binary is used, not a stale global install. No other commands are needed.",
      "binary_prefix": "cargo run -p apm2-cli --",
      "prepare": "cargo run -p apm2-cli -- fac review prepare --json",
      "finding": "cargo run -p apm2-cli -- fac review finding --type code-quality --severity <BLOCKER|MAJOR|MINOR|NIT> --summary \"...\" --risk \"...\" --impact \"...\" --location \"...\" --body \"...\" --json",
      "verdict": "cargo run -p apm2-cli -- fac review verdict set --dimension code-quality --verdict <approve|deny> --reason \"...\" --json"
    },
    "constraints": {
      "forbidden_operations": [
        "NEVER use bare `apm2` — always use `cargo run -p apm2-cli --` so the workspace-built binary is used.",
        "NEVER pass --sha to any command. The CLI auto-derives the SHA from the PR identity.",
        "All interactions with the repository MUST be read-only. Do not modify any files.",
        "NEVER paste raw command output into finding fields (summary, risk, impact, body). Finding fields must contain your original analysis text only."
      ],
      "invariants": [
        {
          "id": "INV-CQ-001",
          "description": "Every execution path MUST terminate with exactly one verdict set call.",
          "criticality": "PROCESS"
        },
        {
          "id": "INV-CQ-002",
          "description": "SHA is managed by the CLI — the reviewer never tracks, stores, or references it.",
          "criticality": "PROCESS"
        },
        {
          "id": "INV-CQ-003",
          "description": "ALWAYS use `cargo run -p apm2-cli --` instead of bare `apm2`. The workspace binary contains the code under review; a globally installed binary may be stale and missing fields or fixes from the current PR.",
          "criticality": "PROCESS"
        },
        {
          "id": "INV-CQ-004",
          "description": "Deployment invariant: this CLI serves Anveio on the current VPS only; do NOT file compatibility findings that require broad enterprise/custom-remote support or GitHub-as-authority fallback.",
          "criticality": "PROCESS"
        },
        {
          "id": "INV-CQ-005",
          "description": "Backwards compatibility is expressly and intentionally NEVER required unless specifically called out as a requirement in a work object. Do NOT file findings for missing backwards-compat shims, re-exports, deprecated aliases, or migration paths unless a linked ticket or RFC explicitly mandates them.",
          "criticality": "PROCESS"
        },
        {
          "id": "INV-CQ-006",
          "description": "Do NOT run or check cargo fmt, clippy, cargo test, or cargo doc. All code under FAC review has already passed every automated gate (fmt, clippy -D warnings, test, doc) before reaching the reviewer. These are verified automatically and are never part of the code quality review scope. Spend zero time on formatting, lint, or test-execution concerns — focus exclusively on semantic analysis.",
          "criticality": "PROCESS"
        }
      ]
    },
    "references": [
      {"path": "@documents/theory/unified-theory-v2.json", "purpose": "Holonic model, truth/projection split, and verification-first behavior."},
      {"path": "@AGENTS.md", "purpose": "Global repository instructions."},
      {"path": "@documents/security/SECURITY_POLICY.cac.json", "purpose": "Cross-cutting policy guardrails."},
      {"path": "@documents/skills/rust-standards/references/06_triage_fast_scan.md", "purpose": "Fast triage procedure."},
      {"path": "@documents/skills/rust-standards/references/08_invariant_mapping.md", "purpose": "Invariant and contract mapping."},
      {"path": "@documents/skills/rust-standards/references/10_abstraction_and_simplification.md", "purpose": "Complexity reduction checks."},
      {"path": "@documents/skills/rust-standards/references/16_error_handling_and_panic_policy.md", "purpose": "Error handling expectations."},
      {"path": "@documents/skills/rust-standards/references/18_api_design_and_semver.md", "purpose": "Public API compatibility and ergonomics."},
      {"path": "@documents/skills/rust-standards/references/20_testing_evidence_and_ci.md", "purpose": "Test sufficiency expectations."},
      {"path": "@documents/skills/rust-standards/references/22_performance_review.md", "purpose": "Performance regressions and hotspots."},
      {"path": "@documents/skills/rust-standards/references/24_dependency_and_build_surface.md", "purpose": "Dependency and build-surface scrutiny."},
      {"path": "@documents/skills/rust-standards/references/26_severity_and_verdict.md", "purpose": "Severity calibration."},
      {"path": "@documents/skills/rust-standards/references/28_required_actions_templates.md", "purpose": "Finding statement quality."},
      {"path": "@documents/skills/rust-standards/references/01_contract_and_truth.md", "purpose": "Primitive soundness invariants (type validity, initialization, alignment, data races)."},
      {"path": "@documents/skills/rust-standards/references/07_core_language_semantics.md", "purpose": "Place model, move semantics, drop scopes, temporary lifetimes, pattern binding modes."},
      {"path": "@documents/skills/rust-standards/references/09_ownership_borrowing_model.md", "purpose": "Ownership authority, interior mutability protocols, borrow-across-await hazards."},
      {"path": "@documents/skills/rust-standards/references/11_lifetimes_variance_hrtb.md", "purpose": "Variance and auto-trait observability; PhantomData and Pin contracts."},
      {"path": "@documents/skills/rust-standards/references/13_traits_generics_coherence.md", "purpose": "Coherence rules; trait bound SemVer impacts; auto-trait drift detection."},
      {"path": "@documents/skills/rust-standards/references/14_allocator_arena_pool_review.md", "purpose": "Five allocator invariants: UAF, double-free, alignment, overlap, drop discipline."},
      {"path": "@documents/skills/rust-standards/references/15_errors_panics_diagnostics.md", "purpose": "Panic safety, unwind discipline, structured logging, lint policy enforcement."},
      {"path": "@documents/skills/rust-standards/references/17_layout_repr_drop.md", "purpose": "Repr contracts, layout stability, drop discipline, partial initialization."},
      {"path": "@documents/skills/rust-standards/references/25_api_design_stdlib_quality.md", "purpose": "Misuse-resistant APIs: visibility, construction validation, borrowed vs owned."},
      {"path": "@documents/skills/rust-standards/references/27_collections_allocation_models.md", "purpose": "Use-after-realloc prevention, size math overflow, bounded stores, deterministic iteration."},
      {"path": "@documents/skills/rust-standards/references/29_unicode_text_graphemes.md", "purpose": "UTF-8 validity, text units, grapheme policies, confusable prevention."},
      {"path": "@documents/skills/rust-standards/references/33_performance_measurement.md", "purpose": "Performance contracts, benchmark methodology, code-size/monomorphization control."},
      {"path": "@documents/skills/rust-standards/references/35_cfg_features_build_matrix.md", "purpose": "Dark-code control, build matrix coverage, feature stability, fail-closed flags."},
      {"path": "@documents/skills/rust-standards/references/37_macros_buildscripts_proc_macros.md", "purpose": "Macro hygiene, hidden unsafe prevention, build-time execution control."},
      {"path": "@documents/skills/rust-standards/references/40_time_monotonicity_determinism.md", "purpose": "Monotonic clocks, wall-clock hazards, distributed ordering, defensive duration handling."},
      {"path": "@documents/skills/rust-standards/references/41_apm2_safe_patterns_and_anti_patterns.md", "purpose": "APM2-specific: typed IDs, secret redaction, state machines, atomic writes, identity boundaries."},
      {"path": "@documents/skills/rust-standards/references/03_compilation_pipeline.md", "purpose": "Phase-aware reasoning; macro expansion, dark code, drop/borrow checking semantics."},
      {"path": "@documents/skills/rust-standards/references/04_qcp_classification.md", "purpose": "QCP risk escalation and proof-burden multiplier logic."},
      {"path": "@documents/skills/rust-standards/references/00_operating_mode.md", "purpose": "Rust-standards operating mode and review posture."},
      {"path": "@documents/skills/rust-standards/references/02_inputs_and_stop_conditions.md", "purpose": "Review inputs, stop conditions, and triage policy."},
      {"path": "@documents/skills/rust-standards/references/05_toolchain_cargo_build.md", "purpose": "Toolchain contracts (CTR-02XX), build reproducibility, dependency resolution invariants."},
      {"path": "@documents/skills/rust-standards/references/12_rust_soundness_and_unsafe.md", "purpose": "Unsafe soundness obligations (UNSAFE-*), proof-of-safety comment contracts, lint discipline."},
      {"path": "@documents/skills/rust-standards/references/19_unsafe_rust_obligations.md", "purpose": "Comprehensive unsafe invariants (INV-0001..INV-0903), aliasing/provenance/drop contracts."},
      {"path": "@documents/skills/rust-standards/references/21_concurrency_atomics_memory_order.md", "purpose": "Concurrency contracts (CTR-10XX), atomic ordering, lock discipline, data-race prevention."},
      {"path": "@documents/skills/rust-standards/references/23_async_pin_cancellation.md", "purpose": "Async/Pin contracts (CTR-11XX), cancellation safety, poll discipline."},
      {"path": "@documents/skills/rust-standards/references/30_paths_filesystem_os.md", "purpose": "Filesystem path contracts (CTR-15XX), symlink traversal, atomic write invariants."},
      {"path": "@documents/skills/rust-standards/references/31_io_protocol_boundaries.md", "purpose": "I/O boundary contracts (CTR-16XX), serde safety, protocol framing, trust boundaries."},
      {"path": "@documents/skills/rust-standards/references/32_testing_fuzz_miri_evidence.md", "purpose": "Testing evidence contracts (CTR-1701, INV-17XX), fuzz coverage, Miri obligations."},
      {"path": "@documents/skills/rust-standards/references/34_security_adjacent_rust.md", "purpose": "Security-adjacent contracts (CTR-19XX, RSK-19XX), secret handling, timing channels, webhook validation."},
      {"path": "@documents/skills/rust-standards/references/36_msrv_editions_maintenance.md", "purpose": "MSRV/edition contracts (CTR-21XX), edition migration discipline."},
      {"path": "@documents/skills/rust-standards/references/39_hazard_catalog_checklists.md", "purpose": "Cross-reference hazard catalog — comprehensive invariant index across all modules."},
      {"path": "@documents/skills/rust-standards/references/42_distributed_security_invariants.md", "purpose": "Distributed security invariants (CTR-27XX, INV-2701), consensus integrity, replication safety."},
      {"path": "@documents/skills/rust-standards/references/42_pcac_ajc_integration.md", "purpose": "PCAC/AJC integration patterns, authority continuity contracts."},
      {"path": "@documents/skills/rust-standards/references/43_apm2_scp_dcp_map.md", "purpose": "APM2 SCP/DCP mapping — system and domain context provider contracts."},
      {"path": "@documents/skills/rust-standards/references/44_deterministic_simulated_testing.md", "purpose": "Deterministic simulated testing — test isolation, reproducibility, nondeterminism elimination, side-effect capture, simulation harnesses."},
      {"path": "@documents/skills/modes-of-reasoning/assets/06-constraint-satisfiability.json", "purpose": "REQUIRED REASONING MODE: Encode invariants as constraints — verify all contracts and invariants still hold after the change."},
      {"path": "@documents/skills/modes-of-reasoning/assets/07-type-theoretic.json", "purpose": "REQUIRED REASONING MODE: Type-level reasoning — verify types encode the right invariants and invalid states cannot be constructed."},
      {"path": "@documents/skills/modes-of-reasoning/assets/08-counterexample-guided.json", "purpose": "REQUIRED REASONING MODE: Counterexample search — find concrete inputs or states that violate claimed properties."},
      {"path": "@documents/prompts/instruction.alien_coding.v1.json", "purpose": "Alien coding instruction set — exotic implementation patterns and constraints that may appear in reviewed code."}
    ],
    "decision_tree": {
      "entrypoint": "STEP_1_PREPARE",
      "nodes": [
        {
          "id": "STEP_1_PREPARE",
          "purpose": "Discover the CLI surface and materialize local review inputs.",
          "steps": [
            {"action": "command", "run": "cargo run -p apm2-cli -- fac review prepare --help"},
            {"action": "command", "run": "cargo run -p apm2-cli -- fac review finding --help"},
            {"action": "command", "run": "cargo run -p apm2-cli -- fac review verdict set --help"},
            {
              "action": "command",
              "run": "cargo run -p apm2-cli -- fac review prepare --json",
              "capture_as": "prepare_json"
            },
            {
              "action": "parse_json",
              "from": "prepare_json",
              "extract": ["pr_number", "diff_path", "commit_history_path", "diff_content", "commit_history_content"]
            },
            {
              "action": "on_failure",
              "if": "prepare command fails OR diff_path is empty",
              "then": "Jump to STEP_4_VERDICT with verdict=deny reason='prepare failed: no review inputs available'"
            }
          ],
          "next": "STEP_2_STUDY"
        },
        {
          "id": "STEP_2_STUDY",
          "purpose": "Internalize all reference material and PR context before analysis.",
          "steps": [
            {
              "action": "read_all_references",
              "rule": "Read every file listed in the references[] section IN FULL. Do not summarize, skip, or skim — details matter. Each reference contains invariants, contracts, checklists, and anti-patterns that are load-bearing for review accuracy. Incomplete internalization produces false negatives."
            },
            {"action": "use_captured", "from": "diff_content", "purpose": "Full PR diff from prepare output"},
            {"action": "use_captured", "from": "commit_history_content", "purpose": "Commit history from prepare output"},
            {
              "action": "read_module_agents",
              "rule": "For each crate/module touched by the PR diff, locate and read its AGENTS.md (if it exists) in full. These contain module-specific invariants [INV-*] and contracts [CTR-*] that the diff must preserve."
            },
            {
              "action": "read_ticket",
              "rule": "Identify the ticket ID from commit messages in $commit_history_path (convention: 'TCK-XXXXX: ...'). Read the ticket YAML at documents/work/tickets/TCK-XXXXX.yaml in full. Extract scope.in_scope (the delivery contract), scope.out_of_scope (hard boundaries), and definition_of_done.criteria (completion checklist). For each entry in binds.requirements, read the file at requirement_ref and extract acceptance_criteria. These form the requirements baseline for completeness checking in STEP_3."
            },
            {
              "action": "selective_read",
              "rule": "Read RFC/ticket/doc references linked from the ticket or touched files when necessary for intent verification."
            }
          ],
          "next": "STEP_3_ANALYZE_AND_EMIT"
        },
        {
          "id": "STEP_3_ANALYZE_AND_EMIT",
          "purpose": "Apply required reasoning modes to the diff, emit each finding immediately.",
          "modes_of_reasoning": {
            "instruction": "Apply ALL three modes below to every changed module, type, function, and invariant in the diff. The rust-standards references encode the specific quality dimensions — these modes tell you HOW to reason about them.",
            "modes": [
              {
                "mode": "documents/skills/modes-of-reasoning/assets/06-constraint-satisfiability.json",
                "apply": "For each changed function/module: enumerate the invariants and contracts (from AGENTS.md [INV-*], [CTR-*], type constraints, documented preconditions). Verify the change satisfies ALL constraints. If any constraint is violated or unverifiable, it is a finding."
              },
              {
                "mode": "documents/skills/modes-of-reasoning/assets/07-type-theoretic.json",
                "apply": "For each changed type, API, or constructor: verify types encode the right invariants. Can invalid states be constructed? Are newtypes used where semantic distinction matters? Are smart constructors enforcing validation? Unsealed invariants are findings."
              },
              {
                "mode": "documents/skills/modes-of-reasoning/assets/08-counterexample-guided.json",
                "apply": "For each claimed property (error handling, boundary checks, state transitions): actively search for a concrete input, state sequence, or edge case that violates it. If you find one, it is a finding. If you cannot find one after systematic search, the property is provisionally supported."
              }
            ]
          },
          "emit_rule": {
            "action": "For each finding, classify severity (BLOCKER, MAJOR, MINOR, NIT) and call:",
            "command": "cargo run -p apm2-cli -- fac review finding --type code-quality --severity <severity> --summary \"<one-line>\" --risk \"<why this matters>\" --impact \"<consequences if unaddressed>\" --location \"<file:line or module>\" --body \"<detailed description and required action>\" --json",
            "quality_rules": [
              "Each finding MUST include: summary, risk, impact, location, and body (required action).",
              "REQUIREMENTS COVERAGE: Check the diff against every in_scope item and definition_of_done criterion from the ticket. If a scope item is not addressed by the diff, or a DoD criterion has no supporting evidence in the change, emit a BLOCKER finding with summary 'Missing requirement: <item>' and body describing what is missing and what the ticket requires.",
              "For PCAC-integrated handlers, verify canonical lifecycle ordering and builder usage; flag manual join-input construction or lifecycle drift as findings.",
              "For prior-round findings that are now resolved, emit with --severity NIT and note the resolution in --body."
            ]
          },
          "tally": ["blocker_count", "major_count", "minor_count", "nit_count"],
          "next": "STEP_4_VERDICT"
        },
        {
          "id": "STEP_4_VERDICT",
          "purpose": "Set the verdict. This is the ONLY exit point — every execution path MUST reach this step.",
          "decisions": [
            {
              "if": "blocker_count == 0 AND major_count == 0",
              "then": {
                "action": "command",
                "run": "cargo run -p apm2-cli -- fac review verdict set --dimension code-quality --verdict approve --reason \"PASS: no blocker or major findings\" --json"
              }
            },
            {
              "if": "blocker_count > 0 OR major_count > 0",
              "then": {
                "action": "command",
                "run": "cargo run -p apm2-cli -- fac review verdict set --dimension code-quality --verdict deny --reason \"FAIL: <blocker_count> blocker, <major_count> major findings\" --json"
              }
            }
          ],
          "stop": true
        }
      ]
    }
  }
}

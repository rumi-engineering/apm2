prd_constraints_invariants:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  constraints:
    - id: CNS-COORD-0001
      statement: CoordinationReducer MUST NOT directly modify Work, Session, or Lease state.
      rationale: |
        Separation of concerns: each reducer owns its projection. Coordination reacts to
        events from other reducers and emits coordination-specific events. This preserves
        reducer invariants and enables independent evolution.
      enforcement: |
        Code review and architectural tests verify no cross-reducer state modification.
        Coordination only reads from other reducer projections and writes coordination events.
      evidence_ids:
        - EVID-COORD-0005
    - id: CNS-COORD-0002
      statement: Budget parameters (max_episodes, max_duration_ms) MUST be specified for every coordination.
      rationale: |
        No coordination can run indefinitely. Budget ceiling is a safety invariant that
        prevents resource exhaustion regardless of work queue size or failure patterns.
      enforcement: |
        CLI and controller validate budget presence before coordination start.
        Missing budget causes immediate failure with clear error message.
      evidence_ids:
        - EVID-COORD-0003
    - id: CNS-COORD-0003
      statement: Serial execution only - at most one active session per coordination in MVP.
      rationale: |
        Parallel execution adds complexity around resource contention, failure isolation,
        and budget allocation. Serial execution is simpler to reason about and verify.
      enforcement: |
        Controller spawns next session only after current session terminates.
        State machine enforces single-session constraint.
      evidence_ids:
        - EVID-COORD-0006
    - id: CNS-COORD-0004
      statement: All coordination events MUST include coordination_id for correlation.
      rationale: |
        Event correlation is essential for state reconstruction and debugging.
        coordination_id links all events in a coordination to a single execution context.
      enforcement: |
        Event schema requires coordination_id field.
        Reducer rejects events missing coordination_id.
      evidence_ids:
        - EVID-COORD-0005
    - id: CNS-COORD-0005
      statement: Work freshness check MUST use ledger event ordering for consistency.
      rationale: |
        Event ordering provides consistent view across reducers. Checking work state
        via projection could miss in-flight events.
      enforcement: |
        Controller checks work state at known event sequence number.
        Spawn only proceeds if work state valid at that sequence.
      evidence_ids:
        - EVID-COORD-0004
  invariants:
    - id: INV-COORD-0001
      statement: CoordinationReducer is deterministic and idempotent.
      rationale: |
        Given the same event sequence, reducer produces the same state. This enables
        replay, checkpointing, and state verification.
      enforcement: |
        Property tests compare replay-from-genesis with replay-from-checkpoint.
        Golden event sequences committed for determinism verification.
      evidence_ids:
        - EVID-COORD-0005
    - id: INV-COORD-0002
      statement: Every session spawned by coordination is bound before spawn and unbound after termination.
      rationale: |
        Binding lifecycle must be complete. Orphan bindings indicate state corruption.
        Every bound session must eventually be unbound.
      enforcement: |
        Controller emits coordination.session_bound before spawn request.
        Controller emits coordination.session_unbound on session termination event.
        Reducer tracks binding count for verification.
      evidence_ids:
        - EVID-COORD-0006
    - id: INV-COORD-0003
      statement: Budget consumption is monotonically increasing and never exceeds ceiling.
      rationale: |
        Budget cannot decrease during coordination. Ceiling enforcement is safety-critical.
      enforcement: |
        Budget tracked as consumed_episodes, elapsed_ms, consumed_tokens.
        Each increment validated against ceiling before commit.
        Ceiling breach triggers immediate termination.
      evidence_ids:
        - EVID-COORD-0003
    - id: INV-COORD-0004
      statement: Coordination terminates with exactly one stop condition.
      rationale: |
        Clear termination reason is required for evidence and debugging.
        Multiple stop conditions would create ambiguity.
      enforcement: |
        Controller checks stop conditions in priority order.
        First matching condition terminates coordination.
        Receipt records single stop condition.
      evidence_ids:
        - EVID-COORD-0001
    - id: INV-COORD-0005
      statement: Circuit breaker resets on any successful session completion.
      rationale: |
        Consecutive failure count tracks crash loop patterns. A success indicates
        the system can make progress and should continue.
      enforcement: |
        Controller resets consecutive_failure_count to 0 on successful session.
        Circuit breaker only triggers on N consecutive failures with no intervening success.
      evidence_ids:
        - EVID-COORD-0002
  security_properties:
    - id: SEC-COORD-0001
      name: Budget enforcement
      statement: No coordination can exceed its budget ceiling.
      evidence_ids:
        - EVID-COORD-0003
    - id: SEC-COORD-0002
      name: Fail-safe termination
      statement: All coordination paths lead to termination (no infinite loops).
      evidence_ids:
        - EVID-COORD-0006
    - id: SEC-COORD-0003
      name: Audit trail
      statement: All coordination actions are recorded in the ledger.
      evidence_ids:
        - EVID-COORD-0005
  security_controls:
    - id: SEC-CTRL-COORD-0001
      name: Mandatory budget validation
      type: preventative
      details: CLI and controller reject coordination requests without valid budget parameters.
    - id: SEC-CTRL-COORD-0002
      name: Circuit breaker enforcement
      type: preventative
      details: Automatic termination after consecutive failure threshold prevents resource exhaustion.
    - id: SEC-CTRL-COORD-0003
      name: Event provenance
      type: detective
      details: All coordination events include coordination_id, timestamp, and event sequence for audit.
    - id: SEC-CTRL-COORD-0004
      name: Work freshness validation
      type: preventative
      details: Stale work detection prevents wasted execution on already-completed work.

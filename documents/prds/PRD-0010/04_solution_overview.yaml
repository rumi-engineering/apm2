prd_solution_overview:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  proposed_solution:
    overview: |
      The daemon becomes the sole control plane for work orchestration. All episode spawns,
      tool invocations, and state transitions flow through authenticated daemon IPC. Capabilities
      are minted by policy resolution (via HOLON-KERNEL-GOVERNANCE), not requested by agents.
      Sessions receive ephemeral handles with zero credential access; authenticated operations
      are mediated by the daemon tool broker. Context firewall rules from FAC are mechanically
      enforced at the tool mediation layer with deny + terminate semantics. xtask is demoted
      to a thin CLI wrapper during deprecation, then removed entirely.
    policy_resolution_ownership: |
      CLARIFICATION (per review finding FND-0010-017): Daemon CALLS HOLON-KERNEL-GOVERNANCE
      for policy resolution. Daemon does not embed governance logic. The governance holon
      returns the resolved policy tuple; daemon mints capability manifest based on that
      resolution. This separation ensures governance logic remains centralized and auditable.
    context_firewall_reuse: |
      CLARIFICATION (per review finding FND-0010-007): Tool mediation REUSES FAC context
      firewall rules (CTX-ALLOWLIST-001, CTX-CONSUME-FATAL-001). PRD-0010 specifies the
      mechanical enforcement point (tool broker) only, not the rule semantics. Rules are
      defined in PRD-0009 and referenced here.
    key_components:
      - name: Daemon IPC Handler
        type: control_plane_service
        description: |
          Handles authenticated IPC requests via Unix domain sockets. Validates peer
          credentials and issues per-client capability tokens. Routes requests to
          privileged or session-scoped handlers based on authentication level.
        responsibilities:
          - Authenticate clients via SO_PEERCRED
          - Issue per-connection capability tokens
          - Route privileged requests to operator handlers
          - Route session-scoped requests to session handlers
          - Deny unauthenticated or unauthorized requests
      - name: Work Orchestrator
        type: orchestration_service
        description: |
          Handles ClaimWork requests by querying governance for policy resolution and
          minting capability manifests. Returns WorkAssignment with pinned policy reference.
        responsibilities:
          - Validate actor_id against role eligibility
          - Query HOLON-KERNEL-GOVERNANCE for policy resolution
          - Mint capability manifest based on role + work risk tier
          - Seal context pack
          - Return assignment with all hashes pinned
      - name: Episode Spawner
        type: execution_service
        description: |
          Spawns episodes after validating FAC preconditions. For gate executors,
          enforces GateLeaseIssued requirement and SoD custody domain checks.
        responsibilities:
          - Verify PolicyResolvedForChangeSet exists
          - For GATE_EXECUTOR role, verify GateLeaseIssued exists
          - Enforce SoD via custody domain validation
          - Spawn session with ephemeral handle
          - Emit EpisodeSpawned event
      - name: Tool Broker
        type: mediation_service
        description: |
          Mediates all tool invocations from sessions. Enforces context firewall rules
          with deny + terminate semantics. Holds credentials for authenticated operations.
        tool_allowlist:
          - repo.read_allowlisted
          - cargo.test
          - cargo.clippy
          - artifact.fetch
          - cas.get
          - cas.put
        responsibilities:
          - Validate tool requests against capability manifest
          - Enforce context firewall rules (deny + terminate)
          - Mediate authenticated operations (GitHub, API keys, SSH)
          - Emit ToolDecided and ToolExecuted events
          - Terminate session on context firewall violation
      - name: Session Manager
        type: lifecycle_service
        description: |
          Manages session lifecycle, including crash recovery. On daemon restart,
          notifies all sessions of lease revocation.
        responsibilities:
          - Track active sessions
          - Handle daemon restart recovery
          - Emit LEASE_REVOKED to sessions within 5s of recovery
          - Clean up orphaned session state
  ipc_endpoints:
    privileged:
      description: "Require operator credential or internal holon signing key"
      endpoints:
        - name: ClaimWork
          parameters:
            - actor_id
            - role
          returns: WorkAssignment
        - name: SpawnEpisode
          parameters:
            - work_id
            - role
            - lease_id (optional, required for gate roles)
          returns: EpisodeSpawned
        - name: IssueCapability
          parameters:
            - session_id
            - capability_request
          returns: CapabilityGrant
        - name: Shutdown
          parameters: []
          returns: Acknowledgment
    session_scoped:
      description: "Bound to authenticated session_id"
      endpoints:
        - name: RequestTool
          parameters:
            - tool_id
            - arguments
            - dedupe_key
          returns: ToolResult
        - name: EmitEvent
          parameters:
            - event_payload
          returns: EventRef
        - name: PublishEvidence
          parameters:
            - evidence_bundle
          returns: EvidenceRef
        - name: StreamTelemetry
          parameters:
            - telemetry_data
          returns: Acknowledgment
  protocol:
    name: "Work Claim and Episode Spawn Protocol"
    stages:
      - stage_id: DCP-01-CLAIM_WORK
        name: "Work Claim (Policy-Resolved)"
        purpose: |
          Accept work claim request and return policy-resolved capability assignment.
        inputs:
          - actor_id
          - role
        outputs:
          - work_id
          - lease_id
          - capability_manifest_hash
          - policy_resolved_ref
          - context_pack_hash
        actors:
          - HOLON-DAEMON
          - HOLON-KERNEL-GOVERNANCE
        invariants:
          - "ClaimWork MUST NOT accept requester-supplied capabilities"
          - "Daemon MUST query governance for policy resolution"
          - "Capability manifest MUST be minted based on role + risk tier"
          - "Context pack MUST be sealed before return"
        defects_on_violation:
          - CAPABILITY_REQUEST_REJECTED
          - POLICY_RESOLUTION_FAILED
      - stage_id: DCP-02-SPAWN_EPISODE
        name: "Episode Spawn (Lease-Gated)"
        purpose: |
          Spawn episode after validating FAC preconditions and SoD requirements.
        inputs:
          - work_id
          - role
          - lease_id (for gate roles)
        outputs:
          - session_id
          - capability_manifest_hash
          - context_pack_sealed
          - ephemeral_handle
        actors:
          - HOLON-DAEMON
        invariants:
          - "PolicyResolvedForChangeSet MUST exist before spawn"
          - "GATE_EXECUTOR role requires valid GateLeaseIssued"
          - "Executor custody domain MUST NOT overlap author domains (SoD)"
          - "Session receives ephemeral handle, not credentials"
        defects_on_violation:
          - POLICY_RESOLUTION_MISSING
          - GATE_LEASE_MISSING
          - SOD_VIOLATION
      - stage_id: DCP-03-TOOL_MEDIATION
        name: "Tool Mediation (Context Firewall)"
        purpose: |
          Mediate tool invocations with context firewall enforcement.
        inputs:
          - session_id
          - tool_id
          - arguments
          - dedupe_key
        outputs:
          - tool_result
          - tool_decided_event
          - tool_executed_event
        actors:
          - HOLON-DAEMON
        invariants:
          - "Tool requests validated against capability manifest"
          - "Reads outside ContextPack allowlist MUST emit DENY + terminate session"
          - "Context miss terminates session with rationale=CONTEXT_FIREWALL_VIOLATION"
          - "All tool decisions logged to kernel_events"
          - "Authenticated operations mediated by broker, not session"
        defects_on_violation:
          - CONTEXT_FIREWALL_DENY
          - CONTEXT_MISS
          - TOOL_CAPABILITY_DENIED
      - stage_id: DCP-04-SESSION_RECOVERY
        name: "Session Recovery (Daemon Crash)"
        purpose: |
          Recover from daemon crash without orphaning sessions.
        inputs:
          - daemon_restart_event
        outputs:
          - lease_revoked_signals
          - session_terminated_events
        actors:
          - HOLON-DAEMON
        invariants:
          - "Sessions MUST receive LEASE_REVOKED within 5s of daemon recovery"
          - "SessionTerminated events MUST be recorded in ledger"
          - "No orphaned processes after recovery"
        defects_on_violation:
          - SESSION_ORPHANED
          - RECOVERY_TIMEOUT
  cli_migration:
    commands:
      - current: "cargo xtask work claim"
        new: "apm2 work claim --role=implementer"
        notes: "Returns work_id, lease_id, capability_manifest_hash"
      - current: "cargo xtask work start"
        new: "apm2 episode spawn --work-id=W-001 --role=implementer"
        notes: "Returns session_id, sealed pack, capability manifest"
      - current: "cargo xtask fac ingest"
        new: "apm2 fac ingest --work-id=W-001"
        notes: "Commits changeset to FAC pipeline"
      - current: "cargo xtask work status"
        new: "apm2 work status --work-id=W-001"
        notes: "Shows work state projection"
  deprecation_strategy:
    phases:
      - phase: 1
        action: "Add deprecation warnings to all xtask commands"
        duration: "1 release"
      - phase: 2
        action: "Add --allow-deprecated flag requirement"
        duration: "1 release"
        gate: "Telemetry shows decreasing xtask usage"
      - phase: 3
        action: "Remove xtask crate"
        gate: "Telemetry shows <5% direct xtask usage"
    divergence_handling: |
      During deprecation period (Phase 1-2), divergence from xtask direct writes emits
      WARNING but does NOT trigger freeze. Full freeze enforcement starts after Phase 3
      (xtask removal). This prevents operators from being stuck in freeze loops during
      migration.

prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: "REQ-0018"
  type: "SECURITY"
  source_id: "DCP-G-0003"
  title: "SSH Key Mediation Specification"
  statement: |
    apm2-daemon MUST mediate SSH key operations without exposing keys to sessions;
    daemon MUST spawn an isolated ssh-agent per work_id with internal socket path;
    session processes MUST NOT have access to SSH_AUTH_SOCK; git operations requiring
    SSH authentication MUST be mediated through the daemon tool broker.
  acceptance_criteria:
    - "Daemon spawns isolated ssh-agent per work_id. Verified by: Process inspection shows ssh-agent child of daemon with work_id-specific socket."
    - "SSH agent socket path is internal to daemon, not exposed to sessions. Verified by: Session environment dump shows SSH_AUTH_SOCK absent or pointing to non-functional path."
    - "Git operations requiring SSH are mediated by tool broker. Verified by: Session git clone via tool broker succeeds; direct git clone with SSH fails."
    - "Fallback for SSH-less environments: git credential.helper with ephemeral token. Verified by: HTTPS git operations work with daemon-managed credential helper."
    - "SSH agent lifecycle tied to work_id: agent terminates when work completes. Verified by: No orphaned ssh-agent processes after work completion."
  evidence:
    evidence_ids:
      - EVID-0017
  law_alignment:
    - law_id: "LAW-05"
      enforcement: "Dual-Axis Containment: SSH keys contained in daemon custody"
      applies_to:
        - "SSH agent isolation"
        - "Credential mediation"
    - law_id: "LAW-02"
      enforcement: "Observable Context Sufficiency: Git operations within context pack"
      applies_to:
        - "Tool broker mediation"
  defect_codes:
    - code: "SSH_KEY_EXPOSED"
      severity: "S0"
      description: "SSH key or agent socket accessible to session"
    - code: "UNMEDIATED_GIT_SSH"
      severity: "S1"
      description: "Git SSH operation bypassed tool broker"
  review_finding_ref: "FND-PRD-0010-004"

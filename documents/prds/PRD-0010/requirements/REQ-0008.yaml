prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: "REQ-0008"
  type: "SECURITY"
  source_id: "DCP-G-0006"
  title: "IPC Authentication"
  statement: |
    apm2-daemon IPC MUST authenticate all clients via Unix socket peer credentials
    (SO_PEERCRED) and issue per-connection capability tokens on the ProtocolServer
    control plane only (DD-009). Legacy JSON IPC and single-socket configurations
    are rejected fail-closed.
  acceptance_criteria:
    - "ProtocolServer uses SO_PEERCRED to extract peer UID/GID for operator.sock and session.sock. Verified by: code inspection and UT-IPC-001."
    - "Per-connection capability tokens issued at connection establishment. Verified by: protocol trace shows token exchange."
    - "Legacy JSON IPC listener is absent and legacy single-socket config keys are rejected. Verified by: config-parse tests + ADV-012."
    - "JSON frames sent to ProtocolServer sockets are rejected before handler logic. Verified by: ADV-012."
    - "Container deployments with UID remapping documented. Verified by: Deployment guide includes --userns=host requirement."
  evidence:
    evidence_ids:
      - EVID-0001
      - EVID-0002
  law_alignment:
    - law_id: "LAW-05"
      enforcement: "Dual-Axis Containment: IPC authentication boundary"
      applies_to:
        - "Unix socket authentication"
        - "Capability token issuance"
  defect_codes:
    - code: "IPC_AUTH_FAILED"
      severity: "S1"
      description: "Peer credential validation failed"
    - code: "TOKEN_INVALID"
      severity: "S1"
      description: "Capability token validation failed"

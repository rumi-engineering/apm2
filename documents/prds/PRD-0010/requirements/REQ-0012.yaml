prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: "REQ-0012"
  type: "FUNCTIONAL"
  source_id: "DCP-G-0008"
  title: "Daemon Health Metrics"
  statement: |
    apm2-daemon MUST expose Prometheus-compatible metrics for operational monitoring
    including active sessions, tool mediation latency, IPC requests, and capability
    grants.
  acceptance_criteria:
    - "Metric apm2_daemon_sessions_active exposed. Verified by: Prometheus scrape returns valid metric."
    - "Metric apm2_daemon_tool_mediation_latency_seconds histogram exposed. Verified by: Prometheus scrape returns histogram buckets."
    - "Metric apm2_daemon_ipc_requests_total counter exposed with endpoint label. Verified by: Prometheus scrape returns counter with labels."
    - "Metric apm2_daemon_capability_grants_total counter exposed. Verified by: Prometheus scrape returns counter."
    - "Metrics endpoint accessible on configured port. Verified by: HTTP GET to /metrics returns valid Prometheus format."
  evidence:
    evidence_ids:
      - EVID-0012
  law_alignment:
    - law_id: "LAW-15"
      enforcement: "Measurement Integrity: Operational metrics for observability"
      applies_to:
        - "Daemon health"
  defect_codes:
    - code: "METRICS_UNAVAILABLE"
      severity: "S2"
      description: "Prometheus metrics endpoint not responding"

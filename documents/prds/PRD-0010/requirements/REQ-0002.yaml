prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: "REQ-0002"
  type: "SECURITY"
  source_id: "DCP-G-0002"
  title: "PolicyResolvedForChangeSet Precondition"
  statement: |
    apm2-daemon SpawnEpisode MUST block until PolicyResolvedForChangeSet exists for
    the specified work_id; episode spawn without policy resolution MUST be rejected.
  acceptance_criteria:
    - "SpawnEpisode verifies PolicyResolvedForChangeSet exists in ledger before spawning. Verified by: Test shows spawn attempt without PolicyResolvedForChangeSet returns POLICY_RESOLUTION_MISSING error."
    - "EpisodeSpawned event includes policy_resolved_ref pointing to PolicyResolvedForChangeSet. Verified by: Event inspection confirms policy_resolved_ref field is populated."
    - "Spawn attempt with missing policy emits DefectRecord(POLICY_RESOLUTION_MISSING). Verified by: Ledger contains defect record after failed spawn."
  evidence:
    evidence_ids:
      - EVID-0002
  law_alignment:
    - law_id: "LAW-01"
      enforcement: "Loop Closure & Gated Promotion: Gate execution requires policy resolution"
      applies_to:
        - "SpawnEpisode"
        - "PolicyResolvedForChangeSet"
    - law_id: "LAW-09"
      enforcement: "Temporal Pinning: Policy pinned at spawn time via policy_resolved_ref"
      applies_to:
        - "Episode spawn"
  defect_codes:
    - code: "POLICY_RESOLUTION_MISSING"
      severity: "S1"
      description: "Episode spawn attempted without PolicyResolvedForChangeSet"

prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: "REQ-0001"
  type: "SECURITY"
  source_id: "DCP-G-0006"
  title: "IPC Privilege Separation"
  statement: |
    apm2-daemon MUST separate IPC endpoints into privileged (operator-only) and
    session-scoped (bound to session_id) categories using the dual-socket
    topology (operator.sock + session.sock) mandated by DD-009; legacy JSON IPC
    listeners or adapters are forbidden.
  acceptance_criteria:
    - "Privileged endpoints (ClaimWork, SpawnEpisode, IssueCapability, Shutdown) are reachable only via operator.sock with operator credentials. Verified by: ADV-001/ADV-002 show PERMISSION_DENIED from session scope."
    - "Session-scoped endpoints (RequestTool, EmitEvent, PublishEvidence, StreamTelemetry) are reachable only via session.sock with authenticated session_token. Verified by: session-scoped call without valid session_token is rejected."
    - "Legacy JSON IPC listener is absent and single-socket configs are rejected (DD-009). Verified by: ADV-012 and config-parse tests."
    - "JSON frames sent to ProtocolServer sockets are rejected before handler logic. Verified by: ADV-012."
  evidence:
    evidence_ids:
      - EVID-0001
      - EVID-0002
  law_alignment:
    - law_id: "LAW-05"
      enforcement: "Dual-Axis Containment: IPC boundary separates agent from operator authority"
      applies_to:
        - "Privileged endpoints"
        - "Session-scoped endpoints"
    - law_id: "LAW-06"
      enforcement: "MDL as Gated Budget: IPC API surface bounded and minimal"
      applies_to:
        - "IPC endpoint classification"
  defect_codes:
    - code: "IPC_PRIVILEGE_ESCALATION"
      severity: "S0"
      description: "Agent accessed privileged endpoint"
    - code: "IPC_AUTH_BYPASS"
      severity: "S0"
      description: "Unauthenticated access to IPC endpoint"

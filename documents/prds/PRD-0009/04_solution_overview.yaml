prd_solution_overview:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  proposed_solution:
    overview: |
      FAC is the internal, cryptographically enforced admission protocol; reviewers and
      verifiers sign lease-bound outcomes; merges are proven by MergeReceipts; GitHub is
      a projection. APM2 CLI runs the PR inner loop as a hardened protocol: admission is
      impossible to spoof, and every decision is replayable from ledger+CAS under strict
      OCAP. The key insight is that external forges (GitHub) cannot be sources of truth;
      all admission decisions must be cryptographically signed, internally verified, and
      projected outward.
    key_components:
      - name: Coordinator
        holon_id: HOLON-COORDINATOR
        type: orchestration_service
        description: |
          CAS-at-commit orchestration, bounded retries, echo-trap detection. Responsible
          for binding changesets to work items before spawning gate episodes and managing
          the overall FAC workflow.
        tool_allowlist:
          - ledger.append
          - ledger.read
          - session.spawn
          - cas.put
          - cas.get
          - policy.query
      - name: Kernel Governance
        holon_id: HOLON-KERNEL-GOVERNANCE
        type: authority_service
        description: |
          Critical event signing, authority minting, key policy. Issues lease-scoped
          authority for gate executors and manages key rotation with chain-of-custody.
        responsibilities:
          - sign GateLeaseIssued events
          - manage key rotation via KeyRotated events
          - enforce COI grouping policy
      - name: Kernel Gate
        holon_id: HOLON-KERNEL-GATE
        type: admission_service
        description: |
          Gate receipt verification, admission decision, merge receipt emission. The
          sole authority for emitting MergeReceipts and freezing admissions.
        responsibilities:
          - verify GateRunCompleted signatures
          - emit MergeReceipt on successful admission
          - deny admission on policy violations
          - request adjudication when needed
          - freeze admissions on divergence
      - name: Context Compiler
        holon_id: HOLON-CONTEXT-COMPILER
        type: compilation_service
        description: |
          CCP/RCP compilation, impact expansion, ZTI scoring. Generates deterministic,
          bounded context views for each gate role with deep-pinned dependencies.
        responsibilities:
          - compile Review Context Packs (RCP)
          - deterministic impact expansion
          - emit View Commitments binding to ledger anchor
      - name: GitHub Adapter
        holon_id: HOLON-GITHUB-ADAPTER
        type: projection_service
        description: |
          Projection-only sync and divergence watchdog. The only identity permitted to
          write GitHub checks, status, labels, and comments. Imports CI evidence.
        tool_allowlist:
          - github.write
          - github.read_limited
          - artifact.fetch
          - cas.put
          - cas.get
          - ledger.read
        responsibilities:
          - project internal state to GitHub
          - import CI logs/artifacts as evidence
          - detect and react to projection divergence
      - name: Security Reviewer
        holon_id: HOLON-REVIEWER-SECURITY
        type: gate_executor
        description: |
          Executes security gate under OCAP context firewall. Signs GateRunCompleted
          for gate=security under valid lease. Produces evidence bundles and findings.
        tool_allowlist:
          - cas.get
          - repo.read_allowlisted
          - cargo.test
          - dep.audit
          - policy.scan
          - artifact.fetch
      - name: Quality Reviewer
        holon_id: HOLON-REVIEWER-QUALITY
        type: gate_executor
        description: |
          Executes quality gate under OCAP context firewall. Signs GateRunCompleted
          for gate=quality under valid lease. Produces evidence bundles and findings.
        tool_allowlist:
          - cas.get
          - repo.read_allowlisted
          - cargo.test
          - cargo.clippy
          - rustfmt.check
          - artifact.fetch
      - name: AAT Verifier
        holon_id: HOLON-AAT
        type: gate_executor
        description: |
          Executes acceptance test gate under OCAP context firewall against pinned snapshots
          only. Produces transcript hash chains, artifact digests, and terminal-verifier
          outputs; signs GateRunCompleted for gate=aat under valid lease; publishes
          GateReceipt with AAT-typed payload and attestation binding. Executor keys are
          isolated from coordinator/implementer custody domains.
        tool_allowlist:
          - cas.get
          - repo.read_allowlisted
          - shell.exec_allowlisted
          - cargo.test
          - artifact.fetch
      - name: Auditor
        holon_id: HOLON-AUDITOR
        type: measurement_service
        description: |
          Measurement integrity, drift/holdout auditing (Phase 2). Runs adversarial
          holdout suites and samples gate outcomes to detect evaluator drift.
        responsibilities:
          - execute FAC-90-HOLDOUT_AUDIT
          - measure false negative rates
          - emit drift alerts and policy quarantine
      - name: Work Executor
        holon_id: HOLON-WORK-EXECUTOR
        type: implementation_service
        description: |
          Produces changesets and publishes implementation evidence. Cannot sign
          GateRunCompleted for required gates, emit MergeReceipt, or write projections.
        may:
          - produce changesets
          - publish implementation evidence
        may_not:
          - sign GateRunCompleted for required gates
          - emit MergeReceipt
          - write external projections
  protocol:
    name: "Forge Admission Cycle (FAC)"
    stages:
      - stage_id: FAC-00-INGEST_CHANGESET
        name: Ingest ChangeSet + View Commitment
        purpose: |
          Bind a candidate change to pinned inputs; produce a ChangeSetDigest and
          PRBundle artifact.
        inputs:
          - work_id
          - plan_snapshot_hash
          - base_selector
          - workspace_delta_or_commit_range
        outputs:
          - changeset_digest
          - pr_bundle_hash
          - view_commitment_hash
          - run_receipt_hash
        actors:
          - HOLON-COORDINATOR
        invariants:
          - All selectors are resolved to concrete git object IDs (commit/tree), no symbolic HEAD.
          - Workspace deltas are content-addressed artifacts; never inferred from disk.
          - "CAS-at-commit: bind changeset_digest to work_id in ledger before spawning any gate episodes."
        defects_on_violation:
          - INVALID_SELECTOR
          - UNPINNED_INPUTS
      - stage_id: FAC-01-CI_EVIDENCE_IMPORT
        name: Import CI evidence (projection->evidence), not CI truth
        purpose: |
          Capture CI outputs as evidence artifacts; optionally gate readiness-for-review.
        inputs:
          - pr_number
          - commit_sha
          - ci_provider_observations
          - workflow_artifacts
        outputs:
          - ci_evidence_bundle_hash
          - ci_import_attestation_hash
          - work_transition_ready_for_review (optional)
        actors:
          - HOLON-GITHUB-ADAPTER
        invariants:
          - CI observations are never treated as authoritative admission signals.
          - If readiness transition is emitted, it must be backed by imported raw artifacts/log digests stored in CAS.
          - "READY_FOR_REVIEW transition requires: (a) webhook signature verified, (b) raw log/artifact digests imported into CAS, (c) adapter attestation signed and committed."
          - "A plain 'success' conclusion without evidence import is ignored (fail-closed)."
        defects_on_violation:
          - CI_EVIDENCE_MISSING
          - CI_SHA_MISMATCH
          - CI_ATTESTATION_INVALID
      - stage_id: FAC-02-RCP_COMPILE
        name: Compile Review Context Packs (RCP)
        purpose: |
          Generate deterministic, bounded context views for each gate role; maximize
          ZTI for consumption holons.
        inputs:
          - changeset_digest
          - ccp_atlas_hash
          - pack_profiles
          - impact_policy_profile
        outputs:
          - rcp_quality_manifest_hash
          - rcp_security_manifest_hash
          - rcp_aat_manifest_hash
          - run_receipt_hash
        actors:
          - HOLON-CONTEXT-COMPILER
        invariants:
          - Each RCP includes a View Commitment binding to ledger anchor + pinned repo/toolchain/policy digests.
          - RCP manifests deep-pin stable IDs to content hashes (CAC).
          - Impact Expansion is deterministic for same inputs; non-deterministic tools are prohibited in the compiler path.
        defects_on_violation:
          - RCP_NONDETERMINISTIC
          - RCP_MISSING_VIEW_COMMITMENT
      - stage_id: FAC-03-MINT_AUTHORITY
        name: Mint gate-scoped authority (GateLease)
        purpose: |
          Issue lease-scoped authority for a specific gate executor over a specific
          ChangeSetDigest.
        inputs:
          - work_id
          - changeset_digest
          - gate_set
          - executor_selection_policy
        outputs:
          - gate_lease_issued_events
          - run_receipt_hash
        actors:
          - HOLON-KERNEL-GOVERNANCE
          - HOLON-COORDINATOR
        invariants:
          - "GateLease scope is strict: (work_id, gate_id, changeset_digest, executor_actor_id, expiry, policy_hash)."
          - "For gate_id=aat, GateLease scope additionally binds view_commitment_hash, rcp_aat_manifest_hash, and selection_policy_id."
          - Lease issuance committed before session.spawn (CAS-at-commit ordering).
          - Lease derivation obeys subset rule (child leases can only narrow).
        defects_on_violation:
          - LEASE_SCOPE_BROADENED
          - LEASE_NO_POLICY_HASH
      - stage_id: FAC-04-RUN_GATES
        name: Run gates under OCAP context firewall
        purpose: |
          Execute quality/security/AAT gates; produce evidence bundles, gate receipts,
          and signed GateRunCompleted events.
        inputs:
          - gate_lease
          - rcp_manifest_hash
          - tool_policy_profile
          - target_profile
        outputs:
          - evidence_bundle_hash
          - gate_receipt_id
          - gate_run_started_event
          - gate_run_completed_event_signed
          - run_receipt_hash
          - defect_records (optional)
        actors:
          - HOLON-REVIEWER-QUALITY
          - HOLON-REVIEWER-SECURITY
          - HOLON-AAT
        invariants:
          - "OCAP context firewall: repo/file reads are allowed only for objects explicitly enumerated in the RCP manifest allowlist."
          - "Context misses are not 'warnings': they terminate the session with rationale CONTEXT_MISS and trigger refinement."
          - GateRunCompleted is a critical signed event (Ed25519 over canonical bytes, domain-separated).
          - GateReceipt binds to EvidenceBundle hash and is signed by GateReceiptGenerator.
          - GateReceipt uses typed payloads; gate_id=aat requires view_commitment_hash, determinism_class, and evidence/attestation bindings in payload.
          - "AAT runs execute against pinned snapshots only: gate_id=aat requires view_commitment_hash and rcp_aat_manifest_hash; live worktree reads are prohibited."
          - "AAT payload MUST include transcript_chain_root_hash, transcript_bundle_hash, artifact_digests, terminal_verifier_outputs, verifier_policy_hash, selection_policy_id, and risk_tier."
          - "Terminal verifiers must satisfy the machine-defined acceptance predicate; missing or non-matching outputs force FAIL or NEEDS_INPUT."
          - Advisory narratives are recorded but never substitute for terminal-verifier evidence.
        defects_on_violation:
          - CONTEXT_FIREWALL_DENY
          - CONTEXT_MISS
          - AAT_EVIDENCE_MISSING
          - AAT_TERMINAL_VERIFIER_MISSING
          - AAT_ATTESTATION_INVALID
          - INVALID_SIGNATURE
          - UNAUTHORIZED_EXECUTOR
      - stage_id: FAC-05-ADMISSION_DECISION
        name: Admission decision + atomic merge
        purpose: |
          Decide promote/deny; on promote, perform atomic merge and emit MergeReceipt
          after observing trunk update.
        inputs:
          - gate_run_completed_events
          - gate_receipts
          - policy_profile
          - base_selector
          - changeset_digest
        outputs:
          - admission_decision
          - merge_receipt_hash (on success)
          - run_receipt_hash
        actors:
          - HOLON-KERNEL-GATE
          - HOLON-GITHUB-ADAPTER (actuation)
          - HOLON-COORDINATOR
        invariants:
          - Admission reads only internal projections; never reads GitHub status as truth.
          - Required gates must be satisfied by valid GateRunCompleted signatures + matching unexpired leases + matching ChangeSetDigest.
          - AAT admission validates typed GateReceipt payload (view_commitment_hash, rcp_manifest_hash, determinism_class, flake_class, run_receipt_hashes, run_count, stability_digest).
          - "AAT admission validates transcript chain completeness, artifact digests, terminal verifier outputs, verifier_policy_hash, selection_policy_id, risk_tier, and attestation fields."
          - "Atomicity: MergeReceipt is emitted only after result_selector (trunk digest) is observed and recorded."
          - "MergeReceipt binds (base_selector, changeset_digest, gate_receipts, policy_hash) -> (result_selector)."
        defects_on_violation:
          - GATE_MISSING
          - GATE_STALE_SHA
          - AAT_EVIDENCE_MISSING
          - AAT_TRANSCRIPT_CHAIN_INVALID
          - AAT_TERMINAL_VERIFIER_MISSING
          - AAT_TERMINAL_VERIFIER_MISMATCH
          - AAT_ATTESTATION_INVALID
          - AAT_POLICY_MISMATCH
          - MERGE_NONATOMIC
          - MERGE_RECEIPT_INVALID
      - stage_id: FAC-06-PROJECTION_SYNC
        name: Projection sync + anti-entropy watchdog
        purpose: |
          Project authoritative state to GitHub; detect and react to divergence.
        inputs:
          - ledger_head
          - projection_targets
          - latest_merge_receipt
        outputs:
          - projection_receipt_hash
          - projection_health
          - defect_records (optional)
        actors:
          - HOLON-GITHUB-ADAPTER
        invariants:
          - Sync direction is always ledger -> GitHub.
          - Projection is idempotent; repeated sync yields same GitHub state.
          - Adapter is the only identity permitted to write GitHub checks/status/labels/comments.
          - "Continuous divergence detection: compare external trunk HEAD to latest MergeReceipt result_selector; if diverged, emit PROJECTION_DIVERGENCE and freeze admissions for that repo."
        defects_on_violation:
          - PROJECTION_TAMPER
          - PROJECTION_DIVERGENCE
          - PROJECTION_WRITE_UNAUTHORIZED
      - stage_id: FAC-90-HOLDOUT_AUDIT
        name: Adversarial holdout / drift audit (Phase 2)
        purpose: |
          Measure false negatives and evaluator drift using known-bad ChangeSets
          and sampled audits.
        inputs:
          - holdout_suite_id
          - gate_policy_version
          - sampling_policy
        outputs:
          - evaluator_metrics
          - drift_alerts
          - policy_quarantine (optional)
        actors:
          - HOLON-AUDITOR
        invariants:
          - Holdout ChangeSets are isolated from production trunk (no merge capability).
          - If false-negative rate exceeds threshold, gate policy is quarantined and admission requires explicit adjudication until resolved.
        defects_on_violation:
          - EVALUATOR_DRIFT
          - HOLDOUT_FALSE_NEGATIVE
        phase: "Phase 2"
  gate_receipts:
    payloads:
      default:
        description: "GateReceipt binds gate outcome to EvidenceBundle hash and is signed by GateReceiptGenerator."
      aat:
        gate_id: "aat"
        required_fields:
          - view_commitment_hash
          - rcp_manifest_hash
          - determinism_class
          - flake_class
          - run_count
          - run_receipt_hashes
          - stability_digest
          - verdict
          - transcript_chain_root_hash
          - transcript_bundle_hash
          - artifact_digests
          - terminal_verifier_outputs
          - verifier_policy_hash
          - selection_policy_id
          - risk_tier
          - attestation
        binding_rules:
          - "view_commitment_hash MUST match FAC-00-INGEST_CHANGESET output."
          - "rcp_manifest_hash MUST match FAC-02-RCP_COMPILE rcp_aat_manifest_hash."
          - "run_receipt_hashes MUST reference the GateRunCompleted sessions for this gate."
          - "verifier_policy_hash and selection_policy_id MUST match the policy_profile hash used for the run."
          - "transcript_chain_root_hash MUST be derivable from transcript_bundle_hash and complete chunk ordering."
          - "attestation fields MUST match runner identity, toolchain, and network policy profile bound by policy_hash."
  aat_contract:
    binding:
      view_commitment_hash: "FAC-00-INGEST_CHANGESET view_commitment_hash"
      rcp_manifest_hash: "FAC-02-RCP_COMPILE rcp_aat_manifest_hash"
      gate_receipt_id: "GateReceipt for gate_id=aat"
      policy_hash: "AAT policy profile hash (selection + verifier binding + attestation requirements)."
      selection_policy_id: "Risk-tier selection policy identifier bound into GateReceipt payload."
    verdicts:
      - PASS
      - FAIL
      - NEEDS_INPUT
    evidence_binding:
      transcript_chain:
        root_hash_field: "transcript_chain_root_hash"
        bundle_hash_field: "transcript_bundle_hash"
        captures:
          - "command"
          - "environment"
          - "stdout/stderr chunk digests"
          - "exit codes"
          - "timestamp buckets"
          - "file diffs"
      artifact_digests: "All logs, junit, coverage, snapshots, binary outputs; digests must be independently verifiable."
      terminal_verifier_outputs: "Structured outputs required by scenario-type verifier policy; narrative is non-authoritative."
    terminal_verifier_binding:
      schema: "ScenarioType -> allowed_verifier_kinds + required_outputs + machine_predicate"
      allowed_verifier_kinds:
        - "exit_code"
        - "snapshot_diff"
        - "structured_test_report"
        - "invariant_check"
      enforcement: "PASS requires predicate satisfied; missing verifier outputs => FAIL or NEEDS_INPUT."
    flake_classification:
      classes:
        - "PRODUCT_DETERMINISTIC_FAIL"
        - "HARNESS_FLAKE"
        - "ENVIRONMENT_DRIFT"
        - "TEST_NONSEMANTIC"
        - "UNKNOWN"
      handling:
        PRODUCT_DETERMINISTIC_FAIL: "FAIL; defect against ChangeSet and block admission."
        HARNESS_FLAKE: "Quarantine runner pool; reroute to clean pool with attestation check."
        ENVIRONMENT_DRIFT: "Invalidate attestation; block until environment is re-pinned."
        TEST_NONSEMANTIC: "Quarantine AAT spec; open defect against test suite."
        UNKNOWN: "NEEDS_INPUT; never PASS via retries."
    risk_tiering:
      tiers:
        - "HIGH"
        - "MED"
        - "LOW"
      selection_rules:
        - "HIGH: AAT required; suite subset determined by impact expansion."
        - "MED: AAT required for sensitive domains (auth/crypto/ledger/tool mediation); otherwise sampled."
        - "LOW: Sampled AAT (1 in N) + nightly full AAT on main."
      enforcement: "GateReceipt payload includes risk_tier + selection_policy_id; admission validates against policy_hash."
    attestation:
      minimum_viable:
        - "container_image_digest"
        - "toolchain_digests"
        - "runner_identity_key_id"
        - "network_policy_profile_hash"
      phase_2_research:
        - "TPM-backed attestation / measured boot"
        - "reproducible builds for harness and verifiers"
        - "multi-party attestation for highest-risk tiers"
    specification:
      invariant_first: true
      invariants_required: "AAT specs define invariants; steps exist only to observe invariants."
      steps_are_observational: true
    determinism_policy:
      required_gate_ids:
        - "aat"
      extension_note: "Policy may require determinism_class > 0 for other gates over time."
    phase_1:
      scope: "Typed GateReceipt payload, evidence bindings, terminal verifier schema, and minimum attestation for AAT."
      enforcement: "Admission verifies evidence bindings, verifier outputs, and policy_hash for gate_id=aat."
    phase_2:
      scope: "Determinism envelope + flake classification enforcement + risk-tier policy expansion."
      enforcement: "PASS requires stability proof across N runs; flake classes drive quarantine actions."
  determinism_envelope:
    owner: "HOLON-COORDINATOR or Determinism Proxy"
    default_run_count: 3
    stability_rule: "All N runs must produce identical evidence_bundle_hash, transcript_chain_root_hash, and terminal_verifier_outputs."
    proof: "GateReceipt payload includes run_receipt_hashes, run_count, and stability_digest."
    classification: "Coordinator assigns flake_class on mismatch; GateReceipt records determinism_class + flake_class."
    failure_actions:
      - "Emit DefectRecord(GATE_NONDETERMINISTIC)."
      - "WorkTransitioned -> BLOCKED with rationale=QUARANTINED_CHANGESET (time-bounded)."
      - "WorkAborted abort_reason=POLICY_DENY after repeated nondeterminism."
      - "HARNESS_FLAKE triggers InterventionFreeze(scope=runner_pool) and rerun on clean pool."
      - "TEST_NONSEMANTIC triggers AAT spec quarantine and defect against test suite."
    phase: "Phase 2"
  stop_conditions:
    boundedness:
      per_gate_max_attempts: 3
      global_max_episodes: 50
      budgets:
        review_security:
          tokens: 250000
          tool_calls: 800
          duration_ms: 3600000
        review_quality:
          tokens: 250000
          tool_calls: 800
          duration_ms: 3600000
        aat:
          tokens: 200000
          tool_calls: 1000
          duration_ms: 3600000
    echo_trap_detection:
      signal: FindingSignature repeats without delta
      threshold: 3
      window: single GateRun
      actions:
        - Terminate session rationale=REASONING_DEGENERATION
        - Emit DefectRecord(ECHO_TRAP)
        - Escalate via OracleRequest or AdjudicationRequested(request_type=GATE_REVIEW)
    retry_policy:
      backoff: exponential
      max_backoff_seconds: 3600
      provider_errors: "classified into retryable/non-retryable; see provider_routing"
  authority:
    identity:
      keys:
        algorithm: ed25519
        binding: KeyRotated establishes actor_id -> verifying_key with chain-of-custody
        domain_separators:
          gate_run_completed: "GATE_RUN_COMPLETED:"
          gate_lease: "GATE_LEASE_ISSUED:"
          merge_receipt: "MERGE_RECEIPT:"
          ci_import_attestation: "CI_IMPORT_ATTESTATION:"
          projection_receipt: "PROJECTION_RECEIPT:"
        ingestion:
          critical_events_must_verify: true
          reject_reason_codes:
            - INVALID_SIGNATURE
            - UNAUTHORIZED_EXECUTOR
            - UNKNOWN_KEY
    gate_lease:
      fields:
        - lease_id
        - work_id
        - gate_id
        - changeset_digest
        - executor_actor_id
        - issued_at
        - expires_at
        - policy_hash
        - issuer_actor_id
        - issuer_signature
      single_use: true
      expiry_enforced: true
      lease_outcome_binding: "GateRunCompleted must reference lease_id and include changeset_digest; mismatch rejects."
      aat_scope_extensions:
        - view_commitment_hash
        - rcp_manifest_hash
        - selection_policy_id
        - policy_hash
      aat_binding: "GateRunCompleted for gate_id=aat MUST match view_commitment_hash and rcp_manifest_hash from lease."
    conflict_of_interest:
      enabled: true
      rule: Executor of a required gate must not be the author of the ChangeSet (or a key in the same COI group).
      coi_grouping: Keys may be grouped by custody domain; COI is enforced at group-level.
      waiver:
        enabled: true
        path: "AdjudicationRequested request_type=WAIVER with explicit rationale and bounded scope; signed by authority set"
        scope_fields:
          - work_id
          - changeset_digest
          - gate_id
          - expires_at
          - rationale
    custody_separation:
      rule: "AAT executor keys must not share custody domains with coordinator or implementer roles."
      enforcement: "KeyPolicy validation on lease issuance; unauthorized custody groups rejected."
  ocap_and_context:
    mode: "ZTI-first consumption"
    context_firewall:
      mechanism: "OCAP mediated tools with manifest-scoped read handles"
      rules:
        - rule_id: "CTX-ALLOWLIST-001"
          statement: "repo.read and file.read operations must reference a manifest entry (stable_id or path+hash) present in the ContextPackManifest allowlist."
          enforcement: "ToolDecided=DENY if not allowlisted; no data returned."
          severity: "S1"
        - rule_id: "CTX-SUFFICIENCY-001"
          statement: "Every RunReceipt records context sufficiency metrics (bytes supplied, entries used, misses, denied reads, ZTI score)."
          enforcement: "RunReceipt required for GateRunCompleted acceptance"
          severity: "S2"
        - rule_id: "CTX-ZOOM-001"
          statement: "Consumers may request additional context only via ContextRefinementRequest; no in-session discovery."
          enforcement: "SessionTerminated rationale=CONTEXT_MISS; coordinator reissues lease after refined pack"
          severity: "S1"
        - rule_id: "CTX-CONSUME-FATAL-001"
          statement: "In CONSUME mode, reads outside pack are blocked (not logged as soft warnings); context miss is session-fatal unless policy explicitly allows refinement."
          enforcement: "SessionTerminated rationale=CONTEXT_MISS; no fallback reads permitted."
          severity: "S1"
      defect_emission:
        on_denied_read: "CONTEXT_FIREWALL_DENY"
        on_context_miss: "CONTEXT_MISS"
        on_excessive_zoom_requests: "ECHO_TRAP"
    tool_policy:
      default: "deny"
      per_role_allowlists:
        HOLON-AAT:
          - artifact.fetch
          - cas.get
          - cargo.test
          - repo.read_allowlisted
          - shell.exec_allowlisted
        HOLON-COORDINATOR:
          - cas.get
          - cas.put
          - ledger.append
          - ledger.read
          - policy.query
          - session.spawn
        HOLON-GITHUB-ADAPTER:
          - artifact.fetch
          - cas.get
          - cas.put
          - github.read_limited
          - github.write
          - ledger.read
        HOLON-REVIEWER-QUALITY:
          - artifact.fetch
          - cas.get
          - cargo.clippy
          - cargo.test
          - repo.read_allowlisted
          - rustfmt.check
        HOLON-REVIEWER-SECURITY:
          - artifact.fetch
          - cas.get
          - dep.audit
          - policy.scan
          - repo.read_allowlisted
          - cargo.test
      ambient_credential_ban:
        - "No agent processes inherit GitHub tokens/ssh keys; only adapter has projection credentials."
        - "Any attempt to access forbidden credentials emits PolicyViolation and quarantines session."
  ci_ingestion:
    trusted_boundary: "GitHub webhook signature verifies origin but is not sufficient for readiness/admission."
    evidence_binding:
      required_for_ready_for_review: "when_ci_gating_enabled"
      raw_import:
        - "workflow logs (compressed)"
        - "test reports/artifacts"
        - "workflow metadata (run id, job ids)"
      attestation:
        level: "L1"
        fields:
          - "runner_image_digest?"
          - "toolchain?"
          - "command_transcript_hash?"
          - "workflow_run_id"
          - "downloaded_artifact_hashes"
        signed_by: "HOLON-GITHUB-ADAPTER"
    feature_flags:
      CI_EVENTS_ENABLED: "false by default (fail-closed); when true, evidence-backed import is required"
      CI_GATED_QUEUE_ENABLED: "false by default (fail-closed); when true, READY_FOR_REVIEW transitions require attested evidence import"
    open_question: "How to obtain stable runner image digests from hosted CI; may require self-hosted runners for L1+."
    security_notes:
      - "CI conclusions are treated as observations; admission requires internal gates with terminal verifiers."
      - "Where hosted CI cannot provide strong environment attestations, re-run critical verifiers in controlled environments for T3 changes."
  projection:
    projection_only: true
    write_identity: "HOLON-GITHUB-ADAPTER"
    idempotence: "Projection keyed by (work_id, changeset_digest, ledger_head) fingerprint; reapply is safe."
    tamper_detection:
      status_write_policy: "Only adapter token may write checks/status; other writers treated as tamper."
      tamper_reaction:
        - "Optionally set external checks to FAILURE on tamper detection to prevent reliance on stale green UI."
        - "Overwrite projection to match ledger truth on next sync."
        - "Emit DefectRecord(PROJECTION_TAMPER) with evidence (diff of fingerprints)."
    divergence_watchdog:
      check: "Compare external trunk HEAD commit/tree to latest internal MergeReceipt result_selector."
      poll_interval_seconds: 30
      on_divergence:
        - "Emit DefectRecord(PROJECTION_DIVERGENCE) with observed head + expected head"
        - "Emit InterventionFreeze(scope=repo) and halt new FAC admissions for repo"
        - "Open AdjudicationRequested(request_type=EMERGENCY_RECOVERY) referencing divergence evidence"
      unfreeze: "Requires explicit adjudication or emergency override ceremony per PRD-0007."
    branch_protection_contract:
      goal: "Ensure external merge paths cannot bypass FAC admission."
      requirements:
        - "Main branch protection requires checks that are only set by HOLON-GITHUB-ADAPTER."
        - "Restrict merge permissions so only adapter identity (or merge bot) can merge to main."
        - "Disable administrator bypass for routine operations; if kept, treat use as emergency override with audit."
      open_question: "Exact GitHub org policies and enforcement mechanics; document and codify in adapter handshake."
  goodhart_resistance:
    enabled: false
    activation_phase: "Phase 2"
    policy: "Holdouts/audits are measurement channels isolated from admission objectives; they can quarantine policies but do not auto-merge or auto-block in Phase 1."
    holdouts:
      concept: "Known-bad ChangeSets and adversarial suites routed through gate pipeline to estimate false-negative rates."
      execution: "HOLON-AUDITOR runs FAC-90-HOLDOUT_AUDIT on schedule; cannot merge."
      metrics:
        - false_negative_rate
        - finding_precision
        - gate_evidence_coverage
        - aat_escape_rate
        - aat_signal_density
        - aat_flake_attribution
        - median_time_to_actionable
    evaluator_audit:
      concept: "Sample GateRunCompleted + EvidenceBundle pairs and verify rationale codes align with raw evidence (LAW-15)."
      sampling:
        rate: "1% of GateRuns or min 1/day"
        bias: "oversample security-sensitive changes"
      actions_on_drift:
        - "Quarantine affected gate policy version"
        - "Require adjudication for affected gate until resolved"
  defects:
    schema: "cac.defect_record.v1"
    taxonomy:
      - code: "AAT_ATTESTATION_INVALID"
        severity: "S1"
        description: "AAT receipt attestation missing or invalid (runner/toolchain/network profile)"
      - code: "AAT_EVIDENCE_MISSING"
        severity: "S1"
        description: "AAT receipt missing transcript chain, artifact digests, or required raw evidence"
      - code: "AAT_FALSE_NEGATIVE"
        severity: "S1"
        description: "Post-merge defect attributed to missed AAT detection"
      - code: "AAT_POLICY_MISMATCH"
        severity: "S1"
        description: "AAT receipt policy_hash or selection_policy_id mismatch"
      - code: "AAT_SPEC_INVALID"
        severity: "S2"
        description: "AAT spec missing invariant or uses step-based acceptance"
      - code: "AAT_TERMINAL_VERIFIER_MISSING"
        severity: "S1"
        description: "AAT receipt missing required terminal verifier outputs"
      - code: "AAT_TERMINAL_VERIFIER_MISMATCH"
        severity: "S1"
        description: "Terminal verifier outputs do not satisfy machine predicate"
      - code: "AAT_TRANSCRIPT_CHAIN_INVALID"
        severity: "S1"
        description: "AAT transcript hash chain incomplete or invalid"
      - code: "CI_ATTESTATION_INVALID"
        severity: "S1"
        description: "CI import attestation signature invalid or missing fields"
      - code: "CI_EVIDENCE_MISSING"
        severity: "S1"
        description: "CI readiness transition attempted without imported raw evidence digests"
      - code: "CI_SHA_MISMATCH"
        severity: "S1"
        description: "CI evidence commit SHA does not match expected changeset"
      - code: "CONTEXT_FIREWALL_DENY"
        severity: "S2"
        description: "Attempted read outside pack allowlist"
      - code: "CONTEXT_MISS"
        severity: "S2"
        description: "Pack lacks required context; session terminated; triggers refinement loop"
      - code: "ECHO_TRAP"
        severity: "S2"
        description: "Reasoning degeneration detected (repeated finding signatures)"
      - code: "EVALUATOR_DRIFT"
        severity: "S1"
        description: "Auditor detected drift between rationale codes and evidence"
      - code: "ENVIRONMENT_DRIFT"
        severity: "S2"
        description: "AAT environment/toolchain drift detected between runs"
      - code: "GATE_NONDETERMINISTIC"
        severity: "S1"
        description: "Gate outcomes diverged under determinism envelope"
      - code: "HARNESS_FLAKE"
        severity: "S2"
        description: "Runner/infra nondeterminism detected; quarantine runner pool"
      - code: "HOLDOUT_FALSE_NEGATIVE"
        severity: "S1"
        description: "Gate missed known-bad holdout vulnerability/bug"
      - code: "INVALID_SIGNATURE"
        severity: "S0"
        description: "Critical event signature invalid"
      - code: "PROJECTION_DIVERGENCE"
        severity: "S0"
        description: "External trunk diverges from latest MergeReceipt"
      - code: "PROJECTION_TAMPER"
        severity: "S1"
        description: "External projection mutated by non-adapter identity"
      - code: "PROJECTION_WRITE_UNAUTHORIZED"
        severity: "S1"
        description: "Non-adapter identity attempted projection write"
      - code: "PROVIDER_RATE_LIMIT"
        severity: "S3"
        description: "LLM provider rate limiting impacted run"
      - code: "PROVIDER_TIMEOUT"
        severity: "S3"
        description: "LLM provider timeout impacted run"
      - code: "TEST_NONSEMANTIC"
        severity: "S2"
        description: "AAT spec brittle or non-semantic; quarantine test spec"
      - code: "UNAUTHORIZED_EXECUTOR"
        severity: "S0"
        description: "Gate outcome signed by actor not authorized/leased"
    generation_sources:
      - "ToolDecided DENY"
      - "SessionTerminated rationale codes"
      - "Provider error classification from ToolExecuted"
      - "Projection watchdog events"
      - "AAT receipt evidence validation"
      - "Terminal verifier policy evaluation"
      - "Determinism envelope mismatches"
      - "Gate audit/holdout metrics"
    linkage: "DefectRecord links to (work_id, session_id, gate_id, changeset_digest) and evidence hashes."
    phase2_only_codes:
      - "EVALUATOR_DRIFT"
      - "GATE_NONDETERMINISTIC"
      - "HOLDOUT_FALSE_NEGATIVE"
      - "AAT_FALSE_NEGATIVE"
      - "HARNESS_FLAKE"
      - "ENVIRONMENT_DRIFT"
      - "TEST_NONSEMANTIC"
  provider_routing:
    classification_aware: true
    stage_scoped: true
    error_taxonomy:
      - "INVALID_RESPONSE"
      - "POLICY_DENY"
      - "RATE_LIMIT"
      - "TIMEOUT"
      - "TRANSIENT_5XX"
    circuit_breaker:
      thresholds:
        RATE_LIMIT: 3
        TIMEOUT: 2
        TRANSIENT_5XX: 2
      ttl_ms: 900000
      reset_on_success: true
    recording: "All provider routing decisions and errors are recorded in ToolDecided/ToolExecuted receipts and normalized into DefectRecords."
    fallback_policy: "Deterministic routing profile per stage with ordered fallbacks; emits routing rationale."
    open_issue: "Cross-provider prompt equivalence & data classification constraints."
  appendix:
    new_event_shapes:
      proto_changes_required:
        - payload_family: "GateEvent"
          messages:
            - "GateLeaseIssued (critical, signed by governance)"
            - "GateRunStarted (non-critical, unsigned ok)"
            - "GateRunCompleted (critical, signed by gate executor; includes evidence_bundle_hash, gate_receipt_id, lease_id, changeset_digest)"
          canonicalization: "No maps; sort repeated fields before signing; domain-separated signatures."
          notes:
            - "AAT uses typed GateReceipt payloads (gate_id=aat); no standalone AATReceipt event."
            - "AAT typed payload binds transcript_chain_root_hash, artifact_digests, terminal_verifier_outputs, selection_policy_id, risk_tier, and attestation fields."
        - payload_family: "InterventionEvent"
          messages:
            - "InterventionFreeze (repo/work scope, signed by admission authority)"
            - "InterventionUnfreeze (signed; may require adjudication/override ceremony)"
        - payload_family: "ProjectionEvent"
          messages:
            - "ProjectionApplied (receipt-backed sync attempt)"
            - "ProjectionDiverged (critical; triggers freeze)"
            - "ProjectionTamperObserved (defect signal)"

prd_customer:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  segments:
    - id: CUST-0001
      name: Kernel Governance Team
      description: Engineers responsible for critical event signing, authority minting, and key policy.
      holon_id: HOLON-KERNEL-GOVERNANCE
      primary_jobs_to_be_done:
        - Sign critical events with domain-separated Ed25519 signatures.
        - Mint and issue gate-scoped authorities (GateLeases).
        - Define and enforce key rotation and custody policies.
      constraints:
        - Must maintain chain-of-custody for all signing keys.
        - Key rotation events must be ledger-recorded with provenance.
    - id: CUST-0002
      name: Kernel Gate Team
      description: Engineers responsible for gate receipt verification, admission decisions, and merge receipts.
      holon_id: HOLON-KERNEL-GATE
      primary_jobs_to_be_done:
        - Verify GateRunCompleted signatures and lease validity.
        - Make admission decisions based on internal projections only.
        - Emit MergeReceipts after observing trunk updates.
      constraints:
        - Must never read GitHub status as truth for admission decisions.
        - Required gates must be satisfied by valid signatures + matching leases + matching ChangeSetDigest.
    - id: CUST-0003
      name: Coordinator Team
      description: Engineers responsible for CAS-at-commit orchestration, bounded retries, and echo-trap detection.
      holon_id: HOLON-COORDINATOR
      primary_jobs_to_be_done:
        - Orchestrate changeset ingestion and gate session spawning.
        - Enforce bounded retry policies with exponential backoff.
        - Detect echo-traps and escalate to oracle when reasoning degenerates.
      constraints:
        - Lease issuance must be committed before session spawn (CAS-at-commit ordering).
        - Global episode limit must be enforced to prevent runaway loops.
    - id: CUST-0004
      name: Context Compiler Team
      description: Engineers building CCP/RCP compilation, impact expansion, and Context Efficiency scoring.
      holon_id: HOLON-CONTEXT-COMPILER
      primary_jobs_to_be_done:
        - Compile Review Context Packs (RCPs) for each gate role.
        - Perform deterministic impact expansion for changesets.
        - Score Context Efficiency (Context Discipline) for consumption holons.
      constraints:
        - RCP compilation must be deterministic for identical inputs.
        - Impact expansion must use pinned toolchains; non-deterministic tools prohibited.
    - id: CUST-0005
      name: GitHub Adapter Team
      description: Engineers responsible for projection-only sync and divergence watchdog.
      holon_id: HOLON-GITHUB-ADAPTER
      primary_jobs_to_be_done:
        - Project authoritative ledger state to GitHub (checks, status, labels, comments).
        - Import CI evidence as raw artifacts, not truth signals.
        - Detect and react to external trunk divergence.
      constraints:
        - Sync direction is always ledger -> GitHub (never reverse).
        - Only adapter identity may write GitHub checks/status/labels/comments.
        - CI conclusions are observations; they never substitute for internal gate decisions.
    - id: CUST-0006
      name: Auditor Team
      description: Engineers responsible for measurement integrity and drift/holdout auditing (Phase 2).
      holon_id: HOLON-AUDITOR
      primary_jobs_to_be_done:
        - Run holdout suites with known-bad ChangeSets to measure false negatives.
        - Sample gate outcomes vs evidence to detect evaluator drift.
        - Quarantine affected policies when drift thresholds are exceeded.
      constraints:
        - Holdout ChangeSets are isolated from production trunk (no merge capability).
        - Audits are measurement channels; they do not auto-merge or auto-block in Phase 1.
  stakeholder_entities:
    - id: STKH-0001
      name: GitHub
      entity_type: external_platform
      description: External forge platform used as projection target for status, checks, and labels.
      constraints:
        - Treated as projection-only; never as source of truth.
        - All writes are idempotent and keyed by fingerprint.
        - Tamper detection triggers defect records and projection overwrite.
    - id: STKH-0002
      name: CI Providers
      entity_type: external_service
      description: External CI systems (GitHub Actions, etc.) providing workflow execution and artifacts.
      constraints:
        - CI conclusions are treated as observations, not admission signals.
        - Evidence-backed import required for readiness transitions when CI gating enabled.
        - Re-run critical verifiers in controlled environments for T3 changes.
    - id: STKH-0003
      name: APM2 Kernel (PRD-0001)
      entity_type: internal_prd
      description: Core kernel providing ledger, CAS, holonic execution, and event signing primitives.
      constraints:
        - FAC inherits signed event requirements from kernel.
        - Critical events use Ed25519 with domain-separated signatures.
    - id: STKH-0004
      name: Work Substrate (PRD-0004)
      entity_type: internal_prd
      description: Work management substrate providing GateRunCompleted, GitHub sync, and critical event signing.
      constraints:
        - FAC inherits REQ-0009 (Signed GateRunCompleted), REQ-0015 (GitHub sync adapter), REQ-0025 (Critical Event Signing).
    - id: STKH-0005
      name: Context-as-Code (PRD-0007)
      entity_type: internal_prd
      description: Canonical context pipeline providing ContextPacks, stable-ID addressing, and hermetic consumption.
      constraints:
        - RCPs are compiled via CAC infrastructure.
        - ContextPack manifests define allowlist for OCAP context firewall.
  user_journeys:
    - id: UJ-0001
      name: Changeset Ingestion
      description: The workflow from changeset creation to view commitment binding.
      steps:
        - Coordinator receives work_id, plan_snapshot_hash, base_selector, and workspace delta.
        - All selectors are resolved to concrete git object IDs (no symbolic HEAD).
        - Workspace deltas are stored as content-addressed artifacts.
        - ChangeSetDigest and PRBundle are produced.
        - View commitment is bound to ledger anchor + pinned digests.
        - CAS-at-commit ensures changeset_digest is bound to work_id before gate episodes spawn.
      failure_modes:
        - INVALID_SELECTOR if symbolic selectors not resolved.
        - UNPINNED_INPUTS if workspace delta is disk-inferred rather than content-addressed.
      observability_notes:
        - RunReceipt emitted with changeset_digest, pr_bundle_hash, view_commitment_hash.
        - All binding events recorded in ledger with hash references.
    - id: UJ-0002
      name: Admission Decision
      description: The workflow from gate execution to merge receipt emission.
      steps:
        - Context Compiler produces RCPs for quality, security, and AAT gates.
        - Governance mints GateLeases scoped to (work_id, gate_id, changeset_digest, executor, expiry_ref).
        - Gate executors run under OCAP context firewall with RCP allowlist.
        - Each gate produces signed GateRunCompleted with evidence_bundle_hash, gate_receipt_id, and gate_receipt_payload_hash (typed payload in CAS).
        - Kernel Gate verifies all required gate signatures, lease validity, and changeset_digest match.
        - On approval, adapter performs atomic merge and observes trunk update.
        - MergeReceipt is emitted binding (base_selector, changeset_digest, gate_receipts) -> result_selector.
      failure_modes:
        - GATE_MISSING if required gate not satisfied.
        - GATE_STALE_SHA if changeset_digest mismatch.
        - CONTEXT_MISS if gate session lacks required context.
        - INVALID_SIGNATURE if GateRunCompleted signature invalid.
        - UNAUTHORIZED_EXECUTOR if signer not authorized/leased.
      observability_notes:
        - GateLeaseIssued, GateRunStarted, GateRunCompleted events recorded.
        - Admission decision and MergeReceipt recorded with full binding.
    - id: UJ-0003
      name: Divergence Recovery
      description: The workflow when external trunk diverges from internal MergeReceipt truth.
      steps:
        - Divergence watchdog polls external trunk HEAD at HTF-defined interval (TIME_TBD).
        - If external HEAD differs from latest MergeReceipt result_selector, divergence detected.
        - DefectRecord(PROJECTION_DIVERGENCE) emitted with observed vs expected heads.
        - InterventionFreeze(scope=repo) halts new FAC admissions for affected repo.
        - AdjudicationRequested(request_type=EMERGENCY_RECOVERY) opened with divergence evidence.
        - Unfreeze requires explicit adjudication or PRD-0007 emergency_override ceremony.
      failure_modes:
        - Prolonged freeze if adjudication not resolved.
        - Data loss if divergence caused by external force push.
      observability_notes:
        - Freeze and unfreeze events recorded in ledger.
        - Divergence evidence preserved for audit.

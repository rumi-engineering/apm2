prd_success_metrics:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  metrics:
    - id: MET-0001
      name: Gate spoofing prevention rate
      description: |
        Percentage of gate outcomes that are cryptographically verified via signed
        GateRunCompleted events with valid leases.
      baseline: "0% (no cryptographic enforcement pre-FAC)"
      target: "100% of gate outcomes verified; 0 spoofed gates admitted"
      measurement_method: |
        Count GateRunCompleted events with valid signatures and matching leases vs total
        gate outcome attempts. Track INVALID_SIGNATURE and UNAUTHORIZED_EXECUTOR defects.
      evidence_ids:
        - EVID-0001
    - id: MET-0002
      name: MergeReceipt coverage rate
      description: |
        Percentage of trunk merges that are backed by cryptographically signed
        MergeReceipts binding (base, changeset, gates) -> result.
      baseline: "0% (no MergeReceipt mechanism pre-FAC)"
      target: "100% within Phase 1; all merges produce MergeReceipts"
      measurement_method: |
        Compare trunk commits to MergeReceipt result_selectors in ledger. Any trunk
        commit without corresponding MergeReceipt is a defect.
      evidence_ids:
        - EVID-0002
    - id: MET-0003
      name: Context firewall enforcement rate
      description: |
        Percentage of consumption-mode reads that are properly allowlisted via
        ContextPackManifest. Measures OCAP containment effectiveness.
      baseline: "Baseline established from initial ledger window; expected >20% denial rate initially."
      target: "<5% denial rate within configured ledger window; <1% within extended ledger window"
      measurement_method: |
        Aggregate ToolDecided=DENY events with rule_id CTX-ALLOWLIST-001. Compute rate
        per 1000 gate runs with Wilson score interval.
      evidence_ids:
        - EVID-0003
    - id: MET-0004
      name: Context pack sufficiency rate
      description: |
        Fraction of gate runs completed without CONTEXT_MISS termination,
        indicating RCP compilation quality.
      baseline: "Baseline established from initial ledger window; expected <70% initially."
      target: ">95% within configured ledger window; >99% within extended ledger window"
      measurement_method: |
        RunReceipt analysis for context_pack_sufficiency=true. Track SessionTerminated
        events with rationale=CONTEXT_MISS.
      evidence_ids:
        - EVID-0004
    - id: MET-0005
      name: Projection divergence detection latency
      description: |
        Time between external trunk divergence and PROJECTION_DIVERGENCE defect
        emission plus admission freeze.
      baseline: "No detection mechanism pre-FAC (infinite latency measured in tick deltas)."
      target: "Detection latency <= configured tick threshold; freeze within configured tick threshold"
      measurement_method: |
        Compare divergence watchdog poll ticks to InterventionFreeze ticks.
        Track poll_interval_ticks compliance. Primary index by tick deltas.
      evidence_ids:
        - EVID-0005
    - id: MET-0006
      name: CI evidence import compliance rate
      description: |
        Percentage of READY_FOR_REVIEW transitions backed by imported raw CI
        evidence digests and adapter attestation.
      baseline: "0% (no CI evidence import mechanism pre-FAC)"
      target: "100% when CI_GATED_QUEUE_ENABLED=true; fail-closed on missing evidence"
      measurement_method: |
        Track WorkTransition events to READY_FOR_REVIEW. Verify corresponding
        EvidencePublished entries exist with ci_import_attestation_hash.
      evidence_ids:
        - EVID-0006
    - id: MET-0007
      name: Lease expiry enforcement rate
      description: |
        Percentage of GateRunCompleted events that reference unexpired leases at
        time of verification.
      baseline: "N/A (no lease mechanism pre-FAC)"
      target: "100%; 0 gate outcomes accepted with expired leases"
      measurement_method: |
        Compare GateRunCompleted HTF time to lease time_envelope_ref. Track rejection rate
        for expired-lease attempts (HTF).
      evidence_ids:
        - EVID-0007
    - id: MET-0008
      name: Echo-trap detection rate
      description: |
        Percentage of reasoning degeneration episodes detected and terminated
        before exceeding threshold.
      baseline: "Baseline established from initial ledger window."
      target: "100% detection when FindingSignature repeats 3+ times without delta"
      measurement_method: |
        Track SessionTerminated events with rationale=REASONING_DEGENERATION and
        DefectRecord(ECHO_TRAP). Verify threshold=3 enforcement.
      evidence_ids:
        - EVID-0008
    - id: MET-0009
      name: COI enforcement compliance rate
      description: |
        Percentage of gate executions where executor is verified as not being
        the ChangeSet author (or in same COI group).
      baseline: "0% (no COI enforcement pre-FAC)"
      target: "100%; 0 COI violations in gate execution"
      measurement_method: |
        Verify executor_actor_id vs changeset author at lease issuance. Track
        AdjudicationRequested(request_type=WAIVER) for explicit exceptions.
      evidence_ids:
        - EVID-0009
    - id: MET-0010
      name: Evaluator drift detection rate (Phase 2)
      description: |
        Percentage of gate policy drift detected through holdout audits and
        outcome sampling.
      baseline: "Baseline established after Phase 2 holdout suite deployment."
      target: ">95% detection of false-negative rate exceeding threshold; quarantine within configured tick window"
      measurement_method: |
        Track FAC-90-HOLDOUT_AUDIT results. Compare false_negative_rate to threshold.
        Verify EVALUATOR_DRIFT emission and policy quarantine timing.
      evidence_ids:
        - EVID-0010
    - id: MET-0011
      name: AAT typed receipt coverage rate
      description: |
        Percentage of AAT-required gate outcomes with typed GateReceipt payloads
        including view_commitment_hash and determinism metadata.
      baseline: "0% (no typed payload enforcement pre-FAC)"
      target: "100% for gate_id=aat when AAT is required by policy"
      measurement_method: |
        Verify GateReceipt payloads for gate_id=aat include required fields and
        match FAC-00 view_commitment_hash.
      evidence_ids:
        - EVID-0018
        - EVID-0020
    - id: MET-0012
      name: Determinism envelope stability rate
      description: |
        Percentage of determinism-required gate runs that produce identical terminal evidence
        across N runs (default 3) and are accepted.
      baseline: "Baseline established after Phase 2 determinism enforcement."
      target: ">95% stability for AAT; >99% for deterministic gates"
      measurement_method: |
        Compare terminal_evidence_digest and terminal_verifier_outputs_digest across N runs. Track
        GATE_NONDETERMINISTIC defects and acceptance rates.
      evidence_ids:
        - EVID-0019
    - id: MET-0013
      name: Nondeterminism quarantine rate
      description: |
        Rate of changesets quarantined or aborted due to nondeterministic gate outcomes.
      baseline: "Baseline established after Phase 2 determinism enforcement."
      target: "<1% of changesets quarantined; 0 repeated nondeterminism accepted"
      measurement_method: |
        Track WorkTransitioned rationale=QUARANTINED_CHANGESET and WorkAborted
        abort_reason=POLICY_DENY following GATE_NONDETERMINISTIC defects.
      evidence_ids:
        - EVID-0021
    - id: MET-0014
      name: AAT evidence-chain completeness rate
      description: |
        Percentage of AAT receipts that include transcript hash chain, artifact manifest hash,
        terminal verifier outputs, and minimum attestation fields.
      baseline: "0% (no evidence-chain enforcement pre-FAC)"
      target: "100% for AAT-required gate outcomes"
      measurement_method: |
        Validate GateReceipt payloads for required fields (transcript_chain_root_hash,
        transcript_bundle_hash, artifact_manifest_hash, terminal_verifier_outputs,
        terminal_evidence_digest, observational_evidence_digest, attestation).
      evidence_ids:
        - EVID-0022
    - id: MET-0015
      name: AAT escape rate
      description: |
        Post-merge defects tagged as "should have been caught by AAT" per holdout and
        production incident review.
      baseline: "Baseline established after Phase 2 holdouts."
      target: "<1% escape rate; trending down over ledger sequence windows"
      measurement_method: |
        Track defect taxonomy tags AAT_FALSE_NEGATIVE / HOLDOUT_FALSE_NEGATIVE and
        correlate with changeset risk tier. Index by ledger windows; wall-time trends are observational only.
      evidence_ids:
        - EVID-0010
    - id: MET-0016
      name: Flake attribution distribution
      description: |
        Distribution of AAT mismatches by flake_class values:
        HARNESS_FLAKE, ENVIRONMENT_DRIFT, TEST_NONSEMANTIC, CODE_NONSEMANTIC, UNKNOWN.
      baseline: "Baseline established after flake classification rollout."
      target: "UNKNOWN <5%; HARNESS_FLAKE + ENVIRONMENT_DRIFT trending down over ledger windows"
      measurement_method: |
        Aggregate GateReceipt flake_class across AAT mismatches/failures and correlate with quarantine events.
        Index by ledger sequence windows; wall-time aggregation is observational only.
      evidence_ids:
        - EVID-0025
    - id: MET-0017
      name: AAT signal density
      description: |
        Defects per AAT run or per tick window to ensure AAT yields actionable signal.
      baseline: "Baseline established after AAT rollout."
      target: "Signal density increases over ledger sequence windows"
      measurement_method: |
        Compute defects linked to AAT evidence bundles divided by total AAT runtime in tick deltas.
        Index by ledger windows; wall-time overlay is observational only.
      evidence_ids:
        - EVID-0024
    - id: MET-0018
      name: Median tick-delta-to-actionable AAT output
      description: |
        Median tick delta from AAT failure to actionable fix (measured via defect closure).
        Primary axis is MonotonicTicks (M) delta.
      baseline: "Baseline established after AAT rollout."
      target: "<1 configured tick window for HIGH-risk tier"
      measurement_method: |
        Track tick delta between AAT defect creation and linked fix merge, stratified by risk tier.
        Index by tick deltas; wall-time overlay is bounded and non-authoritative.
      evidence_ids:
        - EVID-0027
    - id: MET-0019
      name: Anti-downgrade enforcement rate
      description: |
        Rate of detected downgrade attempts versus total AAT receipts.
      baseline: "Baseline established after anti-downgrade enforcement."
      target: "0% of downgrades accepted; 100% downgrade attempts rejected"
      measurement_method: |
        Track AAT_POLICY_DOWNGRADE_ATTEMPT and AAT_PROFILE_SUBSTITUTION defects; verify
        no admissions proceed when these defects are present.
      evidence_ids:
        - EVID-0028
    - id: MET-0020
      name: AAT reuse integrity rate
      description: |
        Percentage of AAT reuses with exact provenance tuple match; mismatches are defects.
      baseline: "Baseline established after reuse policy rollout."
      target: "100% provenance match; 0 AAT_CACHE_KEY_MISMATCH accepted"
      measurement_method: |
        Track AATResultReused events and validate key tuple equality; count AAT_CACHE_KEY_MISMATCH defects.
      evidence_ids:
        - EVID-0029
    - id: MET-0021
      name: Evidence hygiene compliance rate
      description: |
        Percentage of AAT evidence artifacts with classification, redaction metadata, and retention window (HTF).
      baseline: "Baseline established after evidence hygiene enforcement."
      target: "100% compliance; 0 AAT_EVIDENCE_POLICY_VIOLATION accepted"
      measurement_method: |
        Validate evidence artifact metadata for AAT receipts; track AAT_EVIDENCE_POLICY_VIOLATION defects.
      evidence_ids:
        - EVID-0030
    - id: MET-0022
      name: HIGH-risk quorum coverage rate
      description: |
        Percentage of HIGH-risk admissions that include two independent AAT receipts.
      baseline: "Baseline established after quorum enforcement."
      target: "100% for risk_tier=HIGH"
      measurement_method: |
        Validate presence of two receipts with disjoint runner pool identities; track missing quorum defects.
      evidence_ids:
        - EVID-0031
  guardrails:
    - id: GRD-0001
      name: Admission decision internal-only
      threshold: "Admission MUST read only internal projections; GitHub status never consulted as truth."
      response_plan: |
        Any code path that reads GitHub status for admission decisions is a critical
        defect. Immediate code review and rollback required.
      evidence_ids:
        - EVID-0016
    - id: GRD-0002
      name: Signature verification mandatory
      threshold: "GateRunCompleted events MUST be rejected if signature verification fails."
      response_plan: |
        INVALID_SIGNATURE defect emits. Gate outcome not accepted. Session terminated
        and escalated for investigation.
      evidence_ids:
        - EVID-0017
    - id: GRD-0003
      name: Context firewall fail-closed
      threshold: "Reads outside ContextPackManifest allowlist MUST be denied."
      response_plan: |
        ToolDecided=DENY with rule_id CTX-ALLOWLIST-001. On CONTEXT_MISS, session
        terminates and triggers refinement loop.
      evidence_ids:
        - EVID-0001
        - EVID-0002
    - id: GRD-0004
      name: Projection divergence freeze
      threshold: "External trunk divergence MUST trigger InterventionFreeze within configured tick window."
      response_plan: |
        PROJECTION_DIVERGENCE defect emitted. New FAC admissions blocked for repo.
        Unfreeze requires AdjudicationResolved or emergency_override ceremony.
      evidence_ids:
        - EVID-0003
        - EVID-0004
    - id: GRD-0005
      name: Lease scope immutability
      threshold: "Child leases MUST NOT broaden parent lease scope."
      response_plan: |
        LEASE_SCOPE_BROADENED defect emitted. Lease rejected. Session not spawned.
      evidence_ids:
        - EVID-0007
    - id: GRD-0006
      name: Ambient credential prohibition
      threshold: "No agent processes inherit GitHub tokens/ssh keys; only adapter has projection credentials."
      response_plan: |
        Any attempt to access forbidden credentials emits PolicyViolation and quarantines
        session immediately.
      evidence_ids:
        - EVID-0011
    - id: GRD-0007
      name: Terminal verifier supremacy
      threshold: "Advisory narratives MUST NOT substitute for terminal-verifier evidence in admission decisions."
      response_plan: |
        Admission pipeline rejects gate outcomes lacking terminal-verifier evidence.
        Advisory signals recorded but not used for gate pass/fail.
      evidence_ids:
        - EVID-0012
    - id: GRD-0008
      name: Determinism envelope enforced
      threshold: "Gates with determinism_class > 0 MUST satisfy N-run stability before PASS."
      response_plan: |
        GATE_NONDETERMINISTIC defect emitted; quarantine events emitted for pools/specs.
        Admission does not proceed without eligible alternates; repeated nondeterminism aborts per policy.
      evidence_ids:
        - EVID-0019
        - EVID-0021
    - id: GRD-0009
      name: AAT evidence-chain enforcement
      threshold: "AAT PASS requires transcript chain + terminal verifier outputs + attestation fields."
      response_plan: |
        Admission rejects AAT receipts missing evidence bindings; emit AAT_EVIDENCE_MISSING
        or AAT_TERMINAL_VERIFIER_MISSING and quarantine changeset until resolved.
      evidence_ids:
        - EVID-0022
        - EVID-0023
    - id: GRD-0010
      name: Risk-tiered AAT selection integrity
      threshold: "HIGH-risk changes MUST include AAT with matching selection_policy_id."
      response_plan: |
        AAT_POLICY_MISMATCH defect emitted; admission blocked until selection policy corrected.
      evidence_ids:
        - EVID-0024
    - id: GRD-0011
      name: Anti-downgrade enforcement
      threshold: "Resolved AAT policy tuple MUST NOT be downgraded without waiver."
      response_plan: |
        AAT_POLICY_DOWNGRADE_ATTEMPT or AAT_PROFILE_SUBSTITUTION defect emitted; admission blocked
        until waiver is approved and projection-visible.
      evidence_ids:
        - EVID-0028
    - id: GRD-0012
      name: AAT reuse provenance integrity
      threshold: "AAT reuse MUST match exact provenance tuple."
      response_plan: |
        AAT_CACHE_KEY_MISMATCH defect emitted; reuse rejected and cache entry invalidated.
      evidence_ids:
        - EVID-0029
    - id: GRD-0013
      name: Evidence hygiene enforcement
      threshold: "AAT evidence artifacts MUST meet classification/redaction/retention policy."
      response_plan: |
        AAT_EVIDENCE_POLICY_VIOLATION defect emitted; admission blocked until evidence remediated.
      evidence_ids:
        - EVID-0030
  definition_of_done:
    phase_1:
      name: "Phase 1 (FAC Core Hardening)"
      deliverables:
        - "New gate events (GateLeaseIssued, GateRunStarted, GateRunCompleted) with mandatory signature verification on ingestion."
        - "OCAP context firewall enforced mechanically for CONSUME holons."
        - "GitHub adapter projection-only; status setters outside adapter removed from skills and denied by policy."
        - "Projection divergence watchdog + freeze/unfreeze path."
      criteria:
        - "An autonomous agent cannot flip a gate outcome or merge by manipulating GitHub or xtask; it must produce signed internal events and receipts."
        - "A GateRun cannot proceed with missing context; it terminates and triggers pack refinement."
    phase_2:
      name: "Phase 2 (Measurement Integrity + Goodhart Resistance)"
      deliverables:
        - "Holdout suite runner (known-bad changes) to measure false negatives."
        - "Auditor sampling of gate outcomes vs evidence; drift alerts and policy quarantine."
        - "Echo-trap metrics feeding instruction and pack compiler updates."
        - "Determinism envelope enforcement for gates with determinism_class > 0 (AAT first)."
      criteria:
        - "False-negative rate is measured and tracked for all gate policies."
        - "Evaluator drift triggers automatic policy quarantine and adjudication requirement."
        - "Nondeterministic gate outcomes trigger GATE_NONDETERMINISTIC and fail-closed quarantine/abort."
        - "AAT escape rate, flake attribution, and signal density are measured and reviewed."
    phase_3:
      name: "Phase 3 (Autonomous Improvement Substrate)"
      deliverables:
        - "Defect-driven auto-tuning of pack specs and instructions under CAC governance."
        - "Provider routing improvements with safe fallback and classification-aware routing."
      criteria:
        - "Pack specs improve automatically based on CONTEXT_MISS defect patterns."
        - "Provider failures are classified and routed with circuit breaker protection."

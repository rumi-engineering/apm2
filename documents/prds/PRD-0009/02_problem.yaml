prd_problem:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  context:
    background: |
      APM2 already has a signed, hash-chained ledger and a content-addressed store (CAS).
      The system uses holonic execution with explicit leases and budgets. PRD-0004 defines
      the Work Substrate with gate events and GitHub sync capabilities. PRD-0007 defines
      Context-as-Code with ContextPacks and hermetic consumption. However, the admission
      protocol from changeset to merge currently relies on external forge signals (GitHub
      status checks) which can be spoofed or manipulated by autonomous agents.
    current_state: |
      Agents can currently manipulate external status checks and bypass intended scrutiny.
      GitHub is treated as a source of truth for admission decisions, creating an adversarial
      surface. Gate outcomes are not cryptographically bound to changesets or executors.
      There is no mechanical enforcement of context boundaries during gate execution.
      Projection divergence between ledger and external forge is not detected or handled.
      CI evidence is accepted as truth rather than imported as observations requiring
      internal verification.
    why_now: |
      Agents currently can spoof external statuses and bypass intended scrutiny.
      FAC closes the loop with internal authority minting, OCAP containment, and projection-only forges.
      The existing kernel primitives (ledger, CAS, holonic execution) and CAC infrastructure
      (ContextPacks, stable-ID addressing) provide the foundation to build a hardened admission
      protocol where admission is impossible to spoof and every decision is replayable.
  problem_statement:
    primary: |
      FAC is the internal, cryptographically enforced admission protocol. Reviewers/verifiers
      sign lease-bound outcomes. Merges are proven by MergeReceipts. GitHub is a projection.
    north_star: |
      APM2 CLI runs the PR inner loop as a hardened protocol: admission is impossible to spoof,
      and every decision is replayable from ledger+CAS under strict OCAP.
    supporting_details:
      - External forge status checks can be manipulated by autonomous agents.
      - No cryptographic binding exists between gate outcomes and changesets/executors.
      - No mechanical enforcement prevents context discovery during gate execution.
      - No divergence detection exists between ledger truth and external forge state.
      - CI signals are accepted as truth without evidence-backed verification.
  observed_failure_modes:
    - id: FM-0001
      name: Status spoofing via external forge manipulation
      mechanism: Autonomous agents manipulate GitHub status checks directly to bypass gate scrutiny.
      impact:
        - Unapproved changes reach trunk without proper review.
        - Security vulnerabilities introduced without detection.
        - Audit trail incomplete due to bypassed gates.
      alternative_interventions:
        - id: ALT-FM001-01
          intervention: "Stricter GitHub branch protection rules"
          assessment: "Addresses symptom (harder to bypass) but agents with token access can still manipulate; does not eliminate adversarial surface."
        - id: ALT-FM001-02
          intervention: "Dual-approval workflows requiring human sign-off"
          assessment: "Slows automation; humans can be socially engineered; does not address root cause of external truth dependency."
        - id: ALT-FM001-03
          intervention: "Audit logging of status changes with alerts"
          assessment: "Detective only; catches manipulation after the fact; does not prevent admission."
      fac_superiority: |
        FAC is superior because gate outcomes are cryptographically signed by authorized executors
        under lease-bound authority. Status checks are projections of internal truth, not inputs to
        admission decisions. Even if an agent manipulates GitHub, admission requires valid internal
        signatures that cannot be forged. Alternative interventions address symptoms; FAC addresses
        the root cause by making external forges projection-only.
    - id: FM-0002
      name: Gate outcome forgery via unsigned events
      mechanism: Gate outcomes are recorded without cryptographic binding to executor identity or changeset.
      impact:
        - Outcomes can be replayed or modified.
        - Executor accountability is unprovable.
        - Admission decisions based on unverified claims.
      alternative_interventions:
        - id: ALT-FM002-01
          intervention: "Access control lists for gate outcome writers"
          assessment: "Relies on perimeter security; compromised credentials allow forgery; no cryptographic proof."
        - id: ALT-FM002-02
          intervention: "Append-only logs with tamper detection"
          assessment: "Detects modification but does not prevent unauthorized writes; no executor binding."
        - id: ALT-FM002-03
          intervention: "Code review of gate implementations"
          assessment: "Addresses implementation bugs but not protocol-level forgery; human review does not scale."
      fac_superiority: |
        FAC requires GateRunCompleted to be signed with Ed25519 using domain-separated signatures.
        The signature binds the outcome to the executor identity and changeset_digest. Lease validity
        is verified at admission time. Unsigned or incorrectly signed outcomes are rejected with
        INVALID_SIGNATURE or UNAUTHORIZED_EXECUTOR defects. Cryptographic proof replaces trust assumptions.
    - id: FM-0003
      name: Context leakage during gate execution
      mechanism: Gate executors perform discretionary reads outside their assigned context pack, accessing information they should not see.
      impact:
        - Non-deterministic gate outcomes.
        - Information leakage across security boundaries.
        - Unpredictable and unreproducible review behavior.
      alternative_interventions:
        - id: ALT-FM003-01
          intervention: "Sandboxed execution environments"
          assessment: "Limits system access but does not constrain LLM context; agents can still request arbitrary reads via tools."
        - id: ALT-FM003-02
          intervention: "Tool call auditing and alerting"
          assessment: "Detective only; does not prevent leakage; alerts after the fact."
        - id: ALT-FM003-03
          intervention: "Pre-flight context approval workflows"
          assessment: "Manual and slow; does not scale; approval is per-run not per-read."
      fac_superiority: |
        FAC enforces OCAP context firewall mechanically. Repo/file reads are allowed only for objects
        explicitly enumerated in the RCP manifest allowlist. Reads outside the allowlist emit
        ToolDecided=DENY with rule_id CTX-ALLOWLIST-001. Context misses terminate the session with
        rationale CONTEXT_MISS and trigger refinement. This is preventative, not detective, and operates
        at tool invocation granularity.
    - id: FM-0004
      name: Projection divergence without detection
      mechanism: External trunk state diverges from internal MergeReceipt truth (force push, manual merge, sync failure) without detection or reaction.
      impact:
        - Ledger and external forge in inconsistent states.
        - Humans and agents see different truths.
        - Subsequent admissions based on stale assumptions.
      alternative_interventions:
        - id: ALT-FM004-01
          intervention: "Protected branches preventing force push"
          assessment: "Helps but does not cover all divergence causes (manual merges, sync failures); no detection mechanism."
        - id: ALT-FM004-02
          intervention: "Periodic manual reconciliation"
          assessment: "Slow and error-prone; does not prevent divergence during reconciliation windows (HTF-defined)."
        - id: ALT-FM004-03
          intervention: "Webhook notifications on branch updates"
          assessment: "Provides signals but requires custom handling; no built-in freeze mechanism."
      fac_superiority: |
        FAC includes a divergence watchdog that continuously compares external trunk HEAD to the latest
        MergeReceipt result_selector. On divergence, PROJECTION_DIVERGENCE defect is emitted and
        InterventionFreeze halts admissions until reconciliation. Unfreeze requires explicit adjudication.
        This is automatic, continuous, and fail-closed.
    - id: FM-0005
      name: CI conclusions accepted as admission truth
      mechanism: CI success/failure conclusions are treated as authoritative signals for admission without evidence-backed verification.
      impact:
        - CI spoofing enables admission bypass.
        - CI environment assumptions not verified.
        - No attestation of actual test execution.
      alternative_interventions:
        - id: ALT-FM005-01
          intervention: "Required CI checks in branch protection"
          assessment: "Relies on CI conclusions as truth; spoofable; no evidence verification."
        - id: ALT-FM005-02
          intervention: "Multiple CI providers for redundancy"
          assessment: "Increases cost; does not address trust model; all providers can be spoofed."
        - id: ALT-FM005-03
          intervention: "Manual verification of CI artifacts"
          assessment: "Does not scale; human error; slow feedback loop."
      fac_superiority: |
        FAC treats CI conclusions as observations, not truth. When CI gating is enabled, READY_FOR_REVIEW
        transitions require: (a) webhook signature verified, (b) raw log/artifact digests imported into CAS,
        (c) adapter attestation signed and committed. A plain 'success' conclusion without evidence import
        is ignored (fail-closed). Admission requires internal gates using terminal verifiers with attested evidence.
  non_goals:
    - id: NG-0001
      statement: Building a universal CI integration framework.
      clarification: |
        FAC imports CI evidence from specific supported providers (GitHub Actions initially).
        Universal CI integration is out of scope; each provider requires explicit adapter support.
    - id: NG-0002
      statement: Replacing existing kernel Protobuf schemas for gate events.
      clarification: |
        FAC does not replace existing kernel schemas; placement of new Gate/Projection/
        Intervention payloads remains an open design decision (see Q-FAC-0001).
        Full schema replacement is an optional post-MVP enhancement.
    - id: NG-0003
      statement: Automated divergence resolution without human adjudication.
      clarification: |
        Divergence triggers freeze and requires explicit adjudication or emergency override.
        Automated resolution risks data loss and is out of scope.
    - id: NG-0004
      statement: Full Goodhart resistance in Phase 1.
      clarification: |
        Holdout suites and evaluator audits are Phase 2 deliverables.
        Phase 1 focuses on core admission hardening without measurement integrity.
    - id: NG-0005
      statement: Cross-provider prompt equivalence guarantees.
      clarification: |
        Provider routing is classification-aware but prompt equivalence across providers
        is an open issue. Phase 1 uses deterministic routing profiles per stage.

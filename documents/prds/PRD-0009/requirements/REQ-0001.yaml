prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: "REQ-0001"
  type: "SECURITY"
  source_id: "FAC-REQ-0100"
  title: "Mechanical Context Firewall"
  statement: |
    apm2-daemon MUST deny any read outside ContextPack allowlist for CONSUME-mode holons;
    context misses MUST terminate and trigger refinement.
  acceptance_criteria:
    - "Denied reads emit ToolDecided=DENY with rule_id CTX-ALLOWLIST-001. Verified by: Test that repo.read or file.read operations outside the ContextPackManifest allowlist emit ToolDecided event with decision=DENY and rule_id=CTX-ALLOWLIST-001."
    - "SessionTerminated rationale=CONTEXT_MISS occurs when required context absent; GateRunCompleted is not emitted. Verified by: Test that missing required context triggers SessionTerminated with rationale CONTEXT_MISS and no GateRunCompleted event is recorded."
    - "Context refinement is triggered after CONTEXT_MISS termination. Verified by: Test that CONTEXT_MISS triggers ContextRefinementRequest and coordinator reissues lease after refined pack is produced."
    - "RunReceipt records context sufficiency metrics (bytes supplied, entries used, misses, denied reads, efficiency score). Verified by: Test that RunReceipt schema includes all required context sufficiency fields and they are populated correctly."
    - "Excessive zoom/refinement requests emit ECHO_TRAP and escalate. Verified by: Test that repeated ContextRefinementRequest beyond threshold triggers DefectRecord with code ECHO_TRAP and SessionTerminated rationale=REASONING_DEGENERATION, with OracleRequest or AdjudicationRequested."
  evidence:
    evidence_ids:
      - EVID-0001
      - EVID-0002
  law_alignment:
    - law_id: "LAW-05"
      enforcement: "Mechanical context firewall + capability scoping; no ambient credentials"
      applies_to:
        - "OCAP mediated tools"
        - "ContextPackManifest allowlist"
    - law_id: "LAW-02"
      enforcement: "Context sufficiency observed; context misses terminate and trigger refinement"
      applies_to:
        - "ContextPack"
        - "RunReceipt"
    - law_id: "LAW-12"
      enforcement: "Bounded retries, echo-trap detection, oracle escalation"
      applies_to:
        - "Coordinator"
        - "Echo-trap detection"
  defect_codes:
    - code: "CONTEXT_FIREWALL_DENY"
      severity: "S2"
      description: "Attempted read outside pack allowlist"
    - code: "CONTEXT_MISS"
      severity: "S2"
      description: "Pack lacks required context; session terminated; triggers refinement loop"
    - code: "ECHO_TRAP"
      severity: "S2"
      description: "Reasoning degeneration detected (repeated finding signatures)"

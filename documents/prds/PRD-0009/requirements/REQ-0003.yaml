prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: "REQ-0003"
  type: "SECURITY"
  source_id: "FAC-REQ-0102"
  title: "CI evidence-backed readiness gating"
  statement: |
    If CI is used to transition work into READY_FOR_REVIEW, the transition MUST be backed
    by imported raw evidence digests and adapter attestation at or above the policy-defined
    minimum level (L1 or higher). L0 (status-only) is insufficient.
  acceptance_criteria:
    - "No transition based only on 'success' conclusion. Verified by: Test that CI webhook with only conclusion='success' and no evidence import does not trigger READY_FOR_REVIEW transition."
    - "EvidencePublished entries exist for CI logs/artifacts and are referenced from transition rationale metadata. Verified by: Test that READY_FOR_REVIEW transition includes EvidencePublished events for workflow logs, test reports, and artifacts with CAS hashes."
    - "Webhook signature is verified before evidence import. Verified by: Test that CI events from webhooks without valid signature are rejected and do not trigger any evidence import."
    - "Raw log/artifact digests are imported into CAS. Verified by: Test that workflow logs (compressed), test reports/artifacts, and workflow metadata are stored in CAS with content hashes."
    - "Adapter attestation is signed and committed. Verified by: Test that CI import produces signed attestation from HOLON-GITHUB-ADAPTER including workflow_run_id and downloaded_artifact_hashes."
    - "Attestation level meets or exceeds policy minimum; L0 is rejected when gating enabled. Verified by: L0 rejection/L1 acceptance tests."
    - "Feature flags control CI gating behavior (fail-closed default). Verified by: Test that when CI_EVENTS_ENABLED=false, CI events are ignored; when CI_GATED_QUEUE_ENABLED=false, READY_FOR_REVIEW transitions do not require attested evidence."
  evidence:
    evidence_ids:
      - EVID-0005
      - EVID-0006
      - EVID-0035
  law_alignment:
    - law_id: "LAW-04"
      enforcement: "Terminal verifiers anchor; advisory signals never sole admission basis"
      applies_to:
        - "LLM reviewers"
        - "CI conclusions"
    - law_id: "LAW-15"
      enforcement: "Measurement integrity: auditor sampling + drift alarms"
      applies_to:
        - "CI evidence binding"
        - "Metrics"
  defect_codes:
    - code: "CI_EVIDENCE_MISSING"
      severity: "S1"
      description: "CI readiness transition attempted without imported raw evidence digests"
    - code: "CI_SHA_MISMATCH"
      severity: "S1"
      description: "CI evidence commit SHA does not match expected changeset"
    - code: "CI_ATTESTATION_INVALID"
      severity: "S1"
      description: "CI import attestation signature invalid or missing required fields"
    - code: "CI_ATTESTATION_LEVEL_INSUFFICIENT"
      severity: "S1"
      description: "CI attestation level below policy minimum (L0 or missing)"
  feature_flags:
    - flag: "CI_EVENTS_ENABLED"
      default: false
      description: "When true, evidence-backed import is required; when false, CI events are ignored (fail-closed)"
    - flag: "CI_GATED_QUEUE_ENABLED"
      default: false
      description: "When true, READY_FOR_REVIEW transitions require attested evidence import (fail-closed)"
  attestation_levels:
    - level: "L0"
      description: "Status-only; insufficient for READY_FOR_REVIEW gating."
    - level: "L1"
      description: "Signed adapter attestation + raw artifact digests imported into CAS."
    - level: "L2"
      description: "Replayable verifier proof / reproducibility (deferred)."
    - level: "L3"
      description: "Measured boot / TPM-backed attestation (deferred)."
  attestation_schema:
    minimum_level: "L1"
    signed_by: "HOLON-GITHUB-ADAPTER"
    required_fields:
      - name: "workflow_run_id"
        description: "GitHub Actions workflow run identifier"
      - name: "downloaded_artifact_hashes"
        description: "Content hashes of all downloaded artifacts"
    optional_fields:
      - name: "runner_image_digest"
        description: "Digest of CI runner image (optional; may require self-hosted runners)"
      - name: "toolchain"
        description: "Toolchain version used in CI"
      - name: "command_transcript_hash"
        description: "Hash of command execution transcript"

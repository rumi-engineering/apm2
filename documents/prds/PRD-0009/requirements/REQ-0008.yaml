prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: "REQ-0008"
  type: "SECURITY"
  source_id: "FAC-REQ-0107"
  title: "AAT flake classification and policy routing"
  statement: |
    AAT outcomes MUST record determinism_status (STABLE|MISMATCH) and outcome_class
    (stored in payload field flake_class for compatibility). outcome_class is a canonical
    enum: DETERMINISTIC_FAIL, HARNESS_FLAKE, ENVIRONMENT_DRIFT, TEST_NONSEMANTIC, UNKNOWN
    (CODE_NONSEMANTIC optional by policy). determinism_status indicates whether a behavioral
    mismatch occurred; deterministic FAIL is verdict=FAIL with determinism_status=STABLE
    and outcome_class=DETERMINISTIC_FAIL. Policy routes each class to a specific quarantine
    or escalation path.
  acceptance_criteria:
    - "GateReceipt payload includes determinism_class, determinism_status, and flake_class when verdict=FAIL or determinism_status=MISMATCH. Verified by: Schema validation test."
    - "Deterministic FAIL uses verdict=FAIL with determinism_status=STABLE and flake_class=DETERMINISTIC_FAIL. Verified by: Policy enforcement test."
    - "UNKNOWN failures produce NEEDS_INPUT and never PASS via retries. Verified by: Policy enforcement test."
    - "HARNESS_FLAKE triggers runner pool quarantine; TEST_NONSEMANTIC triggers AAT spec quarantine. Verified by: Integration test with quarantine events."
    - "ENVIRONMENT_DRIFT invalidates attestation and blocks until re-pinned environment. Verified by: Attestation drift test."
  evidence:
    evidence_ids:
      - EVID-0025
  law_alignment:
    - law_id: "LAW-12"
      enforcement: "Bounded retries and termination discipline; classification prevents infinite retry loops."
      applies_to:
        - "Coordinator"
        - "Determinism envelope"
    - law_id: "LAW-15"
      enforcement: "Measurement integrity via explicit classification and routing."
      applies_to:
        - "GateReceipt payload"
  defect_codes:
    - code: "DETERMINISTIC_FAIL"
      severity: "S3"
      description: "Deterministic FAIL; no mismatch detected"
    - code: "HARNESS_FLAKE"
      severity: "S2"
      description: "Runner/infra nondeterminism detected"
    - code: "ENVIRONMENT_DRIFT"
      severity: "S2"
      description: "Toolchain or environment drift detected"
    - code: "TEST_NONSEMANTIC"
      severity: "S2"
      description: "AAT spec brittle or non-semantic"
    - code: "CODE_NONSEMANTIC"
      severity: "S2"
      description: "Semantically equivalent behavior with non-semantic diff"

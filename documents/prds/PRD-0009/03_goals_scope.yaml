prd_goals_scope:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  goals:
    - id: FAC-G-0001
      statement: Cryptographically signed gate outcomes - All GateRunCompleted events are signed with Ed25519 using domain-separated signatures binding executor, lease, and changeset.
      measurable_outcomes:
        - GateRunCompleted events include Ed25519 signature over canonical bytes with domain separator GATE_RUN_COMPLETED.
        - Signature binds (gate_id, lease_id, changeset_digest, executor_actor_id, evidence_bundle_hash, gate_receipt_payload_hash, gate_receipt_payload_type).
        - Unsigned or invalid signatures rejected with INVALID_SIGNATURE defect at admission.
        - 100% of gate outcomes are cryptographically verifiable from ledger.
    - id: FAC-G-0002
      statement: Lease-bound gate authority - Gate executors operate under lease-scoped authority that cannot be broadened and expires.
      measurable_outcomes:
        - GateLease scope is strict with fields (work_id, gate_id, changeset_digest, executor_actor_id, expiry_ref, policy_hash).
        - Lease issuance committed before session spawn (CAS-at-commit ordering).
        - Child leases can only narrow scope (subset rule enforced).
        - Expired (HTF-enforced) or scope-mismatched leases rejected with LEASE_SCOPE_BROADENED or UNAUTHORIZED_EXECUTOR.
    - id: FAC-G-0003
      statement: OCAP context firewall for consumption holons - Gate executors can only read objects explicitly enumerated in their RCP manifest allowlist.
      measurable_outcomes:
        - Repo/file reads outside RCP manifest allowlist emit ToolDecided=DENY with rule_id CTX-ALLOWLIST-001.
        - Context misses terminate session with rationale CONTEXT_MISS and trigger refinement.
        - RunReceipt records context sufficiency metrics (bytes supplied, entries used, misses, denied reads, ZTI score).
        - Zero unauthorized reads succeed in gate execution sessions.
    - id: FAC-G-0004
      statement: Projection-only GitHub integration - GitHub status checks are projections of internal ledger truth and never inputs to admission decisions.
      measurable_outcomes:
        - Admission reads only internal projections; never reads GitHub status as truth.
        - Only HOLON-GITHUB-ADAPTER may write GitHub checks/status/labels/comments (enforced by policy).
        - Projection is idempotent and keyed by (work_id, changeset_digest, ledger_head) fingerprint.
        - External status manipulation does not affect admission decisions.
    - id: FAC-G-0005
      statement: Divergence detection and emergency stop - External trunk divergence from MergeReceipt truth triggers freeze until adjudication.
      measurable_outcomes:
        - Divergence watchdog compares external trunk HEAD to latest MergeReceipt result_selector at HTF-defined poll interval (TIME_TBD).
        - On divergence, PROJECTION_DIVERGENCE defect emitted and InterventionFreeze(repo) halts admissions.
        - Unfreeze requires AdjudicationResolved(request_type=EMERGENCY_RECOVERY) or emergency_override ceremony.
        - Zero admissions proceed during divergence freeze.
    - id: FAC-G-0006
      statement: Evidence-backed CI import - CI transitions to READY_FOR_REVIEW require imported raw evidence digests and adapter attestation when CI gating is enabled.
      measurable_outcomes:
        - No transition based only on CI 'success' conclusion (fail-closed).
        - READY_FOR_REVIEW requires webhook signature verified, raw log/artifact digests in CAS, signed adapter attestation.
        - EvidencePublished entries exist for CI logs/artifacts and are referenced from transition rationale.
        - CI_EVIDENCE_MISSING defect emitted if evidence import bypassed.
    - id: FAC-G-0007
      statement: Atomic merge with receipt - Merges produce MergeReceipt binding inputs to result after observing trunk update.
      measurable_outcomes:
        - MergeReceipt binds (base_selector, changeset_digest, gate_receipts, policy_hash) -> result_selector.
        - MergeReceipt emitted only after result_selector (trunk digest) is observed and recorded.
        - Receipt is signed with domain separator MERGE_RECEIPT.
        - 100% of successful admissions have corresponding verifiable MergeReceipt.
    - id: FAC-G-0008
      statement: Bounded retries and echo-trap detection - Coordinator enforces bounded attempts and detects reasoning degeneration.
      measurable_outcomes:
        - Per-gate max attempts of 3 enforced.
        - Global max episodes of 50 enforced.
        - Echo-trap detected when FindingSignature repeats 3 times without delta within single GateRun.
        - On echo-trap, session terminated with rationale REASONING_DEGENERATION and DefectRecord(ECHO_TRAP) emitted.
        - Oracle escalation triggered for unresolved loops.
    - id: FAC-G-0009
      statement: Typed AAT gate receipts - AAT outcomes are recorded as typed GateReceipt payloads bound to view commitments.
      measurable_outcomes:
        - AAT GateReceipt payload includes view_commitment_hash and determinism_class.
        - AAT GateReceipt payload includes run_receipt_hashes and run_count binding all runs.
        - Admission rejects AAT GateReceipts missing required typed payload fields.
    - id: FAC-G-0010
      statement: Gate outcome determinism envelope - Deterministic gates must prove stability under coordinator-managed N-run validation.
      measurable_outcomes:
        - Determinism envelope enforces N runs with identical stability_digest (verdict + terminal_evidence_digest + terminal_verifier_outputs_digest) for determinism_class > 0.
        - Observational evidence differences do not trigger nondeterminism.
        - Nondeterminism emits GATE_NONDETERMINISTIC defect and fails closed.
        - Repeated nondeterminism quarantines and aborts changesets per policy.
    - id: FAC-G-0011
      statement: Evidence-first AAT receipts - AAT GateReceipts bind raw evidence digests, transcript chains, and attestation fields.
      measurable_outcomes:
        - AAT GateReceipt payload includes transcript_chain_root_hash and transcript_bundle_hash.
        - AAT GateReceipt payload includes artifact_manifest_hash for logs, reports, snapshots, and binaries.
        - AAT GateReceipt payload includes attestation fields (container_image_digest, toolchain_digests, runner_identity_key_id, network_policy_profile_hash).
        - Admission rejects AAT receipts missing any required evidence bindings.
    - id: FAC-G-0012
      statement: Terminal verifier binding - PASS requires machine-defined verifier outputs and predicates.
      measurable_outcomes:
        - AAT policy defines scenario_type -> allowed_verifier_kinds + required_outputs + machine_predicate.
        - GateReceipt payload includes terminal_verifier_outputs and verifier_policy_hash.
        - Admission rejects AAT PASS when required verifier outputs are missing or predicate not satisfied.
    - id: FAC-G-0013
      statement: Flake classification and policy routing - Failures are classified and routed by policy to prevent throughput collapse.
      measurable_outcomes:
        - GateReceipt payload records determinism_class, determinism_status, and outcome_class (flake_class field) for AAT failures/mismatches.
        - DETERMINISTIC_FAIL = verdict=FAIL with determinism_status=STABLE; UNKNOWN never PASS via retries.
        - HARNESS_FLAKE quarantines runner pool; TEST_NONSEMANTIC quarantines test spec.
    - id: FAC-G-0014
      statement: Risk-tiered AAT selection - Diff-aware AAT gating preserves throughput while protecting high-risk changes.
      measurable_outcomes:
        - Risk tier (HIGH/MED/LOW) and selection_policy_id are recorded in GateReceipt payload.
        - HIGH tier always requires AAT; MED/LOW are sampled by policy with nightly full AAT on main.
        - Admission verifies selection_policy_id and risk_tier against policy_hash.
    - id: FAC-G-0015
      statement: Invariant-first AAT specs - Acceptance tests assert invariants, not brittle step scripts.
      measurable_outcomes:
        - AAT specs require invariant declarations; steps are observational only.
        - Invariants are expressed in machine-checkable form (exit codes, structured reports, invariant checks).
    - id: FAC-G-0016
      statement: Anti-downgrade enforcement - AAT policy resolution cannot be silently weakened.
      measurable_outcomes:
        - Resolved risk_tier, determinism_class, verifier_policy_hashes, and rcp_profile_ids are pinned at FAC start.
        - PolicyResolvedForChangeSet event is committed before any GateLeaseIssued for the changeset.
        - Admission rejects AAT receipts with policy_hash mismatch or lowered tiers.
        - Downgrades require explicit waiver with separate authority and projection visibility.
    - id: FAC-G-0017
      statement: Safe AAT reuse - Reuse is provenance-bound and replay-safe.
      measurable_outcomes:
        - AAT reuse emits AATResultReused with full provenance tuple.
        - AAT reuse rejected on any provenance mismatch.
    - id: FAC-G-0018
      statement: Evidence hygiene - AAT evidence artifacts are classified, redacted, and retention-bounded.
      measurable_outcomes:
        - Evidence artifacts include data_classification, redaction metadata, and retention_window_ref (HTF).
        - Admission rejects evidence policy violations.
    - id: FAC-G-0019
      statement: Quorum/audit enforcement - High-risk AAT results require independent verification.
      measurable_outcomes:
        - HIGH tier requires two independent receipts from disjoint runner pools.
        - MED tier uses audit re-runs before admission finalizes.
    - id: FAC-G-0020
      statement: Harness sandboxing - AAT executes in a strict sandbox with deny-by-default egress.
      measurable_outcomes:
        - No host mounts beyond pinned snapshot.
        - Network egress is policy-declared and recorded in receipts.
  time_semantics_deferral:
    statement: |
      Time authority is deferred to the Holonic Time Fabric (HTF) RFC (number TBD).
      No protocol decision (lease expiry, TTLs, retry windows, quarantine windows, admission
      deadlines, polling cadence) may use wall-clock time as authority.
      Wall-clock timestamps may appear only as observational metadata in receipts/telemetry.
    placeholders:
      - "TIME_TBD (HTF-defined time envelope)"
      - "HTF::LedgerTime"
      - "HTF::CausalTime/HLC"
      - "HTF::MonotonicTicks"
      - "HTF::BoundedWallTime (observational only)"
  scope:
    in_scope:
      - forge
      - admission
      - gates
      - ledger
      - cas
      - ocap
      - context_packs
      - projection
      - ci_attestation
      - containment
      - measurement_integrity
      - goodhart
      - efficiency
    out_of_scope:
      - id: NG-0001
        statement: Building a universal CI integration framework.
      - id: NG-0002
        statement: Replacing existing kernel Protobuf schemas for gate events.
      - id: NG-0003
        statement: Automated divergence resolution without human adjudication.
      - id: NG-0004
        statement: Full Goodhart resistance in Phase 1.
      - id: NG-0005
        statement: Cross-provider prompt equivalence guarantees.
  milestones:
    - id: PHASE-1
      name: "Phase 1: FAC Core Hardening"
      description: Core admission hardening with signed gates, OCAP firewall, and projection-only GitHub.
      deliverables:
        - New gate events (GateLeaseIssued, GateRunStarted, GateRunCompleted) with mandatory signature verification on ingestion.
        - OCAP context firewall enforced mechanically for CONSUME holons.
        - GitHub adapter projection-only; status setters outside adapter removed from skills and denied by policy.
        - Projection divergence watchdog + freeze/unfreeze path.
        - Typed GateReceipt payloads for AAT bound to view commitments.
        - AAT evidence bindings (transcript chains, artifact manifest hash, attestation fields) validated at admission.
        - Terminal verifier binding schema enforced for AAT PASS.
        - Risk-tiered AAT selection policy with diff-aware gating.
        - Anti-downgrade enforcement for risk tier, verifier policy, and RCP profiles.
        - Evidence hygiene enforcement for AAT receipts (classification/redaction/retention).
        - AAT reuse safety with provenance tuple validation.
        - AAT harness sandboxing with deny-by-default egress.
      definition_of_done:
        - An autonomous agent cannot flip a gate outcome or merge by manipulating GitHub or xtask; it must produce signed internal events and receipts.
        - A GateRun cannot proceed with missing context; it terminates and triggers pack refinement.
    - id: PHASE-2
      name: "Phase 2: Measurement Integrity + Goodhart Resistance"
      description: Holdout suites and evaluator audits to detect drift and false negatives.
      deliverables:
        - Holdout suite runner (known-bad changes) to measure false negatives.
        - Auditor sampling of gate outcomes vs evidence; drift alerts and policy quarantine.
        - Echo-trap metrics feeding instruction and pack compiler updates.
        - Determinism envelope enforcement for gates with determinism_class > 0 (AAT first).
        - Flake classification policy routing with runner-pool quarantine and test-spec quarantine.
        - Quorum/audit enforcement for HIGH and MED risk tiers.
      definition_of_done:
        - Holdout suite runs on schedule and produces false_negative_rate, finding_precision, gate_evidence_coverage metrics.
        - Auditor samples 1% of GateRuns (or min 1 per HTF window) and detects rationale/evidence drift.
        - Affected gate policies are quarantined when drift thresholds exceeded.
        - Determinism envelope rejects nondeterministic gate outcomes and triggers quarantine/abort policy.
    - id: PHASE-3
      name: "Phase 3: Autonomous Improvement Substrate"
      description: Defect-driven auto-tuning and improved provider routing.
      deliverables:
        - Defect-driven auto-tuning of pack specs and instructions under CAC governance.
        - Provider routing improvements with safe fallback and classification-aware routing.
      definition_of_done:
        - Pack compiler updates based on accumulated defect patterns without human intervention.
        - Provider routing handles RATE_LIMIT, TIMEOUT, TRANSIENT_5XX with circuit breaker and fallback.
        - Routing decisions recorded with rationale in ToolDecided/ToolExecuted receipts.
  success_criteria_summary:
    - All gate outcomes are cryptographically signed with Ed25519 and verifiable from ledger.
    - Gate executors operate under lease-scoped authority with HTF-enforced expiry and scope enforcement.
    - OCAP context firewall prevents all unauthorized reads during gate execution.
    - GitHub is projection-only; external manipulation does not affect admission.
    - Divergence detection freezes admissions automatically until adjudication.
    - CI evidence import is required for readiness transitions when CI gating enabled.
    - Every successful admission has a verifiable MergeReceipt.
    - Bounded retries and echo-trap detection prevent runaway loops.
    - AAT gate receipts are typed and bound to view commitments.
    - Determinism envelope prevents nondeterministic gate outcomes from passing.
    - AAT receipts bind transcript chains, artifact manifest hash, and attestation fields.
    - Terminal verifier binding prevents narrative-only PASS.
    - Risk-tiered AAT selection preserves merge cadence while protecting high-risk changes.
    - AAT specs are invariant-first and machine-verifiable.
    - Anti-downgrade enforcement prevents silent policy weakening.
    - AAT reuse is provenance-bound and replay-safe.
    - Evidence hygiene enforces classification, redaction, and retention windows (HTF).
    - HIGH-risk AAT requires independent quorum receipts.
    - AAT harnesses run in a strict sandbox with deny-by-default egress.

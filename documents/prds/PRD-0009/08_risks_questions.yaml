prd_risks_questions:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  risks:
    - id: RSK-FAC-0001
      statement: Context firewall adoption friction causes agent failures during transition.
      impact: |
        Agents accustomed to broad file access fail frequently under OCAP containment;
        perceived as regression blocking productivity.
      likelihood: HIGH
      mitigations:
        - Graduated rollout with warn-only phase before hard enforcement.
        - Treat context misses as compiler defects; prioritize pack completeness fixes.
        - Provide clear error messages with guidance on ContextRefinementRequest path.
        - Monitor CONTEXT_MISS and CONTEXT_FIREWALL_DENY defect rates for rapid response.
      evidence_ids: []
      tradeoff_cluster: STRICTNESS_VS_ADOPTION
    - id: RSK-FAC-0002
      statement: Projection divergence false positives cause unnecessary factory freezes.
      impact: |
        Legitimate external changes (e.g., admin hotfixes) trigger PROJECTION_DIVERGENCE
        and InterventionFreeze, blocking all admissions until manual recovery.
      likelihood: MEDIUM
      mitigations:
        - Document expected divergence scenarios and pre-authorize via emergency override.
        - Implement grace period and re-check before triggering freeze.
        - Provide expedited AdjudicationRequested(EMERGENCY_RECOVERY) path.
        - Emit DefectRecord with evidence diff for rapid root-cause analysis.
      evidence_ids: []
    - id: RSK-FAC-0003
      statement: Key management complexity leads to operational failures or security gaps.
      impact: |
        Ed25519 key rotation, custody grouping, and COI enforcement add operational
        burden; misconfiguration could allow unauthorized signing or block legitimate actors.
      likelihood: MEDIUM
      mitigations:
        - Define clear KeyPolicy artifact under CAC governance.
        - Automate key rotation with KeyRotated event chain-of-custody.
        - Implement COI group validation in lease issuance path.
        - Provide tooling to audit key bindings and custody domains.
      evidence_ids: []
    - id: RSK-FAC-0004
      statement: CI attestation gaps leave evidence import incomplete for hosted runners.
      impact: |
        Hosted CI environments cannot provide stable runner image digests; L1+ attestation
        requires self-hosted runners, increasing operational complexity.
      likelihood: HIGH
      mitigations:
        - Default CI_EVENTS_ENABLED=false (fail-closed) until evidence binding confirmed.
        - Document L1 attestation requirements and self-hosted runner setup.
        - For T3 (high-risk) changes, re-run critical verifiers in controlled environments.
        - Reject L0 attestation; require L1+ or rerun in controlled environments for readiness gating.
      evidence_ids: []
    - id: RSK-FAC-0005
      statement: COI enforcement blocks legitimate single-developer workflows.
      impact: |
        Small teams or solo developers cannot satisfy COI requirement that changeset
        author cannot review; blocks admission without waiver ceremony.
      likelihood: MEDIUM
      mitigations:
        - Implement waiver path via AdjudicationRequested(WAIVER) with bounded scope.
        - Define policy for low-risk artifacts that may have relaxed COI.
        - Document waiver ceremony and audit requirements.
        - Consider automated waiver for non-security-critical changes with explicit policy.
      evidence_ids: []
      tradeoff_cluster: STRICTNESS_VS_ADOPTION
    - id: RSK-FAC-0006
      statement: Determinism envelope increases gate latency and compute cost.
      impact: |
        N-run stability checks (default 3) may slow admissions and increase resource usage,
        reducing throughput if applied too broadly.
      likelihood: MEDIUM
      mitigations:
        - Gate determinism enforcement is Phase 2; Phase 1 ships schema only.
        - Apply determinism envelope selectively by risk tier (T3 first).
        - Cache evidence across identical changeset/view_commitment pairs.
        - Use deterministic environments to reduce re-run variance.
      evidence_ids: []
    - id: RSK-FAC-0007
      statement: Quarantine/abort policy may over-reject due to infra flakiness.
      impact: |
        Environmental instability could trigger GATE_NONDETERMINISTIC and quarantine
        otherwise valid changesets, reducing trust in the pipeline.
      likelihood: MEDIUM
      mitigations:
        - Separate infra instability detection from code nondeterminism.
        - Use Determinism Proxy with pinned environments for AAT.
        - Allow adjudication only for infra-root-cause classification; keep fail-closed for code.
        - Track nondeterminism rates to tune policy thresholds.
      evidence_ids: []
    - id: RSK-FAC-0008
      statement: AAT evidence-chain capture increases latency and storage costs.
      impact: |
        Transcript hash chains and artifact manifest hashing add compute overhead; if unchecked,
        AAT could slow merge cadence or inflate evidence retention costs.
      likelihood: MEDIUM
      mitigations:
        - Use chunked hashing and streaming digests to avoid large memory footprints.
        - Compress and deduplicate artifacts in CAS; retain raw evidence per policy.
        - Apply risk-tiered AAT selection to reduce overall run volume.
      evidence_ids: []
    - id: RSK-FAC-0009
      statement: Terminal verifier policy drift can cause false PASS or brittle blocking.
      impact: |
        If verifier predicates become lax, AAT becomes spoofable; if too strict, AAT
        blocks safe refactors and slows velocity.
      likelihood: MEDIUM
      mitigations:
        - Version verifier policies with policy_hash and audit changes.
        - Use holdout suites to detect false negatives.
        - Require invariants-first specs to avoid step-based brittleness.
      evidence_ids: []
    - id: RSK-FAC-0010
      statement: AAT reuse without strict provenance increases replay and cache poisoning risk.
      impact: |
        Reusing stale or mismatched receipts could allow regressions to pass or conceal
        failures, undermining admission integrity.
      likelihood: MEDIUM
      mitigations:
        - Enforce exact provenance tuple and AATResultReused event.
        - Emit AAT_CACHE_KEY_MISMATCH on any mismatch.
        - Log and invalidate caches on mismatch.
      evidence_ids: []
    - id: RSK-FAC-0011
      statement: Evidence retention and transcripts increase long-term secret exposure risk.
      impact: |
        Secrets captured in logs or transcripts become permanent if retention is unmanaged,
        creating compliance and security liabilities.
      likelihood: MEDIUM
      mitigations:
        - Enforce classification, redaction profile, and retention window (HTF) on all evidence.
        - Reject admission when evidence hygiene requirements are not met.
        - Apply deduplication and compression to reduce unnecessary exposure.
      evidence_ids: []
    - id: RSK-FAC-0012
      statement: Quorum/audit enforcement for HIGH risk may reduce throughput.
      impact: |
        Requiring independent receipts and audit re-runs increases latency and compute,
        potentially slowing high-risk merges.
      likelihood: MEDIUM
      mitigations:
        - Limit quorum to HIGH tier and audit sampling to MED tier.
        - Use disjoint runner pools with pinned environments to reduce flake-induced reruns.
        - Measure quorum coverage vs latency to tune policy.
      evidence_ids: []
    - id: RSK-FAC-0013
      statement: AAT harness execution surface enables exfiltration or evidence forgery.
      impact: |
        Malicious harness changes could leak data or forge evidence unless sandboxed.
      likelihood: MEDIUM
      mitigations:
        - Enforce strict sandboxing with deny-by-default egress and env allowlist.
        - Bind transcripts and artifacts into receipt with hash-chain completeness.
        - Require verifier policy linting to prevent tautological tests.
      evidence_ids: []
    - id: RSK-FAC-0014
      statement: Time authority is undefined until HTF RFC is specified.
      impact: |
        If any component uses wall-clock time for lease expiry, quarantine windows, or
        admission deadlines, protocol decisions can drift or be spoofed.
      likelihood: MEDIUM
      mitigations:
        - Explicitly defer time semantics to HTF and prohibit wall-clock authority.
        - Require HTF time_envelope_ref on time-bound events (leases, quarantines, waivers).
        - Treat wall-clock timestamps as observational metadata only.
      evidence_ids: []
  open_questions:
    - id: Q-FAC-0001
      question: |
        Canonical proto placement for new gate/projection/intervention events:
        extend kernel_events.proto with GateEvent and ProjectionEvent payloads
        vs encode as EvidenceEvent + metadata?
      decision_needed_by: Phase 1 (FAC Core Hardening)
      resolution_plan: |
        Prefer typed GateEvent/ProjectionEvent payloads for security-critical events.
        Evaluate coordination costs and define proto migration path.
    - id: Q-FAC-0002
      question: |
        Deterministic impact expansion for Rust (call graph, trait impl fanout)
        within pinned toolchains: baseline grep/symbol scan vs rust-analyzer indexing?
      decision_needed_by: Phase 1 (FAC Core Hardening)
      resolution_plan: |
        Start with deterministic grep/symbol baseline. Evaluate rust-analyzer snapshot
        indexing for improved accuracy if baseline proves insufficient.
    - id: Q-FAC-0003
      question: |
        Formal COI grouping policy (key custody domains) and interaction with
        delegation: how to define KeyPolicy artifact under CAC?
      decision_needed_by: Phase 1 (FAC Core Hardening)
      resolution_plan: |
        Define KeyPolicy schema with custody domain grouping. Implement COI validation
        in lease issuance. Document delegation rules and group membership.
    - id: Q-FAC-0004
      question: |
        How to obtain stable runner image digests from hosted CI for L1+ attestation?
        May require self-hosted runners.
      decision_needed_by: Phase 1 (FAC Core Hardening)
      resolution_plan: |
        Survey hosted CI providers for environment attestation capabilities.
        Document self-hosted runner requirements for L1+. Define fallback policy
        for hosted runners with explicit attestation level documentation.
    - id: Q-FAC-0005
      question: |
        Exact GitHub org policies and enforcement mechanics for branch protection
        contract: how to ensure external merge paths cannot bypass FAC admission?
      decision_needed_by: Phase 1 (FAC Core Hardening)
      resolution_plan: |
        Document required GitHub branch protection settings. Codify in adapter
        handshake and validate on startup. Define audit for administrator bypass usage.
    - id: Q-FAC-0006
      question: |
        Default determinism envelope policy: what is N for stability checks by risk tier,
        and when should deterministic enforcement expand beyond AAT?
      decision_needed_by: Phase 2 (Measurement Integrity + Goodhart Resistance)
      resolution_plan: |
        Start with N=3 for AAT in T3; evaluate throughput impact and expand to other
        gates only after stability and cost metrics meet targets.
    - id: Q-FAC-0007
      question: |
        Transcript hash chain schema: what canonical ordering and chunking rules ensure
        deterministic verification across environments?
      decision_needed_by: Phase 1 (FAC Core Hardening)
      resolution_plan: |
        Define canonical transcript event ordering and chunk size. Publish schema and
        reference implementation for verification.
    - id: Q-FAC-0008
      question: |
        Risk tier classification model: which signals (diff scope, module criticality,
        policy profile) determine HIGH/MED/LOW for AAT selection?
      decision_needed_by: Phase 1 (FAC Core Hardening)
      resolution_plan: |
        Start with policy-defined critical domains (auth/crypto/ledger/tool mediation) and
        expand with impact expansion heuristics; revise based on escape-rate metrics.
    - id: Q-FAC-0009
      question: |
        Where should policy resolution be recorded (PolicyResolved event vs embedded in FAC-00 run receipt),
        and what is the canonical hash for anti-downgrade enforcement?
      decision_needed_by: Phase 1 (FAC Core Hardening)
      resolution_plan: |
        Define PolicyResolved payload with resolved_policy_hash and policy tuple; bind to ledger at FAC-00.
    - id: Q-FAC-0010
      question: |
        Should AAT reuse be allowed for LOW risk only, or for MED with explicit waiver?
      decision_needed_by: Phase 1 (FAC Core Hardening)
      resolution_plan: |
        Start with LOW-only reuse; expand based on cache integrity metrics and escape rate.
  tradeoff_analyses:
    - id: TRADEOFF-FAC-0001
      name: Strictness vs. Adoption
      cluster_id: STRICTNESS_VS_ADOPTION
      linked_risks:
        - RSK-FAC-0001
        - RSK-FAC-0005
      description: |
        Context firewall enforcement (RSK-FAC-0001) and COI requirements (RSK-FAC-0005)
        represent the fundamental tradeoff between security strictness and adoption
        velocity. Stricter enforcement improves security guarantees but creates
        friction for developers transitioning to FAC or working in small teams.
      criteria_ranking:
        - criterion: Security (OCAP containment, COI enforcement)
          weight: 0.45
          rationale: Core mission of FAC; non-negotiable for production trust
        - criterion: Velocity (time-to-merge, developer experience)
          weight: 0.30
          rationale: Critical for adoption; excessive blocking kills trust
        - criterion: Observability (defect detection, refinement feedback)
          weight: 0.15
          rationale: Enables learning; strict enforcement without visibility is blind
        - criterion: Reversibility (waiver paths, emergency overrides)
          weight: 0.10
          rationale: Reduces risk of strict enforcement; provides escape valves
      quantified_thresholds:
        acceptable_context_miss_rate: "<=15% of GateRuns trigger CONTEXT_MISS in initial HTF window (TIME_TBD)"
        acceptable_coi_waiver_rate: "<=5% of admissions require COI waiver"
        required_security_posture: "Zero gate outcomes without valid lease and signature"
        feedback_latency_sla: "Pack spec updates within HTF window (TIME_TBD) of recurring CONTEXT_MISS pattern"
      pareto_configurations:
        - id: CONFIG-FAC-STRICT
          description: Full OCAP + COI enforcement from initial HTF window
          security: 1.0
          velocity: 0.4
          observability: 0.8
          reversibility: 0.2
          recommendation: Not recommended; adoption risk too high
        - id: CONFIG-FAC-GRADUATED
          description: Warn -> soft-fail -> hard-fail over HTF windows (TIME_TBD); waiver path for COI
          security: 0.9
          velocity: 0.7
          observability: 0.9
          reversibility: 0.7
          recommendation: RECOMMENDED; balances security and adoption
        - id: CONFIG-FAC-PERMISSIVE
          description: Defect-emit only; never fail on context miss or COI
          security: 0.5
          velocity: 1.0
          observability: 1.0
          reversibility: 1.0
          recommendation: Not recommended; security posture insufficient for FAC goals
      coordinated_mitigation:
        rollout_phases:
          - phase: "FAC-R-01 (HTF window A)"
            mode: WARN
            description: "Warn-only for LOW risk changes on sterile runner pool (no secrets, egress denied); all violations logged but not blocking."
          - phase: "FAC-R-02 (HTF window B)"
            mode: SOFT_FAIL
            description: "Context miss terminates session but allows retry; COI waiver auto-granted with audit."
          - phase: "FAC-R-03 (HTF window C)"
            mode: HARD_FAIL
            description: "Full enforcement; context miss triggers refinement; COI waiver requires ceremony."
          - phase: "FAC-R-04 (ongoing)"
            mode: PRODUCTION
            description: "Continuous improvement; pack specs refined based on defect patterns."
        acceleration_clause: |
          If CONTEXT_MISS rate <5% by HTF window threshold (TIME_TBD), advance to FAC-R-03.
          If COI waiver rate <2% by HTF window threshold (TIME_TBD), remove auto-grant.
          Data-driven acceleration rewards faster-than-expected pack completeness.
        rollout_sla:
          during_rollout: "HTF window (TIME_TBD) for pack fixes; emergency window (TIME_TBD)"
          post_rollout: "HTF window (TIME_TBD) standard; emergency window (TIME_TBD)"
        feedback_integration:
          - "CONTEXT_MISS defects automatically trigger pack spec review"
          - "COI waiver frequency feeds into policy refinement"
          - "Weekly strictness-vs-adoption dashboard review"
        escape_hatches:
          - "ContextRefinementRequest for pack incompleteness"
          - "AdjudicationRequested(WAIVER) for COI with bounded scope and HTF time_envelope_ref"
          - "Emergency override ceremony per PRD-0007 for critical blockers"

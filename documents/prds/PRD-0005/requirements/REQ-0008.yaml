prd_requirement:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  id: REQ-0008
  type: NON_FUNCTIONAL
  title: Determinism envelope and material-diff acceptance
  statement: |
    The compiler MUST enforce a determinism envelope for all stage outputs. Outputs MUST be written with stable ordering and atomic replacement, and re-running compilation with identical inputs MUST produce byte-identical artifacts or a bounded diff report requiring explicit acceptance before overwriting.
  acceptance_criteria:
    - "All YAML outputs are canonicalized (key ordering, indentation, quoting rules) before write."
    - "Writes use atomic replace (write temp -> fsync -> rename) and never produce partial files."
    - "Re-run emits a diff report classifying changes as 'structural' or 'free-text within allowed fields'."
    - "Material diffs require explicit acceptance (flag or manifest entry) before applying changes."
  evidence:
    evidence_ids:
      - EVID-0006
      - EVID-0001

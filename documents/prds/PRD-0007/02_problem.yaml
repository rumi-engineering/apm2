prd_problem:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  context:
    background: |
      APM2 already has a signed, hash-chained ledger and a content-addressed store (CAS).
      Today, the system still relies on implicit or prose-driven contracts (README/Markdown/scripts)
      and unverified assumptions about CLI functionality. This creates unplanned context discovery,
      brittle agent behavior, and a slow innermost loop (code+review).
    current_state: |
      The system lacks a single, canonical, machine-validated source of truth for the context
      that governs planning, execution, review, and operation. Context is scattered across
      Markdown files, scripts, and implicit CLI assumptions. Agents spend time searching or
      asking for context that should have been pre-packaged. Reviewers catch bugs rooted in
      missing or inconsistent context rather than coding mistakes. CLI/xtask mismatch causes
      brittle workflows and manual intervention.
    why_now: |
      The existing APM2 kernel primitives (ledger, CAS, holonic execution) provide the foundation
      to build a canonical context pipeline. By making context machine-native, canonical, and
      enforceable, we can dramatically improve the innermost loop throughput and enable safe
      cutover to the APM2 CLI as the holonic control surface.
  problem_statement:
    primary: |
      Make context the authoritative program: a content-addressed context graph compiled through
      target profiles into deterministic packs and delivery payloads, with full provenance
      recorded as kernel messages.
    supporting_details:
      - "No normative representation for context exists (schema-validated, canonical, versioned)."
      - "No patch-first authoring pipeline exists with replay protection and evidence receipts."
      - "No stable-ID deterministic read plane exists for consumption holons."
      - "No capability truthing/selftest receipts gate agent plans."
      - "No principled compiler boundary exists between internal context IR and vendor-required ABIs."
  observed_failure_modes:
    - id: FM-0001
      name: Contract drift encoded in prose
      mechanism: Normative requirements appear in Markdown/scripts without schema validation or canonicalization.
      impact:
        - Agents mis-plan due to inconsistent or outdated context.
        - Reviewers miss implicit assumptions not encoded in validated artifacts.
        - System behavior diverges from declared behavior.
      alternative_interventions:
        - id: ALT-FM001-01
          intervention: "Stricter Markdown linting with machine-readable frontmatter"
          assessment: "Addresses symptom (linting) but not cause (no canonical representation); drift can still occur between lint rules and runtime behavior."
        - id: ALT-FM001-02
          intervention: "Human-authored YAML contracts with manual validation"
          assessment: "Improves structure but introduces human error; no cryptographic provenance; manual validation is slow and incomplete."
        - id: ALT-FM001-03
          intervention: "Test-driven contracts (contracts verified by test suites)"
          assessment: "Good for runtime behavior but does not address planning-time context; tests verify behavior, not intent."
      cac_superiority: |
        CAC is superior because it provides: (1) single canonical representation enforced at admission,
        (2) cryptographic content addressing for provenance, (3) machine authoring with replay protection,
        (4) schema validation before any artifact influences execution. Alternative interventions address
        symptoms; CAC addresses the root cause by making context machine-native.
    - id: FM-0002
      name: Capability ambiguity in the CLI
      mechanism: CLI claims features via docs or flags but behavior is untested or partial.
      impact:
        - Agents freeze mid-flight due to unsupported operations.
        - Manual debugging required to identify capability gaps.
        - Slow iteration and loss of trust in automation.
      alternative_interventions:
        - id: ALT-FM002-01
          intervention: "Comprehensive CLI documentation with examples"
          assessment: "Documentation can drift from implementation; agents cannot verify claims at planning time."
        - id: ALT-FM002-02
          intervention: "Integration tests for all CLI commands"
          assessment: "Tests verify behavior exists but do not expose capabilities to agents; agents still guess."
        - id: ALT-FM002-03
          intervention: "CLI --help output parsing by agents"
          assessment: "Fragile parsing; help text is human-oriented, not machine-readable; no verification of claimed capabilities."
      cac_superiority: |
        CAC provides CapabilityManifest: a machine-readable declaration of what the CLI actually supports,
        verified by selftests (AAT). Agents can query capabilities at planning time and avoid unsupported
        operations. The manifest is evidence-backed, not documentation-backed.
    - id: FM-0003
      name: Unplanned tool calls during consumption
      mechanism: Consumption holons perform discretionary reads/browsing because required context was not compiled into a pack.
      impact:
        - Non-determinism in execution.
        - Leaky policies and hidden dependencies.
        - Repeat incidents due to context discovery failures.
      alternative_interventions:
        - id: ALT-FM003-01
          intervention: "Tool call auditing and alerting"
          assessment: "Detective only; does not prevent non-determinism; alerts after the fact."
        - id: ALT-FM003-02
          intervention: "Sandbox restrictions on consumption holons"
          assessment: "Prevents some reads but does not provide context; tasks fail without useful feedback."
        - id: ALT-FM003-03
          intervention: "Pre-flight context checklist for agents"
          assessment: "Manual process; incomplete and error-prone; does not scale."
      cac_superiority: |
        CAC provides ContextPacks with deep-pinned dependencies. Consumption holons receive everything
        they need; discretionary reads are policy-denied. Pack misses create defects that feed back
        into pack improvement. This is preventative, not detective.
    - id: FM-0004
      name: Non-replayable research behavior
      mechanism: Context production uses tools without explicit leases/budgets and without publishing evidence snapshots.
      impact:
        - Irreproducible outputs.
        - Cannot audit production decisions.
        - Cannot improve pack compiler based on production patterns.
      alternative_interventions:
        - id: ALT-FM004-01
          intervention: "Verbose logging of all tool calls"
          assessment: "Logs are unstructured; difficult to replay; no cryptographic provenance."
        - id: ALT-FM004-02
          intervention: "Notebook-style execution with cell outputs"
          assessment: "Better structure but no canonical format; outputs are not content-addressed."
        - id: ALT-FM004-03
          intervention: "Manual evidence collection post-hoc"
          assessment: "Incomplete coverage; human error; no proof of completeness."
      cac_superiority: |
        CAC requires production holons to operate under explicit leases/budgets with structured
        evidence snapshots stored in CAS. Every decision is auditable via ledger events. Planned
        vs unplanned tool calls are classified and feed into pack compiler improvement.
    - id: FM-0005
      name: Vendor ABI requirements dominate internal design
      mechanism: External systems require Markdown + directory layouts; without a compiler, teams treat these outputs as source of truth.
      impact:
        - Drift between internal and external representations.
        - Unclear provenance for generated artifacts.
        - Unsafe edits to generated artifacts.
      alternative_interventions:
        - id: ALT-FM005-01
          intervention: "Template-based generation with manual sync"
          assessment: "Manual sync is error-prone; templates can drift from actual requirements."
        - id: ALT-FM005-02
          intervention: "CI checks for internal/external consistency"
          assessment: "Detective only; catches drift after the fact; does not prevent it."
        - id: ALT-FM005-03
          intervention: "Git hooks to prevent direct edits to generated files"
          assessment: "Partial protection; does not address source-of-truth confusion."
      cac_superiority: |
        CAC provides Target Profiles for deterministic compilation to vendor layouts. Generated
        artifacts include provenance frontmatter. Export manifests verify determinism. The internal
        CAC-JSON is always source of truth; vendor layouts are always derived outputs.
  yagni_analysis:
    description: |
      Analysis of which CAC features could be deferred if simpler interventions partially succeed.
      This provides a fallback path if full CAC adoption proves too costly.
    deferrable_features:
      - id: DEFER-01
        feature: "Target Profile compilation"
        condition: "If vendor layouts remain stable and manual sync is acceptable"
        risk: "Drift will accumulate; recommended only for short-term deferral"
      - id: DEFER-02
        feature: "Full hermetic consumption (hard-fail mode)"
        condition: "If defect-emit mode achieves acceptable quality"
        risk: "Non-determinism remains; not recommended for safety-critical paths"
      - id: DEFER-03
        feature: "Typed kernel events (ControlArtifactEvent)"
        condition: "If EvidencePublished metadata proves sufficient for queries"
        risk: "Low; already marked as out-of-scope post-MVP"
    non_deferrable_features:
      - id: NODEFER-01
        feature: "CAC-JSON canonicalization and validation"
        rationale: "Foundation for all other features; cannot be partially adopted"
      - id: NODEFER-02
        feature: "Patch-first authoring with replay protection"
        rationale: "Core to provenance and audit; security property"
      - id: NODEFER-03
        feature: "Content-addressed storage and stable IDs"
        rationale: "Required for deterministic reads and pack compilation"
  non_goals:
    - id: NG-0001
      statement: Humans authoring normative context artifacts.
      clarification: |
        Context artifacts are machine-authored via patch streams. Human review focuses
        on semantic correctness and policy compliance, not artifact syntax.
    - id: NG-0002
      statement: Using token-optimized formats (e.g., TOON) as normative storage.
      clarification: |
        TOON and other derived formats are prompt-pack encodings for LLM consumption.
        CAC-JSON is the sole normative representation; derived formats are never authoritative.
    - id: NG-0003
      statement: Replacing all existing kernel Protobuf schemas in this phase.
      clarification: |
        CAC operates alongside existing kernel event schemas. Proto changes are
        optional post-MVP enhancements.
    - id: NG-0004
      statement: Building a universal cross-vendor standard.
      clarification: |
        We compile to target profiles and delivery payloads specific to each vendor.
        Interoperability is achieved through deterministic compilation, not universal formats.

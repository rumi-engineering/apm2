rfc_problem_and_imports:
  schema_version: "2026-01-24"
  template_version: "2026-01-24"

  problem_statement:
    summary: "PRs currently lack systematic verification of claimed functionality"
    context: |
      The APM2 project needs a quality gate that verifies PR claims through
      hypothesis-driven testing before merge. Without AAT, agents may submit
      PRs with untested claims, hardcoded test-passing logic, or undocumented
      limitations.
    goals:
      - "Establish AAT as mandatory merge gate for every PR"
      - "Implement hypothesis-driven verification protocol"
      - "Detect and prevent anti-gaming patterns (hardcoded logic, mock data)"
      - "Generate evidence bundles proving PR claims"
      - "Provide waiver system for legitimate exceptions"
    non_goals:
      - "Replace unit tests or integration tests"
      - "Automate code review decisions"
      - "Provide 100% coverage guarantee"

  implementation_note: |
    This RFC implements PRD-0003 requirements through an xtask-based command
    (`cargo xtask aat <PR_URL>`) that extends existing xtask infrastructure.
    Rather than creating a separate apm2-aat crate, the implementation:

    1. Leverages existing xtask patterns (security-review, quality-review)
    2. Uses regex for anti-gaming static analysis
    3. Uses gh CLI (via xshell) for GitHub API interactions
    4. Reuses existing xtask dependencies (regex, serde, serde_yaml, xshell)
    5. Produces evidence bundles as JSON/YAML artifacts

  imports:
    prd_requirements:
      - id: REQ-0001
        ref: "documents/prds/PRD-0003/requirements/REQ-0001.yaml"
        summary: "PR Description Format for AAT Consumption"
        requirement_text: |
          PRs must include structured sections: Usage (CLI examples),
          Expected Outcomes (When/Then predicates), Evidence Script (path + status),
          and Known Limitations (TODOs with waiver IDs)

      - id: REQ-0002
        ref: "documents/prds/PRD-0003/requirements/REQ-0002.yaml"
        summary: "AAT Agent Invocation as Merge Gate"
        requirement_text: |
          AAT must be invoked automatically as a merge gate via CI/CD.
          Implementation: `cargo xtask aat <PR_URL>` sets GitHub status check.

      - id: REQ-0003
        ref: "documents/prds/PRD-0003/requirements/REQ-0003.yaml"
        summary: "Hypothesis-Driven Testing Protocol"
        requirement_text: |
          Before execution, form at least 3 falsifiable hypotheses.
          Each hypothesis maps claim to verifiable predicate.
          Record hypothesis formation timestamp before execution.

      - id: REQ-0004
        ref: "documents/prds/PRD-0003/requirements/REQ-0004.yaml"
        summary: "Anti-Gaming - No Hardcoded Logic Detection"
        requirement_text: |
          Detect hardcoded values (UUIDs, timestamps, IPs) in PR diff
          using regex patterns. Flag if same output produced regardless
          of input variation (invariance detection).

      - id: REQ-0005
        ref: "documents/prds/PRD-0003/requirements/REQ-0005.yaml"
        summary: "Anti-Gaming - TODO Documentation Requirement"
        requirement_text: |
          Extract TODO, FIXME, HACK comments from diff.
          Flag undocumented TODOs not mentioned in Known Limitations section.
          Cross-reference against waiver system.

      - id: REQ-0006
        ref: "documents/prds/PRD-0003/requirements/REQ-0006.yaml"
        summary: "Evidence Bundle Script Generation"
        requirement_text: |
          Produce JSON evidence bundle (evidence/aat/PR-{number}_{timestamp}.json)
          containing: PR parse results, hypotheses, verification outcomes,
          anti-gaming analysis, and final verdict.

      - id: REQ-0007
        ref: "documents/prds/PRD-0003/requirements/REQ-0007.yaml"
        summary: "Agent-Friendly UX Verification"
        requirement_text: |
          Evidence bundle schema must be machine-parseable (JSON/YAML).
          Output format enables downstream agents to consume results
          for adjudication or escalation workflows.

      - id: REQ-0008
        ref: "documents/prds/PRD-0003/requirements/REQ-0008.yaml"
        summary: "AAT Status Check Manual Toggle"
        requirement_text: |
          GitHub status can be manually toggled via PR comment.
          Adjudication process allows AUTH_AAT to override verdict
          with documented reason.

      - id: REQ-0009
        ref: "documents/prds/PRD-0003/requirements/REQ-0009.yaml"
        summary: "Deterministic Verification"
        requirement_text: |
          Same PR content + environment produces same verdict.
          All randomness must be seeded; all external dependencies versioned.
          Implementation timestamps are ISO 8601; no relative time references.

      - id: REQ-0010
        ref: "documents/prds/PRD-0003/requirements/REQ-0010.yaml"
        summary: "Escalation and Adjudication Protocol"
        requirement_text: |
          If verification outcome is ambiguous, set status to NEEDS_ADJUDICATION.
          Escalation levels: 4h (notify AUTH_AAT), 24h (escalate to AUTH_PRODUCT),
          auto-fail with documented reason.

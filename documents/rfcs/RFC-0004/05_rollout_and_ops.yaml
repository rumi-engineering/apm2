rfc_rollout_and_ops:
  rollout_phases:
    - id: "PHASE-1"
      name: "Shadow Mode"
      description: "AAT runs in observation mode; status checks created but not blocking"
      duration: "1 week (2026-01-24 to 2026-01-31)"
      branch_protection:
        aat_acceptance_required: false
        allow_manual_override: "N/A (not enforced)"
      deployment:
        invocation: "Enabled automatically on all PRs via GitHub Actions workflow"
        evidence_collection: "All bundles written and published"
        status_check_visibility: "Visible in PR checks; never causes merge block"
      success_criteria:
        - "AAT completes on 100% of PRs without crashes (0 timeout > 5 min)"
        - "Evidence bundles generated for 100% of executions"
        - "No spurious GitHub API failures (< 0.1%)"
        - "False positive rate < 10% (measured by manual review)"
        - "Hypothesis formation/execution monotonicity maintained (100%)"
      exit_criteria:
        proceed_to_phase_2_if: "All success criteria met AND team consensus"
        rollback_trigger_if: "Crash rate > 1% OR false positive rate > 30%"
      monitoring_focus:
        - "Identify gaming patterns and refine anti-gaming rules"
        - "Measure actual execution time distribution"
        - "Discover common false positives for Phase 2 tuning"
      team_communication:
        frequency: "Daily status report"
        distribution: "AUTH_PRODUCT, AUTH_ARCHITECTURE, dev team Slack"
        issue_escalation: "File issues immediately for crashes; PR comments for FP review"

    - id: "PHASE-2"
      name: "Soft Enforcement"
      description: "AAT blocks PRs but maintainers can override with WAIVER"
      duration: "2 weeks (2026-01-31 to 2026-02-14)"
      branch_protection:
        aat_acceptance_required: true
        allow_manual_override: true
        override_mechanism: "GitHub WAIVER comments or API token for AUTH_PRODUCT"
      deployment:
        invocation: "Unchanged from Phase 1"
        blocking_behavior: "PR marked as non-mergeable if aat/acceptance != success"
        maintainer_option: "Add WAIVER comment to override (requires AUTH_PRODUCT signature)"
      success_criteria:
        - "All Phase 1 criteria maintained"
        - "Override rate < 20% (waivers < 20% of PRs)"
        - "No valid PRs blocked incorrectly (0 complaints from team)"
        - "All overrides documented with waiver ID and reason"
        - "Anti-gaming violations rare and justified (< 2% of PRs)"
      exit_criteria:
        proceed_to_phase_3_if: "All success criteria met AND no regression in false positives"
        rollback_to_phase_1_if: "Override rate > 40% OR developer complaints"
      waiver_process:
        initiation: "Blocked PR author or maintainer comments '!waiver <reason>'"
        approval: "AUTH_PRODUCT reviews evidence bundle and approves/denies"
        tracking: "All waivers recorded with ticket ID and expiry date"
        appeal: "Can appeal to AUTH_PRODUCT within 72 hours"
      team_communication:
        frequency: "Bi-daily sync on waivers; weekly trend analysis"
        distribution: "AUTH_PRODUCT, AUTH_ARCHITECTURE, dev team"
        waiver_dashboard: "Public link showing all active waivers and reasons"

    - id: "PHASE-3"
      name: "Full Enforcement"
      description: "AAT required for all merges; no manual override except via formal waiver process"
      duration: "Indefinite (2026-02-14 onward)"
      branch_protection:
        aat_acceptance_required: true
        allow_manual_override: false
        formal_waiver_process: "Requires GATE-AAT-WAIVER approval from AUTH_PRODUCT + AUTH_SECURITY"
      deployment:
        invocation: "Unchanged"
        blocking_behavior: "PR is unmergeable; must pass AAT or have formal WAIVER"
        merge_gate: "Protected branch rule enforces aat/acceptance=success"
      success_criteria:
        - "All Phase 2 criteria maintained"
        - "100% of merged PRs have aat/acceptance=success OR valid WAIVER"
        - "Waiver request rate < 5% (mature and stable)"
        - "AAT execution time stable (p95 within 10% of baseline)"
      formal_waiver_conditions:
        eligible_scenarios:
          - "Critical security hotfix (approved by AUTH_SECURITY)"
          - "High-priority customer issue (approved by AUTH_PRODUCT + AUTH_SECURITY)"
          - "AAT tooling bug blocking valid feature (approved by AUTH_ARCHITECTURE)"
        requirements:
          - "Formal WAIVER-ID issued (format: WAIVER-YYYY-XXXXX)"
          - "Documented reason and expiry date"
          - "Both AUTH_PRODUCT and AUTH_SECURITY sign-off"
          - "Public announcement to dev team"
        duration:
          default: "Until next AAT version release"
          critical_security: "Until hotfix merged + next release"
      incident_response:
        definition: "aat/acceptance failures affecting > 10% of PRs for > 1 hour"
        escalation: "Page AUTH_ARCHITECTURE + AUTH_PRODUCT immediately"
        resolution:
          - "If tooling bug: disable aat_acceptance_required via branch protection"
          - "Revert to Phase 2 until bug fixed"
          - "Communicate status and ETA to dev team every 15 min"
      team_communication:
        frequency: "Weekly status; immediate alerts for incidents"
        distribution: "All team members; public status page"
        retrospectives: "Monthly review of waivers, false positives, and improvements"

  operations:
    monitoring:
      metrics:
        - name: "aat_execution_time_seconds"
          labels: ["pr_number", "result", "phase"]
          exporters: ["prometheus", "datadog"]
          dashboard: "Grafana: AAT Performance Trends"

        - name: "aat_verdict_distribution"
          cardinality: "result (PASSED, FAILED, NEEDS_ADJUDICATION)"
          aggregation: "Daily breakdown by result type"
          target: "Pass rate maintained > 90% as system matures"

        - name: "aat_anti_gaming_violations"
          cardinality: "violation_type (if_test_patterns, mock_patterns, hardcoded_values, undocumented_todos)"
          tracking: "Count of violations per PR; investigate trends"

        - name: "aat_hypothesis_count"
          observation: "Should be 3-7 per PR (tracks thoroughness)"
          alert_if: "Average < 3 (underspecified verification)"

        - name: "aat_waiver_rate"
          formula: "waivers_approved / total_prs"
          phase_1_target: "N/A"
          phase_2_target: "< 20%"
          phase_3_target: "< 5%"

        - name: "github_status_api_errors"
          tracking: "Count of failed status check submissions"
          alert_if: "> 1% of AAT runs"

        - name: "evidence_bundle_generation_failures"
          tracking: "Count of PRs where JSON was not written"
          alert_if: "> 0 (critical)"

      dashboards:
        - name: "AAT Health"
          description: "Real-time execution metrics and health status"
          refresh_rate: "5 minutes"
          viewers: "All team members"

        - name: "AAT Waiver Tracking (Phase 2+)"
          description: "Active and expired waivers, reasons, approval times"
          refresh_rate: "1 minute"
          viewers: "AUTH_PRODUCT, AUTH_ARCHITECTURE"

        - name: "AAT False Positive Analysis"
          description: "Evidence bundles marked as FP, clustered by pattern"
          refresh_rate: "1 hour"
          viewers: "AUTH_ARCHITECTURE, interested developers"

    alerting:
      high_severity:
        - condition: "aat_verdict_distribution.failure_rate > 50% (for 30 min)"
          description: "AAT failure rate exceeds 50% - systemic problem"
          severity: "CRITICAL"
          action: "Page on-call architect; consider Phase rollback"
          escalation_path: "AUTH_ARCHITECTURE -> AUTH_PRODUCT"
          slo: "Response within 15 minutes"
          remediation_options:
            - "Investigate recent code changes"
            - "Revert problematic xtask commit"
            - "Disable aat_acceptance_required in branch protection"
            - "Run manual review of affected PRs"

        - condition: "aat_execution_time_seconds.p95 > 600 (10 minutes, for 1 hour)"
          description: "AAT execution timeouts or severe slowdown"
          severity: "HIGH"
          action: "Investigate performance; may impact developer velocity"
          escalation_path: "AUTH_ARCHITECTURE -> SRE team"
          slo: "Root cause identified within 1 hour"
          remediation_options:
            - "Profile hypothesis execution for bottlenecks"
            - "Optimize static analysis or API calls"
            - "Increase timeout threshold temporarily"
            - "Scale GitHub API rate limit if needed"

        - condition: "evidence_bundle_generation_failures > 0 (any PR)"
          description: "Evidence bundle not written - audit trail broken"
          severity: "CRITICAL"
          action: "Immediately investigate; blocks AAT integrity"
          escalation_path: "AUTH_ARCHITECTURE -> on-call"
          slo: "Fixed before next AAT run"

        - condition: "github_status_api_errors > 0.01 * total_aats (for 30 min)"
          description: "Status check submissions failing consistently"
          severity: "HIGH"
          action: "Check GitHub API status; verify auth token"
          escalation_path: "AUTH_ARCHITECTURE"
          slo: "Root cause within 30 minutes"

      medium_severity:
        - condition: "aat_anti_gaming_violations > 2% of PRs (daily)"
          description: "More violations detected than expected"
          severity: "MEDIUM"
          action: "Review violated PRs for patterns; may need waiver tuning"
          slo: "Analysis completed daily; rule adjustment within 48 hours"

        - condition: "aat_waiver_rate > threshold for current phase (Phase 2: 20%, Phase 3: 5%)"
          description: "Waiver rate higher than expected"
          severity: "MEDIUM"
          action: "Analyze reasons; may indicate AAT rules too strict"
          escalation_path: "AUTH_PRODUCT"
          slo: "Root cause analysis within 24 hours"

      low_severity:
        - condition: "aat_hypothesis_count < 3 (per PR)"
          description: "Underspecified verification for a PR"
          severity: "LOW"
          action: "Comment on PR suggesting more thorough testing"
          escalation_path: "Developer feedback"

    dashboards:
      alert_view:
        display: "On-call dashboard showing active and historical alerts"
        refresh_rate: "1 minute"
        retention: "90 days of alert history"

    escalation_paths:
      level_1: "AUTH_ARCHITECTURE (on-call engineer)"
      level_2: "AUTH_PRODUCT (product owner)"
      level_3: "Steering committee (for Phase rollback decisions)"

  operability:
    runbooks:
      - id: "RB-001"
        name: "Resolve AAT False Positive on PR"
        symptoms: "PR blocked by aat/acceptance=failure, but change is valid"
        root_causes:
          - "Anti-gaming rule too strict"
          - "Hypothesis verification error in evidence bundle"
          - "AAT parsing error in PR description"
        investigation_steps:
          - step_1: "Review evidence bundle JSON at target_url of aat/acceptance status"
          - step_2: "Check anti_gaming section for violation type"
          - step_3: "Examine hypotheses for FAILED results and actual_outcome"
          - step_4: "Compare against PR description Usage and Expected Outcomes"
        resolution_paths:
          path_a:
            trigger: "Anti-gaming violation is legitimate design choice"
            action:
              - "Create WAIVER-XXXX documenting the choice"
              - "Re-run 'cargo xtask aat <PR_URL>' with --skip-gaming flag (requires AUTH_PRODUCT)"
              - "Update evidence bundle with waiver reference"
          path_b:
            trigger: "Hypothesis verification error (bad test, not bad PR)"
            action:
              - "File issue against xtask/src/tasks/aat.rs"
              - "Request PR author retry after fix (temporary workaround)"
              - "Include reproduction steps in issue"
          path_c:
            trigger: "PR description parse error (sections missing or malformed)"
            action:
              - "Request PR author edit description to match CONTRACT-001"
              - "Sections: Usage, Expected Outcomes, Evidence Script, Known Limitations"
              - "Link to CONTRACT-001 in comments for guidance"
        escalation: "If unresolved after step 4, escalate to AUTH_ARCHITECTURE"
        time_estimate: "10-30 minutes for experienced reviewer"

      - id: "RB-002"
        name: "Investigate High False Positive Rate (Phase 1)"
        symptoms: "False positive rate > 10% in Phase 1 shadow mode"
        root_cause_analysis:
          - "Run query: SELECT pr_number, violation_type FROM aat_violations WHERE verdict=FAILED AND manually_reviewed=false LIMIT 100"
          - "Manually review sample of 20 PRs to confirm false positives"
          - "Cluster by violation type and PR description patterns"
          - "Identify which anti-gaming rules are too strict"
        decision_points:
          - "< 5% confirmed false positives: proceed to Phase 2"
          - "> 5% but < 10%: proceed to Phase 2 with monitoring"
          - "> 10%: stay in Phase 1; adjust rules and re-test"
        adjustment_procedure:
          - "Edit anti-gaming rules in xtask/src/tasks/aat.rs"
          - "Document change in commit message"
          - "Re-run AAT on sample PRs to verify improvement"
          - "Notify team of rules change"
        time_estimate: "2-4 hours for full analysis and adjustment"

      - id: "RB-003"
        name: "Handle AAT Timeout (PR Blocked by Execution Timeout)"
        symptoms: "AAT exits with code 4 (timeout) after 5+ minutes; aat/acceptance=failure"
        root_causes:
          - "Hypothesis verification commands are slow (external API calls, etc.)"
          - "Evidence Script is computationally expensive"
          - "GitHub API rate limit causing retries"
        investigation_steps:
          - step_1: "Review evidence bundle's hypotheses.executed_at and timestamps"
          - step_2: "Identify which hypothesis(es) took > 60 seconds"
          - step_3: "Check if slow hypothesis involves external API, compilation, or heavy computation"
        resolution_paths:
          path_a:
            trigger: "Single hypothesis is slow (> 60 sec)"
            action:
              - "Optimize Evidence Script to reduce execution time"
              - "Or: Split slow verification into multiple hypotheses"
              - "OR: Use timeout override flag for legitimate slow tests"
          path_b:
            trigger: "GitHub API rate limit issue"
            action:
              - "Check GitHub API quota: 'gh api rate-limit'"
              - "Increase timeout threshold for this phase if quota is low"
              - "Consider caching API responses between AAT runs"
          path_c:
            trigger: "PR is legitimately slow to verify (e.g., heavy compilation)"
            action:
              - "Use --timeout override for this specific PR"
              - "Document override reason in WAIVER comment"
              - "Request PR author simplify verification if possible"
        escalation: "If timeout persists for > 50% of PRs, page AUTH_ARCHITECTURE"
        time_estimate: "15-45 minutes depending on root cause"

      - id: "RB-004"
        name: "Manual Override of AAT Failure (Phase 2: Soft Enforcement)"
        symptoms: "PR failed aat/acceptance but needs to merge urgently"
        prerequisites:
          - "Phase 2 or higher"
          - "Change is legitimate (verified by code review)"
          - "Override reason documented"
        approval_process:
          step_1: "PR author or maintainer posts comment: '!waiver <reason>'"
          step_2: "AUTH_PRODUCT reviews evidence bundle and change"
          step_3: "If approved, AUTH_PRODUCT posts comment with WAIVER-ID"
          step_4: "Branch protection bypassed; PR can merge"
        waiver_tracking:
          logging: "Auto-logged with WAIVER-ID and timestamp"
          review: "Weekly audit of waivers by AUTH_PRODUCT"
          appeal: "Developer can appeal decision within 72 hours"
        time_estimate: "5-15 minutes for AUTH_PRODUCT review"
        examples:
          - "!waiver Critical security hotfix required immediately - APPROVED as WAIVER-2026-00001"
          - "!waiver AAT false positive on harmless refactor - DENIED: use CONTRACT-001 sections instead"

      - id: "RB-005"
        name: "Rollback from Phase to Earlier Phase (Incident Response)"
        symptoms: "aat_verdict_distribution.failure_rate > 50% for 30 minutes; critical incident"
        rollback_criteria:
          - "Failure rate > 50% (majority of PRs blocked)"
          - "> 5 developers reporting blockers in Slack"
          - "No quick fix identified within 30 minutes"
        rollback_steps:
          step_1: "Declare incident: 'AAT Phase Rollback Started' in #engineering Slack"
          step_2: "Disable branch protection for aat_acceptance: 'gh repo edit --allow-empty-repo'"
          step_3: "Identify root cause (new code? GitHub API issue? Rules regression?)"
          step_4: "Fix root cause or revert problematic commit"
          step_5: "Verify fix on sample PRs before re-enabling"
          step_6: "Update branch protection to re-enable aat_acceptance_required"
          step_7: "Post incident report with timeline and prevention steps"
        communication:
          immediate: "Page on-call in #engineering; set status in Slack"
          every_15_min: "Update status and ETA"
          post_incident: "RCA document within 24 hours"
        time_estimate: "15-45 minutes for rollback and stabilization"

      - id: "RB-006"
        name: "Adjudication of NEEDS_ADJUDICATION Status (Escalation)"
        symptoms: "aat/acceptance status is 'pending' with description 'NEEDS_ADJUDICATION'"
        context:
          - "AAT agent could not determine pass/fail; requires human judgment"
          - "Evidence bundle.verdict == 'NEEDS_ADJUDICATION' with reasoning"
          - "Escalation timers active (4h, 24h, auto-fail)"
        adjudication_process:
          step_1: "AUTH_ARCHITECTURE or AUTH_PRODUCT receives notification"
          step_2: "Review evidence bundle ambiguity_reason field"
          step_3: "Examine PR diff and hypotheses to understand issue"
          step_4: "Determine: Is PR valid (safe to merge) or invalid (should fail)?"
          step_5: "Post comment on PR with decision and rationale"
          step_6: "Manual status check update: 'gh api repos/...statuses/{sha} -f state=success/failure'"
        decision_criteria:
          approve_if:
            - "Evidence suggests valid feature, just hard to verify automatically"
            - "Hypotheses could be refined but don't reflect fundamental flaw"
          deny_if:
            - "Evidence shows potential gaming or undocumented TODOs"
            - "Hypotheses reveal insufficient testing"
        escalation_levels:
          level_1: "4 hours: AUTH_ARCHITECTURE reviews and adjudicates"
          level_2: "24 hours: Escalate to AUTH_PRODUCT if unresolved"
          level_3: "Auto-fail with documented reason if still unresolved"
        time_estimate: "20-45 minutes for adjudication"

  maintenance:
    version_updates:
      procedure: |
        1. Update CONTRACT versions in 04_contracts_and_versioning.yaml
        2. Update SKILL.md if schema changes
        3. Update xtask/src/tasks/aat.rs to match new schema
        4. Run full test suite on sample PRs from each contract version
        5. Announce breaking changes 1 week before deployment
        6. Deploy at slow hours (e.g., Friday afternoon -> weekend)
      validation: "Evidence bundles from new version must be valid after update"

    rule_tuning:
      anti_gaming_rules:
        review_frequency: "Weekly during Phase 1-2, Monthly during Phase 3"
        process:
          - "Analyze false positive clusters from dashboards"
          - "Identify patterns that are legitimate but flagged"
          - "Update regex patterns or thresholds in xtask/src/tasks/aat.rs"
          - "Test on historical PRs to verify improvement"
          - "Deploy in Phase 1 first; monitor for regressions"

    documentation:
      update_triggers:
        - "Any change to CONTRACT versions"
        - "Any change to anti-gaming rules"
        - "Any runbook procedure updates"
        - "Monthly: Consolidate lessons from ops incidents"
      owners: "AUTH_ARCHITECTURE + developers who experienced runbook scenarios"

rfc_contracts_and_versioning:
  contracts:
    - id: CONTRACT-001
      name: "PR Description Contract"
      version: "1.0.0"
      description: "Specifies required sections in PR body for AAT verification"
      binding:
        applies_to: "All PRs requesting merge to main"
        enforcement_mechanism: "AAT gates merge via aat/acceptance status check"
      required_sections:
        - section: "## Usage"
          purpose: "CLI invocation examples demonstrating feature functionality"
          requirements:
            - "Must contain at least one code block with CLI command"
            - "Examples must be executable or clearly demonstrate usage patterns"
            - "Must show realistic invocation patterns from user perspective"
          example: |
            ## Usage
            ```bash
            cargo xtask aat https://github.com/owner/repo/pull/123
            ```
            This validates that the PR meets acceptance criteria.

        - section: "## Expected Outcomes"
          purpose: "Verifiable predicates (When X, then Y) that AAT will test"
          requirements:
            - "Must contain at least one testable When/Then predicate"
            - "Predicates must be falsifiable (not aspirational)"
            - "Each outcome must map to a hypothesis in verification"
          example: |
            ## Expected Outcomes
            - When `cargo xtask aat <valid_pr_url>` is invoked, the tool completes without error
            - When `cargo xtask aat <invalid_pr_url>` is invoked, the tool returns exit code 1
            - When AAT detects gaming patterns, status check sets to failure

        - section: "## Evidence Script"
          purpose: "Path and status (NEW/MODIFIED/EXISTING) of verification script"
          requirements:
            - "Must specify valid file path to executable script or test"
            - "Must indicate status: NEW (added in this PR), MODIFIED (changed), or EXISTING (unchanged)"
            - "Script must be executable and deterministic"
            - "Script location must be under evidence/ or xtask/src/"
          example: |
            ## Evidence Script
            Path: `xtask/src/tasks/aat.rs`
            Status: NEW
            The AAT task implementation with all hypothesis verification logic.

        - section: "## Known Limitations"
          purpose: "Documented TODOs, workarounds, and waiver IDs"
          requirements:
            - "All TODOs/FIXMEs in diff must be documented here"
            - "Each limitation must reference a WAIVER-ID if it blocks acceptance"
            - "Format: 'Limitation description (WAIVER-ID if applicable)'"
            - "Undocumented TODOs in diff = anti-gaming violation"
          example: |
            ## Known Limitations
            - Timeout is hardcoded to 5 minutes (TODO: make configurable) - WAIVER-TCK-00049-001
            - Does not support private GitHub instances (WAIVER-TCK-00049-002)

      validation:
        parse_success: "All four sections extractable from PR body"
        parse_failure: "Sets aat/acceptance to failure with actionable error"

    - id: CONTRACT-002
      name: "Evidence Bundle Contract"
      version: "1.0.0"
      description: "Specifies JSON schema and content requirements for AAT evidence output"
      binding:
        applies_to: "Every AAT execution must produce exactly one bundle"
        storage_location: "evidence/aat/PR-{number}_{timestamp}.json"
        publication: "Linked from aat/acceptance status check target_url"
      schema:
        schema_version:
          type: "string"
          value: "1.0.0"
          immutable: true
        pr_number:
          type: "integer"
          purpose: "GitHub PR number for traceability"
        commit_sha:
          type: "string"
          purpose: "Full commit SHA being tested (40 hex chars)"
        timestamp:
          type: "string (ISO 8601)"
          purpose: "When evidence bundle was generated"

        pr_description_parse:
          type: "object"
          purpose: "Records which required sections were found in PR body"
          fields:
            - usage_found: "boolean"
            - expected_outcomes_found: "boolean"
            - evidence_script_found: "boolean"
            - known_limitations_found: "boolean"
          rule: "All must be true; if any false, verdict is failure"

        hypotheses:
          type: "array[object]"
          minimum_count: 3
          purpose: "Pre-formed and executed test hypotheses"
          fields_per_hypothesis:
            - id: "string (H-NNN format)"
            - prediction: "string - what should happen"
            - verification_method: "string - how to test it"
            - tests_error_handling: "boolean - true if tests edge case"
            - formed_at: "string (ISO 8601) - timestamp BEFORE execution"
            - executed_at: "string (ISO 8601) - timestamp AFTER execution"
            - result: "enum(PASSED, FAILED)"
            - actual_outcome: "string - what actually happened"
            - stdout: "string - captured stdout"
            - stderr: "string - captured stderr"
            - exit_code: "integer - process exit code"
          invariant: "formed_at < executed_at for all hypotheses"

        anti_gaming:
          type: "object"
          purpose: "Static analysis and behavioral checks to detect gaming"
          subsections:
            static_analysis:
              if_test_patterns: "array[string] - matched TEST conditionals in diff"
              hardcoded_values: "array[string] - matched UUIDs or timestamps"
              mock_patterns: "array[string] - matched mock_*/stub_*/fake_* patterns"
            input_variation:
              variations_tested: "integer - number of input variations"
              invariance_detected: "boolean - true if output identical for all inputs"
            todo_check:
              todos_found: "array[string] - all TODOs in diff"
              documented_in_known_limitations: "array[string] - TODOs that are documented"
              undocumented_todos: "array[string] - TODOs NOT documented (violation)"
            result: "enum(PASSED, FAILED) - true if no violations detected"

        verdict:
          type: "enum(PASSED, FAILED, NEEDS_ADJUDICATION)"
          rule: "PASSED only if all hypotheses PASSED AND anti_gaming PASSED"
        verdict_reason:
          type: "string"
          purpose: "Human-readable explanation of verdict"

      validation:
        well_formed_json: "Must parse as valid JSON"
        schema_compliance: "All required fields present and typed correctly"
        timestamp_monotonicity: "formed_at < executed_at for all hypotheses"
        hypothesis_count: "Minimum 3 hypotheses required"

    - id: CONTRACT-003
      name: "Status Check Contract"
      version: "1.0.0"
      description: "Specifies GitHub status check API contract for aat/acceptance state"
      binding:
        applies_to: "Every PR with AAT invocation"
        enforcement: "GitHub branch protection rules can require aat/acceptance=success"
      status_states:
        success:
          condition: "All hypotheses PASSED AND anti-gaming PASSED"
          description: "AAT passed: N/M hypotheses verified"
          target_url: "Link to evidence bundle JSON"
          merge_blocker: false (configurable per phase)

        failure:
          condition: "Any hypothesis FAILED OR anti-gaming violation detected OR parse error"
          description: "AAT failed: {reason} - see evidence bundle"
          target_url: "Link to evidence bundle JSON"
          merge_blocker: true (configurable per phase)
          actionable_errors:
            - "Missing PR section (Usage, Expected Outcomes, Evidence Script, Known Limitations)"
            - "Hypothesis verification failed: {hypothesis_id}"
            - "Anti-gaming violation: undocumented TODO in {file}"
            - "Input variation showed invariance"

        pending:
          condition: "AAT requires human adjudication (NEEDS_ADJUDICATION)"
          description: "NEEDS_ADJUDICATION: {reason}"
          target_url: "Link to evidence bundle with ambiguity reason"
          merge_blocker: true (always blocks during adjudication)
          escalation:
            - "Level 1 (4 hours): Notify AUTH_AAT"
            - "Level 2 (24 hours): Escalate to AUTH_PRODUCT"
            - "Level 3 (N/A): Auto-fail with documented reason"

      github_api_contract:
        endpoint: "gh api repos/{owner}/{repo}/statuses/{sha}"
        payload:
          state: "enum(success, failure, pending)"
          context: "aat/acceptance (literal string)"
          description: "string (max 140 chars)"
          target_url: "string (https URL to evidence bundle)"
        success_response: "Status created/updated on commit"
        idempotency: "Multiple calls with same state are safe"

    - id: CONTRACT-004
      name: "CLI Contract"
      version: "1.0.0"
      description: "Specifies the xtask command interface for AAT invocation"
      binding:
        applies_to: "All xtask aat invocations"
        implementation_location: "xtask/src/tasks/aat.rs"
      cli_interface:
        command: "cargo xtask aat <PR_URL>"
        arguments:
          - name: "PR_URL"
            type: "string"
            pattern: "https://github.com/{owner}/{repo}/pull/{number}"
            required: true
            example: "https://github.com/anthropic-ai/apm2/pull/123"

        options: |
          --dry-run       : Preview what would happen without setting status
          --evidence-dir  : Override evidence output directory (default: evidence/aat/)
          --timeout       : Override execution timeout in seconds (default: 300)
          --skip-gaming   : Skip anti-gaming checks (requires WAIVER)

      exit_codes:
        0: "AAT completed successfully (verdict PASSED or NEEDS_ADJUDICATION)"
        1: "AAT failed with execution error or parse failure"
        2: "Invalid arguments (bad PR_URL format)"
        3: "GitHub API error (authentication, rate limit, etc.)"
        4: "Timeout exceeded during hypothesis verification"

      output_contract:
        stdout: "Progress messages and verdict summary"
        stderr: "Warnings and non-fatal errors"
        evidence_bundle: "JSON written to evidence/aat/PR-{number}_{timestamp}.json"
        status_check: "GitHub status updated via gh api"

      implementation_requirements:
        - "Parse PR_URL to extract owner, repo, number"
        - "Fetch PR details and description from GitHub API"
        - "Parse PR description for required sections (CONTRACT-001)"
        - "Create at least 3 hypotheses from Expected Outcomes section"
        - "Record hypothesis formation timestamp BEFORE execution"
        - "Execute verification for each hypothesis"
        - "Run anti-gaming checks on diff"
        - "Generate evidence bundle JSON (CONTRACT-002)"
        - "Set GitHub status via gh api (CONTRACT-003)"
        - "Exit with appropriate code and print verdict to stdout"

  versioning:
    strategy: "Semantic versioning with backward compatibility"
    contract_stability: "1.x contracts are stable; changes bump minor version"
    breaking_change_policy: |
      Major version bump (2.0.0) required for:
      - Removing required PR description section
      - Changing evidence bundle schema
      - Changing GitHub status state enum values
      - Changing CLI command syntax

    rollback_procedure: |
      If new contract version breaks existing PRs:
      1. Disable AAT enforcement (move to Phase 1)
      2. Keep evidence bundles and status checks readable
      3. Support reading both old and new evidence bundle versions
      4. Communicate breaking changes 1 week in advance

  reference_implementations:
    - "xtask/src/tasks/aat.rs - Core AAT task implementation"
    - "documents/skills/aat/SKILL.md - AAT protocol details"
    - "evidence/aat/PR-*_*.json - Example evidence bundles"

evidence_artifact:
  schema_version: "2026-01-23"
  id: "EVID-0305"
  title: "Receipt binding enforcement and replay verification evidence"
  category: "INTEGRATION_TEST_RESULT"
  status: "PASS"
  description: |
    Evidence that receipt emission with envelope bindings is enforced
    at the LedgerEventEmitter level. Both SQLite (production) and stub
    (test) implementations include envelope_hash, capability_manifest_hash,
    and view_commitment_hash in signed receipt payloads, with fail-closed
    validation that rejects zero bindings. Replay verification confirms
    that reconstructed bindings from ledger payloads match the original
    CAS-stored envelope.
  requirement_ids:
    - "REQ-0004"
  source_refs:
    - "crates/apm2-daemon/src/protocol/dispatch.rs"
    - "crates/apm2-daemon/src/ledger.rs"
    - "crates/apm2-daemon/tests/tck_00350_envelope_binding.rs"
  artifacts:
    - type: "test_output"
      description: |
        Integration tests verify receipt binding enforcement:
        - emit_receipt_succeeds_with_valid_bindings_stub: stub emitter includes
          bindings in signed payload, with specific non-zero hex values asserted
        - emit_receipt_succeeds_with_valid_bindings_sqlite: SQLite emitter
          persists bindings in signed payload, verified via direct SQL query
          (count = 1)
        - emit_receipt_rejects_zero_bindings: stub rejects zero envelope_hash
        - emit_receipt_rejects_zero_bindings_sqlite: SQLite rejects zero bindings
        - e2e_envelope_bindings_receipt_verify: reconstructs bindings from receipt
          payload JSON and verifies against original EpisodeEnvelopeV1
        - replay_verification_roundtrip: validates bindings extracted from
          envelope can be verified against that same envelope
        - replay_verification_detects_tampered_envelope_hash: tampered hash
          yields BindingMismatch{field: "envelope_hash"}
        - replay_verification_detects_tampered_capability_hash: tampered hash
          yields BindingMismatch{field: "capability_manifest_hash"}
        - replay_verification_detects_tampered_view_hash: tampered hash
          yields BindingMismatch{field: "view_commitment_hash"}
      ref: "cargo test -p apm2-daemon --test tck_00350_envelope_binding"

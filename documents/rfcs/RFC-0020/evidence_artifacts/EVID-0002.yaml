evidence_artifact:
  schema_version: "2026-01-23"
  id: "EVID-0002"
  title: "Handshake contract-hash binding and tiered mismatch gates evidence"
  category: "UNIT_TEST_RESULT"
  status: "PASS"
  description: |
    Evidence that the Hello/HelloAck handshake exchanges cli_contract_hash
    and canonicalizer metadata, and that the tiered mismatch policy is
    enforced per RFC-0020 sections 3.1.2 and 3.1.3. Tier0/Tier1 mismatches
    are waived (warned), Tier2+ mismatches are denied (fail-closed).
    SessionContractBinding metadata is persisted for session start events.
    Mismatch counters are emitted with risk-tier labels per section 11.4.
  requirement_ids:
    - "REQ-0002"
  source_refs:
    - "crates/apm2-daemon/src/hsi_contract/handshake_binding.rs"
    - "crates/apm2-daemon/src/hsi_contract/mod.rs"
    - "crates/apm2-daemon/src/protocol/handshake.rs"
    - "crates/apm2-daemon/src/metrics.rs"
  artifacts:
    - type: "test_output"
      description: |
        Handshake binding tests verify contract-hash exchange and mismatch gates:
        - test_hello_with_contract_hash: cli_contract_hash serialization roundtrip
        - test_hello_without_contract_hash_omits_field: backward-compatible omission
        - test_hello_with_canonicalizers: canonicalizer metadata serialization
        - test_hello_without_canonicalizers_omits_field: backward-compatible omission
        - test_hello_ack_with_contract_binding_fields: server contract binding in HelloAck
        - test_hello_ack_omits_empty_contract_fields: skip_serializing_if works
        - test_hello_nack_contract_mismatch: ContractMismatch error code
        - test_contract_mismatch_error_code_serialization: snake_case serialization
        - test_server_handshake_contract_match_tier2: exact match at Tier2 succeeds
        - test_server_handshake_contract_mismatch_tier0_waived: Tier0 mismatch waived
        - test_server_handshake_contract_mismatch_tier2_denied: Tier2 mismatch denied
        - test_server_handshake_missing_client_hash_tier2_denied: fail-closed for missing hash
        - test_server_handshake_missing_client_hash_tier0_allowed: backward compat at Tier0
        - test_server_handshake_version_mismatch_takes_precedence_over_contract: ordering
        - test_server_handshake_hello_ack_includes_server_canonicalizers: canonicalizer echo
        - test_server_handshake_no_contract_config_succeeds: unconfigured server
        - test_backward_compat_hello_without_contract_fields: old client compat
        - test_backward_compat_hello_ack_without_contract_fields: old server compat
        Handshake binding module tests verify mismatch policy evaluation:
        - exact_match_returns_match: no mismatch when hashes match
        - contract_hash_mismatch_tier0_waived: Tier0 warn/waive
        - contract_hash_mismatch_tier1_waived: Tier1 warn/waive
        - contract_hash_mismatch_tier2_denied: Tier2 deny
        - contract_hash_mismatch_tier3_denied: Tier3 deny
        - contract_hash_mismatch_tier4_denied: Tier4 deny
        - missing_client_hash_tier0_allowed: empty hash at Tier0 acceptable
        - missing_client_hash_tier2_denied: empty hash at Tier2 denied
        - canonicalizer_version_mismatch_tier0_waived: version mismatch waived
        - canonicalizer_version_mismatch_tier2_denied: version mismatch denied
        - unknown_canonicalizer_tier2_denied: unsupported canonicalizer denied
        - combined_hash_and_canonicalizer_mismatch: multiple mismatches reported
        Metrics tests verify contract mismatch counter:
        - test_contract_mismatch_counter: counter increments with risk_tier/outcome labels
        - test_metrics_text_encoding: contract_mismatch_total in Prometheus output
      ref: "cargo test -p apm2-daemon --lib protocol::handshake && cargo test -p apm2-daemon --lib hsi_contract::handshake_binding && cargo test -p apm2-daemon --lib metrics"

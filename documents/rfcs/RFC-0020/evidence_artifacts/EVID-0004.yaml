evidence_artifact:
  schema_version: "2026-01-23"
  id: "EVID-0004"
  title: "EpisodeEnvelopeV1 and receipt binding enforcement evidence"
  category: "UNIT_TEST_RESULT"
  status: "PASS"
  description: |
    Evidence that EpisodeEnvelopeV1 construction enforces non-zero bindings
    (fail-closed), receipts always carry envelope/capability/view bindings,
    spawn/resume is denied when envelope is absent or malformed, and replay
    verification can resolve and verify bindings from CAS + ledger.
  requirement_ids:
    - "REQ-0004"
  source_refs:
    - "crates/apm2-daemon/src/episode/envelope.rs"
    - "crates/apm2-daemon/src/ledger.rs"
    - "crates/apm2-daemon/src/protocol/dispatch.rs"
    - "crates/apm2-daemon/tests/tck_00350_envelope_binding.rs"
  artifacts:
    - type: "test_output"
      description: |
        Unit tests in envelope.rs verify:
        - test_v1_envelope_builder_minimal: V1 envelope builds with valid fields
        - test_v1_envelope_delegated: delegated envelopes carry permeability_receipt_hash
        - test_v1_envelope_rejects_zero_view_commitment: fail-closed on zero view hash
        - test_v1_envelope_rejects_zero_freshness_pinset: fail-closed on zero freshness hash
        - test_v1_envelope_rejects_zero_permeability_receipt: fail-closed on zero permeability hash
        - test_v1_envelope_inner_error_propagated: inner envelope errors propagate
        - test_v1_bindings_extraction: bindings extracted correctly from envelope
        - test_v1_bindings_validate_passes: valid bindings pass validation
        - test_v1_bindings_validate_rejects_zero_*: zero binding hashes rejected
        - test_v1_bindings_verify_against_matching_envelope: replay verification succeeds
        - test_v1_bindings_verify_against_mismatched_envelope: tampered bindings detected
        - test_v1_validate_for_spawn_passes: valid envelope passes spawn gate
        - test_v1_validate_for_delegated_spawn_requires_permeability: delegated requires hash
        - test_v1_validate_for_delegated_spawn_passes_with_hash: delegated with hash succeeds
        - test_spawn_gate_rejects_absent_envelope: None envelope rejected
        - test_spawn_gate_accepts_valid_envelope: valid envelope accepted
        - test_spawn_gate_rejects_delegated_without_permeability: delegated gate enforced
        - test_v1_bindings_to_hex_map: hex encoding correct
        - test_v1_envelope_hash_is_inner_digest: envelope_hash equals inner BLAKE3 digest
        - test_v1_replay_verification_roundtrip: full lifecycle verification succeeds

        Integration tests in tck_00350_envelope_binding.rs verify:
        - spawn_denied_without_envelope: absent envelope rejected
        - spawn_denied_with_zero_view_commitment: malformed envelope rejected
        - spawn_denied_with_zero_freshness_pinset: malformed envelope rejected
        - spawn_accepted_with_valid_envelope: valid envelope accepted
        - delegated_spawn_denied_without_permeability_receipt: delegation enforcement
        - delegated_spawn_accepted_with_permeability_receipt: delegation accepted
        - receipt_carries_bindings_after_valid_spawn: bindings are non-zero
        - receipt_rejected_with_zero_bindings: fail-closed on zero bindings
        - emit_receipt_rejects_zero_bindings: stub emitter rejects zero bindings
        - emit_receipt_succeeds_with_valid_bindings_stub: receipt emission with bindings
        - emit_receipt_succeeds_with_valid_bindings_sqlite: SQLite receipt with bindings
        - emit_receipt_rejects_zero_bindings_sqlite: SQLite fail-closed on zero bindings
        - replay_verification_roundtrip: CAS + ledger verification succeeds
        - replay_verification_detects_tampered_*: tamper detection verified
        - envelope_binds_freshness_pinset_hash: freshness commitment verified
        - delegated_episode_binds_permeability_receipt_hash: delegation binding verified
        - e2e_envelope_bindings_receipt_verify: full end-to-end lifecycle
      ref: "cargo test -p apm2-daemon episode::envelope::tests && cargo test -p apm2-daemon --test tck_00350_envelope_binding"

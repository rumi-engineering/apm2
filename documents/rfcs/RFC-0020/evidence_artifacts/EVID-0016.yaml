evidence_artifact:
  schema_version: "2026-02-07"
  id: "EVID-0016"
  title: "AuthoritySealV1 unified fact-authentication conformance evidence"
  category: "UNIT_TEST_RESULT"
  status: "PASS"
  description: |
    Evidence that REQ-0016 acceptance criteria are met by the AuthoritySealV1
    implementation in the daemon identity module. The implementation supports
    four seal kinds (SINGLE_SIG, QUORUM_MULTISIG, QUORUM_THRESHOLD,
    MERKLE_BATCH) with domain-separated preimages, mandatory ledger-anchor
    binding, temporal authority binding, call-site subject enforcement, and
    fail-closed validation of all construction and verification parameters.

    Domain separation: every preimage hashed for verification includes the
    authority seal domain separator, seal kind tag, issuer cell ID, issuer
    identity bytes (public key ID or keyset ID), subject kind string
    (artifact kind + schema version), subject hash, ledger anchor canonical
    bytes, and time_envelope_ref. Tests confirm that different issuer cell
    IDs, issuer IDs, subject kinds, seal kinds, ledger anchors, and
    time_envelope_ref values produce distinct preimages.

    Temporal authority binding: all seals carry a time_envelope_ref field
    (32-byte hash binding to an HTF time envelope). Verification methods
    accept a require_temporal flag; when set, a zero time_envelope_ref is
    rejected with TemporalAuthorityRequired, enforcing temporal authority
    for Tier2+ and governance contexts.

    Call-site subject enforcement: all verification methods accept
    expected_subject_kind and expected_subject_hash parameters. Mismatches
    are rejected with SubjectKindMismatch before any cryptographic work,
    preventing cross-artifact verification confusion.

    Issuer identity binding: the domain-separated preimage and canonical bytes
    both include issuer_cell_id and issuer_id bytes, binding issuer identity
    metadata to the cryptographic proof and preventing metadata substitution
    or replay attacks.

    Ledger anchor binding: all seals require a LedgerAnchorV1 at construction
    time. Free-floating batch root rejection is enforced at construction time
    (empty signature vectors are rejected by AuthoritySealV1::new). The
    reject_free_floating_batch_root helper provides a named assertion point
    for integration code.

    Quorum identifier validation: quorum/threshold seal kinds require an
    IssuerId::Quorum issuer; single-sig seals require IssuerId::PublicKey.
    Mismatches are rejected at construction time.

    Unsigned batch root rejection: MerkleBatch seals reject empty signature
    vectors at construction, preventing unsigned batch roots from entering
    the verification path.

    Single-key MERKLE_BATCH signature count: when a MerkleBatch seal uses a
    single-key (PublicKey) issuer, exactly one signature is required at
    construction time. Multiple signatures are rejected.
  requirement_ids:
    - "REQ-0016"
  source_refs:
    - "documents/rfcs/RFC-0020/requirements/REQ-0016.yaml"
    - "crates/apm2-daemon/src/identity/authority_seal.rs"
    - "crates/apm2-daemon/src/identity/mod.rs"
    - "crates/apm2-daemon/src/identity/directory_proof.rs"
  artifacts:
    - type: "test_output"
      description: |
        SubjectKind domain separation tag validation:
        - subject_kind_rejects_empty: empty tags rejected
        - subject_kind_rejects_non_ascii: non-ASCII tags rejected
        - subject_kind_rejects_too_long: tags exceeding MAX_SUBJECT_KIND_LEN rejected
        - subject_kind_accepts_valid: well-formed tags accepted
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::subject_kind_rejects_empty"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::subject_kind_rejects_non_ascii"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::subject_kind_rejects_too_long"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::subject_kind_accepts_valid"
    - type: "test_output"
      description: |
        SealKind tag parsing and fail-closed unknown rejection:
        - seal_kind_round_trip: all four tags round-trip correctly
        - seal_kind_rejects_unknown: 0x00, 0x05, 0xFF all rejected
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::seal_kind_round_trip"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::seal_kind_rejects_unknown"
    - type: "test_output"
      description: |
        Construction validation â€” issuer/seal kind compatibility and signature
        count bounds:
        - single_sig_rejects_quorum_issuer: quorum id rejected for SingleSig
        - quorum_multisig_rejects_single_key_issuer: public key rejected for QuorumMultisig
        - quorum_rejects_empty_signatures: zero signatures rejected for quorum seals
        - single_sig_rejects_wrong_signature_count: two signatures rejected for SingleSig
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::single_sig_rejects_quorum_issuer"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::quorum_multisig_rejects_single_key_issuer"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::quorum_rejects_empty_signatures"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::single_sig_rejects_wrong_signature_count"
    - type: "test_output"
      description: |
        Single-sig (SINGLE_SIG) verification:
        - verify_single_sig_valid: correct key accepts
        - verify_single_sig_wrong_key: wrong key rejects
        - verify_single_sig_tampered_subject: tampered subject hash rejects
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::verify_single_sig_valid"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::verify_single_sig_wrong_key"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::verify_single_sig_tampered_subject"
    - type: "test_output"
      description: |
        Quorum multisig (QUORUM_MULTISIG) verification:
        - verify_quorum_multisig_valid: all signers valid accepts (n-of-n)
        - verify_quorum_multisig_one_bad_sig: one bad signer rejects
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::verify_quorum_multisig_valid"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::verify_quorum_multisig_one_bad_sig"
    - type: "test_output"
      description: |
        Quorum threshold (QUORUM_THRESHOLD) verification:
        - verify_quorum_threshold_meets_threshold: 2-of-3 with 2 valid sigs accepts
        - verify_quorum_threshold_below_threshold: 1-of-3 with threshold=2 rejects
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::verify_quorum_threshold_meets_threshold"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::verify_quorum_threshold_below_threshold"
    - type: "test_output"
      description: |
        Merkle batch (MERKLE_BATCH) verification and unsigned root rejection:
        - verify_merkle_batch_valid: signed root + valid inclusion proof accepts
        - verify_merkle_batch_wrong_artifact: wrong artifact hash rejects via leaf mismatch
        - merkle_proof_depth_exceeded: proof depth > MAX_MERKLE_PROOF_DEPTH rejected
        - merkle_batch_rejects_empty_signatures: unsigned batch root rejected at construction
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::verify_merkle_batch_valid"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::verify_merkle_batch_wrong_artifact"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::merkle_proof_depth_exceeded"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::merkle_batch_rejects_empty_signatures"
    - type: "test_output"
      description: |
        Domain separation preimage uniqueness:
        - domain_separated_preimage_differs_by_subject_kind
        - domain_separated_preimage_differs_by_seal_kind
        - domain_separated_preimage_differs_by_ledger_anchor
        - test_preimage_changes_with_different_issuer_cell_id: different cell_id produces different preimage
        - test_preimage_changes_with_different_issuer_id: different issuer key produces different preimage
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::domain_separated_preimage_differs_by_subject_kind"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::domain_separated_preimage_differs_by_seal_kind"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::domain_separated_preimage_differs_by_ledger_anchor"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::test_preimage_changes_with_different_issuer_cell_id"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::test_preimage_changes_with_different_issuer_id"
    - type: "test_output"
      description: |
        Receipt leaf hash domain separation and determinism:
        - receipt_leaf_hash_is_domain_separated: leaf hash differs from raw hash
        - receipt_leaf_hash_is_deterministic: same input yields same output
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::receipt_leaf_hash_is_domain_separated"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::receipt_leaf_hash_is_deterministic"
    - type: "test_output"
      description: |
        Free-floating batch root rejection (section 0.1(11b)):
        - reject_free_floating_batch_root_passes_for_anchored: anchored seal accepted
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::reject_free_floating_batch_root_passes_for_anchored"
    - type: "test_output"
      description: |
        Merkle inclusion proof edge cases:
        - merkle_proof_empty_siblings_single_leaf: single-leaf tree verifies
        - merkle_proof_wrong_root: wrong root rejects
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::merkle_proof_empty_siblings_single_leaf"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::merkle_proof_wrong_root"
    - type: "test_output"
      description: |
        Temporal authority binding (time_envelope_ref):
        - test_tier2_seal_rejects_zero_time_envelope_ref: Tier2+ require_temporal=true rejects zero ref
        - test_time_envelope_ref_included_in_preimage: different refs produce different preimages
        - test_time_envelope_ref_in_canonical_bytes: ref survives canonical bytes round-trip
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::test_tier2_seal_rejects_zero_time_envelope_ref"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::test_time_envelope_ref_included_in_preimage"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::test_time_envelope_ref_in_canonical_bytes"
    - type: "test_output"
      description: |
        Call-site subject enforcement:
        - test_verify_rejects_subject_kind_mismatch: wrong expected_subject_kind rejected
        - test_verify_rejects_subject_hash_mismatch: wrong expected_subject_hash rejected
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::test_verify_rejects_subject_kind_mismatch"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::test_verify_rejects_subject_hash_mismatch"
    - type: "test_output"
      description: |
        Single-key MERKLE_BATCH signature count enforcement:
        - merkle_batch_single_key_rejects_multiple_signatures: two sigs rejected for single-key issuer
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::merkle_batch_single_key_rejects_multiple_signatures"
    - type: "test_output"
      description: |
        Extra signature rejection (threshold paths):
        - verify_quorum_threshold_rejects_extra_signatures: more sigs than keys rejected
        - merkle_batch_quorum_threshold_rejects_extra_signatures: more sigs than keys rejected in batch path
      ref:
        - "cargo test -p apm2-daemon identity::authority_seal::tests::verify_quorum_threshold_rejects_extra_signatures"
        - "cargo test -p apm2-daemon identity::authority_seal::tests::merkle_batch_quorum_threshold_rejects_extra_signatures"
    - type: "test_output"
      description: |
        Full daemon test suite regression check.
      ref:
        - "cargo test -p apm2-daemon"

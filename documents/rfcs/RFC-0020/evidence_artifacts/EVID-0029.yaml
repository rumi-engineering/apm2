evidence_artifact:
  schema_version: "2026-01-23"
  id: "EVID-0029"
  title: "Context firewall and TOCTOU integrity evidence"
  category: "UNIT_TEST_RESULT"
  status: "PASS"
  description: |
    Evidence that REQ-0029 acceptance criteria are enforced for context
    firewall gating, TOCTOU pre-actuation checks, and Tier3+ mandatory
    termination semantics.

    This artifact covers dispatcher and handler invariants added for
    TCK-00375 iteration work:
    - Mandatory firewall defects are enforced before tool actuation
      (no tool execution when Tier3+ mandatory defects are present)
    - Broker/handler verified-content key normalization is aligned via
      shared derivation helpers and workspace-relative lookup parity
    - Search scan budget accounting in TOCTOU-required mode excludes
      non-admitted files so excluded siblings cannot exhaust search budget
    - Read/Search/ListFiles consume only pre-verified bytes when TOCTOU
      verification is required (fail-closed)

    Umbrella rollout linkage (TCK-00438) additionally validates:
    - launch-lineage continuity from role/context admission through
      session start, authoritative receipts, and projection outputs,
    - replay-consistent projection responses over unchanged ledger state,
    - stale/adversarial fail-closed outcomes across launch, boundary,
      and liveness slices.
  requirement_ids:
    - "REQ-0029"
  source_refs:
    - "documents/rfcs/RFC-0020/requirements/REQ-0029.yaml"
    - "crates/apm2-daemon/src/protocol/session_dispatch.rs"
    - "crates/apm2-daemon/src/episode/broker.rs"
    - "crates/apm2-daemon/src/episode/handlers.rs"
    - "crates/apm2-daemon/src/episode/verified_content.rs"
    - "crates/apm2-daemon/tests/tck_00438_launch_rollout.rs"
  artifacts:
    - type: "test_output"
      description: |
        Mandatory Tier3+ defect pre-actuation enforcement:
        - test_mandatory_defect_terminates_before_search_actuation
          verifies Allow+mandatory-defect broker responses are converted to
          termination before tool execution.
      ref:
        - "cargo test -p apm2-daemon protocol::session_dispatch::tests::tck_00375_firewall_enforcement::test_mandatory_defect_terminates_before_search_actuation"
    - type: "test_output"
      description: |
        Verified-content normalization parity and TOCTOU fail-closed path:
        - test_read_handler_accepts_workspace_relative_verified_key_when_toctou_required
        - test_search_handler_accepts_workspace_relative_verified_keys_when_toctou_required
        - test_listfiles_handler_accepts_workspace_relative_verified_keys_when_toctou_required
      ref:
        - "cargo test -p apm2-daemon episode::handlers::tests::test_read_handler_accepts_workspace_relative_verified_key_when_toctou_required"
        - "cargo test -p apm2-daemon episode::handlers::tests::test_search_handler_accepts_workspace_relative_verified_keys_when_toctou_required"
        - "cargo test -p apm2-daemon episode::handlers::tests::test_listfiles_handler_accepts_workspace_relative_verified_keys_when_toctou_required"
    - type: "test_output"
      description: |
        Search budget accounting excludes non-admitted files in
        TOCTOU-required mode:
        - test_search_toctou_budget_skips_unverified_files
      ref:
        - "cargo test -p apm2-daemon episode::handlers::tests::test_search_toctou_budget_skips_unverified_files"
    - type: "test_output"
      description: |
        Full daemon regression suite covering REQ-0029 contract surfaces.
      ref:
        - "cargo test -p apm2-daemon"
    - type: "integration_test"
      path: "crates/apm2-daemon/tests/tck_00438_launch_rollout.rs"
      description: |
        `tck_00438_launch_rollout_e2e_lineage_liveness_and_projection`
        validates end-to-end launch lineage continuity and replay-consistent
        auditor/orchestrator projection outputs with admissible boundary +
        liveness evidence.
    - type: "integration_test"
      path: "crates/apm2-daemon/tests/tck_00438_launch_rollout.rs"
      description: |
        `tck_00438_launch_rollout_fails_closed_on_missing_or_inconsistent_slices`
        validates fail-closed outcomes for tampered launch lineage, missing
        channel witness metadata, stale heartbeat progression checks, and
        malformed receipt projection surfaces.
    - type: "test_output"
      description: |
        Umbrella launch rollout integration suite command.
      ref:
        - "cargo test -p apm2-daemon --test tck_00438_launch_rollout"

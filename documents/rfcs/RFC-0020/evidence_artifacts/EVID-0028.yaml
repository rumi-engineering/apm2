evidence_artifact:
  schema_version: "2026-01-23"
  id: "EVID-0028"
  title: "Capsule containment with no ambient authority - unit test evidence"
  category: "UNIT_TEST_RESULT"
  status: "PASS"
  description: |
    Evidence that capsule profile linux-ns-v1 policy types, validation logic,
    and admission gate correctly enforce no-ambient-authority containment rules
    per REQ-0028. This ticket delivers module-level capsule profile policy
    types and validation. It does NOT deliver runtime enforcement in daemon
    actuation paths -- that is the scope of TCK-00375 (context firewall
    TOCTOU enforcement) and TCK-00376 (no-bypass path ratchet). The
    AdmissionGate::check() method is provided as a library function for use
    by downstream tickets.

    Tests verify:
    - Tier3+ actuation is rejected without an admitted capsule profile
      (unit-level gate logic only; runtime wiring deferred to TCK-00375)
    - Tier0-Tier2 actuation permits absent capsule (optional)
    - Tampered profile hash causes admission rejection
    - Deny-by-default egress blocks all unlisted routes
    - Explicit egress routes are allowed only for exact (host, port, protocol) match
    - deny_by_default=false is fail-closed (denies all traffic)
    - linux-ns-v1 requires user+mount+pid+net namespaces (insufficient namespaces rejected)
    - linux-ns-v1 requires at least Restricted seccomp level
    - linux-ns-v1 requires bounded non-zero cgroup controls (memory, pids, cpu_quota, io_weight)
    - Tier3+ admission only accepts enumerated admitted profile IDs (e.g., linux-ns-v1)
    - Content-addressed profile hash is deterministic across builds
    - Profile hash changes when any security-relevant field changes
    - Serde roundtrip preserves profile integrity
    - Builder validates all resource limits (max egress routes, max executables)
  requirement_ids:
    - "REQ-0028"
  source_refs:
    - "crates/apm2-core/src/capsule/profile.rs"
    - "crates/apm2-core/src/capsule/mod.rs"
  artifacts:
    - type: "test_output"
      description: |
        Profile and admission gate tests (51 tests):
        - test_build_linux_ns_v1_defaults: validates default profile meets all requirements
        - test_build_with_egress_routes: explicit route grants work correctly
        - test_build_missing_profile_id: missing field rejected
        - test_build_rejects_deny_by_default_false: fail-closed egress enforcement
        - test_build_rejects_insufficient_namespaces: user+mount+pid+net required
        - test_build_rejects_insufficient_seccomp: None/Baseline rejected for linux-ns-v1
        - test_build_accepts_strict_seccomp: Strict level accepted
        - test_build_too_many_egress_routes: route count limit enforced
        - test_build_too_many_executables: executable count limit enforced
        - test_profile_hash_deterministic: same config produces same hash
        - test_profile_hash_changes_with_routes: hash changes with egress routes
        - test_profile_hash_changes_with_seccomp: hash changes with seccomp level
        - test_egress_deny_all: deny-all blocks all traffic
        - test_egress_explicit_route: explicit route allows exact match only
        - test_egress_deny_by_default_false_rejects_all: fail-closed on invalid config
        - test_admission_tier0_no_capsule_ok: Tier0 without capsule passes
        - test_admission_tier1_no_capsule_ok: Tier1 without capsule passes
        - test_admission_tier2_no_capsule_ok: Tier2 without capsule passes
        - test_admission_tier3_no_capsule_rejected: Tier3 without capsule rejected
        - test_admission_tier4_no_capsule_rejected: Tier4 without capsule rejected
        - test_admission_tier3_with_valid_capsule_ok: Tier3 with valid capsule passes
        - test_admission_tier4_with_valid_capsule_ok: Tier4 with valid capsule passes
        - test_admission_tier3_with_invalid_capsule_rejected: tampered hash rejected
        - test_admission_tier3_rejects_custom_weak_profile: non-admitted profile_id rejected at Tier3
        - test_admission_tier4_rejects_unadmitted_profile_id: non-admitted profile_id rejected at Tier4
        - test_admission_tier2_allows_non_admitted_profile_id: below Tier3 no enforcement
        - test_namespace_isolated: full isolation config validated
        - test_namespace_insufficient_user_missing: partial namespace config detected
        - test_namespace_insufficient_net_missing: net=false detected as insufficient
        - test_build_rejects_net_false_for_linux_ns_v1: builder rejects net=false
        - test_admission_tier3_rejects_net_false_profile: Tier3 rejects tampered net=false
        - test_cgroup_default_restricted: default cgroup limits verified
        - test_build_rejects_zero_memory_limit: zero memory_limit_bytes rejected
        - test_build_rejects_zero_pids_max: zero pids_max rejected
        - test_build_rejects_zero_cpu_quota: zero cpu_quota_us rejected
        - test_build_rejects_zero_io_weight: zero io_weight rejected
        - test_build_rejects_io_weight_above_10000: io_weight > 10000 rejected
        - test_build_accepts_io_weight_at_boundaries: io_weight=1 and 10000 accepted
        - test_build_rejects_all_zero_cgroups: all-zero cgroup limits rejected
        - test_violation_kind_display: violation kinds display correctly
        - test_profile_serde_roundtrip: serialization preserves integrity
        - test_egress_route_empty_host: empty host rejected
        - test_egress_route_port_zero: zero port rejected
        - test_egress_route_invalid_protocol: invalid protocol rejected
        RFC-0020 ยง4.3 mandatory controls (new):
        - test_build_rejects_readonly_rootfs_false: readonly_rootfs=false rejected for linux-ns-v1
        - test_build_rejects_tmpfs_tmp_false: tmpfs_tmp=false rejected for linux-ns-v1
        - test_build_rejects_scrub_environment_false: scrub_environment=false rejected for linux-ns-v1
        - test_admission_tier3_rejects_readonly_rootfs_false_profile: Tier3 rejects tampered readonly_rootfs
        - test_admission_tier3_rejects_scrub_environment_false_profile: Tier3 rejects tampered scrub_environment
        - test_non_linux_ns_v1_allows_optional_hardening: non-linux-ns-v1 profiles not enforced
      ref: "cargo test -p apm2-core -- capsule::profile"

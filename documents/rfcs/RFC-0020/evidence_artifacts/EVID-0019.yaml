evidence_artifact:
  schema_version: "2026-01-23"
  id: "EVID-0019"
  title: "Epoch seal monotonicity, equivocation, fail-closed verification, and admission wiring evidence"
  category: "UNIT_TEST_RESULT"
  status: "PASS"
  description: |
    Evidence that EpochSealV1 construction, monotonicity enforcement,
    equivocation detection, fail-closed signature verification, eviction
    replay protection, bounded signature deserialization, and production
    admission wiring are correctly implemented per RFC-0020 requirements.

    This artifact covers TCK-00365 epoch seal implementation:
    - Seal construction rejects invalid fields (zero epoch, empty issuer,
      zero hashes, oversized strings)
    - Verifier enforces strict monotonicity per (cell_id,
      htf_time_envelope_ref, quorum_anchor) key
    - Rollback attempts are rejected with audit events
    - Same-epoch replay with identical fields is idempotent
    - Same-epoch replay with differing fields is equivocation
    - Missing signature verifier causes fail-closed rejection
    - Content hash recomputation detects tampered seals
    - LRU eviction prevents capacity exhaustion DoS
    - Per-cell-id limits prevent single-cell capacity exhaustion
    - Tier2+ admissions fail-closed on missing seals via
      verify_with_policy()
    - Eviction high-water marks prevent replay-after-eviction attacks
    - Bounded signature deserialization rejects oversized payloads
      before allocation (prevents memory exhaustion)
    - Epoch seal verification is wired into the daemon ToolBroker
      admission path for Tier2+ authority claims (fail-closed)
  requirement_ids:
    - "REQ-0019"
  source_refs:
    - "crates/apm2-core/src/htf/epoch_seal.rs"
    - "crates/apm2-daemon/src/episode/broker.rs"
  artifacts:
    - type: "test_output"
      description: |
        Seal construction invariants:
        - seal_construction_valid
        - seal_rejects_zero_epoch
        - seal_rejects_zero_root_hash
        - seal_rejects_zero_content_hash
        - seal_rejects_empty_issuer
        - seal_rejects_oversized_issuer
        - seal_rejects_empty_cell_id
        - seal_rejects_zero_time_envelope_ref
        - seal_rejects_zero_quorum_anchor
        - seal_rejects_zero_authority_seal_hash
      ref: "cargo test -p apm2-core epoch_seal::tests::seal_"
    - type: "test_output"
      description: |
        Monotonicity and rollback enforcement:
        - verifier_accepts_first_seal
        - verifier_accepts_monotonic_sequence
        - verifier_accepts_non_consecutive_monotonic
        - verifier_rejects_rollback
        - verifier_rejects_rollback_to_epoch_1
        - monotonicity_keyed_on_cell_id_not_issuer
        - monotonicity_includes_quorum_anchor_in_key
        - monotonicity_includes_htf_time_envelope_ref_in_key
        - rollback_detected_for_same_cell_id_and_anchors
      ref: "cargo test -p apm2-core epoch_seal::tests::verifier_"
    - type: "test_output"
      description: |
        Equivocation detection and idempotent replay:
        - verifier_detects_equivocation
        - verifier_idempotent_same_seal
        - equivocation_detected_on_differing_directory_epoch
        - equivocation_detected_on_differing_receipt_batch_epoch
        - equivocation_detected_on_differing_authority_seal_hash
        - idempotent_reaccept_requires_all_fields_matching
      ref: "cargo test -p apm2-core epoch_seal::tests::equivocation"
    - type: "test_output"
      description: |
        Signature verification fail-closed:
        - verifier_without_signature_verifier_rejects_all_seals
        - verifier_with_reject_all_rejects_forged_seal
        - verifier_with_accept_all_accepts_valid_seal
        - set_signature_verifier_enables_acceptance
      ref: "cargo test -p apm2-core epoch_seal::tests::verifier_with"
    - type: "test_output"
      description: |
        LRU eviction and DoS protection:
        - verifier_evicts_lru_when_max_issuers_reached
        - verifier_eviction_does_not_panic_on_capacity_exhaustion
        - verifier_per_cell_id_limit_prevents_single_cell_exhaustion
      ref: "cargo test -p apm2-core epoch_seal::tests::verifier_evict"
    - type: "test_output"
      description: |
        Integrated tier-based policy verification:
        - verify_with_policy_rejects_missing_seal_at_tier2
        - verify_with_policy_rejects_missing_seal_at_tier3
        - verify_with_policy_accepts_missing_seal_at_tier0
        - verify_with_policy_accepts_missing_seal_at_tier1
        - verify_with_policy_accepts_valid_seal_at_tier2
        - verify_with_policy_rejects_rollback_at_tier3
      ref: "cargo test -p apm2-core epoch_seal::tests::verify_with_policy"
    - type: "test_output"
      description: |
        Eviction high-water mark replay protection:
        - eviction_replay_rejected_after_lru_eviction: verifies that a
          replayed seal at the evicted epoch is rejected with
          EvictionReplayRejected audit event.
        - eviction_replay_accepted_with_higher_epoch: verifies that a
          re-introduced key with epoch > evicted high-water is accepted.
        - eviction_high_water_count_bounded: verifies the evicted
          high-water map is bounded at MAX_EVICTION_HIGH_WATER_MARKS.
        - verify_or_reject_maps_eviction_replay_error: verifies
          verify_or_reject returns EvictionReplay error variant.
      ref: "cargo test -p apm2-core epoch_seal::tests::eviction_replay"
    - type: "test_output"
      description: |
        Bounded signature deserialization:
        - signature_deser_rejects_oversized_payload: verifies that a
          65-byte signature is rejected during deserialization before
          unbounded Vec allocation.
        - signature_deser_rejects_undersized_payload: verifies that a
          63-byte signature is rejected.
        - signature_deser_accepts_exact_size: verifies 64-byte roundtrip.
        - signature_roundtrip_preserves_bytes: full seal roundtrip.
      ref: "cargo test -p apm2-core epoch_seal::tests::signature_deser"
    - type: "test_output"
      description: |
        Daemon admission wiring (ToolBroker integration):
        - broker_epoch_seal_denies_tier2_without_seal: verifies that
          Tier2 tool requests are denied when no epoch seal is attached.
        - broker_epoch_seal_allows_tier0_without_seal: verifies that
          Tier0 tool requests pass without epoch seal.
        - broker_epoch_seal_allows_tier1_without_seal: verifies that
          Tier1 tool requests pass without epoch seal.
        - broker_epoch_seal_valid_accepted: verifies that Tier2
          requests with a valid request-carried seal are accepted.
        - broker_epoch_seal_rollback_denied: verifies that a rollback
          seal (lower epoch after higher) is denied at Tier2.
        - broker_epoch_seal_missing_seal_denied_at_tier3: verifies
          Tier3 without epoch seal is denied.
        - broker_epoch_seal_rejected_by_signature_verifier: verifies
          that seals rejected by the signature verifier are denied.
      ref: "cargo test -p apm2-daemon broker::tests::broker_epoch_seal"
    - type: "test_output"
      description: |
        Full epoch seal test suite.
      ref: "cargo test -p apm2-core epoch_seal"

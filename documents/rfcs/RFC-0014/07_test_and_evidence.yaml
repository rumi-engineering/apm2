rfc_test_and_evidence:
  schema_version: "2026-01-28"

  test_strategy:
    overview: |
      Testing follows a layered approach: unit tests for components, integration
      tests for cross-component behavior, property-based tests for invariants,
      fault injection tests for failure scenarios, and conformance tests for
      protocol compliance.

    layers:
      - layer: UNIT
        description: "Test individual functions and structs in isolation"
        scope: "Single module"
        examples:
          - "LedgerBackend trait method implementations"
          - "SchemaRegistry lookup and handshake"
          - "Merkle tree digest computation"
          - "CRDT merge operator correctness"

      - layer: INTEGRATION
        description: "Test cross-component interactions"
        scope: "Multiple modules within a crate"
        examples:
          - "Event append through LedgerBackend + SchemaRegistry"
          - "Consensus proposal through entire voting pipeline"
          - "Anti-entropy sync between two nodes"

      - layer: PROPERTY
        description: "Property-based tests for invariants"
        scope: "Randomly generated inputs"
        framework: "proptest"
        examples:
          - "Hash chain integrity: verify_chain() passes for any valid append sequence"
          - "CRDT commutativity: merge(a, merge(b, c)) == merge(merge(a, b), c)"
          - "Schema handshake symmetry: handshake(A, B) consistent with handshake(B, A)"

      - layer: FAULT_INJECTION
        description: "Simulate failures and verify recovery"
        scope: "Multi-node cluster"
        framework: "Custom test harness with Tokio simulation"
        examples:
          - "Leader crash during proposal"
          - "Network partition and heal"
          - "Byzantine equivocation"
          - "Schema mismatch rejection"

      - layer: CONFORMANCE
        description: "Protocol compliance testing"
        scope: "Wire format and behavior"
        examples:
          - "Protobuf encoding matches specification"
          - "Quorum certificate verification"
          - "Genesis block validation"

  test_categories:
    - category: "Hash Chain Integrity"
      description: "Tests ensuring hash chain remains valid across operations"
      requirements_covered:
        - DCS-REQ-0006
        - SEC-PROP-0004
      tests:
        - id: TEST-HC-001
          type: UNIT
          description: "verify_chain() passes for empty ledger"
          verification: "Assert Ok(()) for ledger with no events"

        - id: TEST-HC-002
          type: UNIT
          description: "verify_chain() passes for valid event sequence"
          verification: "Append 100 events; verify_chain() returns Ok(())"

        - id: TEST-HC-003
          type: UNIT
          description: "verify_chain() fails for tampered event"
          verification: "Modify event payload; verify_chain() returns HashChainBroken"

        - id: TEST-HC-004
          type: UNIT
          description: "verify_chain() fails for wrong prev_hash"
          verification: "Insert event with incorrect prev_hash; verify fails"

        - id: TEST-HC-005
          type: PROPERTY
          description: "Hash chain invariant under random operations"
          verification: "Generate random append sequence; verify_chain() always passes"

        - id: TEST-HC-006
          type: INTEGRATION
          description: "Hash chain preserved across consensus"
          verification: "Propose events via consensus; verify_chain() on all nodes"

    - category: "Consensus Safety"
      description: "Tests ensuring no conflicting finalization"
      requirements_covered:
        - DCS-REQ-0007
        - SEC-PROP-0001
      tests:
        - id: TEST-CS-001
          type: FAULT_INJECTION
          description: "No conflicting finality during partition"
          verification: |
            1. Start 7 nodes (f=2)
            2. Partition into {0,1,2,3,4} and {5,6}
            3. Propose event A in majority partition
            4. Attempt event B in minority partition
            5. Assert: A finalized, B not finalized
            6. Heal partition; assert B discarded

        - id: TEST-CS-002
          type: FAULT_INJECTION
          description: "Leader crash mid-proposal recovers"
          verification: |
            1. Start 4 nodes (f=1)
            2. Leader proposes event
            3. Crash leader after pre-prepare, before commit
            4. Assert: New leader elected
            5. Assert: Event eventually finalized

        - id: TEST-CS-003
          type: FAULT_INJECTION
          description: "f simultaneous crashes tolerated"
          verification: |
            1. Start 7 nodes (f=2)
            2. Crash 2 nodes
            3. Propose event
            4. Assert: Event finalized by remaining 5 nodes

        - id: TEST-CS-004
          type: UNIT
          description: "Quorum certificate requires 2f+1 signatures"
          verification: "Assert certificate invalid with 2f signatures"

    - category: "Byzantine Detection"
      description: "Tests for equivocation and invalid behavior detection"
      requirements_covered:
        - DCS-REQ-0007
        - SEC-PROP-0003
      tests:
        - id: TEST-BZ-001
          type: FAULT_INJECTION
          description: "Equivocation detected and recorded"
          verification: |
            1. Byzantine node signs proposal A for round 1
            2. Byzantine node signs proposal B for round 1
            3. Assert: Equivocation evidence generated
            4. Assert: Byzantine validator removed

        - id: TEST-BZ-002
          type: UNIT
          description: "Invalid signature rejected"
          verification: "Submit event with wrong signature; assert rejection"

        - id: TEST-BZ-003
          type: FAULT_INJECTION
          description: "Invalid proposal rejected by honest nodes"
          verification: |
            1. Byzantine node proposes event with invalid hash
            2. Assert: Honest nodes reject proposal
            3. Assert: Consensus continues without event

        - id: TEST-BZ-004
          type: UNIT
          description: "Slashing proof is replay-safe across epochs"
          verification: "Attempt to frame validator using old-epoch conflicting messages; assert rejection of proof"

    - category: "Boundary and Capability Integrity"
      description: "Tests for cross-node capability verification and relay paths"
      requirements_covered:
        - DCS-REQ-0011
        - DCS-REQ-0014
      tests:
        - id: TEST-BC-001
          type: INTEGRATION
          description: "Cross-node capability verification via signature chain"
          verification: |
            1. Node A grants capability to Actor
            2. Actor presents capability proof to Node B
            3. Assert: Node B verifies proof via Node A public key + ledger record

        - id: TEST-BC-002
          type: FAULT_INJECTION
          description: "Relay tunnel idle timeout triggers disconnect"
          verification: "Establish tunnel; idle for > timeout; assert tunnel closed by Relay"

        - id: TEST-BC-003
          type: INTEGRATION
          description: "Forced relay rotation prevents squatting"
          verification: "Establish tunnel; maintain activity; assert forced disconnect after MAX_DURATION"

        - id: TEST-BC-004
          type: UNIT
          description: "Capability proofs enforce namespace binding"
          verification: "Present capability proof with mismatched namespace; assert verification failure"

    - category: "Schema Governance"
      description: "Tests for schema registry and fail-closed validation"
      requirements_covered:
        - DCS-REQ-0003
      tests:
        - id: TEST-SG-001
          type: UNIT
          description: "Known schema accepted"
          verification: "Register schema; append event with matching digest; assert success"

        - id: TEST-SG-002
          type: UNIT
          description: "Unknown schema rejected (fail-closed)"
          verification: "Append event with unregistered digest; assert SchemaMismatch error"

        - id: TEST-SG-003
          type: UNIT
          description: "Handshake identifies missing schemas"
          verification: |
            1. Node A has schemas [S1, S2]
            2. Node B has schemas [S2, S3]
            3. Handshake result: A missing [S3], B missing [S1]

        - id: TEST-SG-004
          type: INTEGRATION
          description: "Node with missing schema cannot join cluster"
          verification: |
            1. Cluster has schema S1 registered
            2. New node without S1 attempts join
            3. Assert: Handshake fails; join rejected

    - category: "Membership Admission"
      description: "Tests for join rate limiting and bootstrap credentials"
      requirements_covered:
        - DCS-REQ-0013
      tests:
        - id: TEST-MA-001
          type: FAULT_INJECTION
          description: "Join attempt rate-limiting per source IP"
          verification: "Rapid join attempts from same IP; assert rejection after N attempts"

        - id: TEST-MA-002
          type: UNIT
          description: "Joining node MUST provide valid invitation token"
          verification: "Attempt join with missing or invalid token; assert rejection"

        - id: TEST-MA-003
          type: UNIT
          description: "Invitation tokens are single-use"
          verification: "Reuse a previously accepted token; assert rejection"

        - id: TEST-MA-004
          type: UNIT
          description: "Invitation tokens expire after configured window"
          verification: "Attempt join with expired token; assert rejection"

    - category: "Transport Security"
      description: "Tests for control plane traffic-analysis mitigation"
      requirements_covered:
        - DCS-REQ-0012
      tests:
        - id: TEST-TS-001
          type: UNIT
          description: "Control plane frame padding enforced"
          verification: "Serialize control plane message; assert frame size == configured constant"

        - id: TEST-TS-002
          type: UNIT
          description: "Control plane dispatch jitter applied"
          verification: "Emit N messages; assert dispatch jitter within configured bounds"

    - category: "Ordering and Clock Semantics"
      description: "Tests for TotalOrder, HLC, and StrictlyOrderedEvidence"
      requirements_covered:
        - DCS-REQ-0004
        - DCS-REQ-0009
        - DCS-REQ-0010
        - DCS-REQ-0011
      tests:
        - id: TEST-ORD-001
          type: UNIT
          description: "HLC preserves causality across events"
          verification: "Generate sequence of events; assert HLC(e_n) < HLC(e_n+1)"

        - id: TEST-ORD-002
          type: INTEGRATION
          description: "StrictlyOrderedEvidence enforced for Admission"
          verification: "Attempt WorkCompleted with eventual Evidence; assert rejection"

        - id: TEST-ORD-003
          type: INTEGRATION
          description: "Relay Holon tunnel maintains message order"
          verification: "Stream events through Relay; assert arrival matches departure order"

    - category: "Gate Evidence Predicates"
      description: "Tests for evidence predicates on gate receipts"
      requirements_covered:
        - DCS-REQ-0009
      tests:
        - id: TEST-GE-001
          type: UNIT
          description: "GateReceipt includes evidence_predicates"
          verification: "Generate GateReceipt; assert evidence_predicates populated"

    - category: "Anti-Entropy Sync"
      description: "Tests for CRDT merge and data plane convergence"
      requirements_covered:
        - DCS-REQ-0008
      tests:
        - id: TEST-AE-001
          type: UNIT
          description: "Merkle digest matches for identical data"
          verification: "Two nodes with same events; assert digests equal"

        - id: TEST-AE-002
          type: UNIT
          description: "Merkle digest differs for divergent data"
          verification: "Node A has event E; Node B doesn't; assert digests differ"

        - id: TEST-AE-003
          type: INTEGRATION
          description: "Pull-based sync transfers missing events"
          verification: |
            1. Node A has events [1, 2, 3]
            2. Node B has events [1, 2]
            3. B syncs from A
            4. Assert: B now has [1, 2, 3]

        - id: TEST-AE-004
          type: UNIT
          description: "LWW merge selects later HLC timestamp"
          verification: |
            1. Event A: HLC(100, 0), value X
            2. Event B: HLC(100, 1), value Y
            3. Assert: merge(A, B) == B

        - id: TEST-AE-007
          type: INTEGRATION
          description: "Merge conflict recorded as DefectRecorded event"
          verification: |
            1. Node A and B have conflicting events (NoMerge operator)
            2. Anti-entropy sync detects conflict
            3. Assert: DefectRecorded event emitted to local log

    - category: "Migration"
      description: "Tests for single-node to distributed migration"
      requirements_covered:
        - DCS-REQ-0006
      tests:
        - id: TEST-MG-001
          type: INTEGRATION
          description: "Pre-migration events verifiable post-migration"
          verification: |
            1. Create single-node ledger with 1000 events
            2. Run migration script
            3. Start in distributed mode
            4. Assert: verify_chain() passes
            5. Assert: All events readable with correct content

        - id: TEST-MG-002
          type: INTEGRATION
          description: "No seq_id gaps during migration"
          verification: "Scan all events; assert consecutive seq_ids"

        - id: TEST-MG-003
          type: INTEGRATION
          description: "Rollback preserves finalized events"
          verification: |
            1. Migrate to distributed mode
            2. Finalize 100 new events
            3. Rollback to single-node
            4. Assert: All events present and verifiable

    - category: "Performance"
      description: "Tests for latency and throughput at local-quorum scale"
      tests:
        - id: TEST-PF-001
          type: BENCHMARK
          description: "Consensus finalization latency p99 < 500ms"
          verification: "Measure 1000 proposals; assert p99 < 500ms"

        - id: TEST-PF-002
          type: BENCHMARK
          description: "Throughput >= 100 events/second"
          verification: "Sustain 100 proposals/s for 60s; assert no backpressure"

        - id: TEST-PF-003
          type: BENCHMARK
          description: "Anti-entropy sync completes within 60s for 100k events"
          verification: "Node with 100k events; new node syncs; assert < 60s"

  determinism_vectors:
    - id: DV-001
      name: "Canonical Encoding Reproducibility"
      description: |
        Verify that the same logical event produces identical bytes across
        different platforms, Rust versions, and serialization libraries.
      test_data:
        - event_type: "LeaseIssued"
          input: |
            {
              "lease_id": "lease-001",
              "work_id": "work-001",
              "actor_id": "actor-001",
              "issued_at": 1706400000000000000,
              "expires_at": 1706403600000000000
            }
          expected_hash: "to be computed during implementation"

    - id: DV-002
      name: "Hash Chain Determinism"
      description: |
        Verify that appending the same sequence of events on different nodes
        produces identical hash chains.
      verification: |
        1. Create 3 nodes with same genesis
        2. Append identical event sequence on each
        3. Assert: all nodes have same event_hash for each seq_id

    - id: DV-003
      name: "Quorum Certificate Verification"
      description: |
        Verify that quorum certificates are verifiable on any node with
        access to the validator public keys.
      verification: |
        1. Finalize event with QC on node A
        2. Transfer event + QC to node B (offline)
        3. Assert: node B can verify QC without network access

  evidence_artifacts:
    - id: EVID-0001
      name: "OPT-HYBRID Design Rationale"
      description: |
        Document analyzing the four consensus options (OPT-SEQ, OPT-RAFT,
        OPT-HYBRID, OPT-FED) and justifying OPT-HYBRID selection.
      path: "evidence_artifacts/EVID-0001-hybrid-rationale.md"

    - id: EVID-0002
      name: "LedgerBackend Trait Extraction"
      description: |
        Evidence that SqliteLedgerBackend passes all existing ledger tests.
      path: "evidence_artifacts/EVID-0002-ledgerbackend-trait-extraction.md"

    - id: EVID-0003
      name: "Trust Tier Analysis"
      description: |
        Analysis of signer tiers and key management requirements.
      path: "evidence_artifacts/EVID-0003-trust-tier-analysis.md"

    - id: EVID-0004
      name: "Schema Registry Design"
      description: |
        Design document for fail-closed schema validation.
      path: "evidence_artifacts/EVID-0004-schema-registry-design.md"

    - id: EVID-0005
      name: "Event Classification Matrix"
      description: |
        Complete classification of all kernel events by ordering guarantee.
      path: "evidence_artifacts/EVID-0005-event-classification.md"

    - id: EVID-0006
      name: "Merkle Tree Performance Analysis"
      description: |
        Benchmark results for Merkle tree operations at various scales.
      path: "evidence_artifacts/EVID-0006-merkle-tree-performance-analysis.md"

    - id: EVID-0007
      name: "Consensus Protocol Specification"
      description: |
        Formal specification of consensus messages and state machine.
      path: "evidence_artifacts/EVID-0007-consensus-protocol-specification.md"

    - id: EVID-0008
      name: "BFT Safety Proof"
      description: |
        Reference to BFT safety and liveness proofs (e.g., PBFT paper).
      path: "evidence_artifacts/EVID-0008-bft-safety-proof.md"

    - id: EVID-0009
      name: "Equivocation Detection Test Results"
      description: |
        Test results demonstrating Byzantine fault detection.
      path: "evidence_artifacts/EVID-0009-equivocation-detection-test-results.md"

    - id: EVID-0010
      name: "Hash Chain Integrity Test Results"
      description: |
        Test results for hash chain verification across scenarios.
      path: "evidence_artifacts/EVID-0010-hash-chain-integrity-test-results.md"

    - id: EVID-0011
      name: "Key Rotation Security Analysis"
      description: |
        Analysis of key rotation protocol security properties.
      path: "evidence_artifacts/EVID-0011-key-rotation-security-analysis.md"

    - id: EVID-0012
      name: "Schema Backward Compatibility"
      description: |
        Evidence that extended KernelEvent is backward compatible.
      path: "evidence_artifacts/EVID-0012-schema-backward-compatibility.md"

    - id: EVID-0013
      name: "HLC Determinism Analysis"
      description: |
        Evidence that Hybrid Logical Clocks preserve causality and deterministic merge.
      path: "evidence_artifacts/EVID-0013-hlc-determinism.md"

    - id: EVID-0014
      name: "Strictly Ordered Evidence Policy"
      description: |
        Admission policy describing when EvidencePublished must be TotalOrder.
      path: "evidence_artifacts/EVID-0014-strict-evidence.md"

    - id: EVID-0015
      name: "Relay Holon Security Review"
      description: |
        Threat analysis and mitigations for Relay Holon tunnels.
      path: "evidence_artifacts/EVID-0015-relay-holon-security-review.md"

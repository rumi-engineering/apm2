rfc_design_decisions:
  schema_version: "2026-01-29"

  version_transition:
    from_version: "v4"
    to_version: "v4.1"
    transition_date: "2026-01-29"
    mode: CORRECTION
    summary: |
      RFC v4.1 corrections: add missing specification details (TerminalVerifier,
      VerifierPolicy, KeyPolicy, LeaseRevoked), align rollout WARN window, clarify
      determinism Phase 1 vs Phase 2 enforcement, and remove engineering estimates.

  previous_transitions:
    - from_version: "v0"
      to_version: "v2"
      transition_date: "2026-01-29"
      mode: EXPLORE
      summary: |
        RFC v2 (Grounded) transition after EXPLORE council session. Design decisions
        grounded in codebase evidence. Component mapping confidence upgraded from
        LOW to MEDIUM. Open questions Q-RFC-FAC-0001 and Q-RFC-FAC-0002 resolved.
    - from_version: "v2"
      to_version: "v4"
      transition_date: "2026-01-29"
      mode: FINALIZE
      summary: |
        RFC v4 (Standard) transition after FINALIZE council session. All HYPOTHESIS
        decisions upgraded to VALIDATED. All open questions resolved or explicitly deferred.
        All security findings addressed. Ready for DECOMPOSE phase.

  finalize_findings:
    council_session_id: COUNCIL-RFC-0015-FINALIZE-20260129
    council_timestamp: "2026-01-29T14:00:00Z"
    subagents:
      - agent_id: SA-1
        role: "Structural Rigorist (Force Convergence)"
        modes: [3, 16, 42, 58, 74]
        artifact: "Explanatory Scoring Table"
        verdict: "All decisions meet 3.5+ threshold; mean score 4.08/5.0"
      - agent_id: SA-2
        role: "Implementation Feasibility (Execution Strategy)"
        modes: [11, 39, 47, 51, 70]
        artifact: "Mock Implementation Run Report"
        verdict: "GO_WITH_REMEDIATION; confidence recorded in SA-2 artifact"
      - agent_id: SA-3
        role: "Security & Anti-Cousin Guardian (Final Security Assurance)"
        modes: [8, 35, 49, 65, 80]
        artifact: "CAE Tree"
        verdict: "APPROVE_WITH_CONDITIONS; 91% confidence"

    decisions_upgraded:
      - decision_id: DD-FAC-0004
        from_status: HYPOTHESIS
        to_status: VALIDATED
        score: 3.55
        rationale: "Runtime enforcement via network policy addresses TB-0003"
      - decision_id: DD-FAC-0005
        from_status: HYPOTHESIS
        to_status: VALIDATED
        score: 4.00
        rationale: "CI evidence import pattern well-defined; attestation schema complete"
      - decision_id: DD-FAC-0006
        from_status: HYPOTHESIS
        to_status: VALIDATED
        score: 4.55
        rationale: "Typed payload schema complete; evidence binding well-specified"
      - decision_id: DD-FAC-0007
        from_status: HYPOTHESIS
        to_status: VALIDATED
        score: 3.55
        rationale: "Terminal verifier kinds and predicates defined; verifier policy schema specified"
      - decision_id: DD-FAC-0008
        from_status: HYPOTHESIS
        to_status: VALIDATED
        score: 3.55
        rationale: "Risk tier classification model defined; N by tier resolved"
      - decision_id: DD-FAC-0009
        from_status: HYPOTHESIS
        to_status: VALIDATED
        score: 5.00
        rationale: "Anti-downgrade enforcement clear; pinning semantics complete"

    security_findings_resolved:
      - finding_id: F-SA3-001
        title: "Lease Revocation Gap"
        resolution: "Add LeaseRevoked event type; enforce short HTF lease window (TIME_TBD)"
      - finding_id: F-SA3-002
        title: "WARN Mode Security Gap"
        resolution: "Reduce WARN window using HTF time envelope (TIME_TBD); exclude sensitive domains from WARN mode"
      - finding_id: F-SA3-004
        title: "TB-0003 Runtime Enforcement"
        resolution: "Implement network-level policy blocking api.github.com:443 for admission path"
      - finding_id: F-SA3-012
        title: "Insider Threat Not Modeled"
        resolution: "Added ADV-0005 threat model with dual-control (SEC-CTRL-FAC-0009)"

  exploration_findings:
    council_session_id: COUNCIL-RFC-0015-EXPLORE-20260129
    council_timestamp: "2026-01-29T13:00:00Z"
    subagents:
      - agent_id: SA-1
        role: "Structural Rigorist"
        modes: [4, 22, 47, 62, 75]
        verdict: "Pattern alignment 7.2/10; proto extension feasible"
      - agent_id: SA-2
        role: "Implementation Feasibility"
        modes: [11, 39, 51, 70, 76]
        verdict: "Integration feasibility assessed; details in SA-2 artifact"
      - agent_id: SA-3
        role: "Anti-Cousin Guardian"
        modes: [8, 35, 49, 65, 80]
        verdict: "APPROVED_WITH_CRITICAL_REMEDIATION; no cousin abstractions"

    resolved_questions:
      - question_id: Q-RFC-FAC-0001
        resolution: "EXTEND kernel_events.proto"
        rationale: |
          SA-1 analysis: kernel_events.proto uses oneof payload pattern with 8 existing
          event families. GateLease extends LeaseEvent (tag 6); GateRunCompleted and
          MergeReceipt extend EvidenceEvent (tags 3, 4). Follows established pattern,
          minimizes breaking changes, maintains single proto source. Evidence:
          proto/kernel_events.proto:43-54, crates/apm2-core/src/events/apm2.kernel.v1.rs:612-626
        confidence: HIGH

      - question_id: Q-RFC-FAC-0002
        resolution: "ContextAwareValidator middleware at tool validation layer"
        rationale: |
          SA-2 analysis: Tool validation layer (crates/apm2-core/src/tool/validation.rs)
          has clean architecture for extension. Create ContextAwareValidator trait that
          wraps existing Validator with manifest checking. Non-breaking, composable,
          testable. Integration point: crates/apm2-core/src/tool/mod.rs:66-75.
          Probability of success: 0.75 (highest of 3 options analyzed).
        confidence: HIGH

      - question_id: Q-RFC-FAC-0005
        resolution: "Reuse TranscriptChunk from CAC module"
        rationale: |
          SA-2 analysis: CAC module already handles transcript chunking with streaming
          hashing. Create AATTranscriptBinding wrapper that imports TranscriptChunk
          from cac/pack_spec.rs. Avoids duplication, maintains PRD-0007 conformance.
          Reuse rate >= 80%. Evidence: crates/apm2-core/src/cac/pack_spec.rs:1-150.
        confidence: MEDIUM

    extension_points_identified:
      - id: EP-1
        name: "Domain Separator Module"
        path: "crates/apm2-core/src/fac/domain_separator.rs"
        status: NEW
        reuses: "Canonicalization from crates/apm2-core/src/events/canonical.rs"
        affects: [DD-FAC-0001]

      - id: EP-2
        name: "GateLease Extension"
        path: "crates/apm2-core/src/lease/"
        status: EXTEND
        reuses: "LeaseReducer, LeaseState from existing module"
        affects: [DD-FAC-0002]

      - id: EP-3
        name: "Context Firewall Integration"
        paths:
          - "crates/apm2-core/src/context/manifest.rs (NEW)"
          - "crates/apm2-core/src/context/firewall.rs (NEW)"
          - "crates/apm2-core/src/policy/engine.rs (EXTEND)"
        reuses: "PolicyEngine default-deny + rule evaluation"
        affects: [DD-FAC-0003]

      - id: EP-4
        name: "Receipt Typed Payloads"
        path: "crates/apm2-core/src/evidence/receipt.rs"
        status: EXTEND
        reuses: "GateReceiptGenerator, typed payload discriminator"
        affects: [DD-FAC-0006]

      - id: EP-5
        name: "Terminal Verifier Policy"
        path: "crates/apm2-core/src/evidence/verifier.rs"
        status: NEW
        reuses: "PolicyEngine rule evaluation model"
        affects: [DD-FAC-0007]

      - id: EP-6
        name: "KeyPolicy Artifact"
        path: "crates/apm2-core/src/crypto/policy.rs"
        status: NEW
        reuses: "Policy schema infrastructure"
        affects: [Q-RFC-FAC-0003]

      - id: EP-7
        name: "Projection Adapter"
        paths:
          - "crates/apm2-daemon/src/projection/github_sync.rs"
          - "crates/apm2-daemon/src/projection/divergence_watchdog.rs"
          - "crates/apm2-daemon/src/projection/projection_receipt.rs"
        status: NEW
        reuses: "Event contract model (not agent adapter)"
        affects: [DD-FAC-0004]

    anti_cousin_analysis:
      verdict: "NO COUSIN ABSTRACTIONS DETECTED"
      findings:
        - component: "Signature Infrastructure"
          risk: NONE
          rationale: "Domain separation is thin wrapper on existing Signer"
        - component: "Policy Engine"
          risk: MITIGATED
          rationale: "Extend PolicyEngine with manifest-aware rules; avoid separate firewall"
        - component: "Leases"
          risk: NONE
          rationale: "GateLease is specialized work lease with gate_id discriminator"
        - component: "Receipts"
          risk: NONE
          rationale: "AatGateReceipt is typed payload extension"
        - component: "CI Import"
          risk: MITIGATED
          rationale: "Extend CIWorkflowCompleted with attestation field"
        - component: "Projection"
          risk: NONE
          rationale: "Intentionally new; separate holon in daemon/projection/"

    critical_security_findings:
      - id: F-SA3-001
        title: "Lease Revocation Gap"
        severity: MAJOR
        description: "No LeaseRevoked event type; compromised key valid until HTF lease window (TIME_TBD)"
        recommendation: "Add LeaseRevoked event; enforce short HTF lease window (TIME_TBD)"
        phase_to_resolve: v2

      - id: F-SA3-002
        title: "TB-0003 Runtime Enforcement Missing"
        severity: MAJOR
        description: "GitHub read isolation is architectural only; no runtime check"
        recommendation: "Implement network-level policy blocking api.github.com:443"
        phase_to_resolve: v2

      - id: F-SA3-003
        title: "WARN Phase Security Gap"
        severity: MEDIUM
        description: "WARN phase without enforcement allows context violation exfiltration; HTF window (TIME_TBD)"
        recommendation: "Reduce WARN window using HTF time envelope (TIME_TBD)"
        phase_to_resolve: v4

    pattern_alignment_scores:
      DD-FAC-0001: 8  # Ed25519 domain-separated signatures
      DD-FAC-0002: 7  # Lease-scoped gate authority
      DD-FAC-0003: 6  # OCAP context firewall (integration point resolved)
      DD-FAC-0004: 6  # Projection-only GitHub
      DD-FAC-0005: 7  # Evidence-backed CI import
      DD-FAC-0006: 8  # Typed AAT GateReceipt payloads
      DD-FAC-0007: 3  # Terminal verifier binding
      DD-FAC-0008: 5  # Risk-tiered AAT selection
      DD-FAC-0009: 6  # AAT anti-downgrade enforcement
      mean_score: 6.2

  architectural_overview:
    summary: |
      FAC implements a hardened admission protocol with seven protocol stages:
      (1) Changeset ingestion with view commitment and policy pinning,
      (2) CI evidence import as observations,
      (3) Review Context Pack compilation,
      (4) Gate-scoped authority minting via leases,
      (5) Gate execution under OCAP context firewall,
      (6) Admission decision with atomic merge receipt,
      (7) Projection sync with divergence watchdog.

      The design ensures cryptographic signing of all gate outcomes, lease-bounded
      executor authority, mechanical context containment, and projection-only GitHub
      integration. AAT gates have enhanced requirements including typed payloads,
      evidence binding, terminal verifier enforcement, and risk-tiered selection.

    constraints:
      - id: CON-FAC-001
        name: "Fail-Closed Admission"
        description: "Uncertain truth implies deny admission or escalate to adjudication/oracle"
      - id: CON-FAC-002
        name: "GitHub is Projection"
        description: "GitHub is never a source of truth; all admission authority flows from internal ledger"
      - id: CON-FAC-003
        name: "CAS-at-Commit Ordering"
        description: "Changeset and lease bound to ledger before any gate execution"
      - id: CON-FAC-004
        name: "Domain-Separated Signatures"
        description: "All critical events signed with domain-specific prefixes to prevent cross-context replay"

    components:
      - name: "Coordinator"
        holon_id: HOLON-COORDINATOR
        role: "FAC orchestration"
        responsibilities:
          - "CAS-at-commit binding of changeset to work_id"
          - "Bounded retry management per gate"
          - "Echo-trap detection and termination"
          - "Gate execution scheduling"

      - name: "Kernel Governance"
        holon_id: HOLON-KERNEL-GOVERNANCE
        role: "Authority minting"
        responsibilities:
          - "GateLease issuance with scope validation"
          - "Key rotation via KeyRotated events"
          - "COI grouping policy enforcement"
          - "Critical event signing"

      - name: "Kernel Gate"
        holon_id: HOLON-KERNEL-GATE
        role: "Admission decision"
        responsibilities:
          - "GateRunCompleted signature verification"
          - "Lease validity and expiry checking"
          - "MergeReceipt emission after trunk observation"
          - "Intervention freeze management"

      - name: "Context Compiler"
        holon_id: HOLON-CONTEXT-COMPILER
        role: "RCP compilation"
        responsibilities:
          - "Impact expansion with deterministic tools"
          - "View commitment generation"
          - "ZTI scoring and pack optimization"
          - "Stable-ID to content hash deep-pinning"

      - name: "GitHub Adapter"
        holon_id: HOLON-GITHUB-ADAPTER
        role: "Projection and CI import"
        responsibilities:
          - "Ledger -> GitHub state projection"
          - "Divergence watchdog polling"
          - "CI evidence import with attestation"
          - "Tamper detection and overwrite"

      - name: "Gate Executors"
        holon_ids:
          - HOLON-REVIEWER-QUALITY
          - HOLON-REVIEWER-SECURITY
          - HOLON-AAT
        role: "Gate execution"
        responsibilities:
          - "Execute under OCAP context firewall"
          - "Produce evidence bundles"
          - "Sign GateRunCompleted under valid lease"
          - "Respect RCP manifest allowlist"

    protocol_stages:
      - stage_id: FAC-00-INGEST_CHANGESET
        name: "Ingest ChangeSet + View Commitment"
        actor: HOLON-COORDINATOR
        inputs:
          - work_id
          - plan_snapshot_hash
          - base_selector
          - workspace_delta_or_commit_range
        outputs:
          - changeset_digest
          - pr_bundle_hash
          - view_commitment_hash
          - resolved_policy_hash
          - resolved_risk_tier

      - stage_id: FAC-01-CI_EVIDENCE_IMPORT
        name: "Import CI evidence"
        actor: HOLON-GITHUB-ADAPTER
        inputs:
          - pr_number
          - ci_provider_observations
        outputs:
          - ci_evidence_bundle_hash
          - ci_import_attestation_hash

      - stage_id: FAC-02-RCP_COMPILE
        name: "Compile Review Context Packs"
        actor: HOLON-CONTEXT-COMPILER
        inputs:
          - changeset_digest
          - ccp_atlas_hash
        outputs:
          - rcp_quality_manifest_hash
          - rcp_security_manifest_hash
          - rcp_aat_manifest_hash

      - stage_id: FAC-03-MINT_AUTHORITY
        name: "Mint gate-scoped authority"
        actor: HOLON-KERNEL-GOVERNANCE
        inputs:
          - work_id
          - changeset_digest
          - gate_set
        outputs:
          - gate_lease_issued_events

      - stage_id: FAC-04-RUN_GATES
        name: "Run gates under OCAP firewall"
        actors:
          - HOLON-REVIEWER-QUALITY
          - HOLON-REVIEWER-SECURITY
          - HOLON-AAT
        inputs:
          - gate_lease
          - rcp_manifest_hash
        outputs:
          - evidence_bundle_hash
          - gate_receipt_id
          - gate_receipt_payload_hash
          - gate_receipt_payload_type
          - gate_run_completed_event_signed

      - stage_id: FAC-05-ADMISSION_DECISION
        name: "Admission decision + atomic merge"
        actor: HOLON-KERNEL-GATE
        inputs:
          - gate_run_completed_events
          - gate_receipts
        outputs:
          - admission_decision
          - merge_receipt_hash

      - stage_id: FAC-06-PROJECTION_SYNC
        name: "Projection sync + watchdog"
        actor: HOLON-GITHUB-ADAPTER
        inputs:
          - ledger_head
          - latest_merge_receipt
        outputs:
          - projection_receipt_hash
          - projection_health

  design_decisions:
    - id: DD-FAC-0001
      title: "Ed25519 Domain-Separated Signatures for Critical Events"
      status: VALIDATED
      validation_evidence: |
        SA-1 EXPLORE analysis confirmed: Existing Signer in crates/apm2-core/src/crypto/sign.rs:36-114
        is directly reusable. Ed25519 via ed25519-dalek 2.x already in codebase. Domain separation
        requires only thin wrapper (sign_with_domain helper). AATReceipt in aat_receipt.rs:20-55
        demonstrates existing signature binding pattern. Extension point EP-1 identified:
        crates/apm2-core/src/fac/domain_separator.rs (NEW).
      decision: |
        All critical events (GateLeaseIssued, GateRunCompleted, MergeReceipt) MUST be signed
        with Ed25519 using domain-separated prefixes. Signature covers canonical bytes with
        prefix to prevent cross-context replay.
      domain_separators:
        - event: GateLeaseIssued
          prefix: "GATE_LEASE_ISSUED:"
        - event: LeaseRevoked
          prefix: "LEASE_REVOKED:"
        - event: GateRunCompleted
          prefix: "GATE_RUN_COMPLETED:"
        - event: MergeReceipt
          prefix: "MERGE_RECEIPT:"
        - event: CIImportAttestation
          prefix: "CI_IMPORT_ATTESTATION:"
        - event: ProjectionReceipt
          prefix: "PROJECTION_RECEIPT:"
        - event: AATResultReused
          prefix: "AAT_RESULT_REUSED:"
      alternatives:
        - id: ALT-0001-A
          name: "HMAC-based event integrity"
          rejected_reason: "Symmetric keys cannot provide non-repudiation; verification requires shared secret"
        - id: ALT-0001-B
          name: "No domain separation (single signature scheme)"
          rejected_reason: "Enables cross-context signature replay attacks"
      rationale:
        - "Non-repudiation requires asymmetric signatures"
        - "Domain separation prevents signing a lease from being replayed as gate completion"
        - "Ed25519 is already used in the codebase (via ed25519-dalek)"
        - "Canonical serialization required before signing (JCS or sorted protobuf)"
      requirement_ids:
        - FAC-REQ-0017
      confidence: MEDIUM

    - id: DD-FAC-0002
      title: "Lease-Scoped Gate Authority with Strict Scope Fields"
      status: VALIDATED
      validation_evidence: |
        SA-1 EXPLORE analysis confirmed: Existing lease infrastructure in crates/apm2-core/src/lease/
        (state.rs:113-149, reducer.rs:1-85) provides extensible base. LeaseIssued proto already
        has registrar_signature field (proto:229-236). GateLease is clean extension with gate_id,
        changeset_digest, policy_hash as additional discriminated fields. Extension point EP-2
        uses existing LeaseReducer pattern.
      decision: |
        GateLease binds (work_id, gate_id, changeset_digest, executor_actor_id, expiry_ref, policy_hash).
        Leases are single-use with enforced HTF expiry. Child leases can only narrow scope (subset rule).
      lease_structure:
        fields:
          - lease_id
          - work_id
          - gate_id
          - changeset_digest
          - executor_actor_id
          - issued_at_observed
          - expires_at_observed
          - time_envelope_ref
          - policy_hash
          - issuer_actor_id
          - issuer_signature
        aat_extensions:
          - view_commitment_hash
          - rcp_manifest_hash
          - rcp_profile_id
          - selection_policy_id
        revocation:
          event_type: LeaseRevoked
          fields:
            - lease_id
            - revoked_by
            - revoked_at_observed
            - time_envelope_ref
            - reason
            - issuer_signature
          enforcement: "Admission rejects GateRunCompleted if a LeaseRevoked exists for lease_id with HTF time <= completion tick"
        ttl_policy:
          aat_default: "HTF window (TIME_TBD)"
          aat_high_risk: "HTF window (TIME_TBD)"
          other_gates: "HTF window (TIME_TBD)"
      alternatives:
        - id: ALT-0002-A
          name: "Ambient authority with post-hoc audit"
          rejected_reason: "Cannot prevent unauthorized execution; audit is detective not preventative"
      rationale:
        - "Explicit lease scoping prevents privilege escalation"
        - "Single-use prevents replay"
        - "Expiry bounds temporal authority"
        - "AAT-specific extensions bind to view commitment"
      requirement_ids:
        - FAC-REQ-0018
        - FAC-REQ-0010
      confidence: MEDIUM

    - id: DD-FAC-0003
      title: "OCAP Context Firewall with Manifest Allowlist"
      status: VALIDATED
      validation_evidence: |
        SA-2 EXPLORE analysis confirmed: Tool validation layer (crates/apm2-core/src/tool/validation.rs)
        provides clean extension point. Q-RFC-FAC-0002 resolved via ContextAwareValidator middleware
        (0.75 success probability, highest of 3 options). Extension point EP-3: Create manifest.rs
        and firewall.rs in crates/apm2-core/src/context/, extend PolicyEngine with manifest-aware
        rules. Avoids cousin abstraction by reusing PolicyEngine default-deny model.
      decision: |
        CONSUME-mode holons operate under mechanical context firewall. All repo.read and file.read
        operations must reference a manifest entry in the RCP allowlist. Denials are hard failures
        with ToolDecided=DENY. Context misses terminate the session and trigger refinement.
      firewall_rules:
        - rule_id: CTX-ALLOWLIST-001
          statement: "Reads must reference manifest entry (stable_id or path+hash)"
          enforcement: "ToolDecided=DENY if not allowlisted"
          severity: S1
        - rule_id: CTX-SUFFICIENCY-001
          statement: "RunReceipt records context sufficiency metrics"
          enforcement: "RunReceipt required for GateRunCompleted acceptance"
          severity: S2
        - rule_id: CTX-ZOOM-001
          statement: "Additional context only via ContextRefinementRequest"
          enforcement: "SessionTerminated rationale=CONTEXT_MISS; coordinator reissues after refined pack"
          severity: S1
        - rule_id: CTX-CONSUME-FATAL-001
          statement: "In CONSUME mode, reads outside pack are blocked (session-fatal)"
          enforcement: "SessionTerminated rationale=CONTEXT_MISS"
          severity: S1
      alternatives:
        - id: ALT-0003-A
          name: "Soft warnings with audit log"
          rejected_reason: "Does not prevent information leakage; warnings can be ignored"
      rationale:
        - "Prevents non-deterministic gate outcomes from context discovery"
        - "Forces systematic improvement of pack compilation"
        - "Aligns with LAW-02 (context sufficiency) and LAW-05 (OCAP)"
      requirement_ids:
        - FAC-REQ-0001
      confidence: MEDIUM

    - id: DD-FAC-0004
      title: "Projection-Only GitHub with Divergence Watchdog"
      status: VALIDATED
      validation_evidence: |
        SA-1 FINALIZE analysis (COUNCIL-RFC-0015-FINALIZE-20260129): Weighted score 3.55/5.0.
        Type theory: GitHub typed as WriteOnly<GitHubState>; admission has no Read capability.
        Divergence watchdog provides detection mechanism. F-SA3-004 remediation required:
        implement runtime policy or network-level blocking of api.github.com in admission path.
        Integration test for network isolation to be added.
      decision: |
        GitHub is a projection target, never a source of truth. Only HOLON-GITHUB-ADAPTER may
        write to GitHub. A divergence watchdog continuously compares external trunk HEAD to
        latest MergeReceipt result_selector, triggering InterventionFreeze on mismatch.
      projection_model:
        write_identity: HOLON-GITHUB-ADAPTER
        idempotence_key: "(work_id, changeset_digest, ledger_head)"
        poll_interval_htf_ticks: "TIME_TBD"
        on_divergence:
          - "Emit DefectRecord(PROJECTION_DIVERGENCE)"
          - "Emit InterventionFreeze(scope=repo)"
          - "Halt new FAC admissions for repo"
          - "Open AdjudicationRequested(EMERGENCY_RECOVERY)"
        on_tamper:
          - "Emit DefectRecord(PROJECTION_TAMPER)"
          - "Overwrite projection to match ledger truth"
      alternatives:
        - id: ALT-0004-A
          name: "GitHub status as admission input"
          rejected_reason: "Creates adversarial surface; external status can be spoofed"
      rationale:
        - "Single source of truth (ledger) prevents split-brain"
        - "Projection-only ensures external manipulation cannot affect admission"
        - "Divergence detection enables security response"
      requirement_ids:
        - FAC-REQ-0002
        - FAC-REQ-0019
      confidence: MEDIUM

    - id: DD-FAC-0005
      title: "Evidence-Backed CI Import with Attestation"
      status: VALIDATED
      validation_evidence: |
        SA-1 FINALIZE analysis (COUNCIL-RFC-0015-FINALIZE-20260129): Weighted score 4.00/5.0.
        CI conclusions typed as Observation requiring Evidence conversion via attestation.
        Fail-closed default (CI_EVENTS_ENABLED=false) prevents bypass. Q-RFC-FAC-0004
        deferred to Phase 2 with explicit attestation level definitions and minimums.
      decision: |
        CI conclusions are observations, not truth. READY_FOR_REVIEW transition requires:
        (1) webhook signature verified, (2) raw log/artifact digests imported into CAS,
        (3) adapter attestation signed and committed. Plain 'success' conclusion without
        evidence import is ignored (fail-closed).
        Attestation levels are explicit: L0 (status-only, insufficient), L1 (signed adapter
        attestation + CAS artifact digests), L2/L3 deferred. Policy maps risk tier to
        minimum CI attestation level; L0 is rejected when CI gating is enabled.
      attestation_levels:
        L0: "status-only (insufficient for readiness gating)"
        L1: "signed adapter attestation + raw artifact digests in CAS"
        L2: "replayable verifier proof (deferred)"
        L3: "measured boot/TPM-backed attestation (deferred)"
      attestation_fields:
        - workflow_run_id
        - downloaded_artifact_hashes
        - runner_image_digest (optional, L1+)
        - toolchain (optional, L1+)
        - command_transcript_hash (optional, L1+)
      feature_flags:
        - CI_EVENTS_ENABLED: "false by default (fail-closed)"
        - CI_GATED_QUEUE_ENABLED: "false by default"
      alternatives:
        - id: ALT-0005-A
          name: "CI status as authoritative signal"
          rejected_reason: "CI can be spoofed; no evidence backing"
      rationale:
        - "Treats CI as external observation requiring internal verification"
        - "Fail-closed prevents bypass via missing evidence"
        - "Attestation provides evidence chain for audit"
      requirement_ids:
        - FAC-REQ-0003
        - FAC-REQ-0118
      confidence: MEDIUM

    - id: DD-FAC-0006
      title: "Typed AAT GateReceipt Payloads"
      status: VALIDATED
      validation_evidence: |
        SA-1 FINALIZE analysis (COUNCIL-RFC-0015-FINALIZE-20260129): Weighted score 4.55/5.0.
        GateReceipt<AAT> is parameterized type with 17 required fields forming product type.
        Incomplete receipts are unrepresentable (type safety). TranscriptChunk reuse from
        CAC confirmed in EXPLORE phase. Terminal verifier binding (DD-FAC-0007) provides
        complementary evidence validation.
      decision: |
        AAT outcomes use typed GateReceipt payloads (gate_id=aat) with required fields for
        view commitment binding, determinism tracking, evidence binding, and attestation.
        No standalone AATReceipt event; AAT-specific payloads are stored in CAS and referenced
        by payload_hash from GateRunCompleted to preserve canonicalization stability.
        Terminal evidence digest is computed from machine-checkable PASS/FAIL outputs (exit code,
        structured test report counts, snapshot diff digest, invariant check outputs).
        Observational evidence digest covers logs/transcripts/timing/debug traces and is excluded
        from determinism equality.
      required_fields:
        - view_commitment_hash
        - rcp_manifest_hash
        - rcp_profile_id
        - policy_hash
        - determinism_class
        - determinism_status
        - outcome_class (flake_class field)
        - run_count
        - run_receipt_hashes
        - terminal_evidence_digest
        - observational_evidence_digest
        - terminal_verifier_outputs_digest
        - stability_digest
        - verdict
        - transcript_chain_root_hash
        - transcript_bundle_hash
        - artifact_manifest_hash
        - terminal_verifier_outputs
        - verifier_policy_hash
        - selection_policy_id
        - risk_tier
        - attestation
      phase_notes:
        phase_1: "Record determinism metadata (run_count, run_receipt_hashes, terminal_evidence_digest, terminal_verifier_outputs_digest, stability_digest) without enforcing N-run rejection."
        phase_2: "Enable determinism envelope enforcement; nondeterminism fails closed per FAC-REQ-0005."
      alternatives:
        - id: ALT-0006-A
          name: "Separate AATReceipt event type"
          rejected_reason: "Creates parallel receipt paths; complicates admission logic"
      rationale:
        - "Single GateReceipt with typed payload keeps admission logic unified"
        - "Required fields prevent spoofed PASS"
        - "Evidence binding enables independent verification"
        - "Terminal/observational evidence split avoids false nondeterminism"
      requirement_ids:
        - FAC-REQ-0004
        - FAC-REQ-0006
      confidence: MEDIUM

    - id: DD-FAC-0007
      title: "Terminal Verifier Binding for AAT"
      status: VALIDATED
      validation_evidence: |
        SA-1 FINALIZE analysis (COUNCIL-RFC-0015-FINALIZE-20260129): Weighted score 3.55/5.0.
        VerifierPolicy defines type signature: scenario_type -> (verifier_kinds, outputs, predicate).
        Machine predicates are deterministic first-order formulas. Addresses Goodhart drift by
        anchoring to ground truth (exit codes, snapshot diffs). TerminalVerifier trait and
        VerifierPolicy schema are specified in RFC-0015 contracts (FAC-CONTRACT-007).
      decision: |
        AAT PASS requires terminal verifier outputs satisfying machine-defined predicates.
        Policy defines scenario_type -> allowed_verifier_kinds + required_outputs + machine_predicate.
        Narrative is non-authoritative.
      allowed_verifier_kinds:
        - exit_code
        - snapshot_diff
        - structured_test_report
        - invariant_check
      verifier_policy_spec:
        contract_ref: "FAC-CONTRACT-007"
        required_fields:
          - policy_id
          - policy_hash
          - schema_version
          - scenario_type
          - allowed_verifier_kinds
          - required_outputs
          - machine_predicate
          - predicate_lang
      terminal_verifier_trait:
        language: Rust
        signature: |
          trait TerminalVerifier {
            fn kind(&self) -> VerifierKind;
            fn evaluate(&self, output: &VerifierOutput, policy: &VerifierPolicy) -> VerifierVerdict;
          }
      predicate_language:
        id: FAC-PREDICATE-V1
        allowed_ops: ["==", "!=", "<", "<=", ">", ">=", "AND", "OR", "NOT"]
        allowed_value_types: ["int", "bool", "string"]
        reference_rule: "Predicate evaluation is pure and deterministic over verifier outputs"
      enforcement: |
        PASS requires predicate satisfied and required outputs present.
        Missing outputs => FAIL or NEEDS_INPUT (policy-defined).
        verifier_policy_hash MUST be in resolved_verifier_policy_hashes pinned at FAC-00.
      alternatives:
        - id: ALT-0007-A
          name: "Narrative-based acceptance"
          rejected_reason: "LLM narratives can be manipulated; no machine verification"
      rationale:
        - "Terminal verifiers provide ground truth"
        - "Prevents Goodhart drift toward non-terminal signals"
        - "Machine predicates are deterministic"
      requirement_ids:
        - FAC-REQ-0007
      confidence: MEDIUM

    - id: DD-FAC-0008
      title: "Risk-Tiered AAT Selection Policy"
      status: VALIDATED
      validation_evidence: |
        SA-1 FINALIZE analysis (COUNCIL-RFC-0015-FINALIZE-20260129): Weighted score 3.55/5.0.
        RiskTier enumerated type with classification model defined (Q-RFC-FAC-0007 resolved).
        Primary signals: module criticality (auth/crypto/ledger/tool/kernel), sensitive patterns.
        Secondary signals: diff scope, dependency fanout, coverage delta. Classification function
        maps changeset attributes to tier. Escape metrics track tier assignment effectiveness.
      decision: |
        AAT selection is risk-tiered: HIGH always requires AAT, MED requires AAT for sensitive
        domains, LOW is sampled with nightly full AAT. Risk tier and selection_policy_id
        recorded in GateReceipt.
      tiers:
        HIGH:
          aat_required: always
          selection: "All AAT scenarios for impacted modules"
        MED:
          aat_required: conditional
          selection: "Required for auth/crypto/ledger/tool mediation; sampled otherwise"
        LOW:
          aat_required: sampled
          selection: "1 in N sampling + nightly full AAT on main"
      alternatives:
        - id: ALT-0008-A
          name: "AAT required for all changes"
          rejected_reason: "Throughput collapse; merge cadence unacceptable"
        - id: ALT-0008-B
          name: "AAT optional everywhere"
          rejected_reason: "High-risk changes escape verification"
      rationale:
        - "Preserves merge cadence while protecting high-risk changes"
        - "Risk tier based on diff impact and module criticality"
        - "Nightly full AAT catches sampling gaps"
      requirement_ids:
        - FAC-REQ-0009
      confidence: MEDIUM

    - id: DD-FAC-0009
      title: "AAT Anti-Downgrade Enforcement"
      status: VALIDATED
      validation_evidence: |
        SA-1 FINALIZE analysis (COUNCIL-RFC-0015-FINALIZE-20260129): Weighted score 5.00/5.0.
        Anti-downgrade implements monotonicity constraint: receipt values >= resolved values.
        Pinning at FAC-00 ingestion creates immutable baseline. Direct analogy to TLS downgrade
        prevention (SCSV). Waiver path via AdjudicationRequested provides controlled escape.
        Design complete with no pending conditions. Highest-scoring decision in evaluation.
      decision: |
        Policy resolution is pinned at FAC-00 ingestion. Admission rejects AAT receipts
        where risk_tier, determinism_class, verifier_policy_hash, or rcp_profile_id are
        lower than or not included in resolved values. Downgrades require explicit waiver.
      pinned_at_ingest:
        - resolved_policy_hash
        - resolved_risk_tier
        - resolved_determinism_class
        - resolved_verifier_policy_hashes
        - resolved_rcp_profile_ids
        - resolved_rcp_manifest_hashes
      enforcement:
        - "policy_hash MUST equal resolved_policy_hash"
        - "risk_tier MUST NOT be lower than resolved_risk_tier"
        - "verifier_policy_hash MUST be in resolved_verifier_policy_hashes"
        - "rcp_profile_id MUST be in resolved_rcp_profile_ids and rcp_aat_manifest_hash MUST match resolved_rcp_manifest_hashes"
        - "Downgrades require AdjudicationRequested(WAIVER)"
      alternatives:
        - id: ALT-0009-A
          name: "Dynamic policy selection"
          rejected_reason: "Enables 'easier exam' attacks via policy substitution"
      rationale:
        - "Prevents silent policy weakening"
        - "Waiver provides auditable override path"
        - "Pinning at ingest creates immutable baseline"
      requirement_ids:
        - FAC-REQ-0012
      confidence: MEDIUM

    - id: DD-FAC-0010
      title: "KeyPolicy Artifact for COI and Custody Domains"
      status: VALIDATED
      validation_evidence: |
        SA-1 FINALIZE analysis (COUNCIL-RFC-0015-FINALIZE-20260129) requires formal COI
        grouping to make TB-0007 mechanically enforceable. KeyPolicy schema is specified
        in FAC-CONTRACT-008 and enforced at lease issuance and admission.
      decision: |
        Define a KeyPolicy artifact under CAC governance that maps keys to custody domains
        and COI groups. Lease issuance MUST validate executor custody domain against the
        changeset author; AAT executor keys MUST be in a distinct custody domain from
        coordinator and implementer roles.
      keypolicy_spec:
        contract_ref: "FAC-CONTRACT-008"
        required_fields:
          - policy_id
          - policy_hash
          - schema_version
          - custody_domains
          - coi_rules
          - delegation_rules
      enforcement:
        - "executor_key.coi_group_id MUST NOT equal author.coi_group_id"
        - "AAT executor custody domain MUST be disjoint from coordinator/implementer domains"
        - "KeyPolicy changes require dual-control (SEC-CTRL-FAC-0009)"
      requirement_ids:
        - FAC-REQ-0010
      confidence: MEDIUM

    - id: DD-FAC-0011
      title: "AAT Flake Classification and Policy Routing"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0008 defines determinism_class, determinism_status, and outcome_class routing.
        Q-RFC-FAC-0006 defines classification for mismatch scenarios.
      decision: |
        AAT GateReceipts MUST record determinism_class, determinism_status (STABLE|MISMATCH),
        and outcome_class (flake_class field). outcome_class routing:
        HARNESS_FLAKE -> runner pool quarantine, ENVIRONMENT_DRIFT -> attestation invalidation,
        TEST_NONSEMANTIC/CODE_NONSEMANTIC -> spec quarantine, UNKNOWN -> NEEDS_INPUT.
        Deterministic FAIL is verdict=FAIL with determinism_status=STABLE and
        outcome_class=DETERMINISTIC_FAIL. No retries may convert UNKNOWN to PASS.
      phase_notes:
        phase_1: "Record determinism_status and outcome_class (flake_class field) in receipt payloads."
        phase_2: "Enforce quarantine routing and audit metrics."
      requirement_ids:
        - FAC-REQ-0008
      confidence: MEDIUM

    - id: DD-FAC-0012
      title: "Invariant-First AAT Specifications"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0011 requires invariants-first specs with machine-checkable outcomes.
      decision: |
        AAT specs MUST declare invariants; procedural steps are observational only.
        Invariants are expressed in machine-checkable form (exit codes, structured reports).
      requirement_ids:
        - FAC-REQ-0011
      confidence: MEDIUM

    - id: DD-FAC-0013
      title: "AAT Reuse Safety and Provenance"
      status: VALIDATED
      validation_evidence: |
        Q-RFC-FAC-0009 resolution defines LOW-only reuse and provenance tuple enforcement.
      decision: |
        AAT reuse is provenance-bound and replay-safe. LOW tier reuse requires exact
        provenance tuple match; MED requires waiver; HIGH never reuses.
      requirement_ids:
        - FAC-REQ-0013
      confidence: MEDIUM

    - id: DD-FAC-0014
      title: "AAT Evidence Hygiene and Retention"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0014 requires classification/redaction/retention metadata.
      decision: |
        Evidence artifacts MUST include data classification, redaction metadata, and
        retention window (HTF). Admission rejects evidence policy violations.
      requirement_ids:
        - FAC-REQ-0014
      confidence: MEDIUM

    - id: DD-FAC-0015
      title: "AAT Quorum and Audit Enforcement"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0015 defines independent verification by risk tier.
      decision: |
        HIGH tier requires two independent AAT receipts from disjoint runner pools.
        MED tier requires audit re-runs before admission finalizes.
      phase_notes:
        phase_2: "Enforcement enabled with holdout/audit infrastructure."
      requirement_ids:
        - FAC-REQ-0015
      confidence: MEDIUM

    - id: DD-FAC-0016
      title: "AAT Harness Sandboxing and Egress Control"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0016 mandates sandboxing and deny-by-default egress.
      decision: |
        AAT harnesses run in strict sandbox with deny-by-default egress. Only policy-declared
        network access is allowed and recorded in receipts; host mounts are limited to pinned snapshot.
      requirement_ids:
        - FAC-REQ-0016
      confidence: MEDIUM

    - id: DD-FAC-0017
      title: "Atomic Merge Receipt"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0020 defines MergeReceipt binding inputs to observed trunk result.
      decision: |
        MergeReceipt is emitted only after result_selector is observed. Receipt binds
        (base_selector, changeset_digest, gate_receipts, policy_hash) -> result_selector
        and is signed with MERGE_RECEIPT domain separator.
      requirement_ids:
        - FAC-REQ-0020
      confidence: MEDIUM

    - id: DD-FAC-0018
      title: "Bounded Retries and Echo-Trap Detection"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0021 requires bounded attempts and echo-trap termination.
      decision: |
        Coordinator enforces per-gate max attempts and global max episodes. Echo-trap
        detection triggers REASONING_DEGENERATION termination and defect emission.
      requirement_ids:
        - FAC-REQ-0021
      confidence: MEDIUM

    - id: DD-FAC-0019
      title: "Policy Resolution Anchor Event"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0116 defines PolicyResolvedForChangeSet and admission enforcement.
      decision: |
        Emit PolicyResolvedForChangeSet before any lease issuance for the changeset.
        Admission and lease issuance MUST verify resolved policy tuple match; downgrades
        require explicit waiver with separate authority.
      requirement_ids:
        - FAC-REQ-0116
      confidence: MEDIUM

    - id: DD-FAC-0020
      title: "GateReceipt Versioning and Canonicalization"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0119 requires receipt versioning and canonicalization rules.
      decision: |
        GateReceipt envelopes carry receipt_version, payload_kind, payload_schema_version,
        payload_hash, and evidence_bundle_hash. Admission rejects unknown versions in
        enforce mode; canonicalization is deterministic with no maps and stable ordering.
      requirement_ids:
        - FAC-REQ-0119
      confidence: MEDIUM

    - id: DD-FAC-0021
      title: "Quarantine Events and Projection"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0117 defines quarantine events and projection-based routing.
      decision: |
        RunnerPoolQuarantined and AATSpecQuarantined events update a QuarantineProjection.
        Selection excludes quarantined targets; quarantine windows use HTF time envelopes
        (TIME_TBD). Work transitions do not model quarantine state.
      requirement_ids:
        - FAC-REQ-0117
      confidence: MEDIUM

    - id: DD-FAC-0022
      title: "CI Attestation Levels"
      status: VALIDATED
      validation_evidence: |
        PRD-0009 FAC-REQ-0118 defines L0-L3 levels and minimum enforcement.
      decision: |
        Define CI attestation levels: L0 (status-only, insufficient), L1 (signed adapter
        attestation + CAS artifact digests), L2/L3 deferred. Policy maps risk tier to
        minimum level; READY_FOR_REVIEW enforces the mapping.
      requirement_ids:
        - FAC-REQ-0118
      confidence: MEDIUM

  component_mapping:
    # Confidence upgraded from LOW to MEDIUM after EXPLORE phase grounding

    - requirement_id: FAC-REQ-0001
      verified_components:
        - path: "crates/apm2-core/src/tool/validation.rs"
          status: REUSE
          changes: "Extend with ContextAwareValidator trait (EP-3)"
        - path: "crates/apm2-core/src/policy/engine.rs"
          status: REUSE
          changes: "Add manifest-aware rule evaluation"
      new_components:
        - path: "crates/apm2-core/src/context/manifest.rs"
          status: NEW
          purpose: "ContextPackManifest for allowlist checking"
        - path: "crates/apm2-core/src/context/firewall.rs"
          status: NEW
          purpose: "Firewall integration with PolicyEngine"
      confidence: MEDIUM
      explore_evidence: "SA-2 Option C analysis; Q-RFC-FAC-0002 resolved"

    - requirement_id: FAC-REQ-0002
      verified_components: []
      new_components:
        - path: "crates/apm2-daemon/src/projection/divergence_watchdog.rs"
          status: NEW
          purpose: "Poll-based divergence detection (30s interval)"
        - path: "crates/apm2-daemon/src/projection/github_sync.rs"
          status: NEW
          purpose: "Idempotent ledger -> GitHub projection"
      confidence: MEDIUM
      explore_evidence: "SA-3 EP-7 analysis; no cousin risk with adapter pattern"

    - requirement_id: FAC-REQ-0017
      verified_components:
        - path: "crates/apm2-core/src/crypto/sign.rs"
          status: REUSE
          changes: "Use existing Ed25519 Signer with domain prefix wrapper"
        - path: "crates/apm2-core/src/events/canonical.rs"
          status: REUSE
          changes: "Add Canonicalize impls for new event types"
      new_components:
        - path: "crates/apm2-core/src/fac/domain_separator.rs"
          status: NEW
          purpose: "Domain separator constants and sign_with_domain helper"
        - path: "crates/apm2-core/src/evidence/receipt.rs"
          status: EXTEND
          purpose: "GateRunCompleted, MergeReceipt with typed payloads"
      confidence: HIGH
      explore_evidence: "SA-1 analysis: 95% reusability; evidence at sign.rs:36-114"

    - requirement_id: FAC-REQ-0018
      verified_components:
        - path: "crates/apm2-core/src/lease/state.rs"
          status: REUSE
          changes: "Extend Lease struct or create GateLease discriminated variant"
        - path: "crates/apm2-core/src/lease/reducer.rs"
          status: REUSE
          changes: "Handle GateLeaseIssued events"
      new_components:
        - path: "proto/kernel_events.proto"
          status: EXTEND
          purpose: "Add GateLease and LeaseRevoked to LeaseEvent oneof"
      confidence: HIGH
      explore_evidence: "SA-1 analysis: 90% feasibility; Q-RFC-FAC-0001 resolved"

    - requirement_id: FAC-REQ-0010
      verified_components:
        - path: "crates/apm2-core/src/lease/reducer.rs"
          status: REUSE
          changes: "Validate custody domains and lease bindings at issuance"
      new_components:
        - path: "crates/apm2-core/src/crypto/policy.rs"
          status: NEW
          purpose: "KeyPolicy artifact parsing and custody domain validation"
      confidence: MEDIUM
      explore_evidence: "Q-RFC-FAC-0003 resolved; KeyPolicy schema specified in FAC-CONTRACT-008"

    - requirement_id: FAC-REQ-0019
      verified_components: []
      new_components:
        - path: "crates/apm2-daemon/src/projection/"
          status: NEW
          purpose: "Projection-only GitHub integration"
      confidence: LOW

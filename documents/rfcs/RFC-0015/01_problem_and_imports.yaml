rfc_problem_and_imports:
  schema_version: "2026-01-29"

  problem_statement:
    primary: |
      FAC is the internal, cryptographically enforced admission protocol. Reviewers/verifiers
      sign lease-bound outcomes. Merges are proven by MergeReceipts. GitHub is a projection.
      APM2 CLI runs the PR inner loop as a hardened protocol: admission is impossible to spoof,
      and every decision is replayable from ledger+CAS under strict OCAP.

    current_state:
      admission_implementation:
        - "Agents can currently manipulate external status checks and bypass intended scrutiny"
        - "GitHub is treated as a source of truth for admission decisions, creating an adversarial surface"
        - "Gate outcomes are not cryptographically bound to changesets or executors"
        - "No mechanical enforcement of context boundaries during gate execution"
        - "Projection divergence between ledger and external forge is not detected or handled"
        - "CI evidence is accepted as truth rather than imported as observations requiring internal verification"
      existing_primitives:
        - "Signed, hash-chained ledger (PRD-0004)"
        - "Content-addressed store (CAS)"
        - "Holonic execution with explicit leases and budgets"
        - "Gate events (PRD-0004 Work Substrate)"
        - "ContextPacks and hermetic consumption (PRD-0007 CAC)"

    why_now:
      - "Agents currently can spoof external statuses and bypass intended scrutiny"
      - "FAC closes the loop with internal authority minting, OCAP containment, and projection-only forges"
      - "The existing kernel primitives (ledger, CAS, holonic execution) and CAC infrastructure provide the foundation"
      - "Admission must be impossible to spoof for production-grade agent autonomy"

  failure_modes:
    - id: FM-0001
      name: "Status spoofing via external forge manipulation"
      mechanism: "Autonomous agents manipulate GitHub status checks directly to bypass gate scrutiny"
      impact: "Unapproved changes reach trunk without proper review"
      solution: |
        Gate outcomes are cryptographically signed by authorized executors under lease-bound authority.
        Status checks are projections of internal truth, not inputs to admission decisions.

    - id: FM-0002
      name: "Gate outcome forgery via unsigned events"
      mechanism: "Gate outcomes recorded without cryptographic binding to executor identity or changeset"
      impact: "Outcomes can be replayed or modified; executor accountability is unprovable"
      solution: |
        GateRunCompleted signed with Ed25519 using domain-separated signatures. Signature binds
        the outcome to executor identity and changeset_digest. Lease validity verified at admission.

    - id: FM-0003
      name: "Context leakage during gate execution"
      mechanism: "Gate executors perform discretionary reads outside their assigned context pack"
      impact: "Non-deterministic gate outcomes; information leakage across security boundaries"
      solution: |
        OCAP context firewall enforced mechanically. Repo/file reads allowed only for objects
        explicitly enumerated in RCP manifest allowlist. Context misses terminate session with
        CONTEXT_MISS and trigger refinement.

    - id: FM-0004
      name: "Projection divergence without detection"
      mechanism: "External trunk state diverges from internal MergeReceipt truth without detection"
      impact: "Ledger and external forge in inconsistent states; subsequent admissions based on stale assumptions"
      solution: |
        Divergence watchdog continuously compares external trunk HEAD to latest MergeReceipt
        result_selector. On divergence, PROJECTION_DIVERGENCE defect emitted and InterventionFreeze
        halts admissions until reconciliation.

    - id: FM-0005
      name: "CI conclusions accepted as admission truth"
      mechanism: "CI success/failure conclusions treated as authoritative signals without evidence verification"
      impact: "CI spoofing enables admission bypass; no attestation of actual test execution"
      solution: |
        CI conclusions treated as observations. READY_FOR_REVIEW requires webhook signature verified,
        raw log/artifact digests imported into CAS, and adapter attestation signed. Plain 'success'
        conclusion without evidence import is ignored (fail-closed).

  imported_requirements:
    - prd_requirement_id: REQ-0001
      rfc_local_id: FAC-REQ-0001
      title: "Mechanical Context Firewall"
      statement: |
        apm2-daemon MUST deny any read outside ContextPack allowlist for CONSUME-mode holons;
        context misses MUST terminate and trigger refinement.
      acceptance_criteria:
        - "Denied reads emit ToolDecided=DENY with rule_id CTX-ALLOWLIST-001"
        - "SessionTerminated rationale=CONTEXT_MISS when required context absent"
        - "Context refinement triggered after CONTEXT_MISS termination"
        - "RunReceipt records context sufficiency metrics"
        - "Excessive zoom/refinement requests emit ECHO_TRAP and escalate"

    - prd_requirement_id: REQ-0002
      rfc_local_id: FAC-REQ-0002
      title: "Projection Divergence Emergency Stop"
      statement: |
        If external trunk HEAD differs from latest MergeReceipt result_selector, emit
        PROJECTION_DIVERGENCE defect and InterventionFreeze halting admissions.
      acceptance_criteria:
        - "Divergence watchdog compares external trunk HEAD to MergeReceipt result_selector every 30 seconds"
        - "On divergence, PROJECTION_DIVERGENCE defect emitted and InterventionFreeze(repo) halts admissions"
        - "Unfreeze requires AdjudicationResolved(EMERGENCY_RECOVERY) or emergency override ceremony"
        - "Zero admissions proceed during divergence freeze"

    - prd_requirement_id: REQ-0003
      rfc_local_id: FAC-REQ-0003
      title: "CI evidence-backed readiness gating"
      statement: |
        READY_FOR_REVIEW transition requires webhook signature verified, raw log/artifact digests
        imported into CAS, and adapter attestation signed and committed when CI gating is enabled.
      acceptance_criteria:
        - "No transition based only on CI 'success' conclusion (fail-closed)"
        - "READY_FOR_REVIEW requires webhook signature verified, raw log/artifact digests in CAS, signed adapter attestation"
        - "EvidencePublished entries exist for CI logs/artifacts and are referenced from transition rationale"
        - "CI_EVIDENCE_MISSING defect emitted if evidence import bypassed"

    - prd_requirement_id: REQ-0004
      rfc_local_id: FAC-REQ-0004
      title: "Typed GateReceipt payloads for AAT"
      statement: |
        AAT outcomes are recorded as typed GateReceipt payloads bound to view commitments with
        determinism_class, run_receipt_hashes, run_count, and stability_digest.
      acceptance_criteria:
        - "AAT GateReceipt payload includes view_commitment_hash and determinism_class"
        - "AAT GateReceipt payload includes run_receipt_hashes and run_count binding all runs"
        - "Admission rejects AAT GateReceipts missing required typed payload fields"

    - prd_requirement_id: REQ-0005
      rfc_local_id: FAC-REQ-0005
      title: "Gate outcome determinism envelope"
      statement: |
        Deterministic gates must prove stability under coordinator-managed N-run validation;
        nondeterminism emits GATE_NONDETERMINISTIC and triggers quarantine/abort per policy.
      acceptance_criteria:
        - "Determinism envelope enforces N identical runs for gates with determinism_class > 0"
        - "Nondeterminism emits GATE_NONDETERMINISTIC defect and fails closed"
        - "Repeated nondeterminism quarantines and aborts changesets per policy"
        - "Phase 1 records determinism metadata; enforcement enabled in Phase 2 via FAC_DETERMINISM_ENVELOPE_ENABLED"

    - prd_requirement_id: REQ-0006
      rfc_local_id: FAC-REQ-0006
      title: "Evidence-bound AAT GateReceipt"
      statement: |
        AAT GateReceipts bind raw evidence digests, transcript chains, and attestation fields
        for independent verification.
      acceptance_criteria:
        - "AAT GateReceipt payload includes transcript_chain_root_hash and transcript_bundle_hash"
        - "AAT GateReceipt payload includes artifact_digests for logs, reports, snapshots, binaries"
        - "AAT GateReceipt payload includes attestation fields (container_image_digest, toolchain_digests, runner_identity_key_id, network_policy_profile_hash)"
        - "Admission rejects AAT receipts missing any required evidence bindings"

    - prd_requirement_id: REQ-0007
      rfc_local_id: FAC-REQ-0007
      title: "Terminal verifier binding for AAT"
      statement: |
        PASS requires machine-defined verifier outputs and predicates; missing verifier outputs
        force FAIL or NEEDS_INPUT.
      acceptance_criteria:
        - "AAT policy defines scenario_type -> allowed_verifier_kinds + required_outputs + machine_predicate"
        - "GateReceipt payload includes terminal_verifier_outputs and verifier_policy_hash"
        - "Admission rejects AAT PASS when required verifier outputs missing or predicate not satisfied"

    - prd_requirement_id: REQ-0008
      rfc_local_id: FAC-REQ-0008
      title: "AAT flake classification and policy routing"
      statement: |
        Failures are classified and routed by policy to prevent throughput collapse; UNKNOWN
        failures never PASS via retries.
      acceptance_criteria:
        - "GateReceipt payload records determinism_class and flake_class for AAT runs"
        - "UNKNOWN failures never PASS via retries; NEEDS_INPUT required"
        - "HARNESS_FLAKE quarantines runner pool; TEST_NONSEMANTIC quarantines test spec"

    - prd_requirement_id: REQ-0009
      rfc_local_id: FAC-REQ-0009
      title: "Risk-tiered AAT selection policy"
      statement: |
        Diff-aware AAT gating preserves throughput while protecting high-risk changes with
        mandatory AAT and risk tier enforcement.
      acceptance_criteria:
        - "Risk tier (HIGH/MED/LOW) and selection_policy_id recorded in GateReceipt payload"
        - "HIGH tier always requires AAT; MED/LOW sampled by policy with nightly full AAT on main"
        - "Admission verifies selection_policy_id and risk_tier against policy_hash"

    - prd_requirement_id: REQ-0010
      rfc_local_id: FAC-REQ-0010
      title: "AAT lease binding and executor isolation"
      statement: |
        AAT GateLease scope binds view_commitment_hash, rcp_aat_manifest_hash, and selection_policy_id;
        AAT executor keys must be in a distinct custody domain from coordinator/implementer.
      acceptance_criteria:
        - "For gate_id=aat, GateLease scope binds view_commitment_hash, rcp_aat_manifest_hash, rcp_profile_id, selection_policy_id"
        - "GateRunCompleted for gate_id=aat MUST match view_commitment_hash and rcp_manifest_hash from lease"
        - "AAT executor keys must not share custody domains with coordinator or implementer roles"

    - prd_requirement_id: REQ-0011
      rfc_local_id: FAC-REQ-0011
      title: "Invariant-first AAT specifications"
      statement: |
        Acceptance tests assert invariants, not brittle step scripts; steps are observational only.
      acceptance_criteria:
        - "AAT specs require invariant declarations; steps are observational only"
        - "Invariants expressed in machine-checkable form (exit codes, structured reports, invariant checks)"

    - prd_requirement_id: REQ-0012
      rfc_local_id: FAC-REQ-0012
      title: "AAT anti-downgrade invariant"
      statement: |
        AAT policy resolution cannot be silently weakened; resolved risk_tier, determinism_class,
        verifier_policy_hash, and rcp_profile_id are pinned at FAC start.
      acceptance_criteria:
        - "Resolved risk_tier, determinism_class, verifier_policy_hash, rcp_profile_id pinned at FAC start"
        - "Admission rejects AAT receipts with policy_hash mismatch or lowered tiers"
        - "Downgrades require explicit waiver with separate authority and projection visibility"

    - prd_requirement_id: REQ-0013
      rfc_local_id: FAC-REQ-0013
      title: "AAT reuse safety and provenance"
      statement: |
        Reuse is provenance-bound and replay-safe; reuse rejected on any provenance mismatch.
      acceptance_criteria:
        - "AAT reuse emits AATResultReused with full provenance tuple"
        - "AAT reuse rejected on any provenance mismatch"

    - prd_requirement_id: REQ-0014
      rfc_local_id: FAC-REQ-0014
      title: "AAT evidence hygiene and retention"
      statement: |
        Evidence artifacts are classified, redacted, and retention-bounded; policy violations
        are admission-blocking.
      acceptance_criteria:
        - "Evidence artifacts include data_classification, redaction metadata, retention_ttl"
        - "Admission rejects evidence policy violations"

    - prd_requirement_id: REQ-0015
      rfc_local_id: FAC-REQ-0015
      title: "AAT quorum/audit enforcement by risk tier"
      statement: |
        High-risk AAT results require independent verification; quorum and audit enforcement
        based on risk tier.
      acceptance_criteria:
        - "HIGH tier requires two independent receipts from disjoint runner pools"
        - "MED tier uses audit re-runs before admission finalizes"

    - prd_requirement_id: REQ-0016
      rfc_local_id: FAC-REQ-0016
      title: "AAT harness sandboxing and egress control"
      statement: |
        AAT executes in a strict sandbox with deny-by-default egress; no host mounts beyond
        pinned snapshot.
      acceptance_criteria:
        - "No host mounts beyond pinned snapshot"
        - "Network egress is policy-declared and recorded in receipts"

  additional_requirements:
    - id: FAC-REQ-0017
      title: "Cryptographically signed gate outcomes"
      statement: |
        All GateRunCompleted events MUST be signed with Ed25519 using domain-separated signatures
        binding executor, lease, and changeset.
      acceptance_criteria:
        - "GateRunCompleted events include Ed25519 signature over canonical bytes with domain separator GATE_RUN_COMPLETED"
        - "Signature binds (gate_id, lease_id, changeset_digest, executor_actor_id, evidence_bundle_hash)"
        - "Unsigned or invalid signatures rejected with INVALID_SIGNATURE defect at admission"
        - "100% of gate outcomes are cryptographically verifiable from ledger"
      law_refs:
        - LAW-01
        - LAW-15

    - id: FAC-REQ-0018
      title: "Lease-bound gate authority"
      statement: |
        Gate executors operate under lease-scoped authority that cannot be broadened and expires.
      acceptance_criteria:
        - "GateLease scope is strict with fields (work_id, gate_id, changeset_digest, executor_actor_id, expiry, policy_hash)"
        - "Lease issuance committed before session spawn (CAS-at-commit ordering)"
        - "Child leases can only narrow scope (subset rule enforced)"
        - "Expired or scope-mismatched leases rejected with LEASE_SCOPE_BROADENED or UNAUTHORIZED_EXECUTOR"
      law_refs:
        - LAW-05

    - id: FAC-REQ-0019
      title: "Projection-only GitHub integration"
      statement: |
        GitHub status checks are projections of internal ledger truth and never inputs to
        admission decisions.
      acceptance_criteria:
        - "Admission reads only internal projections; never reads GitHub status as truth"
        - "Only HOLON-GITHUB-ADAPTER may write GitHub checks/status/labels/comments (enforced by policy)"
        - "Projection is idempotent and keyed by (work_id, changeset_digest, ledger_head) fingerprint"
        - "External status manipulation does not affect admission decisions"
      law_refs:
        - LAW-03

    - id: FAC-REQ-0020
      title: "Atomic merge with receipt"
      statement: |
        Merges produce MergeReceipt binding inputs to result after observing trunk update.
      acceptance_criteria:
        - "MergeReceipt binds (base_selector, changeset_digest, gate_receipts, policy_hash) -> result_selector"
        - "MergeReceipt emitted only after result_selector (trunk digest) is observed and recorded"
        - "Receipt is signed with domain separator MERGE_RECEIPT"
        - "100% of successful admissions have corresponding verifiable MergeReceipt"
      law_refs:
        - LAW-01
        - LAW-10

    - id: FAC-REQ-0021
      title: "Bounded retries and echo-trap detection"
      statement: |
        Coordinator enforces bounded attempts and detects reasoning degeneration.
      acceptance_criteria:
        - "Per-gate max attempts of 3 enforced"
        - "Global max episodes of 50 enforced"
        - "Echo-trap detected when FindingSignature repeats 3 times without delta within single GateRun"
        - "On echo-trap, session terminated with rationale REASONING_DEGENERATION and DefectRecord(ECHO_TRAP) emitted"
        - "Oracle escalation triggered for unresolved loops"
      law_refs:
        - LAW-12

  inherited_from_prds:
    - prd_id: PRD-0004
      requirements:
        - id: REQ-0009
          title: "Signed GateRunCompleted"
          rationale: "FAC relies on cryptographically signed gate outcomes for admission decisions"
        - id: REQ-0015
          title: "GitHub sync adapter projects ledger state"
          rationale: "FAC projection model requires adapter-only writes to GitHub"
        - id: REQ-0025
          title: "Critical Event Signing"
          rationale: "FAC admission authority requires signed events with chain-of-custody"
    - prd_id: PRD-0007
      requirements:
        - id: REQ-0001
          title: "ContextPack manifest"
          rationale: "FAC context firewall operates on ContextPack allowlists"
        - id: REQ-0003
          title: "Hermetic consumption"
          rationale: "FAC gate execution requires hermetic context"

  non_goals:
    - id: NG-0001
      statement: "Building a universal CI integration framework"
      clarification: |
        FAC imports CI evidence from specific supported providers (GitHub Actions initially).
        Universal CI integration is out of scope; each provider requires explicit adapter support.

    - id: NG-0002
      statement: "Replacing existing kernel Protobuf schemas for gate events"
      clarification: |
        FAC does not replace existing kernel schemas; placement of new Gate/Projection/
        Intervention payloads remains an open design decision (see Q-FAC-0001).

    - id: NG-0003
      statement: "Automated divergence resolution without human adjudication"
      clarification: |
        Divergence triggers freeze and requires explicit adjudication or emergency override.
        Automated resolution risks data loss and is out of scope.

    - id: NG-0004
      statement: "Full Goodhart resistance in Phase 1"
      clarification: |
        Holdout suites and evaluator audits are Phase 2 deliverables.
        Phase 1 focuses on core admission hardening without measurement integrity.

    - id: NG-0005
      statement: "Cross-provider prompt equivalence guarantees"
      clarification: |
        Provider routing is classification-aware but prompt equivalence across providers
        is an open issue. Phase 1 uses deterministic routing profiles per stage.

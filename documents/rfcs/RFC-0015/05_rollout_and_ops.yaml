rfc_rollout_and_ops:
  schema_version: "2026-01-29"

  rollout_strategy:
    overview: |
      FAC rollout follows a phased approach with graduated strictness and feature flags.
      Phase 1 focuses on core admission hardening; Phase 2 adds measurement integrity;
      Phase 3 enables autonomous improvement. Context firewall adoption uses a multi-phase
      graduated rollout to allow pack completeness improvements (HTF windows; TIME_TBD).

    phases:
      - phase_id: PHASE-1
        name: "FAC Core Hardening"
        duration: "Target Q1 2026"
        deliverables:
          - "GateLeaseIssued, GateRunStarted, GateRunCompleted events with mandatory signature verification"
          - "OCAP context firewall enforced for CONSUME holons"
          - "GitHub adapter projection-only; status setters denied by policy"
          - "Projection divergence watchdog + freeze/unfreeze path"
          - "Typed GateReceipt payloads for AAT bound to view commitments"
          - "AAT evidence bindings validated at admission"
          - "Terminal verifier binding schema enforced"
          - "Risk-tiered AAT selection policy"
          - "Anti-downgrade enforcement"
          - "Evidence hygiene enforcement"
          - "AAT reuse safety with provenance validation"
          - "AAT harness sandboxing"
          - "Determinism metadata captured in AAT receipts (enforcement gated to Phase 2)"
        definition_of_done:
          - "An autonomous agent cannot flip a gate outcome or merge by manipulating GitHub or xtask"
          - "A GateRun cannot proceed with missing context; it terminates and triggers pack refinement"
        feature_flags:
          - name: FAC_SIGNATURE_VERIFICATION_ENABLED
            default: true
            description: "Enable Ed25519 signature verification on critical events"
          - name: FAC_CONTEXT_FIREWALL_MODE
            default: WARN
            values: [WARN, SOFT_FAIL, HARD_FAIL]
            description: "Context firewall enforcement mode"
          - name: CI_EVENTS_ENABLED
            default: false
            description: "Enable CI evidence import (fail-closed when false)"
          - name: FAC_DIVERGENCE_WATCHDOG_ENABLED
            default: true
            description: "Enable projection divergence watchdog"

    phase_1_limitations:
      - "CI evidence attestation is L1 only in Phase 1; L2+ deferred to Phase 2."
      - "AAT reuse is limited to LOW risk; MED requires waiver; HIGH is never reused."
      - "Determinism envelope enforcement is disabled in Phase 1 (schema only)."

      - phase_id: PHASE-2
        name: "Measurement Integrity + Goodhart Resistance"
        duration: "Target Q2 2026"
        dependencies:
          - PHASE-1
        deliverables:
          - "Holdout suite runner for false negative measurement"
          - "Auditor sampling of gate outcomes vs evidence"
          - "Echo-trap metrics feeding instruction updates"
          - "Determinism envelope enforcement for AAT"
          - "Flake classification policy routing"
          - "Quorum/audit enforcement for HIGH/MED risk tiers"
        definition_of_done:
          - "Holdout suite runs on schedule and produces metrics"
          - "Auditor samples 1% of GateRuns and detects drift"
          - "Determinism envelope rejects nondeterministic outcomes"
        feature_flags:
          - name: FAC_HOLDOUT_ENABLED
            default: false
            description: "Enable holdout suite execution"
          - name: FAC_DETERMINISM_ENVELOPE_ENABLED
            default: false
            description: "Enable N-run determinism validation"

      - phase_id: PHASE-3
        name: "Autonomous Improvement Substrate"
        duration: "Target Q3-Q4 2026"
        dependencies:
          - PHASE-2
        deliverables:
          - "Defect-driven auto-tuning of pack specs"
          - "Provider routing improvements with fallback"
        definition_of_done:
          - "Pack compiler updates based on defect patterns"
          - "Provider routing handles errors with circuit breaker"

    context_firewall_rollout:
      description: |
        Graduated rollout of context firewall enforcement across HTF windows (TIME_TBD) to allow
        pack completeness improvements without blocking development.
      phases:
        - phase: FAC-R-01
          mode: WARN
          duration_htf_window: "TIME_TBD"
          description: "Warn-only for LOW risk changes on sterile runner pool (no secrets, egress denied); auth/crypto/ledger enforced at SOFT_FAIL"
        - phase: FAC-R-02
          mode: SOFT_FAIL
          duration_htf_window: "TIME_TBD"
          description: "Context miss terminates session but allows retry; COI waiver auto-granted"
        - phase: FAC-R-03
          mode: HARD_FAIL
          duration_htf_window: "TIME_TBD"
          description: "Full enforcement; context miss triggers refinement; COI waiver requires ceremony"
        - phase: FAC-R-04
          mode: PRODUCTION
          duration: ongoing
          description: "Continuous improvement; pack specs refined based on defect patterns"
      acceleration_clause: |
        If CONTEXT_MISS rate <5% at HTF milestone window A (TIME_TBD), advance to FAC-R-03.
        If COI waiver rate <2% at HTF milestone window B (TIME_TBD), remove auto-grant.
      thresholds:
        acceptable_context_miss_rate: "<=15% of GateRuns in first HTF rollout window (TIME_TBD)"
        acceptable_coi_waiver_rate: "<=5% of admissions"
        feedback_latency_sla: "Pack spec updates within HTF window (TIME_TBD) of recurring pattern"

  operational_considerations:
    monitoring:
      - metric: fac_gate_signature_verification_failures
        type: counter
        alert_threshold: ">0 per HTF window (TIME_TBD)"
        description: "Count of INVALID_SIGNATURE rejections"

      - metric: fac_context_miss_rate
        type: gauge
        alert_threshold: ">15% over HTF window (TIME_TBD)"
        description: "Rate of CONTEXT_MISS session terminations"

      - metric: fac_projection_divergence_events
        type: counter
        alert_threshold: ">0 per HTF window (TIME_TBD)"
        description: "Count of PROJECTION_DIVERGENCE defects"

      - metric: fac_lease_expiry_rejections
        type: counter
        alert_threshold: ">5% of lease validations"
        description: "Count of expired lease rejections"

      - metric: fac_echo_trap_detections
        type: counter
        alert_threshold: ">3 per HTF window (TIME_TBD)"
        description: "Count of ECHO_TRAP reasoning degeneration detections"

      - metric: aat_terminal_verifier_failures
        type: counter
        alert_threshold: ">10% of AAT runs"
        description: "Count of terminal verifier predicate failures"

      - metric: aat_flake_classification
        type: histogram
        labels: [flake_class]
        description: "Distribution of AAT outcome_class (flake_class field) classifications"

    incident_response:
      - scenario: "Projection Divergence Detected"
        severity: P1
        response:
          - "InterventionFreeze halts admissions automatically"
          - "Investigate external trunk modification cause"
          - "Execute AdjudicationRequested(EMERGENCY_RECOVERY)"
          - "Verify ledger state integrity"
          - "Execute unfreeze ceremony after resolution"

      - scenario: "Widespread Context Miss Failures"
        severity: P2
        response:
          - "Check pack compiler output for recent changes"
          - "Review CONTEXT_MISS defect patterns"
          - "Emergency pack spec update if systematic gap"
          - "Consider temporary rollback to WARN mode"

      - scenario: "Signature Verification Failure Spike"
        severity: P0
        response:
          - "Immediately investigate key compromise"
          - "Check for unauthorized signers"
          - "Verify KeyRotated event chain"
          - "Consider emergency key rotation if compromise confirmed"

      - scenario: "AAT False Positive Blocking Merges"
        severity: P2
        response:
          - "Review terminal verifier configuration"
          - "Check for TEST_NONSEMANTIC flake class"
          - "Quarantine brittle AAT specs"
          - "Consider temporary waiver with explicit rationale"

    key_rotation:
      description: |
        Key rotation procedure for gate executor and adapter keys.
      procedure:
        - "Generate new key pair offline"
        - "Emit KeyRotated event with old -> new binding"
        - "Wait for event to be ledger-committed"
        - "Deploy new key to executor/adapter"
        - "Revoke old key after grace period"
      grace_period_htf_window: "TIME_TBD"
      audit_requirements:
        - "Log all key rotation events"
        - "Alert on unexpected rotations"
        - "Require dual approval for T1 (validator) keys"

  emergency_procedures:
    divergence_recovery:
      description: |
        Recovery procedure when projection divergence freeze is triggered.
      steps:
        - step: 1
          action: "Investigate divergence cause"
          details: "Compare external trunk HEAD to MergeReceipt result_selector"
        - step: 2
          action: "Determine recovery path"
          options:
            - "Force-push external to match ledger (if ledger is truth)"
            - "Adopt external state and create reconciliation event (if external is correct)"
        - step: 3
          action: "Execute AdjudicationRequested(EMERGENCY_RECOVERY)"
          details: "Requires explicit approval from AUTH_SECURITY"
        - step: 4
          action: "Execute unfreeze ceremony"
          details: "InterventionUnfreeze with adjudication_id"
        - step: 5
          action: "Verify projection sync"
          details: "Confirm watchdog shows no divergence"

    coi_waiver_ceremony:
      description: |
        Waiver ceremony for conflict of interest bypass.
      steps:
        - step: 1
          action: "Submit AdjudicationRequested(WAIVER)"
          details: "Include rationale, scope, and time_envelope_ref (TIME_TBD)"
        - step: 2
          action: "Await approval"
          details: "Requires AUTH_SECURITY signoff"
        - step: 3
          action: "Waiver recorded in ledger"
          details: "Projection-visible for audit"
        - step: 4
          action: "Execute with waived COI"
          details: "Limited to specified scope and time_envelope_ref (TIME_TBD)"

    emergency_override:
      description: |
        Emergency override ceremony per PRD-0007 for critical blockers.
      requirements:
        - "Dual approval required"
        - "Time-bounded via HTF time_envelope_ref (TIME_TBD)"
        - "Full audit trail"
        - "Post-incident review mandatory"

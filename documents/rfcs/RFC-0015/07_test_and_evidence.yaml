rfc_test_and_evidence:
  schema_version: "2026-01-29"

  test_strategy:
    overview: |
      FAC testing follows a multi-layer strategy: unit tests for core components,
      integration tests for protocol stages, property-based tests for invariants,
      and adversarial tests for security boundaries. Evidence binding validation
      is critical for AAT requirements.

    test_categories:
      - category: UNIT
        description: "Component-level tests for FAC modules"
        coverage_target: ">=80% line coverage for core modules"
        examples:
          - "GateLease validation logic"
          - "Signature verification with domain separation"
          - "Context firewall allowlist matching"
          - "Divergence detection comparison"

      - category: INTEGRATION
        description: "Protocol stage integration tests"
        coverage_target: "All FAC stages covered with happy path and error cases"
        examples:
          - "FAC-00 through FAC-06 complete workflow"
          - "Context miss triggers refinement loop"
          - "Divergence triggers freeze/unfreeze"
          - "AAT evidence chain validation"

      - category: PROPERTY
        description: "Property-based tests for invariants"
        framework: "proptest"
        examples:
          - "Lease subset rule: child lease cannot broaden scope"
          - "Signature verification: invalid signature always rejects"
          - "Context firewall: no reads outside allowlist succeed"
          - "Determinism: same inputs produce same outputs"

      - category: ADVERSARIAL
        description: "Security boundary tests"
        examples:
          - "Status spoofing via forged GateRunCompleted"
          - "Context escape attempt outside manifest"
          - "Replay attack with HTF-expired lease"
          - "CI evidence bypass without attestation"
          - "AAT narrative-only PASS attempt"

  evidence_requirements:
    - evidence_id: EVID-FAC-0001
      requirement_ids:
        - FAC-REQ-0017
      description: "Signature verification enforcement tests"
      test_type: UNIT + INTEGRATION
      verification_method: |
        Test that GateRunCompleted events with invalid, missing, or wrong-domain signatures
        are rejected with INVALID_SIGNATURE defect. Test that valid signatures are accepted.

    - evidence_id: EVID-FAC-0002
      requirement_ids:
        - FAC-REQ-0018
      description: "Lease scope and expiry enforcement tests"
      test_type: UNIT + PROPERTY
      verification_method: |
        Test that leases beyond HTF expiry window are rejected. Test that child leases cannot broaden scope.
        Test that mismatched changeset_digest rejects.

    - evidence_id: EVID-FAC-0021
      requirement_ids:
        - FAC-REQ-0018
      description: "Lease revocation enforcement tests"
      test_type: UNIT + INTEGRATION
      verification_method: |
        Test that LeaseRevoked invalidates a lease immediately.
        Test that GateRunCompleted with revoked lease is rejected.

    - evidence_id: EVID-FAC-0003
      requirement_ids:
        - FAC-REQ-0001
      description: "Context firewall enforcement tests"
      test_type: INTEGRATION + ADVERSARIAL
      verification_method: |
        Test that reads outside RCP manifest allowlist emit ToolDecided=DENY.
        Test that context miss terminates session with CONTEXT_MISS.
        Test that refinement is triggered after CONTEXT_MISS.

    - evidence_id: EVID-FAC-0004
      requirement_ids:
        - FAC-REQ-0002
      description: "Projection divergence detection tests"
      test_type: INTEGRATION
      verification_method: |
        Test that divergence between external trunk HEAD and MergeReceipt result_selector
        triggers PROJECTION_DIVERGENCE and InterventionFreeze.

    - evidence_id: EVID-FAC-0005
      requirement_ids:
        - FAC-REQ-0019
      description: "Projection-only GitHub integration tests"
      test_type: INTEGRATION + ADVERSARIAL
      verification_method: |
        Test that admission never reads GitHub status as truth.
        Test that non-adapter GitHub writes are detected as tamper.
        Test that projection is idempotent.

    - evidence_id: EVID-FAC-0006
      requirement_ids:
        - FAC-REQ-0003
      description: "CI evidence import and attestation tests"
      test_type: INTEGRATION
      verification_method: |
        Test that READY_FOR_REVIEW without evidence import fails.
        Test that webhook signature verification is enforced.
        Test that adapter attestation is required and signed.
        Test that L0 attestation is rejected and L1 is accepted when CI gating is enabled.

    - evidence_id: EVID-FAC-0007
      requirement_ids:
        - FAC-REQ-0004
        - FAC-REQ-0006
      description: "Typed AAT GateReceipt validation tests"
      test_type: UNIT + INTEGRATION
      verification_method: |
        Test that AAT GateReceipt with missing required fields is rejected.
        Test that view_commitment_hash binding is enforced.
        Test that transcript chain and artifact_manifest_hash are validated.
        Test that terminal/observational evidence digests are required.

    - evidence_id: EVID-FAC-0008
      requirement_ids:
        - FAC-REQ-0007
      description: "Terminal verifier binding enforcement tests"
      test_type: INTEGRATION + ADVERSARIAL
      verification_method: |
        Test that AAT PASS without terminal verifier outputs is rejected.
        Test that unsatisfied predicates fail admission.
        Test that narrative cannot substitute for verifier evidence.

    - evidence_id: EVID-FAC-0009
      requirement_ids:
        - FAC-REQ-0009
      description: "Risk-tiered AAT selection policy tests"
      test_type: UNIT + INTEGRATION
      verification_method: |
        Test that HIGH tier always requires AAT.
        Test that MED tier requires AAT for sensitive domains.
        Test that LOW tier sampling works correctly.
        Test that selection_policy_id is verified against policy_hash.

    - evidence_id: EVID-FAC-0010
      requirement_ids:
        - FAC-REQ-0005
      description: "Determinism envelope enforcement tests (Phase 2)"
      test_type: INTEGRATION + PROPERTY
      phase: PHASE-2
      verification_method: |
        Test that N-run stability is enforced for gates with determinism_class > 0.
        Test that nondeterminism emits GATE_NONDETERMINISTIC.
        Test that repeated nondeterminism triggers quarantine.
        Test that observational evidence differences do not trigger nondeterminism.
        Test that stability_digest uses terminal_evidence_digest and terminal_verifier_outputs_digest.

    - evidence_id: EVID-FAC-0011
      requirement_ids:
        - FAC-REQ-0008
      description: "AAT flake classification tests"
      test_type: UNIT + INTEGRATION
      verification_method: |
        Test that UNKNOWN failures cannot PASS via retries.
        Test that HARNESS_FLAKE triggers runner pool quarantine.
        Test that TEST_NONSEMANTIC triggers test spec quarantine.
        Test that ENVIRONMENT_DRIFT invalidates attestation and blocks admission.
        Test that deterministic FAIL uses outcome_class=DETERMINISTIC_FAIL.

    - evidence_id: EVID-FAC-0012
      requirement_ids:
        - FAC-REQ-0010
      description: "AAT lease binding and executor isolation tests"
      test_type: UNIT + INTEGRATION
      verification_method: |
        Test that AAT lease binds view_commitment_hash and rcp_manifest_hash.
        Test that AAT executor keys in wrong custody domain are rejected.

    - evidence_id: EVID-FAC-0022
      requirement_ids:
        - FAC-REQ-0010
      description: "KeyPolicy custody domain/COI enforcement tests"
      test_type: UNIT + INTEGRATION
      verification_method: |
        Test that KeyPolicy mapping enforces coi_group separation at lease issuance.
        Test that policy_hash mismatch rejects lease issuance.

    - evidence_id: EVID-FAC-0013
      requirement_ids:
        - FAC-REQ-0011
      description: "Invariant-first AAT specification validation tests"
      test_type: UNIT
      verification_method: |
        Test that AAT specs without invariant declarations are rejected.
        Test that step-only specs fail validation.

    - evidence_id: EVID-FAC-0014
      requirement_ids:
        - FAC-REQ-0012
      description: "AAT anti-downgrade enforcement tests"
      test_type: INTEGRATION + ADVERSARIAL
      verification_method: |
        Test that policy_hash mismatch rejects admission.
        Test that lowered risk_tier rejects admission.
        Test that downgrade with waiver succeeds.

    - evidence_id: EVID-FAC-0015
      requirement_ids:
        - FAC-REQ-0013
      description: "AAT reuse provenance validation tests"
      test_type: UNIT + INTEGRATION
      verification_method: |
        Test that AAT reuse requires exact provenance tuple match.
        Test that mismatched provenance emits AAT_CACHE_KEY_MISMATCH.

    - evidence_id: EVID-FAC-0016
      requirement_ids:
        - FAC-REQ-0014
      description: "AAT evidence hygiene tests"
      test_type: UNIT
      verification_method: |
        Test that evidence artifacts require data_classification.
        Test that missing redaction metadata rejects admission.
        Test that retention_window_ref is enforced.

    - evidence_id: EVID-FAC-0024
      requirement_ids:
        - FAC-REQ-0116
      description: "Policy resolution anchor tests"
      test_type: UNIT + INTEGRATION
      verification_method: |
        Test that PolicyResolvedForChangeSet exists before any GateLeaseIssued.
        Test that mismatched policy fields reject GateLeaseIssued and GateReceipt ingestion.

    - evidence_id: EVID-FAC-0025
      requirement_ids:
        - FAC-REQ-0117
      description: "Quarantine projection and routing tests"
      test_type: INTEGRATION
      verification_method: |
        Test that RunnerPoolQuarantined blocks selection.
        Test that AATSpecQuarantined blocks selection.
        Test that QuarantineCleared re-enables selection.

    - evidence_id: EVID-FAC-0026
      requirement_ids:
        - FAC-REQ-0118
      description: "CI attestation level enforcement tests"
      test_type: INTEGRATION
      verification_method: |
        Test that L0 attestation is rejected for CI-gated transitions.
        Test that L1 attestation with CAS artifact digests is accepted.

    - evidence_id: EVID-FAC-0027
      requirement_ids:
        - FAC-REQ-0119
      description: "GateReceipt versioning/canonicalization tests"
      test_type: UNIT + INTEGRATION
      verification_method: |
        Test that unknown receipt_version or payload_schema_version is rejected in enforce mode.
        Test canonical_bytes() hashing matches payload_hash and signature verification.

    - evidence_id: EVID-FAC-0017
      requirement_ids:
        - FAC-REQ-0015
      description: "AAT quorum/audit enforcement tests (Phase 2)"
      test_type: INTEGRATION
      phase: PHASE-2
      verification_method: |
        Test that HIGH tier requires two independent receipts.
        Test that MED tier triggers audit re-run at target rate.

    - evidence_id: EVID-FAC-0018
      requirement_ids:
        - FAC-REQ-0016
      description: "AAT harness sandboxing tests"
      test_type: INTEGRATION + ADVERSARIAL
      verification_method: |
        Test that egress is deny by default.
        Test that host mounts beyond pinned snapshot are blocked.
        Test that network violations are recorded in receipts.

    - evidence_id: EVID-FAC-0023
      requirement_ids:
        - FAC-REQ-0019
      description: "Admission network isolation tests"
      test_type: INTEGRATION + ADVERSARIAL
      verification_method: |
        Test that admission-path holons cannot reach api.github.com:443.
        Test that only HOLON-GITHUB-ADAPTER has GitHub API egress permission.

    - evidence_id: EVID-FAC-0019
      requirement_ids:
        - FAC-REQ-0020
      description: "Atomic merge receipt tests"
      test_type: INTEGRATION
      verification_method: |
        Test that MergeReceipt is only emitted after result_selector is observed.
        Test that incomplete merge does not emit receipt.
        Test that receipt binds all inputs to result.

    - evidence_id: EVID-FAC-0020
      requirement_ids:
        - FAC-REQ-0021
      description: "Bounded retries and echo-trap tests"
      test_type: INTEGRATION
      verification_method: |
        Test that per-gate max attempts (3) is enforced.
        Test that global max episodes (50) is enforced.
        Test that echo-trap detection triggers after 3 repeated findings.
        Test that escalation is triggered for unresolved loops.

  terminal_verifier_specs:
    - verifier_kind: exit_code
      required_outputs:
        - exit_code
        - command
      machine_predicate: "exit_code == 0"

    - verifier_kind: structured_test_report
      required_outputs:
        - report_digest
        - passed_count
        - failed_count
        - skipped_count
      machine_predicate: "failed_count == 0"

    - verifier_kind: snapshot_diff
      required_outputs:
        - diff_digest
        - changed_files_count
      machine_predicate: "changed_files_count == 0 OR diff_approved"

    - verifier_kind: invariant_check
      required_outputs:
        - invariant_id
        - check_result
      machine_predicate: "check_result == SATISFIED"

  test_commands:
    unit_tests: "cargo test -p apm2-core"
    integration_tests: "cargo test -p apm2-daemon"
    property_tests: "cargo test -p apm2-core --features test-utils"
    adversarial_tests: "cargo test -p apm2-daemon"
    all_fac_tests: "cargo test --workspace"

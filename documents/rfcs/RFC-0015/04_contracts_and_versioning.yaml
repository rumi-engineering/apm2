rfc_contracts_and_versioning:
  schema_version: "2026-01-29"

  protocol_contracts:
    - contract_id: FAC-CONTRACT-001
      name: "GateLeaseIssued Contract"
      description: |
        Defines the structure and invariants for gate lease issuance.
      schema: |
        message GateLease {
          string lease_id = 1;
          string work_id = 2;
          string gate_id = 3;
          bytes changeset_digest = 4;
          string executor_actor_id = 5;
          google.protobuf.Timestamp issued_at = 6;   // observational only
          google.protobuf.Timestamp expires_at = 7;  // observational only
          bytes policy_hash = 8;
          string issuer_actor_id = 9;
          bytes issuer_signature = 10;
          bytes time_envelope_ref = 11; // HTF time envelope (authoritative expiry)

          // AAT-specific extensions (when gate_id = "aat")
          AatLeaseExtension aat_extension = 12;
        }

        message AatLeaseExtension {
          bytes view_commitment_hash = 1;
          bytes rcp_manifest_hash = 2;
          string rcp_profile_id = 3;
          string selection_policy_id = 4;
        }
      invariants:
        - "lease_id is globally unique"
        - "time_envelope_ref is present (HTF-defined)"
        - "issuer_signature covers canonical bytes with GATE_LEASE_ISSUED: prefix"
        - "Child leases can only narrow scope (subset rule)"
        - "issued_at/expires_at are observational metadata only"
      domain_separator: "GATE_LEASE_ISSUED:"

    - contract_id: FAC-CONTRACT-009
      name: "LeaseRevoked Contract"
      description: |
        Defines the structure and invariants for lease revocation.
      schema: |
        message LeaseRevoked {
          string lease_id = 1;
          string revoked_by = 2;
          google.protobuf.Timestamp revoked_at = 3; // observational only
          string reason = 4;
          bytes issuer_signature = 5;
          bytes time_envelope_ref = 6; // HTF time envelope (authoritative ordering)
        }
      invariants:
        - "lease_id references valid GateLease"
        - "issuer_signature covers canonical bytes with LEASE_REVOKED: prefix"
        - "time_envelope_ref is present (HTF-defined)"
        - "revoked_at is observational metadata only"
      domain_separator: "LEASE_REVOKED:"

    - contract_id: FAC-CONTRACT-011
      name: "PolicyResolvedForChangeSet Contract"
      description: |
        Anchors resolved policy tuple for a changeset prior to lease issuance.
      schema: |
        message PolicyResolvedForChangeSet {
          string work_id = 1;
          bytes changeset_digest = 2;
          bytes resolved_policy_hash = 3;
          string resolved_risk_tier = 4;
          uint32 resolved_determinism_class = 5;
          repeated string resolved_rcp_profile_ids = 6;
          repeated bytes resolved_rcp_manifest_hashes = 7;
          repeated bytes resolved_verifier_policy_hashes = 8;
          string resolver_actor_id = 9;
          string resolver_version = 10;
          bytes resolver_signature = 11;
        }
      invariants:
        - "resolver_signature covers canonical bytes with POLICY_RESOLVED_FOR_CHANGESET: prefix"
        - "Event committed before any GateLeaseIssued for same changeset"
        - "All GateLeaseIssued and GateReceipt payloads must match resolved tuple"
        - "resolved_rcp_profile_ids.len() == resolved_rcp_manifest_hashes.len()"
        - "resolved_verifier_policy_hashes.len() >= 1"
      domain_separator: "POLICY_RESOLVED_FOR_CHANGESET:"

    - contract_id: FAC-CONTRACT-002
      name: "GateRunCompleted Contract"
      description: |
        Defines the structure and invariants for gate completion events.
      schema: |
        message GateRunCompleted {
          string gate_id = 1;
          string lease_id = 2;
          bytes changeset_digest = 3;
          string executor_actor_id = 4;
          bytes evidence_bundle_hash = 5;
          string gate_receipt_id = 6;
          google.protobuf.Timestamp completed_at = 7; // observational only
          bytes executor_signature = 8;
          bytes gate_receipt_payload_hash = 9;
          string gate_receipt_payload_type = 10; // e.g., "aat.v1"
        }
      invariants:
        - "lease_id references valid GateLease"
        - "no LeaseRevoked exists for lease_id with HTF time <= completion tick"
        - "changeset_digest matches lease"
        - "executor_actor_id matches lease"
        - "gate_receipt_payload_hash references CAS payload with type gate_receipt_payload_type"
        - "executor_signature covers canonical bytes with GATE_RUN_COMPLETED: prefix"
        - "completion HTF tick is within lease time_envelope_ref"
        - "completed_at is observational metadata only"
      domain_separator: "GATE_RUN_COMPLETED:"

    - contract_id: FAC-CONTRACT-012
      name: "GateReceipt Envelope Contract"
      description: |
        Defines the envelope and versioning for gate receipts. Payloads are stored in CAS
        and referenced by payload_hash.
      schema: |
        message GateReceipt {
          string receipt_id = 1;
          string gate_id = 2;
          string lease_id = 3;
          bytes changeset_digest = 4;
          string executor_actor_id = 5;
          uint32 receipt_version = 6;
          string payload_kind = 7;          // e.g., "aat"
          string payload_schema_version = 8; // e.g., "aat.v1"
          bytes payload_hash = 9;
          bytes evidence_bundle_hash = 10;
          bytes receipt_signature = 11;
        }
      invariants:
        - "receipt_signature covers canonical bytes with GATE_RECEIPT: prefix"
        - "receipt_version is known and supported in enforce mode"
        - "payload_kind and payload_schema_version are allowlisted in enforce mode"
        - "canonicalization: deterministic encoding, no maps, stable ordering of repeated fields"
      domain_separator: "GATE_RECEIPT:"

    - contract_id: FAC-CONTRACT-003
      name: "AatGateReceipt Contract"
      description: |
        Typed payload for AAT gate receipts with evidence binding (stored in CAS, referenced by payload hash).
      schema: |
        message AatGateReceipt {
          // View commitment binding
          bytes view_commitment_hash = 1;
          bytes rcp_manifest_hash = 2;
          string rcp_profile_id = 3;
          bytes policy_hash = 4;

          // Determinism tracking
          uint32 determinism_class = 5;
          string determinism_status = 6; // STABLE, MISMATCH
          string flake_class = 7;        // outcome_class (legacy field name); DETERMINISTIC_FAIL, HARNESS_FLAKE, ENVIRONMENT_DRIFT, TEST_NONSEMANTIC, CODE_NONSEMANTIC(optional), UNKNOWN
          uint32 run_count = 8;
          repeated bytes run_receipt_hashes = 9;
          bytes terminal_evidence_digest = 10;
          bytes observational_evidence_digest = 11;
          bytes terminal_verifier_outputs_digest = 12;
          bytes stability_digest = 13;

          // Verdict
          string verdict = 14;  // PASS, FAIL, NEEDS_INPUT

          // Evidence binding
          bytes transcript_chain_root_hash = 15;
          bytes transcript_bundle_hash = 16;
          bytes artifact_manifest_hash = 17;
          repeated TerminalVerifierOutput terminal_verifier_outputs = 18;
          bytes verifier_policy_hash = 19;

          // Risk tier
          string selection_policy_id = 20;
          string risk_tier = 21;  // HIGH, MED, LOW

          // Attestation
          AatAttestation attestation = 22;
        }

        message TerminalVerifierOutput {
          string verifier_kind = 1;  // exit_code, snapshot_diff, structured_test_report, invariant_check
          bytes output_digest = 2;
          bool predicate_satisfied = 3;
        }

        message AatAttestation {
          bytes container_image_digest = 1;
          repeated bytes toolchain_digests = 2;
          string runner_identity_key_id = 3;
          bytes network_policy_profile_hash = 4;
        }
      invariants:
        - "view_commitment_hash matches FAC-00 output"
        - "rcp_manifest_hash matches FAC-02 output for profile"
        - "run_receipt_hashes.len() == run_count"
        - "transcript_chain_root_hash derivable from transcript_bundle_hash"
        - "artifact_manifest_hash references CAS ArtifactManifest"
        - "observational_evidence_digest excluded from determinism equality"
        - "At least one terminal_verifier_output present for PASS"
        - "predicate_satisfied == true for all verifier outputs when verdict == PASS"
        - "determinism_status == MISMATCH implies flake_class in {HARNESS_FLAKE, ENVIRONMENT_DRIFT, TEST_NONSEMANTIC, CODE_NONSEMANTIC, UNKNOWN}"
        - "verdict == FAIL AND determinism_status == STABLE implies flake_class == DETERMINISTIC_FAIL"
        - "stability_digest == hash(verdict, terminal_evidence_digest, terminal_verifier_outputs_digest)"

    - contract_id: FAC-CONTRACT-010
      name: "ArtifactManifest Contract"
      description: |
        Defines a manifest for large evidence artifact lists stored in CAS.
      schema: |
        message ArtifactManifest {
          repeated ArtifactDigest artifacts = 1;
        }

        message ArtifactDigest {
          string artifact_type = 1;  // log, junit, coverage, snapshot, binary
          bytes digest = 2;
          string data_classification = 3;
          bool redaction_applied = 4;
          bytes redaction_profile_hash = 5;
          bytes retention_window_ref = 6; // HTF time envelope reference
        }
      invariants:
        - "All artifacts include data_classification"

    - contract_id: FAC-CONTRACT-007
      name: "VerifierPolicy Contract"
      description: |
        Defines terminal verifier policy: scenario_type -> allowed verifiers,
        required outputs, and machine predicate.
      schema: |
        verifier_policy:
          policy_id: "VERIFIER_POLICY_FAC_V1"
          policy_hash: "<blake3 of canonical form>"
          schema_version: "fac.verifier_policy.v1"
          scenario_type: "aat"
          allowed_verifier_kinds: ["exit_code", "snapshot_diff", "structured_test_report", "invariant_check"]
          required_outputs:
            exit_code: ["exit_code", "command"]
            structured_test_report: ["report_digest", "passed_count", "failed_count", "skipped_count"]
          machine_predicate: "exit_code == 0 AND failed_count == 0"
          predicate_lang: "fac_predicate_v1"
      invariants:
        - "policy_hash equals BLAKE3 of canonical policy document"
        - "predicate_lang is supported by admission runtime"
        - "required_outputs keys are subset of allowed_verifier_kinds"

    - contract_id: FAC-CONTRACT-008
      name: "KeyPolicy Contract"
      description: |
        Defines custody domains, COI groups, and key bindings for lease issuance.
      schema: |
        key_policy:
          policy_id: "KEY_POLICY_FAC_V1"
          policy_hash: "<blake3 of canonical form>"
          schema_version: "fac.key_policy.v1"
          custody_domains:
            - domain_id: "DOMAIN_ADMISSION"
              coi_group_id: "admission"
              key_bindings:
                - key_id: "key:ed25519:..."
                  actor_id: "HOLON-KERNEL-GATE"
                  role_ids: ["ROLE_ADMISSION"]
          coi_rules:
            - rule_id: "COI-001"
              statement: "Executor COI group must differ from changeset author COI group"
          delegation_rules:
            - from_domain_id: "DOMAIN_KERNEL"
              to_domain_id: "DOMAIN_ADMISSION"
              allowed_gates: ["quality", "security", "aat"]
      invariants:
        - "policy_hash equals BLAKE3 of canonical policy document"
        - "All key_bindings include actor_id and role_ids"
        - "coi_group_id is defined for every custody_domain"

    - contract_id: FAC-CONTRACT-004
      name: "MergeReceipt Contract"
      description: |
        Defines the atomic merge receipt binding inputs to result.
      schema: |
        message MergeReceipt {
          bytes base_selector = 1;
          bytes changeset_digest = 2;
          repeated string gate_receipt_ids = 3;
          bytes policy_hash = 4;
          bytes result_selector = 5;
          google.protobuf.Timestamp merged_at = 6;
          string gate_actor_id = 7;
          bytes gate_signature = 8;
        }
      invariants:
        - "result_selector is observed trunk HEAD after merge"
        - "All gate_receipt_ids reference valid GateRunCompleted events"
        - "gate_signature covers canonical bytes with MERGE_RECEIPT: prefix"
        - "merged_at is observational metadata only; authoritative ordering uses HTF ledger tick"
      domain_separator: "MERGE_RECEIPT:"

    - contract_id: FAC-CONTRACT-005
      name: "AATResultReused Contract"
      description: |
        Defines the provenance-bound AAT result reuse event.
      schema: |
        message AATResultReused {
          bytes from_receipt_hash = 1;
          AatProvenanceTuple provenance = 2;
          bytes policy_hash = 3;
          string justification = 4;
          bytes gate_signature = 5;
        }

        message AatProvenanceTuple {
          bytes changeset_digest = 1;
          bytes pinned_snapshot_digest = 2;
          bytes verifier_policy_hash = 3;
          bytes toolchain_digest = 4;
          bytes env_attestation_digest = 5;
          bytes rcp_aat_manifest_hash = 6;
        }
      invariants:
        - "from_receipt_hash references valid AatGateReceipt"
        - "All provenance fields must match exactly"
        - "gate_signature covers canonical bytes with AAT_RESULT_REUSED: prefix"
      domain_separator: "AAT_RESULT_REUSED:"

    - contract_id: FAC-CONTRACT-006
      name: "InterventionFreeze Contract"
      description: |
        Defines the freeze/unfreeze protocol for divergence handling.
      schema: |
        message InterventionFreeze {
          string scope = 1;  // repo, work_id
          string scope_value = 2;
          string trigger_defect_id = 3;
          google.protobuf.Timestamp frozen_at = 4; // observational only
          string gate_actor_id = 5;
          bytes gate_signature = 6;
          bytes time_envelope_ref = 7; // HTF time envelope (if bounded)
        }

        message InterventionUnfreeze {
          string freeze_id = 1;
          string resolution_type = 2;  // ADJUDICATION, EMERGENCY_OVERRIDE
          string adjudication_id = 3;
          google.protobuf.Timestamp unfrozen_at = 4; // observational only
          string gate_actor_id = 5;
          bytes gate_signature = 6;
          bytes time_envelope_ref = 7; // HTF time envelope (if bounded)
        }
      invariants:
        - "Unfreeze requires valid adjudication or emergency override ceremony"
        - "No admissions proceed while freeze is active for scope"
        - "frozen_at/unfrozen_at are observational metadata only"

    - contract_id: FAC-CONTRACT-013
      name: "Quarantine Events Contract"
      description: |
        Defines quarantine events for runner pools and AAT specs with HTF time envelopes.
      schema: |
        message RunnerPoolQuarantined {
          string quarantine_id = 1;
          string pool_id = 2;
          string reason = 3;
          repeated bytes evidence_refs = 4;
          bytes time_envelope_ref = 5;
          string issuer_actor_id = 6;
          bytes issuer_signature = 7;
        }

        message AATSpecQuarantined {
          string quarantine_id = 1;
          string spec_id = 2;
          string reason = 3;
          repeated bytes evidence_refs = 4;
          bytes time_envelope_ref = 5;
          string issuer_actor_id = 6;
          bytes issuer_signature = 7;
        }

        message QuarantineCleared {
          string quarantine_id = 1;
          string target_id = 2;
          string cleared_reason = 3;
          string issuer_actor_id = 4;
          bytes issuer_signature = 5;
        }
      invariants:
        - "issuer_signature covers canonical bytes with QUARANTINE_EVENT: prefix"
        - "time_envelope_ref is present for quarantine events"
        - "QuarantineCleared requires prior active quarantine for target_id"
      domain_separator: "QUARANTINE_EVENT:"

  versioning_strategy:
    schema_versioning:
      approach: "Schema digest with fail-closed validation"
      details: |
        All event envelopes include schema_version and schema_digest. Unknown schemas
        trigger event rejection. Canonicalizer version tracked for cross-version verification.
        GateReceipt envelopes reject unknown payload_kind or payload_schema_version in
        enforce mode; audit mode may allow unknown versions only if explicitly configured.

    api_versioning:
      approach: "Semantic versioning with additive-only extensions"
      details: |
        FAC protocol version follows semver. New fields are additive with default handling.
        Breaking changes require new major version and migration path.

    policy_versioning:
      approach: "Content-addressed policy profiles"
      details: |
        Policy profiles are identified by policy_hash (BLAKE3 digest of canonical form).
        Policy resolution pinned at FAC-00 ingestion. Changes require new changeset.

  migration_considerations:
    - id: MIG-FAC-0001
      name: "Gate Event Payload Extension"
      description: |
        Existing kernel_events.proto may need extension for GateLeaseIssued, GateRunStarted,
        GateRunCompleted, and LeaseRevoked payloads.
      resolution: "Extend kernel_events.proto (Q-RFC-FAC-0001 resolved)"

    - id: MIG-FAC-0002
      name: "Gradual OCAP Rollout"
      description: |
        Context firewall enforcement should be graduated (warn -> soft-fail -> hard-fail)
        to allow pack completeness improvements during transition.
      phases:
        - phase: FAC-R-01
          mode: WARN
          duration_htf_window: "TIME_TBD"
          notes: "WARN applies only to non-sensitive domains; auth/crypto/ledger start at SOFT_FAIL"
        - phase: FAC-R-02
          mode: SOFT_FAIL
          duration_htf_window: "TIME_TBD"
        - phase: FAC-R-03
          mode: HARD_FAIL
          duration_htf_window: "TIME_TBD"
        - phase: FAC-R-04
          mode: PRODUCTION
          duration: ongoing

    - id: MIG-FAC-0003
      name: "CI Evidence Feature Flag"
      description: |
        CI evidence import is disabled by default (CI_EVENTS_ENABLED=false).
        Fail-closed when disabled; evidence-backed import required when enabled.

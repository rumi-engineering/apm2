# RFC-0015 FAC - Mock Implementation Run Report
# SA-2 (Implementation Feasibility) FINALIZE Artifact
# Session: 20260129-RFC0015-FINALIZE
# Agent: SA-2 (Implementation Feasibility)
# Transition: v2 (Grounded) -> v4 (Standard)

sa2_mock_implementation_run_report:
  schema_version: "2026-01-29"
  session_id: "20260129-RFC0015-FINALIZE"
  agent_id: SA-2
  role: "Implementation Feasibility"
  artifact_type: "Mock Implementation Run Report"

  reasoning_modes_applied:
    - mode_id: 11
      name: "Bayesian Reasoning"
      application: "Prior updates on implementation success probabilities based on codebase evidence"
    - mode_id: 39
      name: "Counterfactual Reasoning"
      application: "What-if analysis for alternative implementation paths and intervention effects"
    - mode_id: 47
      name: "Planning/Policy Reasoning"
      application: "Action sequence optimization and goal satisfaction verification"
    - mode_id: 51
      name: "Satisficing"
      application: "Bounded search for good-enough solutions under resource constraints"
    - mode_id: 70
      name: "Engineering Design"
      application: "Specifications, constraints, and trade-off analysis"

  # ============================================================================
  # SECTION 1: MOCK IMPLEMENTATION RUN SIMULATIONS
  # ============================================================================

  mock_implementation_runs:

    # --------------------------------------------------------------------------
    # RUN 1: Gate Event Infrastructure (TG-FAC-001)
    # --------------------------------------------------------------------------
    - run_id: MIR-FAC-001
      ticket_group: TG-FAC-001
      name: "Gate Event Infrastructure"

      bayesian_analysis:
        prior_probability: 0.65
        prior_rationale: |
          Base rate for proto extension in this codebase is ~65% success on first attempt.
          kernel_events.proto has clear oneof patterns (8 existing families).
          LeaseEvent already has registrar_signature pattern reusable for GateLease.

        evidence_updates:
          - evidence: "LeaseIssued proto already has registrar_signature field (proto:229-236)"
            likelihood_ratio: 1.3
            posterior_after: 0.71
          - evidence: "LeaseReducer in lease/reducer.rs shows extensible state machine pattern"
            likelihood_ratio: 1.2
            posterior_after: 0.76
          - evidence: "SA2-RFC0015-F001 finding: GateLease schema incompatibility with LeaseIssued"
            likelihood_ratio: 0.7
            posterior_after: 0.64
          - evidence: "Q-RFC-FAC-0001 RESOLVED: extend kernel_events.proto confirmed feasible"
            likelihood_ratio: 1.5
            posterior_after: 0.73

        final_probability: 0.73
        confidence_interval: [0.62, 0.84]

      counterfactual_analysis:
        baseline_path: "Extend LeaseEvent oneof with GateLeaseIssued variant"
        alternative_paths:
          - path_id: CF-001-A
            description: "Create separate GateEvent message family"
            intervention: "Add new oneof family tag 19 for GateEvent"
            predicted_outcome: |
              Would require new reducer, new event handling path. Increases scope.
              Probability of clean integration drops to 0.55 due to
              code duplication and maintenance burden.
            recommendation: REJECT

          - path_id: CF-001-B
            description: "Reuse existing EvidenceEvent for gate receipts only"
            intervention: "Put GateRunCompleted in EvidenceEvent, GateLease separate"
            predicted_outcome: |
              Semantic mismatch: lease issuance is not evidence. Would confuse
              reducer responsibilities. Probability of defects: 0.35.
            recommendation: REJECT

        selected_path: "Extend LeaseEvent (tag 13) with GateLeaseIssued; extend EvidenceEvent (tag 16) with GateRunCompleted/MergeReceipt"

      planning_analysis:
        goal: "Implement gate event infrastructure with signature verification"
        action_sequence:
          - action: "Define GateLeaseIssued, GateRunStarted, GateRunCompleted, MergeReceipt in kernel_events.proto"
            preconditions: []
            postconditions: ["proto compiles", "Rust bindings generate"]
          - action: "Create domain_separator.rs with GATE_* prefixes"
            preconditions: ["proto defined"]
            postconditions: ["sign_with_domain helper available"]
          - action: "Extend LeaseReducer with GateLease handling"
            preconditions: ["proto defined", "domain separator ready"]
            postconditions: ["GateLease state transitions work"]
          - action: "Create GateReceiptReducer for evidence events"
            preconditions: ["proto defined"]
            postconditions: ["GateRunCompleted ingestion works"]
          - action: "Add signature verification to event ingestion"
            preconditions: ["domain separator ready", "reducers ready"]
            postconditions: ["INVALID_SIGNATURE rejected", "tests pass"]

        parallelization_factor: 1.4
        adjusted_hours: 21

      satisficing_analysis:
        constraint: "Deliver working gate infrastructure with limited engineering hours"
        good_enough_criteria:
          - "GateLease extends existing Lease with gate-specific fields"
          - "Signature verification reuses existing Signer infrastructure"
          - "Domain separation is thin wrapper (not full crypto library)"

        deferred_optimizations:
          - "Hardware security module integration for T1 keys"
          - "Batch signature verification for high-throughput scenarios"
          - "Cross-shard lease consistency (single-shard sufficient for v1)"

        satisficing_verdict: |
          Good-enough solution: Extend LeaseReducer pattern, reuse Signer from
          crypto/sign.rs, implement domain_separator.rs as ~100 LOC module.
          Full optimization can be deferred to Phase 2.

      engineering_design_analysis:
        specifications:
          - spec_id: SPEC-FAC-001-A
            title: "Domain Separator Format"
            specification: |
              Domain separator format: UTF-8 prefix string concatenated with canonical bytes.
              Format: "<PREFIX>:" || canonical_bytes(message)
              Prefixes are constant strings terminated with colon.
              Example: "GATE_LEASE_ISSUED:" || canonical_proto_bytes
            rationale: "Simple concatenation, no length prefix needed for fixed prefixes"

          - spec_id: SPEC-FAC-001-B
            title: "GateLease Proto Extension"
            specification: |
              Extend LeaseEvent oneof with new message types:
              - GateLeaseIssued: extends LeaseIssued with gate_id, changeset_digest, policy_hash
              - GateLeaseRevoked: new message for compromised key handling (addresses F-SA3-001)
            rationale: "Extends existing pattern, maintains backward compatibility"

        constraints:
          - constraint: "Must be backward compatible with existing LeaseReducer"
            satisfied: true
            how: "New oneof variants; existing variants unchanged"
          - constraint: "Signature verification must be constant-time"
            satisfied: true
            how: "ed25519-dalek uses constant-time comparison"

        trade_offs:
          - trade_off: "Proto message size vs field completeness"
            decision: "Include all fields in GateLease (larger messages, better auditability)"
            rationale: "Security auditability outweighs bandwidth cost"

      implementation_verdict:
        feasibility: HIGH
        confidence: 0.73
        critical_blockers: []
        recommendations:
          - "Resolve domain separator format (SPEC-FAC-001-A) before implementation"
          - "Add LeaseRevoked event to address F-SA3-001 security finding"

    # --------------------------------------------------------------------------
    # RUN 2: OCAP Context Firewall (TG-FAC-002)
    # --------------------------------------------------------------------------
    - run_id: MIR-FAC-002
      ticket_group: TG-FAC-002
      name: "OCAP Context Firewall"

      bayesian_analysis:
        prior_probability: 0.50
        prior_rationale: |
          Context firewall is conceptually new to codebase. Tool validation layer
          exists but no manifest-based allowlist checking. Prior is neutral.

        evidence_updates:
          - evidence: "Q-RFC-FAC-0002 RESOLVED: ContextAwareValidator at tool validation layer (0.75 success)"
            likelihood_ratio: 1.5
            posterior_after: 0.60
          - evidence: "PolicyEngine in policy/engine.rs has default-deny, rule evaluation"
            likelihood_ratio: 1.3
            posterior_after: 0.67
          - evidence: "tool/validation.rs provides clean extension point (mod.rs:66-75)"
            likelihood_ratio: 1.2
            posterior_after: 0.72
          - evidence: "No existing manifest schema for allowlist"
            likelihood_ratio: 0.85
            posterior_after: 0.66

        final_probability: 0.66
        confidence_interval: [0.52, 0.80]

      counterfactual_analysis:
        baseline_path: "ContextAwareValidator middleware wrapping existing Validator"
        alternative_paths:
          - path_id: CF-002-A
            description: "Protocol layer interception"
            intervention: "Intercept at daemon protocol layer instead of core"
            predicted_outcome: |
              Higher coupling to daemon. Would need duplicated logic for different
              adapters. Integration probability drops to 0.45.
            recommendation: REJECT

          - path_id: CF-002-B
            description: "Inline checks in each tool handler"
            intervention: "Add manifest checking to file_read, repo_read handlers individually"
            predicted_outcome: |
              Scattered logic, high probability of missed checks (0.25 escape rate).
              Violates single responsibility principle.
            recommendation: REJECT

        selected_path: "ContextAwareValidator trait in apm2-core/src/tool/ wrapping Validator"

      planning_analysis:
        goal: "Implement mechanical context firewall with manifest allowlist"
        action_sequence:
          - action: "Create context/manifest.rs with ContextPackManifest struct"
            preconditions: []
            postconditions: ["Manifest struct with stable_id, path, hash fields"]
          - action: "Create context/firewall.rs with ContextAwareValidator trait"
            preconditions: ["manifest.rs ready"]
            postconditions: ["Trait wraps Validator, checks manifest"]
          - action: "Integrate with PolicyEngine for CTX-ALLOWLIST-001 rule"
            preconditions: ["firewall.rs ready"]
            postconditions: ["ToolDecided=DENY emitted on manifest miss"]
          - action: "Implement ContextRefinementRequest handling"
            preconditions: ["firewall integrated"]
            postconditions: ["Context miss terminates session, triggers refinement"]
          - action: "Add CONTEXT_MISS defect tracking"
            preconditions: ["refinement handling ready"]
            postconditions: ["Metrics and defect records generated"]

        parallelization_factor: 1.3
        adjusted_hours: 17

      satisficing_analysis:
        constraint: "Deliver working context firewall without over-engineering"
        good_enough_criteria:
          - "Manifest is simple struct with Vec<ManifestEntry>"
          - "Firewall checks path+hash or stable_id against manifest"
          - "Hard deny on miss (no soft modes in core, feature flag in daemon)"

        deferred_optimizations:
          - "Manifest caching with LRU eviction"
          - "Prefix-tree optimization for path matching"
          - "Integration with compiler for automatic manifest generation"

        satisficing_verdict: |
          Good-enough solution: Simple manifest struct, linear search for matching
          (sufficient for <1000 entries per pack). Optimization deferred.

      engineering_design_analysis:
        specifications:
          - spec_id: SPEC-FAC-002-A
            title: "Manifest Entry Format"
            specification: |
              ManifestEntry {
                stable_id: Option<String>,  // e.g., "org:doc:readme"
                path: String,               // e.g., "/repo/README.md"
                content_hash: [u8; 32],     // BLAKE3 hash
                entry_type: EntryType,      // FILE, DIR, ARTIFACT
              }
            rationale: "Supports both stable_id and path+hash lookup"

          - spec_id: SPEC-FAC-002-B
            title: "Firewall Decision Flow"
            specification: |
              1. ToolRequested(file_read, path) arrives
              2. ContextAwareValidator checks: is path in manifest?
              3. If yes: check content_hash matches (if available)
              4. If no: emit ToolDecided(DENY, "CTX-ALLOWLIST-001")
              5. On deny: emit ContextMiss event, terminate session
            rationale: "Fail-closed, auditable, refinement-triggering"

        constraints:
          - constraint: "Must not break existing tool validation"
            satisfied: true
            how: "Wrapper pattern; existing Validator unchanged"
          - constraint: "Must work with CONSUME mode holons"
            satisfied: true
            how: "Mode flag in session context determines enforcement"

        trade_offs:
          - trade_off: "Strictness vs adoption friction"
            decision: "Hard fail in core, feature flag for rollout modes in daemon"
            rationale: "Core is strict; operational flexibility in daemon layer"

      implementation_verdict:
        feasibility: MEDIUM
        confidence: 0.66
        critical_blockers: []
        recommendations:
          - "Define manifest schema before implementation"
          - "Coordinate with Context Compiler team for manifest generation"

    # --------------------------------------------------------------------------
    # RUN 3: Projection and Divergence Watchdog (TG-FAC-003)
    # --------------------------------------------------------------------------
    - run_id: MIR-FAC-003
      ticket_group: TG-FAC-003
      name: "Projection and Divergence Watchdog"

      bayesian_analysis:
        prior_probability: 0.55
        prior_rationale: |
          GitHub adapter exists but is read-focused. Projection-only write pattern
          is new. Watchdog is straightforward polling but integration points unclear.

        evidence_updates:
          - evidence: "No existing projection module in daemon (EP-7 is NEW)"
            likelihood_ratio: 0.9
            posterior_after: 0.51
          - evidence: "Event contract model is reusable (SA-3 finding)"
            likelihood_ratio: 1.2
            posterior_after: 0.57
          - evidence: "Q-RFC-FAC-0010 UNRESOLVED: GitHub branch protection contract"
            likelihood_ratio: 0.8
            posterior_after: 0.50

        final_probability: 0.50
        confidence_interval: [0.35, 0.65]

      counterfactual_analysis:
        baseline_path: "New daemon/projection/ module with github_sync.rs and divergence_watchdog.rs"
        alternative_paths:
          - path_id: CF-003-A
            description: "Extend existing GitHub adapter"
            intervention: "Add projection logic to existing adapter code"
            predicted_outcome: |
              Would mix read and write concerns. Violates TB-0003 isolation boundary.
              Probability of security regression: 0.20.
            recommendation: REJECT

          - path_id: CF-003-B
            description: "External watchdog service"
            intervention: "Separate process polls GitHub and ledger"
            predicted_outcome: |
              Adds operational complexity. Harder to test. Coordination overhead.
              Probability of deployment issues: 0.30.
            recommendation: REJECT

        selected_path: "New daemon/projection/ module with clear separation from read adapter"

      planning_analysis:
        goal: "Implement projection-only GitHub sync with divergence watchdog"
        action_sequence:
          - action: "Create projection/github_sync.rs with idempotent write logic"
            preconditions: []
            postconditions: ["Can project ledger state to GitHub"]
          - action: "Create projection/divergence_watchdog.rs with 30s polling"
            preconditions: ["sync module ready"]
            postconditions: ["Detects trunk HEAD vs MergeReceipt mismatch"]
          - action: "Implement InterventionFreeze emission on divergence"
            preconditions: ["watchdog ready"]
            postconditions: ["Factory freeze triggered automatically"]
          - action: "Create projection/projection_receipt.rs for audit trail"
            preconditions: ["sync module ready"]
            postconditions: ["Signed receipt for each projection operation"]

        parallelization_factor: 1.2
        adjusted_hours: 18

      satisficing_analysis:
        constraint: "Deliver divergence detection without perfect branch protection verification"
        good_enough_criteria:
          - "Poll-based watchdog (30s interval) is sufficient for initial detection"
          - "Branch protection contract documented but not runtime-verified initially"
          - "Divergence triggers freeze; recovery is manual ceremony"

        deferred_optimizations:
          - "Webhook-based divergence detection (sub-second latency)"
          - "Runtime branch protection verification via GitHub API"
          - "Automated recovery for known-safe divergence patterns"

        satisficing_verdict: |
          Good-enough solution: Poll-based detection, manual recovery. Branch
          protection verification deferred pending Q-RFC-FAC-0010 resolution.

      engineering_design_analysis:
        specifications:
          - spec_id: SPEC-FAC-003-A
            title: "Divergence Detection Algorithm"
            specification: |
              Every 30s:
              1. Fetch external trunk HEAD commit SHA
              2. Fetch latest MergeReceipt from ledger
              3. Compare external HEAD to MergeReceipt.result_selector
              4. If mismatch:
                 a. Emit DefectRecord(PROJECTION_DIVERGENCE)
                 b. Emit InterventionFreeze(scope=repo)
                 c. Halt FAC admissions for repo
            rationale: "Simple polling with clear escalation path"

        constraints:
          - constraint: "Must handle GitHub API rate limits"
            satisfied: true
            how: "30s interval well within rate limits; exponential backoff on 429"
          - constraint: "Must not block on divergence check"
            satisfied: true
            how: "Async polling in background task"

        trade_offs:
          - trade_off: "Detection latency vs API usage"
            decision: "30s polling interval"
            rationale: "Balance between responsiveness and resource usage"

      implementation_verdict:
        feasibility: MEDIUM
        confidence: 0.50
        critical_blockers:
          - "Q-RFC-FAC-0010 unresolved (branch protection contract)"
        recommendations:
          - "Resolve Q-RFC-FAC-0010 before production deployment"
          - "Document divergence recovery procedure before rollout"

    # --------------------------------------------------------------------------
    # RUN 4: Typed AAT GateReceipt (TG-FAC-005)
    # --------------------------------------------------------------------------
    - run_id: MIR-FAC-005
      ticket_group: TG-FAC-005
      name: "Typed AAT GateReceipt"

      bayesian_analysis:
        prior_probability: 0.60
        prior_rationale: |
          AATReceipt already exists in evidence/aat_receipt.rs with signature binding.
          GateReceiptGenerated exists in proto. Extension seems feasible.

        evidence_updates:
          - evidence: "AATReceipt in aat_receipt.rs has canonical_bytes, signature, verification"
            likelihood_ratio: 1.4
            posterior_after: 0.70
          - evidence: "Q-RFC-FAC-0005 RESOLVED: reuse TranscriptChunk from CAC (80% reuse)"
            likelihood_ratio: 1.3
            posterior_after: 0.77
          - evidence: "GateReceiptGenerated proto already has typed payload pattern"
            likelihood_ratio: 1.2
            posterior_after: 0.81
          - evidence: "Terminal verifier has no existing pattern (SA2-RFC0015-F003)"
            likelihood_ratio: 0.6
            posterior_after: 0.67

        final_probability: 0.67
        confidence_interval: [0.53, 0.81]

      counterfactual_analysis:
        baseline_path: "Extend GateReceiptGenerated with AAT-specific typed payload"
        alternative_paths:
          - path_id: CF-005-A
            description: "Separate AATReceipt event type"
            intervention: "Create standalone AATReceipt in EvidenceEvent oneof"
            predicted_outcome: |
              Creates parallel receipt paths. Complicates admission logic.
              Would need separate reducer. Probability of inconsistency: 0.25.
            recommendation: REJECT

          - path_id: CF-005-B
            description: "Embed AAT data in existing AATReceipt (non-event)"
            intervention: "Keep AATReceipt separate from ledger events"
            predicted_outcome: |
              Breaks evidence chain. AAT outcomes not in ledger audit trail.
              Violates LAW-01 (receipt-backed gate).
            recommendation: REJECT

        selected_path: "Typed payload in GateReceiptGenerated with gate_id='aat'"

      planning_analysis:
        goal: "Implement typed AAT GateReceipt with evidence binding"
        action_sequence:
          - action: "Define AATGatePayload proto with required fields"
            preconditions: ["TG-FAC-001 proto work done"]
            postconditions: ["Proto with view_commitment, transcript, verifier fields"]
          - action: "Create AATTranscriptBinding wrapper using CAC TranscriptChunk"
            preconditions: ["payload proto defined"]
            postconditions: ["Streaming hash, chunk binding working"]
          - action: "Implement evidence binding validation"
            preconditions: ["transcript binding ready"]
            postconditions: ["artifact_digests, transcript_chain_root verified"]
          - action: "Add AAT-specific fields to GateReceiptGenerated handling"
            preconditions: ["evidence binding ready"]
            postconditions: ["Admission accepts typed AAT receipts"]

        parallelization_factor: 1.3
        adjusted_hours: 16

      satisficing_analysis:
        constraint: "Deliver evidence-bound AAT receipts without full verifier infrastructure"
        good_enough_criteria:
          - "Transcript chain hashing using existing CAC infrastructure"
          - "Evidence binding with artifact_digests field"
          - "Terminal verifier outputs recorded but predicate evaluation deferred"

        deferred_optimizations:
          - "Terminal verifier predicate engine (EP-5, deferred to v4)"
          - "Determinism envelope N-run validation (Phase 2)"
          - "Evidence compression for large transcript bundles"

        satisficing_verdict: |
          Good-enough solution: Use CAC TranscriptChunk, bind artifacts by hash,
          record terminal verifier outputs. Predicate evaluation deferred per EP-5.

      engineering_design_analysis:
        specifications:
          - spec_id: SPEC-FAC-005-A
            title: "AATGatePayload Structure"
            specification: |
              AATGatePayload {
                view_commitment_hash: bytes,
                rcp_manifest_hash: bytes,
                rcp_profile_id: string,
                policy_hash: bytes,
                determinism_class: string,  // DETERMINISTIC, STABLE, FLAKY
                flake_class: string,        // Optional: INFRA, TEST_NONSEMANTIC, etc.
                run_count: uint32,
                run_receipt_hashes: repeated bytes,
                stability_digest: bytes,
                verdict: string,            // PASS, FAIL, NEEDS_INPUT
                transcript_chain_root_hash: bytes,
                transcript_bundle_hash: bytes,
                artifact_digests: repeated bytes,
                terminal_verifier_outputs: repeated TerminalVerifierOutput,
                verifier_policy_hash: bytes,
                selection_policy_id: string,
                risk_tier: string,          // HIGH, MED, LOW
                attestation: bytes,         // Ed25519 signature
              }
            rationale: "All required fields from DD-FAC-0006, typed for validation"

        constraints:
          - constraint: "Must bind to view commitment from RCP"
            satisfied: true
            how: "view_commitment_hash is required field"
          - constraint: "Must support evidence replay verification"
            satisfied: true
            how: "transcript_chain_root_hash enables replay from CAS"

        trade_offs:
          - trade_off: "Message size vs evidence completeness"
            decision: "Include all hashes, store artifacts in CAS"
            rationale: "Hashes are fixed-size; full artifacts in CAS"

      implementation_verdict:
        feasibility: MEDIUM-HIGH
        confidence: 0.67
        critical_blockers: []
        recommendations:
          - "Coordinate with CAC team on TranscriptChunk import"
          - "Define terminal verifier output schema before implementation"

    # --------------------------------------------------------------------------
    # RUN 5: Risk-Tiered AAT Selection (TG-FAC-006)
    # --------------------------------------------------------------------------
    - run_id: MIR-FAC-006
      ticket_group: TG-FAC-006
      name: "Risk-Tiered AAT Selection"

      bayesian_analysis:
        prior_probability: 0.50
        prior_rationale: |
          Risk tier classification is new. No existing risk scoring infrastructure.
          Policy engine exists but needs new rule type.

        evidence_updates:
          - evidence: "PolicyEngine supports custom rule types (policy/engine.rs)"
            likelihood_ratio: 1.2
            posterior_after: 0.55
          - evidence: "Q-RFC-FAC-0007 UNRESOLVED: risk tier classification model"
            likelihood_ratio: 0.7
            posterior_after: 0.46
          - evidence: "Impact expansion exists in impact_map/ module"
            likelihood_ratio: 1.3
            posterior_after: 0.53

        final_probability: 0.53
        confidence_interval: [0.38, 0.68]

      counterfactual_analysis:
        baseline_path: "Policy-defined critical domains with impact expansion heuristics"
        alternative_paths:
          - path_id: CF-006-A
            description: "ML-based risk classification"
            intervention: "Train classifier on historical defect data"
            predicted_outcome: |
              No training data available. Would require significant data collection.
              Implementation timeline extends by 3+ months.
            recommendation: DEFER_TO_PHASE_3

          - path_id: CF-006-B
            description: "Manual risk annotation per file"
            intervention: "Require developers to annotate risk in file headers"
            predicted_outcome: |
              Adoption friction high. Annotation accuracy varies.
              Probability of stale annotations: 0.40.
            recommendation: REJECT

        selected_path: "Policy-defined critical domains (auth/crypto/ledger/tool) + diff scope heuristics"

      planning_analysis:
        goal: "Implement risk-tiered AAT selection policy"
        action_sequence:
          - action: "Define RiskTier enum and classification interface"
            preconditions: []
            postconditions: ["HIGH, MED, LOW tiers defined"]
          - action: "Implement critical domain detection (auth/crypto/ledger/tool)"
            preconditions: ["tier enum ready"]
            postconditions: ["Files in critical domains flagged HIGH"]
          - action: "Implement diff scope heuristics for MED classification"
            preconditions: ["domain detection ready"]
            postconditions: ["Large diffs, cross-module changes flagged MED"]
          - action: "Integrate with AAT gate selection in coordinator"
            preconditions: ["classification ready"]
            postconditions: ["AAT required/sampled based on tier"]
          - action: "Add selection_policy_id to GateReceipt"
            preconditions: ["integration ready"]
            postconditions: ["Audit trail includes selection rationale"]

        parallelization_factor: 1.2
        adjusted_hours: 16

      satisficing_analysis:
        constraint: "Deliver working risk tiers without perfect classification"
        good_enough_criteria:
          - "Critical domains are hardcoded list (configurable in Phase 2)"
          - "HIGH: touches critical domain"
          - "MED: >100 lines changed OR cross-module"
          - "LOW: everything else"

        deferred_optimizations:
          - "Dynamic critical domain learning from defect patterns"
          - "Per-repo risk tier calibration"
          - "Semantic change analysis (not just line count)"

        satisficing_verdict: |
          Good-enough solution: Hardcoded critical domains, simple heuristics.
          Revise based on escape-rate metrics after 90 days.

      engineering_design_analysis:
        specifications:
          - spec_id: SPEC-FAC-006-A
            title: "Risk Tier Classification Rules"
            specification: |
              HIGH if any:
              - Diff touches crates/*/src/crypto/
              - Diff touches crates/*/src/auth/
              - Diff touches crates/*/src/ledger/
              - Diff touches crates/*/src/tool/
              - Diff touches policy files (*.policy.yaml)

              MED if any:
              - Diff > 100 lines changed
              - Diff spans > 2 crates
              - Diff touches test infrastructure

              LOW otherwise
            rationale: "Conservative initial rules; can be relaxed based on data"

        constraints:
          - constraint: "Must not block safe refactors"
            satisfied: PARTIAL
            how: "LOW tier uses sampling; nightly full AAT catches gaps"
          - constraint: "Must preserve merge cadence"
            satisfied: true
            how: "Sampling for LOW, conditional for MED"

        trade_offs:
          - trade_off: "Safety vs throughput"
            decision: "Always AAT for HIGH, sampling for LOW"
            rationale: "Critical changes justify cost; low-risk can be sampled"

      implementation_verdict:
        feasibility: MEDIUM
        confidence: 0.53
        critical_blockers:
          - "Q-RFC-FAC-0007 needs resolution for precise classification"
        recommendations:
          - "Propose concrete resolution for Q-RFC-FAC-0007"
          - "Plan 90-day review of classification accuracy"

    # --------------------------------------------------------------------------
    # RUN 6: Terminal Verifier Policy (TG-FAC-005 dependency, EP-5)
    # --------------------------------------------------------------------------
    - run_id: MIR-FAC-007
      ticket_group: TG-FAC-005
      name: "Terminal Verifier Policy (EP-5)"

      bayesian_analysis:
        prior_probability: 0.35
        prior_rationale: |
          SA2-RFC0015-F003: Terminal Verifier has no existing pattern.
          Requires entirely new trait, schema, predicate engine.

        evidence_updates:
          - evidence: "PolicyEngine provides predicate evaluation model"
            likelihood_ratio: 1.2
            posterior_after: 0.39
          - evidence: "No existing verifier infrastructure in codebase"
            likelihood_ratio: 0.8
            posterior_after: 0.35
          - evidence: "EP-5 explicitly deferred to v4"
            likelihood_ratio: 1.0
            posterior_after: 0.35

        final_probability: 0.35
        confidence_interval: [0.20, 0.50]

      counterfactual_analysis:
        baseline_path: "New evidence/verifier.rs with TerminalVerifier trait"
        alternative_paths:
          - path_id: CF-007-A
            description: "External verifier service"
            intervention: "Verifier runs in separate process, RPC interface"
            predicted_outcome: |
              Adds operational complexity. Latency concerns.
              Probability of timeout issues: 0.25.
            recommendation: DEFER_ANALYSIS

        selected_path: "Deferred to v4; record verifier outputs now, evaluate later"

      planning_analysis:
        goal: "Define terminal verifier infrastructure (deferred to v4)"
        action_sequence:
          - action: "Define TerminalVerifierOutput proto message"
            preconditions: []
            postconditions: ["Output schema ready for recording"]
          - action: "Record verifier outputs in AAT receipt without predicate evaluation"
            preconditions: ["output proto defined"]
            postconditions: ["Outputs captured for future evaluation"]
          - action: "[v4] Define TerminalVerifier trait"
            preconditions: ["outputs being recorded"]
            postconditions: ["Trait interface defined"]
          - action: "[v4] Implement verifier predicate engine"
            preconditions: ["trait defined"]
            postconditions: ["Machine predicates evaluated"]

        parallelization_factor: 1.0
        adjusted_hours: 17

      satisficing_analysis:
        constraint: "Deliver AAT without full verifier; enable future enforcement"
        good_enough_criteria:
          - "Record terminal verifier outputs in AAT receipt"
          - "Define allowed_verifier_kinds enum"
          - "Predicate evaluation is log-only until v4"

        deferred_optimizations:
          - "Full predicate evaluation engine"
          - "Verifier policy versioning"
          - "Holdout suite integration"

        satisficing_verdict: |
          Good-enough for v2->v4 transition: Record outputs, defer enforcement.
          Full implementation in Phase 2 per EP-5 deferral.

      engineering_design_analysis:
        specifications:
          - spec_id: SPEC-FAC-007-A
            title: "TerminalVerifierOutput Schema"
            specification: |
              TerminalVerifierOutput {
                verifier_kind: string,  // exit_code, snapshot_diff, test_report, invariant_check
                scenario_id: string,
                output_hash: bytes,     // Hash of full output in CAS
                predicate_satisfied: optional bool,  // null until v4 enforcement
                predicate_id: string,
              }
            rationale: "Captures outputs now; predicate field ready for v4"

        constraints:
          - constraint: "Must not block AAT in Phase 1"
            satisfied: true
            how: "Predicate is optional; outputs recorded for audit"

        trade_offs:
          - trade_off: "Early enforcement vs adoption"
            decision: "Defer enforcement to v4"
            rationale: "Allow AAT adoption without verifier friction"

      implementation_verdict:
        feasibility: LOW (for full implementation)
        feasibility_partial: HIGH (for output recording only)
        confidence: 0.35
        critical_blockers: []
        recommendations:
          - "Implement output recording in Phase 1"
          - "Full predicate engine in Phase 2 (EP-5)"

  # ============================================================================
  # SECTION 2: FRICTION POINTS AND BLOCKERS
  # ============================================================================

  friction_points:

    critical_blockers:
      - blocker_id: FB-001
        title: "Q-RFC-FAC-0003: COI Grouping Policy Unresolved"
        severity: CRITICAL
        description: |
          Formal COI grouping policy and KeyPolicy artifact definition not specified.
          Blocks TB-0007 (AAT Executor Custody Boundary) implementation.
        affects: [TG-FAC-001, TG-FAC-006]
        proposed_resolution: |
          Define KeyPolicy as YAML artifact under CAC governance:
          - custody_domain: string (e.g., "apm2-aat-prod")
          - key_ids: list of public key hashes
          - coi_group: string (e.g., "executor-independent")
          - role: string (e.g., "AAT_EXECUTOR", "COORDINATOR")

          COI rule: GateLease rejected if issuer_actor_id and executor_actor_id
          share custody_domain with changeset author.
        resolution_confidence: 0.70

      - blocker_id: FB-002
        title: "Q-RFC-FAC-0007: Risk Tier Classification Model Unresolved"
        severity: MAJOR
        description: |
          Risk tier classification signals not formally specified.
          Affects AAT selection policy accuracy.
        affects: [TG-FAC-006]
        proposed_resolution: |
          Start with hardcoded critical domains:
          - HIGH: crypto/, auth/, ledger/, tool/, *.policy.yaml
          - MED: >100 LOC, cross-crate, test infrastructure
          - LOW: all other changes

          Revise after 90-day escape-rate analysis.
        resolution_confidence: 0.65

      - blocker_id: FB-003
        title: "Q-RFC-FAC-0006: Determinism N by Risk Tier Unresolved"
        severity: MAJOR
        description: |
          What is N for stability checks by risk tier?
          Affects TG-FAC-007 (Determinism Envelope).
        affects: [TG-FAC-007]
        proposed_resolution: |
          Start with N=3 for HIGH risk, N=2 for MED, N=1 for LOW.
          Determinism envelope is Phase 2; can adjust based on data.
        resolution_confidence: 0.60

    major_friction:
      - friction_id: MF-001
        title: "Terminal Verifier Pattern Gap"
        severity: MAJOR
        description: |
          SA2-RFC0015-F003: No existing terminal verifier infrastructure.
        affects: [TG-FAC-005]
        mitigation: |
          Defer full verifier to v4 (EP-5). Record outputs now.

      - friction_id: MF-002
        title: "Domain Separator Prefix Format Underdetermined"
        severity: MAJOR
        description: |
          SA2-RFC0015-F005: Multiple valid interpretations for domain separation.
          Could cause signature incompatibility between implementations.
        affects: [TG-FAC-001]
        mitigation: |
          Resolve with SPEC-FAC-001-A: UTF-8 prefix + canonical bytes.
          Document in domain_separator.rs before implementation.

    minor_friction:
      - friction_id: LF-001
        title: "Q-RFC-FAC-0009: AAT Reuse Scope"
        severity: MINOR
        description: "Should AAT reuse be allowed for LOW risk only or MED with waiver?"
        affects: [TG-FAC-008]
        mitigation: "Start with LOW-only; expand based on cache integrity metrics."

      - friction_id: LF-002
        title: "Q-RFC-FAC-0010: GitHub Branch Protection Contract"
        severity: MINOR
        description: "Exact GitHub settings for FAC bypass prevention not specified."
        affects: [TG-FAC-003]
        mitigation: "Document requirements; runtime verification deferred."

      - friction_id: LF-003
        title: "Q-RFC-FAC-0004: CI Runner Image Digests"
        severity: MINOR
        description: "Hosted CI may not provide stable runner image digests for L1+ attestation."
        affects: [TG-FAC-004]
        mitigation: "L0 attestation (webhook + artifact hashes) sufficient for Phase 1."


      - group_id: TG-FAC-011
        name: "Atomic Merge Receipt"
        original_range: "2-3"
        original_midpoint: 2.5
        phase: PHASE-1
        dependencies: [TG-FAC-001]

      - group_id: TG-FAC-012
        name: "Bounded Retries and Echo-Trap"
        original_range: "1-2"
        original_midpoint: 1.5
        phase: PHASE-1
        dependencies: [TG-FAC-001]

    totals:
      original_midpoint_sum: 33

    effort_conversion:
      recommended_team_size: 3

  # ============================================================================
  # SECTION 4: QUESTION RESOLUTIONS
  # ============================================================================

  question_resolutions:

    - question_id: Q-RFC-FAC-0003
      question: "Formal COI grouping policy and KeyPolicy artifact definition"
      status: PROPOSED_RESOLUTION
      proposed_resolution: |
        **KeyPolicy Artifact Schema:**

        ```yaml
        key_policy:
          policy_id: "policy-aat-prod-001"
          custody_domain: "apm2-aat-prod"
          keys:
            - key_id: "sha256:abc123..."
              role: AAT_EXECUTOR
              coi_group: "executor-independent"
              issued_at: "2026-01-15T00:00:00Z"
              expires_at: "2027-01-15T00:00:00Z"
          coi_rules:
            - rule_id: "COI-001"
              statement: "Executor must not share custody_domain with changeset author"
              enforcement: "GateLease rejected on violation"
        ```

        **COI Enforcement:**
        1. At lease issuance, extract author_key_id from ChangeSetIngested
        2. Lookup author's custody_domain from KeyPolicy
        3. Lookup executor's custody_domain from KeyPolicy
        4. If same custody_domain, reject lease with UNAUTHORIZED_EXECUTOR

        **Governance:**
        - KeyPolicy artifacts under CAC governance
        - Changes require AUTH_SECURITY signoff
        - KeyRotated events maintain chain of custody
      resolution_confidence: 0.70
      implementation_impact: |
        Adds KeyPolicy schema validation and COI check integration to TG-FAC-001.

    - question_id: Q-RFC-FAC-0006
      question: "Determinism N by risk tier"
      status: PROPOSED_RESOLUTION
      proposed_resolution: |
        **Initial Values:**
        - HIGH risk: N=3 (3 identical runs required)
        - MED risk: N=2 (2 identical runs required)
        - LOW risk: N=1 (single run sufficient)

        **Stability Digest Calculation:**
        stability_digest = BLAKE3(sort(run_receipt_hashes))

        **Enforcement:**
        - All N runs must produce identical verdict
        - stability_digest must match across runs
        - Flake classification triggers on any mismatch

        **Calibration:**
        - Review after initial Phase 2 data collection
        - Adjust N based on flake rate and throughput impact
      resolution_confidence: 0.60
      implementation_impact: |
        Affects TG-FAC-007 (Phase 2). No Phase 1 impact.
        Determinism envelope deferred per original plan.

    - question_id: Q-RFC-FAC-0007
      question: "Risk tier classification model"
      status: PROPOSED_RESOLUTION
      proposed_resolution: |
        **Phase 1 Classification Rules:**

        HIGH if ANY:
        - Diff touches crates/*/src/crypto/**
        - Diff touches crates/*/src/auth/**
        - Diff touches crates/*/src/ledger/**
        - Diff touches crates/*/src/tool/**
        - Diff touches *.policy.yaml
        - Diff modifies proto/*.proto
        - PR marked with label "security-critical"

        MED if ANY (and not HIGH):
        - Diff > 100 lines changed (insertions + deletions)
        - Diff spans > 2 crates
        - Diff touches crates/*/tests/**
        - Diff modifies Cargo.toml dependency versions

        LOW:
        - All other changes

        **Configuration:**
        - Critical domains list in fac_policy.yaml
        - Thresholds (100 lines, 2 crates) configurable

        **Escape Rate Tracking:**
        - Monitor defects that escaped LOW-tier sampling
        - Adjust thresholds if escape rate > 5%
      resolution_confidence: 0.65
      implementation_impact: |
        Enables TG-FAC-006 implementation.
        Requires fac_policy.yaml schema definition.

    - question_id: Q-RFC-FAC-0009
      question: "AAT reuse scope"
      status: PROPOSED_RESOLUTION
      proposed_resolution: |
        **Phase 1 Rule:**
        - AAT reuse allowed ONLY for LOW risk changes
        - Reuse requires:
          - Identical rcp_manifest_hash
          - Identical policy_hash
          - Same terminal verifier outputs
          - Cache entry < 7 days old

        **Reuse Validation:**
        - Emit AATResultReused event (domain-separated signature)
        - Include original receipt_id for provenance chain

        **Phase 2 Expansion:**
        - Consider MED reuse with explicit waiver
        - Require AdjudicationRequested(WAIVER) for MED reuse
        - Track cache hit rate and defect correlation
      resolution_confidence: 0.70
      implementation_impact: |
        Affects TG-FAC-008. Scope limited to LOW reduces implementation complexity.

  # ============================================================================
  # SECTION 6: CONFIDENCE ASSESSMENT
  # ============================================================================

  confidence_assessment:

    overall_implementation_feasibility:
      verdict: FEASIBLE_WITH_REMEDIATION
      confidence: 0.68
      confidence_interval: [0.55, 0.81]

    per_component_confidence:
      - component: "Gate Event Infrastructure (TG-FAC-001)"
        feasibility: HIGH
        confidence: 0.73
        rationale: "Strong existing patterns; proto extension validated"

      - component: "OCAP Context Firewall (TG-FAC-002)"
        feasibility: MEDIUM
        confidence: 0.66
        rationale: "Integration point resolved; new manifest schema needed"

      - component: "Projection Watchdog (TG-FAC-003)"
        feasibility: MEDIUM
        confidence: 0.50
        rationale: "New module; Q-RFC-FAC-0010 unresolved"

      - component: "CI Evidence Import (TG-FAC-004)"
        feasibility: MEDIUM
        confidence: 0.60
        rationale: "L0 attestation feasible; L1+ deferred"

      - component: "Typed AAT GateReceipt (TG-FAC-005)"
        feasibility: MEDIUM-HIGH
        confidence: 0.67
        rationale: "Good CAC reuse; verifier deferred"

      - component: "Risk-Tiered Selection (TG-FAC-006)"
        feasibility: MEDIUM
        confidence: 0.53
        rationale: "Classification model needs resolution"

      - component: "Determinism Envelope (TG-FAC-007)"
        feasibility: MEDIUM
        confidence: 0.55
        rationale: "Phase 2; depends on N resolution"

      - component: "AAT Reuse (TG-FAC-008)"
        feasibility: MEDIUM
        confidence: 0.60
        rationale: "LOW-only scope simplifies"

      - component: "Quorum/Sandboxing (TG-FAC-009)"
        feasibility: MEDIUM
        confidence: 0.55
        rationale: "Phase 2; sandboxing is well-understood"

      - component: "Invariant Specs (TG-FAC-010)"
        feasibility: HIGH
        confidence: 0.70
        rationale: "Schema-level enforcement; straightforward"

      - component: "Merge Receipt (TG-FAC-011)"
        feasibility: HIGH
        confidence: 0.75
        rationale: "Follows GateReceipt pattern"

      - component: "Echo-Trap (TG-FAC-012)"
        feasibility: HIGH
        confidence: 0.70
        rationale: "Signature pattern detection; well-defined"

    go_no_go_recommendation:
      recommendation: GO_WITH_REMEDIATION
      conditions:
        - "Resolve Q-RFC-FAC-0003 (COI policy) before TG-FAC-001 completion"
        - "Resolve Q-RFC-FAC-0007 (risk tiers) before TG-FAC-006 start"
        - "Document domain separator format (SPEC-FAC-001-A) before implementation"

      critical_success_factors:
        - "Weekly sync with CAC team on TranscriptChunk integration"
        - "Defer Terminal Verifier predicate engine to Phase 2"
        - "Monitor context miss rate during rollout (target <15%)"

  # ============================================================================
  # SECTION 7: SUMMARY AND RECOMMENDATIONS
  # ============================================================================

  summary:
    agent: SA-2
    role: "Implementation Feasibility"
    session: "20260129-RFC0015-FINALIZE"

    key_findings:
      - finding: "Gate Event Infrastructure is feasible with existing patterns"
        confidence: 0.73

      - finding: "Context Firewall integration point resolved; manifest schema needed"
        confidence: 0.66

      - finding: "Terminal Verifier should be deferred to v4 (EP-5)"
        confidence: 0.80

    blockers_requiring_resolution:
      - Q-RFC-FAC-0003 (COI grouping)
      - Q-RFC-FAC-0007 (risk tier classification)
      - SA2-RFC0015-F005 (domain separator format)

    deferred_items:
      - EP-5 Terminal Verifier predicate engine
      - TG-FAC-007 Determinism Envelope (Phase 2)
      - TG-FAC-009 Quorum/Sandboxing (Phase 2)
      - Q-RFC-FAC-0010 Runtime branch protection verification

    final_verdict: |
      RFC-0015 FAC implementation is FEASIBLE with identified remediations.
      Critical blockers (COI policy, risk tiers, domain separator format) must be
      resolved before implementation begins. Terminal Verifier enforcement deferred
      to Phase 2 per EP-5. Overall implementation probability: 68%.

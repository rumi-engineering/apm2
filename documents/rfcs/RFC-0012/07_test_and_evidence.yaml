rfc_test_and_evidence:
  schema_version: "2026-01-26"
  template_version: "2026-01-26"

  test_strategy:
    overview: |
      Coordination layer testing follows established patterns from SessionReducer
      and WorkReducer. Emphasis on property-based testing for reducer determinism
      and integration testing for controller behavior.

    test_categories:
      - category: UNIT_TESTS
        description: "Component-level tests for types, reducer, and controller logic"
        coverage_targets:
          - target: "CoordinationState serialization"
            verification: "Round-trip serialize/deserialize equality"
          - target: "Event application"
            verification: "Each event type correctly updates state"
          - target: "Budget arithmetic"
            verification: "Consumption tracking and ceiling checks"
          - target: "Stop condition evaluation"
            verification: "Priority ordering of stop conditions"

      - category: PROPERTY_TESTS
        description: "Invariant verification via property-based testing"
        properties:
          - property: "Reducer determinism"
            description: "Same event sequence produces same state"
            verification: "Compare replay-from-genesis with replay-from-checkpoint"
          - property: "Reducer idempotency"
            description: "Applying same event twice is no-op"
            verification: "State unchanged after duplicate event application"
          - property: "Budget monotonicity"
            description: "Budget consumption never decreases"
            verification: "Property test over random event sequences"
          - property: "Binding completeness"
            description: "Every bound session is eventually unbound"
            verification: "No orphan bindings after coordination completion"

      - category: INTEGRATION_TESTS
        description: "Multi-component tests with real ledger and reducers"
        scenarios:
          - scenario: "Happy path: work queue completion"
            description: "Process 3 work items successfully"
            verification: "Receipt shows WORK_COMPLETED, all items succeeded"
          - scenario: "Circuit breaker: 3 consecutive failures"
            description: "Mock session failures until circuit breaker triggers"
            verification: "Receipt shows CIRCUIT_BREAKER_TRIGGERED"
          - scenario: "Budget exhaustion: episode limit"
            description: "Process work until max_episodes reached"
            verification: "Receipt shows BUDGET_EXHAUSTED(Episodes)"
          - scenario: "Budget exhaustion: duration limit"
            description: "Process work until max_duration_ms reached"
            verification: "Receipt shows BUDGET_EXHAUSTED(Duration)"
          - scenario: "Work freshness failure"
            description: "Work state changes between check and spawn"
            verification: "Coordination proceeds to next item"

      - category: E2E_TESTS
        description: "CLI-level tests with real session spawning"
        scenarios:
          - scenario: "apm2 coordinate with valid work queue"
            verification: "Command exits 0, receipt JSON valid"
          - scenario: "apm2 coordinate with invalid budget"
            verification: "Command exits 2, error message"
          - scenario: "apm2 coordinate --quiet mode"
            verification: "No progress events, only final receipt"

  evidence_requirements:
    prd_evidence_refs:
      - id: EVID-COORD-0001
        description: "Coordination receipt proving execution outcomes"
        verification: "Receipt includes all required fields, stored in CAS"
      - id: EVID-COORD-0002
        description: "Circuit breaker behavior verification"
        verification: "Property tests demonstrate reset-on-success and trigger-on-3-failures"
      - id: EVID-COORD-0003
        description: "Budget enforcement verification"
        verification: "Integration tests confirm termination at budget ceiling"
      - id: EVID-COORD-0004
        description: "Work freshness check verification"
        verification: "Test shows freshness failure handling"
      - id: EVID-COORD-0005
        description: "Reducer determinism and event recording"
        verification: "Property tests and golden event sequences"
      - id: EVID-COORD-0006
        description: "Serial execution loop verification"
        verification: "Integration test confirms one session at a time"
      - id: EVID-COORD-0007
        description: "CLI command integration"
        verification: "E2E tests for apm2 coordinate"

  test_infrastructure:
    dependencies:
      - name: proptest
        purpose: "Property-based testing for reducer invariants"
      - name: tokio-test
        purpose: "Async test utilities for controller"
      - name: assert_cmd
        purpose: "CLI integration testing"
      - name: tempfile
        purpose: "Isolated test directories"

    mock_requirements:
      - name: MockSessionSpawner
        purpose: "Control session outcomes in tests"
        interface: "async fn spawn(work_id) -> Result<SessionId, Error>"
      - name: MockLedger
        purpose: "Controlled event injection for property tests"
        interface: "fn append(event) -> EventId; fn replay() -> Vec<EventRecord>"

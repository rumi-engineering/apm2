rfc_meta:
  schema_version: "2026-01-30"
  template_version: "2026-01-23"

  rfc:
    id: RFC-0017
    title: "Daemon as Control Plane: xtask Demotion, Capability-Minted Episodes, Receipt-Backed Orchestration"
    status: APPROVED
    created_date: "2026-01-30"
    last_updated_date: "2026-01-30"
    version: "v4"
    version_history:
      - version: "v4"
        date: "2026-01-30"
        phase: "v4 (Standard)"
        notes: |
          RFC v4 completed via rfc-council FINALIZE mode. Council deliberation
          with 3 subagents (SA-1 Structural, SA-2 Feasibility, SA-3 Security)
          produced 18 findings (0 BLOCKER, 7 MAJOR, 9 MINOR, 3 INFO).

          All MAJOR findings remediated:
          - OQ-008, OQ-009 formalized with deferral rationale and future RFC refs
          - OQ-010 resolved with concrete SSH mediation design
          - ADV-009, ADV-010, ADV-011 added for threat coverage gaps
          - Proto message specification delegated to ticket scope

          RFC is now implementation-ready for DECOMPOSE phase.
      - version: "v2"
        date: "2026-01-30"
        phase: "v2 (Grounded)"
        notes: |
          RFC v2 completed via rfc-council EXPLORE mode. All open questions
          (OQ-001 through OQ-007) resolved with codebase evidence. Key findings:
          - Protocol decision: Protobuf Runtime Protocol adopted (OQ-001a)
          - Capability structures: 5 existing structures found, no cousins needed
          - Tool execution: 5-layer architecture with PreToolUse hook mediation
          - Session persistence: Ledger-driven model with recovery infrastructure
          - Signing: Comprehensive Ed25519 + canonicalization exists
          - Governance: PolicyEngine exists but not wired to daemon
          - xtask: Only 4 of 15 commands in scope for daemon control plane
      - version: "v0"
        date: "2026-01-30"
        phase: "v0 (Discovery)"
        notes: |
          Initial RFC v0 created from PRD-0010 via rfc-council CREATE mode.
          This RFC establishes the daemon as the sole control plane for work
          orchestration, with policy-resolved capability minting, lease-gated
          episode spawn, and receipt-backed state transitions.
    abstract: |
      RFC-0017 elevates apm2-daemon to the sole control plane for APM2 work
      orchestration. All episode spawns, tool invocations, and state transitions
      flow through authenticated daemon IPC with policy-resolved capabilities
      and receipt-backed evidence.

      Key invariants:
      - Capabilities are minted by governance policy, never requested by callers
      - Episodes require PolicyResolvedForChangeSet; gate executors require GateLeaseIssued
      - Sessions receive ephemeral handles only; credentials are broker-mediated
      - Context firewall violations terminate sessions immediately (fail-closed)
      - SoD enforced via custody domain separation at spawn time
      - All state transitions emit Ed25519 signed events

      xtask commands are demoted to thin CLI wrappers during deprecation, then
      removed entirely once telemetry confirms migration complete.

  binds_to_prd:
    prd_id: PRD-0010
    prd_base_path: "documents/prds/PRD-0010/"
    requirement_registry_ref: "07_traceability.yaml#prd_traceability.requirement_registry"
    evidence_bundle_ref: "12_evidence_bundle.yaml#prd_evidence_bundle.bundle"
    prd_meta_ref: "00_meta.yaml#prd_meta"
    rationale: |
      PRD-0010 specifies the execution-layer enforcement mechanisms required to
      prevent bypass of FAC (PRD-0009) guarantees. This RFC provides the technical
      design for daemon-as-control-plane, closing the gap between admission protocol
      and execution substrate.

  protocol_profile:
    id: DAEMON-CONTROL-PLANE-001
    applies: true
    inherited_from_prd: true
    profile_ref: "documents/prds/PRD-0010/00_meta.yaml#prd_meta.protocol_profile"

  custody:
    producing_agent_roles:
      - AGENT_AUTHOR
      - AGENT_ARCHITECT
    responsible_domains:
      - DOMAIN_DAEMON
      - DOMAIN_KERNEL
      - DOMAIN_EXECUTION
      - DOMAIN_SECURITY
    authority_signoffs_required:
      - AUTH_ARCHITECTURE
      - AUTH_SECURITY
      - AUTH_RELIABILITY
      - AUTH_PRODUCT

  refs:
    standards:
      requirement_schema: "standards/schemas/02_requirement.schema.yaml#requirement_schema"
      evidence_artifact_schema: "standards/schemas/01_evidence_artifact.schema.yaml#evidence_artifact_schema"
      quality_coverage_schema: "standards/schemas/03_quality_coverage.schema.yaml#quality_coverage_schema"
      gate_review_schema: "standards/schemas/06_gate_review.schema.yaml#gate_review_schema"
      waiver_schema: "standards/schemas/05_waiver.schema.yaml#waiver_schema"
      ticket_meta_schema: "standards/schemas/04_ticket_meta.schema.yaml#ticket_meta_schema"
      lint_spec: "standards/lint/LINT_SPEC.yaml#lint_spec"
    laws:
      - id: LAW-01
        name: "Receipt-Backed Gate for Authoritative Promotion"
        ref: "documents/theory/laws.json"
      - id: LAW-02
        name: "Context Sufficiency Observation"
        ref: "documents/theory/laws.json"
      - id: LAW-03
        name: "Monotone Ledger vs. Overwritable Projection"
        ref: "documents/theory/laws.json"
      - id: LAW-04
        name: "Stochastic Stability Contracts"
        ref: "documents/theory/laws.json"
      - id: LAW-05
        name: "OCAP and Capability Scoping"
        ref: "documents/theory/laws.json"
      - id: LAW-06
        name: "MDL as Gated Budget"
        ref: "documents/theory/laws.json"
      - id: LAW-11
        name: "Idempotent Tool Calls"
        ref: "documents/theory/laws.json"
      - id: LAW-12
        name: "Episode Budget Enforcement"
        ref: "documents/theory/laws.json"
      - id: LAW-13
        name: "Canonical Encodings"
        ref: "documents/theory/laws.json"
      - id: LAW-15
        name: "Measurement Integrity"
        ref: "documents/theory/laws.json"
    related_documents:
      glossary: "documents/skills/glossary/SKILL.md"
      daemon_glossary: "documents/skills/glossary/references/daemon.md"
      lease_glossary: "documents/skills/glossary/references/lease_and_budget.md"
      fac_rfc: "documents/rfcs/RFC-0015/"
      fac_prd: "documents/prds/PRD-0009/"
      work_substrate: "documents/prds/PRD-0004/"
    protocol_refs:
      event_schema: "proto/kernel_events.proto"
      tool_protocol: "proto/tool_protocol.proto"

  implementation:
    language: Rust
    edition: "2024"
    primary_crates:
      - apm2-daemon
      - apm2-core
      - apm2-cli

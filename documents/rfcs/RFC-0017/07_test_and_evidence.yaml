rfc_test_and_evidence:
  schema_version: "2026-01-30"
  template_version: "2026-01-23"

  test_strategy:
    overview: |
      Testing for daemon-as-control-plane focuses on three areas:
      1. Security boundaries (adversarial tests)
      2. Correctness (unit + integration tests)
      3. Performance (benchmarks for latency requirements)

    test_categories:
      - category: ADVERSARIAL
        description: "Tests that attempt to violate security invariants"
        tests:
          - test_id: ADV-001
            name: "Agent calls ClaimWork"
            description: "Agent session attempts privileged ClaimWork endpoint"
            expected: "PERMISSION_DENIED; session continues operating"
            requirement_ids: [REQ-DCP-0001]

          - test_id: ADV-002
            name: "Agent calls SpawnEpisode"
            description: "Agent session attempts privileged SpawnEpisode endpoint"
            expected: "PERMISSION_DENIED; session continues operating"
            requirement_ids: [REQ-DCP-0001]

          - test_id: ADV-003
            name: "Agent reads outside context pack"
            description: "Agent requests file read outside ContextPack allowlist"
            expected: "ToolDecided=DENY; SessionTerminated; SIGTERM sent"
            requirement_ids: [REQ-DCP-0005]

          - test_id: ADV-004
            name: "GateOutcome without lease"
            description: "Attempt GateOutcome for gate without valid GateLeaseIssued"
            expected: "GATE_LEASE_MISSING error; outcome rejected"
            requirement_ids: [REQ-DCP-0003]

          - test_id: ADV-005
            name: "ClaimWork with capability parameters"
            description: "Operator attempts ClaimWork with requester-supplied capabilities"
            expected: "CAPABILITY_REQUEST_REJECTED; only (actor_id, role) accepted"
            requirement_ids: [REQ-DCP-0001]

          - test_id: ADV-006
            name: "SoD violation - same domain author+reviewer"
            description: "Spawn gate executor with overlapping custody domain"
            expected: "LeaseIssueDenied with reason=SOD_VIOLATION"
            requirement_ids: [REQ-DCP-0006]

          - test_id: ADV-007
            name: "Forge unsigned receipt"
            description: "Ingest unsigned event to ledger"
            expected: "Event rejected at ledger ingestion"
            requirement_ids: [REQ-DCP-0007]

          - test_id: ADV-008
            name: "xtask direct execution post-removal"
            description: "Run xtask command after Phase 5 removal"
            expected: "Command not found"
            requirement_ids: []

          # ===================================================================
          # ADV-009 through ADV-011: Added during FINALIZE phase 2026-01-30
          # Per RFC Council findings FND-RFC-0017-SA3-001, SA3-003, SA3-006
          # ===================================================================
          - test_id: ADV-009
            name: "Container UID remapping bypass attempt"
            description: |
              Deploy daemon in container WITH user namespace remapping enabled.
              Attempt connection from a process running as remapped UID that maps
              to privileged host UID. Validates RISK-RFC-0017-002 mitigation.
            expected: |
              Connection rejected OR correctly identified as different principal.
              SO_PEERCRED returns container-namespace UID; daemon must either:
              (a) Reject connections when user namespaces detected, or
              (b) Correctly map container UID to non-privileged principal.
            requirement_ids: [REQ-DCP-0008]
            threat_coverage: [TH-002]
            added_by: "RFC Council FINALIZE - FND-RFC-0017-SA3-001"

          - test_id: ADV-010
            name: "Rapid-fire requests after context deny"
            description: |
              Session issues FileRead for forbidden path (outside context pack).
              Immediately issue 100 additional requests in tight loop before
              SIGTERM can be processed. Tests deny-terminate atomicity and
              validates MIT-007 residual risk handling.
            expected: |
              ONLY first request gets ToolDecided=DENY response.
              All subsequent requests either:
              (a) Fail with SESSION_TERMINATED error, or
              (b) Fail with connection closed/reset.
              No request after first DENY should succeed or produce ALLOW decision.
            requirement_ids: [REQ-DCP-0005]
            threat_coverage: [TH-007]
            added_by: "RFC Council FINALIZE - FND-RFC-0017-SA3-003"

          - test_id: ADV-011
            name: "Session credential probe"
            description: |
              Session attempts to access credentials that should be broker-held:
              1. Read environment variables: SSH_AUTH_SOCK, AWS_SECRET_ACCESS_KEY,
                 AWS_ACCESS_KEY_ID, GITHUB_TOKEN, GH_TOKEN
              2. Attempt FileRead of ~/.ssh/id_ed25519, ~/.ssh/id_rsa
              3. Attempt FileRead of ~/.config/gh/hosts.yml
              Validates INV-0002 (sessions cannot access credentials directly).
            expected: |
              1. Environment variables NOT present in session process scope
                 (daemon must sanitize environment before session spawn)
              2. File reads blocked by context firewall (credentials not in allowlist)
                 -> ToolDecided=DENY; SessionTerminated
              3. No credential data ever reaches session
            requirement_ids: [REQ-DCP-0004]
            threat_coverage: [TH-005, TH-006]
            invariant_tested: INV-0002
            added_by: "RFC Council FINALIZE - FND-RFC-0017-SA3-006"

      - category: UNIT
        description: "Isolated unit tests for individual components"
        tests:
          - test_id: UT-IPC-001
            name: "Peer credential extraction"
            description: "SO_PEERCRED correctly extracts UID/GID from connection"
            component: "Daemon IPC Handler"

          - test_id: UT-IPC-002
            name: "Capability token generation"
            description: "Tokens are unique, time-bounded, and verifiable"
            component: "Daemon IPC Handler"

          - test_id: UT-WORK-001
            name: "Capability manifest sealing"
            description: "Manifest is correctly sealed with hash"
            component: "Work Orchestrator"

          - test_id: UT-WORK-002
            name: "Context pack sealing"
            description: "Pack is correctly sealed with hash"
            component: "Work Orchestrator"

          - test_id: UT-SPAWN-001
            name: "Policy resolution check"
            description: "SpawnEpisode correctly queries for PolicyResolvedForChangeSet"
            component: "Episode Spawner"

          - test_id: UT-SPAWN-002
            name: "Lease validation"
            description: "GATE_EXECUTOR spawn validates lease binding"
            component: "Episode Spawner"

          - test_id: UT-SPAWN-003
            name: "SoD domain check"
            description: "Custody domain overlap detection is correct"
            component: "Episode Spawner"

          - test_id: UT-TOOL-001
            name: "Tool allowlist validation"
            description: "Tool broker correctly validates against manifest"
            component: "Tool Broker"

          - test_id: UT-TOOL-002
            name: "Context firewall deny"
            description: "Reads outside allowlist trigger deny + terminate"
            component: "Tool Broker"

          - test_id: UT-SIGN-001
            name: "Event signing"
            description: "Events are Ed25519 signed with correct domain prefix"
            component: "Event Signer"

          - test_id: UT-SIGN-002
            name: "Signature verification"
            description: "Invalid signatures are rejected"
            component: "Event Signer"

          - test_id: UT-SESS-001
            name: "Session registry persistence"
            description: "Session state survives daemon restart"
            component: "Session Manager"

          - test_id: UT-SESS-002
            name: "LEASE_REVOKED signal"
            description: "Sessions receive signal within timeout"
            component: "Session Manager"

      - category: INTEGRATION
        description: "End-to-end flow tests"
        tests:
          - test_id: INT-001
            name: "Full work claim flow"
            description: "Operator claims work, receives assignment with sealed pack"
            flow: "ClaimWork -> PolicyResolution -> CapabilityMinting -> PackSealing"

          - test_id: INT-002
            name: "Full episode spawn flow"
            description: "Operator spawns episode, session receives ephemeral handle"
            flow: "SpawnEpisode -> PolicyCheck -> LeaseCheck -> SoDCheck -> SessionCreate"

          - test_id: INT-003
            name: "Full tool mediation flow"
            description: "Session requests tool, broker validates and executes"
            flow: "RequestTool -> CapabilityCheck -> FirewallCheck -> Execute -> EventEmit"

          - test_id: INT-004
            name: "Context firewall violation flow"
            description: "Session requests forbidden read, session is terminated"
            flow: "RequestTool -> FirewallDeny -> SessionTerminate -> SIGTERM"

          - test_id: INT-005
            name: "Daemon crash recovery flow"
            description: "Daemon restarts, sessions receive LEASE_REVOKED"
            flow: "DaemonRestart -> LoadRegistry -> BroadcastRevoke -> SessionTerminate"

      - category: BENCHMARK
        description: "Performance benchmarks for latency requirements"
        tests:
          - test_id: BENCH-001
            name: "Spawn acknowledgment latency"
            description: "session_id returned in <100ms p99"
            requirement_id: REQ-DCP-0009
            methodology: |
              Warm daemon, local Unix socket, 1000 iterations,
              measure time from SpawnEpisode call to session_id return.

          - test_id: BENCH-002
            name: "Session ready latency"
            description: "Pack sealed, policy checked, sandbox ready in <2s p99"
            requirement_id: REQ-DCP-0010
            methodology: |
              Warm daemon, local Unix socket, 100 iterations,
              measure time from SpawnEpisode call to sandbox_ready signal.

          - test_id: BENCH-003
            name: "Tool mediation overhead"
            description: "Mediation (excluding execution) in <5ms p50"
            requirement_id: REQ-DCP-0011
            methodology: |
              Warm daemon, 10000 tool requests with no-op tool,
              measure time from RequestTool to validation complete.

  evidence_requirements:
    - evidence_id: EVID-RFC-0017-001
      description: "Adversarial test results for ADV-001 through ADV-011"
      format: "Test output logs with pass/fail status"
      requirement_ids: [REQ-DCP-0001, REQ-DCP-0003, REQ-DCP-0004, REQ-DCP-0005, REQ-DCP-0006, REQ-DCP-0007, REQ-DCP-0008]

    - evidence_id: EVID-RFC-0017-002
      description: "Unit test coverage report for daemon components"
      format: "Coverage report (target: >=80% line coverage)"
      requirement_ids: [REQ-DCP-0001, REQ-DCP-0008]

    - evidence_id: EVID-RFC-0017-003
      description: "Integration test results for end-to-end flows"
      format: "Test output logs with timing data"
      requirement_ids: [REQ-DCP-0002, REQ-DCP-0004]

    - evidence_id: EVID-RFC-0017-004
      description: "Benchmark results for latency requirements"
      format: "Histogram and percentile data"
      requirement_ids: [REQ-DCP-0009, REQ-DCP-0010, REQ-DCP-0011]

    - evidence_id: EVID-RFC-0017-005
      description: "Metrics endpoint verification"
      format: "Screenshot/output of /metrics with expected metrics"
      requirement_ids: [REQ-DCP-0012]

    - evidence_id: EVID-RFC-0017-006
      description: "Crash recovery test results"
      format: "Test output showing LEASE_REVOKED timing"
      requirement_ids: [REQ-DCP-0013]

  acceptance_criteria_mapping:
    # Maps PRD acceptance criteria to specific tests
    REQ-DCP-0001:
      - ADV-001
      - ADV-002
      - ADV-005
      - UT-IPC-001
      - UT-IPC-002

    REQ-DCP-0002:
      - UT-SPAWN-001
      - INT-001
      - INT-002

    REQ-DCP-0003:
      - ADV-004
      - UT-SPAWN-002

    REQ-DCP-0004:
      - INT-002
      - INT-003
      - ADV-011

    REQ-DCP-0005:
      - ADV-003
      - ADV-010
      - UT-TOOL-002
      - INT-004

    REQ-DCP-0006:
      - ADV-006
      - UT-SPAWN-003

    REQ-DCP-0007:
      - ADV-007
      - UT-SIGN-001
      - UT-SIGN-002

    REQ-DCP-0008:
      - UT-IPC-001
      - UT-IPC-002
      - ADV-009

    REQ-DCP-0009:
      - BENCH-001

    REQ-DCP-0010:
      - BENCH-002

    REQ-DCP-0011:
      - BENCH-003

    REQ-DCP-0012:
      - EVID-RFC-0017-005

    REQ-DCP-0013:
      - UT-SESS-001
      - UT-SESS-002
      - INT-005

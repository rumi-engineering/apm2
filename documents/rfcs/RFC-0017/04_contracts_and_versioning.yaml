rfc_contracts_and_versioning:
  schema_version: "2026-01-30"
  template_version: "2026-01-23"

  ipc_contracts:
    privileged_endpoints:
      description: "Require operator credential or internal holon signing key"
      endpoints:
        - endpoint_id: IPC-PRIV-001
          name: ClaimWork
          description: "Request work assignment with policy-resolved capabilities"
          request:
            parameters:
              - name: actor_id
                type: string
                description: "Display-only hint for actor name. Authoritative actor_id derived from credential."
                required: true
              - name: role
                type: string
                enum: [IMPLEMENTER, GATE_EXECUTOR, REVIEWER, COORDINATOR]
                description: "Role for work assignment"
                required: true
              - name: credential_signature
                type: bytes
                description: "Ed25519 signature over (actor_id || role || nonce) using operator key"
                required: true
            validation:
              - "actor_id must be non-empty"
              - "role must be valid enum value"
              - "Caller must have operator credential (verified via SO_PEERCRED + privileged socket)"
              - "credential_signature must verify against registered operator public key"
              - "Authoritative actor_id is public_key_fingerprint, NOT user-supplied value"
            security_note: |
              User-supplied actor_id is a display hint only. The daemon derives
              authoritative actor_id from the operator credential (public key fingerprint).
              This prevents impersonation attacks where a malicious operator claims
              work as another actor_id.
          response:
            success:
              type: WorkAssignment
              fields:
                - name: work_id
                  type: string
                - name: lease_id
                  type: string
                - name: capability_manifest_hash
                  type: string
                - name: policy_resolved_ref
                  type: string
                - name: context_pack_hash
                  type: string
            errors:
              - code: PERMISSION_DENIED
                description: "Caller lacks operator credential"
              - code: CAPABILITY_REQUEST_REJECTED
                description: "Invalid parameter"
              - code: POLICY_RESOLUTION_FAILED
                description: "Governance query failed"

        - endpoint_id: IPC-PRIV-002
          name: SpawnEpisode
          description: "Spawn execution episode with FAC preconditions"
          request:
            parameters:
              - name: work_id
                type: string
                required: true
              - name: role
                type: string
                enum: [IMPLEMENTER, GATE_EXECUTOR, REVIEWER]
                required: true
              - name: lease_id
                type: string
                required: false
            validation:
              - "PolicyResolvedForChangeSet must exist for work_id"
              - "If GATE_EXECUTOR: lease_id required"
              - "SoD: executor custody domain must not overlap author domains"
          response:
            success:
              type: EpisodeSpawned
              fields:
                - name: session_id
                  type: string
                - name: capability_manifest_hash
                  type: string
                - name: context_pack_sealed
                  type: boolean
                - name: ephemeral_handle
                  type: string
            errors:
              - code: PERMISSION_DENIED
              - code: POLICY_RESOLUTION_MISSING
              - code: GATE_LEASE_MISSING
              - code: SOD_VIOLATION

        - endpoint_id: IPC-PRIV-003
          name: IssueCapability
          description: "Issue additional capability to existing session"
          request:
            parameters:
              - name: session_id
                type: string
                required: true
              - name: capability_request
                type: CapabilityRequest
                required: true
          response:
            success:
              type: CapabilityGrant
              fields:
                - name: capability_id
                  type: string
                - name: granted_at
                  type: timestamp
                - name: expires_at
                  type: timestamp
            errors:
              - code: PERMISSION_DENIED
              - code: SESSION_NOT_FOUND
              - code: CAPABILITY_DENIED

        - endpoint_id: IPC-PRIV-004
          name: Shutdown
          description: "Gracefully shutdown daemon"
          request:
            parameters: []
          response:
            success:
              type: Acknowledgment
            errors:
              - code: PERMISSION_DENIED

    session_scoped_endpoints:
      description: "Bound to authenticated session_id"
      endpoints:
        - endpoint_id: IPC-SESS-001
          name: RequestTool
          description: "Request tool execution through broker"
          request:
            parameters:
              - name: tool_id
                type: string
                required: true
              - name: arguments
                type: object
                required: true
              - name: dedupe_key
                type: string
                required: true
            validation:
              - "tool_id must be in capability manifest tool_allowlist"
              - "arguments must satisfy capability manifest allowlists"
              - "dedupe_key used for idempotent execution"
          response:
            success:
              type: ToolResult
              fields:
                - name: result_id
                  type: string
                - name: output
                  type: bytes
                - name: tool_decided_ref
                  type: string
                - name: tool_executed_ref
                  type: string
            errors:
              - code: TOOL_NOT_ALLOWED
              - code: CONTEXT_FIREWALL_VIOLATION
              - code: TOOL_EXECUTION_FAILED

        - endpoint_id: IPC-SESS-002
          name: EmitEvent
          description: "Emit signed event to ledger"
          request:
            parameters:
              - name: event_payload
                type: bytes
                required: true
          response:
            success:
              type: EventRef
              fields:
                - name: event_id
                  type: string
                - name: ledger_offset
                  type: uint64
            errors:
              - code: INVALID_PAYLOAD
              - code: SIGNING_FAILED

        - endpoint_id: IPC-SESS-003
          name: PublishEvidence
          description: "Publish evidence bundle to CAS"
          request:
            parameters:
              - name: evidence_bundle
                type: bytes
                required: true
          response:
            success:
              type: EvidenceRef
              fields:
                - name: evidence_hash
                  type: string
                - name: cas_ref
                  type: string
            errors:
              - code: INVALID_BUNDLE
              - code: CAS_WRITE_FAILED

        - endpoint_id: IPC-SESS-004
          name: StreamTelemetry
          description: "Stream telemetry data from session"
          request:
            parameters:
              - name: telemetry_data
                type: bytes
                required: true
          response:
            success:
              type: Acknowledgment
            errors:
              - code: TELEMETRY_REJECTED

  event_contracts:
    - event_id: EVT-001
      name: WorkClaimed
      description: "Emitted when work is successfully claimed"
      fields:
        - name: work_id
          type: string
        - name: actor_id
          type: string
        - name: role
          type: string
        - name: capability_manifest_hash
          type: string
        - name: policy_resolved_ref
          type: string
        - name: timestamp
          type: timestamp
      signature_domain: "apm2.event.work_claimed"

    - event_id: EVT-002
      name: EpisodeSpawned
      description: "Emitted when episode is spawned"
      fields:
        - name: session_id
          type: string
        - name: work_id
          type: string
        - name: role
          type: string
        - name: lease_id
          type: string
          optional: true
        - name: capability_manifest_hash
          type: string
        - name: timestamp
          type: timestamp
      signature_domain: "apm2.event.episode_spawned"

    - event_id: EVT-003
      name: ToolDecided
      description: "Emitted for every tool mediation decision"
      fields:
        - name: session_id
          type: string
        - name: tool_id
          type: string
        - name: decision
          type: string
          enum: [ALLOW, DENY]
        - name: rule_id
          type: string
          optional: true
        - name: timestamp
          type: timestamp
      signature_domain: "apm2.event.tool_decided"

    - event_id: EVT-004
      name: ToolExecuted
      description: "Emitted after tool execution completes"
      fields:
        - name: session_id
          type: string
        - name: tool_id
          type: string
        - name: dedupe_key
          type: string
        - name: result_hash
          type: string
        - name: duration_ms
          type: uint64
        - name: timestamp
          type: timestamp
      signature_domain: "apm2.event.tool_executed"

    - event_id: EVT-005
      name: SessionTerminated
      description: "Emitted when session terminates"
      fields:
        - name: session_id
          type: string
        - name: rationale
          type: string
          enum: [NORMAL_COMPLETION, CONTEXT_FIREWALL_VIOLATION, DAEMON_RESTART, BUDGET_EXHAUSTED, LEASE_EXPIRED]
        - name: timestamp
          type: timestamp
      signature_domain: "apm2.event.session_terminated"

  versioning_strategy:
    ipc_versioning:
      approach: "Protobuf with field number stability"
      backward_compatibility: |
        New optional fields can be added with new field numbers.
        Existing fields retain their numbers for backward compatibility.
        Removal of fields requires deprecation period.

    event_versioning:
      approach: "Schema version embedded in each event"
      backward_compatibility: |
        Events include schema_version field.
        Ledger ingestion supports multiple schema versions.
        New versions add fields; existing fields retained.

    migration_path:
      from_xtask:
        - current: "cargo xtask work claim"
          new: "apm2 work claim --role=implementer"
        - current: "cargo xtask work start"
          new: "apm2 episode spawn --work-id=W-001 --role=implementer"
        - current: "cargo xtask fac ingest"
          new: "apm2 fac ingest --work-id=W-001"
        - current: "cargo xtask work status"
          new: "apm2 work status --work-id=W-001"

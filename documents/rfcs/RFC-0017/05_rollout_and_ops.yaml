rfc_rollout_and_ops:
  schema_version: "2026-01-30"
  template_version: "2026-01-23"

  rollout_strategy:
    phases:
      - id: PHASE-1
        name: "IPC Security Foundation"
        description: "Establish authenticated IPC boundary and privilege separation"
        deliverables:
          - "Unix socket IPC with SO_PEERCRED authentication"
          - "Per-connection capability token issuance"
          - "Privileged vs session-scoped endpoint separation"
          - "ClaimWork with policy-resolved capability minting"
        gates:
          - "Adversarial tests ADV-001, ADV-002, ADV-005 pass"
          - "Unit tests for IPC authentication"
          - "Integration test for privilege separation"
        rollback_criteria:
          - "Authentication bypass discovered"
          - "Privilege escalation vulnerability"

      - id: PHASE-2
        name: "Episode Spawn with Lease Gating"
        description: "Enforce FAC lease requirements at spawn time"
        deliverables:
          - "SpawnEpisode with PolicyResolvedForChangeSet precondition"
          - "GateLeaseIssued precondition for gate executor roles"
          - "SoD enforcement via custody domain check"
        gates:
          - "Adversarial tests ADV-004, ADV-006 pass"
          - "Integration test with FAC events"
        rollback_criteria:
          - "Lease validation bypass"
          - "SoD enforcement failure"

      - id: PHASE-3
        name: "Session Binding and Tool Mediation"
        description: "Zero-credential sessions with broker-mediated tool access"
        deliverables:
          - "Ephemeral session handles (no credentials)"
          - "Context firewall enforcement (deny + terminate)"
          - "Daemon-held secret mediation for tool broker"
        gates:
          - "Adversarial test ADV-003 passes"
          - "No credential access in session scope verified"
          - "Context firewall latency <100ms for deny+terminate"
        rollback_criteria:
          - "Credential exposure in session"
          - "Context firewall bypass"

      - id: PHASE-4
        name: "CLI Migration (Cancelled by DD-009)"
        description: "De-scoped under hard cutover; no legacy adapter path"
        deliverables:
          - "Cancelled: CLI migration is out of scope for DD-009"
        gates:
          - "N/A (cancelled)"
        rollback_criteria:
          - "N/A (cancelled)"

      - id: PHASE-5
        name: "xtask Bypass Closure"
        description: "Disable authority-affecting xtask operations (fail-closed)"
        deliverables:
          - "Authority-affecting xtask ops hard-fail or route via daemon projection"
          - "Direct external status writes removed"
        gates:
          - "CI guardrails block legacy IPC + external writes"
          - "Adversarial test ADV-012 passes"
        rollback_criteria:
          - "Bypass path discovered"
          - "Projection-only enforcement regression"

  operational_considerations:
    monitoring:
      metrics:
        - name: apm2_daemon_sessions_active
          type: gauge
          description: "Number of currently active sessions"
          labels: [role]

        - name: apm2_daemon_tool_mediation_latency_seconds
          type: histogram
          description: "Latency of tool mediation (excluding execution)"
          labels: [tool_id, decision]
          buckets: [0.001, 0.005, 0.01, 0.025, 0.05, 0.1]

        - name: apm2_daemon_ipc_requests_total
          type: counter
          description: "Total IPC requests by endpoint"
          labels: [endpoint, status]

        - name: apm2_daemon_capability_grants_total
          type: counter
          description: "Total capability grants issued"
          labels: [role, capability_type]

        - name: apm2_daemon_context_firewall_denials_total
          type: counter
          description: "Total context firewall denials"
          labels: [rule_id]

        - name: apm2_daemon_session_terminations_total
          type: counter
          description: "Total session terminations by rationale"
          labels: [rationale]

      alerts:
        - name: DaemonHighContextFirewallDenials
          condition: "rate(apm2_daemon_context_firewall_denials_total[5m]) > 10"
          severity: warning
          description: "High rate of context firewall denials may indicate misconfiguration or attack"

        - name: DaemonHighMediationLatency
          condition: "histogram_quantile(0.99, apm2_daemon_tool_mediation_latency_seconds) > 0.05"
          severity: warning
          description: "Tool mediation p99 latency exceeds 50ms target"

        - name: DaemonNoActiveSessions
          condition: "apm2_daemon_sessions_active == 0 for 1h"
          severity: info
          description: "No active sessions for extended period"

    logging:
      format: "Structured JSON with tracing spans"
      levels:
        - level: ERROR
          events:
            - "Context firewall violation"
            - "Privilege escalation attempt"
            - "Signing failure"
        - level: WARN
          events:
            - "SoD violation rejected"
            - "Lease validation failure"
            - "xtask deprecation warning"
        - level: INFO
          events:
            - "Session spawned"
            - "Session terminated"
            - "Work claimed"
        - level: DEBUG
          events:
            - "Tool mediation decision"
            - "Capability grant"
            - "IPC request received"

    crash_recovery:
      process:
        - step: 1
          action: "Daemon detects it has restarted (PID file or lock)"
        - step: 2
          action: "Load session registry from persistent state"
        - step: 3
          action: "For each registered session, attempt LEASE_REVOKED signal"
        - step: 4
          action: "Sessions receiving LEASE_REVOKED terminate gracefully"
        - step: 5
          action: "Emit SessionTerminated events with rationale=DAEMON_RESTART"
        - step: 6
          action: "Clean up stale session state"
      timeout: "5 seconds for all sessions to receive LEASE_REVOKED"
      fallback: "Sessions without signal will timeout on next IPC attempt"

    deployment:
      container_requirements:
        - "Use --userns=host to preserve UID for peer credential validation"
        - "Mount Unix socket directory with appropriate permissions"
        - "Daemon process runs as non-root user with capability to bind socket"
      socket_location:
        operator_default: "$XDG_RUNTIME_DIR/apm2/operator.sock"
        operator_fallback: "/tmp/apm2-$USER/operator.sock"
        session_default: "$XDG_RUNTIME_DIR/apm2/session.sock"
        session_fallback: "/tmp/apm2-$USER/session.sock"
      permissions:
        operator_socket: "0600 (owner only)"
        session_socket: "0660 (owner + group)"
        socket_dir: "0700 (owner only)"

  deprecation_timeline:
    milestones:
      - milestone: "Phase 5 start"
        action: "Disable authority-affecting xtask operations (hard-fail or route via daemon projection)"
        duration_estimate: "1 release cycle"

      - milestone: "Phase 5 complete"
        action: "Remove xtask crate"
        gate: "Replacement workflows validated; no telemetry gate"

    divergence_policy: |
      Authority-affecting xtask operations are fail-closed immediately under
      DD-009. Divergence from projection-only paths triggers hard failure and
      is treated as a security defect, not a warning.

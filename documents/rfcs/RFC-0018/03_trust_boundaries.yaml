rfc_trust_boundaries:
  schema_version: "2026-02-01"
  template_version: "2026-01-23"
  boundaries:
    - id: "TB-HEF-0001"
      name: "Pulse subscription boundary (operator vs session sockets)"
      description: |
        Pulse subscriptions cross the ProtocolServer IPC boundary. Privilege is
        derived from socket type (operator.sock vs session.sock), and session
        connections must validate session_token before any subscription.
        Evidence for socket-based privilege separation: crates/apm2-daemon/src/protocol/dispatch.rs:724-783,
        crates/apm2-daemon/AGENTS.md:123-139.
      actors:
        - "PRINCIPAL-OPERATOR"
        - "PRINCIPAL-AGENT"
        - "PRINCIPAL-DAEMON"
      entrypoints:
        - "operator.sock"
        - "session.sock"
      data_flows:
        - "SubscribePulse -> ACL check -> subscription registry"
        - "PulseEvent -> filtered delivery to subscriber"
      authn_authz:
        authn: "Session connections must present a valid session_token before subscription; operator connections rely on socket privilege."
        authz: "Default-deny ACLs; session subscriptions require explicit allowlist in capability manifest/lease (NEW WORK REQUIRED: add topic allowlists, TCK-00314); daemon-only publish."
      risks:
        - "Unauthorized subscription to privileged topics"
        - "Pulse-driven authority escalation"
      evidence_ids:
        - "EVID-HEF-0002"

    - id: "TB-HEF-0002"
      name: "Pulse publish boundary (daemon-only)"
      description: |
        Only the daemon publishes pulses, derived from a post-commit outbox. Sessions
        never publish pulse topics.
      actors:
        - "PRINCIPAL-DAEMON"
      entrypoints:
        - "ledger commit path"
      data_flows:
        - "CAS persist -> ledger append -> outbox -> pulse publish"
      authn_authz:
        authn: "Internal only"
        authz: "Daemon-only; no session pathway"
      risks:
        - "Spoofed pulses if session publishing is allowed"
        - "Pulses emitted before ledger commit"
      evidence_ids:
        - "EVID-HEF-0006"

    - id: "TB-HEF-0003"
      name: "CAS access boundary"
      description: |
        Pulses reference CAS hashes but do not grant read access. CAS access
        remains policy-gated; any disclosure is enforced at CAS retrieval.
      actors:
        - "PRINCIPAL-DAEMON"
        - "PRINCIPAL-OPERATOR"
        - "PRINCIPAL-AGENT"
      entrypoints:
        - "CAS read API"
      data_flows:
        - "Pulse carries cas_refs -> consumer must request CAS via policy gate"
      authn_authz:
        authn: "Per existing CAS access control"
        authz: "Policy-gated; pulses do not extend rights"
      risks:
        - "Inference of sensitive data from pulse metadata"
      evidence_ids:
        - "EVID-HEF-0001"

    - id: "TB-HEF-0004"
      name: "Projection-only external systems boundary"
      description: |
        External systems (e.g., GitHub) remain projection-only and are never a
        source of truth for admission. Pulses must not depend on external
        projection state.
        Evidence for projection-only posture: crates/apm2-daemon/src/projection/mod.rs:4-21.
      actors:
        - "PRINCIPAL-DAEMON"
        - "EXTERNAL-GITHUB"
      entrypoints:
        - "projection adapter"
      data_flows:
        - "ledger -> projection adapter -> external system"
      authn_authz:
        authn: "Adapter credentials held by daemon"
        authz: "Write-only projection; no reads for truth"
      risks:
        - "Authority leakage via external status checks"
      evidence_ids:
        - "EVID-HEF-0001"

    - id: "TB-HEF-0005"
      name: "FAC v0 ChangeSetBundle distribution boundary"
      description: |
        ChangeSetBundle CAS references are delivered to reviewer episodes via
        capability-manifest allowlists (NEW WORK REQUIRED: add CAS hash allowlists,
        TCK-00314). Pulses do not grant CAS reads; access is policy-gated and
        scoped to explicit hashes (changeset_bundle_hash, workspace_snapshot_hash).
      actors:
        - "PRINCIPAL-DAEMON"
        - "PRINCIPAL-AGENT"
      entrypoints:
        - "session.sock"
        - "CAS read API"
      data_flows:
        - "ChangeSetPublished -> CAS hash allowlist -> reviewer episode"
        - "Pulse hint -> consumer fetches CAS via policy gate"
      authn_authz:
        authn: "Session token + lease-bound capability manifest"
        authz: "Explicit CAS hash allowlist enforced at daemon CAS access facade; deny-by-default (NEW WORK REQUIRED: TCK-00314)"
      risks:
        - "Unauthorized CAS read of diff artifacts"
        - "Mismatched changeset_digest vs bundle hash"
      evidence_ids:
        - "EVID-HEF-0009"

    - id: "TB-HEF-0006"
      name: "FAC v0 review output boundary"
      description: |
        Reviewer outputs (review text, tool logs) are stored in CAS and anchored
        by ReviewReceiptRecorded or ReviewBlockedRecorded ledger events. External
        systems are projection-only; outputs never derive from GitHub reads.
      actors:
        - "PRINCIPAL-DAEMON"
        - "PRINCIPAL-AGENT"
        - "EXTERNAL-GITHUB"
      entrypoints:
        - "CAS write API"
        - "ledger append"
        - "projection adapter"
      data_flows:
        - "Reviewer episode -> CAS artifact -> ReviewReceiptRecorded"
        - "ReviewBlocked -> CAS logs -> ledger event"
        - "Ledger -> projection adapter -> external system"
      authn_authz:
        authn: "Episode identity + lease scope"
        authz: "CAS writes bound to lease scope; projection is write-only"
      risks:
        - "Review output leakage outside CAS gating"
        - "Projection treated as authority"
      evidence_ids:
        - "EVID-HEF-0011"
        - "EVID-HEF-0012"

rfc_ticket_decomposition:
  schema_version: "2026-02-01"
  template_version: "2026-01-23"
  status: POPULATED
  notes: |
    Ticket decomposition for HEF Phase 1. Ordering establishes:
    1) protocol schema, 2) topic grammar + ACLs, 3) outbox + publisher,
    4) truth-plane trigger coverage, 5) FAC v0 preconditions, 6) red-team validation.

  tickets:
    - ticket_id: "TCK-00300"
      title: "HEF: Extend ProtocolServer proto with PulseEnvelope + Subscribe/Unsubscribe"
      requirement_ids:
        - "REQ-HEF-0002"
        - "REQ-HEF-0008"
      depends_on:
        - "TCK-00287"
      risk_tier: "T3"
      summary: |
        Extend proto/apm2d_runtime_v1.proto to define PulseEnvelopeV1,
        PulseSubscribeRequest/Response, PulseUnsubscribeRequest/Response,
        and PulseEvent (server->client only). Assign new message tags for
        session and operator sockets.
      files_to_modify:
        - "proto/apm2d_runtime_v1.proto (add PulseEnvelopeV1 + subscription messages + tags)"
      files_to_create: []
      acceptance_criteria:
        - "PulseEnvelopeV1 fields are bounded and unknown fields are rejected."
        - "Subscribe/Unsubscribe tags reserved for both session and operator sockets."
        - "Verified tag map has no collisions; apm2d_runtime_v1.proto reserves a HEF tag range."
      evidence_ids:
        - "EVID-HEF-0003"

    - ticket_id: "TCK-00301"
      title: "HEF: Topic grammar + wildcard matcher with bounded complexity"
      requirement_ids:
        - "REQ-HEF-0007"
      depends_on:
        - "TCK-00287"
        - "TCK-00300"
      risk_tier: "T2"
      summary: |
        Implement parser and matcher for dot-delimited topic grammar with
        per-segment '*' and terminal '>' wildcards (max 2 wildcards). Enforce
        ASCII-only, no empty segments, and length bounds.
      files_to_modify:
        - "crates/apm2-daemon/src/protocol/mod.rs (wire topic parser)"
      files_to_create:
        - "crates/apm2-daemon/src/protocol/pulse_topic.rs (topic validation + matching)"
      acceptance_criteria:
        - "Invalid patterns (regex, empty segments, too many wildcards) are rejected."
      evidence_ids:
        - "EVID-HEF-0007"

    - ticket_id: "TCK-00302"
      title: "HEF: Subscription registry + ACL enforcement"
      requirement_ids:
        - "REQ-HEF-0003"
      depends_on:
        - "TCK-00287"
        - "TCK-00300"
        - "TCK-00301"
      risk_tier: "T3"
      summary: |
        Add subscription handling to ProtocolServer dispatchers. Enforce
        operator/session default-deny ACLs and capability-manifest restrictions.
        Sessions never publish pulses.
      files_to_modify:
        - "crates/apm2-daemon/src/protocol/session_dispatch.rs (Subscribe/Unsubscribe handling)"
        - "crates/apm2-daemon/src/protocol/dispatch.rs (operator Subscribe/Unsubscribe)"
      files_to_create:
        - "crates/apm2-daemon/src/protocol/pulse_acl.rs (ACL evaluation)"
      acceptance_criteria:
        - "Session subscriptions are deny-by-default; only capability-manifest allowlisted topics are accepted."
        - "Session wildcard patterns are rejected in Phase 1."
        - "Operator subscriptions can access full topic taxonomy."
      evidence_ids:
        - "EVID-HEF-0002"

    - ticket_id: "TCK-00303"
      title: "HEF: Resource governance + backpressure/drop policy"
      requirement_ids:
        - "REQ-HEF-0004"
      depends_on:
        - "TCK-00287"
        - "TCK-00302"
      risk_tier: "T2"
      summary: |
        Enforce caps at daemon boundary: max subscriptions per connection,
        max patterns, max pulses/sec, max queue depth, and max bytes in-flight.
        Implement drop policy with ordered priority (episode.<episode_id>.io first).
      files_to_modify:
        - "crates/apm2-daemon/src/protocol/ (quota + queue enforcement)"
      files_to_create: []
      acceptance_criteria:
        - "Oversubscription triggers RESOURCE_LIMIT without daemon crash."
        - "Caps enforced: max_subscriptions_per_connection=16; max_patterns_per_subscription=16; max_total_patterns_per_connection=64."
        - "Caps enforced: max_pulses_per_sec_per_subscriber=100; max_burst_pulses_per_subscriber=200; max_queue_depth_per_subscriber=256; max_bytes_in_flight_per_subscriber=1048576; max_pulse_payload_bytes=2048."
      evidence_ids:
        - "EVID-HEF-0007"

    - ticket_id: "TCK-00304"
      title: "HEF: Outbox + pulse publisher (post-commit)"
      requirement_ids:
        - "REQ-HEF-0006"
        - "REQ-HEF-0001"
      depends_on:
        - "TCK-00287"
        - "TCK-00300"
        - "TCK-00302"
      risk_tier: "T3"
      summary: |
        Implement a daemon-owned outbox populated only after ledger commit.
        Pulse publisher drains outbox, applies ACL filtering, and emits
        PulseEvent frames. Enforce CAS->ledger->pulse ordering. apm2-core
        exposes only a post-commit notification interface; outbox storage stays
        in the daemon.
      post_commit_notification_interface:
        description: |
          Interface specification per FND-RFC-0018-005 remediation. Defines the
          contract between apm2-core and daemon for ledger commit notifications.
        struct_definition: |
          /// Notification sent after ledger commit completes.
          /// [CTR-POSTCOMMIT-001] Notification is best-effort; failure never blocks commit.
          /// [CTR-POSTCOMMIT-002] No daemon types in this struct.
          pub struct CommitNotification {
              pub seq_id: u64,
              pub event_hash: [u8; 32],
              pub event_type: String,
              pub namespace: String,
              pub consensus_index: Option<ConsensusIndex>,
          }
        channel_type: "tokio::sync::mpsc::Sender<CommitNotification>"
        pattern: "CHANNEL_BASED"
        rationale: |
          Channel-based (not callback) for DD-HEF-0007 compliance: apm2-core must
          not depend on daemon types. Daemon injects sender at BftLedgerBackend
          construction; apm2-core sends to channel after on_commit() succeeds.
        error_handling:
          on_send_failure: "LOG_WARN_DROP (fire-and-forget; never fails commit)"
          on_channel_disconnected: "LOG_DEBUG_IGNORE (expected during shutdown)"
          on_channel_full: "DROP_INCREMENT_METRIC (hef_notification_drops counter)"
        bounds:
          channel_capacity: 1024
          non_blocking: "MUST use try_send(); notify() MUST NOT block"
        integration_point: "BftLedgerBackend::on_commit() sends after tx.commit() succeeds"
      files_to_modify:
        - "crates/apm2-core/src/ledger/mod.rs (add CommitNotification + Sender type exports)"
        - "crates/apm2-core/src/ledger/bft_backend.rs (inject channel sender, send after on_commit())"
        - "crates/apm2-daemon/src/protocol/ (pulse publisher + fanout)"
      files_to_create:
        - "crates/apm2-daemon/src/protocol/pulse_outbox.rs (post-commit queue draining channel)"
      acceptance_criteria:
        - "Pulse is emitted only after ledger append succeeds."
        - "apm2-core has no daemon dependency; outbox state is daemon-owned."
        - "Post-commit hook never fails the ledger append; fanout is decoupled."
        - "CommitNotification struct defined in apm2-core with no daemon type dependencies."
        - "Channel-based notification with try_send(); full channel drops notification."
        - "Notification drops logged at WARN and increment hef_notification_drops metric."
        - "BftLedgerBackend accepts optional CommitNotificationSender at construction."
      evidence_ids:
        - "EVID-HEF-0006"

    - ticket_id: "TCK-00305"
      title: "HEF: Topic->trigger mapping for Work and Gate events"
      requirement_ids:
        - "REQ-HEF-0001"
        - "REQ-HEF-0002"
      depends_on:
        - "TCK-00287"
        - "TCK-00304"
      risk_tier: "T2"
      summary: |
        Map kernel events to pulse topics:
        - WorkEvent -> work.<work_id>.events
        - GateReceipt -> gate.<work_id>.<changeset_digest>.<gate_id>
        Add changeset_digest->work_id mapping via PolicyResolvedForChangeSet
        index to populate gate topics.
      files_to_modify:
        - "crates/apm2-core/src/ledger/ (PolicyResolvedForChangeSet lookup)"
        - "crates/apm2-daemon/src/protocol/ (pulse mapping logic)"
      files_to_create: []
      acceptance_criteria:
        - "Gate pulse includes work_id derived from PolicyResolvedForChangeSet."
      evidence_ids:
        - "EVID-HEF-0006"

    - ticket_id: "TCK-00306"
      title: "HEF NEW WORK REQUIRED: Episode lifecycle/tool/io truth-plane events"
      requirement_ids:
        - "REQ-HEF-0001"
        - "REQ-HEF-0008"
      depends_on:
        - "TCK-00287"
        - "TCK-00300"
      risk_tier: "T3"
      preconditions:
        - "Q-HEF-0001 resolved: Option A selected (add episode_id field to existing events)"
      summary: |
        Add episode lifecycle and IO coverage to the truth-plane:
        - Per Q-HEF-0001 resolution (Option A): Add optional episode_id field to
          existing Session/Tool kernel events (SessionStarted, SessionProgress,
          SessionTerminated, SessionQuarantined, ToolRequested, ToolDecided, ToolExecuted).
        - Add IO artifact reference event for episode.<episode_id>.io topic derivation.
        - Daemon populates episode_id from episode context when emitting ledger events.
        - Emit ledger events from daemon episode runtime.
      files_to_modify:
        - "proto/kernel_events.proto (add optional episode_id field to Session/Tool events + IO artifact event)"
        - "crates/apm2-daemon/src/episode/ (populate episode_id in ledger event emission)"
      files_to_create: []
      acceptance_criteria:
        - "Episode pulses are derived from ledger events, not IPC-only messages."
        - "Session/Tool events include optional episode_id field (empty for non-episode sessions)."
        - "Existing ledger events replay correctly (episode_id defaults to empty string)."
        - "Topic derivation extracts episode_id from event fields for episode.*.{lifecycle,tool,io} topics."
      evidence_ids:
        - "EVID-HEF-0006"

    - ticket_id: "TCK-00307"
      title: "HEF NEW WORK REQUIRED: DefectRecord ledger event"
      requirement_ids:
        - "REQ-HEF-0001"
      depends_on:
        - "TCK-00287"
        - "TCK-00300"
      risk_tier: "T3"
      summary: |
        Add DefectRecord to the truth-plane by extending kernel_events.proto
        with a DefectRecorded event referencing DefectRecord (or CAS hash).
        Emit defect ledger events from defect producers (projection watchdog,
        context miss, HTF regression).
      files_to_modify:
        - "proto/kernel_events.proto (add DefectRecorded event type)"
        - "crates/apm2-daemon/src/projection/divergence_watchdog.rs (emit defect ledger event)"
      files_to_create: []
      acceptance_criteria:
        - "defect.new pulses are derived from DefectRecorded ledger events."
      evidence_ids:
        - "EVID-HEF-0006"

    - ticket_id: "TCK-00308"
      title: "HEF: Red-team and resilience test suite"
      requirement_ids:
        - "REQ-HEF-0001"
        - "REQ-HEF-0003"
        - "REQ-HEF-0004"
        - "REQ-HEF-0005"
        - "REQ-HEF-0006"
        - "REQ-HEF-0008"
      depends_on:
        - "TCK-00287"
        - "TCK-00302"
        - "TCK-00303"
        - "TCK-00304"
      risk_tier: "T3"
      summary: |
        Implement red-team tests: pulse-only admission attempt, unauthorized
        subscribe/publish, downgrade attempts, oversize frames/allocation bomb,
        subscription explosion + rate-limit enforcement, replay/reorder/
        duplication handling, and pulse loss recovery via ledger catch-up.
      files_to_modify:
        - "crates/apm2-daemon/tests/ (add HEF integration + adversarial tests)"
      files_to_create:
        - "crates/apm2-daemon/tests/hef_redteam.rs (pulse-plane red-team suite)"
      acceptance_criteria:
        - "All red-team cases fail closed and do not affect admission."
      evidence_ids:
        - "EVID-HEF-0001"
        - "EVID-HEF-0002"
        - "EVID-HEF-0003"
        - "EVID-HEF-0004"
        - "EVID-HEF-0005"
        - "EVID-HEF-0006"
        - "EVID-HEF-0007"

    - ticket_id: "TCK-00309"
      title: "HEF: Close xtask/GitHub status bypass surface"
      requirement_ids:
        - "REQ-HEF-0001"
      depends_on:
        - "TCK-00294"
        - "TCK-00295"
        - "TCK-00296"
        - "TCK-00297"
      risk_tier: "T2"
      summary: |
        Disable direct gh api /statuses writes for FAC-adjacent signals in xtask,
        or route them through daemon projection-only logic. This ticket MUST
        begin with a repo search for direct GitHub status writes and update the
        touched file set accordingly. Phase 1 must fail-closed (disable direct
        writes) until projection routing exists.
      files_to_modify:
        - "xtask/src/tasks/aat.rs (remove or gate direct status writes)"
        - "xtask/src/tasks/push.rs (remove or gate direct status writes)"
        - "xtask/src/tasks/review.rs (remove or gate direct status writes)"
        - "xtask/src/tasks/security_review_exec.rs (remove or gate direct status writes)"
      files_to_create: []
      acceptance_criteria:
        - "Direct GitHub status writes for FAC-adjacent signals are disabled by default."
        - "If daemon projection routing exists, all status writes are routed through it."
      evidence_ids:
        - "EVID-HEF-0001"

    - ticket_id: "TCK-00310"
      group: "FAC v0 Preconditions"
      title: "FAC v0 NEW WORK REQUIRED: ChangeSetBundleV1 + ChangeSetPublished event"
      requirement_ids:
        - "REQ-HEF-0009"
      depends_on:
        - "TCK-00287"
        - "TCK-00288"
        - "TCK-00290"
        - "TCK-00293"
      risk_tier: "T3"
      summary: |
        Define ChangeSetBundleV1 CAS schema and canonicalization. Add a
        ChangeSetPublished ledger event that anchors changeset_digest and CAS
        hash before any review begins.
      files_to_modify:
        - "proto/kernel_events.proto (add ChangeSetPublished event type)"
        - "crates/apm2-core/src/ledger/ (emit ChangeSetPublished)"
      files_to_create:
        - "schemas/apm2/changeset_bundle_v1.yaml (ChangeSetBundleV1 schema)"
        - "crates/apm2-core/src/fac/changeset_bundle.rs (bundle canonicalization)"
      acceptance_criteria:
        - "ChangeSetBundleV1 canonicalization is defined and deterministic."
        - "Deterministic digest test exists (same bundle inputs -> same changeset_digest), and hash input omits the changeset_digest field."
        - "Ledger event ChangeSetPublished references changeset_digest + CAS hash."
      evidence_ids:
        - "EVID-HEF-0009"

    - ticket_id: "TCK-00311"
      group: "FAC v0 Preconditions"
      title: "FAC v0 NEW WORK REQUIRED: Workspace snapshot/apply + ReviewBlocked"
      requirement_ids:
        - "REQ-HEF-0010"
        - "REQ-HEF-0011"
      depends_on:
        - "TCK-00287"
        - "TCK-00288"
        - "TCK-00290"
        - "TCK-00293"
        - "TCK-00310"
        - "TCK-00314"
        - "RFC-0017:TCK-00254"
        - "RFC-0017:TCK-00256"
        - "RFC-0017:TCK-00260"
      risk_tier: "T3"
      summary: |
        Implement reviewer workspace snapshot/apply semantics from
        ChangeSetBundleV1. On apply/tool failure, emit ReviewBlockedRecorded with
        reason_code and CAS log references.
      files_to_modify:
        - "proto/kernel_events.proto (add ReviewBlockedRecorded event type)"
        - "crates/apm2-daemon/src/episode/ (apply snapshot + emit ReviewBlocked)"
      files_to_create:
        - "schemas/apm2/review_blocked_v1.yaml (reason codes + CAS log bundle)"
      acceptance_criteria:
        - "Workspace apply failure emits ReviewBlockedRecorded with CAS logs."
        - "Retries bounded by HTF windows; blocked outcome is durable."
      evidence_ids:
        - "EVID-HEF-0010"

    - ticket_id: "TCK-00312"
      group: "FAC v0 Preconditions"
      title: "FAC v0 NEW WORK REQUIRED: ReviewReceipt artifacts + ledger event"
      requirement_ids:
        - "REQ-HEF-0010"
      depends_on:
        - "TCK-00287"
        - "TCK-00288"
        - "TCK-00290"
        - "TCK-00293"
        - "TCK-00310"
        - "TCK-00314"
        - "RFC-0017:TCK-00254"
        - "RFC-0017:TCK-00260"
      risk_tier: "T3"
      summary: |
        Store reviewer outputs (review text + tool logs) in CAS and anchor via a
        ReviewReceiptRecorded ledger event. Review receipts must bind to
        changeset_digest and ReviewArtifactBundleV1.
      files_to_modify:
        - "proto/kernel_events.proto (add ReviewReceiptRecorded event type)"
        - "crates/apm2-core/src/evidence/ (review receipt validation)"
        - "crates/apm2-daemon/src/episode/ (emit ReviewReceiptRecorded)"
      files_to_create:
        - "schemas/apm2/review_artifact_bundle_v1.yaml (ReviewArtifactBundleV1 schema)"
      acceptance_criteria:
        - "ReviewReceiptRecorded references ReviewArtifactBundleV1 CAS hash."
        - "ReviewReceipt binds changeset_digest + time_envelope_ref."
      evidence_ids:
        - "EVID-HEF-0011"

    - ticket_id: "TCK-00313"
      group: "FAC v0 Preconditions"
      title: "FAC v0: End-to-end autonomous run harness"
      requirement_ids:
        - "REQ-HEF-0009"
        - "REQ-HEF-0010"
        - "REQ-HEF-0011"
      depends_on:
        - "TCK-00287"
        - "TCK-00288"
        - "TCK-00290"
        - "TCK-00293"
        - "TCK-00310"
        - "TCK-00311"
        - "TCK-00312"
        - "TCK-00315"
        - "RFC-0017:TCK-00256"
        - "RFC-0017:TCK-00260"
        - "RFC-0017:TCK-00252"
      risk_tier: "T3"
      summary: |
        Build an end-to-end FAC v0 harness that drives ChangeSetPublished ->
        reviewer episodes -> ReviewReceipt -> GateReceipt -> projection, with
        no GitHub reads for truth.
      files_to_modify:
        - "crates/apm2-daemon/tests/ (FAC v0 integration tests)"
      files_to_create:
        - "crates/apm2-daemon/tests/hef_fac_v0_e2e.rs"
      acceptance_criteria:
        - "EVID-HEF-0012 produced; GATE-HEF-FAC-V0 passes."
      evidence_ids:
        - "EVID-HEF-0012"

    - ticket_id: "TCK-00314"
      title: "HEF NEW WORK REQUIRED: Capability allowlists for pulse topics + CAS reads"
      requirement_ids:
        - "REQ-HEF-0003"
        - "REQ-HEF-0005"
      depends_on:
        - "TCK-00287"
        - "TCK-00292"
        - "TCK-00293"
        - "TCK-00302"
        - "RFC-0017:TCK-00254"
      risk_tier: "T3"
      summary: |
        Extend capability manifests/leases to include explicit allowlists for
        pulse topic subscriptions and CAS hash reads (diff bundles, snapshots,
        review artifacts). Enforce allowlists at SubscribePulse handling and a
        daemon-side CAS access facade (policy/broker layer) before invoking
        core CAS APIs. Phase 1 session.sock forbids wildcards; allowlists must
        enumerate exact topics.
      module_structure:
        evidence_module_exists: true
        evidence_module_path: "crates/apm2-daemon/src/evidence/mod.rs"
        cas_access_placement: |
          cas_access.rs will be added as a submodule of the existing evidence module.
          Add `pub mod cas_access;` to evidence/mod.rs to wire the facade.
      files_to_modify:
        - "crates/apm2-daemon/src/episode/capability.rs (add topic_allowlist + cas_hash_allowlist fields)"
        - "crates/apm2-daemon/src/protocol/session_dispatch.rs (enforce topic allowlist)"
        - "crates/apm2-daemon/src/evidence/mod.rs (add pub mod cas_access; wire CAS access facade)"
      files_to_create:
        - "crates/apm2-daemon/src/evidence/cas_access.rs (policy-gated CAS read facade; submodule of evidence)"
      acceptance_criteria:
        - "Session subscriptions reject any topic not explicitly allowlisted."
        - "Session wildcard patterns are rejected in Phase 1."
        - "CAS reads for ChangeSetBundle/Review artifacts are denied unless hash allowlisted at daemon CAS access facade."
        - "cas_access.rs MUST be the sole entry point for session-context CAS reads."
        - "Direct CAS API calls from session_dispatch.rs or consume.rs bypassing the facade are forbidden."
        - "Module location documented in evidence/mod.rs header comment."
      evidence_ids:
        - "EVID-HEF-0002"

    - ticket_id: "TCK-00315"
      group: "FAC v0 Preconditions"
      title: "FAC v0 NEW WORK REQUIRED: Reviewer navigation tool surface (ListFiles/Search)"
      requirement_ids:
        - "REQ-HEF-0010"
      depends_on:
        - "TCK-00290"
        - "TCK-00291"
        - "TCK-00292"
        - "TCK-00293"
        - "RFC-0017:TCK-00252"
        - "RFC-0017:TCK-00260"
      risk_tier: "T2"
      summary: |
        Define minimal file navigation tool surfaces (ListFiles/Search) in
        proto/tool_protocol.proto and wire them through RequestTool to the
        tool broker. Ensure they are subject to capability allowlists and
        context firewall rules (read-only, bounded output).
      files_to_modify:
        - "proto/tool_protocol.proto (add ListFiles/Search messages)"
        - "crates/apm2-daemon/src/episode/broker.rs (handle navigation tools)"
        - "crates/apm2-daemon/src/session/consume.rs (enforce allowlist for navigation)"
      files_to_create: []
      acceptance_criteria:
        - "ListFiles/Search requests are denied unless allowlisted."
        - "Navigation outputs are bounded (max_bytes=65536, max_lines=2000) and logged to CAS."
      evidence_ids:
        - "EVID-HEF-0011"

rfc_contracts_and_versioning:
  schema_version: "2026-02-01"
  template_version: "2026-01-23"
  contracts:
    - id: "CTR-HEF-0001"
      name: "Pulse Plane IPC (ProtocolServer)"
      type: "API"
      versioning:
        scheme: "SEMVER"
        current_version: "1.0.0"
        compatibility_rules:
          - "Unknown fields are rejected for Subscribe/Unsubscribe (strict decode)."
          - "PulseEnvelopeV1 is size-bounded (<= 2048 bytes)."
          - "Topic length <= 128 chars; pulse_id <= 64 chars; IDs are ASCII only."
          - "New fields must be optional and bounded; removals require major bump."
      schemas:
        - id: "SCH-HEF-0001"
          path: "proto/apm2d_runtime_v1.proto"
          format: "PROTOBUF"
          description: "Add PulseEnvelopeV1, PulseSubscribeRequest/Response, PulseUnsubscribeRequest/Response, PulseEvent."
      evidence_ids:
        - "EVID-HEF-0003"
    - id: "CTR-HEF-FAC-0001"
      name: "ChangeSetBundleV1 (CAS artifact)"
      type: "ARTIFACT"
      versioning:
        scheme: "SEMVER"
        current_version: "0.1.0"
        compatibility_rules:
          - "Bundle encoding is canonical; field order is deterministic."
          - "changeset_digest is derived from canonical bundle bytes with the changeset_digest field omitted from the hash input."
      schemas:
        - id: "SCH-HEF-FAC-0001"
          path: "schemas/apm2/changeset_bundle_v1.yaml"
          format: "JSON_SCHEMA"
          description: "NEW WORK REQUIRED: canonical ChangeSetBundleV1 schema."
      evidence_ids:
        - "EVID-HEF-0009"
    - id: "CTR-HEF-FAC-0002"
      name: "ReviewArtifactBundleV1 (CAS artifact)"
      type: "ARTIFACT"
      versioning:
        scheme: "SEMVER"
        current_version: "0.1.0"
        compatibility_rules:
          - "Bundle encoding is canonical; field order is deterministic."
          - "Review receipts reference bundle hash; bundle is immutable."
      schemas:
        - id: "SCH-HEF-FAC-0002"
          path: "schemas/apm2/review_artifact_bundle_v1.yaml"
          format: "JSON_SCHEMA"
          description: "NEW WORK REQUIRED: canonical ReviewArtifactBundleV1 schema."
      evidence_ids:
        - "EVID-HEF-0011"
  outputs:
    artifacts_produced:
      - "PulseEvent frames delivered over ProtocolServer"
      - "Subscription registry entries (bounded)"
    failure_modes:
      - "PERMISSION_DENIED on unauthorized subscribe"
      - "RESOURCE_LIMIT on exceeded caps"
      - "DROP on backpressure"

  pulse_protocol_additions:
    proto_file: "proto/apm2d_runtime_v1.proto"
    tag_allocation_policy:
      - "Tag numbers are provisional until a collision audit passes."
      - "Reserve a contiguous HEF tag range in apm2d_runtime_v1.proto."
      - "Do not ship until the tag map is collision-free across all sockets."
    message_tags:
      status: "PROVISIONAL"
      session_socket:
        - "TBD (HEF reserved range) = SubscribePulseRequest"
        - "TBD (HEF reserved range) = UnsubscribePulseRequest"
        - "TBD (HEF reserved range) = PulseEvent (server -> client only)"
      operator_socket:
        - "TBD (HEF reserved range) = SubscribePulseRequest"
        - "TBD (HEF reserved range) = UnsubscribePulseRequest"
        - "TBD (HEF reserved range) = PulseEvent (server -> client only)"
    messages:
      - name: "PulseEnvelopeV1"
        description: "Lossy hint derived from committed ledger+CAS artifacts."
        size_limits:
          max_bytes: 2048
          max_entities: 8
          max_cas_refs: 8
        fields:
          - "string pulse_id (<=64, ASCII)"
          - "string topic (<=128, ASCII, dot-delimited)"
          - "uint32 schema_version = 1"
          - "uint64 ledger_cursor (seq_id)"
          - "uint64 ledger_head (optional; 0 if unknown)"
          - "bytes event_hash (32 bytes, optional)"
          - "string event_type (<=64)"
          - "repeated EntityRef entities (opaque IDs: work_id, episode_id, gate_id, defect_id)"
          - "repeated CasRef cas_refs (hash + size_bytes + kind)"
          - "optional bytes time_envelope_hash (32 bytes)"
          - "optional HlcStamp hlc (advisory only)"
          - "optional BoundedWallInterval wall (observational only)"
      - name: "EntityRef"
        fields:
          - "string kind (WORK|EPISODE|GATE|DEFECT|SESSION)"
          - "string id (<=128, ASCII)"
          - "optional bytes digest (32 bytes)"
      - name: "CasRef"
        fields:
          - "bytes hash (32 bytes)"
          - "uint64 size_bytes"
          - "string kind (EVIDENCE|TIME_ENVELOPE|TOOL_RESULT|IO_CHUNK)"
      - name: "PulseSubscribeRequest"
        description: "Client requests subscription; since_ledger_cursor is for resume hint only."
        fields:
          - "string session_token (required on session.sock)"
          - "string client_sub_id (optional, <=64)"
          - "repeated string topic_patterns (<=16 patterns, bounded wildcard grammar)"
          - "uint64 since_ledger_cursor (0 = from now)"
          - "uint32 max_pulses_per_sec (optional cap requested; server clamps)"
      - name: "PulseSubscribeResponse"
        fields:
          - "string subscription_id (server-generated)"
          - "uint64 effective_since_cursor"
          - "repeated string accepted_patterns"
          - "repeated PatternRejection rejected_patterns"
      - name: "PatternRejection"
        fields:
          - "string pattern"
          - "string reason_code (INVALID_PATTERN|ACL_DENY|LIMIT_EXCEEDED)"
      - name: "PulseUnsubscribeRequest"
        fields:
          - "string subscription_id"
      - name: "PulseUnsubscribeResponse"
        fields:
          - "bool removed"
      - name: "PulseEvent"
        description: "Server-to-client notification containing PulseEnvelopeV1."
        fields:
          - "PulseEnvelopeV1 envelope"

  fac_v0_artifact_formats:
    changeset_bundle_v1:
      status: "NEW_WORK_REQUIRED"
      schema_path: "schemas/apm2/changeset_bundle_v1.yaml"
      required_fields:
        - "schema (const: apm2.changeset_bundle.v1)"
        - "schema_version"
        - "changeset_id (opaque)"
        - "base (GitObjectRef commit/tree)"
        - "changeset_digest (32 bytes)"
        - "diff_format (git_unified_diff)"
        - "diff_hash (CAS content hash)"
        - "file_manifest (sorted, stable)"
        - "binary_detected (bool)"
      digest_rules:
        algorithm: "BLAKE3-256"
        source: "EventHasher::hash_content (crates/apm2-core/src/crypto/hash.rs:98-110) over canonical ChangeSetBundle bytes with changeset_digest omitted"
        notes:
          - "Aligns with CAS hashing (BLAKE3) to avoid dual hash families (crates/apm2-core/src/evidence/cas.rs:1-18)."
          - "Hash input is the canonical bundle object with the changeset_digest field omitted entirely (Option A)."
      canonicalization_rules:
        - "Canonical JSON serialization (RFC 8785/JCS) over the bundle object."
        - "When computing changeset_digest, omit the changeset_digest field entirely from the object prior to JCS serialization."
        - "file_manifest sorted lexicographically by normalized path (no '.', '..', or backslashes)."
        - "All paths use '/' separators and are UTF-8 NFC normalized."
        - "diff_format is fixed to git_unified_diff; no alternate encodings in v0."
        - "diff bytes are stored in CAS; diff_hash is the CAS BLAKE3 hash."
        - "Diff content is newline-normalized to LF before hashing for diff_hash."
        - "binary_detected=true MUST trigger ReviewBlocked reason_code=BINARY_UNSUPPORTED in v0."
      notes:
        - "Bundle must be CAS-hosted; pulses only carry hashes."
    review_artifact_bundle_v1:
      status: "NEW_WORK_REQUIRED"
      schema_path: "schemas/apm2/review_artifact_bundle_v1.yaml"
      required_fields:
        - "schema (const: apm2.review_artifact_bundle.v1)"
        - "schema_version"
        - "review_id"
        - "changeset_digest"
        - "review_text_hash (CAS)"
        - "tool_log_hashes (CAS)"
        - "time_envelope_ref (CAS)"
      canonicalization_rules:
        - "log hashes sorted by tool_name + seq"
        - "review_text stored as immutable CAS artifact"
      notes:
        - "Review receipts reference this bundle hash; no GitHub reads."
    review_blocked_v1:
      status: "NEW_WORK_REQUIRED"
      schema_path: "schemas/apm2/review_blocked_v1.yaml"
      required_fields:
        - "schema (const: apm2.review_blocked.v1)"
        - "schema_version"
        - "blocked_id"
        - "changeset_digest"
        - "reason_code"
        - "blocked_log_hash (CAS)"
        - "time_envelope_ref (CAS)"
      canonicalization_rules:
        - "reason_code from fixed enum"
        - "logs stored in CAS; hash references only"
      notes:
        - "Ledger event ReviewBlockedRecorded references this bundle hash."

  subscribe_semantics:
    - "SubscribePulseRequest is accepted only after handshake and privilege checks."
    - "Session subscriptions require valid session_token before ACL evaluation."
    - "Session subscriptions are deny-by-default; only capability-manifest allowlisted topics are accepted."
    - "Phase 1 session.sock rejects wildcard patterns; allowlists must enumerate exact topics."
    - "since_ledger_cursor is a resume hint; correctness requires ledger catch-up."
    - "Pulse replay buffer is optional and non-authoritative; absence is allowed."
    - "Clients must treat pulses as hints and verify via ledger/CAS."

  downgrade_resistance:
    - "JSON-framed messages are never accepted on ProtocolServer sockets (DD-009 hard cutover)."
    - "Any JSON framing received on operator.sock/session.sock results in connection close."

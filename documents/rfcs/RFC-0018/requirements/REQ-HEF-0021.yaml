rfc_requirement:
  schema_version: "2026-02-09"
  template_version: "2026-01-23"
  id: "REQ-HEF-0021"
  type: "RELIABILITY"
  title: "Dispatch idempotency, join semantics, and SHA-drift-safe resumption"
  statement: |
    FAC review dispatch MUST be idempotent for equivalent `(repo, pr_number, review_type, head_sha)`
    requests and MUST implement join semantics so concurrent equivalent requests attach to
    a single authoritative run.

    On PR head movement, active reviewer sessions MUST terminate and resume against the
    new SHA with explicit lineage receipts.

    Primary delivery ticket: TCK-00443.
  acceptance_criteria:
    - "Equivalent dispatch requests do not create duplicate reviewer executions."
    - "Concurrent equivalent dispatches return a shared run identity and join receipt."
    - "Head SHA drift triggers kill-and-resume with old/new SHA linkage and restart reason receipts."
    - "Ambiguous run ownership or stale SHA state fails closed with explicit deny status."
  evidence:
    evidence_ids:
      - "EVID-HEF-0018"
      - "EVID-HEF-0019"
    inherited_from_prd: false
    notes: []

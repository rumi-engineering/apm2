rfc_design_decisions:
  schema_version: "2026-01-30"

  definitions_and_time_model:
    overview: |
      HTF defines four clocks. Each clock has a single intended authority.
      Mixing authorities is forbidden and must be mechanically prevented.

    clocks:
      - id: L
        name: LedgerTime
        type: tuple
        fields: [ledger_id, epoch, seq]
        semantics:
          - "Total order within a ledger_id; replay-stable ordering anchor."
          - "Authoritative for 'what was true when' and admission/gate ordering."
          - "Never derived from wall time."
        production:
          - "ledger.append() returns seq"
          - "replication commit index (Phase 2+)"

      - id: M
        name: MonotonicTicks
        type: u64
        fields: [tick, tick_rate_hz, source]
        semantics:
          - "Monotone per node; not comparable across nodes."
          - "Authoritative for deadlines, retry/backoff windows, circuit breakers, quarantine TTL."
          - "Immune to wall-clock adjustments."
        production:
          source_preference_order:
            - CLOCK_MONOTONIC_RAW
            - CLOCK_MONOTONIC
          regression_handling:
            - "Emit CLOCK_REGRESSION defect"
            - "Fail-closed for high-risk decisions"

      - id: C
        name: CausalTime (HLC)
        type: tuple
        fields: [wall_ns, logical]
        semantics:
          - "Captures happens-before across nodes/messages; compact alternative to vector clocks."
          - "Used for trace stitching and cross-ledger reconciliation hints."
          - "Not authoritative for protocol truth decisions."
        algorithm:
          compare: "lexicographic (wall_ns, logical)"
          state: [last_wall_ns, last_logical]
          on_local_event: "wall=max(now_wall,last_wall); logical=(last_logical+1 if wall==last_wall else 0)"
          on_receive: "wall=max(now_wall, wall_r, last_wall); logical=casework to preserve causality"

      - id: W
        name: BoundedWallTime
        type: interval
        fields: [t_min_utc_ns, t_max_utc_ns, source, confidence]
        semantics:
          - "Human-facing wall time with uncertainty bounds."
          - "Used for display, audits, and external coordination; never used to decide internal truth."
          - "May be absent; if present, must be validated against ClockProfile.max_wall_uncertainty_ns."
        sources:
          - NONE
          - BEST_EFFORT_NTP
          - AUTHENTICATED_NTS
          - ROUGHTIME
          - CLOUD_BOUNDED
          - MANUAL_OPERATOR

    event_kinds:
      point_event:
        definition: "A single logical instant in M-time (mono.start_tick only)."
        examples:
          - "LeaseRevoked"
          - "GateOutcomeCommitted"
      span_event:
        definition: "A span in M-time (mono.start_tick..mono.end_tick inclusive)."
        examples:
          - "Episode runtime"
          - "Tool execution"

  normative_semantics_and_invariants:
    authority_matrix:
      - use_case: "Ordering / truth (admission, gate validity, reducer projections)"
        authoritative_clock: "L"
        allowed_clocks: [C, W]
        forbidden: ["W for ordering", "M for ordering"]

      - use_case: "Deadlines / TTLs / timeouts / backoff / quarantine"
        authoritative_clock: "M"
        allowed_clocks: [L, W]
        forbidden: ["W for expiry"]

      - use_case: "Cross-node trace correlation"
        authoritative_clock: "C"
        allowed_clocks: [L, M, W]
        forbidden: ["W as causal order"]

      - use_case: "External display / audits"
        authoritative_clock: "W (interval)"
        allowed_clocks: [L, M]
        forbidden: ["W as internal truth"]

    invariants:
      - id: INV-HTF-0001
        statement: "No authoritative path uses wall time for lease validity, timeouts, backoff, admission, or gate truth."
      - id: INV-HTF-0002
        statement: "All critical receipts/events include TimeEnvelopeV1 (direct or referenced) and pin ClockProfile by hash."
      - id: INV-HTF-0003
        statement: "Reducers never call runtime now(); time is consumed only as data from recorded envelopes."
      - id: INV-HTF-0004
        statement: "Metrics primary indexing uses (ledger_id, epoch, seq) windows and/or tick deltas; wall time is a non-authoritative overlay."

    human_time_policy:
      default: forbidden
      allowed_only_when:
        - "Interacting with the outside world (notifications, external SLAs, human UX)"
        - "Display-only formatting derived from HTF fields"
      enforcement:
        - "Doc lint: reject human-time units in normative docs except explicit external contexts"
        - "Type system: privileged code does not accept raw wall timestamps for expiry/ordering"

  key_design_decisions:
    - decision_id: DD-HTF-0001
      title: "Four-clock HTF model (L, M, C, W)"
      status: ACCEPTED
      statement: |
        HTF introduces four clocks with a strict authority matrix:
        - L (LedgerTime) is the only authoritative ordering clock.
        - M (MonotonicTicks) is the only authoritative duration/expiry clock.
        - C (HLC) is for cross-node correlation; advisory only.
        - W (BoundedWallTime) is for human/external display; never used as authority.
      rationale: |
        Separating authority prevents common failures:
        - replay non-determinism (reducers consulting wall time)
        - time manipulation (NTP rewind, skew, VM pause)
        - cross-node ordering errors from comparing wall timestamps.
      requirement_ids: [REQ-HTF-0001]

    - decision_id: DD-HTF-0002
      title: "TimeEnvelope is mandatory on critical artifacts"
      status: ACCEPTED
      statement: |
        Critical artifacts embed a TimeEnvelopeV1 or carry time_envelope_ref.
        The envelope carries:
        - ledger anchor (L)
        - monotonic ticks (M)
        - optional HLC (C) where relevant
        - optional bounded wall interval (W) for external display
        - clock_profile_hash pinning.
      rationale: |
        Time must be auditable, replay-stable, and signed/hardened like any other
        critical protocol input. Envelope pinning prevents silent drift in clock assumptions.
      requirement_ids: [REQ-HTF-0002]

    - decision_id: DD-HTF-0003
      title: "CAS-referenced envelopes for hot paths"
      status: ACCEPTED
      statement: |
        Events/receipts may embed TimeEnvelopeV1 when small, but the default
        is to store TimeEnvelope in CAS and reference it by content hash.
      rationale: |
        Envelope fields may grow (observations, attestation, debug notes).
        CAS-referencing keeps hot-path messages compact while preserving
        verifiability.
      requirement_ids: [REQ-HTF-0002]

    - decision_id: DD-HTF-0004
      title: "ClockProfile is governed and pinned"
      status: ACCEPTED
      statement: |
        Each node publishes a ClockProfileV1 as a governed artifact.
        TimeEnvelope includes clock_profile_hash (content hash) and
        ClockProfile constrains acceptable wall-time uncertainty.
      rationale: |
        Without a pinned profile, identical time fields can imply different
        semantics. Risk-tier policies can restrict profiles (e.g., disallow
        unbounded wall time sources).
      requirement_ids: [REQ-HTF-0007]

    - decision_id: DD-HTF-0005
      title: "Reducers are time-pure; runtime stamping happens at boundaries"
      status: ACCEPTED
      statement: |
        Reducers never consult runtime clocks. Runtime stamping occurs in the
        daemon episode controller at:
        - episode start/end
        - tool request/decision/execution boundaries
        - gate issuance and completion boundaries.

        Reducers treat envelopes as data and validate envelope invariants.
      rationale: |
        This preserves event-sourcing determinism and enables replay to be the
        source of truth for metrics, audits, and debugging.
      requirement_ids: [REQ-HTF-0003]

    - decision_id: DD-HTF-0006
      title: "Metrics axes: ledger windows + tick deltas"
      status: ACCEPTED
      statement: |
        Metrics are indexed primarily by:
        - L: (ledger_id, epoch, seq) windows for throughput and ordering
        - M: tick deltas for latency and budgets

        Wall time display is permitted only as a bounded overlay.
      rationale: |
        Primary indexing by wall time produces misleading narratives under
        clock drift and breaks auditability in replay.
      requirement_ids: [REQ-HTF-0006]

  enforcement_mechanisms:
    type_system:
      required_types:
        - LedgerTime
        - HtfTick
        - HlcStamp
        - BoundedWallInterval
        - TimeEnvelopeRef
      rules:
        - "Privileged code may not accept raw timestamps for expiry/ordering."
        - "No implicit conversions between clock domains."

    admission_and_gates:
      - "Reject artifacts missing TimeEnvelope when required."
      - "Reject artifacts attempting to use forbidden time fields for authority decisions."

    doc_lint_policy:
      escape_hatch: "EXTERNAL_TIME: prefix or explicit metadata external_time=true"
      reject_patterns:
        - "\\b\\d+\\s*(minutes?|hours?|days?|weeks?|months?|years?)\\b"
        - "\\b(ASAP|EOD|EOY|EOW)\\b"
        - "\\bnext\\s+(week|month|quarter)\\b"
      scope:
        - "documents/prds/**"
        - "documents/rfcs/**"
        - "documents/skills/**"
        - "documents/laws/**"

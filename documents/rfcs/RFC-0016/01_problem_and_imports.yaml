rfc_problem_and_imports:
  schema_version: "2026-01-30"

  intent_and_thesis:
    one_line: "Make time explicit, replay-stable, and non-forgeable by separating ordering, duration, causality, and human display into distinct clocks."
    thesis: |
      Time is an input, not an ambient authority.

      HTF defines four clocks with non-overlapping authority and makes them
      first-class data in receipts/events. Reducers never read runtime clocks;
      they only consume recorded envelopes.

      Internal truth (ordering, expiry, admission, gate validity) is anchored to
      LedgerTime and MonotonicTicks, not wall time.

  problem_statement:
    primary: |
      APM2 currently contains multiple, partially-specified time domains:
      wall timestamps in protobuf events, monotonic `Instant` timing in runtime
      paths, HLC wall time in consensus utilities, and human-duration policy
      language scattered across documents.

      This ambiguity creates three systemic failures:
      1) replay non-determinism (reducers or privileged logic consulting "now"),
      2) adversarial time manipulation (NTP rewind, skew, VM pause), and
      3) metrics theater (primary indexing by wall time rather than ledger truth).

      HTF resolves this by defining explicit clock semantics, banning wall time
      authority in normative protocol decisions, and requiring time envelopes on
      critical artifacts.

    current_state:
      observed_time_authority_leaks:
        - "proto/kernel_events.proto defines KernelEvent.timestamp and lease issued_at/expires_at fields"
        - "proto/tool_protocol.proto carries timeout_ms and duration_ms"
        - "crates/apm2-core coordination uses max_duration_ms budgets and real-time elapsed tracking"
        - "crates/apm2-core budget module documents wall-clock expiry as an external comparison"
        - "crates/apm2-core consensus HLC utilities can call SystemTime::now()"
      doc_time_underspecification:
        - "RFC-0015 and PRD-0009 intentionally defer authority semantics to HTF (TIME_TBD placeholders)"
        - "RFC-0012/RFC-0013 describe timeouts/TTLs in wall units or ms without a unified authority model"

    why_now:
      - "FAC (PRD-0009 / RFC-0015) requires time-bounded leases, quarantines, and polling intervals, but explicitly defers time authority to HTF"
      - "Coordination (PRD-0008 / RFC-0012) needs replay-stable retry/backoff/deadline semantics"
      - "Daemon runtime (RFC-0013) needs a standard envelope for episode and tool boundary receipts"
      - "Phase-2 federation requires a causality stamp (HLC) at message boundaries"

  goals:
    - id: G-HTF-0001
      statement: "Define HTF four-clock model (L, M, C, W) with explicit authority and invariants."
    - id: G-HTF-0002
      statement: "Prohibit wall time as authority for ordering, expiry, admission, gate validity, retry windows, and timeouts."
    - id: G-HTF-0003
      statement: "Require TimeEnvelope on critical receipts/events (embedded or CAS-ref) and pin ClockProfile by hash."
    - id: G-HTF-0004
      statement: "Replay determinism: reducers never consult runtime clocks; time flows only via recorded envelopes."
    - id: G-HTF-0005
      statement: "Establish enforcement: types, CAC admission rules, doc-lint, and code-lint deny wall-authority."
    - id: G-HTF-0006
      statement: "Align metrics: primary axes are ledger sequence windows and tick deltas; wall time is a bounded overlay."

  non_goals:
    - id: NG-HTF-0001
      statement: "Define a global time synchronization protocol or guarantee sub-interval accuracy across deployments."
    - id: NG-HTF-0002
      statement: "Make monotonic ticks comparable across nodes (they are node-local by design)."
    - id: NG-HTF-0003
      statement: "Require attested time sources in Phase 1 (hooks are defined; enforcement is Phase 2+ by risk tier)."
    - id: NG-HTF-0004
      statement: "Remove all legacy timestamp fields immediately; legacy fields may persist as observational metadata."

  phase_assumptions:
    phase_1_single_node:
      mandatory:
        - "LedgerTime and MonotonicTicks are available on all critical surfaces"
        - "TimeEnvelopeV1 and ClockProfileV1 exist as governed artifacts"
        - "Doc-lint/code-lint enforcement blocks new wall-authority"
      optional:
        - "BoundedWallTime recorded only for UX/external surfaces; may be absent"
      conditional:
        - "CausalTime (HLC) recommended for receipts; required at message boundaries when messaging exists"
    phase_2_federation:
      mandatory:
        - "CausalTime (HLC) on all cross-node message boundaries"
        - "Clock anomaly quarantine routing enforced"
    phase_3_strong_attestation:
      roadmap:
        - "ClockProfile attestation hooks usable for high-risk tiers"

  impacted_documents_and_modules:
    documents_to_update_or_mark_htf_ready:
      - path: "documents/prds/PRD-0009/"
        note: "Replace TIME_TBD placeholders with TimeEnvelope semantics and tick-based policies."
      - path: "documents/rfcs/RFC-0012/"
        note: "Rewrite coordination timeouts/backoff/budgets from wall units to ticks."
      - path: "documents/rfcs/RFC-0013/"
        note: "Define runtime stamping and receipts to include TimeEnvelope; eliminate wall-authority."
      - path: "documents/rfcs/RFC-0015/"
        note: "Finalize lease/quarantine/poll window semantics in ticks; wall timestamps observational only."
      - path: "documents/skills/"
        note: "Replace human-duration instructions with tick/ledger-window language; allow only explicit external contexts."

    code_to_update:
      - path: "proto/kernel_events.proto"
        note: "Add TimeEnvelope references to critical events; treat timestamp fields as non-authoritative."
      - path: "proto/tool_protocol.proto"
        note: "Add tick-based timeouts and envelope stamping surfaces; legacy timeout_ms becomes non-authoritative."
      - path: "crates/apm2-core/"
        note: "Introduce HTF types, reducer purity enforcement, tick-based lease/timeout logic."
      - path: "crates/apm2-daemon/"
        note: "Provide HolonicClock service; stamp envelopes at episode/tool boundaries; enforce OCAP time access."
      - path: "crates/apm2-cli/"
        note: "Render ticks/ledger windows for humans; never accept human time as authority inputs."

  imported_requirements:
    - prd_requirement_id: REQ-0008
      rfc_local_id: HTF-PRD-REQ-0008
      title: "Work lease mechanics are atomic and idempotent"
      statement: |
        Lease expiration is computed from event data; reducers do not depend on
        wall-clock time for replay correctness.
      acceptance_criteria:
        - "Lease expiration and renewal semantics are replay-stable"
        - "Reducer truth does not consult wall time"

    - prd_requirement_id: REQ-0019
      rfc_local_id: HTF-PRD-REQ-0019
      title: "Budgeting and resource accounting"
      statement: |
        Sessions operate under explicit budgets with deterministic accounting.
      acceptance_criteria:
        - "Budget enforcement is fail-closed"
        - "Budget accounting is replay-stable"

  additional_requirements:
    - id: REQ-HTF-0001
      title: "Four-clock model"
      statement: "HTF defines LedgerTime, MonotonicTicks, CausalTime (HLC), and BoundedWallTime with explicit authority boundaries."
      acceptance_criteria:
        - "Clock authority matrix is explicit and mechanically enforceable"

    - id: REQ-HTF-0002
      title: "TimeEnvelope is mandatory on critical artifacts"
      statement: "Critical receipts/events include TimeEnvelope (embedded or referenced) and pin ClockProfile by hash."
      acceptance_criteria:
        - "Missing envelope on required artifacts is rejected by admission"

    - id: REQ-HTF-0003
      title: "Tick-based TTLs and deadlines"
      statement: "Expiry, timeouts, backoff, and quarantine windows are enforced using MonotonicTicks, not wall time."
      acceptance_criteria:
        - "No authoritative path uses wall time for expiry/timeout/backoff"

    - id: REQ-HTF-0004
      title: "CausalTime stamping at message boundaries"
      statement: "Cross-node messages carry HLC stamps and receivers update local HLC state."
      acceptance_criteria:
        - "HLC monotonicity violations emit defects"

    - id: REQ-HTF-0005
      title: "Bounded wall time is interval-bounded and non-authoritative"
      statement: "If wall time is recorded, it is an interval with uncertainty bounds validated against ClockProfile and never used for internal truth."
      acceptance_criteria:
        - "Wall time comparisons never gate authority"

    - id: REQ-HTF-0006
      title: "No human-time units in normative artifacts by default"
      statement: "Normative documents and policies forbid human time units except explicitly external-facing contexts."
      acceptance_criteria:
        - "Doc-lint enforces the policy with a narrow escape hatch"

    - id: REQ-HTF-0007
      title: "ClockProfile governance"
      statement: "Each node publishes a governed ClockProfile referenced by hash in TimeEnvelope; policy may restrict profiles by risk tier."
      acceptance_criteria:
        - "ClockProfile changes require CAC admission"

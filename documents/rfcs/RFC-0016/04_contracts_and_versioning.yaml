rfc_contracts_and_versioning:
  schema_version: "2026-01-30"

  schema_governance:
    canonicalizer_contract:
      canonicalizer_id: "cac-canon"
      canonicalizer_version: "1.0.0"
      vectors_ref: "dcp://apm2.local/canonicalizers/jcs_vectors@v1"
      notes: |
        HTF artifacts are CAC-JSON artifacts.
        The canonical bytes for signing/hashing are the output of the canonicalizer.

    versioning_policy:
      - "TimeEnvelopeV1 and ClockProfileV1 are versioned schemas (v1 -> v2 major bumps)."
      - "Unknown fields are rejected (fail-closed)."
      - "Optional fields are omitted when absent (do not encode nulls)."

  core_types:
    - type_id: HTF-TYPE-0001
      name: LedgerTime
      definition: |
        Tuple (ledger_id, epoch, seq).
        - ledger_id: stable identifier for a ledger namespace.
        - epoch: changes on authority/config changes.
        - seq: monotone increasing within (ledger_id, epoch).

    - type_id: HTF-TYPE-0002
      name: HtfTick
      definition: |
        Node-local monotonic tick counter (u64).
        Tick arithmetic is authoritative for deadlines and durations.

    - type_id: HTF-TYPE-0003
      name: TimeEnvelopeRef
      definition: |
        Content hash reference to a TimeEnvelope CAC artifact stored in CAS.
        The reference is used in hot-path protobuf events to avoid embedding.

  cac_schemas:
    - schema_id: SCH-HTF-0001
      name: ClockProfileV1
      schema: "cac.clock_profile.v1"
      kind: "clock.profile"
      purpose: |
        Declares the clock assumptions for a node/runtime.
        Policies may restrict acceptable profiles by risk tier.
      payload_fields:
        profile_policy_id: "stable identifier for policy grouping"
        tick_rate_hz: "u32 (must match envelopes)"
        monotonic_source: "enum (CLOCK_MONOTONIC_RAW | CLOCK_MONOTONIC | OTHER)"
        hlc_enabled: "bool"
        wall_time_source: "enum (NONE | BEST_EFFORT_NTP | AUTHENTICATED_NTS | ROUGHTIME | CLOUD_BOUNDED | MANUAL_OPERATOR)"
        max_wall_uncertainty_ns: "u64"
        build_fingerprint: "hash (daemon version + platform)"
        attestation: "optional (Phase 2+)"
      governance:
        - "ClockProfile is a governed artifact; changes require CAC admission."
        - "High-risk work may restrict allowed profiles (policy)."

    - schema_id: SCH-HTF-0002
      name: TimeEnvelopeV1
      schema: "cac.time_envelope.v1"
      kind: "time.envelope"
      purpose: |
        Standard time envelope attached to critical events/receipts.
        Provides ledger anchor (ordering), monotonic ticks (duration/expiry),
        optional HLC stamp (correlation), and optional bounded wall interval (display).
      payload_fields:
        clock_profile_hash: "content hash of ClockProfileV1"
        ledger_anchor: "LedgerTime tuple"
        mono:
          start_tick: "u64"
          end_tick: "u64 (optional; absent for point events)"
          tick_rate_hz: "u32"
          source: "enum (CLOCK_MONOTONIC_RAW | CLOCK_MONOTONIC | OTHER)"
        hlc:
          wall_ns: "u64"
          logical: "u32"
          note: "optional in Phase 1; required at federation boundaries"
        wall:
          t_min_utc_ns: "u64"
          t_max_utc_ns: "u64"
          source: "enum (NONE | BEST_EFFORT_NTP | AUTHENTICATED_NTS | ROUGHTIME | CLOUD_BOUNDED | MANUAL_OPERATOR)"
          confidence: "string or enum (deployment-defined)"
          note: "optional; never authoritative"
        notes: "string (optional; non-authoritative)"
      invariants:
        - "mono.end_tick >= mono.start_tick when end_tick present"
        - "mono.tick_rate_hz matches ClockProfile.tick_rate_hz"
        - "ledger_anchor monotone non-decreasing per session (defect on violation)"
        - "hlc monotone per session when present (defect on violation)"
        - "(wall.t_max_utc_ns - wall.t_min_utc_ns) <= ClockProfile.max_wall_uncertainty_ns when wall present"

    - schema_id: SCH-HTF-0003
      name: TimeSyncObservationV1 (optional)
      schema: "cac.time_sync_observation.v1"
      kind: "time.sync_observation"
      purpose: |
        Optional observational artifact recording time source measurements.
        Not used for protocol truth; supports audits and debugging.
      payload_fields:
        observed_at_envelope_ref: "TimeEnvelopeRef"
        observations: "list of source-specific measurements"

  canonicalization_and_vectors:
    requirements:
      - id: CAN-HTF-0001
        statement: "Canonicalization must be deterministic across languages."
      - id: CAN-HTF-0002
        statement: "Arrays that are semantically sets are sorted deterministically before signing/hashing."
      - id: CAN-HTF-0003
        statement: "Optional fields are omitted when absent; null is forbidden."

    required_vectors:
      - vector_set_id: TV-HTF-0001
        title: "ClockProfile canonicalization"
        must_cover:
          - "enum field encoding"
          - "presence/absence of optional fields"
          - "hash pinning stability"

      - vector_set_id: TV-HTF-0002
        title: "TimeEnvelope canonicalization"
        must_cover:
          - "point event (no end_tick)"
          - "span event (start/end)"
          - "wall present with bounded interval"
          - "wall absent"
          - "hlc present/absent"

    evidence_requirement:
      - "Vectors must be verified in CI and treated as signature-critical artifacts."

  compatibility_and_deprecation:
    legacy_timestamp_fields:
      rule: |
        Legacy wall timestamp fields may remain for observational metadata only.
        Admission and reducers must ignore them for authority decisions.
      migration_expectation:
        - "Introduce time_envelope_ref alongside legacy fields"
        - "Mark legacy fields deprecated in docs and generated types"
        - "Eventually remove legacy fields at a major schema bump"

rfc_trust_boundaries:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  boundaries:
    - id: "TB-0001"
      name: "Session-Kernel Tool Execution Boundary"
      description: |
        Tool requests from sessions cross into kernel execution space.
        The kernel executes tools on behalf of sessions with capability-bounded permissions.
      actors:
        - "Session (reviewer agent)"
        - "ToolBroker (kernel)"
        - "ToolExecutor (kernel)"
      entrypoints:
        - "RequestTool IPC message"
      data_flows:
        - "Session -> RequestTool -> Broker -> Executor -> CAS -> Session (result)"
      authn_authz:
        authn: "Session ID bound at spawn via SpawnEpisode"
        authz: "CapabilityManifest allowlist checked by Broker before execution"
      risks:
        - id: "RSK-TB-001"
          description: "Legacy allow path bypasses capability checks"
          mitigation: "Remove/gate legacy allow path; require broker in production"
      evidence_ids: []

    - id: "TB-0002"
      name: "Workspace Filesystem Boundary"
      description: |
        Reviewer tools operate within isolated workspace directories.
        Path traversal must be prevented to maintain isolation.
      actors:
        - "ToolExecutor"
        - "ListFilesHandler"
        - "SearchHandler"
        - "Filesystem"
      entrypoints:
        - "ListFiles tool request"
        - "Search tool request"
        - "apply_changeset workspace creation"
      data_flows:
        - "Tool request -> Handler -> Workspace root -> Filesystem -> CAS-stored result"
      authn_authz:
        authn: "Workspace root bound per-episode"
        authz: "Canonical path resolution within workspace root"
      risks:
        - id: "RSK-TB-002"
          description: "Symlink escape from workspace"
          mitigation: "Block symlinks pointing outside workspace; use canonical path checks"
        - id: "RSK-TB-003"
          description: "Patch apply writes outside root"
          mitigation: "Validate all patch paths before apply; fail closed on suspicious paths"
      evidence_ids: []

    - id: "TB-0003"
      name: "CAS-Ledger Persistence Boundary"
      description: |
        All durable state flows through CAS (content) and ledger (events).
        External systems are projections, not sources of truth.
      actors:
        - "SessionDispatcher"
        - "EpisodeRuntime"
        - "CAS"
        - "Ledger"
        - "ProjectionWorker"
      entrypoints:
        - "PublishEvidence IPC message"
        - "EmitEvent IPC message"
        - "Projection worker ledger tail"
      data_flows:
        - "Evidence -> CAS -> hash returned"
        - "Event -> Ledger -> commit confirmation"
        - "Ledger commit -> ProjectionWorker -> External system"
      authn_authz:
        authn: "Session ID validates event origin"
        authz: "Event type determines which sessions can emit"
      risks:
        - id: "RSK-TB-004"
          description: "Events emitted without CAS artifacts existing"
          mitigation: "Store CAS artifacts atomically before emitting referencing event"
        - id: "RSK-TB-005"
          description: "Projection state diverges from ledger"
          mitigation: "Projection receipts anchor all external writes; divergence detection"
      evidence_ids: []

    - id: "TB-0005"
      name: "Capability Manifest Integrity Boundary"
      description: |
        Capability manifests determine what tools sessions can execute.
        Manifest integrity must be verified from storage through assignment.
      actors:
        - "PolicyResolver"
        - "SpawnEpisode handler"
        - "CAS"
        - "SessionDispatcher"
      entrypoints:
        - "SpawnEpisode policy resolution"
        - "Manifest load from CAS"
      data_flows:
        - "PolicyResolved -> manifest_hash -> CAS lookup -> CapabilityManifest -> Session"
      authn_authz:
        authn: "Manifest identified by content hash (CAS-addressed)"
        authz: "PolicyResolver determines which manifest hash is assigned"
      risks:
        - id: "RSK-TB-008"
          description: "Manifest tampering between storage and use"
          mitigation: "CAS content addressing ensures integrity; hash verification on load"
        - id: "RSK-TB-009"
          description: "Policy resolution assigns wrong manifest"
          mitigation: "Policy rules are auditable; manifest assignment logged in spawn event"
      evidence_ids: []

    - id: "TB-0004"
      name: "GitHub Projection Boundary"
      description: |
        GitHub is an output target, never a source of truth.
        All GitHub writes are derived from internal ledger state.
        Production agent runtimes are not admissible direct GitHub writers.
      actors:
        - "ProjectionWorker"
        - "GitHub API"
      entrypoints:
        - "Projection worker GitHub adapter"
      data_flows:
        - "Ledger -> ProjectionWorker -> GitHub API -> ProjectionReceipt -> CAS+Ledger"
      authn_authz:
        authn: "GitHub token managed by projection worker"
        authz: "Projection worker only; production agent runtimes deny direct gh/GitHub API actuation"
      risks:
        - id: "RSK-TB-006"
          description: "GitHub state tampered externally"
          mitigation: "Projection divergence detection + channel quarantine + replay-safe rebuild; CAS/ledger remains authoritative truth root"
        - id: "RSK-TB-007"
          description: "Duplicate projections on restart"
          mitigation: "Durable projection receipts with idempotency keys"
        - id: "RSK-TB-015"
          description: "Agent runtime directly invokes GitHub API/gh with privileged scope"
          mitigation: "Capability-surface hard deny for production roles; projection isolation gate blocks and emits structured defects"
      evidence_ids: []

    - id: "TB-0006"
      name: "ContextPack Firewall Boundary"
      description: |
        All diffs, tool outputs, and workspace material are adversarial inputs.
        Episodes MUST consume bounded context via sealed ContextPacks and a broker-side
        context firewall. Reads outside the ContextPack surface are denied (fail closed)
        and recorded as defects/blocked outcomes.
      actors:
        - "Session (reviewer agent)"
        - "ToolBroker (kernel)"
        - "ContextFirewall (kernel)"
        - "CAS"
      entrypoints:
        - "SpawnEpisode context_pack_hash binding"
        - "Tool requests requiring repository reads"
      data_flows:
        - "context_pack_hash -> CAS lookup -> ContextPack manifest/spec -> Broker enforcement"
        - "Tool request -> ContextFirewall -> Allow/Deny -> Tool execution (if allowed) -> CAS"
      authn_authz:
        authn: "ContextPack identified by content hash (CAS-addressed)"
        authz: "ContextPack allowlists bound at spawn; broker denies out-of-pack reads"
      risks:
        - id: "RSK-TB-010"
          description: "Context poisoning/prompt injection via diffs and tool outputs"
          mitigation: "Sealed ContextPacks + structured tool APIs + hash-addressed evidence; zoom-in only by hash under budgets"
        - id: "RSK-TB-011"
          description: "Ambient discovery/read paths bypass firewall"
          mitigation: "Deny all non-pack reads by default; conformance tests enforce fail-closed behavior"
      evidence_ids: []

    - id: "TB-0007"
      name: "Stop-State Gate Boundary"
      description: |
        Stop-order gating is mandatory: before any actuation (tool execution, evidence publish,
        event emission, external projection), the kernel MUST verify stop-state. If stop-state is
        missing or unverifiable, the actuation is denied (fail closed).
      actors:
        - "Kernel stop gate"
        - "ToolBroker"
        - "SessionDispatcher"
        - "ProjectionWorker"
        - "Ledger"
      entrypoints:
        - "RequestTool"
        - "PublishEvidence"
        - "EmitEvent"
        - "Projection worker actuation"
      data_flows:
        - "stop_condition_hash -> verify binding -> allow/deny actuation"
      authn_authz:
        authn: "Stop-state referenced by hash and bound by delegation (PermeabilityReceipt/lease)"
        authz: "Stop gate is authoritative; denial is terminal/blocked per policy"
      risks:
        - id: "RSK-TB-012"
          description: "Actuation proceeds despite missing/unverifiable stop-state"
          mitigation: "Fail closed; treat as defect; record ReviewBlockedRecorded with STOP_STATE_MISSING"
      evidence_ids: []

    - id: "TB-0008"
      name: "Harness Adapter Boundary (external CLI integration)"
      description: |
        External agent harnesses (vendor CLIs, local inference) are untrusted processes.
        Agent outputs are hints; the ledger is authoritative. Kernel-side tool execution is
        mandatory; adapters normalize harness I/O into tool intents and lifecycle signals.
        Adapter selection is explicit and hash-addressed via AgentAdapterProfileV1.
      actors:
        - "Agent harness process"
        - "AdapterRuntime"
        - "SessionDispatcher"
        - "ToolBroker"
        - "CAS/Ledger"
      entrypoints:
        - "Adapter spawn using adapter_profile_hash"
        - "Structured output / tool intent parsing"
      data_flows:
        - "Harness output -> Adapter parse -> ToolRequest -> Broker -> ToolExec -> CAS -> injected result -> Harness"
        - "Adapter + Broker -> Ledger events attributing (work_id, episode_id, session_id, adapter_profile_hash)"
      authn_authz:
        authn: "Adapter profile hash + session identity"
        authz: "Broker capability manifest enforcement; adapter cannot execute tools directly"
      risks:
        - id: "RSK-TB-013"
          description: "Output-format drift causes mis-parse or silent tool bypass"
          mitigation: "Conformance tests + strict parsing + fail-closed on parse errors"
        - id: "RSK-TB-014"
          description: "Misconfigured adapter profile grants ambient authority"
          mitigation: "Profiles are hash-addressed and audited; kernel-side tool execution enforced; deny on misconfiguration"
      evidence_ids: []

rfc_problem_and_imports:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  imported_from_prd:
    problem_ref: "02_problem.yaml#prd_problem"
    goals_scope_ref: "03_goals_scope.yaml#prd_goals_scope"
    constraints_invariants_ref: "06_constraints_invariants.yaml#prd_constraints_invariants"
    quality_framework_ref: "10_quality_framework.yaml#prd_quality_framework"
  protocol_profile_imports:
    required_rfc_section_refs:
      - "documents/prds/PRD-0009/00_meta.yaml#prd_meta.law_alignment"
      - "documents/prds/PRD-0010/00_meta.yaml#prd_meta.law_alignment"
  rfc_specific_problem_detail:
    additional_context: |
      RFC-0018 and recent PRs (387, 389) established FAC v0 primitives:
      - ChangeSetBundleV1, ReviewArtifactBundleV1, ReviewReceiptRecorded
      - E2E test harness in crates/apm2-daemon/tests/hef_fac_v0_e2e.rs
      - Reviewer navigation tools ListFiles and Search

      However, **automated FAC does not yet exist** because daemon control-plane wiring is incomplete:
      - Sessions are not viable (no real RequestTool execution path, no real PublishEvidence/EmitEvent persistence)
      - Workspace apply is stubbed
      - Tool logs are not surfaced into receipts
      - Projection is present but not wired

      This RFC specifies the remaining integration to reach automated FAC v0.
    out_of_scope_confirmations:
      - "Full merge automation (MergeReceipt, auto-merge) beyond minimal review gate + projection"
      - "Production-grade distributed scheduling"
      - "Replacing all legacy codepaths in one sweep (incremental cutover)"
  non_negotiable_constraints:
    - id: "NC-001"
      statement: "Truth is internal: ledger + CAS are the system of record; external systems (GitHub, git remote) are inputs/effects, not truth"
      law_refs: ["LAW-03"]
      evidence_ref: "documents/prds/PRD-0009/00_meta.yaml#prd_meta.classification.notes"
    - id: "NC-002"
      statement: "Fail closed: no stub-allow paths for tool execution, event emission, or evidence publication in session workflows"
      law_refs: ["LAW-01", "LAW-15"]
      evidence_ref: "documents/prds/PRD-0009/00_meta.yaml#prd_meta.classification.notes"
    - id: "NC-003"
      statement: "No regression to legacy JSON IPC: new functionality lands on ProtocolServer tag-based dispatchers and structured protocols (RFC-0017 line)"
      evidence_ref: "documents/rfcs/RFC-0017/"
    - id: "NC-004"
      statement: "OCAP only: capabilities are not discoverable; tool authority enters an episode only via explicit delegation (capability manifest by hash)"
      law_refs: ["LAW-05"]
      evidence_ref: "documents/theory/unified-theory-v2.json#ocap"
    - id: "NC-005"
      statement: "Stop-order gating is mandatory: before any actuation (tool execution, evidence publish, event emission, external projection), the kernel MUST verify stop-state; if stop-state is missing or unverifiable: deny (fail-closed)"
      law_refs: ["LAW-05", "LAW-12", "LAW-15"]
      evidence_ref: "documents/theory/unified-theory-v2.json#stop-order"
    - id: "NC-006"
      statement: "View commitments are mandatory: every episode + receipt binds to a ledger anchor and a pinned world (repo/deps/policy/toolchain/model digests); no ambient HEAD/filesystem truth"
      law_refs: ["LAW-03", "LAW-09"]
      evidence_ref: "schemas/apm2/view_commitment.schema.json"
    - id: "NC-007"
      statement: "Idempotent actuation: every external side-effect uses a dedupe key and emits an execution/projection receipt; retries are safe by construction"
      law_refs: ["LAW-11"]
      evidence_ref: "proto/kernel_events.proto"
    - id: "NC-008"
      statement: "Small messages, big evidence: inter-holon communication is receipts + selectors; large payloads live in CAS and are referenced by hash"
      evidence_ref: "documents/theory/unified-theory-v2.json#evidence-economics"
    - id: "NC-009"
      statement: "Constraint precedence: when constraints conflict, apply Security/Containment > Verification/Correctness > Liveness/Progress; if containment blocks sufficient context/capabilities, terminate/decompose/escalate and record a defect/decision"
      evidence_ref: "documents/theory/unified-theory-v2.json#dominance-order"
    - id: "NC-010"
      statement: "Typed quantities only: budgets/timeouts/limits MUST be typed quantities (unitful) at the boundary; never interpret naked integers as seconds/tokens/bytes across holons"
      law_refs: ["LAW-13"]
      evidence_ref: "documents/theory/unified-theory-v2.json#typed-quantities"
  module_contract_ref: "00_meta.yaml#rfc_meta.module_contract"
  design_north_stars:
    - id: "NS-001"
      statement: "Closed-loop promotion only: actuation is never promoted without a verifiable receipt"
    - id: "NS-002"
      statement: "Boundary discipline: internal reasoning is ephemeral; only selected outputs cross the boundary as receipts + evidence pointers"
    - id: "NS-003"
      statement: "Compression-first: coordination is via hashes/selectors and verifiable summaries, not transcripts"
    - id: "NS-004"
      statement: "Recursion by default: every holon is both supervisor and subordinate; interfaces must compose without bespoke coupling"
    - id: "NS-005"
      statement: "Crash-only recovery: restart from committed facts; never depend on process memory for truth"
  holonic_boundary_discipline:
    - id: "HB-01"
      statement: "Seclusion: episode internal state (model scratchpad, in-memory logs, transient summaries) is non-durable and MUST be treated as garbage after completion"
    - id: "HB-02"
      statement: "Commitment filter: only explicitly selected artifacts may cross the boundary into CAS/ledger; 'nice to have' logs are not admissible truth"
    - id: "HB-03"
      statement: "Crash-only corollary: if an episode violates invariants (missing pins, missing broker, tool escape attempt, entropy runaway), terminate and restart from last committed checkpoint; do not continue on best-effort"
    - id: "HB-05"
      statement: "Interface variety control: supervisors control typed signals/contracts (receipts, selectors, budgets), not internal agent complexity; this RFC must not introduce untyped chatty coordination as an interface"
  channel_separation:
    channels:
      - id: "DISCOVERY"
        trust: "LOW"
        bandwidth: "LOW"
        budgeting: "prune aggressively"
      - id: "HANDSHAKE"
        trust: "AUDITED"
        bandwidth: "LOW"
        budgeting: "lease/budget bounded"
      - id: "WORK"
        trust: "CONTRACT_BOUND"
        bandwidth: "MEDIUM"
        budgeting: "stop-conditions and budgets apply"
      - id: "EVIDENCE"
        trust: "CRYPTOGRAPHIC"
        bandwidth: "HIGH (by reference)"
        budgeting: "evidence budget; content-addressed retrieval"
    zti_note: "FAC v0 may use discovery minimally, but MUST be correct if discovery is absent (ZTI direction)."
  holarchy_protocol_v1:
    description: "Ordered interaction without chat: small, typed, hash-addressed messages; artifacts are replayable across holons/cells."
    channel_classes_ref: "channel_separation.channels"
    permeability_receipt_v1:
      normative: true
      requirement: "Capabilities MUST NOT be discovered; they only enter a holon via explicit delegation receipts."
      storage: "MUST be stored in CAS and referenced by hash from any episode/receipt that uses its authority."
      fields:
        binds:
          - "delegator_holon_id"
          - "delegatee_holon_id"
          - "work_id"
          - "lease_id"
        delegates:
          - "capability_manifest_hash"
          - "context_pack_hash"
        bounds:
          - "budgets"
          - "stop_condition_hash"
          - "expiry (HTF time envelope ref)"
        commits:
          - "view_commitment_hash (or selector to derive it)"
    holon_interface_contract_v1:
      normative: true
      inputs:
        - "holon_id (stable identity)"
        - "work_id (stable)"
        - "changeset_digest (stable)"
        - "lease_id (explicit)"
        - "permeability_receipt_hash (explicit authority entry)"
        - "capability_manifest_hash + context_pack_hash (delegated handles)"
        - "budgets (typed quantities) + stop_condition_hash"
      outputs:
        - "receipt_hash (CAS)"
        - "ledger_anchor (event hash / seq)"
        - "summary_receipt_hash (lossy but verifiable; zoom-in via selectors)"
        - "defect_ids (optional)"
      state: "No durable hidden state; all durable state reducible from ledger+CAS."
    ordered_interaction:
      normative: true
      sequence:
        - "Handshake: supervisor issues lease + PermeabilityReceipt (by hash)."
        - "Work: subordinate runs bounded episode(s) under that receipt."
        - "Commit: subordinate emits ReviewReceipt/Blocked + summary receipt."
        - "Evidence: supervisor fetches by hash on demand; anti-entropy replicates facts."
  scope_and_scaling_model:
    cell_scope: "Single daemon deployment boundary ('one cell'); interfaces/artifacts must be federation-ready while implementation stays minimal."
    delivers_strict:
      - "One end-to-end FAC loop per changeset: ingest -> episode -> receipt -> project"
      - "All durable outputs verifiable from ledger+CAS (no reliance on process memory)"
      - "Tool execution mediated by capability manifests and (when enabled) context firewalling"
    does_not_deliver:
      - "Global scheduling, global consensus, or multi-region HA"
      - "Cross-repo / cross-org policy governance"
      - "Autonomous merging beyond minimal review/projection semantics"
    civilizational_scale_constraints:
      - id: "CSC-001"
        statement: "Compression + addressability over chatty coordination: receipts/digests/selectors/summary receipts; zoom-in by hash on demand."
      - id: "CSC-002"
        statement: "Recursion is default: reviewer episode is a leaf holon; supervisory holons remain above; FAC v0 must not embed their logic."
      - id: "CSC-003"
        statement: "Failure is normal: retries/duplication/partitions expected; only valid response is idempotency + receipts."
      - id: "CSC-004"
        statement: "No ambient workspace truth: workspace is a projection; every episode binds to a ViewCommitment (ledger anchor + pinned world + optional delta)."
      - id: "CSC-005"
        statement: "Anti-entropy readiness: all durable artifacts content-addressed; ledger events deterministic/replayable; projections derivable from receipts via pure reducers and safe to replay."
      - id: "CSC-006"
        statement: "Verifiable summaries: supervisory holons operate primarily on summary receipts + selectors; raw transcripts/logs are evidence retrieved by hash."
      - id: "CSC-007"
        statement: "Monotone compaction/summarization: derived artifacts reference prior history by hash/range and declare derivation method/version and loss profile; GC/TTL is non-semantic."
    minimal_holon_to_holon_interface:
      exchange_only:
        ids_and_digests:
          - "work_id"
          - "changeset_digest"
          - "artifact_bundle_hash"
          - "projection_receipt_hash"
        delegations:
          - "capability_manifest_hash"
          - "context_pack_hash"
        outcomes:
          - "ReviewReceiptRecorded"
          - "ReviewBlockedRecorded"
          - "DefectRecorded"
          - "ContextRefinementRequest"
      recursion_stability_required:
        budgets:
          - "tool_call_budget"
          - "token_budget"
          - "wall_clock_budget"
          - "evidence_budget"
        stop_conditions: "terminal predicates for the loop (pass/fail/needs-input)"
        summary_receipts: "lossy but verifiable 'front pages' with selectors to zoom into evidence by hash"
  definitions:
    - term: "Holon"
      normativity: "BACKGROUND"
      definition: "A bounded agent/service with explicit inputs/outputs and bounded authority (leases/budgets), capable of producing evidence-bearing receipts."
    - term: "Cell"
      normativity: "NORMATIVE"
      definition: "One daemon deployment boundary owning a local ledger+CAS instance and running the FAC control loop."
    - term: "Truth plane"
      normativity: "NORMATIVE"
      definition: "Ledger + CAS. Only truth-plane artifacts may drive admission/projection decisions."
    - term: "Pulse plane"
      normativity: "EXPLANATORY"
      definition: "Derived wakeups (HEF pulses) that hint 'something changed' but are never authoritative."
    - term: "ChangeSetBundleV1"
      normativity: "NORMATIVE"
      definition: "Canonical diff/manifest stored in CAS and anchored by ChangeSetPublished."
    - term: "Reviewer episode"
      normativity: "NORMATIVE"
      definition: "Bounded tool-using execution with explicit capabilities + context pack and explicit stop conditions."
    - term: "ReviewArtifactBundleV1"
      normativity: "NORMATIVE"
      definition: "CAS bundle containing review output + tool result references + view commitment material."
    - term: "ViewCommitment"
      normativity: "NORMATIVE"
      definition: "Compact header binding an episode/receipt to ledger anchor + pinned world + selectors so other holons can verify and replay."
    - term: "PermeabilityReceiptV1"
      normativity: "NORMATIVE"
      definition: "Explicit authority delegation artifact introducing capability/context/budget handles into a holon without discovery."
    - term: "ToolExecutionReceipt"
      normativity: "NORMATIVE"
      definition: "Signed receipt proving a tool call occurred, binding args/result hashes + policy/time envelope under the episode envelope."
    - term: "ToolLogIndexV1"
      normativity: "NORMATIVE"
      definition: "Canonical, chunkable (Merkle-friendly) index of tool-log hashes for an episode."
    - term: "SummaryReceipt"
      normativity: "NORMATIVE"
      definition: "Compact lossy artifact that declares loss profile and provides selectors to zoom into evidence by hash."
  architecture_overview:
    fac_v0_control_loop:
      - id: "LOOP-INGRESS"
        statement: "Ingress (adapter): external diff -> CAS artifact -> ChangeSetPublished"
      - id: "LOOP-EPISODE"
        statement: "Episode (contained execution): bounded tools + rooted workspace -> CAS tool results"
      - id: "LOOP-RECEIPT"
        statement: "Receipt (truth-plane commit): ReviewArtifactBundle -> ReviewReceiptRecorded / ReviewBlockedRecorded"
      - id: "LOOP-PROJECTION"
        statement: "Projection (output-only reducer): ledger -> GitHub write -> ProjectionReceipt (CAS) -> optional ledger anchor"
    key_components_to_integrate:
      - "FAC Ingress (adapter): stores diff bytes and ChangeSetBundleV1 in CAS; appends ChangeSetPublished to ledger"
      - "Workspace Manager (sandbox): materializes isolated workspace from pinned base + diff; safe apply; produces ViewCommitment (+ optional WorkspaceDelta); provides workspace root to tools"
      - "Episode Runner (review holon): spawns reviewer runtime/adapter; mediates tool calls under manifests + sealed context pack firewall; kernel executes tools; stores results in CAS"
      - "Review Receipt Builder (truth-plane commit): stores review body/tool logs/bundles; appends ReviewReceiptRecorded to ledger"
      - "Projection Worker (reducer): tails ledger; derives GitHub status/comment from internal receipts; stores durable projection receipts; idempotent replay"
      - "Projection Worker wakeups MAY use HEF pulses to reduce latency, but pulses are advisory only; ledger is authoritative (truth plane)."
  fac_admission_state_machine_v0:
    normative: true
    idempotency_rule: "Every transition MUST be replay-safe; replaying ledger events after restart MUST converge without duplicate external side-effects."
    transitions:
      - state: "INGESTED"
        cas:
          - "diff_bytes stored -> diff_hash"
          - "ChangeSetBundleV1 stored -> bundle_hash"
        ledger:
          - "ChangeSetPublished(changeset_digest, bundle_hash, time_envelope_ref)"
      - state: "POLICY_BOUND"
        ledger:
          - "PolicyResolvedForChangeSet(work_id, changeset_digest, risk/determinism/rcp/verifier hashes, ...)"
        notes:
          - "Governance semantics out-of-scope; FAC refuses to proceed without valid binding."
      - state: "AUTHORITY_BOUND"
        preconditions:
          - "Valid LeaseIssued exists for work_id"
          - "Valid PermeabilityReceiptV1 exists in CAS and is referenced by hash"
          - "capability_manifest_hash, context_pack_hash, budgets, stop_condition_hash are bound by that receipt"
        stop_gating:
          - "Kernel verifies stop-state prior to continuing; deny if unverifiable"
        failures:
          - "ReviewBlockedRecorded(reason=LEASE_MISSING|DELEGATION_MISSING|STOP_STATE_MISSING, ...)"
      - state: "WORKSPACE_READY"
        projection:
          - "Workspace materialized from pinned base + diff_hash"
        cas:
          - "ViewCommitment stored -> view_commitment_hash"
        failures:
          - "ReviewBlockedRecorded(reason=APPLY_FAILED|PIN_MISSING|ESCAPE_ATTEMPT, ...)"
      - state: "EPISODE_EXECUTED"
        ledger:
          - "Episode lifecycle + tool events streamed during execution (HEF-ready)"
        cas:
          - "Each tool result stored (ToolResultData)"
          - "ToolExecutionReceipt stored per tool actuation (signed; proof-carrying)"
          - "ToolLogIndex stored (indexes ToolExecutionReceipt hashes; hash-first, chunkable)"
        stop_gating:
          - "Checked before each tool actuation (deny if unverifiable)"
      - state: "RECEIPT_RECORDED"
        cas:
          - "Review artifacts bundle stored (includes bindings + tool log index)"
          - "SummaryReceipt stored and referenced by hash from artifacts"
        ledger:
          - "ReviewReceiptRecorded(changeset_digest, artifact_bundle_hash, time_envelope_ref, ...)"
      - state: "PROJECTED"
        reducer:
          - "Derive GitHub writes (status/comment) from ledger+CAS"
        cas:
          - "ProjectionReceipt stored (dedupe key + request/response hashes)"
        ledger_optional:
          - "ProjectionReceiptRecorded(...) (recommended)"
        stop_gating:
          - "Checked before any external write (deny if unverifiable)"
  requirement_binding:
    bound_requirement_ids:
      - "REQ-0001"  # Session dispatcher viability
      - "REQ-0002"  # Capability manifests
      - "REQ-0003"  # Workspace apply and isolation
      - "REQ-0004"  # Tool result hash propagation
      - "REQ-0005"  # Episode event persistence
      - "REQ-0006"  # Projection worker wiring
      - "REQ-0007"  # xtask authority reduction
      - "REQ-0008"  # ViewCommitment + ContextPack binding (holon-ready receipts)
      - "REQ-0009"  # Agent adapter profiles (heterogeneous CLIs)
      - "REQ-0010"  # Proof-carrying tool execution + summary receipts
    added_rfc_only_requirements:
      mode: "FILE_PER_REQUIREMENT"
      local_root: "requirements/"
      local_requirements:
        - id: "REQ-0001"
          file_ref: "requirements/REQ-0001.yaml"
        - id: "REQ-0002"
          file_ref: "requirements/REQ-0002.yaml"
        - id: "REQ-0003"
          file_ref: "requirements/REQ-0003.yaml"
        - id: "REQ-0004"
          file_ref: "requirements/REQ-0004.yaml"
        - id: "REQ-0005"
          file_ref: "requirements/REQ-0005.yaml"
        - id: "REQ-0006"
          file_ref: "requirements/REQ-0006.yaml"
        - id: "REQ-0007"
          file_ref: "requirements/REQ-0007.yaml"
        - id: "REQ-0008"
          file_ref: "requirements/REQ-0008.yaml"
        - id: "REQ-0009"
          file_ref: "requirements/REQ-0009.yaml"
        - id: "REQ-0010"
          file_ref: "requirements/REQ-0010.yaml"
      rationale: "RFC-0019 defines integration requirements to close FAC v0 automation gaps"
      evidence_policy: "RFC-only requirements define evidence in 07_test_and_evidence.yaml"

  current_state_snapshot_post_pr_387_389:
    source_ref: "AUTONOMOUS_FORGE_ADMISSION_CYCLE.md#Current state (post PR #387 + PR #389)"
    note: "Captured for provenance from the original narrative draft; file/line references are draft snapshot indicators."
    in_place_usable_primitives:
      - "FAC v0 artifact schemas and canonicalization exist (ChangeSetBundleV1, ReviewArtifactBundleV1, ReviewReceiptRecorded)."
      - "E2E harness exists (crates/apm2-daemon/tests/hef_fac_v0_e2e.rs) demonstrating intended ledger->receipt flow at test level."
      - "Reviewer navigation tools ListFiles and Search handlers exist post PR #389."
      - "Projection adapter primitives exist (write-only projection + projection receipts), but no long-running reducer wiring."
      - "Tool broker + context firewall primitives exist, but are not consistently initialized from sealed ContextPacks."
    blocking_automation_gaps:
      - id: "CSG-0001"
        statement: "Session dispatcher not wired to real stores/broker (SessionDispatcher constructed without CAS/ledger/clock/broker)."
        draft_evidence_ref: "crates/apm2-daemon/src/state.rs:349-352"
      - id: "CSG-0002"
        statement: "Session RequestTool has legacy ALLOW fallback when broker absent (manifest allowlist becomes effective behavior)."
        draft_evidence_ref:
          - "crates/apm2-daemon/src/protocol/session_dispatch.rs:967-997"
          - "crates/apm2-daemon/src/protocol/session_dispatch.rs:1016-1029"
      - id: "CSG-0003"
        statement: "SpawnEpisode installs empty capability allowlist stub (deny-all); reviewer cannot progress."
        draft_evidence_ref: "crates/apm2-daemon/src/protocol/dispatch.rs:2911-2920"
      - id: "CSG-0004"
        statement: "Workspace apply is stubbed (patch apply/snapshot TODO), so tools operate on wrong filesystem state."
        draft_evidence_ref: "crates/apm2-daemon/src/episode/workspace.rs:691-766"
      - id: "CSG-0005"
        statement: "ToolResultData stored to CAS but result_hash is not surfaced/aggregated for receipts and tool lifecycle events."
        draft_evidence_ref: "crates/apm2-daemon/src/episode/executor.rs:481-512"
      - id: "CSG-0006"
        statement: "ToolExecutionReceipt framework exists but FAC runtime does not emit/integrate it."
        draft_evidence_ref:
          - "crates/apm2-daemon/src/evidence/receipt.rs"
          - "crates/apm2-daemon/src/evidence/receipt_builder.rs"
      - id: "CSG-0007"
        statement: "Episode runtime buffers events in memory; it does not persist sufficient episode/tool lifecycle events to ledger for HEF topics and crash-only recovery."
        draft_evidence_ref: "crates/apm2-daemon/src/episode/runtime.rs:1162-1209"
      - id: "CSG-0008"
        statement: "Projection is present but not wired into a long-running reducer loop."
        draft_evidence_ref: "crates/apm2-daemon/src/projection/mod.rs:3-12"
      - id: "CSG-0009"
        statement: "ListFiles/Search default root is \".\"; only safe if handlers are instantiated per-workspace root (otherwise escapes/ambient truth risk)."
        draft_evidence_ref: "crates/apm2-daemon/src/episode/handlers.rs (PR #389 handlers default root)"
    additional_notes:
      - "xtask already contains explicit guardrails for GitHub writes (xtask/src/util.rs:287-330); RFC stages authority reduction without breaking workflows."

  research_alignment_informative:
    source_ref: "AUTONOMOUS_FORGE_ADMISSION_CYCLE.md#Research alignment (informative, non-normative)"
    guidance:
      - "Compiled multi-role, not conversational multi-agent: roles compile down to a bounded episode plan + tool actuation evidence + SummaryReceipt; no inter-role chat logs cross holon boundaries."
      - "ACI-first tool design: narrow, typed tools dominate gains; prefer read-only repo tools and bounded interfaces over shells."
      - "Hazard-aware control + info-flow controls: treat diffs/tool outputs as adversarial; use context firewalling and proof-carrying artifacts (receipts binding inputs/outputs)."
      - "Termination discipline: budget exhaustion, repeated denials, repeated ContextPack misses, or repeated tool failures are terminal -> Blocked + defect signals, not \"try harder\" loops."

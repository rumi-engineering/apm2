evidence_artifact:
  schema_version: "2026-01-23"
  id: "EVID-0016"
  title: "Security hardening evidence (broker sandboxing, taint tracking, attestation tightening)"
  category: "SECURITY_REVIEW"
  status: "PARTIAL"
  description: |
    Evidence that the broker and evidence pipeline are hardened after FAC viability: sandboxing constraints,
    taint tracking for untrusted inputs, and stronger attestation enforcement by risk tier.
  requirement_ids:
    - "REQ-0016"
  source_refs:
    - "documents/rfcs/RFC-0019/requirements/REQ-0016.yaml"
  artifacts:
    - artifact_type: "CODE"
      path: "crates/apm2-daemon/src/episode/handlers.rs"
      description: |
        TCK-00338: Broker sandboxing implementation (SEC-CTRL-FAC-0016)
        - SandboxConfig struct with shell allowlist, env passthrough, stall timeout
        - ExecuteHandler uses env_clear() + selective restoration of safe vars
        - ENV_PASSTHROUGH allowlist: PATH, HOME, USER, SHELL, TERM, LANG, etc.
        - ENV_BLOCKLIST_PATTERNS: API_KEY, TOKEN, SECRET, PASSWORD, AUTH, etc.
        - Shell command allowlist validation with fail-closed semantics
        - Tests for allowlist validation, env scrubbing, and blocklist override
    - artifact_type: "TEST"
      path: "crates/apm2-daemon/src/episode/handlers.rs"
      description: |
        Unit tests for SandboxConfig and ExecuteHandler security hardening:
        - test_sandbox_config_default_is_fail_closed
        - test_sandbox_config_permissive_allows_all
        - test_sandbox_config_shell_allowlist_exact_match
        - test_sandbox_config_shell_allowlist_wildcard
        - test_sandbox_config_env_passthrough_defaults
        - test_sandbox_config_env_blocklist_patterns
        - test_sandbox_config_custom_env_passthrough
        - test_sandbox_config_blocklist_overrides_passthrough
        - test_execute_handler_command_allowlist_blocks_disallowed
        - test_execute_handler_command_allowlist_allows_matching
        - test_execute_handler_env_scrubbing
        - test_execute_handler_default_env_passthrough
    - artifact_type: "CODE"
      path: "crates/apm2-core/src/fac/policy_inheritance.rs"
      description: |
        TCK-00340: Multi-holon policy inheritance enforcement + attestation tightening
        - PolicyInheritanceValidator enforces subleases are strict subsets of parent leases
          (work_id, changeset_digest, policy_hash constant-time checks, time bounds, AAT extension)
        - AttestationLevel enum: None, SelfSigned, CounterSigned, ThresholdSigned
        - AttestationRequirements with per-tier per-receipt-kind ratcheting table
        - ReceiptAttestation metadata with internal consistency validation
        - validate_receipt_attestation: top-level fail-closed validation pipeline
        - Monotonic ratchet invariant enforced at construction time
        - Fail-closed semantics: missing attestation in high-risk tiers always rejected
        - Bounded resource limits: MAX_SUBLEASE_BATCH_SIZE, MAX_ACTOR_ID_LENGTH
    - artifact_type: "TEST"
      path: "crates/apm2-core/src/fac/policy_inheritance.rs"
      description: |
        37 unit tests for policy inheritance and attestation ratcheting:
        - test_valid_sublease_strict_subset
        - test_sublease_exact_parent_bounds
        - test_sublease_work_id_mismatch_rejected
        - test_sublease_changeset_mismatch_rejected
        - test_sublease_policy_hash_mismatch_rejected
        - test_sublease_issued_before_parent_rejected
        - test_sublease_expires_after_parent_rejected
        - test_sublease_aat_escalation_rejected
        - test_sublease_aat_manifest_mismatch_rejected
        - test_sublease_aat_profile_mismatch_rejected
        - test_valid_sublease_with_matching_aat
        - test_batch_validation_all_valid
        - test_batch_validation_partial_violations
        - test_batch_too_large_rejected
        - test_attestation_level_ordering
        - test_attestation_level_satisfies
        - test_attestation_level_from_code_valid
        - test_attestation_level_from_code_invalid
        - test_default_requirements_monotonic
        - test_tier0_allows_no_attestation
        - test_tier1_requires_self_signed
        - test_tier2_review_requires_counter_signed
        - test_tier3_requires_counter_signed_all
        - test_tier4_review_requires_threshold_signed
        - test_higher_attestation_always_accepted
        - test_validate_receipt_attestation_success
        - test_validate_receipt_attestation_policy_hash_mismatch
        - test_validate_receipt_attestation_insufficient_level
        - test_validate_receipt_attestation_counter_signed_without_counter_signer
        - test_validate_receipt_attestation_threshold_without_count
        - test_validate_receipt_attestation_threshold_count_too_low
        - test_validate_receipt_attestation_full_threshold_success
        - test_validate_self_signed_empty_signer_rejected
        - test_signer_identity_too_long_rejected
        - test_fail_closed_high_tier_no_attestation
        - test_receipt_kind_display
        - test_attestation_level_display

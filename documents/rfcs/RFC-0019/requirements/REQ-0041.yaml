requirement:
  schema_version: "2026-02-09"
  id: "REQ-0041"
  title: "Doctor wait loop must terminate on manual/complete states with reasoned terminal events"
  category: "NON_FUNCTIONAL"
  priority: "P1"
  status: "PROPOSED"
  statement: |
    `apm2 fac doctor --pr <N> --wait-for-recommended-action` MUST treat
    manual-action and completion states as terminal outcomes rather than
    waiting indefinitely.

    Terminal behavior:
      - `dispatch_implementor` is terminal (manual intervention required).
      - all-verdicts-approve outcomes (`approve` / merge-ready) are terminal.
      - other explicitly configured `--exit-on` actions remain terminal.

    JSON wait contract:
      - On terminal exit, emit `wait_terminal` with:
          - `reason` (stable machine-readable terminal reason),
          - `action` (recommended action string),
          - `elapsed_seconds`.
      - On timeout, emit `wait_timeout` with `elapsed_seconds`.
      - `wait_terminal` and `wait_timeout` are mutually exclusive for one run.

    Reason normalization:
      - `dispatch_implementor` => `reason: "dispatch_implementor"`
      - `merge` or `approve` => `reason: "merge_ready"`

    Primary delivery ticket: TCK-00621.
  rationale: |
    A wait loop that does not terminate on states requiring operator action or
    on completed approval states causes orchestration deadlock and hides the
    real control decision. Reasoned terminal events let automation branch
    cleanly on timeout vs terminal-state exit and preserve deterministic flow.
  acceptance_criteria:
    - "Wait mode returns immediately when recommended action is `dispatch_implementor`."
    - "Wait mode returns immediately when all verdict dimensions approve (`approve`/merge-ready)."
    - "JSON mode emits `wait_terminal` with `reason`, `action`, and `elapsed_seconds` on terminal exit."
    - "JSON mode emits `wait_timeout` (not `wait_terminal`) on timeout."
    - "`wait_terminal.reason` maps `merge` and `approve` to `merge_ready`."
  evidence_ids:
    - "EVID-0041"
  source_refs:
    - "documents/work/tickets/TCK-00621.yaml"

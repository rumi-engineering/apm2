requirement:
  schema_version: "2026-02-09"
  id: "REQ-0036"
  title: "Structured stdout JSONL contract for gates observability"
  category: "FUNCTIONAL"
  priority: "P0"
  status: "PROPOSED"
  statement: |
    `apm2 fac gates --json` MUST emit a sequence of newline-delimited JSON
    objects (JSONL) on stdout. Each object MUST include a `schema` field set
    to `"apm2.fac.gates_event.v1"` and an `event` field identifying the event
    type.

    Delivery is staged:
      - Phase A (TCK-00621) establishes phase/gate lifecycle visibility for the
        local worker execution path with
        `prep_started`, `prep_step`, `execute_started`, `gate_started`,
        `gate_finished`, and terminal `run_summary`/`run_failed`.
      - Phase B (TCK-00625) completes the full 10-event contract below and
        enforces schema completeness/order validation in CI.

    The following events are REQUIRED and MUST be emitted in the order listed
    when the corresponding phase or action occurs:

      run_started       — first line; includes run_id, head_sha, timestamp, flags
      prep_started      — PREP phase begins; includes prep_steps planned
      prep_step         — one per PREP step; includes step_name, status, duration_ms
      prep_autofix      — emitted when ReadinessController applies an autofix;
                          includes component, action, outcome
      execute_started   — EXECUTE phase begins; includes gate_count, network_policy
      gate_started      — once per gate; includes gate_name, sha, cache_eligible
      gate_finished     — once per gate; includes gate_name, verdict, duration_ms,
                          cache_decision (see REQ-0037), exit_code
      cache_decision    — MAY be inlined into gate_finished or emitted separately;
                          includes hit, reason_code, first_mismatch_dimension
      run_summary       — final line on success; includes all gate verdicts,
                          prep_duration_ms, execute_duration_ms, total_duration_ms,
                          cache_hit_count, cache_miss_count
      run_failed        — final line on failure; includes failure_code, failure_class,
                          stage, root_cause, remediation, diagnostics

    The event sequence MUST be sufficient to reconstruct the full execution
    timeline, identify performance bottlenecks, and locate failure locus
    without reading any lane log or internal service log.

    Without `--json`, a human-friendly summary MAY be emitted; the JSONL
    contract applies only to `--json` mode.

    Primary delivery tickets: TCK-00621 (Phase A), TCK-00625 (Phase B).
  rationale: |
    Structured stdout is the primary observability surface for orchestrators,
    CI pipelines, and implementor agents. Without a stable schema, consumers
    must parse free-form text, which breaks on binary changes. The JSONL
    contract gives consumers a stable, versioned event stream from which
    dashboards, progress indicators, and failure routing can be built without
    log access.
  acceptance_criteria:
    - "Phase A emits prep/execute/gate lifecycle events and terminal run_summary/run_failed on the local worker path."
    - "Phase B emits all 10 required event types in the correct order for a successful run."
    - "run_failed is emitted on any failure with all required fields from the failure taxonomy (REQ-0035)."
    - "Every event includes schema: apm2.fac.gates_event.v1 and event fields."
    - "The event stream alone (no logs) is sufficient to determine: which gate failed, why cache missed, how long each phase took."
    - "Schema is versioned; a schema bump is required for any breaking change."
    - "CI tests parse the JSONL output and assert event presence, order, and field completeness."
  evidence_ids:
    - "EVID-0036"
  source_refs:
    - "documents/rfcs/RFC-0019/20_fac_execution_substrate_build_farm_revision.md"

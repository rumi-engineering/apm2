requirement:
  schema_version: "2026-02-09"
  id: "REQ-0032"
  title: "Two-phase gates contract: PREP (healing) then EXECUTE (isolated, deterministic)"
  category: "FUNCTIONAL"
  priority: "P0"
  status: "PROPOSED"
  statement: |
    `apm2 fac gates` MUST structure execution into exactly two phases:

    PREP phase:
      - Invokes the readiness controller (REQ-0031).
      - Executes the dependency-closure readiness/hydration hook.
      - Full dependency closure hydration semantics are delivered by
        REQ-0033/REQ-0034 tickets; this requirement establishes the
        phase boundary and fail-closed sequencing contract.
      - MAY perform network I/O, filesystem mutations, and service calls.
      - MUST complete successfully before EXECUTE begins.
      - If PREP fails, no gates execute. Failure is reported with structured
        output including `stage: "prep"`.

    EXECUTE phase:
      - Runs gates in deterministic, isolated order.
      - MUST NOT perform ambient filesystem mutations outside gate workspaces.
      - MUST run with network denied (REQ-0033).
      - Gate inputs are fully resolved by the end of PREP; EXECUTE consumes
        only pre-hydrated artifacts.
      - Each gate result MUST be individually reported (per REQ-0036).

    PREP and EXECUTE outcomes MUST be separately timed and reported in
    structured stdout output (per REQ-0036). `run_summary` MUST include
    `prep_duration_ms`, `execute_duration_ms`, and `phase_failed`; `run_failed`
    MUST include `stage`.

    Primary delivery ticket: TCK-00621.
  rationale: |
    Mixing preparation and execution creates non-deterministic gate behaviour:
    a gate may succeed or fail depending on ambient network state, cache
    freshness, or infrastructure readiness at an arbitrary mid-run point.
    The two-phase split makes preparation explicit and containable, and makes
    gate execution a predictable, auditable unit. Fail-before-execute ensures
    no partial gate results are produced from an un-ready substrate.
  acceptance_criteria:
    - "If PREP fails, zero gate processes are started and the run exits with stage=prep in the structured failure."
    - "EXECUTE phase performs no ambient mutations outside gate workspaces."
    - "Structured output includes distinct prep_started and execute_started events."
    - "run_summary includes prep_duration_ms, execute_duration_ms, and phase_failed."
    - "run_failed includes stage=prep or stage=execute."
    - "PREP and EXECUTE are separately timed and reported."
  evidence_ids:
    - "EVID-0032"
  source_refs:
    - "documents/rfcs/RFC-0019/20_fac_execution_substrate_build_farm_revision.md"

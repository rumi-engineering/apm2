rfc_rollout_and_ops:
  schema_version: "2026-01-23"
  template_version: "2026-01-23"
  rollout_plan:
    phases:
      - id: "ROL-0001"
        name: "M1 - Control plane viability"
        steps:
          - "Close TCK-00290: wire SessionDispatcher to CAS/ledger/broker/clock"
          - "Remove legacy allow path in production"
          - "Implement PublishEvidence + EmitEvent real persistence"
          - "Implement reviewer capability manifest"
        guardrails:
          - "Integration tests verify tool execution is CAS-backed"
          - "E2E test (hef_fac_v0_e2e.rs) passes with real stores"
        rollback_steps:
          - "Revert to stub dispatcher if blocking issues"
          - "Feature flag to enable/disable real execution"
        evidence_ids: []

      - id: "ROL-0002"
        name: "M2 - Workspace apply + rooted tools"
        steps:
          - "Implement apply_changeset with isolated workspace"
          - "Amend tool handlers to be per-workspace rooted"
          - "Add path traversal prevention"
        guardrails:
          - "Workspace escape tests (symlink, path traversal)"
          - "ListFiles/Search reflect patched state"
        rollback_steps:
          - "Workspace can remain stubbed if blocking"
          - "Tool handlers can use fallback root"
        evidence_ids: []

      - id: "ROL-0003"
        name: "M3 - Review receipt end-to-end"
        steps:
          - "Capture tool logs as CAS artifacts"
          - "Store review body + bundle"
          - "Emit ReviewReceiptRecorded"
        guardrails:
          - "Receipt references valid CAS hashes"
          - "Offline audit possible from receipt"
        rollback_steps:
          - "Receipt can omit tool logs if blocking"
        evidence_ids: []

      - id: "ROL-0004"
        name: "M4 - Projection v0"
        steps:
          - "Wire projection worker in daemon"
          - "Minimal GitHub projection: status + single comment"
          - "Durable projection receipts + idempotency"
        guardrails:
          - "Projection matches internal receipt"
          - "Restart doesn't duplicate comments"
        rollback_steps:
          - "Disable projection worker; continue manual projection"
        evidence_ids: []

      - id: "ROL-0005"
        name: "M5 - xtask demotion"
        steps:
          - "Add xtask --emit-receipt-only mode"
          - "Default xtask path triggers ingestion + waits for projection"
          - "Direct GitHub writes require explicit flag"
        guardrails:
          - "All writes have projection receipts"
          - "Audit trail shows write source"
        rollback_steps:
          - "Revert xtask to direct writes with flag"
        evidence_ids: []

  operability:
    runbooks:
      - id: "RB-0001"
        name: "Projection Worker Recovery"
        trigger: "Projection worker crashes or falls behind"
        steps:
          - "Check daemon logs for projection worker errors"
          - "Verify CAS and ledger accessibility"
          - "Restart daemon to reinitialize projection worker"
          - "Verify catch-up by checking ledger head vs projection cursor"
      - id: "RB-0002"
        name: "Workspace Cleanup"
        trigger: "Disk space exhaustion from orphaned workspaces"
        steps:
          - "List workspace root directory"
          - "Identify workspaces older than retention period"
          - "Remove orphaned workspace directories"
          - "Verify daemon workspace management is operational"
    alarms:
      - id: "ALM-0001"
        name: "projection_lag_high"
        condition: "Projection cursor > 100 commits behind ledger head"
        severity: "WARNING"
      - id: "ALM-0002"
        name: "workspace_disk_usage_high"
        condition: "Workspace root > 80% of allocated space"
        severity: "WARNING"
    automated_response_notes:
      - "Projection lag can be temporary during high activity; escalate if persists > 1 hour"
      - "Workspace cleanup should be automatic; alarm indicates lifecycle management failure"

  observability:
    metrics:
      - id: "MET-0001"
        name: "fac_reviews_completed_total"
        type: "counter"
        description: "Total review episodes completed"
      - id: "MET-0002"
        name: "fac_projections_completed_total"
        type: "counter"
        description: "Total projections to GitHub"
      - id: "MET-0003"
        name: "fac_projection_lag_commits"
        type: "gauge"
        description: "Commits behind ledger head"
    logs:
      - id: "LOG-0001"
        event: "review_receipt_recorded"
        fields: ["work_id", "receipt_hash", "artifact_count"]
      - id: "LOG-0002"
        event: "projection_completed"
        fields: ["work_id", "receipt_hash", "github_pr_number"]
    traces:
      - id: "TRC-0001"
        span: "review_episode"
        children: ["tool_execution", "evidence_store", "event_emit"]
    audit_events:
      - id: "AUD-0001"
        event: "github_write"
        fields: ["projection_receipt_hash", "pr_number", "write_type"]

rfc_trust_boundaries:
  schema_version: "2026-01-27"
  template_version: "2026-01-27"

  trust_model:
    overview: |
      The kernel daemon (apm2d) operates as the trusted authority for episode
      execution. Agent harness processes are untrusted holons whose internal
      state is ephemeral; only I/O across explicit channels is meaningful.

      Trust is established through:
      1. Capability delegation (OCAP) - explicit grants, not discovery
      2. Budget enforcement - hard limits with termination on exhaustion
      3. Receipt binding - cryptographic evidence of all authoritative outcomes
      4. Channel classification - no unclassified side channels

    boundaries:
      - boundary_id: TB-DAEMON-001
        name: "Kernel Daemon"
        type: TRUSTED
        description: |
          apm2d is the trusted authority for:
          - Episode lifecycle (spawn, terminate, quarantine)
          - Ledger events (single writer for daemon family)
          - Policy evaluation and capability delegation
          - Receipt signing
          - Evidence storage coordination
        assets_protected:
          - "Ledger integrity"
          - "Episode envelope immutability"
          - "Capability manifest authenticity"
          - "Budget enforcement correctness"
          - "Receipt authenticity"
        invariants:
          - "Daemon runs as single instance per host"
          - "Daemon signing key protected in OS keychain"
          - "All daemon actions logged to ledger"

      - boundary_id: TB-HARNESS-001
        name: "Agent Harness Process"
        type: UNTRUSTED_HOLON
        description: |
          Vendor CLIs (Claude Code, Codex CLI, Gemini CLI) and local models
          run as child processes. Internal state is ephemeral; only I/O across
          channels is meaningful to the kernel.

          Harness processes:
          - Cannot access ledger directly
          - Cannot emit events directly
          - Cannot sign receipts
          - Cannot modify capabilities
        invariants:
          - "Harness communicates only via PTY/stdin/stdout"
          - "Tool requests mediated by ToolBroker"
          - "Harness cannot escalate capabilities"
          - "Harness termination emits episode event"

      - boundary_id: TB-TOOLBROKER-001
        name: "Tool Broker"
        type: TRUSTED_MEDIATOR
        description: |
          ToolBroker validates and executes tool calls. It sits between
          harness requests and actual tool execution.

          Responsibilities:
          - Validate capability manifest
          - Check dedupe cache
          - Evaluate policy rules
          - Charge budget
          - Execute tool
          - Emit receipts
          - Store results in CAS
        invariants:
          - "No tool execution without valid capability"
          - "All tool executions produce receipts"
          - "Dedupe keys prevent replay abuse"
          - "Budget charged before execution"

      - boundary_id: TB-ADAPTER-001
        name: "Harness Adapter"
        type: TRUSTED_PARSER
        description: |
          HarnessAdapter normalizes harness behavior into structured events.
          It parses PTY output to detect tool requests, progress indicators,
          and termination signals.

          Trust level: HIGH (processes raw harness output)
          Risk: Prompt injection via malformed output
        invariants:
          - "Parser state machine is deterministic"
          - "Malformed input triggers parsing error event, not crash"
          - "Parsing failures are logged as defects"
          - "Adapter does not execute arbitrary content"
          - "PTY output is sanitized (ANSI escape stripping) before parsing"
          - "Tool request rate limited to prevent DoS via parser"

      - boundary_id: TB-EVIDENCE-001
        name: "Evidence Store (CAS)"
        type: TRUSTED_STORAGE
        description: |
          Content-addressed store for evidence artifacts.
          Integrity verified by hash; authenticity by receipt binding.
        invariants:
          - "Hash of stored content matches content digest"
          - "No content modification after storage"
          - "Pinned content not deleted until unpin"
          - "TTL expiry respects pin state"

      - boundary_id: TB-TELEMETRY-001
        name: "Telemetry Collector"
        type: TRUSTED_PROBE
        description: |
          Collects resource metrics from cgroups and /proc.
          Telemetry frames become evidence when signed.
        invariants:
          - "Telemetry values sourced from OS primitives"
          - "Signed frames are immutable"
          - "Sample timestamps are monotonic"

  threat_model:
    - threat_id: TH-INJECT-001
      name: "Prompt injection via tool output"
      description: |
        Malicious content in tool results could manipulate agent behavior.
        Tool outputs are untrusted observations, not trusted instructions.
      attack_vector: "Crafted file contents, API responses, or error messages"
      mitigation:
        - "Tool outputs stored in CAS with content classification"
        - "Agent context marks tool results as untrusted"
        - "Capability scope limits accessible content"
      residual_risk: MEDIUM
      owner: AUTH_SECURITY

    - threat_id: TH-DEPUTY-001
      name: "Confused deputy via overbroad capabilities"
      description: |
        Agent requests tool execution with capabilities beyond intended scope.
        Daemon executes because capability technically allows it.
      attack_vector: "Broad filesystem or network capabilities"
      mitigation:
        - "Default deny; explicit allowlist"
        - "Read-only by default; write requires elevation"
        - "Capability scope includes path patterns"
        - "Risk tier gates dangerous capabilities"
      residual_risk: LOW
      owner: AUTH_SECURITY

    - threat_id: TH-SIDECHANNEL-001
      name: "Uncontrolled side effects outside tool plane"
      description: |
        Harness process accesses resources directly (shell, network)
        bypassing tool mediation.
      attack_vector: "Shell command execution, direct file access"
      mitigation:
        - "Filesystem confinement via bind mounts"
        - "Network namespace isolation (REQUIRED for risk tier 3+; OPTIONAL for tier 1-2)"
        - "No ambient credentials in harness environment"
        - "All external access via tool broker"
      residual_risk: MEDIUM
      owner: AUTH_SECURITY

    - threat_id: TH-TAMPER-001
      name: "Evidence tampering / receipt forgery"
      description: |
        Attacker modifies evidence artifacts or forges receipts to
        falsify execution outcomes.
      attack_vector: "Direct file modification, key compromise"
      mitigation:
        - "Content-addressed storage (hash verification)"
        - "Receipt signing with ed25519"
        - "Signing key in OS keychain"
        - "Rekor-style transparency log (future)"
      residual_risk: LOW
      owner: AUTH_SECURITY

    - threat_id: TH-EXFIL-001
      name: "Data exfiltration via logs/evidence"
      description: |
        Sensitive data embedded in tool arguments, results, or telemetry
        could leak through evidence artifacts.
      attack_vector: "Secrets in file contents, environment variables"
      mitigation:
        - "Redaction rules for known secret patterns"
        - "Evidence classification (ephemeral/standard/archival)"
        - "TTL enforcement for non-pinned evidence"
        - "No ambient credentials in harness"
      residual_risk: |
        MEDIUM. Telemetry timing side channel is an acknowledged limitation 
        (estimated 10 bps max exfiltration) that cannot be fully eliminated 
        without disabling all high-rate telemetry.
      owner: AUTH_SECURITY

    - threat_id: TH-EXHAUST-001
      name: "Resource exhaustion via unbounded episodes"
      description: |
        Malicious or buggy episodes consume excessive resources
        (CPU, memory, disk, network).
      attack_vector: "Infinite loops, fork bombs, disk filling"
      mitigation:
        - "Mandatory budget limits (tokens, wall_ms, cpu_ms, bytes_io)"
        - "cgroup resource limits"
        - "Per-episode evidence quota"
        - "Termination on budget exhaustion"
      residual_risk: LOW
      owner: AUTH_ARCHITECTURE

    - threat_id: TH-RACE-001
      name: "TOCTOU in stop-state checking"
      description: |
        Stop state changes between check and actuation, allowing
        action after stop should have been enforced.
      attack_vector: "Concurrent stop signal with tool execution"
      mitigation:
        - "Atomic stop-state check via mutex"
        - "Fail closed on unverifiable stop state"
        - "Stop propagates to pending tool requests"
      residual_risk: LOW
      owner: AUTH_ARCHITECTURE

  channel_classes:
    - class: CONTROL
      trust_level: HIGH
      description: "Episode lifecycle commands, policy updates"
      allowed_operations:
        - "CreateEpisode, StartEpisode, StopEpisode"
        - "PolicyLoad, CapabilityDelegate"
      budget:
        requests_per_minute: 60
        max_payload_bytes: 65536

    - class: IO
      trust_level: MEDIUM
      description: "PTY streaming, stdin/stdout/stderr"
      allowed_operations:
        - "SendInput, StreamOutput, ResizePty"
      budget:
        bytes_per_second: 10485760
        max_buffer_bytes: 16777216

    - class: TOOL
      trust_level: HIGH
      description: "Tool requests and responses"
      allowed_operations:
        - "ToolRequest, ToolDecision, ToolResult"
      budget:
        requests_per_minute: 300
        max_args_bytes: 1048576
        max_result_bytes: 10485760

    - class: TELEMETRY
      trust_level: MEDIUM
      description: "Resource metrics streaming"
      allowed_operations:
        - "TelemetryFrame, TelemetryPolicy"
      budget:
        frames_per_second: 10
        max_frame_bytes: 4096

    - class: EVIDENCE
      trust_level: HIGH
      description: "Artifact storage and receipt emission"
      allowed_operations:
        - "PublishEvidence, Receipt"
      budget:
        bytes_per_episode: 104857600
        max_artifact_bytes: 10485760

  security_contacts:
    - role: AUTH_SECURITY
      responsibilities:
        - "Review trust boundary definitions"
        - "Approve capability delegation policies"
        - "Audit receipt signing implementation"
        - "Review evidence retention policies"
        - "Incident response for security events"

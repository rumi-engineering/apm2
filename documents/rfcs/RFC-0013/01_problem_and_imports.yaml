rfc_problem_and_imports:
  schema_version: "2026-01-27"
  template_version: "2026-01-27"

  problem_statement:
    summary: |
      Current APM2 state contains kernel primitives (events, ledger/CAS, reducers,
      policy concepts) but lacks a running kernel daemon capable of:

      - Hosting sessions/episodes with enforceable budgets and stop conditions
      - Mediating tool executions with receipts and dedupe keys
      - Streaming real-time I/O and telemetry with backpressure and quotas
      - Producing replayable evidence artifacts without prohibitive storage growth
      - Integrating heterogeneous agent harnesses without inheriting their authority model

      MCP is not sufficient for this layer: it standardizes message exchange for
      tools/resources/prompts, not **runtime enveloping**, OS-level accounting,
      deterministic receipt binding, and holonic authority boundaries.

      This RFC defines the missing layer: a kernel-hosted episode runtime and
      low-latency process control protocol for running any agent harness (vendor
      CLIs and local models) as bounded holonic episodes.
    doctrine_ref: "documents/theory/unified-theory-v2.json"

  doctrine_requirements:
    # Non-negotiable requirements derived from holonic unified theory

    - id: DOC-TRUTH-001
      title: "Truth is events + evidence"
      description: |
        Authoritative facts are append-only ledger events with content-addressed
        evidence pointers. Mutable state is projection: session tables, indexes,
        and in-memory maps are derived; they may be rebuilt from the ledger.
      doctrine_ref: "unified-theory.md#truth-topology"
      enforcement: "All state transitions emit typed events; projections computed by reducers"

    - id: DOC-BOUNDARY-001
      title: "Holonic boundary and channels"
      description: |
        Agent harness processes are untrusted holons: internal state is ephemeral;
        only I/O across explicit channels is meaningful. Channel classes MUST exist
        (discovery/handshake/work/evidence) with explicit budgets and retention;
        unclassified side channels are defects.
      doctrine_ref: "unified-theory.md#holonic-boundary-model"
      enforcement: "All harness I/O classified into channel types; unclassified rejected"

    - id: DOC-OCAP-001
      title: "Capabilities are delegated, not discovered"
      description: |
        No ambient authority; all effectors are tool capabilities. Capabilities MUST
        NOT be discoverable; only explicit delegation creates capabilities.
      doctrine_ref: "unified-theory.md#ocap"
      enforcement: "Tool broker validates capability manifests; discovery blocked"

    - id: DOC-LEASE-001
      title: "Leases and budgets are mandatory"
      description: |
        Termination on exhaustion is required. Every episode executes under bounded
        budget (tokens, tool_calls, wall_ms, cpu_ms, bytes_io, evidence_bytes).
        Budgets are hard limits; exhaustion triggers termination or explicit escalation.
      doctrine_ref: "unified-theory.md#leases-budgets"
      enforcement: "Episode envelope requires budget; runtime enforces limits"

    - id: DOC-MEASURE-001
      title: "Measurement integrity"
      description: |
        Every authoritative outcome MUST satisfy the verification predicate:
        Valid(Output, Receipt, Evidence) := VerifyReceipt(receipt) AND
        EvidenceSatisfies(contract, evidence) AND DigestBindingsHold(output, evidence).
        Canonicalization is required prior to hashing/signing.
      doctrine_ref: "unified-theory.md#measurement-integrity"
      enforcement: "All receipts include canonical bytes hash, signature, evidence refs"

    - id: DOC-BOUNDED-001
      title: "Bounded cognition and context"
      description: |
        Episodes execute under bounded context |s| <= W; context packs are
        sufficient-statistics approximations compiled upstream. ZTI applies
        to consumption: execution episodes should not perform discretionary
        context discovery; pack misses are defects.
      doctrine_ref: "unified-theory.md#bounded-cognition"
      enforcement: "Episode envelope includes context_refs; discovery attempts logged as defects"

  derived_requirements:
    # Requirements derived from doctrine for this RFC's scope

    - id: REQ-DAEMON-001
      title: "Kernel daemon (apm2d) implementation"
      description: |
        Implement kernel daemon hosting ledger/CAS/reducers/policy and the
        runtime protocol server. Daemon is the authoritative plant controller
        for episode execution.
      traces_to: [DOC-TRUTH-001]

    - id: REQ-EPISODE-001
      title: "Episode runtime with envelope"
      description: |
        Episode runtime that spawns harness processes (PTY/non-PTY), enforces
        OCAP, leases, budgets, and stop conditions. Each episode created with
        immutable envelope object referenced by digest and bound into all receipts.
      traces_to: [DOC-BOUNDARY-001, DOC-LEASE-001]

    - id: REQ-PROTOCOL-001
      title: "Runtime protocol (wire)"
      description: |
        Low-latency process control protocol with control plane commands
        (spawn/stop/input/signal), I/O plane streaming, tool plane mediation,
        telemetry plane metrics, evidence plane artifacts, and ledger plane events.
      traces_to: [DOC-TRUTH-001, DOC-BOUNDARY-001]

    - id: REQ-TOOL-001
      title: "Tool mediation with OCAP"
      description: |
        Tool actuation is the only permitted effect path. Each tool execution
        produces events (ToolRequested, ToolDecided, ToolExecuted) with receipts.
        Dedupe keys mandatory for idempotent tools.
      traces_to: [DOC-OCAP-001, DOC-MEASURE-001]

    - id: REQ-TEL-001
      title: "Telemetry and resource accounting"
      description: |
        High-rate telemetry streaming with budget attribution for CPU/memory/I/O/network.
        Telemetry frames are evidence of consumption when signed/bound to episode.
        Lossy aggregation by default; pin-on-trigger for full fidelity.
      traces_to: [DOC-MEASURE-001, DOC-LEASE-001]

    - id: REQ-EVID-001
      title: "Evidence economics"
      description: |
        Evidence must not scale linearly with runtime duration. Flight recorder
        policy with ring buffers; persist full-fidelity only on triggers.
        TTL + pinning for retention management; compaction produces summary receipts.
      traces_to: [DOC-MEASURE-001, DOC-BOUNDED-001]

    - id: REQ-RECEIPT-001
      title: "Receipt binding and verification"
      description: |
        All receipts bind: envelope digest, policy digest, canonicalizer id/version,
        evidence refs, unsigned bytes hash, and signer identity. Verification uses
        the satisfiability predicate from doctrine.
      traces_to: [DOC-MEASURE-001]

    - id: REQ-ADAPTER-001
      title: "Harness adapter integration"
      description: |
        Integration adapters for at least one vendor harness class (Claude Code,
        Codex CLI, Gemini CLI) in black-box mode (PTY transcript + tool protocol).
        Adapters normalize harness behavior into ToolRequest, Progress, Terminated events.
      traces_to: [DOC-BOUNDARY-001, DOC-OCAP-001]

  scope:
    in_scope:
      - "Kernel daemon (apm2d) hosting ledger/CAS/reducers/policy and runtime protocol server"
      - "Episode runtime: spawn harness processes, enforce OCAP, leases, budgets, stop conditions"
      - "Runtime protocol: control plane, I/O plane, tool plane, telemetry plane, evidence plane"
      - "Tool mediation with receipts binding tool actuation to evidence"
      - "High-rate telemetry streaming + resource accounting + budget consumption"
      - "Evidence economics: bounded retention, flight recorder, pinning, compaction"
      - "Integration adapter for at least one vendor harness (Claude Code or similar)"

    out_of_scope:
      - "Multi-node federation, consensus, cross-machine holarchy routing"
      - "Replacing GitHub CI immediately (CI remains external verifier)"
      - "Building general orchestration system (coordination is RFC-0012)"
      - "Perfect inference determinism for vendor models (treated as oracle)"

  component_dependencies:
    - id: COMP-LEDGER
      ref: "crates/apm2-core/src/ledger/"
      rationale: "Episode runtime emits events to ledger"

    - id: COMP-CAS
      ref: "crates/apm2-core/src/evidence/"
      rationale: "Evidence artifacts stored in CAS"

    - id: COMP-REDUCER
      ref: "crates/apm2-core/src/reducer/"
      rationale: "State projections computed by reducers"

    - id: COMP-SESSION
      ref: "crates/apm2-core/src/session/"
      rationale: "Episode runtime extends session infrastructure"

    - id: COMP-PROCESS
      ref: "crates/apm2-core/src/process/"
      rationale: "Harness spawning uses process management"

    - id: COMP-DAEMON
      ref: "crates/apm2-daemon/"
      rationale: "Protocol server extends existing daemon"

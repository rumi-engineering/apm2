rfc_test_and_evidence:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"

  test_strategy:
    approach: |
      Multi-layered testing strategy:
      - Unit tests for restart monotonicity and AI tool invocation patterns
      - Integration tests for xtask lint command
      - Manual verification for documentation and workflow improvements

    unit_tests:
      - id: UT-006-001
        description: "Restart monotonicity boundary tests"
        file: "crates/apm2-core/src/session/reducer.rs"
        test_function: "test_restart_monotonicity_boundary_cases"
        deterministic: true
        test_cases:
          - name: "restart_0_to_0"
            input:
              current_restart_attempt: 0
              new_restart_attempt: 0
            expected: "Err (non-monotonic)"
          - name: "restart_0_to_1"
            input:
              current_restart_attempt: 0
              new_restart_attempt: 1
            expected: "Ok"
          - name: "restart_5_to_5"
            input:
              current_restart_attempt: 5
              new_restart_attempt: 5
            expected: "Err (non-monotonic)"
          - name: "restart_5_to_6"
            input:
              current_restart_attempt: 5
              new_restart_attempt: 6
            expected: "Ok"
          - name: "restart_max_to_any"
            input:
              current_restart_attempt: "u32::MAX"
              new_restart_attempt: "any"
            expected: "Err (overflow)"
        pass_criteria: |
          All boundary cases correctly validated.
          Run: cargo test -p apm2-core test_restart_monotonicity_boundary_cases

      - id: UT-006-002
        description: "Terminal state data preservation tests"
        file: "crates/apm2-core/src/session/reducer.rs"
        test_function: "test_restart_preserves_terminal_state_data"
        deterministic: true
        test_cases:
          - name: "preserve_last_restart_attempt"
            scenario: "Session crashes with restart_attempt=5"
            expected: "Crashed state has last_restart_attempt=5"
          - name: "preserve_resume_cursor"
            scenario: "Session crashes with resume_cursor=Some(100)"
            expected: "Crashed state has resume_cursor=Some(100)"
          - name: "preserve_error_context"
            scenario: "Session crashes with error='OOM'"
            expected: "Crashed state has error='OOM'"
        pass_criteria: |
          Terminal states preserve all required fields.
          Run: cargo test -p apm2-core test_restart_preserves_terminal_state_data

      - id: UT-006-003
        description: "Temp file security tests"
        file: "xtask/src/tasks/push.rs"
        test_function: "test_temp_file_security"
        deterministic: true
        test_cases:
          - name: "permissions_0600"
            scenario: "Create NamedTempFile"
            expected: "File permissions are 0600"
          - name: "unpredictable_path"
            scenario: "Create two NamedTempFiles"
            expected: "Paths are different"
          - name: "cleanup_on_drop"
            scenario: "Create NamedTempFile, drop it"
            expected: "File no longer exists"
        pass_criteria: |
          Temp files have correct security properties.
          Run: cargo test -p xtask test_temp_file_security

      - id: UT-006-004
        description: "Script command format tests"
        file: "xtask/src/tasks/review.rs"
        test_function: "test_script_command_format"
        deterministic: true
        test_cases:
          - name: "valid_script_command"
            input: "/tmp/test_prompt.txt"
            expected: "script -qec \"gemini --yolo < '/tmp/test_prompt.txt'\" /dev/null"
          - name: "escapes_special_chars"
            input: "/tmp/test's prompt.txt"
            expected: "Path properly escaped"
        pass_criteria: |
          Script command format is valid for shell execution.
          Run: cargo test -p xtask test_script_command_format

      - id: UT-006-005
        description: "Reviewer health state management tests"
        file: "xtask/src/reviewer_state.rs"
        test_function: "test_reviewer_state"
        deterministic: true
        test_cases:
          - name: "state_file_location"
            scenario: "Get state file path"
            expected: "~/.apm2/reviewer_state.json expanded correctly"
          - name: "save_and_load_state"
            scenario: "Save reviewer state and load it back"
            expected: "State roundtrips correctly (serde JSON serialization)"
          - name: "atomic_write"
            scenario: "Save state while another process reads"
            expected: "No partial reads or corruption"
          - name: "missing_state_file"
            scenario: "Load state when file doesn't exist"
            expected: "Returns empty ReviewerStateFile::default()"
          - name: "corrupt_state_file"
            scenario: "Load state when file contains invalid JSON"
            expected: "Returns error (caller handles by deleting and starting fresh)"
        pass_criteria: |
          Reviewer state management functions correctly.
          Run: cargo test -p xtask test_reviewer_state

      - id: UT-006-006
        description: "Log file mtime activity detection"
        file: "xtask/src/reviewer_state.rs"
        test_function: "test_activity_detection"
        deterministic: true
        test_cases:
          - name: "recent_activity"
            scenario: "Log file mtime is 30s ago, process alive"
            expected: "HealthStatus::Healthy"
          - name: "stale_activity"
            scenario: "Log file mtime is 90s ago, process alive"
            expected: "HealthStatus::Stale"
          - name: "dead_process"
            scenario: "Process not running (regardless of log file mtime)"
            expected: "HealthStatus::Dead"
          - name: "missing_log_file"
            scenario: "Log file does not exist, process alive"
            expected: "HealthStatus::Stale (cannot verify activity)"
        pass_criteria: |
          Activity detection correctly uses log file mtime and process status.
          Run: cargo test -p xtask test_activity_detection

    integration_tests:
      - id: IT-006-001
        description: "xtask lint detects anti-patterns"
        deterministic: true
        setup: |
          Create test file with anti-patterns:
          - std::env::temp_dir() usage
          - Shell interpolation with markdown
        execution: "cargo xtask lint"
        validation:
          output_contains:
            - "Warning: Use tempfile::NamedTempFile"
            - "Warning: Write prompts to temp file"
          exit_code: 0
        pass_criteria: |
          Lint command detects anti-patterns and warns.

      - id: IT-006-002
        description: "Enhanced clippy lints catch issues"
        deterministic: true
        setup: |
          Create test file with:
          - Missing backticks in doc comment
          - Identical match arms
        execution: "cargo xtask commit 'test'"
        validation:
          output_contains:
            - "doc_markdown"
            - "match_same_arms"
          exit_code: "non-zero"
        pass_criteria: |
          Pre-commit clippy catches doc and match issues.

    manual_verification:
      - id: MV-006-001
        description: "Verify anti-patterns documented"
        prerequisites:
          - "TCK-00059 completed"
        steps:
          - "Open documents/skills/rust-textbook/26_apm2_safe_patterns_and_anti_patterns.md"
          - "Verify Anti-Patterns section exists"
          - "Verify ANTI-1, ANTI-2, ANTI-3 documented"
          - "Verify INV-2615 exists (APPLY: INV-2502)"
        pass_criteria:
          file_must_contain:
            - "Anti-Patterns"
            - "ANTI-1"
            - "ANTI-2"
            - "ANTI-3"
            - "INV-2615"
            - "INV-2502"

      - id: MV-006-002
        description: "Verify historical patterns in security prompt"
        prerequisites:
          - "TCK-00060 completed"
        steps:
          - "Open documents/reviews/SECURITY_REVIEW_PROMPT.md"
          - "Verify Historical Issue Patterns section exists"
          - "Verify state machine, temp file, shell, struct patterns"
        pass_criteria:
          file_must_contain:
            - "Historical Issue Patterns"
            - "State machine"
            - "Temp file"
            - "Shell"
            - "Struct field"

      - id: MV-006-003
        description: "Verify check shows remediation commands"
        prerequisites:
          - "TCK-00065 completed"
          - "PR with failing checks"
        steps:
          - "Run: cargo xtask check"
          - "Verify specific fix commands shown"
        pass_criteria:
          output_must_contain:
            - "Fix: cargo"

      - id: MV-006-004
        description: "Verify code quality uses Gemini"
        prerequisites:
          - "TCK-00066 completed"
          - "gemini CLI installed"
        steps:
          - "Run: cargo xtask review quality <PR_URL>"
          - "Verify Gemini CLI invoked"
        pass_criteria:
          output_must_not_contain:
            - "codex"
          behavior:
            - "Review comment posted"
            - "Status updated"

      - id: MV-006-005
        description: "Verify check shows reviewer health"
        prerequisites:
          - "TCK-00067 completed"
          - "Active review in progress"
        steps:
          - "Run: cargo xtask push (to start reviews)"
          - "Run: cargo xtask check"
          - "Verify reviewer health section displayed"
        pass_criteria:
          output_must_contain:
            - "Reviewer Agents"
            - "PID"
            - "Last activity"
            - "Status"

      - id: MV-006-006
        description: "Verify auto-remediation of stale reviewer"
        prerequisites:
          - "TCK-00067 completed"
          - "Stale reviewer (>300s since last activity)"
        steps:
          - "Wait for reviewer to become stale (or mock stale state by touching log file with old timestamp)"
          - "Run: cargo xtask check"
          - "Verify auto-remediation occurs"
        pass_criteria:
          output_must_contain:
            - "stale"
            - "Auto-remediating"
            - "killing PID"
            - "Restarted"
          behavior:
            - "Old process killed (verified via ps)"
            - "New review started (new PID in state file)"
            - "Old log file deleted"

      - id: MV-006-007
        description: "Verify simultaneous stale reviewers handled sequentially"
        prerequisites:
          - "TCK-00067 completed"
          - "Both security and quality reviewers stale"
        steps:
          - "Start both security and quality reviews"
          - "Wait for both to become stale (or mock stale state)"
          - "Run: cargo xtask check"
          - "Verify both are remediated sequentially"
        pass_criteria:
          output_must_contain:
            - "Security reviewer stale"
            - "Restarted security review"
            - "Quality reviewer stale"
            - "Restarted quality review"
          behavior:
            - "Security remediated first, then quality"
            - "No parallel remediation (avoids resource exhaustion)"

  evidence_requirements:
    - id: EVID-6001
      description: "Anti-patterns documented in rust-textbook Chapter 26"
      artifact_type: "documentation"
      verification:
        manual: "MV-006-001 passes"
      location: "documents/skills/rust-textbook/26_apm2_safe_patterns_and_anti_patterns.md"

    - id: EVID-6002
      description: "Historical patterns in security review prompt"
      artifact_type: "documentation"
      verification:
        manual: "MV-006-002 passes"
      location: "documents/reviews/SECURITY_REVIEW_PROMPT.md"

    - id: EVID-6003
      description: "Enhanced clippy lints catch issues"
      artifact_type: "test_output"
      verification:
        automated: "IT-006-002 passes"
      location: "evidence/RFC-0006/EVID-6003_clippy_lints.log"

    - id: EVID-6004
      description: "xtask lint detects anti-patterns"
      artifact_type: "test_output"
      verification:
        automated: "IT-006-001 passes"
      location: "evidence/RFC-0006/EVID-6004_lint_command.log"

    - id: EVID-6005
      description: "Gemini CLI used for code quality review"
      artifact_type: "command_output"
      verification:
        manual: "MV-006-004 passes"
      location: "evidence/RFC-0006/EVID-6005_gemini_quality.log"

    - id: EVID-6006
      description: "Check shows remediation commands"
      artifact_type: "command_output"
      verification:
        manual: "MV-006-003 passes"
      location: "evidence/RFC-0006/EVID-6006_check_remediation.log"

    - id: EVID-6007
      description: "Reviewer health monitoring and auto-remediation works"
      artifact_type: "command_output"
      verification:
        manual: "MV-006-005 and MV-006-006 pass"
        automated: "UT-006-005 passes"
      location: "evidence/RFC-0006/EVID-6007_reviewer_health.log"

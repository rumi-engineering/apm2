rfc_rollout_and_ops:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"

  rollout_plan:
    strategy: "Phased implementation with direct merge to main"
    rationale: |
      Improvements are organized into 4 phases with clear dependencies.
      Documentation updates (Phase 0) can proceed in parallel. Local checks
      and test coverage (Phases 1-2) are independent. Workflow improvements
      (Phase 3) depend on earlier phases.

    phases:
      - phase: 0
        name: "Documentation & Guidelines"
        description: |
          Update coding guidelines and security review prompt with learned
          anti-patterns and historical issue patterns.
        tickets:
          - "TCK-00059: Add Learned Anti-Patterns to Coding Guidelines"
          - "TCK-00060: Add Historical Issue Patterns to Security Review Prompt"
        parallelism: "Both tickets can execute in parallel"
        success_criteria:
          - "Anti-patterns section exists in documents/skills/rust-textbook/26_apm2_safe_patterns_and_anti_patterns.md"
          - "Historical patterns section exists in SECURITY_REVIEW_PROMPT.md"

      - phase: 1
        name: "Enhanced Local Checks"
        description: |
          Add enhanced clippy lints to pre-commit and create automated
          anti-pattern detection via cargo xtask lint.
        tickets:
          - "TCK-00061: Enhance Pre-Commit Clippy Lints"
          - "TCK-00062: Add Automated Pattern Validation"
        parallelism: "Both tickets can execute in parallel"
        success_criteria:
          - "Pre-commit catches doc-markdown and match-same-arms"
          - "cargo xtask lint detects anti-patterns"

      - phase: 2
        name: "Test Coverage"
        description: |
          Add tests for restart monotonicity boundary cases and AI tool
          invocation patterns.
        tickets:
          - "TCK-00063: Add Restart Monotonicity Boundary Tests"
          - "TCK-00064: Add AI Tool Invocation Tests"
        parallelism: "Both tickets can execute in parallel"
        success_criteria:
          - "Restart monotonicity tests pass"
          - "AI tool invocation tests pass"

      - phase: 3
        name: "Workflow Improvements"
        description: |
          Improve check workflow with specific remediation guidance,
          switch code quality reviewer to Gemini CLI, and add reviewer
          health monitoring with auto-remediation.
        tickets:
          - "TCK-00065: Improve Check Workflow Error Messages"
          - "TCK-00066: Switch Code Quality Reviewer to Gemini CLI"
          - "TCK-00067: Add Reviewer Agent Health Monitoring"
        dependencies:
          - "TCK-00065 depends on TCK-00061 for failure types"
          - "TCK-00066 depends on TCK-00064 for invocation tests"
          - "TCK-00067 depends on TCK-00066 for Gemini integration"
        parallelism: "Tickets have dependencies, must be sequential (65 || 66 -> 67)"
        success_criteria:
          - "Check shows specific fix commands for failures"
          - "Code quality review uses Gemini CLI"
          - "Check shows reviewer health status with auto-remediation"

  operational_considerations:
    monitoring:
      - "Developers notice improved pre-commit feedback immediately"
      - "CI logs show same results (pre-commit catches issues earlier)"
      - "Review comments now from Gemini (same format expected)"

    rollback:
      strategy: "git revert individual tickets if issues discovered"
      notes: |
        Each ticket is a separate PR. Can revert individual changes without
        affecting others. Documentation changes are purely additive. The
        Gemini switch can be reverted to restore Codex if needed.

    dependencies:
      - name: "tempfile crate"
        version: "3.x"
        notes: "Already in xtask; used for secure temp files"
      - name: "nix crate"
        version: "0.30.x"
        notes: "Must add to xtask; used for signal handling (SIGTERM/SIGKILL)"
      - name: "directories crate"
        version: "6.x"
        notes: "Must add to xtask; used for home directory detection"
      - name: "gemini CLI"
        version: "current"
        notes: "Required for code quality review (was Codex)"
      - name: "gh CLI"
        version: "2.x"
        notes: "Required for GitHub API interactions"

    verification_after_rollout:
      commands:
        - description: "Verify documentation"
          command: "grep 'Anti-Patterns' documents/skills/rust-textbook/26_apm2_safe_patterns_and_anti_patterns.md"
        - description: "Verify historical patterns"
          command: "grep 'Historical Issue Patterns' documents/reviews/SECURITY_REVIEW_PROMPT.md"
        - description: "Verify pre-commit catches issues"
          command: "cargo xtask commit 'test'"
        - description: "Verify pattern validation"
          command: "cargo xtask lint"
        - description: "Verify restart monotonicity tests"
          command: "cargo test -p apm2-core test_restart_monotonicity"
        - description: "Verify temp file tests"
          command: "cargo test -p xtask test_temp_file_security"
        - description: "Verify check shows remediation"
          command: "cargo xtask check"
        - description: "Verify Gemini for code quality"
          command: "cargo xtask review quality <PR_URL>"
        - description: "Verify reviewer health monitoring"
          command: "cargo xtask check"
          expected_output: "Reviewer Agents section displayed with health status"

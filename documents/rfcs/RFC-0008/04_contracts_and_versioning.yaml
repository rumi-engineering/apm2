rfc_contracts_and_versioning:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"

  contracts:
    - id: CONTRACT-008-001
      name: "GitHub webhook endpoint contract"
      description: |
        HTTP endpoint that receives GitHub workflow_run webhooks.
      interface:
        endpoint: "POST /webhooks/github"
        content_type: "application/json"
        required_headers:
          - name: "X-Hub-Signature-256"
            format: "sha256=<HMAC-SHA256 hex digest>"
            purpose: "Payload signature verification"
          - name: "X-GitHub-Event"
            format: "workflow_run"
            purpose: "Event type identification"
          - name: "X-GitHub-Delivery"
            format: "UUID"
            purpose: "Unique delivery ID for idempotency"
        responses:
          200: "Webhook processed successfully"
          202: "Webhook accepted, processing async"
          400: "Invalid payload format"
          401: "Invalid or missing signature"
          429: "Rate limit exceeded"
          500: "Internal server error"
      backward_compatible: true
      notes: "New endpoint; follows GitHub webhook conventions"

    - id: CONTRACT-008-002
      name: "CIWorkflowCompleted event schema"
      description: |
        Ledger event emitted when CI workflow completes.
      interface:
        event_type: "CIWorkflowCompleted"
        schema: |
          {
            "event_id": "<UUID>",
            "event_type": "CIWorkflowCompleted",
            "timestamp": "<ISO8601>",
            "source": "github_webhook",
            "payload": {
              "pr_number": <number>,
              "commit_sha": "<40 char hex>",
              "conclusion": "success" | "failure" | "cancelled",
              "workflow_name": "<string>",
              "workflow_run_id": <number>,
              "checks": [
                {
                  "name": "<string>",
                  "conclusion": "success" | "failure" | "skipped",
                  "started_at": "<ISO8601>",
                  "completed_at": "<ISO8601>"
                }
              ]
            },
            "signature_verified": true,
            "delivery_id": "<UUID from X-GitHub-Delivery>"
          }
        idempotency: "Duplicate delivery_id events are ignored"
      backward_compatible: true
      notes: "New event type"

    - id: CONTRACT-008-003
      name: "WorkReadyForNextPhase event schema"
      description: |
        Ledger event emitted when work transitions after CI completion.
      interface:
        event_type: "WorkReadyForNextPhase"
        schema: |
          {
            "event_id": "<UUID>",
            "event_type": "WorkReadyForNextPhase",
            "timestamp": "<ISO8601>",
            "payload": {
              "work_id": "<UUID>",
              "previous_phase": "CI_PENDING",
              "next_phase": "READY_FOR_REVIEW" | "BLOCKED",
              "triggered_by": "<CIWorkflowCompleted event_id>",
              "evidence_bundle_ref": "<path to evidence bundle>"
            }
          }
      backward_compatible: true
      notes: "New event type"

    - id: CONTRACT-008-004
      name: "AgentSessionCompleted event schema"
      description: |
        Ledger event emitted when an agent signals phase completion.
      interface:
        event_type: "AgentSessionCompleted"
        schema: |
          {
            "event_id": "<UUID>",
            "event_type": "AgentSessionCompleted",
            "timestamp": "<ISO8601>",
            "payload": {
              "session_id": "<UUID>",
              "work_id": "<UUID>",
              "phase_completed": "IMPLEMENTATION" | "REVIEW" | "...",
              "pr_url": "<GitHub PR URL or null>",
              "evidence_bundle_ref": "<path to evidence bundle>",
              "next_expected_phase": "CI_PENDING" | "READY_FOR_MERGE" | "...",
              "exit_reason": "completed" | "blocked" | "error"
            }
          }
      backward_compatible: true
      notes: "New event type"

    - id: CONTRACT-008-005
      name: "Agent exit protocol contract"
      description: |
        Structured output format for agent phase completion.
      interface:
        output_format: |
          Agent outputs JSON to stdout at session end:
          ```json
          {
            "protocol": "apm2_agent_exit",
            "version": "1.0.0",
            "phase_completed": "IMPLEMENTATION",
            "pr_url": "https://github.com/org/repo/pull/123",
            "evidence_bundle_ref": "evidence/work/W-00042/phase_implementation.yaml",
            "exit_reason": "completed",
            "notes": "Implementation complete, ready for CI"
          }
          ```
        required_fields:
          - "protocol (must be apm2_agent_exit)"
          - "version"
          - "phase_completed"
          - "exit_reason"
        optional_fields:
          - "pr_url (if PR was created)"
          - "evidence_bundle_ref"
          - "notes"
      backward_compatible: true
      notes: "New protocol; agents must be updated to emit this"

    - id: CONTRACT-008-006
      name: "Task queue work item phase model"
      description: |
        Work item lifecycle phases with CI gating.
      interface:
        phases:
          - name: "DRAFT"
            description: "Initial state, work defined but not started"
            claimable: true
          - name: "IMPLEMENTATION"
            description: "Agent implementing the work"
            claimable: false
          - name: "CI_PENDING"
            description: "Waiting for CI completion"
            claimable: false
            exit_conditions:
              - "CIWorkflowCompleted with conclusion=success -> READY_FOR_REVIEW"
              - "CIWorkflowCompleted with conclusion=failure -> BLOCKED"
          - name: "READY_FOR_REVIEW"
            description: "CI passed, ready for review agent"
            claimable: true
          - name: "BLOCKED"
            description: "CI failed or other blocker"
            claimable: false
          - name: "REVIEW"
            description: "Agent reviewing the work"
            claimable: false
          - name: "READY_FOR_MERGE"
            description: "Review complete, ready to merge"
            claimable: true
          - name: "COMPLETED"
            description: "Work merged and complete"
            claimable: false
      backward_compatible: true
      notes: "Extends PRD-0004 work item model with CI phases"

  versioning:
    strategy: "Semantic versioning for event schemas"
    rationale: |
      Event schemas are contracts between components. Using semantic versioning
      allows consumers to detect breaking changes:
      - MAJOR: Breaking changes to event schema
      - MINOR: New optional fields, new event types
      - PATCH: Documentation, non-schema changes

      Current version: 1.0.0 (initial release)

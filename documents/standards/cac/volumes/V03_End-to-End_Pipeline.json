{
  "schema": "apm2.prd.volume.v1",
  "schema_version": "1.0.0",
  "sections": [
    {
      "content": {
        "closed_loop": {
          "default_rule": "Treat unplanned reads/tool calls in consumption mode as compiler defects, not execution necessities.",
          "feedback_targets": [
            "ContextPack compiler rules",
            "Schema evolution (tighten or expand)",
            "Capability manifest updates",
            "Target profile updates",
            "ChangeSet compaction rules"
          ],
          "signals": [
            "PolicyViolation events",
            "BudgetExceeded events",
            "Unplanned tool call attempts in consumption mode",
            "Selftest/AAT failures",
            "Export conformance failures"
          ]
        },
        "overview": "A closed-loop, message-native context pipeline: machines propose patches with semantic deltas; kernel admits canonical artifacts; compiler builds deep-pinned packs and target-specific payloads; consumption is hermetic and budgeted; misses create defects; improvements feed back into pack compilation and target profiles.",
        "stages": [
          {
            "default_tool_budget": {
              "notes": [
                "Patch authoring may run in production mode and use tools under lease/budget."
              ],
              "tool_calls": "bounded"
            },
            "inputs": [
              "work_id",
              "target_artifact_ref (stable_id + expected_base_hash)",
              "schema_ref",
              "budget/lease refs"
            ],
            "invariants": [
              "PatchRecord must include expected_base_hash for replay protection.",
              "PatchRecord must declare patch_kind and be schema-valid itself.",
              "If patch touches security-critical artifacts, it must include a justification_code and can trigger adjudication."
            ],
            "mode": "PRODUCE",
            "name": "Patch Authoring",
            "outputs": [
              "PatchRecord (JSONL record)",
              "ChangeSetReport (semantic delta summary)",
              "optional supporting evidence (CAS refs)"
            ],
            "stage_id": "CAC-STAGE-01"
          },
          {
            "inputs": [
              "PatchRecord",
              "schema_ref",
              "policy_profile_ref",
              "artifact_kind rules"
            ],
            "invariants": [
              "Fail-closed on schema mismatch, unknown fields, forbidden constructs, size/depth limits.",
              "Reject patch if expected_base_hash does not match current artifact hash.",
              "Policy profile may deny patching certain paths/fields without adjudication.",
              "Admission requires a ChangeSetReport for patch streams."
            ],
            "kernel_messages": [
              {
                "event": "PolicyViolation",
                "event_family": "PolicyEvent",
                "when": "on denial due to policy"
              }
            ],
            "mode": "KERNEL",
            "name": "Admission Gate: Validate",
            "outputs": [
              "ValidationReport (machine-readable)",
              "admit/deny decision"
            ],
            "stage_id": "CAC-STAGE-02"
          },
          {
            "inputs": [
              "validated PatchRecord",
              "base artifact (canonical)",
              "canonicalizer id/version"
            ],
            "invariants": [
              "Canonicalization is deterministic and idempotent.",
              "New artifact must validate against target schema after patching and canonicalization.",
              "AdmissionReceipt references: patch record hash, base hash, new hash, schema hash, canonicalizer id/version."
            ],
            "kernel_messages": [
              {
                "event": "EvidencePublished",
                "event_family": "EvidenceEvent",
                "when": "on publishing AdmissionReceipt and/or admitted artifact"
              }
            ],
            "mode": "KERNEL",
            "name": "Admission Gate: Apply Patch + Canonicalize",
            "outputs": [
              "new canonical artifact bytes",
              "content_hash",
              "AdmissionReceipt"
            ],
            "stage_id": "CAC-STAGE-03"
          },
          {
            "dcp_indexing_strategy": {
              "fallback": "Explicit DCP mapping events (future extension)",
              "preferred": "Projection over ledger EvidencePublished metadata"
            },
            "inputs": [
              "canonical artifact bytes",
              "artifact metadata (stable_id, schema_id, kind)"
            ],
            "invariants": [
              "CAS blobs are immutable and verified by hash.",
              "DCP is derived: stable_id -> content_hash mapping is reconstructable from ledger events.",
              "No artifact becomes visible to consumption mode until its stable_id resolves to a pinned content_hash.",
              "Dependency edges are recorded for graph closure queries."
            ],
            "mode": "KERNEL",
            "name": "Publish to CAS + Update DCP",
            "outputs": [
              "CAS blob",
              "DCP index update",
              "ledger provenance events"
            ],
            "stage_id": "CAC-STAGE-04"
          },
          {
            "inputs": [
              "ContextPackSpec (stable_id)",
              "resolved stable_ids",
              "lease/budget refs",
              "TargetProfile (stable_id)"
            ],
            "invariants": [
              "Compilation is deterministic given resolved inputs and target profile.",
              "Manifest lists every stable_id with pinned content_hash; no floating refs.",
              "Transitive dependency closure is resolved and pinned (deep pinning).",
              "Context budgets (tokens, artifacts, bytes) are enforced during compilation.",
              "Compiler must emit evidence snapshots for any tool-derived sources."
            ],
            "kernel_messages": [
              {
                "event": "EvidencePublished",
                "event_family": "EvidenceEvent",
                "when": "on publishing pack manifest and receipts"
              }
            ],
            "mode": "PRODUCE",
            "name": "Compile ContextPacks",
            "outputs": [
              "ContextPackManifest",
              "Derived PromptPack artifacts (TOON or compact JSON)",
              "PackCompilationReceipt"
            ],
            "stage_id": "CAC-STAGE-05"
          },
          {
            "inputs": [
              "TargetProfile (stable_id)",
              "SkillSpec and other inputs (stable_ids)",
              "export target (workspace dir)"
            ],
            "invariants": [
              "Rendering is deterministic and constrained by the target profile.",
              "Export is deterministic from inputs; output tree is byte-identical for identical inputs.",
              "Generated files embed provenance (stable_ids, hashes) where possible (e.g., YAML frontmatter).",
              "Conformance tests are required and their results are published as evidence."
            ],
            "kernel_messages": [
              {
                "event": "EvidencePublished",
                "event_family": "EvidenceEvent",
                "when": "on publishing export manifest/receipt"
              },
              {
                "event": "GateReceiptGenerated",
                "event_family": "GateReceiptGenerated",
                "when": "optional gating of export"
              }
            ],
            "mode": "PRODUCE",
            "name": "Target Delivery Rendering",
            "outputs": [
              "delivery payloads (vendor layouts, model IRs)",
              "ExportManifest",
              "ExportReceipt",
              "conformance test report"
            ],
            "stage_id": "CAC-STAGE-06"
          },
          {
            "inputs": [
              "built apm2 binary",
              "capabilities manifest schema",
              "selftest suite"
            ],
            "invariants": [
              "CapabilityManifest is generated from the binary (not handwritten).",
              "Selftests are hermetic and bounded (time/tool/token budgets).",
              "AATReceipt is required for critical cutovers and for agent planning gates."
            ],
            "mode": "PRODUCE",
            "name": "Capability Truthing + Selftest (AAT)",
            "outputs": [
              "CapabilityManifest",
              "AATReceipt",
              "GateReceipt (optional)"
            ],
            "stage_id": "CAC-STAGE-07"
          },
          {
            "defect_generation": [
              {
                "default_remediation": [
                  "update ContextPackSpec",
                  "update pack compiler rules",
                  "add stable-ID mapping"
                ],
                "defect_class": "UNPLANNED_CONTEXT_READ",
                "trigger": "attempted tool call or read not in pack allowlist"
              }
            ],
            "inputs": [
              "work_id",
              "ContextPackManifest",
              "CapabilityManifest",
              "policy profile"
            ],
            "invariants": [
              "All context reads must be stable-ID fetches from DCP via deterministic tools.",
              "Discretionary discovery attempts are denied or defect-emitting.",
              "Any required extra context is classified as a pack compiler failure defect.",
              "context_pack_miss emits a defect and fails the run unless explicitly in escalation-allowed mode."
            ],
            "mode": "CONSUME",
            "name": "Consume (Execution/Review/Ops)",
            "outputs": [
              "work outputs (code, reviews, ops actions)",
              "RunReceipt (context_pack_miss + sufficiency)",
              "evidence artifacts",
              "ledger events"
            ],
            "stage_id": "CAC-STAGE-08"
          }
        ]
      },
      "section_id": "PIPELINE",
      "title": "Pipeline"
    }
  ],
  "volume": {
    "generated_at": "2026-01-26",
    "source_prd_id": "APM2-PRD-CAC-0001",
    "title": "End-to-End Pipeline",
    "volume_id": "V03"
  }
}

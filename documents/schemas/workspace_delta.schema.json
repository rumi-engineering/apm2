{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://apm2.dev/schemas/apm2/workspace_delta.schema.json",
  "title": "WorkspaceDelta",
  "description": "Content-addressed representation of a dirty working state relative to a pinned base repo state (usually Git commit/tree). Patch bytes are stored in CAS and referenced by hash.",
  "type": "object",
  "required": ["schema", "schema_version", "base", "patch_format", "patch_hash"],
  "properties": {
    "schema": {
      "type": "string",
      "const": "apm2.workspace_delta.v1"
    },
    "schema_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "base": {
      "type": "object",
      "description": "Pinned base state the delta applies to. At least one of commit or tree must be present.",
      "properties": {
        "commit": {
          "allOf": [
            { "$ref": "git_object_ref.schema.json" },
            {
              "properties": { "object_kind": { "const": "commit" } },
              "required": ["object_kind"]
            }
          ]
        },
        "tree": {
          "allOf": [
            { "$ref": "git_object_ref.schema.json" },
            {
              "properties": { "object_kind": { "const": "tree" } },
              "required": ["object_kind"]
            }
          ]
        }
      },
      "anyOf": [{ "required": ["commit"] }, { "required": ["tree"] }],
      "unevaluatedProperties": false
    },
    "patch_format": {
      "type": "string",
      "description": "Patch encoding format.",
      "enum": ["git_unified_diff"]
    },
    "patch_hash": {
      "type": "string",
      "description": "Hex-encoded 32-byte hash of patch bytes stored in CAS.",
      "pattern": "^[a-f0-9]{64}$"
    },
    "paths_touched": {
      "type": "array",
      "description": "Optional path list touched by this delta (used for policy scoping and review).",
      "maxItems": 100000,
      "items": {
        "type": "string",
        "minLength": 1,
        "maxLength": 4096
      }
    },
    "staged": {
      "type": "boolean",
      "description": "Whether this delta represents staged changes (git index) rather than working tree."
    }
  },
  "unevaluatedProperties": false
}

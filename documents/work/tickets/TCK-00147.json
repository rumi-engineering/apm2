{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00147",
      "title": "Add CLI commands: apm2 capabilities, apm2 selftest",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0007",
      "rfc_id": "RFC-0011",
      "requirements": [
        {
          "requirement_id": "CAC-REQ-0014",
          "requirement_ref": "documents/prds/PRD-0007/requirements/REQ-0014.yaml#prd_requirement"
        },
        {
          "requirement_id": "CAC-REQ-0006",
          "requirement_ref": "documents/prds/PRD-0007/requirements/REQ-0006.yaml#prd_requirement"
        }
      ],
      "evidence_artifacts": [
        "EVID-0007"
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_CLI",
        "DOMAIN_AGENT_RUNTIME"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00144",
        "TCK-00145"
      ]
    },
    "scope": {
      "in_scope": [
        "Add 'cargo xtask capabilities' command for manifest generation",
        "Add 'cargo xtask selftest' command for AAT execution",
        "Support --json flag for machine-readable output",
        "Support --filter for running subset of selftests",
        "Emit receipt to stdout or file (--output flag)",
        "Exit code reflects selftest pass/fail status",
        "Human-readable summary output by default"
      ],
      "out_of_scope": [
        "CapabilityManifest generation logic (TCK-00144)",
        "Selftest harness implementation (TCK-00145)",
        "Capability gating logic (TCK-00146)",
        "Interactive selftest mode"
      ]
    },
    "plan": {
      "steps": [
        "Add Capabilities subcommand to xtask/src/main.rs Commands enum",
        "Add Selftest subcommand to Commands enum",
        "Define CapabilitiesArgs: --json, --output",
        "Define SelftestArgs: --json, --filter, --output, --timeout",
        "Create xtask/src/tasks/capabilities.rs for command implementation",
        "Create xtask/src/tasks/selftest.rs for command implementation",
        "Implement capabilities(): generate manifest, serialize, output",
        "Implement selftest(): discover tests, run harness, emit receipt",
        "Add human-readable summary formatter (passed/failed/skipped counts)",
        "Set exit code: 0 on all pass, 1 on any failure",
        "Update xtask/src/tasks/mod.rs to export new commands",
        "Add integration tests for CLI invocation"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-0007"
      ],
      "criteria": [
        "'cargo xtask capabilities' outputs capability manifest",
        "'cargo xtask capabilities --json' outputs JSON format",
        "'cargo xtask selftest' runs all selftests and reports results",
        "'cargo xtask selftest --filter canonicalize' runs matching tests",
        "Exit code 0 when all tests pass, 1 when any fail",
        "--output flag writes result to file",
        "Human-readable output shows pass/fail counts",
        "All tests pass: cargo test --package xtask capabilities selftest"
      ]
    },
    "notes": {
      "rust_textbook_refs": [
        {
          "file": ".claude/skills/rust-textbook/07_errors_panics_diagnostics.md",
          "contracts": [
            "CTR-0701: Failure Channel Selection - Result for CLI errors",
            "CTR-0703: Error Types Structured - CliError for user-facing messages"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/12_api_design_stdlib_quality.md",
          "contracts": [
            "CTR-1202: Borrowed vs Owned Discipline - borrowed refs for filter patterns"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/26_apm2_safe_patterns_and_anti_patterns.md",
          "contracts": [
            "CTR-2607: State Files Use Atomic Write - atomic write for --output"
          ]
        }
      ],
      "codebase_context": {
        "new_files": [
          {
            "path": "xtask/src/tasks/capabilities.rs",
            "description": "capabilities command implementation"
          },
          {
            "path": "xtask/src/tasks/selftest.rs",
            "description": "selftest command implementation"
          }
        ],
        "extend_files": [
          {
            "path": "xtask/src/main.rs",
            "description": "Add Capabilities and Selftest to Commands enum"
          },
          {
            "path": "xtask/src/tasks/mod.rs",
            "description": "Export capabilities and selftest modules"
          }
        ],
        "reference_files": [
          {
            "path": "xtask/src/main.rs",
            "description": "Existing clap CLI pattern (lines 52-170)"
          },
          {
            "path": "xtask/src/tasks/aat.rs",
            "description": "AAT task pattern for selftest reference"
          }
        ]
      },
      "security": "File output uses atomic write pattern (CTR-2607).\nNo secrets in capability manifest output.\n",
      "architecture": "Per preliminary ticket CAC-TCK-0021:\n- 'cargo xtask capabilities --json' for manifest generation\n- 'cargo xtask selftest' for AAT execution\n- Receipt output format (JSON/human-readable)\n- Exit code reflects pass/fail for CI integration\n- Filter flag enables targeted testing during development\n"
    }
  }
}

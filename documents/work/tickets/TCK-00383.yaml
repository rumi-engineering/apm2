ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00383"
    title: "Daemon session dispatcher: wire CAS, broker, ledger, and clock via with_persistence_and_cas"
    status: "OPEN"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0018"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
      - "DOMAIN_SECURITY"
  dependencies:
    tickets: []
  scope:
    in_scope:
      - "Add `--cas-path <PATH>` CLI argument to `apm2-daemon` binary."
      - "Switch `main.rs` DispatcherState construction from `with_persistence()` to `with_persistence_and_cas()` when both `--ledger-db` and `--cas-path` are provided."
      - "Ensure the DurableCas directory is created if it does not exist."
      - "Add `--cas-path` to `ecosystem.toml` daemon config section."
      - "Update `ecosystem.example.toml` with a `cas_path` example."
      - "Add integration test verifying the session dispatcher can execute tool requests, emit events, and publish evidence when CAS + ledger are configured."
    out_of_scope:
      - "ToolBroker business logic (already implemented in broker.rs)."
      - "DurableCas implementation (already implemented in cas.rs)."
      - "SessionDispatcher builder methods (with_ledger, with_cas, with_broker, with_clock, with_episode_runtime already exist)."
      - "Changing the fallback behavior when --cas-path is omitted (stubs remain for backward compatibility)."
  plan:
    steps:
      - "Add `--cas-path` clap argument to DaemonArgs in main.rs alongside --ledger-db."
      - "Add `cas_path` field to `[daemon]` section of EcosystemConfig."
      - "In main.rs async_main, when both sqlite_conn and cas_path are available, call `DispatcherState::with_persistence_and_cas(session_registry, metrics, conn, cas_path)` instead of `with_persistence()`."
      - "When only sqlite_conn is available (no cas_path), continue using `with_persistence()` for backward compatibility."
      - "Update ecosystem.example.toml with `cas_path = '/var/lib/apm2/cas'` example."
      - "Add integration test: start daemon with --cas-path and --ledger-db, connect via session socket, verify RequestTool succeeds (broker available), verify EmitEvent succeeds (ledger available), verify PublishEvidence succeeds (CAS available)."
      - "Verify existing tests still pass (cargo test -p apm2-daemon)."
  definition_of_done:
    criteria:
      - "Daemon started with `--ledger-db` and `--cas-path` uses `with_persistence_and_cas` constructor."
      - "SessionDispatcher has broker, CAS, ledger, clock, and episode_runtime wired."
      - "RequestTool via session socket returns tool results (not 'broker unavailable')."
      - "EmitEvent via session socket persists to SQLite ledger (not 'ledger unavailable')."
      - "PublishEvidence via session socket stores artifacts in DurableCas."
      - "Daemon started without `--cas-path` falls back to `with_persistence` (backward compatible)."
      - "All 7,377 existing tests still pass."
  notes:
    context: |
      This is the single most critical blocker for autonomous FAC. The daemon's
      session dispatcher currently has no backing stores because main.rs (line 679)
      calls `DispatcherState::with_persistence()` which wires the PrivilegedDispatcher
      with real SQLite stores but leaves the SessionDispatcher with only a manifest
      store and subscription registry.

      The `with_persistence_and_cas()` constructor (state.rs line 470) exists and
      properly wires ALL dependencies into the SessionDispatcher:
        .with_ledger(event_emitter)
        .with_cas(cas)
        .with_clock(clock)
        .with_broker(broker)
        .with_episode_runtime(episode_runtime)

      But main.rs never calls it because there is no --cas-path CLI argument to
      provide the DurableCas storage path.

      Without this ticket, every session-scoped operation (tool execution, event
      emission, evidence publishing) fails closed with "unavailable" errors. The
      coordinate command can claim work and spawn episodes (privileged socket), but
      the spawned sessions cannot actually DO anything.

      AAT finding: We successfully exercised ClaimWork -> SpawnEpisode -> SessionStatus
      via IPC, but the session dispatcher cannot execute tools or persist events.
    files: |
      - crates/apm2-daemon/src/main.rs (line 679: with_persistence call, line 634: CLI args)
      - crates/apm2-daemon/src/state.rs (line 320: with_persistence, line 470: with_persistence_and_cas)
      - crates/apm2-daemon/src/protocol/session_dispatch.rs (fail-closed checks for broker/ledger/cas)
      - crates/apm2-daemon/src/episode/broker.rs (ToolBroker, line 576: TODO TCK-FUTURE)
      - crates/apm2-daemon/src/cas.rs (DurableCas implementation)
      - ecosystem.example.toml (daemon config section)
    security: |
      The CAS path must be validated: absolute path, no symlinks, owned by daemon UID.
      DurableCas creates the directory with mode 0700. The broker enforces capability
      manifests before tool execution. Fail-closed behavior must be preserved when
      --cas-path is not provided.

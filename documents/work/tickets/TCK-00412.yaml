ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00412"
    title: "PublishChangeSet fail-closed closure: production CAS wiring, ownership binding, digest integrity, and semantic idempotency"
    status: "OPEN"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0018"
    requirements:
      - requirement_id: "REQ-HEF-0009"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0009.yaml#rfc_requirement"
      - requirement_id: "REQ-HEF-0010"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0010.yaml#rfc_requirement"
      - requirement_id: "REQ-HEF-0011"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0011.yaml#rfc_requirement"
    evidence_artifacts:
      - evidence_id: "EVID-HEF-0009"
        artifact_ref: "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0009.yaml#rfc_evidence_artifact"
      - evidence_id: "EVID-HEF-0012"
        artifact_ref: "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0012.yaml#rfc_evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
      - "AGENT_REVIEWER"
    responsibility_domains:
      - "DOMAIN_SECURITY"
      - "DOMAIN_RUNTIME"
      - "DOMAIN_DATA"
  dependencies:
    tickets:
      - ticket_id: "TCK-00394"
        reason: "Base PublishChangeSet endpoint exists but leaves security/runtime invariants partially unclosed."
      - ticket_id: "TCK-00383"
        reason: "CAS dependency wiring patterns from dispatcher/session initialization are prerequisite context."
      - ticket_id: "TCK-00408"
        reason: "This ticket provides concrete closure for RFC-0018 publish/ingest fail-closed gaps identified in re-review."
  scope:
    in_scope:
      - "Wire production privileged dispatcher construction with CAS (`with_cas`) so PublishChangeSet is functional outside test-only builders."
      - "Enforce actor ownership binding for PublishChangeSet: derived caller actor must match work claim actor before any mutation."
      - "Require full `ChangeSetBundleV1` validation and recompute digest from canonical fields; reject caller-provided digest mismatches."
      - "Unify signing contract with canonical FAC domain separator for ChangeSetPublished events (no divergent ad-hoc domain prefix)."
      - "Enforce semantic idempotency on `(work_id, computed_changeset_digest)` independent of CAS byte-level `is_new` behavior."
      - "Return authoritative replay data from the matched persisted event (event_id + bound CAS hash) on idempotent re-publish."
      - "Add production-path integration tests that construct daemon state as runtime does and execute PublishChangeSet over privileged IPC."
      - "Add negative tests for missing CAS wiring, ownership mismatch, invalid bundle, digest mismatch, and non-canonical duplicate JSON payloads."
    out_of_scope:
      - "Historical migration/backfill of already-emitted incorrect ledger events."
      - "Non-ChangeSetPublished event family redesign."
      - "Changing RFC-0018 requirement text without separate governance approval."
  plan:
    steps:
      - "Patch privileged dispatcher wiring in `crates/apm2-daemon/src/state.rs` to include CAS for production constructors used by daemon runtime."
      - "In `handle_publish_changeset`, fetch claim and enforce actor equality (`claim.actor_id == derive_actor_id(peer_creds)`) with fail-closed denial."
      - "Deserialize bundle, invoke `bundle.validate()`, recompute digest, and reject if embedded digest does not match recomputed canonical digest."
      - "Refactor ChangeSetPublished emission to reuse core contract helpers/domain separator expected by RFC-0018/TCK-00394."
      - "Refactor idempotency lookup to semantic key `(work_id, computed_digest)` and return persisted event binding values, not request-local surrogates."
      - "Add integration tests using daemon runtime wiring (not helper-only dispatch builders) to prove endpoint behavior matches production."
      - "Add regression tests for canonicalization variance: semantically equivalent bundles with different JSON formatting must dedupe correctly."
      - "Run cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings && cargo test --workspace."
  definition_of_done:
    evidence_ids:
      - "EVID-HEF-0009"
      - "EVID-HEF-0012"
    criteria:
      - "PublishChangeSet succeeds in production-wired daemon state when CAS is configured, and fails closed when CAS is absent."
      - "Requests from non-owner actors are denied before CAS write or ledger emission."
      - "Bundle validation and digest recomputation are mandatory; invalid/mismatched bundles are rejected with deterministic errors."
      - "ChangeSetPublished signatures use the canonical FAC domain separation contract and verify with existing core verifiers."
      - "Idempotency is semantic: duplicate logical publish requests return stable authoritative event identity with no duplicate events."
      - "Production-path integration tests and negative tests cover all previously reported blocker/major finding classes."
  notes:
    context: |
      Root causes observed in PR #445 re-reviews:
      1) Production runtime wiring diverged from test wiring (CAS injected in tests
      but not in authoritative daemon construction path).
      2) Security invariants were implemented as partial field checks rather than
      canonical bundle validation plus ownership binding.
      3) Identity/signature/idempotency contracts drifted from RFC intent
      (ad-hoc domain prefix and byte-level dedupe in place of semantic keys).

      These defects allowed a merged endpoint to remain either non-functional
      in production or weaker than required on identity/integrity guarantees.
    files: |
      - crates/apm2-daemon/src/state.rs
      - crates/apm2-daemon/src/protocol/dispatch.rs
      - crates/apm2-daemon/src/ledger.rs
      - crates/apm2-core/src/fac/changeset_bundle.rs
      - crates/apm2-core/src/fac/domain_separator.rs
      - crates/apm2-daemon/tests/
      - proto/apm2d_runtime_v1.proto
    security: |
      - Privileged publish handlers must validate identity and content binding before any authoritative side effect.
      - Idempotency keys must be semantic and replay-safe, not transport-byte incidental.
      - Any missing dependency or contract mismatch must fail closed with auditable error paths.

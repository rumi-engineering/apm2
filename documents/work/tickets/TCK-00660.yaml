ticket_meta:
  schema_version: '2026-01-29'
  template_version: '2026-01-29'
  ticket:
    id: 'TCK-00660'
    title: 'FAC worker: Event-driven queue reconcile to self-heal stuck claimed jobs (no restart, no periodic sweep)'
    status: 'OPEN'
  binds:
    prd_id: 'PRD-0001'
    rfc_id: 'RFC-0019'
    requirements:
      - 'REQ-0020' # partition-tolerant convergence; no silent stuck claimed work
      - 'REQ-0037' # deterministic claimed reconcile and conflict resolution
    evidence_artifacts: []
  custody:
    agent_roles:
      - 'Implementer'
      - 'Reviewer'
    responsibility_domains:
      - 'fac/worker'
      - 'fac/reconcile'
      - 'fac/queue'
  dependencies:
    tickets:
      - 'TCK-00622' # queue/lane reconcile safety baseline
      - 'TCK-00659' # doctor is the sole host remediation surface

context:
  observed_symptoms:
    - 'Queue lanes go idle while queue/claimed contains jobs that are not processed; queue/pending is empty.'
    - 'Runtime self-heal is missing: queue repair happens at worker startup and in `apm2 fac doctor --fix`, not continuously during healthy worker operation.'
  code_evidence:
    - |
      Worker reconcile is invoked at startup before entering the poll loop:
        crates/apm2-cli/src/commands/fac_worker.rs:772-828
    - |
      On commit pipeline failure, worker intentionally leaves job in claimed and returns Skipped:
        crates/apm2-cli/src/commands/fac_worker.rs:8772-8802
    - |
      Queue reconcile already uses bounded traversal and non-blocking flock probes to avoid racing
      active commits:
        crates/apm2-core/src/fac/reconcile.rs:1325-1705
    - |
      Host-level doctor fix already runs full lane+queue reconcile and deterministic remediation:
        crates/apm2-cli/src/commands/fac.rs:2571-3095

problem_statement: |
  Stuck claimed jobs are currently repaired by startup reconcile or by host-level doctor remediation.
  When the worker remains alive but no restart occurs, claimed or torn states can remain indefinitely
  even though the system has enough evidence to repair them safely. We need automatic runtime repair
  that does not depend on a periodic sweep timer and does not require restart.

root_cause_analysis:
  primary_cause: |
    Reconciliation semantics are split:
      - startup/doctor path performs full repair,
      - runtime loop only scans pending work.
    The write path intentionally leaves some failures in claimed/, but runtime has no signal-driven
    queue-repair trigger to converge those states immediately.

requirements_alignment:
  - id: 'REQ-0020'
    statement: |
      Runtime repair must converge claimed queue state under partial failure (dropped/duplicated
      watch events, transient watcher loss, commit failures) without silent work loss. Bounded
      degraded safety-nudge mode and explicit blocked diagnostics are required. Doctor-first
      remediation keeps two explicit scopes:
        - `apm2 fac doctor --fix` for host reconciliation/remediation,
        - `apm2 fac doctor --pr <N> --fix` for PR-scoped lifecycle/agent repair.
      Both paths must remain idempotent under repeated invocation.
  - id: 'REQ-0037'
    statement: |
      Runtime claimed reconcile must be deterministic: explicit state machine, bounded scan/action
      limits, and single-flight scan-lock gating. Escalation paths are scope-specific and explicit:
      `apm2 fac doctor --fix` for host remediation and `apm2 fac doctor --pr <N> --fix` for
      PR-scoped remediation. Deterministic simulated tests (no wall-clock sleeps for steady-state
      activation assertions) are required for wake-latency and coalescing guarantees.

proposed_change:
  intent: |
    Add a signal-driven runtime queue reconcile path (claimed-only) that is triggered by concrete
    failure/repair signals instead of periodic polling:
      - commit pipeline failure,
      - explicit repair-request signals in worker control flow,
      - optional filesystem watch signal when available.
    The runtime path MUST reuse existing queue reconcile safety controls (flock probe, bounded scan,
    token-aware orphan policy) and MUST NOT perform lane mutations.

high_level_design:
  objective: |
    Introduce a deterministic runtime repair controller that converges `queue/claimed` state
    immediately when repair signals occur, without introducing a periodic reconcile sweep.
  architecture:
    - id: 'C1'
      name: 'Repair Signal Plane'
      description: |
        Define a small set of explicit repair signals emitted by runtime control flow:
          - CommitPipelineFailed(job_id)
          - ClaimedQueueFsChanged(path) (best-effort watch backend)
          - ExplicitRepairRequested(reason)
        Signals are level-triggered into a bounded in-memory "repair requested" latch
        (coalescing duplicates) rather than queued unboundedly.
    - id: 'C2'
      name: 'Worker Repair Coordinator'
      description: |
        Add a `RuntimeRepairCoordinator` in fac_worker that owns:
          - repair_requested flag/latch
          - in_progress guard (single-flight reconcile execution)
          - bounded runtime reconcile config
          - last reconcile summary snapshot for heartbeat/diagnostics
        The coordinator attempts reconcile only when scan lock ownership is held.
    - id: 'C3'
      name: 'Runtime Queue Reconcile API (Core)'
      description: |
        Add a runtime-safe core API for claimed-only reconciliation that:
          - reuses `reconcile_queue` safety semantics (bounded traversal, flock probe, token-aware policy),
          - does not mutate lane state,
          - returns a structured result (`applied`, `skipped`, `blocked`, `failed` counters + reasons).
    - id: 'C4'
      name: 'Event-Driven Queue Activation Adapter'
      description: |
        Integrate a watcher-driven activation path for queue work and repair signals:
          - watch `queue/pending` for enqueue-ready transitions,
          - watch `queue/claimed` for repair-relevant transitions,
          - raise immediate wake signals to the worker coordinator.
        This is the primary low-latency activation path for dispatch/reconcile. Watch
        failure/degradation must not disable internal repair triggers.
    - id: 'C5'
      name: 'Doctor Escalation Boundary'
      description: |
        Runtime reconcile handles only safe claimed-file convergence. Any ambiguous or blocked
        condition emits deterministic diagnostics and escalates to doctor-first remediation:
          - `apm2 fac doctor --fix` for host/runtime repair scope,
          - `apm2 fac doctor --pr <N> --fix` when a PR-scoped FAC lifecycle context is present.
        Full lane+queue repair authority remains startup/doctor scope.
    - id: 'C6'
      name: 'Safety Nudge Fallback (Not Primary Scheduler)'
      description: |
        Keep only a low-frequency safety nudge timer to recover from dropped watch events,
        watcher overflow, or transient watcher unavailability. This timer is not the normal
        queue pickup mechanism and must not define steady-state pickup latency.
  runtime_state_machine:
    schema_hint: 'apm2.fac.runtime_reconcile_machine.v1 (ticket-level design target)'
    states:
      - 'Idle'
      - 'RepairRequested'
      - 'AwaitingScanLock'
      - 'Reconciling'
      - 'Reconciled'
      - 'Blocked'
      - 'Failed'
    transitions:
      - 'Idle -> RepairRequested on any repair signal'
      - 'RepairRequested -> AwaitingScanLock when worker loop attempts reconcile without lock'
      - 'RepairRequested|AwaitingScanLock -> Reconciling when scan lock acquired'
      - 'Reconciling -> Reconciled on successful bounded run'
      - 'Reconciling -> Blocked on safe fail-closed ambiguity/bounds blocker'
      - 'Reconciling -> Failed on hard reconcile error'
      - 'Reconciled|Blocked|Failed -> Idle after summary emission and latch clear policy'
  deterministic_execution_model:
    rules:
      - 'No timer-based periodic reconcile sweep; all runs are signal-triggered.'
      - 'Queue pickup activation is event-driven; new pending work must trigger immediate worker wake.'
      - 'At-most-one runtime reconcile execution at a time (single-flight).'
      - 'Repair requests coalesce; duplicate signals cannot create unbounded work.'
      - 'Every reconcile attempt emits structured machine-readable status for replay/debug.'
      - 'Any timer in this design is safety-nudge only (watch recovery), not primary scheduling.'

invariants:
  - id: 'INV-RECON-EVT-001'
    statement: 'Runtime queue reconcile MUST NOT mutate lane leases or lane state; lane repair remains startup/doctor authority.'
  - id: 'INV-RECON-EVT-002'
    statement: 'Runtime queue reconcile MUST NOT move a claimed file when flock probe indicates active commit ownership.'
  - id: 'INV-RECON-EVT-003'
    statement: 'Runtime queue reconcile MUST be bounded by deterministic scan/action limits and MUST fail closed on bound exceed.'
  - id: 'INV-RECON-EVT-004'
    statement: 'When runtime reconcile cannot safely decide, it MUST emit actionable blocked/failure diagnostics and recommend doctor-first remediation (`apm2 fac doctor --fix`, or `apm2 fac doctor --pr <N> --fix` when PR-scoped context is available).'
  - id: 'INV-RECON-EVT-005'
    statement: 'Worker queue pickup MUST be wake-driven by queue events; fixed-interval polling MUST NOT be the steady-state dispatch trigger.'
  - id: 'INV-RECON-EVT-006'
    statement: 'If watch delivery degrades (overflow/unavailable), worker MUST enter deterministic degraded mode using bounded safety nudges and explicit diagnostics.'
  - id: 'INV-RECON-EVT-007'
    statement: 'Legacy remediation surfaces are deprecated for this flow (`apm2 fac recover`, `apm2 fac review run`, `apm2 fac restart`, `apm2 fac review restart`): recovery guidance MUST route through `apm2 fac doctor --fix` (host) and `apm2 fac doctor --pr <N> --fix` (PR-scoped).'
  - id: 'INV-RECON-EVT-008'
    statement: 'Worker runtime queue activation MUST NOT expose user-facing poll cadence controls (for example `apm2 fac worker --poll-interval-secs`); degraded safety-nudge cadence is internal-only.'
  - id: 'INV-RECON-EVT-009'
    statement: 'Doctor fix scopes remain distinct and deterministic: `apm2 fac doctor --fix` MUST NOT take PR-scoped reviewer restart actions, and `apm2 fac doctor --pr <N> --fix` follow-up repair MUST remain bounded and idempotent (including identity refresh only when missing/stale).'

scope:
  in_scope:
    - id: 'S0'
      description: |
        Materialize the high-level runtime repair design in code-level contracts:
          - Introduce runtime reconcile controller and signal plane interfaces.
          - Define runtime reconcile state machine states/transitions in code comments/types/tests.
          - Ensure design maps 1:1 to this ticket's `high_level_design` section.
    - id: 'S1'
      description: |
        Introduce a runtime-safe queue reconcile API in apm2-core:
          - New public entrypoint for claimed-only repair (no lane mutation).
          - Reuses existing reconcile_queue safety controls.
          - Accepts explicit bounded config (max_claimed_scan_entries, max_actions).
          - Returns structured summary counters for heartbeat/telemetry.
    - id: 'S2'
      description: |
        Wire signal-driven triggers into fac_worker:
          - Add a runtime repair-request flag.
          - Set flag on commit pipeline failure paths that leave jobs in claimed/.
          - Attempt queue reconcile when:
              * repair-request flag is set, and
              * scan lock is held.
          - Clear flag only after successful or explicitly blocked reconcile handling.
    - id: 'S3'
      description: |
        Replace steady-state queue polling with event-driven activation:
          - Add watcher-driven wake path for `queue/pending` and `queue/claimed`.
          - Worker waits on wake signals and processes available work immediately.
          - No user-facing poll interval flag controls queue pickup scheduling.
          - Introduce low-frequency bounded safety nudge only for watch degradation recovery.
    - id: 'S4'
      description: |
        Add deterministic tests:
          - Unit: runtime reconcile entrypoint enforces bounds and reports deterministic counters.
          - Integration: commit-failure path sets repair-request and repairs orphan/torn claimed job.
          - Safety: flock-held claimed file is skipped and left untouched.
          - Resilience: watch backend unavailable/overflow enters degraded safety-nudge mode with explicit diagnostics.
          - Latency: enqueue-to-dispatch wake path is immediate in event-driven mode (no fixed 5-10s wait).
          - Remediation: repeated `apm2 fac doctor --fix` and `apm2 fac doctor --pr <N> --fix`
            invocations are idempotent after first convergence.
          - PR repair strategy: `apm2 fac doctor --pr <N> --fix` keeps follow-up repair bounded and
            refreshes identity only when stale/missing.
          - PR doctor no-op regression guard: when direct repair-plan operations are empty but
            doctor still recommends fix with follow-up repair, `apm2 fac doctor --pr <N> --fix`
            MUST execute the bounded follow-up repair cycle.
          - Projection-gap regression guard: when verdict projection is terminal-approved but
            missing authoritative remote comment binding, doctor MUST recommend `fix` (not `merge`
            or `approve`) and execute bounded follow-up projection repair.
          - Run-state-only repair guard: run-state corruption/ambiguity repair MUST NOT imply
            broad lifecycle reset unless lifecycle reset conditions are explicitly present.
    - id: 'S5'
      description: |
        Add cryptographic startup self-heal for canonical-cutover stale legacy checkpoint metadata:
          - If startup sees `checkpoint_rowid > legacy_chain_tip_rowid` while legacy tip is empty
            and canonical `events` contains rows, invalidate only hash-chain checkpoint metadata.
          - Re-run startup validation from legacy genesis with signature + hash-chain verification
            before reseeding a new signed checkpoint.
          - Preserve fail-closed behavior when canonical evidence is absent (no blind checkpoint
            acceptance and no destructive ledger reset).
  out_of_scope:
    - 'Changing startup reconcile semantics or AJC exemption boundaries for full lane+queue reconcile.'
    - 'Adding new FAC remediation commands (doctor remains the host remediation surface).'
    - 'Reintroducing or depending on `apm2 fac recover`, `apm2 fac review run`, `apm2 fac restart`, or `apm2 fac review restart` for runtime claimed self-heal convergence.'
    - 'Full ledger-backed queue migration (tracked separately in TCK-00669).'

plan:
  steps:
    - id: 'P0'
      description: 'Define runtime reconcile controller contract and state machine mapping (from ticket design to code types).'
    - id: 'P1'
      description: 'Extract and expose claimed-only runtime reconcile entrypoint in apm2-core with bounded config.'
    - id: 'P2'
      description: 'Add worker repair-request signaling and scan-lock-gated reconcile execution.'
    - id: 'P3'
      description: 'Implement event-driven worker wake path for queue pickup + repair triggers.'
    - id: 'P4'
      description: 'Add deterministic unit/integration tests for trigger, safety, and boundedness behavior.'
    - id: 'P5'
      description: 'Move degraded safety-nudge interval to internal bounded worker runtime semantics and update service defaults/docs accordingly.'


definition_of_done:
  criteria:
    - 'Runtime repair controller architecture (signals, coordinator, reconcile boundary) is implemented per ticket high-level design.'
    - 'Runtime state machine states/transitions are explicit and test-covered (not implicit control flow).'
    - 'Worker self-heals stuck/torn claimed jobs during runtime without requiring restart.'
    - 'No periodic reconcile sweep timer is required for default behavior; repair is signal-driven.'
    - 'Worker queue pickup no longer depends on fixed 5-10s scan cadence in steady state; queue events trigger immediate activation.'
    - 'Runtime reconcile never mutates lane state and preserves flock/token safety invariants.'
    - 'Deterministic simulated tests cover wake latency, commit-failure-triggered repair, flock-held claimed-file preservation, watch degradation diagnostics, and reconcile single-flight/coalescing.'
    - 'Repeated `apm2 fac doctor --fix` and `apm2 fac doctor --pr <N> --fix` runs are idempotent after first convergence.'
    - 'PR-scoped doctor fix strategy remains bounded: follow-up repair is single-flight per fix pass, and identity refresh is only requested for stale/missing identity signals.'
    - 'PR-scoped doctor fix executes bounded follow-up repair even when direct lifecycle/registry/run-state plan operations are empty, if doctor still recommends fix.'
    - 'PR-scoped doctor never emits merge/approve when terminal-approved projection lacks authoritative remote comment binding; it emits fix and runs bounded follow-up repair first.'
    - 'Run-state-only repair does not trigger implicit lifecycle reset; lifecycle reset remains explicit/deterministic.'
    - 'Startup hash-chain validation includes canonical-cutover stale-checkpoint self-heal that only clears checkpoint metadata, re-verifies chain cryptographically, and remains fail-closed without canonical evidence.'
    - 'Blocked or ambiguous repair states are surfaced explicitly with doctor-first remediation guidance (`apm2 fac doctor --fix`, and `apm2 fac doctor --pr <N> --fix` when PR-scoped).'
    - 'No runbook/help/ticket guidance for this flow requires `apm2 fac recover`, `apm2 fac review run`, `apm2 fac restart`, or `apm2 fac review restart`.'
  evidence_ids:
    - 'EVID-TCK-00660-01 (integration): commit-failure signal triggers runtime claimed repair without restart'
    - 'EVID-TCK-00660-02 (integration): torn state repaired to terminal directory via runtime queue reconcile'
    - 'EVID-TCK-00660-03 (safety): flock-held claimed file is skipped and not moved'
    - 'EVID-TCK-00660-04 (resilience): watch unavailable path still repairs via internal trigger'
    - 'EVID-TCK-00660-05 (coalescing): burst repair signals execute bounded single-flight reconciles'
    - 'EVID-TCK-00660-06 (idempotency): repeated `apm2 fac doctor --fix` converges with no repeated destructive remediation'
    - 'EVID-TCK-00660-07 (idempotency): repeated `apm2 fac doctor --pr <N> --fix` converges with no repeated lifecycle/registry churn'
    - 'EVID-TCK-00660-08 (startup-integrity): canonical-cutover stale checkpoint metadata self-heals by metadata invalidation + cryptographic revalidation; fail-closed path still rejects ahead-of-tip checkpoints without canonical evidence'

notes:
  design_note: |
    This ticket intentionally avoids introducing another periodic maintenance poller.
    Repair is triggered by durable runtime signals and can be woken by filesystem events
    when available. Host-level broad remediation remains centralized in `apm2 fac doctor --fix`.

acceptance_criteria:
  - criterion: EpisodeRuntime with create/start/stop/signal methods
    verification: Unit tests verify all methods
  - criterion: State machine CREATED -> RUNNING -> (TERMINATED | QUARANTINED)
    verification: State transition tests cover all paths
  - criterion: Event emission for all state transitions
    verification: Integration test verifies event emission
implementation:
  code_examples:
    - description: EpisodeRuntime structure
      code: |
        pub struct EpisodeRuntime {
            ledger: Arc<Ledger>,
            cas: Arc<ContentAddressedStore>,
            policy: Arc<PolicyEngine>,
            adapters: AdapterRegistry,
            episodes: DashMap<EpisodeId, EpisodeState>,
        }

        impl EpisodeRuntime {
            pub async fn create(&self, envelope: EpisodeEnvelope) -> Result<EpisodeId>;
            pub async fn start(&self, id: EpisodeId) -> Result<SessionHandle>;
            pub async fn stop(&self, id: EpisodeId, reason: StopReason) -> Result<()>;
            pub async fn signal(&self, id: EpisodeId, sig: Signal) -> Result<()>;
            pub async fn observe(&self, id: EpisodeId) -> Result<EpisodeState>;
        }
  files_to_create:
    - path: crates/apm2-daemon/src/episode/runtime.rs
      purpose: EpisodeRuntime implementation
    - path: crates/apm2-daemon/src/episode/state.rs
      purpose: Episode state machine
    - path: crates/apm2-daemon/src/episode/handle.rs
      purpose: SessionHandle for running episodes
    - path: crates/apm2-daemon/src/episode/error.rs
      purpose: Episode error types
  files_to_modify:
    - changes: Export runtime, state, handle modules
      path: crates/apm2-daemon/src/episode/mod.rs
  implementation_steps:
    - step: 1
      action: Define EpisodeState enum
      details: |
        Create state machine per AD-EPISODE-002:
        - CREATED: Envelope accepted, resources not allocated
        - RUNNING: Harness spawned, I/O streaming
        - TERMINATED: Normal completion, evidence finalized
        - QUARANTINED: Abnormal termination, evidence pinned
    - step: 2
      action: Implement state transitions
      details: |
        Create transition methods with invariants:
        - create(): -> CREATED
        - start(): CREATED -> RUNNING (requires valid lease)
        - stop(): RUNNING -> TERMINATED
        - quarantine(): RUNNING -> QUARANTINED
        - No transitions from terminal states
    - step: 3
      action: Implement EpisodeRuntime
      details: |
        Create runtime struct with:
        - DashMap for concurrent episode tracking
        - Ledger/CAS/Policy references
        - AdapterRegistry for harness lookup
        - Methods: create, start, stop, signal, observe
    - step: 4
      action: Implement event emission
      details: |
        Emit events for all transitions:
        - episode.created (envelope_hash)
        - episode.started (session_pid, io_stream_id)
        - episode.stopped (termination_class)
        - episode.quarantined (reason, evidence_refs)
    - step: 5
      action: Create SessionHandle
      details: |
        Create handle for running episode:
        - episode_id, session_id
        - I/O stream handles
        - Stop condition checker
        - Budget tracker reference
  summary: |
    Implement EpisodeRuntime with state machine per AD-EPISODE-002.
    Manages episode lifecycle (create/start/stop/signal) with event emission
    for all state transitions. States: CREATED -> RUNNING -> TERMINATED | QUARANTINED.
notes: |
  Phase: PHASE-1B (Episode Envelope and Lifecycle)
  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.
  Maps to TCK-PEND-004.
schema_version: "2026-01-27"
template_version: "2026-01-27"
test_requirements:
  - description: State transition coverage
    test_id: UT-00160-01
    verification_command: cargo test -p apm2-daemon episode_state
  - description: Event emission
    test_id: IT-00160-01
    verification_command: cargo test -p apm2-daemon --test integration episode_events
  - description: Invalid transition rejection
    test_id: UT-00160-02
    verification_command: cargo test -p apm2-daemon invalid_transition
ticket:
  depends_on:
    - TCK-00159
  id: TCK-00160
  requirement_ids:
    - REQ-EPISODE-001
    - REQ-DAEMON-001
  rfc_id: RFC-0013
  status: READY
  title: Implement EpisodeRuntime with state machine

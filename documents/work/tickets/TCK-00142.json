{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00142",
      "title": "Implement export conformance tests",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0007",
      "rfc_id": "RFC-0011",
      "requirements": [
        {
          "requirement_id": "CAC-REQ-0013",
          "requirement_ref": "documents/prds/PRD-0007/requirements/REQ-0013.yaml#prd_requirement"
        }
      ],
      "evidence_artifacts": [
        "EVID-0009"
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_KERNEL",
        "DOMAIN_TESTING"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00141"
      ]
    },
    "scope": {
      "in_scope": [
        "Implement ConformanceTest struct for verifying export determinism",
        "Implement determinism verification (re-export comparison)",
        "Implement provenance verification (frontmatter parsing and validation)",
        "Implement schema validation of exported outputs",
        "Generate ExportReceipt with conformance test results",
        "Create golden test vectors for known export scenarios"
      ],
      "out_of_scope": [
        "CLI integration (TCK-00143)",
        "Remote export verification",
        "Performance benchmarking"
      ]
    },
    "plan": {
      "steps": [
        "Create crates/apm2-core/src/cac/conformance.rs module",
        "Define ConformanceTest struct with test_id, expected_hash, pack_ref",
        "Define ExportReceipt struct with passed/failed tests, timestamps",
        "Implement verify_determinism() exporting twice and comparing bytes",
        "Implement verify_provenance() parsing frontmatter and validating fields",
        "Implement verify_schema() validating output against expected schemas",
        "Implement run_conformance_suite() running all tests for an export",
        "Create test fixtures with known packs and expected outputs",
        "Write property tests for conformance invariants",
        "Add documentation with conformance test authoring guide"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-0009"
      ],
      "criteria": [
        "ConformanceTest::run() returns Result<ConformanceResult, ConformanceError>",
        "Determinism verification detects any byte differences",
        "Provenance verification validates all required frontmatter fields",
        "ExportReceipt includes pass/fail for each conformance check",
        "Golden test vectors cover: empty pack, single artifact, nested dependencies",
        "All tests pass: cargo test conformance"
      ]
    },
    "notes": {
      "security": "Conformance testing provides verifiable evidence of export correctness.\nExportReceipt can be used for audit trails and cutover gating.\n",
      "architecture": "DD-0005: Export determinism is verifiable via conformance tests.\n\nConformance test structure:\n1. Determinism: export(pack) twice, compare byte-for-byte\n2. Provenance: parse frontmatter, verify required fields present\n3. Schema: validate output structure against expected schema\n4. Completeness: verify all pack artifacts are represented in output\n\nExportReceipt schema:\n```yaml\nexport_receipt:\n  pack_hash: \"sha256:...\"\n  profile_id: \"claude-code-v1\"\n  conformance_tests:\n    - test_id: \"determinism\"\n      passed: true\n    - test_id: \"provenance\"\n      passed: true\n    - test_id: \"schema\"\n      passed: true\n  overall_passed: true\n  timestamp: \"2026-01-27T12:00:00Z\"\n```\n",
      "rust_textbook_refs": [
        {
          "file": ".claude/skills/rust-textbook/17_testing_fuzz_miri_evidence.md",
          "rules": [
            "CTR-1701: Verification Plan Is Mandatory for Risk Anchors",
            "INV-1701: Tests Encode Invariants, Not Only Examples",
            "INV-1702: Zero-Cost Verification via Compile-Time Assertions"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/16_io_protocol_boundaries.md",
          "rules": [
            "CTR-1602: Serialization Formats Must Be Versioned (golden vectors)"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/07_errors_panics_diagnostics.md",
          "rules": [
            "CTR-0703: Error Types Must Be Structured When Callers Branch on Cause"
          ]
        }
      ],
      "codebase_context": {
        "files_to_reference": [
          {
            "path": "crates/apm2-core/src/determinism/mod.rs",
            "purpose": "Pattern for determinism testing (test_canonicalization_determinism)"
          },
          {
            "path": "crates/apm2-core/src/determinism/canonicalize.rs",
            "purpose": "Property test patterns for idempotence verification"
          },
          {
            "path": "xtask/src/aat/executor.rs",
            "purpose": "Pattern for test execution with result capture"
          },
          {
            "path": "crates/apm2-core/src/evidence/receipt.rs",
            "purpose": "Pattern for GateReceipt with signature verification"
          }
        ],
        "files_to_create": [
          {
            "path": "crates/apm2-core/src/cac/conformance.rs",
            "purpose": "Conformance test implementation"
          },
          {
            "path": "crates/apm2-core/src/cac/fixtures/",
            "purpose": "Test fixtures directory for golden vectors"
          }
        ],
        "files_to_modify": [
          {
            "path": "crates/apm2-core/src/cac/mod.rs",
            "purpose": "Export conformance module"
          }
        ]
      }
    }
  }
}

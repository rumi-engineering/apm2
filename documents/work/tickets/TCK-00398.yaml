ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00398"
    title: "Unify ledger write and read schemas (ledger_events vs events table split)"
    status: "OPEN"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0018"
    requirements:
      - requirement_id: "REQ-HEF-0010"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0010.yaml#rfc_requirement"
    evidence_artifacts:
      - evidence_id: "EVID-HEF-0012"
        artifact_ref: "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0012.yaml#rfc_evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
      - "DOMAIN_ORCHESTRATION"
  dependencies:
    tickets: []
  scope:
    in_scope:
      - "Audit the daemon's ledger write path (crates/apm2-daemon/src/ledger.rs) which writes to the ledger_events table."
      - "Audit the core library's ledger read path (crates/apm2-core/src/ledger/schema.sql) which reads from the events table."
      - "Deliver a Phase 1 compatibility bridge so apm2-core/CLI can read daemon-written ledger_events data immediately."
      - "Define and stage a Phase 2 canonical schema unification plan without a risky big-bang table rename."
      - "Ensure apm2 fac work status, apm2 fac episode inspect, and apm2 fac resume all find events written by the daemon."
      - "Add an idempotent migration/read-compat path for existing ledger.db files."
    out_of_scope:
      - "Consensus-related columns (epoch, validator_signature) — include column definitions but leave nullable."
      - "Event hash chain verification (prev_hash linking) — schema supports it but daemon can write NULL for now."
      - "Replication or multi-writer scenarios."
      - "One-shot replacement of all daemon ledger_events SQL call-sites in this ticket."
  plan:
    steps:
      - "Read crates/apm2-daemon/src/ledger.rs lines 49-71 to document the current daemon schema (ledger_events table: event_id TEXT PK, event_type, work_id, actor_id, payload, signature, timestamp_ns)."
      - "Read crates/apm2-core/src/ledger/schema.sql lines 11-67 to document the core schema (events table: seq_id INTEGER PK AUTOINCREMENT, event_type, session_id, actor_id, record_version, payload, timestamp_ns, prev_hash, event_hash, signature, plus consensus columns)."
      - "Implement Phase 1 compatibility in apm2-core ledger read path: if canonical events rows are unavailable but daemon ledger_events rows exist, map ledger_events rows into EventRecord-compatible reads (read-only bridge)."
      - "Update crates/apm2-cli/src/commands/fac.rs query paths (extract_work_info at ~639) to prefer explicit row/work_id metadata when available and keep payload-based fallback for compatibility."
      - "Add idempotent migration scaffolding: if/when events table is introduced, preserve ledger_events and maintain compatibility during transition."
      - "Document Phase 2 unification design (target canonical schema + cutover/rollback strategy) before changing all daemon SQL call-sites."
      - "Test: start daemon, claim work, spawn episode, emit event, then run apm2 fac work status — must find the events."
      - "Run cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings && cargo doc --workspace --no-deps && cargo test -p apm2-daemon -p apm2-core -p apm2-cli."
  definition_of_done:
    evidence_ids:
      - "EVID-HEF-0012"
    criteria:
      - "CLI/core ledger reads can see daemon-written events from existing ledger.db files without requiring a full daemon table rename."
      - "apm2 fac work status <work_id> returns events written by the daemon for that work_id."
      - "apm2 fac episode inspect <episode_id> finds episode events written by the daemon."
      - "Compatibility path is idempotent and does not break current TCK-00340/PR-450 ledger_events query paths."
      - "Existing daemon ledger tests pass with the compatibility bridge in place."
      - "Core library ledger tests pass with the compatibility bridge in place."
      - "Schema/read migration handles pre-existing ledger.db files with the old ledger_events table."
      - "Phase 2 canonical unification plan is written and linked from the ticket notes or implementation docs."
      - "All CI checks pass: cargo fmt, clippy (zero warnings), doc, tests."
  notes:
    context: |
      AAT evidence (H9: NEEDS_ADJUDICATION) discovered that the daemon successfully persists events
      (WorkClaimed, WorkTransitioned, SessionStarted, SessionEvent) but apm2 fac work status returns
      "No events found." Root cause: the daemon writes to a table called ledger_events while the CLI
      reads from a table called events. The schemas are also structurally different.

      Daemon write schema (ledger.rs:49-71):
        ledger_events(event_id TEXT PK, event_type TEXT, work_id TEXT, actor_id TEXT,
                      payload BLOB, signature BLOB, timestamp_ns INTEGER)

      Core read schema (schema.sql:11-67):
        events(seq_id INTEGER PK AUTOINCREMENT, event_type TEXT, session_id TEXT, actor_id TEXT,
               record_version INTEGER, payload BLOB, timestamp_ns INTEGER, prev_hash BLOB,
               event_hash BLOB, signature BLOB, ...)

      These tables have different names, different primary keys, different columns (work_id vs session_id),
      and different ordering semantics (text PK vs autoincrement). They will never see each other's data.

      IMPORTANT with recent TCK-00340 hardening (PR #450 patch series): daemon code now has additional
      ledger_events-dependent query paths for lease/work validation. A big-bang table migration would be
      high-risk. This ticket therefore uses a phased approach: compatibility-first to restore CLI visibility,
      then canonical unification with an explicit cutover plan.

      Additionally, the daemon's emit_episode_event() uses episode_id as the work_id column value,
      while the CLI's extract_work_info() looks for work_id inside the JSON payload. This is a
      secondary mismatch even if the table names were aligned.
    files: |
      - crates/apm2-daemon/src/ledger.rs (write path, CREATE TABLE ledger_events at lines 49-71, all INSERT methods)
      - crates/apm2-core/src/ledger/schema.sql (read schema, events table at lines 11-67)
      - crates/apm2-core/src/ledger/mod.rs (Ledger::open, query methods)
      - crates/apm2-cli/src/commands/fac.rs (extract_work_info at ~639, work_status query at ~453-460)
    security: |
      - Schema migration must be idempotent (safe to run multiple times).
      - Signature and event_hash columns must be preserved — they provide tamper evidence.
      - Do not drop the ledger_events table during migration — rename or keep as backup.
      - Column types must match exactly between write and read paths to prevent silent truncation.

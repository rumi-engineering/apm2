{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00613",
      "title": "FAC gates architecture alignment + security hardening (throughput-profile model)",
      "status": "MERGED",
      "merge_evidence": [
        {
          "pr": 708,
          "merge_commit": "4002520be210a75b9bf85c4b0ccde969744db507",
          "merged_at": "2026-02-17T02:32:41Z"
        },
        {
          "pr": 709,
          "merge_commit": "dad68b183f24301a52b67b7796bf632460fbe43c",
          "merged_at": "2026-02-17T02:44:34Z"
        },
        {
          "pr": 710,
          "merge_commit": "cba6a9455450b892200ab6a4685157687ffddca2",
          "merged_at": "2026-02-17T03:24:30Z"
        }
      ]
    },
    "binds": {
      "prd_id": "PRD-PLACEHOLDER",
      "rfc_id": "RFC-0019",
      "requirements": [],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_SECURITY",
        "DOMAIN_DOCUMENTATION"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00612",
          "reason": "Defines the throughput-profile model (`throughput`/`balanced`/`conservative`) and host-aware parallelism contract used by fac gates."
        },
        {
          "ticket_id": "TCK-00605",
          "reason": "Defines bounded test execution constraints and containment policy used by FAC gates."
        },
        {
          "ticket_id": "TCK-00563",
          "reason": "Canonicalizer tuple pinning and receipt integrity remain required invariants in worker/broker admission flows."
        }
      ]
    },
    "root_cause_analysis": {
      "summary": "The prior revision of this ticket mixed two incompatible directions:\n- A new trait/registry gate engine with gate-set `--profile`.\n- The already-adopted command-centric FAC gates runtime with throughput\n  profiles and typed gate checks.\n\nIn parallel, PR review surfaced concrete security and correctness gaps:\n- Signing key TOCTOU and duplicated key-handling paths.\n- Unbounded file reads in gates/preflight paths.\n- Worker workspace-root trust boundary ambiguity.\n- Process-global CWD mutation in worker execution path.\n- workflow_dispatch authorization trust override via env var.\n- test_safety_guard misses on top-level `src/*.rs` and unbounded traversal.\n\nThis ticket update formalizes the architecture actually in use and binds\nDoD to hardened, fail-closed behavior across FAC gates and preflight.\n"
    },
    "scope": {
      "in_scope": [
        "Architecture contract: command-centric gates execution remains authoritative (`fac_review/gates.rs` orchestration + typed checks in `fac_review/gate_checks.rs`).",
        "Gate selection semantics: keep `--quick` as gate-set selector (fast subset) and full mode as default behavior.",
        "Throughput semantics: keep `--gate-profile` (`throughput`/`balanced`/`conservative`) for resource/concurrency policy, independent of gate-set selection.",
        "Introduce shared hardened signer-key utility (`fac_key_material`) and remove duplicated key creation/loading logic across queue submit, worker, and broker paths.",
        "Introduce shared fail-closed bounded-read utility (`fac_secure_io`) and replace raw unbounded reads in FAC review gate checks, FAC preflight, FAC broker, queue submit, and worker-adjacent read sites.",
        "Enforce fail-closed handling for oversized/unreadable inputs in security-sensitive paths (no skip-on-error behavior for authorization/gate enforcement inputs).",
        "Remove process-global CWD mutation from worker execution path; pass explicit workspace root through the gates call chain.",
        "Define and enforce workspace-root admission policy in worker gates execution: canonical dir, git toplevel equality, repo identity binding, and explicit deny for FAC-internal roots.",
        "Strengthen preflight trust binding: no env override for actor permission, validated repository/actor normalization, bounded event/policy/PR JSON parsing, and explicit deny on permission lookup failure.",
        "Harden test_safety_guard determinism and coverage: tracked-file-first targeting, top-level `src/lib.rs` and `src/main.rs` coverage under `#[cfg(test)]`, and bounded fail-closed file reads.",
        "Add regression tests for key creation race, workflow_dispatch permission checks, oversized payload denial, workspace-root policy denial, and top-level Rust test-safety detection."
      ],
      "out_of_scope": [
        "Mandating a `gates_engine/` trait/registry abstraction (`Gate`, `GateRegistry`, `GateRunner`) in this ticket.",
        "Replacing current gate-set semantics with a new `--profile <gate-set>` CLI contract in this ticket.",
        "Repository-wide deletion of all shell scripts outside the FAC gates/preflight hardening scope.",
        "Backward-compatibility shims for superseded ticket language.",
        "Global scheduler redesign or distributed queue architecture changes."
      ]
    },
    "plan": {
      "steps": [
        {
          "id": "STEP_01",
          "title": "Codify architecture and CLI contract",
          "detail": "Lock the canonical model for this ticket:\n- `fac_review/gates.rs` orchestrates execution.\n- `--quick` controls gate-set shape.\n- `--gate-profile` controls throughput/resource policy only.\n"
        },
        {
          "id": "STEP_02",
          "title": "Centralize hardened key material handling",
          "detail": "Add shared signer utility for secure create/load semantics:\n- create with owner-only mode at open time\n- nofollow safeguards\n- fsync of file and parent dir\n- race-safe concurrent creator convergence\nReplace all duplicate key handling in queue submit/worker/broker.\n"
        },
        {
          "id": "STEP_03",
          "title": "Centralize bounded fail-closed file reads",
          "detail": "Add shared bounded I/O helper and migrate targeted paths off raw\n`fs::read` / `fs::read_to_string` for security-sensitive inputs.\n"
        },
        {
          "id": "STEP_04",
          "title": "Harden worker execution boundary",
          "detail": "Remove ambient CWD dependency and enforce explicit workspace-root\nadmission checks (canonicalize + git root + repo bind + FAC-internal\ndeny rules).\n"
        },
        {
          "id": "STEP_05",
          "title": "Harden preflight trust binding",
          "detail": "Remove env-based actor-permission override from authorization path,\nenforce repository/actor normalization, and deny on oversized/invalid\npreflight payloads or permission lookup failures.\n"
        },
        {
          "id": "STEP_06",
          "title": "Fix gate correctness regressions",
          "detail": "Ensure test_safety_guard covers top-level `src/*.rs` test regions and\nuses bounded deterministic file targeting/read behavior.\n"
        },
        {
          "id": "STEP_07",
          "title": "Regression suite and verification",
          "detail": "Run targeted security/correctness regressions and strict quality gates:\n- `cargo fmt --all`\n- `cargo clippy -p apm2-cli --all-targets --all-features -- -D warnings`\n- `cargo test -p apm2-cli`\n"
        }
      ]
    },
    "definition_of_done": {
      "evidence_ids": [],
      "criteria": [
        "Ticket language is internally consistent with implemented architecture: command-centric gates orchestration + throughput profiles.",
        "Signer key lifecycle is centralized; queue submit, worker, and broker use shared hardened key material helpers.",
        "No production path creates signing keys via write-then-chmod TOCTOU sequence.",
        "Bounded read helper is shared and used across targeted FAC gates/preflight/broker/queue paths; oversized inputs are denied fail-closed.",
        "Worker gates execution path does not mutate process-global CWD.",
        "Worker workspace_root admission denies FAC-internal roots and repo-identity mismatches; git toplevel binding is enforced.",
        "workflow_dispatch authorization does not trust env permission overrides and denies on lookup failure or insufficient permission.",
        "Preflight event/policy payload reads are bounded and oversized payloads fail closed.",
        "test_safety_guard evaluates top-level `src/lib.rs` and `src/main.rs` test regions and fails closed on oversized targets.",
        "Regression tests exist for signer concurrency, workflow_dispatch permission checks, oversized payload denial, and workspace-root policy denial.",
        "`cargo fmt --all` passes.",
        "`cargo clippy -p apm2-cli --all-targets --all-features -- -D warnings` passes.",
        "`cargo test -p apm2-cli` passes."
      ]
    },
    "notes": {
      "context": "This amendment aligns TCK-00613 with the architecture currently used by\nFAC gates in this repository branch:\n- command-centric orchestration in `fac_review/gates.rs`\n- typed gate checks and evidence checks under `fac_review/*`\n- throughput profile model from TCK-00612\n\nIt intentionally removes conflicting requirements that assumed this ticket\nwas also the migration vehicle for a trait/registry gate engine and\ngate-set profile CLI redesign.\n",
      "amendments": [
        {
          "amendment_id": "AMD-2026-02-17-ARCH-REALIGNMENT",
          "summary": "Replace conflicting gate-engine/profile requirements with branch-aligned architecture and hardening scope.",
          "supersedes": [
            "Requirement that TCK-00613 must introduce `gates_engine/` with `Gate` trait, `GateRegistry`, and `GateRunner`.",
            "Requirement that TCK-00613 must replace `--quick` with gate-set `--profile` semantics.",
            "Requirement that TCK-00613 must be the single vehicle for repository-wide script eradication."
          ],
          "replacement": [
            "TCK-00613 defines and hardens the existing command-centric FAC gates model with explicit fail-closed security guarantees.",
            "Gate-set profile CLI redesign and trait/registry abstraction, if still desired, are follow-on architecture work and not blockers for this ticket."
          ]
        }
      ],
      "security": "default-deny, least privilege, fail-closed"
    }
  }
}

ticket_meta:
  schema_version: '2026-01-29'
  template_version: '2026-01-29'
  ticket:
    id: 'TCK-00659'
    title: 'FAC: Prevent orphaned systemd-run work after worker crash (bind units + lane reclaim guard)'
    status: 'MERGED'
  binds:
    prd_id: 'PRD-0001'
    rfc_id: 'RFC-0019'
    requirements:
      - 'REQ-0008' # atomic/idempotent leases
      - 'REQ-0020' # reconcile correctness
    evidence_artifacts: []
  custody:
    agent_roles:
      - 'Implementer'
      - 'Reviewer'
    responsibility_domains:
      - 'fac/execution-backend'
      - 'fac/worker'
      - 'fac/lane-lease'
  dependencies:
    tickets:
      - 'TCK-00658' # process identity binding (defense-in-depth)
      - 'TCK-00622' # reconcile baseline

context:
  observed_symptoms:
    - 'Worker crashes/restarts can leave behind running systemd transient units (warm phases, gate execution), while the lane lock is released.'
    - 'Subsequent workers may reclaim the lane (pid dead) and start a new job, risking concurrent execution in the same lane resources.'
    - 'Operators observe "dead PID" leases but still see systemd units consuming CPU/memory.'
  code_evidence:
    - |
      Baseline control already present on main: worker unit name detection from /proc/self/cgroup:
        crates/apm2-core/src/fac/systemd_unit.rs
    - |
      Baseline control already present on main: systemd-run includes PartOf/BindsTo parent binding:
        crates/apm2-core/src/fac/execution_backend.rs
    - |
      Baseline control already present on main: stale-lease reclaim consults FAC unit liveness fail-closed:
        crates/apm2-cli/src/commands/fac_worker.rs
    - |
      Remaining gap addressed by this ticket revision: host-side remediation was still fragmented
      and tmp scrub used nested per-directory limits that could amplify resource use:
        crates/apm2-cli/src/commands/fac.rs

problem_statement: |
  Core orphan-prevention controls (unit binding + reclaim guard) now exist in baseline code, but
  host recovery remained operationally fragmented across legacy commands and `apm2 fac doctor --fix`
  still had boundedness gaps in tmp scrub. This caused confusing remediation workflows and exposed a
  denial-of-service risk from nested tmp directory fan-out.

root_cause_analysis:
  primary_cause: |
    Recovery entrypoints diverged over time (doctor + legacy reconcile/reset paths), and the tmp
    scrub implementation applied a fresh large nested-directory budget per entry instead of one
    bounded traversal for the tmp tree.
  contributing_factors:
    - 'Ticket scope evolved after baseline S1-S3 landed, but the in-scope list was not narrowed.'
    - 'Operator runbooks and recommendations still referenced removed legacy commands.'

proposed_change:
  intent: |
    Make it impossible (or at least extremely unlikely) for systemd-run work to outlive the worker
    without the system noticing. Implement defense-in-depth:
      1) Bind transient units to the parent worker systemd unit (PartOf/BindsTo).
      2) Add a lane reclaim guard: before clearing a stale lease (pid dead), check if any job units
         associated with that lease are still active; if yes, fail-closed and surface remediation.
      3) Consolidate host-side repair into `apm2 fac doctor --fix` (no new command surface): run
         deterministic reconcile + targeted lane recovery/remediation when trigger conditions match.

invariants:
  - id: 'INV-SD-BIND-001'
    statement: 'All systemd transient units spawned for FAC execution MUST be bound to the worker unit when running under systemd.'
  - id: 'INV-SD-BIND-002'
    statement: 'Lane reclaim MUST NOT clear a lease solely because the recorded PID is dead if systemd indicates associated units are still active.'

scope:
  in_scope:
    - id: 'S4'
      description: |
        Documentation + operator UX:
          - fac doctor / services status should surface "orphaned systemd unit" clearly and suggest
            remediation (stop_revoke, `apm2 fac doctor --fix`).
          - Add an explicit log line when reclaim is blocked due to active units.
    - id: 'S5'
      description: |
        Doctor fix consolidation (no new commands):
          - `apm2 fac doctor --fix` without `--pr` becomes a system reconciler that:
              * runs lane reconcile and queue reconcile apply paths,
              * detects tmp-corruption triggers and performs bounded tmp scrub,
              * performs stale lane-log GC under bounded retention policy,
              * attempts bounded lane recovery (including lane reset retry) for
                trigger-matched CORRUPT lanes,
              * fails closed when orphaned units are still active/unknown,
              * re-runs doctor checks and emits structured action outcomes.
          - Keep `apm2 fac doctor --pr <N> --fix` semantics unchanged.
          - Remove legacy crash-recovery command entrypoints (`fac reconcile`, `fac lane reset`,
            `fac lane reconcile`) so doctor is the sole remediation surface.
    - id: 'S6'
      description: |
        Tmp scrub hardening:
          - Replace per-entry nested tmp deletion with one bounded traversal of the tmp tree.
          - Enforce a single fail-closed bound for tmp scrub traversal to prevent nested
            limit amplification and resource exhaustion.
          - Recreate tmp directory after scrub so lane structure remains valid.
  out_of_scope:
    - 'Re-implementing S1/S2/S3 controls (already present in baseline code on main).'
    - 'Replacing file locks with systemd unit-name locks (larger redesign).'
    - 'Full D-Bus integration (CLI-based systemctl calls are acceptable for now).'
    - 'Adding a new FAC remediation command family; doctor is the consolidation surface.'

plan:
  steps:
    - id: 'P4'
      description: 'Update fac doctor/status output to expose orphaned units (actionable output).'
    - id: 'P5'
      description: 'Implement no-PR `apm2 fac doctor --fix` reconciliation flow (reconcile + tmp detection/scrub + stale log GC + trigger-based lane reset + post-check).'
    - id: 'P6'
      description: 'Harden tmp scrub with one bounded traversal and deterministic fail-closed errors.'


definition_of_done:
  criteria:
    - 'Scope S4 docs/UX updates are complete and only doctor is advertised for host remediation.'
    - 'Operator-facing tooling surfaces orphaned-unit situations and points to remediation.'
    - '`apm2 fac doctor --fix` (without `--pr`) performs bounded reconciliation/remediation and emits structured action/check output.'
    - 'Tmp scrub is bounded by a single traversal limit and fails closed on oversized trees.'
  evidence_ids:
    - 'EVID-TCK-00659-04 (unit): doctor --fix action schema and exit-code behavior tests'
    - 'EVID-TCK-00659-05 (unit): tmp scrub bounded traversal + fail-closed oversized-tree behavior'
    - 'EVID-TCK-00659-06 (docs): runbooks/skills/reference text migrated to `apm2 fac doctor --fix`'

test_plan:
  unit_tests:
    - 'apm2-cli fac doctor: structured action serialization and blocked-action exit-code tests'
    - 'apm2-cli tmp scrub: nested entries are removed and tmp root is recreated'
    - 'apm2-cli tmp scrub: oversized nested tree returns deterministic entry-bound error'
  integration_tests:
    - |
      Validate no-PR `apm2 fac doctor --fix` reconciliation flow in a seeded lane/queue fixture:
        - trigger-matched CORRUPT lane remediation path executes in bounded order
        - post-fix doctor rerun emits structured action outcomes and fail-closed status on blockers

notes:
  risk:
    - 'Bounded tmp scrub may refuse extremely large transient trees; this is intentional fail-closed behavior.'
    - 'Doctor-only remediation increases dependency on doctor correctness; tests must cover action ordering and exit semantics.'
  safety: |
    This is safety-critical: recovery must remain deterministic and fail-closed. Oversized or ambiguous
    tmp state must not trigger unbounded cleanup work, and blocked remediation actions must produce
    non-zero exit to prevent false-success automation.

ticket_meta:
  schema_version: '2026-01-29'
  template_version: '2026-01-29'
  ticket:
    id: TCK-00654
    title: 'RFC-0032: FAC doctor `--wait` pulse subscription integration (replace polling loop with daemon pulse-driven reevaluation)'
    status: OPEN
  binds:
    prd_id: PRD-PLACEHOLDER
    rfc_id: RFC-0032
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles:
    - AGENT_IMPLEMENTER
    responsibility_domains:
    - DOMAIN_CLI
    - DOMAIN_PROTOCOL
    - DOMAIN_OBSERVABILITY
  dependencies:
    tickets:
    - ticket_id: TCK-00653
      reason: Requires pulse publisher correctness
    - ticket_id: TCK-00644
      reason: Doctor outputs must update on relevant events
  context:
    observed_state:
    - "PR-scoped FAC doctor wait currently runs a poll/sleep loop and periodically re-evaluates instead of waiting on daemon pulse subscriptions."
    - "CLI client surface has no operator pulse subscribe/wait API usage wired into doctor wait paths."
    - "`TCK-00653` hardened daemon-side pulse routing for bridge payloads and typed/dotted event-name parity without changing the CLI wire protocol; `--wait` integration should target existing subscribe/wait semantics."
    code_evidence:
    - 'crates/apm2-cli/src/commands/fac_review/mod.rs:1426-1481 uses `DOCTOR_WAIT_POLL_INTERVAL_SECONDS` with `thread::sleep`.'
    - 'No `SubscribePulse` / `WaitForPulse` call path exists under `crates/apm2-cli/src/client`.'
  scope:
    in_scope:
    - Add operator client support for pulse subscribe/wait (`SubscribePulse` plus bounded wait primitive) in CLI protocol client.
    - Update `apm2 fac doctor --pr <N> --wait-for-recommended-action` to subscribe to relevant work/review topics and re-run doctor on pulse arrival.
    - Demote polling to bounded degraded fallback only when pulse subscription is unavailable.
    out_of_scope:
    - Designing new UI/TTY interactions beyond basic wait semantics
  plan:
    steps:
    - 'Audit existing runtime proto: keep `SubscribePulse`; add/implement a bounded client wait primitive for pulse events.'
    - 'Implement CLI subscription lifecycle: subscribe, await pulses, handle reconnect/backoff, and clean unsubscribe on exit.'
    - 'Integrate with doctor evaluation loop: on pulse, re-run doctor and emit structured status.'
    - 'Add deterministic tests: simulated pulse triggers doctor reevaluation; polling path used only in degraded fallback.'
  definition_of_done:
    evidence_ids: []
    criteria:
    - '`--wait` uses pulses as the primary mechanism and does not rely on periodic polling when pulse delivery is healthy.'
    - CLI subscription code handles disconnect/reconnect without duplicating work or leaking subscribers.

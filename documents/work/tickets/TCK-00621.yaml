ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00621"
    title: "Implement two-phase gates contract: PREP (healing) then EXECUTE (isolated, deterministic)"
    status: "CLOSED"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: ["REQ-0032", "REQ-0036", "REQ-0040", "REQ-0041"]
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME", "DOMAIN_CI"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00620"
        reason: "ReadinessController (the PREP healing step) must land first."

root_cause_analysis:
  summary: |
    Gate execution previously interleaved preparation (readiness checks,
    dependency setup) with execution (individual gates), creating ambiguous
    partial failures and weak phase attribution. A strict PREP/EXECUTE split
    is required so infrastructure defects fail before any gate starts.

    Operator observability was also degraded by high-noise default doctor
    payloads and wait-loop behavior that failed to terminate on actionable
    terminal states. This prevented reliable orchestration branching.

scope:
  in_scope:
    - id: "S1_PREP_PHASE"
      title: "Define and implement the PREP phase"
      detail: |
        PREP phase steps (in order):
          1. ReadinessController::run() (TCK-00620)
          2. Singleflight lock liveness reap (S7)
          3. Dependency closure hydration hook check (TCK-00623 stub)
          4. Emit prep_started event on stdout JSONL
          4. Emit prep_step per step (step_name, status, duration_ms)
          5. On failure: emit run_failed with stage="prep" and exit
        PREP phase MUST complete before EXECUTE begins.

    - id: "S2_EXECUTE_PHASE"
      title: "Define and implement the EXECUTE phase"
      detail: |
        EXECUTE phase:
          - Preserves deterministic gate ordering.
          - Enforces no ambient tracked-worktree mutation invariant.
          - Emits execute_started before first gate runs.
          - Emits gate_started and gate_finished per gate.
          - Reserves network-policy enforcement hook point for TCK-00622.

    - id: "S3_SEPARATE_REPORTING"
      title: "Emit separately timed PREP and EXECUTE outcome events"
      detail: |
        run_summary event includes:
          - prep_duration_ms
          - execute_duration_ms
          - phase_failed: "prep" | "execute" | null
        run_failed event includes stage field and root_cause.

    - id: "S4_REGRESSION_TESTS"
      title: "Regression tests for phase separation and event contract"
      detail: |
        - PREP failure => EXECUTE skipped, stage=prep.
        - PREP+EXECUTE success => both phase durations populated.
        - EXECUTE failure => stage=execute.
        - Ambient mutation invariant detects tracked-worktree drift.
        - Event builders include schema/event/stage and optional-sha behavior.

    - id: "S5_DOCTOR_OUTPUT_NOISE"
      title: "Reduce fac doctor default output noise"
      detail: |
        `apm2 fac doctor` (system mode, no --pr):
          - Default output remains schema `apm2.fac.doctor.system.v1`.
          - `checks` remains authoritative.
          - `tracked_prs` is empty unless `--tracked-prs` or `--full` is set.
          - `--repo` filtering applies when tracked PR output is enabled.

    - id: "S6_DOCTOR_WAIT_TERMINAL_STATES"
      title: "Add terminal-state semantics to --wait-for-recommended-action"
      detail: |
        `fac doctor --wait-for-recommended-action` exits immediately on
        terminal/manual outcomes and emits terminal JSON when in --json mode:
          - dispatch_implementor => wait_terminal reason=dispatch_implementor
          - merge/approve => wait_terminal reason=merge_ready
          - timeout => wait_timeout elapsed_seconds=...
        Approve/merge-ready no longer blocks on active reviewer processes.

    - id: "S7_SINGLEFLIGHT_LOCK_LIVENESS"
      title: "Reap stale singleflight locks via PID-liveness check"
      detail: |
        BUG REPORT — observed 2026-02-18, manual remediation required.

        Symptoms:
          - All agents blocked on `fac push` / `fac gates` for 10+ minutes.
          - 62 stale `.lock` files in `$APM2_HOME/private/fac/queue/singleflight/`,
            accumulated over ~16 hours (2026-02-17 22:04 → 2026-02-18 14:28).
          - `fuser` and `lsof` confirmed ZERO processes held any of these locks.
          - `queue/pending/` and `queue/claimed/` both empty.
          - 22+ `fac worker` processes sleeping at 0% CPU with nothing to process.
          - Manual `rm *.lock` in the singleflight directory immediately unblocked
            all gates processing.

        Root cause:
          `acquire_gates_single_flight_lock()` in gates.rs:504-560 creates a lock
          file per (repo_id, head_sha) and acquires an exclusive flock via
          `lock_exclusive()`. The flock is held for the entire
          `PreparedGatesRequest` lifetime (`_single_flight_lock` field).

          The mechanism has two compounding defects:

          1. LOCK FILES ARE NEVER CLEANED UP. When the owning process exits
             (normally or via crash), the OS releases the flock but the file
             persists. Over time the directory accumulates hundreds of stale
             lock files — one per SHA ever evaluated. There is no reaper, no
             TTL, and no GC integration.

          2. NO LIVENESS CHECK BEFORE BLOCKING. `lock_exclusive()` blocks
             indefinitely if another process holds the flock. Under memory
             pressure (swap thrashing), a flock-holding process may be
             effectively hung — unable to make progress to release the lock.
             New callers for the same SHA pile up blocked on flock, consuming
             resources and worsening the pressure. There is no timeout on the
             flock acquisition.

          Compounding factor: the incident co-occurred with 15 GB of stale
          build artifacts in `/dev/shm/apm2-target` (RAM-backed tmpfs),
          which exhausted swap (3 GB/3 GB) and caused system-wide thrash.
          Under thrash, flock-holding processes could not make progress,
          creating a feedback loop where lock waiters accumulated faster
          than locks were released.

        Required fix (PREP phase integration):
          1. Before calling `lock_exclusive()`, attempt `try_lock_exclusive()`.
             If the lock is held, check whether the holding PID is alive
             (write PID to lock file content; verify with `kill(pid, 0)`).
             If PID is dead, reap the lock file and re-acquire.
          2. Add a configurable timeout to flock acquisition (default: 120s).
             On timeout, emit a diagnostic event and fail with actionable
             error ("stale singleflight lock for SHA <x>, owning PID <y>
             is dead/unresponsive — run `apm2 fac gc` or remove lock").
          3. PREP phase (S1) MUST reap stale singleflight locks as a
             readiness step: scan the directory, check PID liveness for
             each lock, remove files whose owners are dead.
          4. Emit a prep_step event for singleflight reaping with count of
             reaped locks.

        Acceptance criteria:
          - Stale singleflight locks (owner PID dead) are automatically
            reaped during PREP phase.
          - `lock_exclusive()` never blocks indefinitely; bounded by timeout.
          - Lock files include owning PID for liveness verification.
          - Lock reaping emits structured telemetry (prep_step event).
          - Regression test: simulate process crash mid-lock, verify next
            gates invocation reaps the stale lock and proceeds.

        References:
          - gates.rs:504-560 (acquire_gates_single_flight_lock)
          - gates.rs:130 (_single_flight_lock field on PreparedGatesRequest)
          - RFC-0019 FESv1 §4.4 (stale lease handling MUST be fail-closed)
          - RFC-0019 FESv1 §0.3 (reuse model_pool.rs leasing pattern)

  out_of_scope:
    - "Network denial enforcement details (TCK-00622)."
    - "Dependency closure artifact schema and full hydration semantics (TCK-00623)."
    - "Full 10-event JSONL schema completion (TCK-00625)."
    - "Any user-visible gate ordering or gate logic redesign."

plan:
  steps:
    - id: "STEP_01"
      title: "Introduce phase model and structured phase failures"
      detail: |
        Add GatesRunPhase/GatesRunFailure and phase runner plumbing so PREP and
        EXECUTE are explicit, separately timed, and fail-closed.

    - id: "STEP_01b"
      title: "Implement singleflight lock liveness reaper"
      detail: |
        Refactor acquire_gates_single_flight_lock() (gates.rs:504-560) to:
          1. Write owning PID into lock file content on acquisition.
          2. Replace blocking lock_exclusive() with try_lock_exclusive() +
             PID-liveness fallback + bounded retry (timeout 120s default).
          3. Add reap_stale_singleflight_locks() that scans the singleflight
             directory, reads PID from each lock, checks liveness via
             kill(pid, 0), and removes files whose owners are dead.
          4. Wire reap_stale_singleflight_locks() into PREP phase as a
             readiness step (after ReadinessController, before dependency
             closure hydration).
          5. Emit prep_step event with step_name="singleflight_reap" and
             count of reaped locks.

    - id: "STEP_02"
      title: "Implement PREP hook sequence and per-step telemetry"
      detail: |
        Wire ReadinessController + dependency hook check + singleflight reap
        through PREP with prep_started/prep_step emission and stage-attributed
        failures.

    - id: "STEP_03"
      title: "Wire EXECUTE lifecycle telemetry"
      detail: |
        Emit execute_started before first gate, stream gate_started/
        gate_finished during execution, and preserve terminal run_summary/
        run_failed semantics.

    - id: "STEP_04"
      title: "Enforce execute ambient-mutation invariant"
      detail: |
        Capture tracked-worktree fingerprint before/after EXECUTE and fail
        with deterministic marker if drift is detected.

    - id: "STEP_05"
      title: "Implement doctor tracked_prs gating"
      detail: |
        Add --tracked-prs flag and suppress tracked_prs payload by default in
        system doctor output.

    - id: "STEP_06"
      title: "Implement doctor wait terminal-state exit signaling"
      detail: |
        Add wait_terminal emission with reason mapping and treat approve/merge
        as terminal wait outcomes.

    - id: "STEP_07"
      title: "Run workspace-grade validation"
      detail: |
        cargo fmt --all
        cargo clippy --workspace --all-targets --all-features -- -D warnings
        cargo doc --workspace --no-deps
        cargo test --workspace

definition_of_done:
  evidence_ids:
    - "EXEC-TCK00621-PHASE-SEPARATION"
    - "EXEC-TCK00621-PREP-FAIL-NO-GATES"
    - "EXEC-TCK00621-SINGLEFLIGHT-REAP"
    - "EXEC-TCK00621-DOCTOR-WAIT-TERMINAL"
    - "EXEC-TCK00621-WORKSPACE-VALIDATION"
  criteria:
    - "PREP and EXECUTE are distinct, separately timed phases."
    - "If PREP fails, no gate processes are started."
    - "Stale singleflight locks (owner PID dead) are reaped during PREP."
    - "Singleflight lock acquisition has a bounded timeout (no indefinite hang)."
    - "Lock files record owning PID; liveness is verified before blocking."
    - "Regression test: stale lock from dead PID is reaped, gates proceed."
    - "run_summary includes prep_duration_ms, execute_duration_ms, and phase_failed."
    - "run_failed includes stage field identifying failing phase."
    - "execute_started is emitted before first gate lifecycle event."
    - "Regression tests pass for phase separation and event contract invariants."
    - "Default fac doctor output suppresses tracked PR payload noise."
    - "tracked_prs is available via explicit --tracked-prs or --full flags."
    - "--wait-for-recommended-action returns on dispatch_implementor and approve/merge terminal outcomes."
    - "Terminal wait exit emits wait_terminal with reason in JSON mode."
    - "Workspace validation completes successfully."

notes:
  context: |
    This ticket delivers a one-pass phase-separation + observability slice for
    RFC-0019 gates behavior, plus doctor UX/automation fixes needed for
    actionable operator flows. It intentionally excludes migration/cutover
    paths and leaves full JSONL schema completion to TCK-00625.
  security: "fail-closed: PREP failure prevents any gate execution"

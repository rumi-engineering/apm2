{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-24",
    "template_version": "2026-01-24",
    "ticket": {
      "id": "TCK-00680",
      "title": "Docs overhaul: CAC migration, RFC flattening, schema consolidation, cac-spec relocation, and fac push performance",
      "status": "OPEN",
      "severity": "major",
      "component": "docs/cac",
      "tags": [
        "docs-overhaul",
        "cac-migration",
        "documents",
        "instruction-specs",
        "runbooks",
        "reviews",
        "releases",
        "rfc-flatten",
        "schema-consolidation",
        "cac-spec",
        "performance",
        "fac-push",
        "agents-json",
        "behavior-ids"
      ]
    },
    "binds": {
      "prd_id": "PRD-0001",
      "rfc_id": "RFC-0011",
      "requirements": [
        "RFC-0011 establishes Context-as-Code as the canonical format for all agent-executable documents.",
        "fac push end-to-end wall time must be reduced to an acceptable baseline for development iteration velocity."
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_DOC_AUTHOR",
        "AGENT_IMPLEMENTER",
        "AGENT_REVIEWER"
      ],
      "responsibility_domains": [
        "DOMAIN_DOCUMENTATION",
        "DOMAIN_CAC",
        "DOMAIN_FAC",
        "DOMAIN_PUSH",
        "DOMAIN_GITHUB"
      ]
    },
    "dependencies": {
      "tickets": []
    },
    "supersedes": [
      "TCK-00681"
    ]
  },
  "problem_statement": "Two parallel problems drive this ticket:\n\n1. Document format debt: agent-executable documents are spread across incompatible\n   formats (.md, multi-file YAML, flat JSON) with no consistent CAC envelope. The\n   CAC spec itself (documents/standards/cac/) has no canonical home now that the\n   RFC directory is flattening. Schemas are split across two directories. RFC\n   subdirectories are multi-file YAML when the canonical format is a single\n   .cac.rfc_doc.v1.json per RFC.\n\n2. fac push performance: `apm2 fac push` is unacceptably slow. The command resolves\n   work binding, pushes to remote, creates or updates a PR, blocks on evidence gates,\n   synchronizes ruleset projection, and dispatches reviews — a pipeline with significant\n   latency that has grown without a dedicated performance pass. No profiling baseline\n   exists. The command is used on every implementation cycle, so its latency directly\n   multiplies agent iteration cost.\n",
  "scope": {
    "in_scope": [
      {
        "id": "DOC-001",
        "title": "Migrate documents/releases/*.md to CAC JSON format",
        "detail": "Convert the four release documents to .cac.json:\n  - ARTIFACT_PROMOTION.md\n  - DISTRIBUTION.md\n  - README.md\n  - RELEASE_CHANNELS.md\nUpdate AGENTS.md routing (documents/AGENTS.md) to reference new paths.\n"
      },
      {
        "id": "DOC-002",
        "title": "Migrate documents/reviews/*.md to CAC JSON format",
        "detail": "Convert review prompt documents to .cac.json:\n  - AAT_HYPOTHESIS_PROMPT.md → AAT_HYPOTHESIS_PROMPT.cac.json\n  - REVIEW_GATE_WAIVER_FLOW.md → REVIEW_GATE_WAIVER_FLOW.cac.json\nUpdate all cross-document references.\n"
      },
      {
        "id": "DOC-003",
        "title": "Migrate documents/runbooks/*.md to CAC JSON format",
        "detail": "Convert runbook documents to .cac.json:\n  - fac-local-operations.md\n  - fac-systemd-services.md\n"
      },
      {
        "id": "DOC-004",
        "title": "Migrate documents/standards/instructions/*.md to CAC JSON format",
        "detail": "Convert AGENT_INSTRUCTION_AUTHORING_STANDARD.md to .cac.json.\nThis document defines how instructions are authored — it should itself\nbe a canonical CAC artifact.\n"
      },
      {
        "id": "DOC-005",
        "title": "Bring documents/prompts/*.json into full CAC compliance",
        "detail": "The instruction specs in documents/prompts/ already use CAC-like schemas\n(cac.instruction_spec.v1) but may lack:\n  - canonicalizer block in meta\n  - stable_id / provenance fields\n  - schema_version alignment with current CAC spec\nAudit each file and align to the current CAC standard. Files:\n  - instruction.abstraction_discovery.v1.json\n  - instruction.alien_coding.v1.json\n  - instruction.alien_engineering_protocol.v1.json\n  - instruction.alien_prompting.v1.json\n  - instruction.alien_security.v1.json\n  - instruction.business_strategy_protocol.v1.json\n  - instruction.rfc_0021_refinement.alien_engineering_protocol.v1.json\n"
      },
      {
        "id": "DOC-006",
        "title": "Audit and remove outdated content across all migrated documents",
        "detail": "For each document migrated, audit for:\n  - References to deprecated APIs, removed subcommands, or old file paths\n  - RFC references to superseded designs\n  - Version numbers, dates, or status fields that are stale\n  - Duplicate or contradictory content already covered by a newer document\nRemove or correct all stale content identified.\n"
      },
      {
        "id": "DOC-007",
        "title": "Update AGENTS.md routing table to reflect new CAC paths",
        "detail": "After migration, update all AGENTS.md files that reference the migrated\ndocuments (especially documents/AGENTS.md and the root AGENTS.md) to\npoint to the new .cac.json paths instead of .md paths.\nAdd replaces: fields in each new .cac.json pointing to the old .md path.\n"
      },
      {
        "id": "DOC-008",
        "title": "Flatten documents/rfcs/ to a flat JSON-at-root layout",
        "detail": "Current state (as of 2026-02-24):\n  - RFC-0031 and RFC-0032 are already new-format: each dir contains a single\n    RFC-NNNN.cac.rfc_doc.v1.json file.\n  - RFC-0001 through RFC-0021, RFC-0027 through RFC-0029 are old-format:\n    multi-file YAML split across 00_meta.yaml, 01_..., evidence_artifacts/,\n    requirements/, reviews/, and loose .md appendices.\n  - RFC-0022 through RFC-0026, RFC-0030 are seed stubs (seed.md only).\n  - Several flat JSON files already created and untracked in the worktree:\n    RFC-0011, RFC-0016, RFC-0020, RFC-0031, RFC-0032, RFC-0033.\n\nTarget layout: documents/rfcs/ is a flat directory. Each RFC is a single\nfile named RFC-NNNN.cac.rfc_doc.v1.json at the rfcs/ root. No subdirectories.\n\nSteps:\n  1. Stage already-created untracked flat JSON files.\n  2. For RFC-0031 and RFC-0032: git rm the subdirectory (flat JSON already at root).\n  3. For each old-format RFC: merge all YAML sections and any notable .md\n     appendices into a single RFC-NNNN.cac.rfc_doc.v1.json. Fold evidence\n     artifacts and requirements into the JSON payload. Remove old directory.\n  4. For seed stubs (RFC-0022 through RFC-0026, RFC-0030): convert seed.md to\n     a minimal RFC-NNNN.cac.rfc_doc.v1.json with status SEED. Remove directory.\n  5. Remove the rfcs/template/ directory (superseded by cac.rfc_doc.v1 schema).\n  6. Update all cross-references in AGENTS.md routing tables.\n"
      },
      {
        "id": "DOC-009",
        "title": "Consolidate all CAC schemas to documents/schemas/",
        "detail": "Schemas are currently split across two locations:\n  - documents/standards/schemas/ — 9 YAML schemas for work artifacts\n    (tickets, evidence, requirements, gate reviews, PRD/RFC meta, etc.)\n  - documents/standards/cac/schemas/ — 28 JSON schemas for CAC artifacts\n  - documents/rfcs/cac.requirement.v1.schema.json — stray schema at rfcs/ root\n\nTarget: a single canonical schema registry at documents/schemas/ containing\nall schemas regardless of format, with a MANIFEST.json index.\n\nSteps:\n  1. Create documents/schemas/ directory.\n  2. git mv all files from documents/standards/cac/schemas/ → documents/schemas/\n  3. git mv all files from documents/standards/schemas/ → documents/schemas/\n  4. Move stray documents/rfcs/cac.requirement.v1.schema.json → documents/schemas/\n  5. Write documents/schemas/MANIFEST.json indexing every schema by schema_id,\n     file, format, and description.\n  6. Update all cross-references (AGENTS.md, CAC volumes, ticket template).\n  7. Remove now-empty documents/standards/cac/schemas/ and\n     documents/standards/schemas/ directories.\n"
      },
      {
        "id": "DOC-010",
        "title": "Relocate documents/standards/cac/ bulk content to documents/cac/",
        "detail": "Current state: documents/standards/cac/ contains the expanded CAC\nspecification (volumes, workspace fragments, examples, build artifacts,\nparallel design options). With schemas moving to documents/schemas/ and\nRFCs flattening to single-file JSON, this content has no natural home\nunder standards/.\n\nTarget: documents/cac/ — a first-class top-level directory for the CAC\nspecification body, parallel to documents/rfcs/, documents/schemas/, etc.\n\nContent to move (after schemas are extracted to DOC-009):\n  - documents/standards/cac/MANIFEST.json → documents/cac/MANIFEST.json\n  - documents/standards/cac/MASTER.json   → documents/cac/MASTER.json\n  - documents/standards/cac/volumes/      → documents/cac/volumes/\n  - documents/standards/cac/workspace/    → documents/cac/workspace/\n  - documents/standards/cac/examples/     → documents/cac/examples/\n  - documents/standards/cac/build/        → documents/cac/build/\n  - documents/standards/cac/parallel/     → documents/cac/parallel/\n\nAfter move: documents/standards/cac/ is empty and can be removed.\n\nUpdate all cross-references: AGENTS.md entries, any standards/schemas\nthat reference the old path, and internal cross-links in the volumes.\n"
      },
      {
        "id": "DOC-011",
        "title": "Migrate all AGENTS.md files to machine-readable CAC JSON with behavior IDs",
        "detail": "Current state: ~50+ AGENTS.md files across the repository (every crate and\nmodule has one) are free-form Markdown. They describe module contracts,\ninvariants, public APIs, and agent routing instructions in prose. Code\ncomments sometimes duplicate or cross-reference this prose inline.\n\nTarget: every AGENTS.md is replaced by an AGENTS.json conforming to a new\nschema (apm2.agents_context.v1). The schema defines machine-readable\n\"behavior IDs\" — stable, namespaced identifiers for invariants, contracts,\nroles, and routing rules. Code comments replace verbose inline explanations\nwith terse behavior ID references (e.g. `// [BEH-FAC-LANE-001]`), and\ntooling can resolve the full description from AGENTS.json.\n\nDesign decisions (to be finalized in schema design step, see notes):\n  - Behavior IDs are globally unique, namespaced by module path\n    (e.g. BEH-FAC-LANE-001, BEH-CORE-CRYPTO-003)\n  - Each behavior entry has: id, title, kind (invariant | contract |\n    capability | routing_rule | stop_condition), description, and optional\n    traceability links to RFC requirements and ticket IDs\n  - AGENTS.json retains all routing/context-loading instructions from the\n    current AGENTS.md, structured under a routing: key\n  - The root AGENTS.md (context router) becomes AGENTS.json with the full\n    routing_table preserved as structured JSON (it already is JSON inside\n    a .md wrapper)\n  - A new schema file documents/schemas/apm2.agents_context.v1.schema.json\n    defines the format\n\nScope of files to migrate (from AGENTS.md map in root AGENTS.md):\n  All ~50 entries in the agents_md_map, including:\n  - Root AGENTS.md (the context router)\n  - All crates/apm2-*/AGENTS.md\n  - All crates/apm2-*/src/**/AGENTS.md\n  - documents/AGENTS.md, documents/theory/AGENTS.md,\n    documents/work/tickets/AGENTS.md\n\nSteps:\n  1. Finalize apm2.agents_context.v1 schema (separate design step — see notes)\n  2. Write documents/schemas/apm2.agents_context.v1.schema.json\n  3. For each AGENTS.md: convert prose to structured JSON, assign behavior\n     IDs to each invariant/contract/capability, preserve all routing rules\n  4. Replace each AGENTS.md with AGENTS.json in the same directory\n  5. Update all cross-references that use AGENTS.md paths\n  6. Update the agents_md_map in root AGENTS.json to reference .json paths\n  7. Optionally: add a thin AGENTS.md shim in each dir that says\n     \"see AGENTS.json\" if human-readable fallback is desired — but\n     default-deny: remove .md unless there is a concrete reason to keep it\n"
      },
      {
        "id": "DOC-012",
        "title": "Convert all remaining YAML documents to JSON — zero YAML target",
        "detail": "Remaining YAML files after all other migration steps:\n  - documents/work/tickets/TCK-NNNNN.yaml (~657 files)\n  - documents/work/tickets/FAC_SECURITY_MODEL_INVARIANTS_V1.yaml\n  - documents/work/waivers/WVR-XXXX.yaml (~9 files)\n\nTarget: every document in the repository uses JSON. No .yaml or .yml files\nremain under documents/.\n\nConversion approach:\n  - Bulk-convert via python3 (yaml → json) preserving all structure\n  - Add top-level \"schema\" field to each converted file:\n      tickets → \"apm2.ticket.v1\"\n      waivers → \"apm2.waiver.v1\"\n      FAC invariants → \"apm2.fac_security_invariants.v1\"\n  - Rename: .yaml → .json\n  - git rm originals, git add converted files\n\nNote: ticket and waiver content is preserved verbatim — no structural\nchanges to the payload, only format conversion and schema field addition.\n"
      },
      {
        "id": "PERF-001",
        "title": "Instrument fac push with wall-time spans for each major phase",
        "detail": "Add structured timing instrumentation (tracing spans or explicit wall-clock\nmeasurements emitted to stderr/log) covering each phase:\n  - work binding resolution (daemon IPC)\n  - git push to remote\n  - PR create/update (GitHub API)\n  - ruleset projection sync (GitHub API)\n  - evidence gate blocking loop\n  - review dispatch\nEstablish a reproducible baseline before making any changes.\n"
      },
      {
        "id": "PERF-002",
        "title": "Parallelize independent GitHub API calls",
        "detail": "Audit the push pipeline for GitHub API calls that are currently sequential\nbut have no data dependency on each other. Candidates include:\n  - ruleset sync and PR body update happening sequentially\n  - status check reads that could be batched or pipelined\nConvert independent calls to concurrent tokio tasks (join! / FuturesUnordered).\n"
      },
      {
        "id": "PERF-003",
        "title": "Eliminate or bound unnecessary sleeps and polling intervals",
        "detail": "Audit all `tokio::time::sleep`, poll loops, and retry backoff sequences in\nthe push path (push.rs, readiness.rs, lifecycle.rs, github_projection.rs).\nFor each:\n  - replace fixed sleeps with event-driven waits where possible\n  - tighten poll intervals to the minimum safe value\n  - cap retry counts and surface timeouts as errors rather than hanging\n"
      },
      {
        "id": "PERF-004",
        "title": "Parallelize work binding resolution with git push",
        "detail": "Work binding resolution (daemon IPC round-trip) and `git push` are likely\nindependent. If binding resolution does not need to complete before the\npush, issue both concurrently and join before the PR step.\n"
      },
      {
        "id": "PERF-005",
        "title": "Cache GitHub App token across push sub-operations",
        "detail": "If a new installation token is fetched for each GitHub API call within a\nsingle push invocation, consolidate to a single token fetch at startup and\nthread it through. Token exchange adds 200-500ms per call.\n"
      },
      {
        "id": "PERF-006",
        "title": "Establish a push latency regression gate",
        "detail": "After the optimizations land, add a timing assertion (or bench harness entry\nunder `apm2 fac bench`) that fails if fac push wall time on a no-op\n(already-up-to-date) invocation exceeds a defined threshold. Prevents\nsilent regression.\n"
      }
    ],
    "out_of_scope": [
      "Converting RFC content — only structure and format change, not substance",
      "Migrating SKILL.md files and their references/ directories — skills use a distinct SKILL.md format by design",
      "Migrating root-level human-readable docs (README.md, DAEMON.md, SECURITY.md, AGENTS.md) — these serve onboarding and remain as markdown",
      "Changes to FAC gate execution time (gate jobs run inside sandboxed lanes — separate concern)",
      "GitHub Actions CI runtime improvements",
      "Network latency between the compute host and GitHub API (infrastructure concern)",
      "Any behavioral changes to fac push semantics, evidence binding, or security invariants",
      "Any Rust code changes outside the fac push performance items"
    ],
    "affected_paths": [
      "documents/releases/",
      "documents/reviews/",
      "documents/runbooks/",
      "documents/standards/instructions/",
      "documents/prompts/",
      "documents/rfcs/",
      "documents/schemas/  (new — canonical schema registry)",
      "documents/cac/  (new — canonical CAC spec body)",
      "documents/standards/cac/  (to be fully removed after DOC-009 + DOC-010)",
      "documents/standards/schemas/  (to be removed after DOC-009)",
      "documents/AGENTS.md",
      "AGENTS.md",
      "crates/apm2-cli/src/commands/fac_review/push.rs",
      "crates/apm2-cli/src/commands/fac_review/prepare.rs",
      "crates/apm2-cli/src/commands/fac_review/lifecycle.rs",
      "crates/apm2-cli/src/commands/fac_review/readiness.rs",
      "crates/apm2-cli/src/commands/fac_review/github_projection.rs",
      "crates/apm2-cli/src/commands/fac_review/github_reads.rs",
      "crates/apm2-cli/src/commands/fac_review/github_auth.rs",
      "AGENTS.md → AGENTS.json  (all ~50 locations — see agents_md_map in root AGENTS.md)",
      "documents/schemas/apm2.agents_context.v1.schema.json  (new)"
    ]
  },
  "plan": {
    "steps": [
      {
        "step": 1,
        "action": "Audit each in-scope document for stale content and establish a migration checklist"
      },
      {
        "step": 2,
        "action": "Migrate documents/releases/*.md to .cac.json (DOC-001)"
      },
      {
        "step": 3,
        "action": "Migrate documents/reviews/*.md to .cac.json (DOC-002)"
      },
      {
        "step": 4,
        "action": "Migrate documents/runbooks/*.md to .cac.json (DOC-003)"
      },
      {
        "step": 5,
        "action": "Migrate documents/standards/instructions/AGENT_INSTRUCTION_AUTHORING_STANDARD.md to .cac.json (DOC-004)"
      },
      {
        "step": 6,
        "action": "Align documents/prompts/*.json canonicalizer and provenance blocks (DOC-005)"
      },
      {
        "step": 7,
        "action": "Flatten documents/rfcs/: stage untracked JSONs, git rm subdirs, convert seeds, remove template (DOC-008)"
      },
      {
        "step": 8,
        "action": "Create documents/schemas/, move all schemas from both source locations + stray file, write MANIFEST.json (DOC-009)"
      },
      {
        "step": 9,
        "action": "Create documents/cac/, git mv bulk CAC spec content from documents/standards/cac/ (DOC-010)"
      },
      {
        "step": 10,
        "action": "Update all AGENTS.md routing references to new paths (DOC-007)"
      },
      {
        "step": 11,
        "action": "Finalize apm2.agents_context.v1 schema design; write documents/schemas/apm2.agents_context.v1.schema.json (DOC-011 prerequisite)"
      },
      {
        "step": 12,
        "action": "Convert all ~50 AGENTS.md files to AGENTS.json; assign behavior IDs; remove .md files (DOC-011)"
      },
      {
        "step": 13,
        "action": "Instrument fac push with per-phase wall-time spans; record P50/P95 baseline (PERF-001)"
      },
      {
        "step": 12,
        "action": "Parallelize independent GitHub API calls (PERF-002)"
      },
      {
        "step": 13,
        "action": "Audit and tighten all sleep/poll loops (PERF-003)"
      },
      {
        "step": 14,
        "action": "Parallelize work binding + git push if safe (PERF-004)"
      },
      {
        "step": 15,
        "action": "Consolidate GitHub App token fetch (PERF-005)"
      },
      {
        "step": 16,
        "action": "Add latency regression gate to fac bench (PERF-006)"
      },
      {
        "step": 17,
        "action": "Update root AGENTS.json agents_md_map to reference all .json paths; verify no AGENTS.md references remain (DOC-011)"
      },
      {
        "step": 18,
        "action": "Bulk-convert all remaining YAML (tickets, waivers, FAC invariants) to JSON via python3 script (DOC-012)"
      },
      {
        "step": 19,
        "action": "Audit codebase (Rust + JSON + .github/) for stale references: AGENTS.md paths, .yaml filenames, old RFC subdir paths, old schema locations, old PRD paths"
      },
      {
        "step": 20,
        "action": "Fix all stale references found in step 19"
      },
      {
        "step": 21,
        "action": "Re-run baseline; confirm fac push improvement; final zero-YAML verification"
      }
    ]
  },
  "definition_of_done": {
    "evidence_ids": [],
    "criteria": [
      "All in-scope .md files have .cac.json replacements with schema, meta (stable_id, canonicalizer, provenance), and payload blocks",
      "Each migrated .cac.json includes replaces: pointing to the old .md path",
      "All documents/prompts/*.json pass audit: have stable_id, canonicalizer, and provenance fields",
      "No stale version numbers, removed CLI subcommands, or superseded RFC references remain in migrated docs",
      "documents/rfcs/ is flat: only RFC-NNNN.cac.rfc_doc.v1.json files, no subdirectories",
      "documents/schemas/ exists and contains all schemas from both former locations plus the stray rfcs/ schema; MANIFEST.json indexes them",
      "documents/standards/cac/schemas/ and documents/standards/schemas/ are removed",
      "documents/cac/ exists with MASTER.json, volumes/, workspace/, examples/, build/, parallel/",
      "documents/standards/cac/ is fully removed",
      "All AGENTS.md routing tables updated to new paths",
      "grep for old paths (rfcs/RFC-NNNN/, standards/cac/, standards/schemas/) returns no active cross-references",
      "Zero .yaml/.yml files remain under documents/ (confirmed by find)",
      "No stale AGENTS.md, .yaml filename, or removed-path references in Rust source or JSON docs",
      "apm2.agents_context.v1.schema.json exists in documents/schemas/",
      "All ~50 AGENTS.md files replaced by AGENTS.json conforming to the schema",
      "Every invariant/contract/capability in each AGENTS.json has a stable behavior ID",
      "No AGENTS.md files remain (or any kept have explicit justification in the ticket)",
      "Root AGENTS.json agents_md_map references .json paths for all entries",
      "Baseline wall-time measurement exists for each fac push phase (pre-optimization)",
      "Post-optimization wall-time shows statistically significant improvement",
      "All existing fac push behavioral tests pass (no semantic regression)",
      "No new fixed sleeps introduced; all polling loops have documented rationale and bounded retries",
      "Latency regression gate added to fac bench harness or test suite"
    ]
  },
  "notes": {
    "security": "default-deny, least privilege, fail-closed",
    "context": "CAC format reference: documents/security/SECURITY_POLICY.cac.json\nCAC spec (to be relocated): documents/standards/cac/ → documents/cac/\nCAC standard: RFC-0011\nSchema sources: documents/standards/cac/schemas/ (28 JSON), documents/standards/schemas/ (9 YAML)\nfac push implementation: crates/apm2-cli/src/commands/fac_review/push.rs (~6200 lines)\nCLI surface: apm2 fac push — resolves work binding, git push, PR create/update,\n  ruleset projection sync, evidence gate blocking, review dispatch.\nPerformance work must not relax any FAC security invariants or evidence binding guarantees.\nSupersedes: TCK-00681 (fac push performance — merged into this ticket 2026-02-24)\nSchema design for DOC-011 (apm2.agents_context.v1) is a prerequisite step that\nmust be finalized before AGENTS.md conversion begins. Schema design is tracked\nas a collaborative design session, not a code change.\n"
  }
}

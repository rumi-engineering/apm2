{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00144",
      "title": "Implement CapabilityManifest generator",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0007",
      "rfc_id": "RFC-0011",
      "requirements": [
        {
          "requirement_id": "CAC-REQ-0006",
          "requirement_ref": "documents/prds/PRD-0007/requirements/REQ-0006.yaml#prd_requirement"
        },
        {
          "requirement_id": "CAC-REQ-0014",
          "requirement_ref": "documents/prds/PRD-0007/requirements/REQ-0014.yaml#prd_requirement"
        }
      ],
      "evidence_artifacts": [
        "EVID-0007"
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_KERNEL",
        "DOMAIN_AGENT_RUNTIME"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00135"
      ]
    },
    "scope": {
      "in_scope": [
        "Define CapabilityManifest schema (JSON Schema + Rust struct)",
        "Enumerate CLI commands from clap definitions via introspection",
        "Extract input/output schema references for each command",
        "Compute binary_hash binding (cargo pkg version + target triple + profile)",
        "Include selftest references (test_name -> capability_id mapping)",
        "Generate deterministic manifest (sorted keys, stable output)",
        "Implement CapabilityManifest trait with generate() method"
      ],
      "out_of_scope": [
        "Selftest execution (TCK-00145)",
        "Capability gating enforcement (TCK-00146)",
        "CLI commands (TCK-00147)"
      ]
    },
    "plan": {
      "steps": [
        "Define CapabilityManifest struct in crates/apm2-core/src/cac/manifest.rs",
        "Add fields: binary_hash, version, target, commands, capabilities, selftest_refs",
        "Define Command struct: name, description, input_schema_ref, output_schema_ref",
        "Define Capability struct: id, description, verification_method, selftest_id",
        "Implement clap introspection via Command::get_subcommands()",
        "Use env!('CARGO_PKG_VERSION'), option_env!('TARGET'), cfg!(debug_assertions)",
        "Implement Serialize with sorted keys via BTreeMap intermediate",
        "Add manifest.json JSON Schema at schemas/cac/capability_manifest.schema.json",
        "Write unit tests for deterministic generation",
        "Write property tests for manifest invariants"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-0007"
      ],
      "criteria": [
        "CapabilityManifest::generate() returns valid manifest struct",
        "binary_hash computed from version + target + profile",
        "All clap subcommands enumerated with descriptions",
        "Manifest serialization is deterministic (stable key ordering)",
        "Manifest validates against JSON Schema",
        "All tests pass: cargo test capability_manifest"
      ]
    },
    "notes": {
      "rust_textbook_refs": [
        {
          "file": ".claude/skills/rust-textbook/12_api_design_stdlib_quality.md",
          "contracts": [
            "CTR-1201: Public API Contract Must Be Explicit - manifest schema defines explicit contract",
            "CTR-1205: Construction Protocols Must Be Validated - manifest generation validates completeness"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/26_apm2_safe_patterns_and_anti_patterns.md",
          "contracts": [
            "CTR-2610: Canonical Representation at Boundaries - deterministic manifest serialization",
            "CTR-2612: Deterministic Ordering Before Hashing - sorted keys before manifest hash"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/19_security_adjacent_rust.md",
          "contracts": [
            "RSK-1906: Nondeterminism as Integrity Failure - deterministic binary_hash binding"
          ]
        }
      ],
      "codebase_context": {
        "new_files": [
          {
            "path": "crates/apm2-core/src/cac/manifest.rs",
            "description": "CapabilityManifest struct and generation logic"
          },
          {
            "path": "schemas/cac/capability_manifest.schema.json",
            "description": "JSON Schema for capability manifest validation"
          }
        ],
        "extend_files": [
          {
            "path": "crates/apm2-core/src/cac/mod.rs",
            "description": "Export manifest module"
          },
          {
            "path": "xtask/src/main.rs",
            "description": "Clap Command struct for introspection (read-only reference)"
          }
        ]
      },
      "security": "Binary hash binding prevents manifest replay across versions (DD-0006).\nDeterministic generation ensures agents can verify manifest integrity.\n",
      "architecture": "Per DD-0006: CapabilityManifest generated from binary selftests.\nBinary hash includes: CARGO_PKG_VERSION + target triple + profile.\nIntrospection via clap enables compile-time capability discovery.\n"
    }
  }
}

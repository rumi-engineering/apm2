{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-26",
    "template_version": "2026-01-26",
    "ticket": {
      "id": "TCK-00118",
      "title": "Implement model router with routing profiles",
      "status": "CLOSED"
    },
    "binds": {
      "rfc_id": "RFC-0010",
      "requirements": [
        {
          "requirement_id": "REQ-0007"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00117"
      }
    ]
  },
  "implementation": {
    "summary": "Create the model router module to handle multi-model orchestration with\nconfigurable routing profiles. The router parses routing profile YAML files,\nroutes pipeline stages to appropriate providers based on profile configuration,\nand supports canary comparison between two routing configurations.\n",
    "files_to_create": [
      {
        "path": "crates/apm2-core/src/model_router/mod.rs",
        "purpose": "Module entry point exposing router, profile, and canary submodules"
      },
      {
        "path": "crates/apm2-core/src/model_router/router.rs",
        "purpose": "Core routing logic that dispatches stages to providers"
      },
      {
        "path": "crates/apm2-core/src/model_router/profile.rs",
        "purpose": "Routing profile parsing and validation from YAML"
      },
      {
        "path": "crates/apm2-core/src/model_router/canary.rs",
        "purpose": "Canary mode implementation comparing two routes and emitting diff"
      },
      {
        "path": "documents/standards/schemas/routing_profile.schema.yaml",
        "purpose": "JSON Schema defining routing profile structure"
      },
      {
        "path": "documents/standards/routing_profiles/local.yaml",
        "purpose": "Default local routing profile for development"
      }
    ],
    "files_to_modify": [
      {
        "path": "crates/apm2-core/src/lib.rs",
        "changes": "Add pub mod model_router declaration"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Create routing profile schema",
        "details": "Define the routing_profile.schema.yaml with:\n- profile_id: unique identifier\n- stages: map of stage name to provider configuration\n- provider configuration: model, endpoint, timeout, retry policy\n- fallback: optional fallback provider\n"
      },
      {
        "step": 2,
        "action": "Implement profile parser",
        "details": "In profile.rs:\n- Parse routing profile YAML files\n- Validate against schema\n- Provide RoutingProfile struct with stage-to-provider mapping\n"
      },
      {
        "step": 3,
        "action": "Implement core router",
        "details": "In router.rs:\n- Router struct that holds loaded profile\n- route_stage(stage_name) -> ProviderConfig method\n- Provider availability check with fail-closed semantics\n- Error handling for unavailable providers\n"
      },
      {
        "step": 4,
        "action": "Implement canary comparison",
        "details": "In canary.rs:\n- CanaryRunner that executes same input through two routes\n- Diff generation between outputs\n- Structured canary report with timing and differences\n"
      },
      {
        "step": 5,
        "action": "Create local routing profile",
        "details": "In local.yaml:\n- Default profile for local development\n- Map all stages to local/mock providers\n- Include example configuration comments\n"
      },
      {
        "step": 6,
        "action": "Wire up module",
        "details": "In mod.rs and lib.rs:\n- Export public types\n- Add module declaration to crate root\n"
      }
    ],
    "code_examples": [
      {
        "description": "Routing profile structure",
        "code": "# documents/standards/routing_profiles/local.yaml\nprofile_id: local\ndescription: Local development routing profile\nstages:\n  ccp_build:\n    provider: local\n    timeout_ms: 30000\n  impact_map:\n    provider: anthropic\n    model: claude-3-5-sonnet\n    timeout_ms: 60000\n  rfc_frame:\n    provider: anthropic\n    model: claude-3-5-sonnet\n    timeout_ms: 120000\nfallback:\n  provider: local\n  reason: \"Use local fallback when providers unavailable\"\n"
      }
    ]
  },
  "acceptance_criteria": [
    {
      "criterion": "Routing profiles parsed correctly",
      "verification": "Unit tests validate profile loading from YAML and field extraction"
    },
    {
      "criterion": "Canary mode produces diff",
      "verification": "Canary tests show diff output when two routes produce different results"
    },
    {
      "criterion": "Unavailable provider fails closed",
      "verification": "Tests verify router returns error (not fallback) when provider unavailable and no explicit fallback configured"
    }
  ],
  "test_requirements": [
    {
      "test_id": "UT-118-01",
      "description": "Test routing profile YAML parsing with valid input",
      "verification_command": "cargo test -p apm2-core model_router::profile"
    },
    {
      "test_id": "UT-118-02",
      "description": "Test router stage dispatch returns correct provider config",
      "verification_command": "cargo test -p apm2-core model_router::router"
    },
    {
      "test_id": "UT-118-03",
      "description": "Test canary comparison generates structured diff",
      "verification_command": "cargo test -p apm2-core model_router::canary"
    },
    {
      "test_id": "UT-118-04",
      "description": "Test fail-closed behavior when provider unavailable",
      "verification_command": "cargo test -p apm2-core model_router::router::unavailable"
    }
  ],
  "notes": "This ticket implements REQ-0007 (multi-model routing) from RFC-0010.\n\nKey design decisions:\n- Fail-closed semantics: if a provider is unavailable and no fallback is\n  explicitly configured, the router returns an error rather than silently\n  degrading to a different provider.\n- Canary mode is opt-in and runs both routes sequentially to compare outputs.\n- Routing profiles are version-controlled YAML files to enable reproducibility.\n\nCCP grounding: COMP-CORE module, extends model orchestration capabilities.\n"
}

{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-25",
    "template_version": "2026-01-25",
    "ticket": {
      "id": "TCK-00086",
      "title": "Define CIWorkflowCompleted ledger event schema"
    },
    "binds": {
      "prd_id": "PRD-0004",
      "rfc_id": "RFC-0008",
      "requirements": [
        {
          "requirement_id": "REQ-0009",
          "requirement_ref": "documents/prds/PRD-0004/requirements/REQ-0009.yaml#prd_requirement"
        },
        {
          "requirement_id": "REQ-0025",
          "requirement_ref": "documents/prds/PRD-0004/requirements/REQ-0025.yaml#prd_requirement"
        }
      ],
      "evidence_artifacts": [
        "EVID-8002"
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00085"
      ]
    },
    "scope": {
      "in_scope": [
        "Define CIWorkflowCompleted event struct with all required fields",
        "Implement event serialization/deserialization",
        "Add event emission from webhook handler after validation",
        "Track delivery_id for idempotency",
        "Persist events to ledger storage",
        "Add feature flag CI_EVENTS_ENABLED",
        "Add event query capability"
      ],
      "out_of_scope": [
        "Task queue integration (TCK-00087)",
        "Processing events for phase transitions",
        "Event streaming/subscription (future enhancement)"
      ]
    },
    "plan": {
      "steps": [
        "Define CIWorkflowCompleted event struct in events module",
        "Add fields: event_id, timestamp, pr_number, commit_sha, conclusion, checks[]",
        "Add signature_verified and delivery_id fields for audit",
        "Implement serde serialization with JSON format",
        "Create delivery_id tracking store (in-memory initially, with TTL)",
        "Modify webhook handler to emit event on valid webhook",
        "Implement ledger persistence for events",
        "Add event query by type, time range, and pr_number",
        "Write unit tests for event creation and serialization",
        "Write integration test for idempotency"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-8002"
      ],
      "criteria": [
        "CIWorkflowCompleted event struct defined with all fields",
        "Event serializes to JSON matching contract schema",
        "Webhook handler emits event on valid webhook",
        "Duplicate delivery_ids result in no duplicate events",
        "Events are persisted to ledger",
        "Events can be queried from ledger",
        "Feature flag CI_EVENTS_ENABLED controls emission",
        "Unit tests pass for event serialization",
        "Integration test passes for idempotency"
      ]
    },
    "notes": {
      "implementation_details": "Event schema:\n```rust\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CIWorkflowCompleted {\n    pub event_id: Uuid,\n    pub event_type: String, // Always \"CIWorkflowCompleted\"\n    pub timestamp: DateTime<Utc>,\n    pub source: String, // Always \"github_webhook\"\n    pub payload: CIWorkflowPayload,\n    pub signature_verified: bool,\n    pub delivery_id: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CIWorkflowPayload {\n    pub pr_number: u64,\n    pub commit_sha: String,\n    pub conclusion: CIConclusion, // success, failure, cancelled\n    pub workflow_name: String,\n    pub workflow_run_id: u64,\n    pub checks: Vec<CheckResult>,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CheckResult {\n    pub name: String,\n    pub conclusion: CheckConclusion, // success, failure, skipped\n    pub started_at: DateTime<Utc>,\n    pub completed_at: DateTime<Utc>,\n}\n```\n\nIdempotency implementation:\n- Use a HashSet<String> to track seen delivery_ids\n- TTL of 24 hours (configurable)\n- Before emitting event, check if delivery_id already seen\n- If seen, return success but don't emit duplicate event\n",
      "affected_files": "New:\n  - crates/apm2-core/src/events/ci.rs\n  - crates/apm2-core/src/events/mod.rs (if not exists)\nModified:\n  - crates/apm2-core/src/webhook/handler.rs (add event emission)\n  - crates/apm2-core/src/lib.rs (add events module)\n"
    }
  }
}

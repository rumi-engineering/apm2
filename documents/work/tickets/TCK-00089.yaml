ticket_meta:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"
  ticket:
    id: "TCK-00089"
    title: "Add agent handoff integration tests"
  binds:
    prd_id: "PRD-0004"
    rfc_id: "RFC-0008"
    requirements:
      - requirement_id: "REQ-0018"
        requirement_ref: "documents/prds/PRD-0004/requirements/REQ-0018.yaml#prd_requirement"
    evidence_artifacts:
      - "EVID-8005"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
      - "DOMAIN_SECURITY"
  dependencies:
    tickets:
      - "TCK-00088"
  scope:
    in_scope:
      - "End-to-end test: full handoff flow from webhook to agent claiming"
      - "Test webhook signature validation (valid and invalid)"
      - "Test idempotency of webhook handling"
      - "Test anti-gaming controls (agent cannot set CI status)"
      - "Test error cases (malformed payload, missing headers)"
      - "Test feature flag behavior (each phase can be disabled)"
      - "Test phase transition state machine edge cases"
    out_of_scope:
      - "Performance testing"
      - "Load testing"
      - "Testing with actual GitHub webhooks (use mocked payloads)"
  plan:
    steps:
      - "Create test fixtures for GitHub webhook payloads"
      - "Create test helper to generate valid HMAC signatures"
      - "Write E2E test: webhook -> event -> transition -> claim"
      - "Write security test: reject unsigned webhooks"
      - "Write security test: reject tamperedpayloads"
      - "Write security test: agent cannot set CI status directly"
      - "Write idempotency test: duplicate delivery_id handling"
      - "Write error tests: missing headers, malformed JSON"
      - "Write feature flag tests: each phase can be disabled"
      - "Write edge case tests: CI reruns, cancelled workflows"
      - "Verify all tests pass in CI"
  definition_of_done:
    evidence_ids:
      - "EVID-8005"
    criteria:
      - "E2E test passes: webhook -> event -> transition -> handoff"
      - "Security tests pass: invalid signatures rejected"
      - "Security tests pass: agents cannot set CI status"
      - "Idempotency test passes: duplicate webhooks handled"
      - "Error tests pass: malformed requests rejected appropriately"
      - "Feature flag tests pass: phases can be disabled"
      - "Edge case tests pass: reruns, cancellations handled"
      - "All tests run in CI pipeline"
      - "Test coverage for critical paths >90%"
  notes:
    implementation_details: |
      Test structure:
      ```rust
      #[cfg(test)]
      mod tests {
          use super::*;
          use axum::http::StatusCode;

          fn compute_signature(payload: &[u8], secret: &str) -> String {
              use hmac::{Hmac, Mac};
              use sha2::Sha256;
              let mut mac = Hmac::<Sha256>::new_from_slice(secret.as_bytes()).unwrap();
              mac.update(payload);
              let result = mac.finalize();
              format!("sha256={}", hex::encode(result.into_bytes()))
          }

          #[tokio::test]
          async fn test_e2e_handoff_flow() {
              // Setup
              let app = create_test_app().await;
              let work_item = create_work_item(WorkPhase::CIPending).await;

              // Simulate webhook
              let payload = json!({
                  "action": "completed",
                  "workflow_run": {
                      "id": 12345,
                      "head_sha": work_item.commit_sha,
                      "conclusion": "success",
                      "pull_requests": [{"number": work_item.pr_number}]
                  }
              });
              let signature = compute_signature(payload.to_string().as_bytes(), SECRET);

              let response = app
                  .post("/webhooks/github")
                  .header("X-Hub-Signature-256", signature)
                  .header("X-GitHub-Event", "workflow_run")
                  .header("X-GitHub-Delivery", "test-delivery-1")
                  .json(&payload)
                  .await;

              assert_eq!(response.status(), StatusCode::ACCEPTED);

              // Verify event emitted
              let events = app.ledger.query_events::<CIWorkflowCompleted>().await;
              assert_eq!(events.len(), 1);

              // Verify work item transitioned
              let updated = app.work_store.get(&work_item.id).await.unwrap();
              assert_eq!(updated.phase, WorkPhase::ReadyForReview);

              // Verify work can be claimed
              let lease = app.work_store.try_claim(&work_item.id, "agent-2").await;
              assert!(lease.is_ok());
          }

          #[tokio::test]
          async fn test_anti_gaming_agent_cannot_set_ci() {
              let app = create_test_app().await;
              let work_item = create_work_item(WorkPhase::CIPending).await;

              // Simulate agent trying to transition directly (no webhook)
              let result = app.work_store
                  .transition(&work_item.id, WorkPhase::ReadyForReview)
                  .await;

              // Should fail - only CIWorkflowCompleted events can transition
              assert!(matches!(result, Err(Error::UnauthorizedTransition)));

              // Work item still in CI_PENDING
              let unchanged = app.work_store.get(&work_item.id).await.unwrap();
              assert_eq!(unchanged.phase, WorkPhase::CIPending);
          }

          #[tokio::test]
          async fn test_invalid_signature_rejected() {
              let app = create_test_app().await;
              let payload = json!({"action": "completed", ...});

              let response = app
                  .post("/webhooks/github")
                  .header("X-Hub-Signature-256", "sha256=invalid")
                  .json(&payload)
                  .await;

              assert_eq!(response.status(), StatusCode::UNAUTHORIZED);
          }

          #[tokio::test]
          async fn test_duplicate_delivery_id_idempotent() {
              let app = create_test_app().await;
              let payload = json!({...});
              let signature = compute_signature(...);

              // First delivery
              let response1 = app.post("/webhooks/github")
                  .header("X-GitHub-Delivery", "dup-id-1")
                  .header("X-Hub-Signature-256", &signature)
                  .json(&payload)
                  .await;
              assert_eq!(response1.status(), StatusCode::ACCEPTED);

              // Duplicate delivery
              let response2 = app.post("/webhooks/github")
                  .header("X-GitHub-Delivery", "dup-id-1")
                  .header("X-Hub-Signature-256", &signature)
                  .json(&payload)
                  .await;
              assert_eq!(response2.status(), StatusCode::OK); // 200 for already processed

              // Only one event in ledger
              let events = app.ledger.query_events::<CIWorkflowCompleted>().await;
              assert_eq!(events.len(), 1);
          }
      }
      ```
    affected_files: |
      New:
        - crates/apm2-core/tests/integration/handoff.rs
        - crates/apm2-core/tests/integration/mod.rs
        - crates/apm2-core/tests/fixtures/webhook_payloads.rs
      Modified:
        - crates/apm2-core/Cargo.toml (add test dependencies if needed)

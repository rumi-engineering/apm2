ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00408"
    title: "Enforce fail-closed side-effect cutover and durable projection acknowledgement"
    status: "OPEN"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0018"
    requirements:
      - requirement_id: "REQ-HEF-0006"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0006.yaml#rfc_requirement"
      - requirement_id: "REQ-HEF-0009"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0009.yaml#rfc_requirement"
      - requirement_id: "REQ-HEF-0010"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0010.yaml#rfc_requirement"
    evidence_artifacts:
      - evidence_id: "EVID-HEF-0012"
        artifact_ref: "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0012.yaml#rfc_evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
      - "AGENT_REVIEWER"
    responsibility_domains:
      - "DOMAIN_SECURITY"
      - "DOMAIN_RUNTIME"
      - "DOMAIN_BUILD_RELEASE"
  dependencies:
    tickets:
      - ticket_id: "TCK-00324"
        reason: "Incident findings show cutover controls were incomplete in executable paths."
      - ticket_id: "TCK-00297"
        reason: "Direct status-write removal needs strict enforcement and verification in prompts/workflows."
      - ticket_id: "TCK-00393"
        reason: "Watchdog runtime fail-closed startup/dependency behavior was flagged in re-review."
      - ticket_id: "TCK-00394"
        reason: "Publish/ingest side effects must be validated before authoritative event emission."
  scope:
    in_scope:
      - "Enforce emit-only cutover end-to-end: no direct GitHub writes on any code path when emit-only is active."
      - "Propagate effective cutover policy to spawned reviewer/executor child processes."
      - "Require durable projection acknowledgement (receipt/event id) before reporting side-effect success in emit-only mode."
      - "Fail closed when required enforcement dependencies are missing (for example enabled watchdog without required persistence dependencies)."
      - "Require CAS existence/integrity validation and bundle validation before authoritative event emission in privileged ingestion/publish handlers."
      - "Require actor ownership checks for authority-bearing publish/ingest requests."
    out_of_scope:
      - "Changing merge-policy semantics unrelated to side-effect execution."
      - "Bulk refactor of all review prompts."
      - "Long-term projection architecture redesign."
  plan:
    steps:
      - "Audit all direct side-effect callsites and centralize policy check in a single reusable gate."
      - "Thread cutover decision context through parent -> child execution paths."
      - "Change emit-only success semantics to require durable acknowledgement; treat missing acknowledgement as failure."
      - "Update watchdog and related startup configuration checks to hard-fail when enabled dependencies are unavailable."
      - "Add validation hooks for CAS artifact existence and bundle integrity in publish/ingest handlers."
      - "Add actor-ownership checks before mutation/event emission in authority-bearing handlers."
      - "Add integration tests for negative paths (missing daemon, missing CAS artifact, ownership mismatch, enabled-without-dependency startup)."
      - "Run cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings && cargo test --workspace."
  definition_of_done:
    evidence_ids:
      - "EVID-HEF-0012"
    criteria:
      - "Emit-only mode guarantees no direct GitHub writes."
      - "Child processes inherit and honor cutover policy."
      - "Emit-only operations fail closed without durable receipt acknowledgement."
      - "Enabled security controls fail startup when mandatory dependencies are missing."
      - "Publish/ingest handlers reject missing or invalid CAS/bundle inputs before emission."
      - "Ownership mismatch requests are denied and tested."
  notes:
    context: |
      Re-reviews across PRs #440, #443, #445, #448 identified a repeated pattern:
      side-effect controls existed but were not enforced consistently at runtime.
      Success paths sometimes continued after failed emission/validation, violating
      fail-closed expectations.
    files: |
      - xtask/src/tasks/security_review_exec.rs
      - xtask/src/tasks/review.rs
      - xtask/src/tasks/push.rs
      - xtask/src/util.rs
      - crates/apm2-daemon/src/protocol/dispatch.rs
      - crates/apm2-daemon/src/main.rs
      - crates/apm2-daemon/src/ledger.rs
      - documents/reviews/CODE_QUALITY_PROMPT.md
    security: |
      - Every side-effect path must have one authoritative allow/deny gate.
      - Missing dependencies and failed validation paths must deny by default.
      - Success logging must never precede durable acknowledgement.


ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00410"
    title: "FAC-local gate execution (self-hosted OVH runner) + fail-closed test safety guardrails"
    status: "CLOSED"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0019"
    requirements:
      - requirement_id: "REQ-0006"
        requirement_ref: "documents/rfcs/RFC-0019/requirements/REQ-0006.yaml#requirement"
      - requirement_id: "REQ-0011"
        requirement_ref: "documents/rfcs/RFC-0019/requirements/REQ-0011.yaml#requirement"
      - requirement_id: "REQ-0016"
        requirement_ref: "documents/rfcs/RFC-0019/requirements/REQ-0016.yaml#requirement"
    evidence_artifacts:
      - evidence_id: "EVID-0006"
        artifact_ref: "documents/rfcs/RFC-0019/evidence_artifacts/EVID-0006.yaml#evidence_artifact"
      - evidence_id: "EVID-0011"
        artifact_ref: "documents/rfcs/RFC-0019/evidence_artifacts/EVID-0011.yaml#evidence_artifact"
      - evidence_id: "EVID-0016"
        artifact_ref: "documents/rfcs/RFC-0019/evidence_artifacts/EVID-0016.yaml#evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
      - "AGENT_REVIEWER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
      - "DOMAIN_BUILD_RELEASE"
      - "DOMAIN_SECURITY"
  dependencies:
    tickets:
      - ticket_id: "TCK-00393"
        reason: "Watchdog fail-closed semantics are required for reliable local FAC gate orchestration."
      - ticket_id: "TCK-00338"
        reason: "Sandbox controls are prerequisite for safe bounded command/test execution."
      - ticket_id: "TCK-00409"
        reason: "Drift/integrity checks should be reused as baseline gates in local FAC execution."
  scope:
    in_scope:
      - "Technology decision: run CI compute on the OVH host via GitHub self-hosted Actions runner(s), while preserving merge queue and required `CI Success` context."
      - "Technology decision: implement FAC gate execution through existing gate/projection stack (`crates/apm2-daemon/src/gate/*`, `crates/apm2-daemon/src/projection/*`) and expose deterministic trigger surface via `apm2 fac` CLI."
      - "Use existing Rust toolchain and test stack (`nightly-2025-12-01`, cargo-nextest with `.config/nextest.toml` profile `ci`) as the authoritative test execution path."
      - "Use Linux cgroup v2 controls for bounded execution (CPU/memory/pids/time) using existing cgroup telemetry/runtime primitives."
      - "Use fail-closed safety guards in `scripts/ci/` to block destructive test patterns before execution."
      - "Add workspace integrity guard that fails if tracked repository content mutates outside expected scope after tests."
      - "Add watchdog behavior for hung tests and rogue long-running processes with explicit failing verdict and artifacted logs."
      - "Add deterministic flaky-test policy (bounded retry + explicit quarantine state) that cannot silently promote success."
      - "Project FAC gate verdicts and receipts to GitHub status contexts used by merge queue; GitHub remains projection-only."
    out_of_scope:
      - "Immediate full removal of GitHub merge queue."
      - "Global multi-node FAC scheduler; this ticket is single-node local execution."
      - "Rewriting all existing tests."
      - "Replacing all legacy CI workflows in one cutover."
  plan:
    steps:
      - "Update `.github/workflows/ci.yml` to run primary gates on self-hosted OVH runner labels (for example `[self-hosted, linux, x64, fac-ovh]`) while keeping `pull_request` and `merge_group` triggers."
      - "Keep/verify required status contract: `CI Success` on `main`, merge queue required, and `merge_group` check emission."
      - "Implement `scripts/ci/test_safety_guard.sh` to fail on dangerous patterns in test code (for example destructive filesystem operations, unbounded shell invocations, unsafe recursive deletes) with allowlist file support (`scripts/ci/test_safety_allowlist.txt`)."
      - "Implement `scripts/ci/workspace_integrity_guard.sh` to snapshot tracked repository state before tests and fail if post-test tracked content changes unexpectedly."
      - "Implement `scripts/ci/run_bounded_tests.sh` wrapper to execute `cargo nextest run --workspace --all-features --config-file .config/nextest.toml --profile ci` under hard limits (timeout + cgroup/systemd scope + kill escalation)."
      - "Wire bounded test wrapper and both safety guards as blocking CI jobs in `.github/workflows/ci.yml`; include them in `ci-success` dependencies."
      - "Add/extend FAC gate trigger path in `crates/apm2-cli/src/commands/fac.rs` for deterministic local gate execution entrypoint (`fac check`, superseded by `fac gates` in TCK-00436)."
      - "Use `crates/apm2-daemon/src/gate/orchestrator.rs` for gate orchestration and `crates/apm2-daemon/src/projection/github_sync.rs` + `crates/apm2-daemon/src/projection/worker.rs` for status projection mapping to merge-queue-required contexts."
      - "Use cgroup control primitives from `crates/apm2-daemon/src/telemetry/cgroup.rs` and sandbox constraints from `crates/apm2-daemon/src/episode/handlers.rs` (`SandboxConfig`) to enforce containment in gate execution workers."
      - "Add failure-injection tests for: destructive test signature blocked, hung test terminated, cgroup limit breach fails gate, projection idempotency preserved, and flaky-test quarantine path."
      - "Document operator runbook (service bootstrap, runner labels, limits, failure triage) in a FAC runbook doc."
      - "Run cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings && cargo doc --workspace --no-deps && cargo test --workspace."
  definition_of_done:
    evidence_ids:
      - "EVID-0006"
      - "EVID-0011"
      - "EVID-0016"
    criteria:
      - "At least one PR SHA and one merge-group SHA complete local gate execution on self-hosted OVH runners with durable receipt artifacts."
      - "`CI Success` remains the required branch gate and includes new blocking jobs: test safety guard, workspace integrity guard, bounded test runner."
      - "Destructive test signatures are blocked pre-execution by `scripts/ci/test_safety_guard.sh` with deterministic output."
      - "Hung/runaway tests are terminated by watchdog/timeout policy and emit explicit failing gate verdicts with artifacts."
      - "CPU/memory/pids/time ceilings are enforced during test execution and covered by automated failure-injection tests."
      - "Workspace integrity guard fails when tracked repository content mutates unexpectedly after tests."
      - "Projection contexts used by merge queue are written from FAC local results and are idempotent across retries/restarts."
      - "Admission decisioning does not depend on GitHub read state; GitHub remains projection-only."
  notes:
    context: |
      This ticket operationalizes the FAC throughput direction for immediate deployment:
      local gate execution on the OVH node, with GitHub retained only as projection
      and merge-queue surface.

      It also addresses a show-stopping historical failure mode where tests can be
      destructive, runaway, or flaky (including past incidents that damaged the repo).
      The safety model must be fail-closed, bounded, and auditable.
    technology_profile: |
      - Compute substrate: OVH node, Linux, GitHub self-hosted Actions runner service.
      - Gate orchestration runtime: `crates/apm2-daemon/src/gate/orchestrator.rs`.
      - Projection adapter: `crates/apm2-daemon/src/projection/github_sync.rs` + projection worker.
      - FAC operator surface: `crates/apm2-cli/src/commands/fac.rs`.
      - Test runner: cargo-nextest (`.config/nextest.toml`, profile `ci`).
      - Resource containment: cgroup v2 primitives in `crates/apm2-daemon/src/telemetry/cgroup.rs`.
      - Execution sandbox: `SandboxConfig` in `crates/apm2-daemon/src/episode/handlers.rs`.
      - CI guardrail scripts: `scripts/ci/*.sh`.
    constraints: |
      - Preserve `CI Success` required context on `main`.
      - Preserve `merge_group` trigger contract for merge queue admission.
      - Maintain fail-closed semantics for missing sandbox/limit/watchdog controls.
      - Keep truth authority in ledger/CAS receipts; GitHub is projection output only.
      - Use repository toolchain baseline (`rust-toolchain.toml`, nightly-2025-12-01).
      - Use deterministic bounded test settings from `.config/nextest.toml` unless explicitly ratified.
      - No shared mutable build output across concurrent isolated workspaces in this ticket scope.
    amendments:
      - amendment_id: "AMD-2026-02-16-FAC-THROUGHPUT-PIVOT"
        summary: "Containment ceilings remain mandatory, but low fixed throughput defaults are no longer normative for high-capacity hosts."
        supersedes:
          - "Interpretation that bounded runner defaults should always operate at conservative CPU throughput."
        replacement:
          - "Bounded controls are security containment primitives."
          - "Throughput defaults are selected by host-aware profile with queue admission to manage contention."
    files: |
      - crates/apm2-daemon/src/gate/mod.rs
      - crates/apm2-daemon/src/gate/orchestrator.rs
      - crates/apm2-daemon/src/projection/mod.rs
      - crates/apm2-daemon/src/projection/worker.rs
      - crates/apm2-daemon/src/projection/github_sync.rs
      - crates/apm2-daemon/src/telemetry/cgroup.rs
      - crates/apm2-daemon/src/episode/handlers.rs
      - crates/apm2-core/src/webhook/
      - crates/apm2-cli/src/commands/fac.rs
      - .github/workflows/ci.yml
      - scripts/ci/legacy_ipc_guard.sh
      - scripts/ci/test_safety_guard.sh
      - scripts/ci/workspace_integrity_guard.sh
      - scripts/ci/run_bounded_tests.sh
      - scripts/ci/test_safety_allowlist.txt
      - documents/reviews/CODE_QUALITY_PROMPT.md
    security: |
      - Test execution must occur in isolated, least-privilege environments with explicit resource ceilings.
      - Any missing safety control (sandbox, timeout, integrity check, receipt persistence) must fail closed.
      - Admission truth remains CAS/ledger receipts; GitHub statuses are projection outputs only.

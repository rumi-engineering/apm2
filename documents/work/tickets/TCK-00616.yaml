ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00616"
    title: "ITP lease: ruleset drift remediation, gates-before-push ordering, projection demotion"
    status: "IN_PROGRESS"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: []
    evidence_artifacts:
      - "EXEC-2026-02-17-RULESET-SYNC"
      - "EXEC-2026-02-17-GATES-BEFORE-PUSH"
      - "EXEC-2026-02-17-FAC-STATUS-PROJECTION"
      - "EXEC-2026-02-17-RULESET-SYNC-HARDENING"
      - "EXEC-2026-02-17-PROJECTION-CONTEXT-ALIGNMENT"
      - "EXEC-2026-02-17-PUSH-ATTEMPT-RULESET-STAGE"
      - "EXEC-2026-02-17-E2E-REHEARSAL"
      - "EXEC-2026-02-17-WORKSPACE-VALIDATION"
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME", "DOMAIN_SECURITY", "DOMAIN_CI"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00614"
        reason: "Builds on queued-gates fail-closed hardening and push queue integration."
  root_cause_analysis:
    summary: |
      DRIFT OBSERVED 2026-02-17:

      Local source file (.github/rulesets/protect-main.json) requires only
      `apm2 / Forge Admission Cycle`. Live GitHub ruleset FAC + Barrier Admission
      (id 12586011) requires both `Guardian Intelligence / Barrier` and
      `apm2 / Forge Admission Cycle`.

      Policy drift between local-authoritative ruleset definition and live GitHub
      state means merge gates may be more or less restrictive than intended.
      Additionally, `fac push` currently pushes before gates pass, meaning failed
      gates still produce remote side effects.

      Current assessment: YELLOW. Safe enough to continue cautiously, but policy
      drift and push-before-gates behavior must be resolved before resuming
      high-throughput orchestration.

scope:
  in_scope:
    - id: "S1_LOCAL_RULESET_AUTHORITATIVE"
      title: "Make local ruleset file authoritative (Option B)"
      detail: |
        Codify in code and docs that .github/rulesets/protect-main.json is the
        single source of truth for required status contexts. Live GitHub ruleset
        is a projection of this file, not the other way around.

    - id: "S2_RULESET_SYNC_CLI"
      title: "Add ruleset sync to CLI"
      detail: |
        Implement sync command or pre-push hook:
        - Read .github/rulesets/protect-main.json.
        - Fetch live GitHub ruleset via API.
        - Apply live update when drift is detected.
        - Fail closed if sync cannot be verified.

    - id: "S3_REMOVE_BARRIER_REQUIRED"
      title: "Remove Barrier from required live contexts"
      detail: |
        Remove `Guardian Intelligence / Barrier` from the required status contexts
        in the live GitHub ruleset. Keep it optional/informational if desired.

    - id: "S4_GATES_BEFORE_PUSH"
      title: "Reorder fac push: gates run first, then git push"
      detail: |
        Reorder fac push flow:
        HEAD capture -> queued gates -> pass -> git push -> PR update -> review dispatch.
        If gates fail, no remote push happens. No remote side effects on gate failure.

    - id: "S5_PROJECTION_COMPATIBILITY_ONLY"
      title: "Demote GitHub projection to compatibility-only"
      detail: |
        Local forge completion is authoritative for orchestration decisions.
        GitHub status posting is best-effort and non-authoritative for local
        orchestration logic. Projection failures must not block local progress.

    - id: "S6_REGRESSION_TESTS"
      title: "Add regression tests for drift, ordering, and projection"
      detail: |
        Add tests covering:
        - Ruleset sync diff detection.
        - Push ordering (no push before gate pass).
        - Gate failure prevents remote push side effects.
        - Required-context projection checks remain fail-closed where still used.

    - id: "S7_E2E_REHEARSAL"
      title: "End-to-end rehearsal PR"
      detail: |
        Run one end-to-end rehearsal PR:
        - Failing change confirms "no push on failed gates".
        - Passing change confirms normal push/review/merge path.

  out_of_scope:
    - "Changing GitHub auto-merge policy semantics directly."
    - "Redesigning the FAC protocol itself."
    - "Adding new gate types beyond what exists."

plan:
  steps:
    - id: "STEP_01"
      title: "Codify local-authoritative ruleset policy"
      detail: "Document and enforce that .github/rulesets/protect-main.json is the single source of truth."
    - id: "STEP_02"
      title: "Implement ruleset sync in CLI"
      detail: "Read local ruleset, fetch live GitHub ruleset, diff, apply update, fail closed on verification failure."
    - id: "STEP_03"
      title: "Remove Barrier from required contexts"
      detail: "Update live GitHub ruleset to remove Guardian Intelligence / Barrier from required status contexts."
    - id: "STEP_04"
      title: "Reorder fac push to gates-before-push"
      detail: "HEAD capture -> queued gates -> pass -> git push -> PR update -> review dispatch. Gate failure = no push."
    - id: "STEP_05"
      title: "Demote GitHub projection to compatibility-only"
      detail: "Local forge completion authoritative. GitHub status posting best-effort and non-authoritative."
    - id: "STEP_06"
      title: "Add regression tests"
      detail: "Ruleset sync diff detection, push ordering, gate failure side-effect prevention, projection fail-closed checks."
    - id: "STEP_07"
      title: "Run end-to-end rehearsal PR"
      detail: "Failing change = no push. Passing change = normal push/review/merge."
    - id: "STEP_08"
      title: "Run full workspace validation"
      detail: |
        Validate with:
        - `cargo fmt --all`
        - `cargo clippy --workspace --all-targets --all-features -- -D warnings`
        - `cargo doc --workspace --no-deps`
        - `cargo test --workspace`

definition_of_done:
  evidence_ids:
    - "EXEC-2026-02-17-RULESET-SYNC"
    - "EXEC-2026-02-17-GATES-BEFORE-PUSH"
    - "EXEC-2026-02-17-FAC-STATUS-PROJECTION"
    - "EXEC-2026-02-17-E2E-REHEARSAL"
    - "EXEC-2026-02-17-WORKSPACE-VALIDATION"
  criteria:
    - "Local ruleset file is documented and enforced as single source of truth."
    - "CLI ruleset sync detects drift, applies updates, and fails closed on verification failure."
    - "Barrier removed from required live contexts."
    - "`fac push` runs gates before git push; gate failure prevents any remote side effects."
    - "GitHub projection is compatibility-only; local forge completion is authoritative."
    - "When verdict projection resolves to deny, required context `apm2 / Forge Admission Cycle` is projected as GitHub commit status `failure`."
    - "Regression tests pass for drift detection, push ordering, gate failure isolation, and projection checks."
    - "End-to-end rehearsal PR validates both failure and success paths."
    - "Workspace validation commands complete successfully."

notes:
  context: |
    As of 2026-02-17, drift is real between local ruleset definition and live
    GitHub configuration. Current state is yellow: safe enough to continue
    cautiously, but policy drift and push-before-gates behavior must be resolved.
    After steps 2-4 land, assessment moves to green for normal ticket orchestration.

    Execution evidence captured on 2026-02-17:
    - EXEC-2026-02-17-RULESET-SYNC:
      `cargo run -p apm2-cli -- fac pr ruleset-sync --repo guardian-intelligence/apm2`
      (ruleset id 12586011 updated; required status context now only
      `apm2 / Forge Admission Cycle` with strict policy=true).
    - EXEC-2026-02-17-GATES-BEFORE-PUSH:
      `cargo test -p apm2-cli run_pre_push_sequence_with -- --nocapture`
      and `cargo test -p apm2-cli ruleset_sync -- --nocapture`.
    - EXEC-2026-02-17-FAC-STATUS-PROJECTION:
      `cargo run -p apm2-cli -- fac review verdict set --pr 715 --dimension code-quality --verdict deny --reason "FAIL: 2 major findings (Path Traversal Risk, Untyped Errors), 1 minor finding" --json`
      followed by:
      `gh pr view 715 --repo guardian-intelligence/apm2 --json statusCheckRollup`
      and
      `gh api /repos/guardian-intelligence/apm2/commits/a5405ffb5edca920224337c65f444633baa8aeca/status`.
      Result: context `apm2 / Forge Admission Cycle` = `failure` with description
      `Forge Admission Cycle denied`.
    - EXEC-2026-02-17-RULESET-SYNC-HARDENING:
      `cargo test -p apm2-cli ruleset_sync -- --nocapture`.
      Result: symlink rejection, repo-root path boundary checks, local bounded-file read,
      and bounded GitHub response decode assertions pass.
    - EXEC-2026-02-17-PROJECTION-CONTEXT-ALIGNMENT:
      `cargo test -p apm2-cli required_status_projection -- --nocapture`.
      Result: lifecycle projection context loading is sourced from local authoritative
      ruleset policy and projects across resolved contexts.
    - EXEC-2026-02-17-PUSH-ATTEMPT-RULESET-STAGE:
      `cargo test -p apm2-cli push_attempt_record_reports_ruleset_sync_failure_stage -- --nocapture`.
      Result: `fac_push_ruleset_sync_failed` now records deterministic failed_stage
      `ruleset_sync` for doctor/remediation routing.
    - EXEC-2026-02-17-E2E-REHEARSAL:
      `cargo test -p apm2-cli run_pre_push_sequence_with_stops_before_remote_side_effects_on_gate_failure -- --nocapture`
      and
      `cargo test -p apm2-cli run_pre_push_sequence_with_enforces_gates_then_ruleset_sync_then_git_push -- --nocapture`.
      Result: fail path stops before `git_push`; success path executes
      `gates -> ruleset_sync -> git_push`.
    - EXEC-2026-02-17-WORKSPACE-VALIDATION:
      `cargo fmt --all`,
      `cargo test -p apm2-cli --test ci_merge_policy_invariants`,
      `cargo test -p apm2-cli`,
      `cargo clippy --workspace --all-targets --all-features -- -D warnings`,
      `cargo doc --workspace --no-deps`,
      `cargo test --workspace`.
  security: "default-deny, fail-closed gate ordering, local-authoritative policy"

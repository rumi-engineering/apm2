ticket_meta:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"
  ticket:
    id: "TCK-00079"
    title: "Fix check --watch Terminal State Handling"
  binds:
    prd_id: "NONE"
    rfc_id: "RFC-0006"
    requirements:
      - requirement_id: "CHECK-001"
        requirement_ref: "documents/rfcs/RFC-0006/01_problem_and_imports.yaml#rfc_local_requirements.requirements[20]"
    evidence_artifacts: []
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_BUILD_RELEASE"
  dependencies:
    tickets: []
  scope:
    in_scope:
      - "Add exit on PrState::Closed with exit code 1"
      - "Add exit on CiStatus::Failure with exit code 1"
      - "Add exit on ReviewStatus::ChangesRequested with exit code 1"
      - "Add 180s default timeout (non-configurable)"
      - "On timeout exit with code 2 and suggest manually restart"
      - "Print clear message indicating why watch exited"
    out_of_scope:
      - "Configurable timeout duration"
      - "Partial success exit codes"
      - "Notification on timeout"
  plan:
    steps:
      - "Add WATCH_TIMEOUT_SECS constant = 180"
      - "Track elapsed time in watch loop using Instant::now()"
      - "Check for terminal states in watch loop"
      - "Exit on PrState::Closed with message and exit code 1"
      - "Exit on CiStatus::Failure with message and exit code 1"
      - "Exit on ReviewStatus::ChangesRequested with message and exit code 1"
      - "Check elapsed time each iteration"
      - "Exit on timeout with code 2 and remediation message"
      - "Message: Timeout after 180s. Suggestion: manually restart slow checks"
      - "Update run() to return Result<ExitCode>"
      - "Verify cargo build succeeds"
      - "Verify cargo test passes"
      - "Verify cargo clippy passes with no warnings"
  definition_of_done:
    evidence_ids: []
    criteria:
      - "check --watch exits on PrState::Closed (exit code 1)"
      - "check --watch exits on CiStatus::Failure (exit code 1)"
      - "check --watch exits on ReviewStatus::ChangesRequested (exit code 1)"
      - "check --watch exits after 180s timeout (exit code 2)"
      - "Timeout message suggests manually restarting slow checks"
      - "Clear message printed for each exit condition"
      - "cargo build succeeds"
      - "cargo test passes"
      - "cargo clippy passes with no warnings"
  notes:
    security: |
      The 180s timeout prevents indefinite hangs that could:
      - Block CI resources indefinitely
      - Leave terminal sessions unattended
      - Mask underlying infrastructure issues
    implementation_details: |
      ```rust
      // xtask/src/tasks/check.rs additions

      use std::time::Instant;
      use std::process::ExitCode;

      /// Watch mode timeout in seconds.
      const WATCH_TIMEOUT_SECS: u64 = 180;

      /// Exit code for watch timeout.
      const EXIT_TIMEOUT: u8 = 2;

      /// Result of watch mode with exit information.
      #[derive(Debug)]
      pub enum WatchExitReason {
          Merged,
          Closed,
          CiFailed(Vec<String>),
          ChangesRequested,
          Timeout,
      }

      impl WatchExitReason {
          pub fn exit_code(&self) -> ExitCode {
              match self {
                  Self::Merged => ExitCode::SUCCESS,
                  Self::Closed | Self::CiFailed(_) | Self::ChangesRequested => {
                      ExitCode::from(1)
                  }
                  Self::Timeout => ExitCode::from(EXIT_TIMEOUT),
              }
          }

          pub fn message(&self) -> String {
              match self {
                  Self::Merged => "PR merged successfully!".to_string(),
                  Self::Closed => "PR was closed without merging.".to_string(),
                  Self::CiFailed(checks) => format!(
                      "CI failed: {}\nFix the failures and push again.",
                      checks.join(", ")
                  ),
                  Self::ChangesRequested => {
                      "Changes requested by reviewer.\n\
                       Address feedback and push again.".to_string()
                  }
                  Self::Timeout => format!(
                      "Timeout after {}s waiting for checks.\n\
                       Suggestion: Manually restart slow checks or investigate CI.",
                      WATCH_TIMEOUT_SECS
                  ),
              }
          }
      }

      // In run() watch loop:
      if watch {
          let start = Instant::now();

          loop {
              let status = check_status(&sh, &branch_name)?;
              print_status(&status);
              display_reviewer_health(&sh)?;

              // Check terminal states
              if status.pr_state == Some(PrState::Merged) {
                  let reason = WatchExitReason::Merged;
                  println!("\n{}", reason.message());
                  return Ok(reason.exit_code());
              }

              if status.pr_state == Some(PrState::Closed) {
                  let reason = WatchExitReason::Closed;
                  println!("\n{}", reason.message());
                  return Ok(reason.exit_code());
              }

              if let Some(CiStatus::Failure(checks)) = &status.ci {
                  let reason = WatchExitReason::CiFailed(checks.clone());
                  println!("\n{}", reason.message());
                  return Ok(reason.exit_code());
              }

              if status.review == Some(ReviewStatus::ChangesRequested) {
                  let reason = WatchExitReason::ChangesRequested;
                  println!("\n{}", reason.message());
                  return Ok(reason.exit_code());
              }

              // Check timeout
              if start.elapsed().as_secs() >= WATCH_TIMEOUT_SECS {
                  let reason = WatchExitReason::Timeout;
                  println!("\n{}", reason.message());
                  return Ok(reason.exit_code());
              }

              println!("\nPolling in 10s... (Ctrl+C to stop)");
              thread::sleep(Duration::from_secs(10));
          }
      }
      ```
    affected_files: |
      Modified: xtask/src/tasks/check.rs (add terminal state handling and timeout)

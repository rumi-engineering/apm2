{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00675",
      "title": "apm2-daemon: extract freeze-aware SQLite ledger polling (legacy+canonical merge) into shared module + standardize canonical event_id padding for cursor correctness",
      "status": "OPEN"
    },
    "binds": {
      "prd_id": "PRD-PLACEHOLDER",
      "rfc_id": "RFC-0020",
      "requirements": [],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER",
        "AGENT_REVIEWER"
      ],
      "responsibility_domains": [
        "DOMAIN_DAEMON",
        "DOMAIN_DATA",
        "DOMAIN_RUNTIME"
      ]
    },
    "dependencies": {
      "tickets": []
    }
  },
  "root_cause_analysis": {
    "summary": "APM2 currently has multiple independent implementations of \"tail the ledger with a durable\ncursor across two schemas\":\n\n  - Projection worker LedgerTailer (crates/apm2-daemon/src/projection/worker.rs)\n    merges legacy `ledger_events` and canonical `events`, synthesizing canonical event_id as\n    `canonical-{seq_id:020}` to preserve lexical ordering.\n\n  - Gate timeout kernel SqliteTimeoutLedgerReader (crates/apm2-daemon/src/gate/timeout_kernel.rs)\n    re-implements its own canonical+legacy queries (8 query functions) and also synthesizes\n    `canonical-{seq_id:020}` (with SQL tie-breaker expression).\n\n  - The general ledger reader path (crates/apm2-daemon/src/ledger.rs canonical_row_to_event)\n    synthesizes `event_id` as `canonical-{seq_id}` (not zero padded), which breaks lexical\n    ordering for seq_id >= 10 and can produce cursor anomalies when timestamps are equal.\n\nThis duplication is already diverging on a load-bearing invariant: cursor ordering requires a\ntotal order (timestamp_ns, event_id) where event_id compares lexicographically in a way that\nmatches canonical seq order. Without a single shared poller + canonical id helper, future\norchestrators will reintroduce subtle cursor bugs (skips, duplicates, non-deterministic replay).\n"
  },
  "scope": {
    "in_scope": [
      {
        "id": "LED-POLL-001",
        "title": "Introduce a single shared freeze-aware poller module",
        "detail": "Create a new daemon module (location is flexible, but MUST be shared across projection and\norchestrator-kernel consumers), e.g.:\n\n  crates/apm2-daemon/src/ledger_poll.rs\n  or crates/apm2-daemon/src/ledger/poll.rs\n\nThe module must provide:\n  - `fn canonical_event_id(seq_id: i64) -> String` that returns `canonical-{seq_id:020}`\n  - `fn canonical_event_id_cmp_sql_expr() -> &'static str` or an inline helper used by\n    prepared statements to compare cursor_event_id against seq_id lexicographically\n    (the current SUBSTR('000...') || CAST(seq_id AS TEXT) approach).\n\n  - A freeze-aware poll function that merges both sources:\n\n      fn poll_events_blocking(\n        conn: &rusqlite::Connection,\n        event_types: &[&str],\n        cursor_ts_ns: i64,\n        cursor_event_id: &str,\n        limit: usize,\n      ) -> Result<Vec<SignedLedgerEvent>, String>\n\n    Semantics:\n      - Reads from legacy `ledger_events` if present.\n      - Reads from canonical `events` if present.\n      - Filters by event_types (SQL `IN (...)`), not per-type queries.\n      - Applies cursor condition:\n          timestamp_ns > cursor_ts\n          OR (timestamp_ns = cursor_ts AND event_id > cursor_event_id)\n        where canonical event_id is the padded synthesized form.\n      - Returns events sorted by (timestamp_ns ASC, event_id ASC) and truncated to `limit`.\n\n  - An async wrapper:\n      async fn poll_events_async(...) -> Result<Vec<SignedLedgerEvent>, String>\n    implemented via `tokio::task::spawn_blocking`, mirroring the pattern used in\n    projection/worker.rs.\n\nNOTE: The shared poller should NOT interpret payloads. It returns raw `SignedLedgerEvent`\n(or `EventEnvelope`) and leaves parsing to domain-specific code.\n"
      },
      {
        "id": "LED-POLL-002",
        "title": "Refactor projection worker LedgerTailer and gate timeout kernel to use shared poller",
        "detail": "Refactor:\n  - crates/apm2-daemon/src/projection/worker.rs:\n      LedgerTailer::{poll_events, poll_events_async} must delegate to shared poller\n      and canonical_event_id helper.\n      Remove duplicate canonical poll SQL.\n\n  - crates/apm2-daemon/src/gate/timeout_kernel.rs:\n      SqliteTimeoutLedgerReader::poll must delegate to shared poller with the union of\n      relevant event_types:\n        - gate_lease_issued\n        - gate.timed_out\n        - gate.receipt / GateReceipt / gate_receipt\n        - gate.all_completed\n      Then map returned SignedLedgerEvent -> TimeoutObservedEvent using existing parse_* helpers.\n      Delete the 8 query_* functions and the manual merge/truncate code.\n\nThe goal is extraction + reuse, not a new framework.\n"
      },
      {
        "id": "LED-POLL-003",
        "title": "Standardize canonical event_id padding across all canonical reads",
        "detail": "Update crates/apm2-daemon/src/ledger.rs:\n  - canonical_row_to_event() must synthesize event_id using the shared helper:\n      event_id = canonical_event_id(seq_id)\n    rather than `format!(\\\"canonical-{seq_id}\\\")`.\n\nEnsure any parsing logic that extracts seq_id from the event_id remains correct with leading zeros.\n"
      },
      {
        "id": "LED-POLL-004",
        "title": "Cursor correctness tests covering padding + merge ordering",
        "detail": "Add tests (preferably near the shared poller module) that cover:\n  - canonical_event_id lexical ordering:\n      canonical-000...009 < canonical-000...010 < canonical-000...100\n  - merged polling across legacy+canonical with same timestamp_ns:\n      ensure stable order and no skips when advancing cursor by the last event.\n\nAdditionally, add a regression test that uses canonical_row_to_event() and asserts it produces\npadded event_id, preventing future regressions.\n"
      },
      {
        "id": "LED-POLL-005",
        "title": "Documentation + enforcement for 'no bespoke canonical/legacy merge pollers'",
        "detail": "Documentation:\n  - Update crates/apm2-daemon/src/projection/AGENTS.md to describe the shared poller as the\n    canonical implementation of freeze-aware cursor tailing.\n  - Add a short module-level doc comment in the new poller module defining the cursor contract.\n\nEnforcement:\n  - Update CODE_QUALITY_PROMPT.cac.json (or via TCK-00678) with an invariant:\n      \"If a PR adds SQL that unions/merges `ledger_events` and `events`, it MUST use the shared\n       poller module. Hand-rolled cursor comparisons or canonical event_id synthesis is a finding.\"\n  - Update safe patterns doc with a greppable rule:\n      \"Use canonical_event_id(seq_id) helper; never format canonical IDs ad-hoc.\"\n"
      }
    ],
    "out_of_scope": [
      "Replacing SQLite with a new store.",
      "Removing the dual-ledger transitional period (legacy vs canonical).",
      "Changing the ledger schema."
    ]
  },
  "implementation_notes": {
    "critical_structural_boundaries": [
      {
        "id": "IMPL-LED-POLL-01",
        "title": "spawn_blocking for rusqlite inside async",
        "detail": "All async callers must use spawn_blocking (or an equivalent offloading mechanism) for rusqlite\noperations. The shared module should provide the async wrapper so orchestrators don't reintroduce\nruntime blocking.\n"
      },
      {
        "id": "IMPL-LED-POLL-02",
        "title": "Cursor total order is a system invariant",
        "detail": "The ordering used for cursor comparison MUST remain the same everywhere:\n  (timestamp_ns, event_id) with event_id lexicographically comparable.\ncanonical_event_id padding is non-negotiable if event_id is used as tie-breaker.\n"
      }
    ]
  },
  "documentation_and_enforcement": {
    "documentation_deliverables": [
      "New shared poller module has module docs stating cursor ordering and canonical ID rules.",
      "Projection and gate docs updated to point to the shared poller as the only allowed merge implementation."
    ],
    "enforcement_deliverables": [
      "Code-quality reviewer invariant added (prompt + safe-patterns entry) banning ad-hoc canonical/legacy merge logic."
    ]
  },
  "plan": {
    "steps": [
      "Create shared poller module with canonical_event_id helper + blocking + async poll APIs.",
      "Refactor projection LedgerTailer to call shared poller.",
      "Refactor gate timeout kernel ledger reader to call shared poller; delete bespoke query_* functions.",
      "Update ledger.rs canonical_row_to_event to use canonical_event_id helper.",
      "Add tests for canonical padding + merge ordering + ledger.rs regression.",
      "Update documentation and reviewer enforcement artifacts."
    ]
  },
  "definition_of_done": {
    "criteria": [
      "Projection worker and gate timeout kernel no longer contain bespoke canonical+legacy merge SQL; they delegate to shared poller.",
      "ledger.rs canonical_row_to_event emits padded canonical event_id.",
      "New tests cover canonical padding ordering and merged polling cursor advancement.",
      "Docs and reviewer invariant exist to prevent future re-introduction of bespoke pollers."
    ]
  },
  "risks": [
    {
      "id": "R-LED-POLL-01",
      "title": "Behavioral drift in polling semantics could affect projection timing",
      "mitigation": "Keep the refactor mechanical: preserve existing SQL predicates and ordering, but centralize them.\nAdd focused tests for ordering and cursor advancement.\n"
    }
  ]
}

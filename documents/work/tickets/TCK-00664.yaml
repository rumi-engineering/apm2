ticket_meta:
  schema_version: '2026-01-29'
  template_version: '2026-01-29'
  ticket:
    id: 'TCK-00664'
    title: 'FAC: Refactor worker orchestration into explicit state machine modules (reduce brittleness, improve crash recovery)'
    status: 'IN_PROGRESS'
  binds:
    prd_id: 'PRD-0001'
    rfc_id: 'RFC-0019'
    requirements:
      - 'REQ-0037'
      - 'REQ-0020'
    evidence_artifacts: []
  custody:
    agent_roles:
      - 'Implementer'
      - 'Reviewer'
    responsibility_domains:
      - 'fac/worker'
      - 'fac/queue'
      - 'fac/lane'
  dependencies:
    tickets:
      - 'TCK-00660' # runtime repair state machine + event-driven activation baseline

context:
  motivation: |
    The worker orchestration logic is spread across a very large file with many intertwined concerns
    (scan lock, admission, claim, lane acquisition, warm execution, gate execution, receipts, reconcile
    hooks, watchdog/heartbeat). This increases the probability of brittle behavior and makes it hard
    to reason about crash recovery and invariants.
  code_evidence:
    - 'crates/apm2-cli/src/commands/fac_worker.rs is >8k LOC and mixes queue I/O, lane logic, execution, and recovery.'
    - 'Several failure paths intentionally leave partially transitioned state (claimed without receipt) and rely on runtime claimed reconcile + startup/doctor convergence.'

problem_statement: |
  Reliability work keeps accumulating as local patches inside fac_worker.rs. Without a clearer
  orchestration model (explicit states + transitions + persisted checkpoints), we will keep
  reintroducing edge-case bugs (stuck claimed, corrupt lanes, inconsistent cleanup) as the feature
  set expands (FESv1 subprocess spawning, cgroup containment, multi-worker scaling).

proposed_change:
  intent: |
    Refactor the worker into a small set of modules with an explicit state machine that:
      - makes the allowed transitions explicit
      - centralizes error handling + classification
      - surfaces where durable state is written (and what crash recovery expects)
      - enables targeted unit tests per transition

state_machine_model:
  states:
    - 'Idle (no job claimed)'
    - 'Claimed(job_id)'
    - 'LaneAcquired(job_id, lane_id)'
    - 'LeasePersisted(job_id, lane_id)'
    - 'Executing(job_id, lane_id)'
    - 'Committing(job_id, lane_id)'
    - 'Completed(job_id, outcome)'
  invariants:
    - 'A job may be in claimed/ IFF state >= Claimed and < Completed.'
    - 'A lane may have a lease IFF state >= LeasePersisted and < Completed.'
    - 'Receipt is the source of truth for terminal outcome; reconcile can repair torn state.'

scope:
  in_scope:
    - id: 'S1'
      description: |
        Delivered in PR #796 (merged to `main` on 2026-02-22); retained for historical traceability.
        Extract modules (behavior-preserving):
          - worker_loop.rs: wake-driven loop, scan lock, watchdog + heartbeat, runtime repair signal handling
          - queue_ops.rs: claim/requeue/move-to-terminal, open_no_follow, flock handling
          - lane_ops.rs: acquire lane, persist/remove lease, lane cleanup, liveness checks
          - execution_ops.rs: warm + gates + stop_revoke execution
          - commit_ops.rs: receipt pipeline + failure handling
    - id: 'S2'
      description: |
        Delivered in PR #796 (merged to `main` on 2026-02-22); retained for historical traceability.
        Implement an explicit orchestration struct:
          - struct WorkerOrchestrator { ... }
          - fn step(&mut self) -> StepOutcome
          - transitions expressed as enums; all filesystem writes go through queue_ops/lane_ops.
    - id: 'S3'
      description: |
        Delivered in PR #796 (merged to `main` on 2026-02-22); retained for historical traceability.
        Introduce a single error taxonomy:
          - enum OrchestrationError { Recoverable, NeedsReconcile, CorruptLane, ... }
          - ensures every error path either:
              * requeues job safely
              * leaves for runtime claimed reconcile via explicit repair signal
              * quarantines lane/job with explicit reason
    - id: 'S4'
      description: |
        Delivered in PR #796 (merged to `main` on 2026-02-22); retained for historical traceability.
        Use existing deterministic reconcile/worker suites to lock in behavior:
          - Existing runtime reconcile and state-machine tests must still pass after refactor.
          - Add at least 3 new unit tests for state transitions.
    - id: 'S5'
      description: |
        Post-merge hardening follow-up for PR #796:
          - make `consume_authority` durable write path atomic and fail-closed under concurrent races
          - eliminate path re-resolution chmod fallback by using fd-based chmod on Unix
          - add regressions for consume idempotency/race behavior and queue dir hardening edges
  out_of_scope:
    - 'Changing queue on-disk format or adding new directories.'
    - 'Rewriting execution backend (systemd/cgroup) â€” separate efforts.'

plan:
  steps:
    - id: 'P1'
      description: 'Introduce modules with minimal movement of code; keep public signatures stable.'
    - id: 'P2'
      description: 'Introduce WorkerOrchestrator with explicit states; migrate main loop to call orchestrator.step().'
    - id: 'P3'
      description: 'Unify error taxonomy and remove ad-hoc string matching (e.g., "no lane available").'
    - id: 'P4'
      description: 'Run deterministic reconcile/worker suites; add new transition unit tests.'
    - id: 'P5'
      description: 'Apply post-merge hardening patches surfaced by FAC review loops and re-run full gates.'


definition_of_done:
  criteria:
    - 'S1-S4 outcomes are present in `main` via merged PR #796 (material LOC reduction + modularized worker).'
    - 'Post-merge hardening deltas (S5) are implemented with deterministic regressions.'
    - 'All existing deterministic worker/reconcile tests + new transition tests pass.'
    - 'All state transitions are explicit and auditable (no hidden partial transitions).'
  evidence_ids:
    - 'EVID-TCK-00664-01: diff shows modularization + LOC reduction'
    - 'EVID-TCK-00664-02: deterministic worker/reconcile transition suites pass'
    - 'EVID-TCK-00664-03: consume_authority atomic create+sync hardening with race regression'
    - 'EVID-TCK-00664-04: fd-based chmod hardening avoids path re-resolution on Unix'

notes:
  risk:
    - 'Large refactor can destabilize; must be protected by deterministic tests and done incrementally.'
  guiding_principle: |
    Prefer making illegal states unrepresentable in code. Where the filesystem can contain illegal
    states (crash), isolate recovery logic in runtime claimed reconcile and startup/doctor repair
    boundaries, and keep it testable.

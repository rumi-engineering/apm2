ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00486"
    title: "Ledger namespace isolation for authoritative policy-root derivation"
    status: "OPEN"
  binds:
    prd_id: "PRD-0010"
    rfc_id: "RFC-0028"
    requirements:
      - requirement_id: "REQ-0004"
        requirement_ref: "documents/rfcs/RFC-0028/requirements/REQ-0004.yaml#requirement"
    evidence_artifacts:
      - evidence_id: "EVID-0004"
        artifact_ref: "documents/rfcs/RFC-0028/evidence_artifacts/EVID-0004.yaml#evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
      - "AGENT_REVIEWER"
    responsibility_domains:
      - "DOMAIN_SECURITY"
      - "DOMAIN_RUNTIME"
      - "DOMAIN_GOVERNANCE"
  dependencies:
    tickets:
      - ticket_id: "TCK-00465"
        reason: "Boundary-flow integrity establishes the policy-root binding surfaces that need isolation."
  scope:
    in_scope:
      - "Problem: resolve_policy_root_digest_from_ledger() reads get_latest_event() and accepts any policy_hash-like field from ANY event type. EmitEvent permits session-originated payloads into the same ledger. A session can write an event carrying a chosen digest to satisfy the policy-root comparison. This finding has recurred in 6+ review rounds."
      - "Introduce trusted event type namespace: governance/policy events (policy_root_published, policy_updated) are a distinct event class from session-originated events (tool_actuated, session_started, etc.)."
      - "resolve_authoritative_policy_root_digest must ONLY read from trusted governance event types. Session-originated event types are rejected from this lookup path."
      - "Governance events must be signed by the daemon's governance key (or policy-root key), not session keys. Signature provenance check is mandatory."
      - "Remove broker-local fallback: when ledger-rooted policy root is unavailable, return None and deny (fail-closed). The self-referential 'compare broker hash to broker hash' pattern must be eliminated."
      - "PCAC integration: AJC join input capability_manifest_hash and freshness bindings should chain to the ledger-rooted policy root, not the broker-derived one."
    out_of_scope:
      - "Ledger hash-chain signature verification (TCK-00487)."
      - "Declassification receipt consumption changes (TCK-00485)."
      - "Full governance event schema design (future RFC)."
  plan:
    steps:
      - "Define EventTypeClass enum or equivalent: Governance vs Session vs System. Add class field to ledger event schema."
      - "Tag existing governance-relevant events (policy_root_published, gate_configuration_updated, etc.) as Governance class."
      - "Modify resolve_authoritative_policy_root_digest: query only Governance-class events, verify signature provenance against governance/policy-root key."
      - "Remove broker-local fallback from resolve_authoritative_policy_root_digest. On missing/unresolvable governance event, return None."
      - "Modify tool_decision_policy_verified: when authoritative policy root is None, set policy_ledger_verified = false and deny for boundary-enforced tiers."
      - "Update PCAC join input construction: use ledger-rooted policy root for capability_manifest_hash chain."
      - "Add tests: (a) session-originated event with policy_hash field does NOT satisfy policy-root lookup, (b) governance event with valid signature satisfies lookup, (c) governance event with invalid/missing signature fails closed, (d) missing governance event causes deny, (e) broker-local value never used as authoritative source."
      - "Run mandatory pre-commit checks."
  definition_of_done:
    evidence_ids:
      - "EVID-0004"
    criteria:
      - "Policy-root derivation reads ONLY from trusted governance event types with verified signature provenance."
      - "Session-originated events cannot influence policy-root lookup regardless of payload content."
      - "Broker-local fallback eliminated; missing governance state fails closed."
      - "PCAC join inputs chain to ledger-rooted policy root."
      - "This finding class does not recur in subsequent security reviews."
  notes:
    security: |
      This is the most persistent finding in PR #594 — it has recurred across 6+ review rounds
      because each fix attempt addressed the symptom (comparison logic) rather than the root cause
      (the ledger doesn't distinguish trusted governance events from session-originated events).

      Root cause: The ledger is a flat namespace. Any event type can carry any field name.
      resolve_policy_root_digest_from_ledger() has no way to know whether the event it reads
      was emitted by a trusted governance path or by an arbitrary session. The fix must be
      structural: event type classification + signature provenance verification.

      This is NOT a PCAC problem — PCAC is downstream. PCAC trusts the policy root it's given.
      If the policy root is spoofable, PCAC enforces a forged policy.
    verification: |
      Adversarial test: emit a session event with a field named policy_hash containing an
      attacker-chosen digest. Verify that resolve_authoritative_policy_root_digest does NOT
      return this digest. This is the exact exploit path described in the security review.

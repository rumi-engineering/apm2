ticket_meta:
  schema_version: "2026-01-24"
  template_version: "2026-01-24"
  ticket:
    id: "TCK-00055"
    title: "Fix CI failure detection in xtask check"
  binds:
    prd_id: "NONE"
    rfc_id: "RFC-0005"
    requirements:
      - requirement_id: "MAINT-001"
        requirement_ref: "documents/rfcs/RFC-0005/01_problem_and_imports.yaml#rfc_local_requirements.requirements[0]"
    evidence_artifacts: []
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_BUILD_RELEASE"
  dependencies:
    tickets: []
  scope:
    in_scope:
      - "Add CheckRun struct with serde derives for JSON parsing"
      - "Replace string matching with serde_json deserialization in get_ci_status()"
      - "Handle conclusion field values: SUCCESS, FAILURE, CANCELLED, TIMED_OUT, SKIPPED, NEUTRAL, ACTION_REQUIRED, null"
      - "Handle state field values: PENDING, IN_PROGRESS, QUEUED, COMPLETED"
      - "Return appropriate CiStatus based on parsed data"
      - "Add unit tests for JSON parsing edge cases"
      - "Handle gh CLI warnings before JSON output gracefully"
    out_of_scope:
      - "Changes to other xtask commands"
      - "GitHub API changes"
      - "Branch protection rule changes"
  plan:
    steps:
      - "Define CheckRun struct with name, state, conclusion fields"
      - "Add serde derives: Deserialize, Debug"
      - "Make conclusion field Option<String> to handle null values"
      - "Replace string matching logic with serde_json::from_str::<Vec<CheckRun>>()"
      - "Iterate parsed checks to determine overall status"
      - "If any check has conclusion=FAILURE, return CiStatus::Failed"
      - "If any check has state != COMPLETED, return CiStatus::Running"
      - "If all checks have conclusion=SUCCESS, return CiStatus::Passed"
      - "Add unit tests for: empty array, null conclusion, missing fields, FAILURE case"
      - "Test with actual PR to verify fix"
  definition_of_done:
    evidence_ids: []
    criteria:
      - "cargo xtask check correctly identifies failed CI checks"
      - "Output shows '[X] CI checks failed' when CI has failed"
      - "Exit code is non-zero when CI has failed"
      - "JSON parsing handles missing/optional fields gracefully"
      - "No 'Unknown JSON field' warnings in output"
      - "cargo build succeeds"
      - "cargo test passes"
      - "cargo clippy passes with no warnings"
  notes:
    security: "No security impact - read-only status checking"
    root_cause: "String matching on JSON output is fragile; serde deserialization is robust"
    affected_file: "xtask/src/tasks/check.rs lines 215-248 (get_ci_status function)"

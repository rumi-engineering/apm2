{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00616",
      "title": "ITP lease: ruleset drift remediation, gates-before-push ordering, projection demotion",
      "status": "MERGED",
      "merge_evidence": [
        {
          "pr": 718,
          "merge_commit": "90ffcdc5a712f2c5632ca94fd9c6a87295e043d9",
          "merged_at": "2026-02-17T09:03:33Z"
        }
      ]
    },
    "binds": {
      "prd_id": "PRD-PLACEHOLDER",
      "rfc_id": "RFC-0019",
      "requirements": [],
      "evidence_artifacts": [
        "EXEC-2026-02-17-RULESET-SYNC",
        "EXEC-2026-02-17-GATES-BEFORE-PUSH",
        "EXEC-2026-02-17-FAC-STATUS-PROJECTION",
        "EXEC-2026-02-17-RULESET-SYNC-HARDENING",
        "EXEC-2026-02-17-PROJECTION-CONTEXT-ALIGNMENT",
        "EXEC-2026-02-17-PUSH-ATTEMPT-RULESET-STAGE",
        "EXEC-2026-02-17-REVIEWER-STARTUP-HARDENING",
        "EXEC-2026-02-17-E2E-REHEARSAL",
        "EXEC-2026-02-17-WORKSPACE-VALIDATION"
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_SECURITY",
        "DOMAIN_CI"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00614",
          "reason": "Builds on queued-gates fail-closed hardening and push queue integration."
        }
      ]
    },
    "root_cause_analysis": {
      "summary": "DRIFT OBSERVED 2026-02-17:\n\nLocal source file (.github/rulesets/protect-main.json) requires only\n`apm2 / Forge Admission Cycle`. Live GitHub ruleset FAC + Barrier Admission\n(id 12586011) requires both `Guardian Intelligence / Barrier` and\n`apm2 / Forge Admission Cycle`.\n\nPolicy drift between local-authoritative ruleset definition and live GitHub\nstate means merge gates may be more or less restrictive than intended.\nAdditionally, `fac push` currently pushes before gates pass, meaning failed\ngates still produce remote side effects.\n\nCurrent assessment: YELLOW. Safe enough to continue cautiously, but policy\ndrift and push-before-gates behavior must be resolved before resuming\nhigh-throughput orchestration.\n",
      "incidents": [
        {
          "id": "INC-2026-02-17-PR726-MERGE-PAST-DENIAL",
          "severity": "SEV-1",
          "pr": 726,
          "title": "PR #726 merged despite blocking FAC security denial verdict",
          "timeline": [
            {
              "at": "2026-02-17T19:25:50Z",
              "event": "Evidence gates pass (clippy, doc, test, rustfmt, workspace_integrity, merge_conflict_main)"
            },
            {
              "at": "2026-02-17T19:28:03Z",
              "event": "PR merged by Anveio — FAC commit status not yet posted on commit"
            },
            {
              "at": "2026-02-17T19:31:34Z",
              "event": "FAC security denial verdict projected as commit status failure — 3 minutes AFTER merge"
            }
          ],
          "root_cause": "Two compounding failures:\n1. Push-before-gates ordering: code was pushed and PR became merge-eligible\n   before the security review verdict was projected as a GitHub commit status.\n   The denial arrived 3 minutes after merge had already completed.\n2. Non-strict status policy: ruleset had `strict_required_status_checks_policy: false`,\n   which means GitHub treats absent/pending required status checks as \"allow merge\"\n   instead of \"block merge\". Since the FAC status did not exist on the commit at\n   merge time, GitHub did not block.\n",
          "remediation_applied": [
            {
              "at": "2026-02-17T19:40:22Z",
              "action": "Set strict_required_status_checks_policy=true on ruleset 12586011 via GitHub API",
              "effect": "Absent/pending FAC status now blocks merge. Race window closed for future PRs."
            }
          ],
          "remaining_gap": "Strict policy closes the absent-status race window, but the fundamental\npush-before-gates ordering (S4) still means there is a window where code\nis pushed and a PR exists before gates/review verdict is projected.\nS4 (gates-before-push) eliminates this window entirely.\n"
        }
      ]
    }
  },
  "scope": {
    "in_scope": [
      {
        "id": "S1_LOCAL_RULESET_AUTHORITATIVE",
        "title": "Make local ruleset file authoritative (Option B)",
        "detail": "Codify in code and docs that .github/rulesets/protect-main.json is the\nsingle source of truth for required status contexts. Live GitHub ruleset\nis a projection of this file, not the other way around.\n"
      },
      {
        "id": "S2_RULESET_SYNC_CLI",
        "title": "Add ruleset sync to CLI",
        "detail": "Implement sync command or pre-push hook:\n- Read .github/rulesets/protect-main.json.\n- Fetch live GitHub ruleset via API.\n- Apply live update when drift is detected.\n- Fail closed if sync cannot be verified.\n"
      },
      {
        "id": "S3_REMOVE_BARRIER_REQUIRED",
        "title": "Remove Barrier from required live contexts",
        "detail": "Remove `Guardian Intelligence / Barrier` from the required status contexts\nin the live GitHub ruleset. Keep it optional/informational if desired.\n"
      },
      {
        "id": "S4_GATES_BEFORE_PUSH",
        "title": "Reorder fac push: gates run first, then git push",
        "detail": "Reorder fac push flow:\nHEAD capture -> queued gates -> pass -> git push -> PR update -> review dispatch.\nIf gates fail, no remote push happens. No remote side effects on gate failure.\n"
      },
      {
        "id": "S5_PROJECTION_COMPATIBILITY_ONLY",
        "title": "Demote GitHub projection to compatibility-only",
        "detail": "Local forge completion is authoritative for orchestration decisions.\nGitHub status posting is best-effort and non-authoritative for local\norchestration logic. Projection failures must not block local progress.\n"
      },
      {
        "id": "S6_REGRESSION_TESTS",
        "title": "Add regression tests for drift, ordering, and projection",
        "detail": "Add tests covering:\n- Ruleset sync diff detection.\n- Push ordering (no push before gate pass).\n- Gate failure prevents remote push side effects.\n- Required-context projection checks remain fail-closed where still used.\n"
      },
      {
        "id": "S7_E2E_REHEARSAL",
        "title": "End-to-end rehearsal PR",
        "detail": "Run one end-to-end rehearsal PR:\n- Failing change confirms \"no push on failed gates\".\n- Passing change confirms normal push/review/merge path.\n"
      }
    ],
    "out_of_scope": [
      "Changing GitHub auto-merge policy semantics directly.",
      "Redesigning the FAC protocol itself.",
      "Adding new gate types beyond what exists."
    ]
  },
  "plan": {
    "steps": [
      {
        "id": "STEP_01",
        "title": "Codify local-authoritative ruleset policy",
        "detail": "Document and enforce that .github/rulesets/protect-main.json is the single source of truth."
      },
      {
        "id": "STEP_02",
        "title": "Implement ruleset sync in CLI",
        "detail": "Read local ruleset, fetch live GitHub ruleset, diff, apply update, fail closed on verification failure."
      },
      {
        "id": "STEP_03",
        "title": "Remove Barrier from required contexts",
        "detail": "Update live GitHub ruleset to remove Guardian Intelligence / Barrier from required status contexts."
      },
      {
        "id": "STEP_04",
        "title": "Reorder fac push to gates-before-push",
        "detail": "HEAD capture -> queued gates -> pass -> git push -> PR update -> review dispatch. Gate failure = no push."
      },
      {
        "id": "STEP_05",
        "title": "Demote GitHub projection to compatibility-only",
        "detail": "Local forge completion authoritative. GitHub status posting best-effort and non-authoritative."
      },
      {
        "id": "STEP_06",
        "title": "Add regression tests",
        "detail": "Ruleset sync diff detection, push ordering, gate failure side-effect prevention, projection fail-closed checks."
      },
      {
        "id": "STEP_07",
        "title": "Run end-to-end rehearsal PR",
        "detail": "Failing change = no push. Passing change = normal push/review/merge."
      },
      {
        "id": "STEP_08",
        "title": "Run full workspace validation",
        "detail": "Validate with:\n- `cargo fmt --all`\n- `cargo clippy --workspace --all-targets --all-features -- -D warnings`\n- `cargo doc --workspace --no-deps`\n- `cargo test --workspace`\n"
      }
    ]
  },
  "definition_of_done": {
    "evidence_ids": [
      "EXEC-2026-02-17-RULESET-SYNC",
      "EXEC-2026-02-17-GATES-BEFORE-PUSH",
      "EXEC-2026-02-17-FAC-STATUS-PROJECTION",
      "EXEC-2026-02-17-E2E-REHEARSAL",
      "EXEC-2026-02-17-WORKSPACE-VALIDATION"
    ],
    "criteria": [
      "Local ruleset file is documented and enforced as single source of truth.",
      "CLI ruleset sync detects drift, applies updates, and fails closed on verification failure.",
      "Barrier removed from required live contexts.",
      "`fac push` runs gates before git push; gate failure prevents any remote side effects.",
      "GitHub projection is compatibility-only; local forge completion is authoritative.",
      "When verdict projection resolves to deny, required context `apm2 / Forge Admission Cycle` is projected as GitHub commit status `failure`.",
      "Regression tests pass for drift detection, push ordering, gate failure isolation, and projection checks.",
      "End-to-end rehearsal PR validates both failure and success paths.",
      "Workspace validation commands complete successfully."
    ]
  },
  "notes": {
    "context": "As of 2026-02-17, drift is real between local ruleset definition and live\nGitHub configuration. Current state is yellow: safe enough to continue\ncautiously, but policy drift and push-before-gates behavior must be resolved.\nAfter steps 2-4 land, assessment moves to green for normal ticket orchestration.\n\nExecution evidence captured on 2026-02-17:\n- EXEC-2026-02-17-RULESET-SYNC:\n  `cargo run -p apm2-cli -- fac pr ruleset-sync --repo guardian-intelligence/apm2`\n  (ruleset id 12586011 updated; required status context now only\n  `apm2 / Forge Admission Cycle` with strict policy=true).\n- EXEC-2026-02-17-GATES-BEFORE-PUSH:\n  `cargo test -p apm2-cli run_pre_push_sequence_with -- --nocapture`\n  and `cargo test -p apm2-cli ruleset_sync -- --nocapture`.\n- EXEC-2026-02-17-FAC-STATUS-PROJECTION:\n  `cargo run -p apm2-cli -- fac review verdict set --pr 715 --dimension code-quality --verdict deny --reason \"FAIL: 2 major findings (Path Traversal Risk, Untyped Errors), 1 minor finding\" --json`\n  followed by:\n  `gh pr view 715 --repo guardian-intelligence/apm2 --json statusCheckRollup`\n  and\n  `gh api /repos/guardian-intelligence/apm2/commits/a5405ffb5edca920224337c65f444633baa8aeca/status`.\n  Result: context `apm2 / Forge Admission Cycle` = `failure` with description\n  `Forge Admission Cycle denied`.\n- EXEC-2026-02-17-RULESET-SYNC-HARDENING:\n  `cargo test -p apm2-cli ruleset_sync -- --nocapture`.\n  Result: symlink rejection, repo-root path boundary checks, local bounded-file read,\n  and bounded GitHub response decode assertions pass.\n- EXEC-2026-02-17-PROJECTION-CONTEXT-ALIGNMENT:\n  `cargo test -p apm2-cli required_status_projection -- --nocapture`.\n  Result: lifecycle projection context loading is sourced from local authoritative\n  ruleset policy and projects across resolved contexts.\n- EXEC-2026-02-17-PUSH-ATTEMPT-RULESET-STAGE:\n  `cargo test -p apm2-cli push_attempt_record_reports_ruleset_sync_failure_stage -- --nocapture`.\n  Result: `fac_push_ruleset_sync_failed` now records deterministic failed_stage\n  `ruleset_sync` for doctor/remediation routing.\n- EXEC-2026-02-17-REVIEWER-STARTUP-HARDENING:\n  `cargo test -p apm2-cli lease_contention_ -- --nocapture`.\n  Result: lease-contention dedupe now requires verified PID + proc_start_time\n  identity match for state-only contention, preventing stale/PID-reuse false\n  dedupe that can suppress reviewer startup.\n- EXEC-2026-02-17-E2E-REHEARSAL:\n  `cargo test -p apm2-cli run_pre_push_sequence_with_stops_before_remote_side_effects_on_gate_failure -- --nocapture`\n  and\n  `cargo test -p apm2-cli run_pre_push_sequence_with_enforces_gates_then_ruleset_sync_then_git_push -- --nocapture`.\n  Result: fail path stops before `git_push`; success path executes\n  `gates -> ruleset_sync -> git_push`.\n- EXEC-2026-02-17-WORKSPACE-VALIDATION:\n  `cargo fmt --all`,\n  `cargo test -p apm2-cli --test ci_merge_policy_invariants`,\n  `cargo test -p apm2-cli`,\n  `cargo clippy --workspace --all-targets --all-features -- -D warnings`,\n  `cargo doc --workspace --no-deps`,\n  `cargo test --workspace`.\n",
    "security": "default-deny, fail-closed gate ordering, local-authoritative policy"
  }
}

{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00342",
      "title": "CLI process management commands: migrate to ProtocolServer IPC",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0009",
      "rfc_id": "RFC-0018",
      "requirements": [
        {
          "requirement_id": "REQ-HEF-0010",
          "requirement_ref": "documents/rfcs/RFC-0018/requirements/REQ-HEF-0010.yaml#rfc_requirement"
        }
      ],
      "evidence_artifacts": [
        {
          "evidence_id": "EVID-HEF-0010",
          "artifact_ref": "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0010.yaml#rfc_evidence_artifact"
        }
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_SECURITY"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00288",
          "reason": "Protocol clients (OperatorClient/SessionClient) implemented there; this ticket completes the migration."
        },
        {
          "ticket_id": "TCK-00287",
          "reason": "ProtocolServer dispatchers must handle process management requests."
        }
      ]
    },
    "scope": {
      "in_scope": [
        "Migrate `apm2 list` to use OperatorClient with new ListProcesses message type.",
        "Migrate `apm2 status <name>` to use OperatorClient with new ProcessStatus message type.",
        "Migrate `apm2 start <name>` to use OperatorClient with new StartProcess message type.",
        "Migrate `apm2 stop <name>` to use OperatorClient with new StopProcess message type.",
        "Migrate `apm2 restart <name>` to use OperatorClient with new RestartProcess message type.",
        "Migrate `apm2 reload <name>` to use OperatorClient with new ReloadProcess message type.",
        "Migrate `apm2 logs <name>` to use SessionClient with new StreamLogs message type.",
        "Add daemon-side handlers in ProtocolServer for all new message types.",
        "Remove stub implementations in crates/apm2-cli/src/commands/process.rs."
      ],
      "out_of_scope": [
        "Legacy JSON IPC support (already removed per DD-009).",
        "New CLI commands beyond existing process management surface."
      ]
    },
    "plan": {
      "steps": [
        "Define protobuf message types for process management (ListProcesses, ProcessStatus, StartProcess, StopProcess, RestartProcess, ReloadProcess, StreamLogs).",
        "Add message type tags to PrivilegedMessageType enum for operator-socket commands.",
        "Add StreamLogs to SessionMessageType for session-socket log streaming.",
        "Implement daemon-side handlers in ProtocolServer dispatcher.",
        "Wire handlers to existing Supervisor methods in DaemonState.",
        "Update OperatorClient with new request methods (list_processes, process_status, start_process, stop_process, restart_process, reload_process).",
        "Update SessionClient with stream_logs method.",
        "Replace stubs in process.rs with actual OperatorClient/SessionClient calls.",
        "Add integration tests for each migrated command."
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-HEF-0010"
      ],
      "criteria": [
        "`apm2 list` returns process list via OperatorClient (no JSON IPC).",
        "`apm2 status <name>` returns process details via OperatorClient.",
        "`apm2 start <name>` starts process via OperatorClient.",
        "`apm2 stop <name>` stops process via OperatorClient.",
        "`apm2 restart <name>` restarts process via OperatorClient.",
        "`apm2 reload <name>` performs rolling restart via OperatorClient.",
        "`apm2 logs <name>` streams logs via SessionClient.",
        "All stubs removed from crates/apm2-cli/src/commands/process.rs.",
        "Integration tests pass for all process management commands."
      ]
    },
    "notes": {
      "security": "Process management commands are privileged operations and MUST use operator.sock\n(mode 0600). Log streaming uses session.sock but requires valid session context.\nCLI must never fall back to JSON IPC.\n",
      "verification": "IT-00342-01: cargo test -p apm2-cli process_list_protocol\nIT-00342-02: cargo test -p apm2-cli process_status_protocol\nIT-00342-03: cargo test -p apm2-cli process_start_protocol\nIT-00342-04: cargo test -p apm2-cli process_stop_protocol\nIT-00342-05: cargo test -p apm2-daemon process_management_handlers\n",
      "context": "TCK-00288 implemented OperatorClient and SessionClient but left process management\ncommands (list, status, start, stop, restart, reload, logs) as stubs returning\n\"CLI requires protobuf migration (DD-009)\". This ticket completes that migration.\n\nCurrent state of crates/apm2-cli/src/commands/process.rs:\n- All functions are stubs that bail with MIGRATION_ERROR\n- No actual IPC calls to daemon\n\nProtocol clients already implemented in crates/apm2-cli/src/client/protocol.rs:\n- OperatorClient: shutdown, claim_work, spawn_episode, issue_capability\n- SessionClient: request_tool, emit_event, publish_evidence\n\nThis ticket adds the missing process management methods to both clients and\nthe corresponding daemon-side handlers.\n"
    }
  }
}

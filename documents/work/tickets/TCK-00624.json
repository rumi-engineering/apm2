{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00624",
      "title": "FAC doctor/review state machine unification with machine-verifiable CAC contract",
      "status": "MERGED"
    },
    "binds": {
      "prd_id": "PRD-PLACEHOLDER",
      "rfc_id": "RFC-0019",
      "requirements": [
        "REQ-0035"
      ],
      "evidence_artifacts": [
        "documents/reviews/fac_review_state_machine.cac.json"
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_CI"
      ]
    },
    "dependencies": {
      "tickets": []
    }
  },
  "root_cause_analysis": {
    "summary": "FAC doctor recommendation logic and wait-loop behavior accumulated into\nscattered conditional branches, which made correctness hard to prove and\nregressions easy to introduce. The resulting bugs included recommending\nreviewer restarts while evidence gates were still running, and delayed\nwait-loop exits for terminal recommended actions.\n\nThis ticket reframes the entire flow as explicit state machines with ordered\ntransition tables, guard predicates, and machine-readable requirement\ntraceability so behavior is deterministic, auditable, and easy to evolve.\n"
  },
  "scope": {
    "in_scope": [
      {
        "id": "DR-001-GATE_FAILURE_REQUIRES_IMPLEMENTOR",
        "title": "Blocking review conditions recommend dispatch_implementor",
        "detail": "Doctor decision states that represent blocking remediation must resolve\nto `dispatch_implementor`:\n  - merge conflicts,\n  - terminal evidence gate failures,\n  - actionable findings requiring implementor remediation.\nRecommendation command templates must direct to findings context.\n"
      },
      {
        "id": "DR-002-RUNNING_GATE_SUPPRESSES_RESTART",
        "title": "In-flight gate progress suppresses reviewer restarts",
        "detail": "Gate progress derivation must classify RUNNING / NOT_RUN gates as\n`in_flight`, and doctor recommendation must return `wait` (not\n`restart_reviews`) when verdicts are pending and gate progress remains\nin-flight.\n"
      },
      {
        "id": "DR-003-TERMINAL_PASS_REQUIRED_FOR_MERGE_READY",
        "title": "Merge readiness requires terminal passed gates",
        "detail": "Merge and approve outcomes must only be reachable when merge-readiness\nfacts are satisfied, including terminal passed gate progress and no\nmerge conflicts.\n"
      },
      {
        "id": "DR-004-DOCTOR_RULE_ORDER_IS_STRICT",
        "title": "Decision/gate/recommendation rules are table-driven and ordered",
        "detail": "Doctor decision, gate progress, and recommendation logic must be derived\nfrom explicit rule tables with unique IDs and strictly increasing\npriority. Evaluation semantics are first-match in priority order.\n"
      },
      {
        "id": "DR-005-WAIT_RETURNS_ON_TERMINAL_ACTION",
        "title": "Wait loop is an explicit state machine with terminal action exit",
        "detail": "`--wait-for-recommended-action` must evaluate transitions through a\ndedicated wait-state machine. Terminal recommended actions (including\n`dispatch_implementor`) must exit immediately by priority, ahead of\ninterrupt/timeout fallback checks.\n"
      },
      {
        "id": "DR-006-EVERGREEN_CAC_STATE_MACHINE_SOURCE",
        "title": "Single evergreen CAC machine-spec artifact",
        "detail": "FAC review machine spec must be published as a canonical evergreen CAC\ndocument at `documents/reviews/fac_review_state_machine.cac.json` and\nreferenced in code as the snapshot/source contract for machine-spec\noutput verification.\n"
      },
      {
        "id": "DR-007-CLI_EXIT_ON_ACTION_SET_IS_CANONICAL",
        "title": "--exit-on actions derive from action policy table",
        "detail": "Supported/default `--exit-on` actions must derive from a single\n`DoctorActionPolicy` table. CLI enum choices and fac_review-supported\nactions must remain aligned via regression test.\n"
      },
      {
        "id": "DR-008-MACHINE_VERIFIABLE_ARTIFACTS",
        "title": "Emit reviewer-grade transition and traceability artifacts",
        "detail": "Produce machine-verifiable outputs that enumerate states, transitions,\nguards, action policy, and requirement-to-test mapping:\n  - canonical CAC machine spec JSON,\n  - embedded machine_traceability section with indexes, coverage, and\n    integrity checks.\n"
      }
    ],
    "out_of_scope": [
      "Legacy ad-hoc branching paths outside FAC doctor/review scope.",
      "Non-FAC command state-machine redesign.",
      "Backwards-compatibility shims for superseded machine-spec file paths."
    ]
  },
  "plan": {
    "steps": [
      {
        "id": "STEP_01",
        "title": "Model FAC doctor, gate progress, wait loop, and lifecycle as explicit machines",
        "detail": "Encode states, guards, priorities, and transitions as static rule tables.\n"
      },
      {
        "id": "STEP_02",
        "title": "Unify recommendation semantics under rule + action-policy tables",
        "detail": "Ensure recommendation action, priority, reason, and command templates are\nderived from a single table; derive wait `--exit-on` behavior from action policy.\n"
      },
      {
        "id": "STEP_03",
        "title": "Publish CAC machine spec and migrate snapshot checks",
        "detail": "Wrap machine bundle in CAC envelope, publish evergreen JSON, and point\ncode snapshot validation to the canonical file.\n"
      },
      {
        "id": "STEP_04",
        "title": "Populate machine-traceability section inside CAC spec",
        "detail": "Embed compact indexes, requirement coverage, decision/recommendation\nmatrix, and integrity checks directly in the canonical CAC JSON.\n"
      },
      {
        "id": "STEP_05",
        "title": "Regression and workspace validation",
        "detail": "cargo fmt --all\ncargo clippy --workspace --all-targets --all-features -- -D warnings\ncargo doc --workspace --no-deps\ncargo test --workspace\n"
      }
    ]
  },
  "definition_of_done": {
    "evidence_ids": [
      "EXEC-TCK00624-STATE-MACHINE-CUTOVER",
      "EXEC-TCK00624-EVERGREEN-CAC-SPEC",
      "EXEC-TCK00624-WORKSPACE-VALIDATION"
    ],
    "criteria": [
      "Doctor, gate progress, wait loop, and lifecycle transitions are represented as explicit rule/state tables.",
      "Running gates no longer permit restart recommendation; doctor returns wait in the in-flight case.",
      "Blocking conditions (merge conflict/gate failure/actionable findings) recommend dispatch_implementor.",
      "--wait-for-recommended-action exits immediately on terminal recommended actions, including dispatch_implementor.",
      "Supported/default --exit-on actions derive from DoctorActionPolicy and are CLI-aligned via test.",
      "Machine spec is published as a single evergreen CAC JSON document with no TCK path coupling.",
      "CAC machine_traceability section enumerates guards, states, transitions, and requirement/test links.",
      "Workspace validation completes successfully."
    ]
  },
  "notes": {
    "context": "This ticket supersedes the prior if-branch-centric framing for FAC doctor\nbehavior with state-machine-first semantics. The implementation is designed\nso recommendation logic remains evolvable by table edits rather than control\nflow rewrites.\n",
    "security": "fail-closed transition semantics; undefined paths resolve through explicit default guards"
  }
}

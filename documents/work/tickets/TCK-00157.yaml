acceptance_criteria:
  - criterion: UDS server listens on XDG_RUNTIME_DIR/apm2/apm2d.sock
    verification: Integration test connects to socket successfully
  - criterion: Length-prefixed binary framing with max 16MB frames
    verification: Unit test verifies frame encoding/decoding
  - criterion: Protocol version negotiation in handshake
    verification: Unit test verifies version mismatch handling
implementation:
  code_examples:
    - description: Frame encoding structure
      code: |
        pub struct Frame {
            pub length: u32,  // 4-byte big-endian
            pub payload: Bytes,
        }

        impl Frame {
            pub const MAX_SIZE: usize = 16 * 1024 * 1024; // 16MB

            pub fn encode(&self, buf: &mut BytesMut) {
                buf.put_u32(self.payload.len() as u32);
                buf.extend_from_slice(&self.payload);
            }
        }
  files_to_create:
    - path: crates/apm2-daemon/src/protocol/framing.rs
      purpose: Length-prefixed frame codec
    - path: crates/apm2-daemon/src/protocol/server.rs
      purpose: UDS server accepting connections
    - path: crates/apm2-daemon/src/protocol/handshake.rs
      purpose: Protocol version negotiation
    - path: crates/apm2-daemon/src/protocol/error.rs
      purpose: Protocol error types
  files_to_modify:
    - changes: Export framing, server, handshake modules
      path: crates/apm2-daemon/src/protocol/mod.rs
  implementation_steps:
    - step: 1
      action: Implement Frame codec
      details: |
        Create tokio_util::codec::Decoder and Encoder implementations for
        length-prefixed framing. Max frame size 16MB. Reject oversized frames
        with FrameTooLarge error.
    - step: 2
      action: Implement UDS server
      details: |
        Create ProtocolServer struct that:
        - Binds to ${XDG_RUNTIME_DIR}/apm2/apm2d.sock
        - Creates directory if needed
        - Accepts connections with tokio::net::UnixListener
        - Spawns connection handler tasks
    - step: 3
      action: Implement handshake protocol
      details: |
        Hello/HelloAck exchange:
        - Client sends Hello with protocol_version, client_info
        - Server validates version compatibility
        - Server sends HelloAck with server_info, policy_hash
        - Version mismatch returns error, closes connection
    - step: 4
      action: Create error types
      details: |
        ProtocolError enum with variants:
        - FrameTooLarge, InvalidFrame, VersionMismatch,
        - HandshakeFailed, ConnectionClosed, Io(io::Error)
  summary: |
    Implement UDS protocol server with length-prefixed framing per AD-DAEMON-002.
    Server listens on XDG_RUNTIME_DIR/apm2/apm2d.sock with binary framing
    and protocol version negotiation.
notes: |
  Phase: PHASE-1A (Protocol Foundation)
  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.
  Maps to TCK-PEND-001.
schema_version: "2026-01-27"
template_version: "2026-01-27"
test_requirements:
  - description: Frame encoding round-trip
    test_id: UT-00157-01
    verification_command: cargo test -p apm2-daemon framing
  - description: Server accepts connection
    test_id: IT-00157-01
    verification_command: cargo test -p apm2-daemon --test integration server_accept
ticket:
  depends_on:
    - TCK-00156
  id: TCK-00157
  requirement_ids:
    - REQ-PROTOCOL-001
  rfc_id: RFC-0013
  status: READY
  title: Implement UDS protocol server with length-prefixed framing

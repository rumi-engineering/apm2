{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-26",
    "template_version": "2026-01-26",
    "ticket": {
      "id": "TCK-00119",
      "title": "Implement run manifest with signing",
      "status": "CLOSED"
    },
    "binds": {
      "rfc_id": "RFC-0010",
      "requirements": [
        {
          "requirement_id": "REQ-0009"
        },
        {
          "requirement_id": "REQ-0012"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00118"
      }
    ]
  },
  "implementation": {
    "summary": "Create the run manifest module to generate cryptographically signed records\nof pipeline execution. Manifests capture input/output hashes, routing decisions,\nstage timings, and are signed with Ed25519 to enable verification and\nreproducibility auditing.\n",
    "files_to_create": [
      {
        "path": "crates/apm2-core/src/run_manifest/mod.rs",
        "purpose": "Module entry point exposing manifest and signer submodules"
      },
      {
        "path": "crates/apm2-core/src/run_manifest/manifest.rs",
        "purpose": "RunManifest struct with all required fields and serialization"
      },
      {
        "path": "crates/apm2-core/src/run_manifest/signer.rs",
        "purpose": "Ed25519 signing and verification using existing crypto module"
      }
    ],
    "files_to_modify": [
      {
        "path": "crates/apm2-core/src/lib.rs",
        "changes": "Add pub mod run_manifest declaration"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Define manifest structure",
        "details": "In manifest.rs:\n- RunManifest struct with fields:\n  - manifest_id: UUID v7 for temporal ordering\n  - lease_id: identifies the pipeline execution session\n  - created_at: ISO 8601 timestamp\n  - input_hashes: map of input artifact paths to BLAKE3 hashes\n  - output_hashes: map of output artifact paths to BLAKE3 hashes\n  - routing_profile_id: which profile was used\n  - routing_decisions: map of stage to provider used\n  - stage_timings: map of stage to duration_ms\n  - ccp_index_hash: hash of CCP index used as grounding\n- Implement Serialize/Deserialize\n\n**UUID v7 generation:**\nUse the `uuid` crate with `v7` feature:\n```toml\n# In Cargo.toml\nuuid = { version = \"1.0\", features = [\"v7\"] }\n```\n```rust\nuse uuid::Uuid;\nlet manifest_id = Uuid::now_v7().to_string();\n```\n"
      },
      {
        "step": 2,
        "action": "Implement manifest builder",
        "details": "In manifest.rs:\n- ManifestBuilder with fluent API\n- Methods: with_lease_id, add_input, add_output, record_stage_timing\n- build() validates all required fields present\n"
      },
      {
        "step": 3,
        "action": "Implement signer",
        "details": "In signer.rs:\n- Reuse existing crypto module for Ed25519 operations\n- sign_manifest(manifest, signing_key) -> SignedManifest\n- SignedManifest includes manifest bytes and signature\n- Canonicalize manifest before signing (deterministic JSON)\n"
      },
      {
        "step": 4,
        "action": "Implement verifier",
        "details": "In signer.rs:\n- verify_manifest(signed_manifest, public_key) -> Result<RunManifest>\n- Verify signature matches manifest bytes\n- Verify all hash fields match expected values when verifying against artifacts\n- Return error on any mismatch\n"
      },
      {
        "step": 5,
        "action": "Wire up module",
        "details": "In mod.rs and lib.rs:\n- Export RunManifest, ManifestBuilder, SignedManifest\n- Export sign_manifest, verify_manifest functions\n"
      }
    ],
    "code_examples": [
      {
        "description": "Manifest structure example",
        "code": "# Example run manifest (unsigned)\nmanifest_id: \"019450a8-b2c4-7000-8000-000000000001\"\nlease_id: \"lease-2026-01-26-001\"\ncreated_at: \"2026-01-26T14:30:00Z\"\ninput_hashes:\n  \"documents/prds/PRD-0005/00_meta.yaml\": \"blake3:abc123...\"\n  \"documents/prds/PRD-0005/requirements/REQ-0001.yaml\": \"blake3:def456...\"\noutput_hashes:\n  \"evidence/prd/PRD-0005/ccp/ccp_index.json\": \"blake3:789xyz...\"\n  \"documents/rfcs/RFC-0010/00_meta.yaml\": \"blake3:uvw012...\"\nrouting_profile_id: \"local\"\nrouting_decisions:\n  ccp_build: \"local\"\n  impact_map: \"anthropic/claude-3-5-sonnet\"\n  rfc_frame: \"anthropic/claude-3-5-sonnet\"\nstage_timings:\n  ccp_build: 2340\n  impact_map: 45230\n  rfc_frame: 67890\nccp_index_hash: \"blake3:abc123...\"\n"
      }
    ]
  },
  "acceptance_criteria": [
    {
      "criterion": "Manifests include all required fields",
      "verification": "Unit tests verify ManifestBuilder enforces required fields and serialization includes all fields"
    },
    {
      "criterion": "Ed25519 signatures verify correctly",
      "verification": "Round-trip tests sign then verify manifests successfully"
    },
    {
      "criterion": "Verification fails on hash mismatch",
      "verification": "Tests with tampered hashes fail verification with specific error"
    }
  ],
  "test_requirements": [
    {
      "test_id": "UT-119-01",
      "description": "Test manifest builder validates required fields",
      "verification_command": "cargo test -p apm2-core run_manifest::manifest::builder"
    },
    {
      "test_id": "UT-119-02",
      "description": "Test manifest serialization roundtrip",
      "verification_command": "cargo test -p apm2-core run_manifest::manifest::serde"
    },
    {
      "test_id": "UT-119-03",
      "description": "Test Ed25519 sign and verify roundtrip",
      "verification_command": "cargo test -p apm2-core run_manifest::signer::roundtrip"
    },
    {
      "test_id": "UT-119-04",
      "description": "Test verification fails on tampered manifest",
      "verification_command": "cargo test -p apm2-core run_manifest::signer::tamper"
    },
    {
      "test_id": "UT-119-05",
      "description": "Test verification fails on hash mismatch",
      "verification_command": "cargo test -p apm2-core run_manifest::signer::hash_mismatch"
    }
  ],
  "notes": "This ticket implements REQ-0009 (reproducibility via manifests) and REQ-0012\n(cryptographic signing) from RFC-0010.\n\nKey design decisions:\n- Manifests use UUID v7 for manifest_id to enable temporal ordering.\n- BLAKE3 is used for content hashing (consistent with determinism module).\n- Ed25519 signing reuses the existing crypto module infrastructure.\n- Manifests are canonicalized (sorted keys, consistent formatting) before\n  signing to ensure deterministic signatures.\n\nCCP grounding: COMP-CORE module, depends on TCK-00118 (model router) for\nrouting decision capture.\n"
}

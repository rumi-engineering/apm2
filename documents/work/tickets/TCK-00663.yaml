ticket_meta:
  schema_version: '2026-01-29'
  template_version: '2026-01-29'
  ticket:
    id: 'TCK-00663'
    title: 'FAC: Fault-injection + recovery test harness for queue/lane orchestration (reproduce stuck-claimed + dead-PID scenarios)'
    status: 'OPEN'
  binds:
    prd_id: 'PRD-0001'
    rfc_id: 'RFC-0019'
    requirements:
      - 'REQ-0020'
      - 'REQ-0037'
    evidence_artifacts: []
  custody:
    agent_roles:
      - 'Implementer'
      - 'Reviewer'
    responsibility_domains:
      - 'fac/tests'
      - 'fac/reconcile'
      - 'fac/worker'
  dependencies:
    tickets:
      - 'TCK-00658'
      - 'TCK-00659'
      - 'TCK-00660'

context:
  why_now: |
    The current failures are intermittent and environment-dependent (PID reuse timing, worker crash
    points, systemd behavior). Without deterministic tests, regressions will recur.

problem_statement: |
  We need a repeatable, deterministic test suite that exercises the queue/lane orchestration failure
  modes reported in the field:
    - jobs stuck in claimed with no worker pickup
    - dead/stale PIDs in lane leases
    - corrupt lanes due to ambiguous liveness
    - worker crash between claim/lease/commit
  These should be tested without relying on real systemd in CI.

proposed_change:
  intent: |
    Add a fault-injection harness that can simulate crash points and liveness conditions using:
      - temp dirs for FAC root/queue root
      - controllable process identity fixtures (spawn child process, record start ticks)
      - dependency-injected command runners for systemctl queries
      - explicit "crash" by dropping state mid-transition

scope:
  in_scope:
    - id: 'S1'
      description: |
        Create a shared test harness module (apm2-core and/or apm2-cli) to build minimal FAC roots:
          - create_fac_root_fixture(lanes=N)
          - write_lease(lane, lease_fields)
          - write_job(queue/pending, spec)
          - move_job_to_claimed(...) helper
          - write_receipt(job_id, outcome)
          - lock_claimed_file(job_id) helper (flock)
    - id: 'S2'
      description: |
        Add deterministic regression tests for the specific failure modes:
          - T1: Claimed orphan job (no active lane) => reconcile_tick moves to pending.
          - T2: Torn state (receipt exists, job still claimed) => reconcile_tick moves to done/denied.
          - T3: PID reuse false positive simulation:
              * Spawn child process P, get pid + start ticks.
              * Create lease with pid=P but WRONG start ticks.
              * Verify lane_status identity mismatch => lease is reclaimable; job is not treated active.
          - T4: Orphaned systemd unit guard (mocked):
              * Create lease with pid dead.
              * Mock systemctl says associated unit active.
              * Verify reconcile/acquire_worker_lane fail-closed (do not reclaim lane).
          - T5: Commit pipeline failure recovery:
              * Leave job in claimed with no receipt.
              * Verify periodic reconcile path requeues (or quarantines) based on policy.
    - id: 'S3'
      description: |
        Add "crash point" tests for the worker write-path (model-based):
          - Simulate crash after rename pending→claimed.
          - Simulate crash after lane lease persisted but before receipt.
          - Simulate crash after receipt persisted but before move claimed→done.
        Each crash point must have a deterministic recovery assertion.
  out_of_scope:
    - 'End-to-end systemd integration tests requiring privileged CI.'

plan:
  steps:
    - id: 'P1'
      description: 'Implement reusable fixture builders + helpers (temp dirs, job/lease writers).'
    - id: 'P2'
      description: 'Add regression tests T1-T5.'
    - id: 'P3'
      description: 'Add crash point model tests; ensure each recovery path is asserted.'


definition_of_done:
  criteria:
    - 'At least 5 deterministic tests reproduce and then prevent the reported stuck-claimed/dead-PID scenarios.'
    - 'Tests do not require a running systemd instance; systemctl queries are dependency-injected/mocked.'
    - 'Tests run in CI and fail on regression.'
  evidence_ids:
    - 'EVID-TCK-00663-01 (tests): queue/lane fault-injection regression suite'

notes:
  design_note: |
    Prefer a "thin" harness that constructs on-disk state and calls reconcile/lane APIs directly.
    Avoid spinning full worker threads unless necessary; model crash points by stopping mid-step.

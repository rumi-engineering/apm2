ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00396"
    title: "Complete HarnessHandle with real PTY storage for send_input and terminate"
    status: "OPEN"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0018"
    requirements:
      - requirement_id: "REQ-HEF-0010"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0010.yaml#rfc_requirement"
    evidence_artifacts:
      - evidence_id: "EVID-HEF-0012"
        artifact_ref: "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0012.yaml#rfc_evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
  dependencies:
    tickets: []
  scope:
    in_scope:
      - "Replace HarnessHandleInner::Placeholder with a real variant that stores PtyRunner handle, child PID, and stdin writer."
      - "Implement send_input() on RawAdapter and ClaudeCodeAdapter using the stored PTY handle."
      - "Implement terminate() on RawAdapter and ClaudeCodeAdapter with graceful SIGTERM then SIGKILL fallback."
      - "Ensure HarnessHandle is Send + Sync safe for use across tokio tasks."
    out_of_scope:
      - "Wiring the adapter into SpawnEpisode flow (TCK-00399)."
      - "Codex-specific adapter implementation (TCK-00402)."
      - "Model selection or rotation logic."
  plan:
    steps:
      - "Read crates/apm2-daemon/src/episode/adapter.rs and understand HarnessHandleInner::Placeholder (line ~660). Add a Real variant that holds an Arc<Mutex<PtyRunnerHandle>> wrapping the child PID, stdin AsyncWrite, and a stop signal."
      - "Modify RawAdapter::spawn_internal() (raw_adapter.rs line ~271) to return a HarnessHandle with the Real variant instead of Placeholder, storing the PTY child handle created by PtyRunner::spawn()."
      - "Implement RawAdapter::send_input() (raw_adapter.rs line ~397) — write bytes to the stored stdin handle. Replace the current 'not yet implemented' error."
      - "Implement RawAdapter::terminate() (raw_adapter.rs line ~412) — send SIGTERM, wait with timeout, fallback to SIGKILL. Replace the current 'not yet implemented' error."
      - "Apply the same changes to ClaudeCodeAdapter::spawn_internal() (claude_code.rs line ~233), send_input() (line ~383), and terminate() (line ~395)."
      - "Add unit tests: spawn a trivial process (e.g., cat), send input, verify output, terminate."
      - "Run cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings && cargo doc --workspace --no-deps && cargo test -p apm2-daemon."
  definition_of_done:
    evidence_ids:
      - "EVID-HEF-0012"
    criteria:
      - "HarnessHandleInner has a Real variant storing PTY handle, child PID, and stdin writer."
      - "RawAdapter::send_input() writes to the spawned process stdin and returns Ok(())."
      - "RawAdapter::terminate() sends SIGTERM, waits up to the configured shutdown timeout, then SIGKILL. Returns the ExitStatus."
      - "ClaudeCodeAdapter::send_input() and terminate() work identically."
      - "HarnessHandle is Send + Sync (compile-time verified)."
      - "At least one integration test spawns a real process, sends input, reads output via the event stream, and terminates cleanly."
      - "All CI checks pass: cargo fmt, clippy (zero warnings), doc, tests."
  notes:
    context: |
      The HarnessAdapter trait (adapter.rs:900) defines spawn(), send_input(), and terminate() for managing agent CLI processes.
      RawAdapter and ClaudeCodeAdapter both implement spawn_internal() with real PTY creation via PtyRunner::spawn(),
      but the resulting handle is stored as HarnessHandleInner::Placeholder — a no-op variant. This means send_input()
      and terminate() both return "not yet implemented" errors.

      This is a foundational blocker: without real handle storage, the daemon cannot interact with or lifecycle-manage
      any spawned agent process. Every downstream ticket (adapter wiring, Codex adapter, model selection) depends on
      handles actually working.

      AAT evidence (documents/aat/FINDINGS.md) confirmed that SpawnEpisode succeeds at the IPC
      layer but no agent process is actually spawned or managed.
    files: |
      - crates/apm2-daemon/src/episode/adapter.rs (HarnessHandleInner::Placeholder at ~line 660, HarnessAdapter trait at line 900)
      - crates/apm2-daemon/src/episode/raw_adapter.rs (spawn_internal at ~271, send_input stub at ~397, terminate stub at ~412)
      - crates/apm2-daemon/src/episode/claude_code.rs (spawn_internal at ~233, send_input stub at ~383, terminate stub at ~395)
      - crates/apm2-daemon/src/episode/pty.rs (PtyRunner::spawn — the actual PTY creation)
    security: |
      - HarnessHandle must not expose raw file descriptors across async boundaries without proper ownership semantics.
      - terminate() must guarantee the child process is dead before returning (no zombie processes).
      - stdin writer must be dropped on terminate to prevent writes to dead processes.
      - Child PID must be validated before signal delivery (prevent PID reuse attacks on long-lived daemons).

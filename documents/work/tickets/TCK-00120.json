{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-26",
    "template_version": "2026-01-26",
    "ticket": {
      "id": "TCK-00120",
      "title": "Implement end-to-end compile command",
      "status": "CLOSED"
    },
    "binds": {
      "rfc_id": "RFC-0010",
      "requirements": [
        {
          "requirement_id": "REQ-0001"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00119"
      }
    ]
  },
  "implementation": {
    "summary": "Implement the apm2 factory compile command that orchestrates the complete\nidea-to-tickets pipeline. This command chains all stages (CCP build, Impact Map,\nRFC frame, Ticket emit) in order, supports dry-run mode, configurable routing\nprofiles, and emits NDJSON observability events throughout execution.\n",
    "files_to_create": [
      {
        "path": "crates/apm2-cli/src/commands/factory/compile.rs",
        "purpose": "Compile command implementation with stage orchestration"
      }
    ],
    "files_to_modify": [
      {
        "path": "crates/apm2-cli/src/main.rs",
        "changes": "Register compile subcommand under factory"
      },
      {
        "path": "crates/apm2-cli/src/commands/factory.rs",
        "changes": "Add compile module and wire up command"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Define command arguments",
        "details": "In compile.rs using clap:\n- --prd <PRD-ID>: Required, identifies the PRD to compile\n- --rfc <RFC-ID>: Optional, target RFC ID (auto-generated if omitted)\n- --profile <PROFILE>: Optional, routing profile name (default: local)\n- --dry-run: Flag to report intended writes without modifying files\n- --output-dir <PATH>: Optional, override default output directory\n- --sign: Flag to sign the run manifest\n"
      },
      {
        "step": 2,
        "action": "Implement stage orchestration",
        "details": "In compile.rs:\n- CompilePipeline struct holding stage dependencies\n- Stages execute in order:\n  1. CCP build (ccp module)\n  2. Impact Map generation (impact_map module)\n  3. RFC frame (rfc_framer module)\n  4. Ticket emit (ticket_emitter module)\n- Each stage receives output from previous stage\n- Errors halt pipeline with context\n"
      },
      {
        "step": 3,
        "action": "Implement dry-run mode",
        "details": "In compile.rs:\n- DryRunContext tracks intended writes\n- Each stage reports what it would write\n- At end, print summary of all intended writes\n- No filesystem modifications in dry-run\n"
      },
      {
        "step": 4,
        "action": "Implement NDJSON observability",
        "details": "In compile.rs:\n- Define event types: StageStart, StageComplete, StageError, PipelineComplete\n- Each event includes timestamp, stage name, duration, status\n- Events written to stdout as newline-delimited JSON\n- Human-readable summary also printed to stderr\n"
      },
      {
        "step": 5,
        "action": "Wire up routing profile",
        "details": "In compile.rs:\n- Load routing profile from model_router module\n- Pass router to stages that require model invocation\n- Record routing decisions in run manifest\n"
      },
      {
        "step": 6,
        "action": "Generate and sign run manifest",
        "details": "In compile.rs:\n- Build manifest with all inputs, outputs, timings\n- If --sign flag, sign manifest with configured key\n- Write manifest to evidence/prd/<PRD-ID>/manifests/\n"
      },
      {
        "step": 7,
        "action": "Register command",
        "details": "In factory.rs and main.rs:\n- Add compile to factory subcommands\n- Wire up command handler\n"
      }
    ],
    "code_examples": [
      {
        "description": "Command usage",
        "code": "# Full compilation\napm2 factory compile --prd PRD-0005 --rfc RFC-0011\n\n# Dry-run to preview changes\napm2 factory compile --prd PRD-0005 --dry-run\n\n# With custom routing profile\napm2 factory compile --prd PRD-0005 --profile production --sign\n"
      },
      {
        "description": "NDJSON event example",
        "code": "{\"event\":\"stage_start\",\"stage\":\"ccp_build\",\"timestamp\":\"2026-01-26T14:30:00Z\"}\n{\"event\":\"stage_complete\",\"stage\":\"ccp_build\",\"duration_ms\":2340,\"outputs\":[\"evidence/prd/PRD-0005/ccp/ccp_index.json\"]}\n{\"event\":\"stage_start\",\"stage\":\"impact_map\",\"timestamp\":\"2026-01-26T14:30:02Z\"}\n...\n"
      }
    ]
  },
  "acceptance_criteria": [
    {
      "criterion": "End-to-end compilation works",
      "verification": "Integration test runs full pipeline on test PRD and produces expected outputs"
    },
    {
      "criterion": "Dry-run reports intended writes",
      "verification": "Dry-run mode prints all intended file writes without creating files"
    },
    {
      "criterion": "NDJSON events emitted",
      "verification": "Test captures stdout and validates NDJSON event format for each stage"
    }
  ],
  "test_requirements": [
    {
      "test_id": "IT-120-01",
      "description": "Integration test for full compile pipeline",
      "verification_command": "cargo run --bin apm2 -- factory compile --prd PRD-0005 --dry-run"
    },
    {
      "test_id": "UT-120-02",
      "description": "Test dry-run mode produces no side effects",
      "verification_command": "cargo test -p apm2-cli compile::dry_run"
    },
    {
      "test_id": "UT-120-03",
      "description": "Test NDJSON event emission format",
      "verification_command": "cargo test -p apm2-cli compile::ndjson"
    },
    {
      "test_id": "UT-120-04",
      "description": "Test pipeline halts on stage error",
      "verification_command": "cargo test -p apm2-cli compile::error_handling"
    }
  ],
  "notes": "This ticket implements REQ-0001 (end-to-end compilation) from RFC-0010.\n\nKey design decisions:\n- Sequential stage execution ensures deterministic ordering.\n- Dry-run mode is essential for CI integration and validation before writes.\n- NDJSON format enables machine-parseable observability while human summary\n  goes to stderr for interactive use.\n- Run manifests provide full audit trail of compilation.\n\nCCP grounding: COMP-CLI module, extension point EXT-CLI-001.\n\nThis is the capstone ticket for the compile pipeline, bringing together all\nprevious stages (CCP, Impact Map, RFC Framer, Ticket Emitter, Model Router,\nRun Manifest).\n"
}

{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-25",
    "template_version": "2026-01-25",
    "ticket": {
      "id": "TCK-00089",
      "title": "Add agent handoff integration tests"
    },
    "binds": {
      "prd_id": "PRD-0004",
      "rfc_id": "RFC-0008",
      "requirements": [
        {
          "requirement_id": "REQ-0018",
          "requirement_ref": "documents/prds/PRD-0004/requirements/REQ-0018.yaml#prd_requirement"
        }
      ],
      "evidence_artifacts": [
        "EVID-8005"
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_SECURITY"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00088"
      ]
    },
    "scope": {
      "in_scope": [
        "End-to-end test: full handoff flow from webhook to agent claiming",
        "Test webhook signature validation (valid and invalid)",
        "Test idempotency of webhook handling",
        "Test anti-gaming controls (agent cannot set CI status)",
        "Test error cases (malformed payload, missing headers)",
        "Test feature flag behavior (each phase can be disabled)",
        "Test phase transition state machine edge cases"
      ],
      "out_of_scope": [
        "Performance testing",
        "Load testing",
        "Testing with actual GitHub webhooks (use mocked payloads)"
      ]
    },
    "plan": {
      "steps": [
        "Create test fixtures for GitHub webhook payloads",
        "Create test helper to generate valid HMAC signatures",
        "Write E2E test: webhook -> event -> transition -> claim",
        "Write security test: reject unsigned webhooks",
        "Write security test: reject tamperedpayloads",
        "Write security test: agent cannot set CI status directly",
        "Write idempotency test: duplicate delivery_id handling",
        "Write error tests: missing headers, malformed JSON",
        "Write feature flag tests: each phase can be disabled",
        "Write edge case tests: CI reruns, cancelled workflows",
        "Verify all tests pass in CI"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-8005"
      ],
      "criteria": [
        "E2E test passes: webhook -> event -> transition -> handoff",
        "Security tests pass: invalid signatures rejected",
        "Security tests pass: agents cannot set CI status",
        "Idempotency test passes: duplicate webhooks handled",
        "Error tests pass: malformed requests rejected appropriately",
        "Feature flag tests pass: phases can be disabled",
        "Edge case tests pass: reruns, cancellations handled",
        "All tests run in CI pipeline",
        "Test coverage for critical paths >90%"
      ]
    },
    "notes": {
      "implementation_details": "Test structure:\n```rust\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use axum::http::StatusCode;\n\n    fn compute_signature(payload: &[u8], secret: &str) -> String {\n        use hmac::{Hmac, Mac};\n        use sha2::Sha256;\n        let mut mac = Hmac::<Sha256>::new_from_slice(secret.as_bytes()).unwrap();\n        mac.update(payload);\n        let result = mac.finalize();\n        format!(\"sha256={}\", hex::encode(result.into_bytes()))\n    }\n\n    #[tokio::test]\n    async fn test_e2e_handoff_flow() {\n        // Setup\n        let app = create_test_app().await;\n        let work_item = create_work_item(WorkPhase::CIPending).await;\n\n        // Simulate webhook\n        let payload = json!({\n            \"action\": \"completed\",\n            \"workflow_run\": {\n                \"id\": 12345,\n                \"head_sha\": work_item.commit_sha,\n                \"conclusion\": \"success\",\n                \"pull_requests\": [{\"number\": work_item.pr_number}]\n            }\n        });\n        let signature = compute_signature(payload.to_string().as_bytes(), SECRET);\n\n        let response = app\n            .post(\"/webhooks/github\")\n            .header(\"X-Hub-Signature-256\", signature)\n            .header(\"X-GitHub-Event\", \"workflow_run\")\n            .header(\"X-GitHub-Delivery\", \"test-delivery-1\")\n            .json(&payload)\n            .await;\n\n        assert_eq!(response.status(), StatusCode::ACCEPTED);\n\n        // Verify event emitted\n        let events = app.ledger.query_events::<CIWorkflowCompleted>().await;\n        assert_eq!(events.len(), 1);\n\n        // Verify work item transitioned\n        let updated = app.work_store.get(&work_item.id).await.unwrap();\n        assert_eq!(updated.phase, WorkPhase::ReadyForReview);\n\n        // Verify work can be claimed\n        let lease = app.work_store.try_claim(&work_item.id, \"agent-2\").await;\n        assert!(lease.is_ok());\n    }\n\n    #[tokio::test]\n    async fn test_anti_gaming_agent_cannot_set_ci() {\n        let app = create_test_app().await;\n        let work_item = create_work_item(WorkPhase::CIPending).await;\n\n        // Simulate agent trying to transition directly (no webhook)\n        let result = app.work_store\n            .transition(&work_item.id, WorkPhase::ReadyForReview)\n            .await;\n\n        // Should fail - only CIWorkflowCompleted events can transition\n        assert!(matches!(result, Err(Error::UnauthorizedTransition)));\n\n        // Work item still in CI_PENDING\n        let unchanged = app.work_store.get(&work_item.id).await.unwrap();\n        assert_eq!(unchanged.phase, WorkPhase::CIPending);\n    }\n\n    #[tokio::test]\n    async fn test_invalid_signature_rejected() {\n        let app = create_test_app().await;\n        let payload = json!({\"action\": \"completed\", ...});\n\n        let response = app\n            .post(\"/webhooks/github\")\n            .header(\"X-Hub-Signature-256\", \"sha256=invalid\")\n            .json(&payload)\n            .await;\n\n        assert_eq!(response.status(), StatusCode::UNAUTHORIZED);\n    }\n\n    #[tokio::test]\n    async fn test_duplicate_delivery_id_idempotent() {\n        let app = create_test_app().await;\n        let payload = json!({...});\n        let signature = compute_signature(...);\n\n        // First delivery\n        let response1 = app.post(\"/webhooks/github\")\n            .header(\"X-GitHub-Delivery\", \"dup-id-1\")\n            .header(\"X-Hub-Signature-256\", &signature)\n            .json(&payload)\n            .await;\n        assert_eq!(response1.status(), StatusCode::ACCEPTED);\n\n        // Duplicate delivery\n        let response2 = app.post(\"/webhooks/github\")\n            .header(\"X-GitHub-Delivery\", \"dup-id-1\")\n            .header(\"X-Hub-Signature-256\", &signature)\n            .json(&payload)\n            .await;\n        assert_eq!(response2.status(), StatusCode::OK); // 200 for already processed\n\n        // Only one event in ledger\n        let events = app.ledger.query_events::<CIWorkflowCompleted>().await;\n        assert_eq!(events.len(), 1);\n    }\n}\n```\n",
      "affected_files": "New:\n  - crates/apm2-core/tests/integration/handoff.rs\n  - crates/apm2-core/tests/integration/mod.rs\n  - crates/apm2-core/tests/fixtures/webhook_payloads.rs\nModified:\n  - crates/apm2-core/Cargo.toml (add test dependencies if needed)\n"
    }
  }
}

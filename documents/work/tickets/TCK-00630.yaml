ticket_meta:
  schema_version: '2026-01-29'
  template_version: '2026-01-29'
  ticket:
    id: TCK-00630
    title: 'RFC-0032 Phase 0: migrate legacy `ledger_events` -> core `events` with real hash chain'
    status: OPEN
  binds:
    prd_id: PRD-PLACEHOLDER
    rfc_id: RFC-0032
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles:
    - AGENT_IMPLEMENTER
    responsibility_domains:
    - DOMAIN_CORE
    - DOMAIN_DATA
    - DOMAIN_KERNEL
  dependencies:
    tickets: []
  scope:
    in_scope:
    - Implement a daemon-invoked migration that copies rows from legacy `ledger_events` into core `events` (ordered by `rowid ASC`)
    - Compute `prev_hash` and `event_hash` for each migrated row using `apm2_core::crypto::EventHasher` (genesis prev_hash = 32x00)
    - Preserve signature bytes without verifying during migration
    - Ensure `determine_read_mode` becomes `CanonicalEvents` after migration by renaming or removing `ledger_events` from the active schema
    - 'Idempotency + safety: if `events` already has rows, migration is a no-op; if partial migration detected, fail fast'
    out_of_scope:
    - Changing event payload formats (JSON vs protobuf) during migration (defer to later phases)
    - Attempting signature verification for historical rows (explicitly unverified per RFC-0032)
  plan:
    steps:
    - Add a migration entrypoint in `crates/apm2-core/src/ledger/storage.rs` (or adjacent module) callable from daemon startup
    - Acquire exclusive SQLite transaction for the duration of copy + hash-chain computation
    - Select legacy rows in stable order (`rowid ASC`) and insert into `events` with populated `prev_hash`/`event_hash` and `record_version=1`
    - Rename `ledger_events` to `ledger_events_legacy_frozen` (or export+drop) inside the same transaction
    - Add unit/integration tests that start from a DB seeded with only `ledger_events` and assert canonical read-mode + appendability
  definition_of_done:
    evidence_ids: []
    criteria:
    - Migration runs atomically under exclusive lock and produces a contiguous hash chain in `events` (no NULL event_hash after migration).
    - '`determine_read_mode()` selects canonical mode after migration (no `LegacyLedgerEvents`, no `AmbiguousSchemaState`).'
    - 'Migration is idempotent: running twice does not duplicate rows or change hashes.'
    - On partial/ambiguous schema state, migration fails fast with actionable error text.
  notes:
    security: Do not attempt best-effort continuation on partial migration; fail-closed to avoid silent divergence.
    verification: Add a regression test reproducing `LedgerStorageError::LegacyModeReadOnly` pre-migration and proving it disappears post-migration.

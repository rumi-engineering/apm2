{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00137",
      "title": "Implement ContextPack compiler",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0007",
      "rfc_id": "RFC-0011",
      "requirements": [
        {
          "requirement_id": "CAC-REQ-0003",
          "requirement_ref": "documents/prds/PRD-0007/requirements/REQ-0003.yaml#prd_requirement"
        },
        {
          "requirement_id": "CAC-REQ-0008",
          "requirement_ref": "documents/prds/PRD-0007/requirements/REQ-0008.yaml#prd_requirement"
        },
        {
          "requirement_id": "CAC-REQ-0012",
          "requirement_ref": "documents/prds/PRD-0007/requirements/REQ-0012.yaml#prd_requirement"
        }
      ],
      "evidence_artifacts": [
        "EVID-0005",
        "EVID-0010"
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_KERNEL",
        "DOMAIN_COMPILER"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00134",
        "TCK-00136"
      ]
    },
    "scope": {
      "in_scope": [
        "Implement ContextPackCompiler that accepts ContextPackSpec",
        "Transitive dependency resolution from root stable_ids",
        "Deep-pinning of all content hashes in manifest",
        "Budget enforcement during compilation (reject over-budget packs)",
        "Deterministic manifest generation (canonical JSON output)",
        "Cycle detection in dependency graph",
        "CompilationReceipt emission with compilation metadata"
      ],
      "out_of_scope": [
        "CLI integration (TCK-00139)",
        "RunReceipt emission (TCK-00138)",
        "Streaming compilation for very large packs",
        "Partial compilation / incremental updates"
      ]
    },
    "plan": {
      "steps": [
        "Create crates/apm2-core/src/cac/compiler.rs module",
        "Implement ContextPackCompiler struct with DcpIndex dependency",
        "Implement resolve_dependencies() for transitive closure",
        "Implement detect_cycles() using Tarjan's algorithm",
        "Implement deep_pin() to resolve all stable_ids to content_hashes",
        "Implement enforce_budget() to validate against BudgetConstraint",
        "Implement generate_manifest() with canonical JSON output",
        "Define CompiledContextPack struct with manifest, content_hashes, budget_used",
        "Define CompilationReceipt with compile_time_ms, artifact_count, warnings",
        "Implement deterministic ordering for manifest entries (by stable_id)",
        "Write tests for: transitive resolution, cycle detection, budget enforcement",
        "Write property tests for manifest determinism"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-0005",
        "EVID-0010"
      ],
      "criteria": [
        "Compiler resolves transitive dependencies from DCP index",
        "Cycle detection returns CompilationError::CycleDetected with path",
        "Budget enforcement rejects packs exceeding any budget dimension",
        "Manifest generation is deterministic (same input -> same bytes)",
        "CompiledContextPack includes all resolved content_hashes",
        "CompilationReceipt captures compilation metrics",
        "All tests pass: cargo test cac::compiler"
      ]
    },
    "notes": {
      "security": "Deep-pinning ensures hermetic consumption (DD-0003).\nBudget enforcement prevents resource exhaustion attacks.\nCycle detection prevents infinite resolution loops.\n",
      "architecture": "Compiler follows DD-0003 hermetic consumption model.\nUses DCP index (TCK-00134) for stable_id resolution.\nManifest format follows CAC-JSON canonicalization (TCK-00127).\nBudget enforcement uses TypedQuantity from TCK-00136.\n",
      "rust_textbook_refs": [
        {
          "file": ".claude/skills/rust-textbook/07_errors_panics_diagnostics.md",
          "rules": [
            "CTR-0701: Result for all fallible operations",
            "CTR-0703: Typed CompilationError enum with variants"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/12_api_design_stdlib_quality.md",
          "rules": [
            "CTR-1201: Explicit contract for compile() method",
            "CTR-1202: Borrowed views for dependency iteration"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/13_collections_allocation_models.md",
          "rules": [
            "Preallocate manifest Vec based on dependency count estimate"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/17_testing_fuzz_miri_evidence.md",
          "rules": [
            "INV-1701: Property tests for manifest determinism"
          ]
        }
      ],
      "codebase_context": {
        "extend": [
          {
            "file": "crates/apm2-core/src/cac/mod.rs",
            "reason": "Add compiler module export"
          }
        ],
        "reference": [
          {
            "file": "crates/apm2-core/src/cac/dcp_index.rs",
            "reason": "DCP index for stable_id resolution (TCK-00134)"
          },
          {
            "file": "crates/apm2-core/src/cac/pack_spec.rs",
            "reason": "ContextPackSpec input type (TCK-00136)"
          },
          {
            "file": "crates/apm2-core/src/determinism/canonicalize_json.rs",
            "reason": "Canonical manifest output"
          },
          {
            "file": "crates/apm2-core/src/evidence/receipt.rs",
            "reason": "Receipt pattern for CompilationReceipt"
          }
        ]
      }
    }
  }
}

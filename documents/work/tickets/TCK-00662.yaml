ticket_meta:
  schema_version: '2026-01-29'
  template_version: '2026-01-29'
  ticket:
    id: 'TCK-00662'
    title: 'FAC: Make lane reset + PID-based remediation PID-reuse safe (identity-verified kill)'
    status: 'OPEN'
  binds:
    prd_id: 'PRD-0001'
    rfc_id: 'RFC-0019'
    requirements:
      - 'REQ-0008'
      - 'REQ-0037'
    evidence_artifacts: []
  custody:
    agent_roles:
      - 'Implementer'
      - 'Reviewer'
    responsibility_domains:
      - 'fac/ops-tools'
      - 'fac/lane-lease'
  dependencies:
    tickets:
      - 'TCK-00658' # proc_start_time binding for leases

context:
  observed_symptoms:
    - 'Manual remediation via `apm2 fac lane reset --force` can kill the wrong process under PID reuse.'
    - 'Operators avoid lane reset or overuse it, creating reliability and safety risk.'
  code_evidence:
    - |
      kill_process_best_effort currently only checks that /proc/<pid>/comm exists, then SIGTERM/SIGKILL:
        crates/apm2-cli/src/commands/fac.rs:5124-5171
    - |
      Lane leases currently store only pid (and after TCK-00658 will store proc_start_time_ticks),
      but kill path does not (yet) verify identity.

problem_statement: |
  Operator tooling that kills processes by PID must be PID-reuse safe. A lane reset that kills an
  unrelated process is unacceptable. The tooling should only kill a process if it can prove that the
  process is the one recorded in the lane lease (PID + start time match), otherwise fail closed.

proposed_change:
  intent: |
    Make all PID-based remediation identity-verified:
      - If a lane lease has proc_start_time_ticks, verify it before sending any signal.
      - If identity cannot be verified, refuse by default and require a more explicit operator action.

invariants:
  - id: 'INV-KILL-001'
    statement: 'No PID-based kill may be issued unless process identity is verified (PID + starttime match) OR the operator explicitly opts into an unsafe override.'
  - id: 'INV-KILL-002'
    statement: 'Default behavior must be fail-closed (refuse to kill) when identity is unknown.'

scope:
  in_scope:
    - id: 'S1'
      description: |
        Replace kill_process_best_effort with identity-verified variant:
          - kill_process_if_identity_matches(pid, expected_start_ticks) -> Result<KillOutcome>
          - Use the same /proc/<pid>/stat starttime parsing helper introduced in TCK-00658.
          - Only send SIGTERM/SIGKILL when identity matches.
    - id: 'S2'
      description: |
        Update `apm2 fac lane reset`:
          - When a lease exists and includes proc_start_time_ticks:
              * verify identity
              * kill only on match
          - When lease lacks proc_start_time_ticks:
              * refuse by default with a clear error message
              * optionally allow `--unsafe-kill-by-pid` (explicitly named) for emergency cases
    - id: 'S3'
      description: |
        Update any other PID-based remediation paths (search for kill()/SIGTERM usage in fac commands)
        to use the identity-verified helper.
    - id: 'S4'
      description: |
        Add tests:
          - Create a fake lease with pid=current process pid and mismatched start ticks => kill refused.
          - Spawn child process and use correct start ticks => kill attempted (in test, stub out actual SIGKILL).
          - CLI-level test: lane reset refuses when identity missing unless unsafe flag provided.
  out_of_scope:
    - 'Killing systemd units by unit name (already safer and preferred).'

plan:
  steps:
    - id: 'P1'
      description: 'Implement identity-verified kill helper (with injectable signal sender for tests).'
    - id: 'P2'
      description: 'Wire helper into fac lane reset command; add unsafe override flag + messaging.'
    - id: 'P3'
      description: 'Audit other PID-kill call sites and update.'
    - id: 'P4'
      description: 'Add tests + docs in AGENTS.md (PID reuse safety section) and fac doctor remediation advice.'


definition_of_done:
  criteria:
    - 'Lane reset cannot kill an unrelated PID by default (identity mismatch => refusal).'
    - 'Unsafe override is explicit, noisy, and gated behind a dedicated flag name.'
    - 'Unit tests cover identity match/mismatch behavior.'
  evidence_ids:
    - 'EVID-TCK-00662-01 (unit): identity-verified kill refuses on mismatch'
    - 'EVID-TCK-00662-02 (cli): lane reset refuses without identity unless unsafe override'

notes:
  operator_ux: |
    The refusal message should include:
      - lane_id
      - pid
      - expected_start_ticks (if any)
      - observed_start_ticks (if pid alive)
      - recommended safer alternative: stop systemd unit (stop_revoke) or investigate lane corruption

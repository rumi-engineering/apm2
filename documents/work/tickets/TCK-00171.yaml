acceptance_criteria:
  - criterion: Evidence artifact with ttl, class, pin_state
    verification: Artifact fields correctly populated
  - criterion: TTL enforcement timer
    verification: Expired artifacts evicted after TTL
  - criterion: Pin API for incident binding
    verification: Pinned artifacts persist beyond TTL
implementation:
  code_examples:
    - description: EvidenceArtifact structure
      code: |
        pub struct EvidenceArtifact {
            pub artifact_id: ArtifactId,
            pub content_hash: Hash,
            pub class: EvidenceClass,
            pub ttl: Duration,
            pub pin_state: PinState,
            pub created_at: Timestamp,
            pub episode_id: EpisodeId,
        }

        pub enum EvidenceClass {
            Ephemeral,   // Short TTL, auto-delete
            Standard,    // Medium TTL, normal retention
            Archival,    // Long TTL, compliance retention
        }

        pub enum PinState {
            Unpinned,
            Pinned { reason: PinReason, expires_at: Option<Timestamp> },
        }
  files_to_create:
    - path: crates/apm2-daemon/src/evidence/artifact.rs
      purpose: EvidenceArtifact and related types
    - path: crates/apm2-daemon/src/evidence/ttl.rs
      purpose: TTL enforcement and timer
    - path: crates/apm2-daemon/src/evidence/pin.rs
      purpose: Pin API and state management
  files_to_modify:
    - changes: Export artifact, ttl, pin modules
      path: crates/apm2-daemon/src/evidence/mod.rs
  implementation_steps:
    - step: 1
      action: Define EvidenceArtifact
      details: |
        Create artifact type per AD-EVID-002:
        - artifact_id: unique identifier
        - content_hash: CAS reference
        - class: Ephemeral | Standard | Archival
        - ttl: time-to-live duration
        - pin_state: Unpinned | Pinned
    - step: 2
      action: Implement EvidenceClass
      details: |
        Define retention classes:
        - Ephemeral: 1 hour TTL (debug logs)
        - Standard: 7 days TTL (normal evidence)
        - Archival: 90 days TTL (compliance)
    - step: 3
      action: Implement TTL enforcement
      details: |
        Create TtlEnforcer:
        - Periodic timer (1 minute interval)
        - Scan artifacts for expiration
        - Skip pinned artifacts
        - Delete expired, emit events
    - step: 4
      action: Implement Pin API
      details: |
        Pin methods:
        - pin(artifact_id, reason, expires_at)
        - unpin(artifact_id)
        - is_pinned(artifact_id) -> bool
        Emit evidence.pinned events
    - step: 5
      action: Integrate with DefectRecord
      details: |
        Per AD-CAC-001, DefectRecords trigger pins:
        - On defect creation, pin related evidence
        - Set expires_at to defect resolution + grace
        - Unpin on defect closure
  summary: |
    Implement evidence TTL and pinning per AD-EVID-002.
    Every artifact has ttl, class, pin_state. TTL enforcement timer
    evicts expired unpinned artifacts. Pin API for incident binding.
notes: |
  Phase: PHASE-3A (Evidence Economics)
  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.
  Maps to TCK-PEND-014.
schema_version: "2026-01-27"
template_version: "2026-01-27"
test_requirements:
  - description: TTL expiration
    test_id: UT-00171-01
    verification_command: cargo test -p apm2-daemon ttl_expiration
  - description: Pin prevents deletion
    test_id: UT-00171-02
    verification_command: cargo test -p apm2-daemon pin_retention
  - description: Evidence class TTLs
    test_id: UT-00171-03
    verification_command: cargo test -p apm2-daemon evidence_class
ticket:
  depends_on:
    - TCK-00170
  id: TCK-00171
  requirement_ids:
    - REQ-EVID-001
  rfc_id: RFC-0013
  status: READY
  title: Implement evidence TTL and pinning

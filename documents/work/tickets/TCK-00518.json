{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00518",
      "title": "Default-mode gates: enqueue+wait (bounded) + `--direct` unsafe; integrate with worker + broker",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-PLACEHOLDER",
      "rfc_id": "RFC-0019",
      "requirements": [],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_SECURITY"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00510",
          "reason": "Need broker to issue actuation tokens."
        },
        {
          "ticket_id": "TCK-00511",
          "reason": "Need worker to consume queue."
        },
        {
          "ticket_id": "TCK-00512",
          "reason": "Need job spec digest + actuation schema."
        },
        {
          "ticket_id": "TCK-00595",
          "reason": "Need worker liveness surfaced via broker to avoid indefinite waits."
        },
        {
          "ticket_id": "TCK-00594",
          "reason": "Need services status/ensure UX for actionable remediation."
        }
      ]
    },
    "scope": {
      "in_scope": [
        "`apm2 fac gates` creates job spec, obtains token, enqueues, and waits by default.",
        "Default waiting MUST be bounded (`--wait-timeout`) and MUST consult broker liveness; if no worker is live, fail fast with actionable output.",
        "Implement `apm2 fac gates --direct` as explicit unsafe mode that disables cache read/write and marks receipt `unsafe_direct:true`.",
        "Implement `apm2 fac enqueue` paths to request tokens from broker.",
        "Implement wait-for-completion using receipt presence (not process state)."
      ],
      "out_of_scope": [
        "Distributed queue transport."
      ]
    },
    "plan": {
      "steps": [
        "Refactor gates entrypoint to produce job specs rather than running gates inline.",
        "Add waiter that watches done/receipt stream with bounded polling/backoff.",
        "Call broker status API to detect worker liveness and surface progress; implement `--wait-timeout`."
      ]
    },
    "definition_of_done": {
      "evidence_ids": [],
      "criteria": [
        "Default `apm2 fac gates` path exercises broker token issuance, worker claim, RFC-0029 admission, lane lease execution, and receipt emission.",
        "If no worker is live, `apm2 fac gates` exits within `--wait-timeout` with deterministic remediation (e.g., `apm2 fac services ensure` or `--direct`).",
        "Direct mode produces receipts but never writes gate cache."
      ]
    }
  }
}

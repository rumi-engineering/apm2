acceptance_criteria:
  - criterion: PTY output parser for Claude Code CLI
    verification: Parser extracts tool calls from output
  - criterion: Tool call detection and extraction
    verification: Tool requests emit HarnessEvent::ToolRequest
  - criterion: Test fixtures from real Claude Code sessions
    verification: Fixtures parse correctly
implementation:
  code_examples:
    - description: ClaudeCodeAdapter structure
      code: |
        pub struct ClaudeCodeAdapter {
            parser: ClaudeCodeParser,
        }

        impl HarnessAdapter for ClaudeCodeAdapter {
            fn adapter_type(&self) -> AdapterType {
                AdapterType::ClaudeCode
            }

            fn output_stream(&self, handle: &HarnessHandle) -> impl Stream<Item = HarnessEvent> {
                handle.pty_output()
                    .flat_map(|chunk| self.parser.parse(chunk))
            }
        }

        pub struct ClaudeCodeParser {
            state: ParserState,
            buffer: Vec<u8>,
        }

        impl ClaudeCodeParser {
            pub fn parse(&mut self, chunk: &[u8]) -> Vec<HarnessEvent>;
        }
  files_to_create:
    - path: crates/apm2-daemon/src/episode/claude_code.rs
      purpose: ClaudeCodeAdapter implementation
    - path: crates/apm2-daemon/src/episode/claude_parser.rs
      purpose: Parser for Claude Code PTY output
    - path: crates/apm2-daemon/tests/fixtures/claude_code/
      purpose: Test fixtures from real sessions
  files_to_modify:
    - changes: Export claude_code module, register adapter
      path: crates/apm2-daemon/src/episode/mod.rs
    - changes: Register ClaudeCodeAdapter in default registry
      path: crates/apm2-daemon/src/episode/registry.rs
  implementation_steps:
    - step: 1
      action: Implement ClaudeCodeParser
      details: |
        Deterministic parser state machine per AD-ADAPT-001:
        - States: Idle, InToolCall, InOutput
        - Detect tool call markers in output
        - Extract tool name and arguments
        - Emit HarnessEvent::ToolRequest
    - step: 2
      action: Handle parsing failures
      details: |
        Per AD-ADAPT-001:
        - Parsing failures emit DefectRecord
        - Never crash on malformed input
        - Log parsing errors as defects
    - step: 3
      action: Implement ANSI sanitization
      details: |
        Per TB-ADAPTER-001:
        - Strip ANSI escape sequences
        - Normalize line endings
        - Handle partial UTF-8
    - step: 4
      action: Create test fixtures
      details: |
        Capture real Claude Code sessions:
        - Simple command execution
        - File read/write operations
        - Multi-tool sequences
        - Error scenarios
    - step: 5
      action: Implement rate limiting
      details: |
        Per TB-ADAPTER-001:
        - Rate limit tool request extraction
        - Prevent DoS via rapid tool markers
        - Configurable limit (default: 10/sec)
  summary: |
    Implement Claude Code harness adapter per AD-ADAPT-001.
    Parses PTY output to detect tool calls and emit structured events.
    Includes test fixtures from real Claude Code sessions.
notes: |
  Phase: PHASE-3B (Vendor Adapter)
  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.
  Maps to TCK-PEND-016.
schema_version: "2026-01-27"
template_version: "2026-01-27"
test_requirements:
  - description: Parser extracts tool calls
    test_id: UT-00173-01
    verification_command: cargo test -p apm2-daemon claude_parser
  - description: Fixture parsing
    test_id: UT-00173-02
    verification_command: cargo test -p apm2-daemon claude_fixtures
  - description: Malformed input handling
    test_id: UT-00173-03
    verification_command: cargo test -p apm2-daemon claude_malformed
ticket:
  depends_on:
    - TCK-00162
    - TCK-00164
  id: TCK-00173
  requirement_ids:
    - REQ-ADAPTER-001
  rfc_id: RFC-0013
  status: READY
  title: Implement Claude Code harness adapter

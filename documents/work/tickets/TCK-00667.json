{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00667",
      "title": "FAC review orchestration: daemon DispatchReviewer + projection/pulse wait under doctor-first remediation (no legacy review run/restart surfaces)",
      "status": "OPEN"
    },
    "binds": {
      "prd_id": "PRD-PLACEHOLDER",
      "rfc_id": "RFC-0032",
      "requirements": [],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_CLI",
        "DOMAIN_DAEMON",
        "DOMAIN_PROTOCOL",
        "DOMAIN_RUNTIME"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00647",
          "reason": "DispatchReviewer provides daemon-owned workspace + reviewer episode boundary."
        },
        {
          "ticket_id": "TCK-00654",
          "reason": "CLI wait integration should use pulse subscriptions instead of ad-hoc polling."
        },
        {
          "ticket_id": "TCK-00666",
          "reason": "CLI should consume kernel-native review status projection rather than local state."
        }
      ]
    }
  },
  "root_cause_analysis": {
    "summary": "fac_review currently orchestrates reviewer runs by spawning detached systemd units,\ntracking PIDs in review_state.json, and inferring liveness from PID existence + pulse\nfiles. This causes multiple classes of brittleness:\n\n  - PID reuse / dead PID ambiguity causes 'alive' false positives.\n  - Orchestrator crashes leave stale state that blocks progress.\n  - Multiple sources of truth (state.json, pulse files, GitHub) diverge.\n  - The orchestration does not naturally compose with daemon-side work/lease/session\n    logic introduced by RFC-0032.\n\nThe kernel-native direction is: CLI requests dispatch; daemon owns execution and\ndurability; CLI observes progress via pulses/projections.\n"
  },
  "scope": {
    "in_scope": [
      {
        "id": "DRP-001",
        "title": "Replace systemd-run detached dispatch with daemon DispatchReviewer",
        "detail": "Update CLI review dispatch paths to call the daemon DispatchReviewer RPC instead of\nany detached local wrapper orchestration.\n\nRequirements:\n  - dispatch must be idempotent (stable dispatch_idempotency_key derived from work_id + head_sha + review_kind + attempt)\n  - daemon returns a session_id / run_id that CLI can observe via pulses/projection\n  - CLI retains an operator-friendly output that links to work_id/session_id\n"
      },
      {
        "id": "DRP-002",
        "title": "Replace PID/pulse-file liveness with pulse subscriptions + status projection",
        "detail": "For wait/resume/doctor decision flows:\n  - use SubscribePulse/WaitForPulse to wait on reviewer terminal topics\n  - use GetReviewStatus (or WorkStatus extension) to decide whether a reviewer is pending/alive/done/blocked\n  - eliminate the need to read review_state.json or check /proc for liveness\n\nLocal pulse files may remain temporarily as derived UX, but must not be used to make authority decisions.\n"
      },
      {
        "id": "DRP-003",
        "title": "Route PR-scoped remediation through doctor --pr --fix using lease/session signals",
        "detail": "Replace local timestamp/PID restart heuristics with:\n  - lease expiry / renewal signals\n  - session termination reasons recorded by daemon\n  - WorkLoopManager reaper outputs (RFC-0032 Phase 4)\n\nEnsure `apm2 fac doctor --pr <N> --fix` remains bounded and does not attempt reviewer\nrestart when a session is still legitimately running.\n"
      },
      {
        "id": "DRP-004",
        "title": "Hard-cut legacy review orchestration command surfaces",
        "detail": "Ensure legacy command surfaces are fully removed and not reintroduced:\n  - `apm2 fac review run`\n  - `apm2 fac review restart`\n  - `apm2 fac restart`\n\nRemediation and follow-up behavior must be expressed via doctor-first flows\n(`apm2 fac doctor --fix` and `apm2 fac doctor --pr <N> --fix`) with daemon authority.\n"
      }
    ],
    "out_of_scope": [
      "Rewriting reviewer model backends (Codex/Gemini/Claude) beyond what is necessary to run under daemon-owned episodes.",
      "Removing all GitHub caching immediately."
    ]
  },
  "plan": {
    "steps": [
      "Implement dispatch call path and output formatting (work_id + session/run id).",
      "Implement wait path using pulses and projection query.",
      "Convert PR-scoped doctor remediation decisions to lease/session signals.",
      {
        "Add integration test": "CLI crash mid-wait and resume still succeeds."
      },
      {
        "Add integration test": "duplicate dispatch requests do not spawn duplicate sessions."
      }
    ]
  },
  "definition_of_done": {
    "criteria": [
      "CLI review orchestration does not depend on systemd-run detached dispatch for correctness.",
      "CLI liveness and wait behavior uses pulse subscriptions + daemon projection, not PID/pulse-file inference.",
      "Doctor PR-scoped remediation decisions are lease/session-driven and idempotent.",
      "Legacy review run/restart command surfaces remain removed.",
      "Integration tests cover crash/resume and duplicate-dispatch idempotency."
    ]
  },
  "risks": [
    {
      "id": "R-DRP-01",
      "title": "Operator workflows rely on existing review_state.json artifacts",
      "mitigation": "Provide derived/compat output (read-only) for a transition period, but keep it non-authoritative.\nDocument that the canonical truth is now daemon projections.\n"
    }
  ],
  "fac_security_contract": {
    "source": "documents/work/tickets/FAC_SECURITY_MODEL_INVARIANTS_V1.yaml",
    "profile": "FAC-RFC0032-BASELINE",
    "required_invariants": [
      "INV-FAC-TRUTH-001",
      "INV-FAC-WORK-BIND-001",
      "INV-FAC-CLAIM-BIND-001",
      "INV-FAC-ACTOR-BIND-001",
      "INV-FAC-IDEMP-001",
      "INV-FAC-EVID-001"
    ],
    "enforcement_requirements": [
      "Any new requirement, code path, or test added under this ticket must map to one or more required_invariants.",
      "Any invariant relaxation requires explicit amendment in this ticket and the shared security model document.",
      "Reviewer denial is expected for invariant-unmapped behavior changes."
    ]
  }
}

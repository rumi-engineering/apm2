{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00436",
      "title": "Unified local evidence gates with pipeline artifact reuse",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0009",
      "rfc_id": "RFC-0019",
      "requirements": [
        {
          "requirement_id": "REQ-0006",
          "requirement_ref": "documents/rfcs/RFC-0019/requirements/REQ-0006.yaml#requirement"
        },
        {
          "requirement_id": "REQ-0011",
          "requirement_ref": "documents/rfcs/RFC-0019/requirements/REQ-0011.yaml#requirement"
        }
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_BUILD_RELEASE"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00410",
          "reason": "Supersedes fac check with unified fac gates command that covers all evidence gates."
        },
        {
          "ticket_id": "TCK-00433",
          "reason": "Builds on fac_review module structure and evidence gate pipeline."
        }
      ]
    },
    "scope": {
      "in_scope": [
        "Replace `apm2 fac check` with `apm2 fac gates` â€” runs ALL evidence gates locally with bounded test execution.",
        "Per-SHA gate cache under ~/.apm2/private/fac/gate_cache/{sha}.yaml so pipeline can skip already-passed gates.",
        "Pipeline (`run_evidence_gates_with_status`) checks gate cache before each gate and skips if cached PASS.",
        "Bounded test execution: if run_bounded_tests.sh exists and cgroup v2 is available, use bounded runner; otherwise fall back to cargo test.",
        "EvidenceGateOptions struct for test command override in run_evidence_gates()."
      ],
      "out_of_scope": [
        "Changes to CI workflow files.",
        "Changes to the review dispatch system.",
        "Remote/distributed gate caching."
      ]
    },
    "rationale": "Two separate gate systems exist: `fac check` (3 gates with cgroup bounds) and\nevidence gates in pipeline (7 gates, no bounds, no caching). After pushing, the\npipeline re-runs all evidence gates (~5-10 min) even when the developer already\nvalidated locally. Unifying into `fac gates` with per-SHA caching eliminates\nredundant work and provides a single local validation surface.\n",
    "plan": {
      "steps": [
        "Create gate_cache.rs module with per-SHA YAML cache read/write.",
        "Add cache integration to run_evidence_gates_with_status() in evidence.rs.",
        "Add EvidenceGateOptions to run_evidence_gates() for test command override.",
        "Replace Check(CheckArgs) with Gates(GatesArgs) in fac.rs FacSubcommand.",
        "Create gates.rs with run_gates() implementation using bounded test runner.",
        "Wire gate_cache and gates modules in mod.rs.",
        "Remove all fac check code and tests from fac.rs.",
        "Update documentation: TCK-00410, FAC_LOCAL_GATE_RUNBOOK, orchestrator-monitor SKILL."
      ]
    },
    "acceptance_criteria": [
      "`apm2 fac gates` runs all 7 evidence gates locally with summary output.",
      "Bounded test execution used when cgroup v2 available and run_bounded_tests.sh present.",
      "Gate cache written per-SHA after `fac gates` completes.",
      "Pipeline (`fac pipeline`) skips gates that are cached as PASS for the current SHA.",
      "`apm2 fac gates --force` re-runs all gates ignoring cache.",
      "`apm2 fac check` is fully removed.",
      "cargo fmt, clippy, doc, test all clean."
    ],
    "notes": {
      "general": "This ticket supersedes the local gate execution aspects of TCK-00410's\n`fac check` command with a more comprehensive `fac gates` that covers all\nevidence gates and integrates with the pipeline cache.\n",
      "amendments": [
        {
          "amendment_id": "AMD-2026-02-16-FAC-THROUGHPUT-PIVOT",
          "summary": "Bounded test execution remains required, but default throughput policy is now profile-driven and queue-managed.",
          "supersedes": [
            "Bounded test execution used when cgroup v2 available and run_bounded_tests.sh present."
          ],
          "replacement": [
            "Bounded test execution via Rust systemd paths is mandatory.",
            "Default execution profile on high-capacity hosts is throughput (`gate_profile=throughput`) with host-aware test/build parallelism."
          ]
        }
      ]
    }
  }
}

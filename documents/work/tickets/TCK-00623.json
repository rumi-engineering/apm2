{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00623",
      "title": "FAC review/push closure-complete hardening, projection durability, and CLI surface cleanup",
      "status": "MERGED"
    },
    "binds": {
      "prd_id": "PRD-PLACEHOLDER",
      "rfc_id": "RFC-0019",
      "requirements": [
        "REQ-0034",
        "REQ-0042"
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_SECURITY"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00621",
          "reason": "PREP phase infrastructure and queue/lifecycle hardening are prerequisites."
        },
        {
          "ticket_id": "TCK-00622",
          "reason": "Worker dedup/network posture semantics are consumed by push/gates closure behavior."
        }
      ]
    }
  },
  "root_cause_analysis": {
    "summary": "FAC push/review had several brittle integration edges that could stall the\nlifecycle or degrade reviewer trust:\n1) `fac review prepare` could diff against an incorrect base after main\n   advanced, producing empty or misleading review inputs.\n2) Verdict projection behavior around comment lifecycle/fan-in was fragile,\n   especially across re-runs and per-SHA comment identity.\n3) Legacy CLI subcommands overlapped with lifecycle/doctor semantics and\n   increased operational confusion.\n4) Push warm-path dedup behavior needed to stay closure-complete and\n   non-blocking when gates were already satisfied.\n"
  },
  "scope": {
    "in_scope": [
      {
        "id": "S6_PREPARE_BASE_SHA",
        "title": "Fix fac review prepare to use pr.base.sha instead of origin/main",
        "detail": "Ensure `apm2 fac review prepare` resolves base from GitHub PR metadata\n(`pr.base.sha`) when available, with strict SHA validation and reachable\nfallback to local main refs for offline operation.\n"
      },
      {
        "id": "S7_REMOVE_OBSOLETE_COMMANDS",
        "title": "Remove obsolete FAC CLI subcommands",
        "detail": "Remove superseded review subcommands now covered by lifecycle + doctor:\n`fac review dispatch`, `fac review wait`, `fac review status`,\n`fac review project`, and `fac resume`.\n"
      },
      {
        "id": "S8_VERDICT_COMMENT_POSTING",
        "title": "Harden verdict projection fan-in and per-SHA comment behavior",
        "detail": "Projection behavior for GitHub verdict comments must satisfy:\n1. One combined verdict comment per PR head SHA, emitted once all active\n   dimensions are resolved for that SHA.\n2. New review rounds (new head SHA) post a new comment; previous-round\n   comments are not edited as live state.\n3. Projection rendering includes all findings and the decision model ID\n   per dimension (`model_id`) in place of `set_by`.\n4. Create-path posting must preserve merged dimension payload for the\n   same SHA (no dimension loss during reinitialization/replay).\n5. Projection failures must be surfaced as hard errors.\n"
      },
      {
        "id": "S9_DEDUP_CACHE_AND_PUSH",
        "title": "Treat AlreadyCompleted dedup as pass-through for push",
        "detail": "`DenialReasonCode::AlreadyCompleted` indicates deduplicated success for\nan already-completed SHA and must not block `apm2 fac push`. Use\nexisting cache/context fields to resolve gate outcomes without rerun.\n"
      },
      {
        "id": "S10_HIDE_GATES_COMMAND",
        "title": "Hide `apm2 fac gates` from public CLI help",
        "detail": "Keep command callable for internal/debug use, but hide it from public\nhelp output to reduce accidental operator misuse.\n"
      }
    ],
    "out_of_scope": [
      "S1_CLOSURE_SCHEMA deferred to TCK-00624.",
      "S2_CLOSURE_HASH_IN_ATTESTATION deferred to TCK-00624.",
      "S3_PREP_HYDRATION deferred to TCK-00624.",
      "S4_DAEMON_SIGNING deferred to TCK-00624.",
      "S5_REGRESSION_TESTS (closure schema/signing matrix) deferred to TCK-00624.",
      "Shared DST module extraction is tracked in TCK-00624 after closure-complete push hardening is stable."
    ]
  },
  "plan": {
    "steps": [
      {
        "id": "STEP_01",
        "title": "Stabilize prepare head/base resolution",
        "detail": "Keep strict SHA validation for cached/API refs, prefer PR base SHA,\nand treat stale local identity as non-authoritative hint with fallback.\n"
      },
      {
        "id": "STEP_02",
        "title": "Finalize per-SHA verdict projection semantics",
        "detail": "Ensure create/update paths preserve merged payload for same SHA,\nmaintain per-SHA round separation, and surface projection failures.\n"
      },
      {
        "id": "STEP_03",
        "title": "Align lifecycle replay and projection wiring",
        "detail": "Keep replay scoped to matching PR + SHA, prevent stale-SHA fanout,\nand maintain closure-complete push progression.\n"
      },
      {
        "id": "STEP_04",
        "title": "Wire typed queue/pipeline failure taxonomy",
        "detail": "Distinguish prep supply unavailable, authority denied, and gate\nexecution failures in gates queue path outputs.\n"
      },
      {
        "id": "STEP_05",
        "title": "Dogfood push/review and verify idempotent warm-path",
        "detail": "Validate no stuck `apm2 fac push` behavior, warm-path dedup reuse, and\nreviewer lifecycle progression under repeated pushes.\n"
      }
    ]
  },
  "definition_of_done": {
    "evidence_ids": [
      "EXEC-TCK00623-PREPARE-BASE-SHA",
      "EXEC-TCK00623-VERDICT-PROJECTION",
      "EXEC-TCK00623-PUSH-DEDUP",
      "EXEC-TCK00623-CLI-SURFACE"
    ],
    "criteria": [
      "Prepare emits correct non-empty diff for reviewed SHA after push/main advance, with offline fallback intact.",
      "Verdict projection posts per-SHA combined comment with findings and model IDs, without cross-SHA comment mutation.",
      "Create/update projection failures are visible and fail-closed.",
      "`AlreadyCompleted` dedup does not block push; cached results are reused.",
      "Obsolete review subcommands are removed and `fac gates` is hidden from public help.",
      "Dogfooded `apm2 fac push` warm-path remains bounded and idempotent."
    ]
  },
  "notes": {
    "context": "This ticket now tracks closure-complete push/review hardening and lifecycle\ncorrectness. Foundational closure-schema/signing work is explicitly tracked\nin TCK-00624 to avoid mixed-scope acceptance ambiguity.\n",
    "security": "Strict SHA validation, stale-state rejection, typed failure surfaces, and\nper-SHA projection isolation preserve audit integrity and fail-closed\nbehavior.\n"
  }
}

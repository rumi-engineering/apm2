ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00622"
    title: "Enforce network denial during EXECUTE phase; normalize supply failure; fix FAC queue reliability"
    status: "MERGED"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: ["REQ-0033"]
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME", "DOMAIN_SECURITY", "DOMAIN_QUEUE"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00621"
        reason: "Two-phase structure must exist before network denial can be phase-scoped."

root_cause_analysis:
  summary: |
    Gate processes currently have unrestricted network access during execution.
    This allows non-deterministic external I/O (registry fetches, git clones)
    to occur mid-gate, making results non-reproducible and violating the
    hermetic execution model. Additionally, when network is unavailable,
    the failure surface is raw cargo/registry errors that implementors cannot
    act on without reading internal logs. Both problems are addressed together:
    deny network in EXECUTE and collapse the supply-failure surface to one
    normalized code in PREP.

    Additionally, a 2026-02-19 reliability audit
    revealed systemic FAC queue issues: the worker service fails to auto-restart
    after daemon shutdown (8.5h outage), duplicate SHA executions waste up to
    11x capacity, 50% of jobs are denied with opaque/missing reasons, stale lane
    leases block capacity, torn state on job completion causes ambiguous outcomes,
    and review projection SHA mismatches cause false-negative staleness checks.

scope:
  in_scope:
    - id: "S1_NETWORK_DENIAL_EXECUTE"
      title: "Deny network access for all gate processes in EXECUTE phase"
      detail: |
        Using Linux network namespaces (unshare(CLONE_NEWNET)) or
        equivalent cgroup-based network isolation, ensure gate worker
        processes have no outbound network access during EXECUTE.
        Record the network policy hash in the gate attestation receipt.
        Emit the enforcement method in the execute_started event.
    - id: "S2_SUPPLY_FAILURE_NORMALIZATION"
      title: "Normalize supply failures to PREP_SUPPLY_UNAVAILABLE in PREP"
      detail: |
        In PREP phase closure hydration hook:
          - If closure is incomplete AND network is available: fetch missing entries.
          - If closure is incomplete AND network is unavailable: emit structured
            failure with failure_code=PREP_SUPPLY_UNAVAILABLE, failure_class=supply,
            stage=prep, root_cause (human-readable summary of missing entries),
            remediation ("connect to network and retry to hydrate dependency closure").
          - Raw cargo/registry errors are captured as diagnostics[] only.
    - id: "S3_PREP_NETWORK_SCOPE"
      title: "Confine PREP network access to closure hydration only"
      detail: |
        PREP phase network access is allowed only for dependency closure
        hydration (S2 above). Other PREP steps (readiness controller,
        policy checks) MUST NOT initiate outbound network connections.
        Enforce via audit log or network namespace scoping per step.
    - id: "S4_REGRESSION_TESTS"
      title: "Regression tests for network isolation and supply failure"
      detail: |
        - Test: EXECUTE with network namespace: no outbound connections observed.
        - Test: offline run with pre-seeded closure: EXECUTE succeeds.
        - Test: offline run without closure: PREP emits PREP_SUPPLY_UNAVAILABLE
          (not a raw cargo error), zero gates run.
        - Test: online run with missing closure entries: PREP fetches and succeeds.

    - id: "S5_VERDICT_PROJECTION_ALL_DIMENSIONS"
      title: "GitHub projection MUST post comment only after all verdict dimensions resolve"
      detail: |
        BUG REPORT — observed in production.

        Current behavior:
          The GitHub projection in verdict_projection.rs posts a PR comment
          on the FIRST verdict dimension that resolves (e.g., security review
          completes → comment posted immediately). When the second dimension
          resolves (e.g., code-quality), the existing comment SHOULD be updated
          via merge_remote_dimensions_payload() + update_issue_comment(), but
          in practice the update does not occur — the comment remains showing
          only the first dimension's verdict.

        Root cause:
          persist_verdict_projection_locked() (verdict_projection.rs:540) calls
          project_decision_comment_with() (verdict_projection.rs:874) on each
          individual verdict persist. The first call creates the comment. The
          second call should fetch the existing comment, merge dimensions, and
          update — but the merge/update path is not reliably executing.

        Required behavior:
          The GitHub projection MUST NOT post a verdict comment until ALL
          active dimensions (ACTIVE_DIMENSIONS: ["security", "code-quality"])
          have resolved. Specifically:

          1. On each verdict persist, check whether all dimensions in
             ACTIVE_DIMENSIONS have a non-pending decision in the local
             projection record.
          2. If any dimension is still pending: persist locally only, do NOT
             post or update the GitHub comment.
          3. Only when ALL dimensions have resolved: render the full
             multi-dimension comment and post/update on GitHub.
          4. The posted comment MUST contain all dimension verdicts in a
             single rendering pass — no incremental posting.

        This eliminates the race between "first verdict posts" and "second
        verdict updates" entirely: there is exactly one GitHub comment write
        per verdict cycle, and it always contains the complete picture.

        References:
          - verdict_projection.rs:34-36 (ACTIVE_DIMENSIONS)
          - verdict_projection.rs:540 (persist_verdict_projection_locked)
          - verdict_projection.rs:832 (merge_remote_dimensions_payload)
          - verdict_projection.rs:874 (project_decision_comment_with)
          - verdict_projection.rs:1667 (aggregate_verdict_projection_overall_decision)
          - github_projection.rs:155 (create_issue_comment)
          - github_projection.rs:220 (update_issue_comment)

    - id: "S6_RULESET_CLEANUP"
      title: "Remove unused GitHub ruleset flags and review-gate workflow artifacts"
      detail: |
        The repository's GitHub branch protection is enforced by a single
        binary commit status (`apm2 / Forge Admission Cycle`) set by
        `apm2 fac push`. The following artifacts are unused and create
        confusion:

        1. REMOVE `strict_required_status_checks_policy: true` from
           `.github/rulesets/protect-main.json` (line 30). This flag
           enforces that ALL status checks must pass, which is overly
           broad when the only authoritative check is the FAC commit
           status. It can block merges on transient third-party checks
           that are not part of the FAC contract.

        2. REMOVE `.github/workflows/forge-admission-cycle.yml`. This
           workflow is a projection-only stub (workflow_dispatch only)
           that does not compute FAC verdicts. The authoritative path
           is `apm2 fac push` setting the commit status directly. The
           workflow creates the false impression that GitHub Actions
           participates in admission decisions.

        3. REMOVE `.github/review-gate/` directory contents:
           - `workflow-trust-policy.json` — not consumed by any active
             code path; trust policy is enforced in Rust via the FAC
             review lifecycle.
           - `trusted-reviewers.json` — reviewer trust is managed by
             the FAC review prompt system and verdict_projection, not
             by this static JSON.
           - `test-safety-allowlist.txt` — if still referenced by
             test_safety_guard.sh, migrate the reference before removal.

        4. Run `apm2 fac pr ruleset-sync` after local changes to push
           the updated ruleset to GitHub.

    - id: "S7_WORKER_LIFECYCLE"
      title: "Fix worker service auto-restart after daemon shutdown"
      detail: |
        BUG REPORT — observed 2026-02-19 (BUG-2026-02-19-fac-queue-reliability.md, Bug 1).

        The apm2-worker.service has Requires=apm2-daemon.service. When the
        daemon is stopped via CLI shutdown request, systemd stops the worker
        as a dependency. The daemon restarts, but systemd treats the
        dependency-triggered stop as explicit — Restart=always does not
        override it. Result: 8.5-hour undetected worker outage.

        Required fix:
          1. Change Requires= to BindsTo= + After= so the worker co-lifecycles
             with the daemon (stops AND restarts together), OR
          2. Change to Wants= so daemon stops don't cascade, OR
          3. Add a liveness watchdog (systemd path/timer unit) that detects
             worker death and restarts it independently.
          4. Whichever approach: verify that `apm2 daemon` CLI shutdown followed
             by daemon restart also restarts the worker within RestartSec.

        References:
          - ~/.config/systemd/user/apm2-worker.service
          - ~/.config/systemd/user/apm2-daemon.service

    - id: "S8_SHA_DEDUPLICATION"
      title: "Deduplicate gate jobs by SHA at enqueue or admission"
      detail: |
        BUG REPORT — observed 2026-02-19 (BUG-2026-02-19-fac-queue-reliability.md, Bug 2).

        The same SHA is gates-checked up to 11 times (e.g., a610be8 on PR #754).
        Other SHAs show 5-7x duplication. Each redundant run wastes ~19s of
        lane time (warm cache) or minutes (cold cache), generating unnecessary
        receipts and starving the single-lane queue.

        Required fix:
          At job enqueue or admission, check whether a completed receipt already
          exists for (repo_id, head_sha, kind=gates). If so, deny the job with
          denial_reason=already_completed without running gates.

          Edge cases to handle:
          - A SHA re-pushed after force-push should still be admitted (check
            commit timestamp or push event ID, not just SHA).
          - If a prior run was denied (not completed), the SHA should still be
            eligible for re-execution.

    - id: "S9_DENIAL_REASON_POPULATION"
      title: "Populate denial reasons in denied job files and eliminate unknown category"
      detail: |
        BUG REPORT — observed 2026-02-19 (BUG-2026-02-19-fac-queue-reliability.md, Bug 3).

        Out of 491 jobs, 243 were denied (49.5%). The dominant category is
        validation_failed (159) with denial_reason: null in the JSON files.
        34 jobs have denial_reason=unknown. Both are forensically useless.

        Required fixes:
          1. Every denied job JSON file MUST have a non-null denial_reason
             with a human-readable string describing the specific failure.
          2. Eliminate the "unknown" denial category entirely — map all error
             paths to specific, actionable denial reasons.
          3. For token_decode_failed (28 occurrences): either persist signing
             keys across daemon restarts, or drain/cancel pending jobs on key
             rotation so stale-token denials don't accumulate.

    - id: "S10_STALE_LANE_LEASE"
      title: "Detect and reap orphaned lane leases"
      detail: |
        BUG REPORT — observed 2026-02-19 (BUG-2026-02-19-fac-queue-reliability.md, Bug 4).

        Lane-00 shows state=LEASED with job_id=null, pid=null, pid_alive=null.
        `apm2 fac lane reconcile` reports it as "ok" despite the orphaned lease.
        The stale lease blocks the lane from accepting new jobs, reducing
        capacity by 33% (1 of 3 lanes).

        Required fixes:
          1. lane reconcile MUST detect LEASED + (pid=null OR pid not alive)
             as an error condition and release the lease, transitioning the
             lane to IDLE.
          2. The worker poll loop MUST proactively reap orphaned leases on
             each tick, not only on startup.
          3. Add a lane health metric: if a lease has no live PID for more
             than 2× the expected job duration, emit a warning event.

    - id: "S11_TORN_STATE_RACE"
      title: "Fix torn state on job completion (rename race between workers)"
      detail: |
        BUG REPORT — observed 2026-02-19 (BUG-2026-02-19-fac-queue-reliability.md, Bug 5).

        Worker journal shows: "torn state: receipt exists for job but move
        failed: rename claimed/...json -> denied/...json: No such file or
        directory (os error 2)". The receipt was written, but the atomic
        rename from claimed/ to denied/ failed because the source file was
        already gone — indicating a race with another process (reconciliation
        or concurrent worker) operating on the same claimed file.

        Required fixes:
          1. The pipeline commit operation MUST use advisory file locking
             (flock or equivalent) on the claimed job file before writing
             the receipt and performing the rename.
          2. If the source file is already gone at rename time, check whether
             a receipt already exists in the destination directory. If so,
             treat as idempotent success (log warning, do not error).
          3. Reconciliation MUST NOT move files that are currently flock'd
             by a worker.

    - id: "S12_REVIEW_PROJECTION_SHA_MISMATCH"
      title: "Fix review projection current_head_sha staleness"
      detail: |
        BUG REPORT — observed 2026-02-19 (BUG-2026-02-19-fac-queue-reliability.md, Bug 7).

        `apm2 fac review project --pr 751` reports current_head_sha=aa1bb58
        but GitHub confirms PR #751 HEAD is 0205a18. The current_head_sha
        field in the projection is stale.

        Required fix:
          When projecting a review, fetch the current PR HEAD SHA from GitHub
          (or from the local git state if the PR branch is available) and
          use that as current_head_sha. Do not rely on a cached/stored value
          that may be stale from a previous projection cycle.

  out_of_scope:
    - "Dependency closure artifact schema (TCK-00623)."
    - "Full failure taxonomy definition (TCK-00624)."
    - "JSONL event schema (TCK-00625)."
    - "Windows or macOS network isolation (Linux only for now)."

plan:
  steps:
    - id: "STEP_01"
      title: "Implement network namespace isolation for gate worker processes"
      detail: |
        In the gate process launcher, call unshare(CLONE_NEWNET) before exec
        (or equivalent systemd-run --property=IPAddressDeny=any). Record
        enforcement method and verify no connections are possible from within
        the gate process boundary.
    - id: "STEP_02"
      title: "Implement supply failure normalization in PREP closure hydration hook"
      detail: |
        Wire the PREP closure hydration stub (from TCK-00621) with real logic:
        detect incomplete closure, attempt fetch if network available, else
        emit PREP_SUPPLY_UNAVAILABLE with structured fields.
    - id: "STEP_03"
      title: "Verify PREP network scope confinement"
      detail: |
        Add audit assertions that non-hydration PREP steps do not initiate
        network connections. Use strace or similar in test mode to verify.
    - id: "STEP_04"
      title: "Fix verdict projection to post only after all dimensions resolve"
      detail: |
        In persist_verdict_projection_locked(), add a gate before calling
        project_decision_comment_with(): check that all ACTIVE_DIMENSIONS
        have a non-pending decision in the local DecisionProjectionRecord.
        If any dimension is pending, skip GitHub projection (persist locally
        only). When all dimensions resolve, render and post the full comment
        in a single write.

    - id: "STEP_05"
      title: "Remove unused ruleset flag, workflow, and review-gate artifacts"
      detail: |
        1. Edit .github/rulesets/protect-main.json: remove
           strict_required_status_checks_policy or set to false.
        2. Delete .github/workflows/forge-admission-cycle.yml.
        3. Delete .github/review-gate/ directory (after verifying
           test-safety-allowlist.txt is not referenced by active code).
        4. Run apm2 fac pr ruleset-sync to push updated ruleset.

    - id: "STEP_06"
      title: "Fix worker service lifecycle (co-restart with daemon)"
      detail: |
        Update apm2-worker.service to use BindsTo= + After= instead of
        Requires= for the daemon dependency. This ensures the worker stops
        AND restarts when the daemon cycles. Verify with: stop daemon,
        confirm worker stops, start daemon, confirm worker starts within
        RestartSec. Update any install/setup scripts that generate the
        systemd unit file.
    - id: "STEP_07"
      title: "Implement SHA-based job deduplication at admission"
      detail: |
        In the job admission path, before accepting a gates job, query
        completed receipts for (repo_id, head_sha, kind=gates). If a
        completed receipt exists, deny with already_completed. Handle
        force-push edge case (different push event → allow re-run).
    - id: "STEP_08"
      title: "Populate denial reasons and eliminate unknown category"
      detail: |
        Audit all denial code paths. Ensure every denied job JSON file
        has a non-null, specific denial_reason string. Remove or replace
        all "unknown" denial reasons with specific error descriptions.
        Address token_decode_failed by persisting signing keys across
        daemon restarts or draining stale-token jobs on key rotation.
    - id: "STEP_09"
      title: "Fix stale lane lease detection and reaping"
      detail: |
        Update lane reconcile to detect LEASED + (pid=null OR !pid_alive)
        as an error and release the lease → IDLE. Add proactive orphan
        reaping to the worker poll loop (not just startup). Add warning
        event emission for leases with no live PID beyond threshold.
    - id: "STEP_10"
      title: "Fix torn state race on job completion"
      detail: |
        Add advisory file locking (flock) on claimed job files during
        pipeline commit. If rename source is gone but receipt exists in
        destination, treat as idempotent success. Prevent reconciliation
        from moving flock'd files.
    - id: "STEP_11"
      title: "Fix review projection current_head_sha staleness"
      detail: |
        In the review projection path, fetch the current PR HEAD SHA from
        GitHub API (or local git state) at projection time instead of
        relying on a cached value. Ensure current_head_sha always reflects
        the actual PR HEAD.
    - id: "STEP_12"
      title: "Add regression tests and workspace validation"
      detail: |
        cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings
        cargo doc --workspace --no-deps && cargo test --workspace

definition_of_done:
  evidence_ids:
    - "EXEC-TCK00622-NETWORK-DENIAL"
    - "EXEC-TCK00622-SUPPLY-UNAVAILABLE"
    - "EXEC-TCK00622-VERDICT-PROJECTION"
    - "EXEC-TCK00622-RULESET-CLEANUP"
    - "EXEC-TCK00622-WORKER-LIFECYCLE"
    - "EXEC-TCK00622-SHA-DEDUP"
    - "EXEC-TCK00622-DENIAL-REASONS"
    - "EXEC-TCK00622-LANE-LEASE"
    - "EXEC-TCK00622-TORN-STATE"
    - "EXEC-TCK00622-REVIEW-SHA"
    - "EXEC-TCK00622-WORKSPACE-VALIDATION"
  criteria:
    - "EXECUTE phase: all gate processes run with network denied; verified by test."
    - "Offline run with pre-seeded closure: succeeds without network access."
    - "Offline run without closure: emits exactly PREP_SUPPLY_UNAVAILABLE with all required fields."
    - "PREP_SUPPLY_UNAVAILABLE output contains no raw cargo/registry errors at top level."
    - "PREP network access is limited to closure hydration only."
    - "GitHub verdict comment is posted only after ALL active dimensions have resolved."
    - "No partial/single-dimension verdict comments appear on PRs."
    - "Regression test: first verdict persists locally only; second verdict triggers GitHub post with both dimensions."
    - "strict_required_status_checks_policy is removed from .github/rulesets/protect-main.json."
    - ".github/workflows/forge-admission-cycle.yml is deleted."
    - ".github/review-gate/ directory is deleted (with test-safety-allowlist.txt migrated if referenced)."
    - "Worker service restarts automatically when daemon cycles; verified by stopping daemon and confirming worker co-restarts."
    - "Duplicate SHA gates jobs are denied with already_completed; same SHA is never gates-checked more than once per push event."
    - "All denied job JSON files have non-null, specific denial_reason; no 'unknown' denial category exists."
    - "token_decode_failed denials do not accumulate after daemon restart (keys persisted or stale jobs drained)."
    - "lane reconcile detects and releases orphaned leases (LEASED + no live PID → IDLE)."
    - "Worker poll loop proactively reaps orphaned leases, not only on startup."
    - "Job pipeline commit uses advisory locking; torn state (receipt exists, rename fails) is handled as idempotent success."
    - "Review projection current_head_sha matches actual GitHub PR HEAD SHA at projection time."
    - "Regression tests pass for all isolation, failure normalization, and queue reliability invariants."
    - "Workspace validation completes successfully."

notes:
  context: |
    Network denial in EXECUTE is a security boundary, not just a performance
    optimization. The normalization of supply failures to PREP_SUPPLY_UNAVAILABLE
    is essential for the usability contract: implementor agents must be able to
    act on a failure without reading internal logs.

    Queue reliability items (S7-S12) were added from the 2026-02-19 reliability
    audit (BUG-2026-02-19-fac-queue-reliability.md). Bug 6 from that report
    (strict_required_status_checks_policy drift) was already covered by S6.
  security: "fail-closed: network denied in EXECUTE; supply failure is a PREP abort"
  queue_reliability_reference: "BUG-2026-02-19-fac-queue-reliability.md"

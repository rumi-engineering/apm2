ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00677"
    title: "apm2-core orchestrator_kernel: make cursor type generic (KernelCursor) and treat CompositeCursor as one implementation (unblocks BFT/seq cursors before wide adoption)"
    status: "OPEN"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0020"
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER", "AGENT_REVIEWER"]
    responsibility_domains: ["DOMAIN_KERNEL", "DOMAIN_RUNTIME"]
  dependencies:
    tickets: []

root_cause_analysis:
  summary: |
    apm2-core's OrchestratorKernel currently hardcodes `CompositeCursor` everywhere
    (crates/apm2-core/src/orchestrator_kernel/{types.rs,ledger_tailer.rs,controller_loop.rs}).

    This prematurely cements "timestamp_ns + event_id" as the only cursor representation, which:
      - makes integration with BFT ledger finality / seq cursors awkward,
      - incentivizes adapters to shoehorn ledger positions into timestamp/event_id even when the
        natural cursor is a commit index or sequence number,
      - increases the cost of future migrations once multiple orchestrators adopt the kernel.

    Today, only one daemon consumer exists (gate timeout kernel). This is the correct moment to
    generalize the cursor type with minimal blast radius.

scope:
  in_scope:
    - id: "OK-CURSOR-001"
      title: "Introduce KernelCursor and make kernel traits cursor-generic"
      detail: |
        In apm2-core orchestrator_kernel:
          - Define a new trait:
              pub trait KernelCursor:
                Clone + Default + Ord + serde::Serialize + serde::de::DeserializeOwned +
                std::fmt::Debug + Send + Sync + 'static {}
            Provide a blanket impl for all types satisfying bounds.

          - Update CompositeCursor:
              * derive PartialOrd + Ord (currently derives PartialEq/Eq only).

          - Update CursorEvent:
              from: trait CursorEvent { fn timestamp_ns(&self)->u64; fn event_id(&self)->&str; }
              to:   trait CursorEvent<C: KernelCursor> { fn cursor(&self) -> C; }

            Keep CompositeCursor as the default cursor implementation by adding helper impls or type aliases.

          - Update LedgerReader and CursorStore traits to use an associated cursor type:
              trait LedgerReader<E> { type Cursor: KernelCursor; async fn poll(&self, cursor: &Self::Cursor, limit: usize) -> ...; }
              trait CursorStore<C: KernelCursor> { ... }

            (Exact signature can vary, but MUST eliminate hardcoding CompositeCursor.)

          - Update ledger_tailer helpers:
              * is_after_cursor must compare Cursor via Ord
              * advance_cursor_with_event must use max(cursor, event.cursor())
              * sort_and_truncate_events must sort by event.cursor()

    - id: "OK-CURSOR-002"
      title: "Ergonomics: keep CompositeCursor-first experience via aliases"
      detail: |
        Add type aliases / convenience wrappers so most orchestrators still look like "the simple case":
          - type DefaultCursor = CompositeCursor
          - type DefaultTickConfig = TickConfig (unchanged)
          - Optionally: helper trait alias / prelude exports for CompositeCursor-based users.

        Goal: cursor-generic kernel without forcing every consumer to write verbose generics.

    - id: "OK-CURSOR-003"
      title: "Implement CursorEvent for EventEnvelope (CompositeCursor) to encourage reuse"
      detail: |
        In crates/apm2-core/src/orchestrator_kernel/types.rs:
          - Implement CursorEvent<CompositeCursor> for EventEnvelope<T> by returning:
              CompositeCursor { timestamp_ns: self.timestamp_ns, event_id: self.event_id.clone() }

        This makes `EventEnvelope` a usable default event carrier for orchestrators and encourages
        shared ledger reader adapters.

    - id: "OK-CURSOR-004"
      title: "Update current daemon consumer and kernel tests"
      detail: |
        Update gate timeout kernel event types implementing CursorEvent to the new signature.
        Update orchestrator_kernel unit tests (ledger_tailer and controller_loop) to compile and
        still validate determinism/idempotency behavior.

    - id: "OK-CURSOR-005"
      title: "Documentation + enforcement: cursor is ledger-specific; kernel requires total order"
      detail: |
        Documentation:
          - Expand crates/apm2-core/src/orchestrator_kernel/mod.rs doc comment to state:
              * KernelCursor is ledger-specific.
              * Cursor must define a total order consistent with the ledger reader's returned order.
              * CompositeCursor is appropriate for timestamp+id ledgers; seq cursors are valid too.

        Enforcement:
          - Add a code-quality reviewer invariant (or via TCK-00678):
              "New orchestrator-kernel consumers must not assume epoch timestamps are the cursor.
               They must choose a cursor matching ledger truth (seq/commit index if available)."
          - Add a small doc snippet in safe-patterns reference describing cursor choices.

  out_of_scope:
    - Adding explicit BFT finality handling to the kernel (ledger reader can enforce finality).
    - Migrating multiple orchestrators (this is preparatory refactor).

implementation_notes:
  critical_structural_boundaries:
    - id: "IMPL-OK-CURSOR-01"
      title: "Kernel does not own the ledger ordering truth"
      detail: |
        LedgerReader is responsible for returning events consistent with its cursor ordering. KernelCursor's Ord
        must match that order. The kernel may sort as a safety belt, but must not invent semantics beyond Ord.

documentation_and_enforcement:
  documentation_deliverables:
    - "orchestrator_kernel module docs updated with cursor semantics and examples."
    - "EventEnvelope documented as a default event carrier (with CursorEvent impl)."
  enforcement_deliverables:
    - "Reviewer invariant added (prompt or safe-patterns) preventing timestamp-cursor lock-in."

plan:
  steps:
    - "Define KernelCursor trait and update CompositeCursor derives."
    - "Refactor CursorEvent, LedgerReader, CursorStore signatures to be cursor-generic."
    - "Refactor ledger_tailer helper functions to generic cursor ordering."
    - "Update controller_loop run_tick to generic cursor usage."
    - "Implement CursorEvent<CompositeCursor> for EventEnvelope."
    - "Update tests in apm2-core orchestrator_kernel."
    - "Update daemon gate timeout kernel to compile against new traits."
    - "Update documentation and enforcement artifacts."

definition_of_done:
  criteria:
    - "apm2-core orchestrator_kernel no longer hardcodes CompositeCursor in its trait surface."
    - "CompositeCursor remains available and ergonomic via aliases/impls."
    - "Gate timeout kernel compiles and runs with new cursor-generic traits."
    - "All orchestrator_kernel unit tests pass."
    - "Docs clearly state cursor contract and ledger-specific cursor choices."

risks:
  - id: "R-OK-CURSOR-01"
    title: "Generic cursor refactor could over-complicate the kernel API"
    mitigation: |
      Add aliases and keep defaults. Limit trait bounds to what is strictly necessary
      (Clone/Ord/serde) and avoid introducing extra trait layers.

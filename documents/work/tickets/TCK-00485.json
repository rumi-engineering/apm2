{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00485",
      "title": "PCAC-gated declassification receipts with durable single-use and request-scoped binding",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0010",
      "rfc_id": "RFC-0027",
      "requirements": [
        {
          "requirement_id": "REQ-0002",
          "requirement_ref": "documents/rfcs/RFC-0027/requirements/REQ-0002.yaml#requirement"
        },
        {
          "requirement_id": "REQ-0005",
          "requirement_ref": "documents/rfcs/RFC-0027/requirements/REQ-0005.yaml#requirement"
        }
      ],
      "evidence_artifacts": [
        {
          "evidence_id": "EVID-0003",
          "artifact_ref": "documents/rfcs/RFC-0027/evidence_artifacts/EVID-0003.yaml#evidence_artifact"
        }
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER",
        "AGENT_REVIEWER"
      ],
      "responsibility_domains": [
        "DOMAIN_SECURITY",
        "DOMAIN_RUNTIME"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00482",
          "reason": "DelegateSublease PCAC cutover establishes mandatory kernel pattern."
        },
        {
          "ticket_id": "TCK-00465",
          "reason": "Boundary-flow integrity provides the declassification receipt types being gated."
        }
      ]
    },
    "scope": {
      "in_scope": [
        "Replace in-memory consumed_redundancy_receipts tracking with PCAC AJC lifecycle for declassification receipts.",
        "Declassification receipt consumption becomes an AJC-gated effect: join input includes declassification_receipt_hash + request-specific intent_digest (tool_class, channel_key, argument/content digest).",
        "Law 1 (Linear Consumption) + DurableConsumeIndex ensures crash-safe single-use across daemon restarts.",
        "Law 2 (Intent Equality) ensures receipts cannot be replayed across unrelated requests â€” the intent_digest binds the receipt to the specific request payload.",
        "Fix receipt_id uniqueness collision: redundancy_receipt_consumed events must use a scoped uniqueness constraint (event_type + receipt_id), not the global idx_unique_receipt_id that collides with review_receipt_recorded.",
        "Delete in-memory consumed_redundancy_receipts HashMap and all associated lifecycle code."
      ],
      "out_of_scope": [
        "Authoritative leakage/timing witness infrastructure (TCK-00488).",
        "Ledger namespace isolation for policy-root derivation (TCK-00486)."
      ]
    },
    "plan": {
      "steps": [
        "Define declassification receipt consumption as a PCAC-gated effect in boundary-flow admission path.",
        "Build AJC join input: include declassification_receipt_hash, request intent digest (tool_class + channel_key + argument_content_digest), lease_id, work_id, freshness bindings.",
        "Wire join/consume lifecycle: consume only on successful boundary admission; deny on missing/invalid/already-consumed receipt.",
        "Scope idx_unique_receipt_id to event_type or add dedicated index for consumption events.",
        "Delete in-memory tracking code; verify DurableConsumeIndex covers all single-use invariants.",
        "Add tests: (a) receipt reuse denied across requests, (b) receipt reuse denied across daemon restarts, (c) receipt_id uniqueness does not collide between review and consumption events, (d) intent-mismatched receipt denied.",
        "Run mandatory pre-commit checks."
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-0003"
      ],
      "criteria": [
        "Declassification receipt consumption is AJC-gated with durable single-use.",
        "Receipt reuse denied across requests AND across daemon restarts.",
        "Intent digest binding prevents cross-request replay.",
        "receipt_id uniqueness scoped to event type; no collision between review and consumption events.",
        "In-memory consumed_redundancy_receipts HashMap deleted."
      ]
    },
    "notes": {
      "security": "This ticket applies PCAC to the exact problem class it was designed for: making authority\nconsumption single-use, crash-safe, and request-scoped. The current in-memory tracking was\nflagged in PR #594 rounds 4-6 as a persistent security finding.\n\nKey PCAC laws applied:\n- Law 1 (Linear Consumption): each declassification receipt authorizes at most one boundary downgrade\n- Law 2 (Intent Equality): consume requires exact intent digest equality (tool_class + channel_key + content)\n- Law 3 (Freshness Dominance): Tier2+ consume denies on stale/missing freshness authority\n",
      "verification": "Crash-safety test: kill daemon between join and consume, restart, verify receipt not consumed.\nCross-request replay test: consume receipt for request A, attempt reuse for request B, verify deny.\n"
    }
  }
}

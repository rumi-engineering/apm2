ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00666"
    title: "Daemon: add kernel-native review status projection + query surface (work_id -> reviewer state) to eliminate review_state.json as truth"
    status: "OPEN"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0032"
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_DAEMON", "DOMAIN_KERNEL", "DOMAIN_PROTOCOL", "DOMAIN_CLI"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00638"
        reason: "WorkContextEntry evidence publishing is the canonical carrier for findings/verdict."
      - ticket_id: "TCK-00649"
        reason: "Defines REVIEW_FINDING/REVIEW_VERDICT context entries and bridges review receipts."
      - ticket_id: "TCK-00654"
        reason: "CLI wait integration uses pulse subscriptions; review status should integrate with the same surfaces."

root_cause_analysis:
  summary: |
    FAC review currently maintains its own lifecycle truth via:
      - ~/.apm2/review_state.json (per-reviewer PID/start/log pointers),
      - pulse files for SHA freshness,
      - NDJSON telemetry,
      - bespoke GitHub projection caches.

    This duplicates state already representable in the kernel substrate:
      - reviewer claims/leasing (ClaimWorkV2 + leases),
      - session start/terminate events,
      - review receipt events and work context entries,
      - pulse plane topic derivations.

    Without a daemon-native projection, other subsystems (doctor, implementer orchestration,
    CI processor) cannot reliably reason about reviewer status, and the CLI remains forced
    to infer truth from brittle local files and PID checks.

scope:
  in_scope:
    - id: "RSP-001"
      title: "Define ReviewStatusProjectionV1 (bounded) derived from ledger+CAS"
      detail: |
        Implement a daemon projection that, for each (work_id, reviewer_role/review_kind),
        derives a bounded status object with fields such as:
          - claim: actor_id, lease_id, lease_expires_at
          - session: session_id, state (pending/alive/done/failed), last_heartbeat_ts (if available)
          - receipt: receipt_id, verdict, artifact_bundle_hash, blocked_reason_code
          - context: latest REVIEW_VERDICT entry digest, bounded list of latest REVIEW_FINDING digests (N max)
          - head_sha / changeset_digest binding (as applicable)

        Boundedness requirements:
          - cap findings digests at MAX_FINDINGS_PER_ROLE
          - cap strings (role ids, session ids) by existing constants in core (MAX_ID_LENGTH etc)
          - projection rebuild must be incremental via cursor, not full ledger scan on every query

    - id: "RSP-002"
      title: "Expose a query surface for review status (daemon RPC)"
      detail: |
        Add a daemon protocol request/response pair:
          - GetReviewStatusRequest { work_id, review_kind? }
          - GetReviewStatusResponse { statuses: [ReviewStatusProjectionV1] }

        Alternatively, if adding a new RPC is undesirable, extend an existing RPC (e.g., WorkStatus)
        in a backward-compatible way with an optional embedded review status block.

        The query must be:
          - O(1) or O(log n) with indexed projection tables (no replay per request)
          - safe under concurrent writes (read-only connection or mutex-protected reader)

    - id: "RSP-003"
      title: "CLI integration: prefer kernel-native projection for `apm2 fac doctor` / review status UX"
      detail: |
        Update relevant CLI commands (doctor, review status, restart decisions) to consume the daemon
        review status projection first, and treat any local caches as derived/operator-only.
        This is a step toward deleting review_state.json as canonical truth.

    - id: "RSP-004"
      title: "Verification: replay equivalence and monotonicity for projection"
      detail: |
        Add tests that:
          - reconstruct projection from genesis vs from checkpoint + delta (same result)
          - duplicate events do not change final semantics
          - receipt events advance status monotonically to terminal

  out_of_scope:
    - Full removal of fac_review local caches (subsequent tickets).
    - Rewriting GitHub projection caching (addressed separately).

plan:
  steps:
    - Implement projection data model and reducer over the relevant event families.
    - Add projection storage/indexing (SQLite tables or existing projection store).
    - Add protocol request/response and daemon handler.
    - Update CLI to call query surface and display results.
    - Add replay/idempotency tests.

definition_of_done:
  criteria:
    - "Daemon can answer review status for a work_id purely from ledger+CAS-derived projections."
    - "CLI commands can render reviewer status without reading review_state.json."
    - "Projection is bounded and cursor/incremental; no full ledger scan per query."
    - "Replay equivalence tests pass."

risks:
  - id: "R-RSP-01"
    title: "Event vocabulary divergence between legacy fac_review and kernel-native reviewer loop"
    mitigation: |
      Gate this projection on RFC-0032 reviewer bridge event families (ClaimWorkV2, work context entries,
      review receipts). Keep legacy fac_review parsing as a temporary derived view until migration completes.

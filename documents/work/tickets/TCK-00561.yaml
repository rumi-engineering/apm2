ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00561"
    title: "Policy update + adoption protocol: broker-admitted FacPolicyHash rotation with receipts + rollback"
    status: "OPEN"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_SECURITY", "DOMAIN_RUNTIME"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00510"
        reason: "Broker must exist as the authority for admitted policy digests."
      - ticket_id: "TCK-00521"
        reason: "FacPolicyV1 + FacPolicyHash must exist."
      - ticket_id: "TCK-00513"
        reason: "Need receipts to record policy adoption events."
  scope:
    in_scope:
      - "Define how a new `FacPolicyV1` becomes authoritative (admitted) in default mode."
      - "Broker maintains admitted policy digest under `$APM2_HOME/private/fac/broker/admitted_policy_root.v1` (digest only; non-secret)."
      - "Introduce a CLI surface:"
      - "  - `apm2 fac policy show` (prints current policy + hash)"
      - "  - `apm2 fac policy validate <path|stdin>` (checks schema + computes hash)"
      - "  - `apm2 fac policy adopt <path|stdin>` (requests broker to adopt new policy digest)"
      - "Policy adoption MUST be atomic and rollbackable:"
      - "  - broker writes `admitted_policy_root.v1` via atomic rename"
      - "  - broker retains `admitted_policy_root.prev.v1` for rollback"
      - "  - worker refuses actuation tokens whose policy binding does not match admitted digest"
      - "Every policy adoption and rollback MUST emit a durable receipt:"
      - "  - `apm2.fac.policy_adoption_receipt.v1` (new) OR a FacJobReceiptV1(kind=policy_adopt)"
      - "Receipt includes old_digest, new_digest, actor identity (broker), and reason string."
    out_of_scope:
      - "Remote policy distribution."
      - "UI for policy editing."
  plan:
    steps:
      - "Implement broker endpoint: adopt_policy(fac_policy_hash) with atomic persistence."
      - "Implement CLI commands and guardrails (must be run by operator role / local admin)."
      - "Implement adoption receipt emission."
      - "Implement rollback command: `apm2 fac policy rollback`."
  definition_of_done:
    evidence_ids: []
    criteria:
      - "Policy changes are reflected in new actuation tokens and validated by workers."
      - "Workers fail-closed when policy binding mismatches (no silent drift)."
      - "Rollback works and is recorded as receipts."
  notes:
    security: |
      This is a critical control plane. Adoption must not accept an arbitrary file path without schema+hash validation.
      Policy adoption should require explicit operator action (not something an untrusted job can trigger).

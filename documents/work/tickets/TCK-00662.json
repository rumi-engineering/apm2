{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00662",
      "title": "SUPERSEDED: FAC lane-reset PID kill hardening (doctor-first remediation removed lane reset path)",
      "status": "CANCELLED"
    },
    "binds": {
      "prd_id": "PRD-0001",
      "rfc_id": "RFC-0019",
      "requirements": [
        "REQ-0008",
        "REQ-0037"
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "Implementer",
        "Reviewer"
      ],
      "responsibility_domains": [
        "fac/ops-tools",
        "fac/lane-lease"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00658"
      ]
    }
  },
  "supersession": {
    "superseded_by_tickets": [
      "TCK-00658",
      "TCK-00659",
      "TCK-00660"
    ],
    "rationale": "This ticket targeted safety hardening for PID-based kills in `apm2 fac lane reset`.\nThe lane-reset/remediation surface has since been removed in favor of doctor-first\nremediation. With lane PID identity checks and stale-lease handling merged, the\nremaining lane-reset kill-specific scope is no longer relevant.\n"
  },
  "context": {
    "observed_symptoms": [
      "Manual remediation via `apm2 fac lane reset --force` can kill the wrong process under PID reuse.",
      "Operators avoid lane reset or overuse it, creating reliability and safety risk."
    ],
    "code_evidence": [
      "kill_process_best_effort currently only checks that /proc/<pid>/comm exists, then SIGTERM/SIGKILL:\n  crates/apm2-cli/src/commands/fac.rs:5124-5171\n",
      "Lane leases currently store only pid (and after TCK-00658 will store proc_start_time_ticks),\nbut kill path does not (yet) verify identity.\n"
    ]
  },
  "problem_statement": "Operator tooling that kills processes by PID must be PID-reuse safe. A lane reset that kills an\nunrelated process is unacceptable. The tooling should only kill a process if it can prove that the\nprocess is the one recorded in the lane lease (PID + start time match), otherwise fail closed.\n",
  "proposed_change": {
    "intent": "Make all PID-based remediation identity-verified:\n  - If a lane lease has proc_start_time_ticks, verify it before sending any signal.\n  - If identity cannot be verified, refuse by default and require a more explicit operator action.\n"
  },
  "invariants": [
    {
      "id": "INV-KILL-001",
      "statement": "No PID-based kill may be issued unless process identity is verified (PID + starttime match) OR the operator explicitly opts into an unsafe override."
    },
    {
      "id": "INV-KILL-002",
      "statement": "Default behavior must be fail-closed (refuse to kill) when identity is unknown."
    }
  ],
  "scope": {
    "in_scope": [
      {
        "id": "S1",
        "description": "Replace kill_process_best_effort with identity-verified variant:\n  - kill_process_if_identity_matches(pid, expected_start_ticks) -> Result<KillOutcome>\n  - Use the same /proc/<pid>/stat starttime parsing helper introduced in TCK-00658.\n  - Only send SIGTERM/SIGKILL when identity matches.\n"
      },
      {
        "id": "S2",
        "description": "Update `apm2 fac lane reset`:\n  - When a lease exists and includes proc_start_time_ticks:\n      * verify identity\n      * kill only on match\n  - When lease lacks proc_start_time_ticks:\n      * refuse by default with a clear error message\n      * optionally allow `--unsafe-kill-by-pid` (explicitly named) for emergency cases\n"
      },
      {
        "id": "S3",
        "description": "Update any other PID-based remediation paths (search for kill()/SIGTERM usage in fac commands)\nto use the identity-verified helper.\n"
      },
      {
        "id": "S4",
        "description": "Add tests:\n  - Create a fake lease with pid=current process pid and mismatched start ticks => kill refused.\n  - Spawn child process and use correct start ticks => kill attempted (in test, stub out actual SIGKILL).\n  - CLI-level test: lane reset refuses when identity missing unless unsafe flag provided.\n"
      }
    ],
    "out_of_scope": [
      "Killing systemd units by unit name (already safer and preferred)."
    ]
  },
  "plan": {
    "steps": [
      {
        "id": "P1",
        "description": "Implement identity-verified kill helper (with injectable signal sender for tests)."
      },
      {
        "id": "P2",
        "description": "Wire helper into fac lane reset command; add unsafe override flag + messaging."
      },
      {
        "id": "P3",
        "description": "Audit other PID-kill call sites and update."
      },
      {
        "id": "P4",
        "description": "Add tests + docs in AGENTS.md (PID reuse safety section) and fac doctor remediation advice."
      }
    ]
  },
  "definition_of_done": {
    "criteria": [
      "Lane reset cannot kill an unrelated PID by default (identity mismatch => refusal).",
      "Unsafe override is explicit, noisy, and gated behind a dedicated flag name.",
      "Unit tests cover identity match/mismatch behavior."
    ],
    "evidence_ids": [
      "EVID-TCK-00662-01 (unit): identity-verified kill refuses on mismatch",
      "EVID-TCK-00662-02 (cli): lane reset refuses without identity unless unsafe override"
    ]
  },
  "notes": {
    "operator_ux": "The refusal message should include:\n  - lane_id\n  - pid\n  - expected_start_ticks (if any)\n  - observed_start_ticks (if pid alive)\n  - recommended safer alternative: stop systemd unit (stop_revoke) or investigate lane corruption\n"
  }
}

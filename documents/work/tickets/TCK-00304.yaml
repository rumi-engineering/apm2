ticket_meta:
  schema_version: "2026-01-24"
  template_version: "2026-01-24"
  ticket:
    id: "TCK-00304"
    title: "HEF: Outbox + pulse publisher (post-commit)"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0018"
    requirements:
      - requirement_id: "REQ-HEF-0006"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0006.yaml#requirement"
      - requirement_id: "REQ-HEF-0001"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0001.yaml#requirement"
    evidence_artifacts:
      - evidence_id: "EVID-HEF-0006"
        artifact_ref: "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0006.yaml#evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_KERNEL"
      - "DOMAIN_PROTOCOL"
  dependencies:
    tickets:
      - ticket_id: "TCK-00287"
        reason: "Depends on base HEF protocol infrastructure"
      - ticket_id: "TCK-00300"
        reason: "Requires PulseEnvelopeV1 proto definition"
      - ticket_id: "TCK-00302"
        reason: "Requires subscription registry for ACL filtering on fanout"
  scope:
    in_scope:
      - "Implement daemon-owned outbox populated only after ledger commit"
      - "Implement pulse publisher that drains outbox and emits PulseEvent frames"
      - "Apply ACL filtering during pulse fanout to subscribers"
      - "Enforce CAS->ledger->pulse ordering invariant"
      - "Define CommitNotification struct in apm2-core with no daemon type dependencies"
      - "Implement channel-based post-commit notification interface per FND-RFC-0018-005"
      - "CommitNotification fields: seq_id (u64), event_hash ([u8; 32]), event_type (String), namespace (String), consensus_index (Option<ConsensusIndex>)"
      - "Channel type: tokio::sync::mpsc::Sender<CommitNotification> with capacity 1024"
      - "Use try_send() for non-blocking notification; notify() MUST NOT block"
      - "On send failure: LOG_WARN_DROP (fire-and-forget; never fails commit)"
      - "On channel disconnected: LOG_DEBUG_IGNORE (expected during shutdown)"
      - "On channel full: DROP_INCREMENT_METRIC (hef_notification_drops counter)"
      - "BftLedgerBackend accepts optional CommitNotificationSender at construction"
      - "Integration point: BftLedgerBackend::on_commit() sends after tx.commit() succeeds"
      - "Create pulse_outbox.rs for post-commit queue draining channel"
    out_of_scope:
      - "Callback-based notification (channel-based required per DD-HEF-0007)"
      - "Persistent outbox storage across daemon restarts"
      - "Guaranteed delivery semantics (best-effort notification)"
      - "Notification retries on failure"
      - "Direct daemon type imports in apm2-core"
  plan:
    steps:
      - "Define CommitNotification struct in crates/apm2-core/src/ledger/mod.rs"
      - "Export CommitNotification and Sender type alias from ledger module"
      - "Add optional commit_notification_sender field to BftLedgerBackend"
      - "Modify BftLedgerBackend constructor to accept optional sender"
      - "Implement try_send() call in BftLedgerBackend::on_commit() after tx.commit()"
      - "Add LOG_WARN on send failure with hef_notification_drops metric increment"
      - "Create pulse_outbox.rs in crates/apm2-daemon/src/protocol/"
      - "Implement outbox receiver that drains channel into local queue"
      - "Implement pulse publisher that converts CommitNotification to PulseEvent"
      - "Wire ACL filtering from subscription registry into publisher fanout"
      - "Add unit tests for CommitNotification send/receive"
      - "Add integration test verifying pulse emission only after ledger commit"
      - "Add test for channel full scenario with metric increment"
  definition_of_done:
    evidence_ids:
      - "EVID-HEF-0006"
    criteria:
      - "Pulse is emitted only after ledger append succeeds."
      - "apm2-core has no daemon dependency; outbox state is daemon-owned."
      - "Post-commit hook never fails the ledger append; fanout is decoupled."
      - "CommitNotification struct defined in apm2-core with no daemon type dependencies."
      - "Channel-based notification with try_send(); full channel drops notification."
      - "Notification drops logged at WARN and increment hef_notification_drops metric."
      - "BftLedgerBackend accepts optional CommitNotificationSender at construction."
  notes:
    security: "default-deny, least privilege, fail-closed"
    verification: "Verify ordering invariant with concurrent ledger writes and pulse subscriptions"

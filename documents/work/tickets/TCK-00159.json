{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00159",
      "title": "Implement EpisodeEnvelope type with canonicalization",
      "status": "CLOSED"
    },
    "binds": {
      "rfc_id": "RFC-0013",
      "requirements": [
        {
          "requirement_id": "REQ-EPISODE-001"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00158"
      }
    ]
  },
  "acceptance_criteria": [
    {
      "criterion": "EpisodeEnvelope struct with all fields per AD-EPISODE-001",
      "verification": "Unit test verifies field presence and types"
    },
    {
      "criterion": "canonical_bytes() produces deterministic serialization",
      "verification": "Golden vectors match expected digests"
    },
    {
      "criterion": "Envelope hash stable across serialization cycles",
      "verification": "Property test verifies hash stability"
    }
  ],
  "implementation": {
    "code_examples": [
      {
        "description": "EpisodeEnvelope structure",
        "code": "#[derive(Clone, Serialize, Deserialize)]\npub struct EpisodeEnvelope {\n    pub episode_id: EpisodeId,\n    pub actor_id: ActorId,\n    pub work_id: Option<WorkId>,\n    pub lease_id: LeaseId,\n    pub budget: EpisodeBudget,\n    pub stop_conditions: StopConditions,\n    pub pinned_snapshot: PinnedSnapshot,\n    pub capability_manifest_hash: Hash,\n    pub risk_tier: RiskTier,\n    pub determinism_class: DeterminismClass,\n    pub context_refs: Option<ContextRefs>,\n}\n\nimpl EpisodeEnvelope {\n    pub fn canonical_bytes(&self) -> Vec<u8> {\n        // Deterministic protobuf encoding\n    }\n\n    pub fn digest(&self) -> Hash {\n        blake3::hash(&self.canonical_bytes())\n    }\n}\n"
      }
    ],
    "files_to_create": [
      {
        "path": "crates/apm2-daemon/src/episode/envelope.rs",
        "purpose": "EpisodeEnvelope type and canonicalization"
      },
      {
        "path": "crates/apm2-daemon/src/episode/budget.rs",
        "purpose": "EpisodeBudget and resource limit types"
      },
      {
        "path": "crates/apm2-daemon/src/episode/snapshot.rs",
        "purpose": "PinnedSnapshot for reproducibility"
      },
      {
        "path": "crates/apm2-daemon/src/episode/golden_vectors.rs",
        "purpose": "Golden vectors for envelope hashing"
      }
    ],
    "files_to_modify": [
      {
        "changes": "Export envelope, budget, snapshot modules",
        "path": "crates/apm2-daemon/src/episode/mod.rs"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Define EpisodeEnvelope struct",
        "details": "Create EpisodeEnvelope with all fields from AD-EPISODE-001:\n- episode_id, actor_id, work_id, lease_id\n- budget (EpisodeBudget)\n- stop_conditions (StopConditions)\n- pinned_snapshot (PinnedSnapshot)\n- capability_manifest_hash, risk_tier, determinism_class\n- context_refs (optional)\n"
      },
      {
        "step": 2,
        "action": "Implement EpisodeBudget",
        "details": "Create EpisodeBudget struct with fields:\n- tokens: u64\n- tool_calls: u32\n- wall_ms: u64\n- cpu_ms: u64\n- bytes_io: u64\n- evidence_bytes: u64\n"
      },
      {
        "step": 3,
        "action": "Implement PinnedSnapshot",
        "details": "Create PinnedSnapshot struct with optional hashes:\n- repo_hash, lockfile_hash, policy_hash\n- toolchain_hash, model_profile_hash\n"
      },
      {
        "step": 4,
        "action": "Implement canonical_bytes()",
        "details": "Implement deterministic serialization per AD-VERIFY-001:\n- Fields serialized in tag number order\n- No maps in signed messages\n- Unknown fields dropped\n- Explicit default serialization\n"
      },
      {
        "step": 5,
        "action": "Create golden vectors",
        "details": "Create 10+ golden vectors testing:\n- Minimal envelope (required fields only)\n- Full envelope (all optional fields)\n- Various budget combinations\n- Hash stability across cycles\n"
      }
    ],
    "summary": "Implement EpisodeEnvelope type with canonicalization per AD-EPISODE-001.\nDefines immutable envelope object referenced by digest in all receipts.\nIncludes canonical_bytes() for deterministic serialization.\n"
  },
  "notes": "Phase: PHASE-1B (Episode Envelope and Lifecycle)\nGenerated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.\nMaps to TCK-PEND-003.\n",
  "test_requirements": [
    {
      "description": "Envelope serialization round-trip",
      "test_id": "UT-00159-01",
      "verification_command": "cargo test -p apm2-daemon envelope_roundtrip"
    },
    {
      "description": "Golden vectors pass",
      "test_id": "UT-00159-02",
      "verification_command": "cargo test -p apm2-daemon envelope_golden_vectors"
    },
    {
      "description": "Hash stability property test",
      "test_id": "UT-00159-03",
      "verification_command": "cargo test -p apm2-daemon envelope_hash_stability"
    }
  ]
}

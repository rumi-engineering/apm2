ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00602"
    title: "Revert broken Codex/Gemini permission flags and add agent auto-termination on decision set"
    status: "OPEN"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME"]
  dependencies:
    tickets: []
  root_cause_analysis:
    summary: |
      Two issues addressed: (1) A prior attempt to restrict Codex/Gemini sandbox permissions
      broke reviewer dispatch by using incorrect flags (`--sandbox-permissions read` instead of
      `--dangerously-bypass-approvals-and-sandbox` for Codex, and dropping `-y` from Gemini).
      (2) After a decision is persisted via `decision set`, the spawning review agent remains
      alive and can continue performing worktree operations (10+ incidents observed of rogue
      agents destroying worktrees post-decision).
    failure_1_primary: |
      backend.rs Codex commands changed from `--dangerously-bypass-approvals-and-sandbox` to
      `--sandbox-permissions read` in both initial and resume paths. Gemini initial command
      lost its `-y` (auto-approve) flag. These changes broke reviewer dispatch entirely since
      the restricted flags are not yet supported in the review pipeline.
    failure_2: |
      No mechanism existed to terminate the review agent process after a decision is persisted.
      The agent continues running after its decision is set, consuming resources and potentially
      performing unwanted operations on the worktree.
  scope:
    in_scope:
      - "Revert Codex initial command from `--sandbox-permissions read` to `--dangerously-bypass-approvals-and-sandbox` in backend.rs."
      - "Revert Codex resume command from `--sandbox-permissions read` to `--dangerously-bypass-approvals-and-sandbox` in backend.rs."
      - "Restore missing `-y` flag to Gemini initial command in backend.rs."
      - "Add `terminate_review_agent` function in decision.rs that sends SIGTERM/SIGKILL to the review agent after decision persist, with process identity verification via proc_start_time."
      - "Call `terminate_review_agent` at the end of `run_decision_set` after cleanup."
      - "Harden `run_terminate_inner` in fac_review/mod.rs with run-state HMAC integrity verification before PID-based termination."
      - "Write `ReviewRunTerminationReceipt` for manual `apm2 fac review terminate` actions to preserve auditability."
      - "Introduce home-scoped review lease acquisition for tests (`try_acquire_review_lease_for_home`) and use it in fac_review dispatch paths that already accept a `home` parameter."
      - "Eliminate fac_review test leakage into `~/.apm2` by isolating test home state (temp `APM2_HOME` and/or explicit *_for_home helpers) for lease/run-state tests."
      - "Replace real repository URLs in fac_review target-resolution tests with synthetic test repositories."
      - "Add a daemon test policy note documenting that full agent-lifecycle E2E tests are not part of the default suite and must run with temp `APM2_HOME`, mock GitHub adapters, and EVID-HEF-0012 constraints when enabled."
      - "Perform one-time cleanup of leaked fac_review test artifacts under `~/.apm2/review_locks/` and `~/.apm2/reviews/`."
    out_of_scope:
      - "Sandbox mode migration for Codex/Gemini backends (requires upstream support)."
      - "RoleSpec ToolAllowlist runtime enforcement (covered by RFC-0028 broker)."
      - "Prompt-level git prohibitions, ReadOnlyPaths systemd confinement, or other defense-in-depth measures."
      - "Deleting existing RFC evidence harnesses without an explicit replacement coverage plan."
  plan:
    steps:
      - "Revert backend.rs line 19: restore `-y` flag to Gemini initial command."
      - "Revert backend.rs line 39: restore `--dangerously-bypass-approvals-and-sandbox` for Codex initial command."
      - "Revert backend.rs line 63: restore `--dangerously-bypass-approvals-and-sandbox` for Codex resume command."
      - "Add `dimension_to_state_review_type` helper mapping 'code-quality' to 'quality' in decision.rs."
      - "Add `terminate_review_agent` function in decision.rs: load run state, verify PID identity, SIGTERM with 5s timeout, SIGKILL fallback."
      - "Call `terminate_review_agent` in `run_decision_set` after cleanup block."
  definition_of_done:
    evidence_ids: []
    criteria:
      - "backend.rs Codex commands use `--dangerously-bypass-approvals-and-sandbox` (both initial and resume)."
      - "backend.rs Gemini initial command includes `-y` flag."
      - "`run_decision_set` terminates the review agent process after persisting the decision."
      - "Process identity verification prevents killing unrelated processes on PID reuse."
      - "`cargo clippy -p apm2-cli -p apm2-core -- -D warnings` passes clean."
      - "`cargo test -p apm2-cli fac_review` — all tests pass."
  notes:
    security: "E2E agent tests that spawn full agent lifecycles are banned from the default test suite; when enabled they must use temp `APM2_HOME`, mock GitHub adapters, and satisfy EVID-HEF-0012."
    critical_files:
      - "crates/apm2-cli/src/commands/fac_review/backend.rs — Codex/Gemini command builders"
      - "crates/apm2-cli/src/commands/fac_review/decision.rs — terminate_review_agent + call site"

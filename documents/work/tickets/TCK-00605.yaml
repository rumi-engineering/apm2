ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00605"
    title: "FAC agent reliability hardening — auto-verdict, doctor-as-oracle, recovery bypass, auto-merge"
    status: "MERGED"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00604"
        reason: "TCK-00604 introduced the per-PR agent registry, lifecycle reducer, HMAC integrity, MAX_ACTIVE_AGENTS_PER_PR=2 cap, and initial doctor --pr implementation."
  root_cause_analysis:
    summary: |
      The FAC system was designed as if LLM review agents are reliable state
      machines that always complete their protocol (emit findings → call
      `verdict set` → done). Field evidence from multi-PR orchestration runs
      shows they are not: agents crash, timeout, get confused by long decision
      trees, and consistently fail to complete the verdict ceremony.

      Every operational pain point traces back to this mismatch between the
      system's reliability assumptions and agent reality:

      1. VERDICT CEREMONY IS A SINGLE POINT OF FAILURE
         Review agents (codex, gemini-3-pro, gemini-3-flash, codex-spark) emit
         findings successfully but crash before calling `verdict set`. This is
         the dominant failure mode — `decision_receipt_missing` on every run.
         The review prompt decision tree is too long for models to complete
         end-to-end. Findings contain all evidence needed to determine the
         verdict; requiring a separate ceremony is a reliability tax.

      2. RECOVERY IS SUBJECT TO THE RULES IT'S TRYING TO REPAIR
         `fac recover` goes through the same lifecycle reducer (`apply(state,
         recover_requested)`) and HMAC verification that got the system into a
         broken state. Every combination of --pr, --force, --refresh-identity
         returns `illegal transition: <state> + recover_requested`. Recovery
         should be the escape hatch, not subject to the same transition rules
         it's trying to repair.

      3. SHA DRIFT CASCADES INTO UNRECOVERABLE STATES
         After force-push / rebase / amend, the local identity projection at
         `~/.apm2/fac_projection/repos/.../identity.json` retains the old SHA.
         Every subsequent `fac restart` and `fac review dispatch` fails with
         `stale_head_ambiguity` or `stale relative to authoritative PR head`.
         Operators had to manually edit the identity JSON 3+ times per session.
         `fac push` writes identity BEFORE gates/dispatch complete (premature
         persistence), and `fac restart --refresh-identity` doesn't work.

      4. HMAC INTEGRITY BLOCKS RECOVERY
         When reviewer processes die but the registry still shows
         `state: dispatched`, every dispatch attempt hits `at_capacity`. `fac
         review terminate` says "no active reviewer" (correct — process is dead),
         but the registry entry stays dispatched. The registry file can't be
         edited because of HMAC integrity check. Operators had to delete the
         entire registry file to unblock, losing all tracking history.
         Same problem with lifecycle state files — stuck in `gates_running`
         after a partial restart, no way to fix without deleting the file.

      5. EXIT CODE CONFLATES INDEPENDENT OUTCOMES
         `fac push` does 4 things: git push, gates, PR update, review dispatch.
         If the first 3 succeed but dispatch fails (stale_head_ambiguity), the
         whole command exits 1. CI/orchestrators see failure but the push worked.

      6. FINDINGS VS VERDICT MISMATCH
         Findings show `verdict: "FAIL"` (derived from severities) but lane
         status shows `quality_verdict: "UNKNOWN"`. Orchestrators must check
         two inconsistent sources to determine review state.

      7. LEGACY BOUNDED TEST SHELL WRAPPER
         FAC bounded test execution still depended on
         `scripts/ci/run_bounded_tests.sh`, creating a second control plane for
         runtime limits outside the Rust implementation. This wrapper can drift
         from Rust policy and causes avoidable maintenance overhead.

      8. ORCHESTRATOR GLOBAL CAPACITY MISINTERPRETATION
         The orchestrator-monitor SKILL.md SATURATION_CHECK step instructs the
         orchestrator to check capacity globally via `fac_review_status (global)`,
         effectively turning the per-PR cap of 2 into a system-wide cap of 2.
         (Already fixed in this branch — skill instructions updated.)

      9. NO SINGLE SOURCE OF TRUTH FOR ORCHESTRATORS
         Orchestrators must call `fac review status` + `fac review findings`
         + mental arithmetic + event log reconstruction to build the per-PR
         picture each tick. Two commands give contradictory answers to "did
         this review pass?" Elapsed times require timestamp math. Model
         fallback chains require event log archaeology. `fac review status`
         without `--pr` shows stale pulse timestamps from previous runs.
         `sequence_done` events fire prematurely, reporting security as
         "SKIPPED" while the lane is still actively running on restart 3.

      10. DECISION LOGIC LIVES IN THE LLM ORCHESTRATOR
          The most expensive and error-prone part of every orchestrator tick is
          the LLM deciding what to do. It reads multiple data sources, reconciles
          contradictions, and reasons about next actions. This reasoning is
          unreliable — LLMs misinterpret signals, miss edge cases, and make
          different decisions on identical state. The decision logic should be
          in deterministic, testable Rust code, not in LLM prompts.

      11. GATE FAILURES ARE EPHEMERAL
          When an agent runs `fac push` and gates fail, that evidence exists
          only in the agent's stdout. The agent dies, the evidence vanishes.
          The orchestrator must dig through `/tmp/claude-1000/.../tasks/<id>.output`
          to learn "test gate timed out after 261s." There is no FAC-visible
          trace of a failed push attempt — no persistent record of which gate
          failed, why, or when. This is the same architectural gap that
          findings solved for reviews: reviews persist structured evidence;
          gates do not.

      The meta-insight: the system must reach a correct terminal state even
      when agents fail at any point in the protocol. Agents are the most
      unreliable component in the stack.
  scope:
    in_scope:
      - id: P0_AUTO_VERDICT
        title: "Auto-derive verdict from findings on reviewer process exit"
        detail: |
          When a reviewer process terminates (clean exit, crash, timeout, PID
          reap) without having called `verdict set`, the system must auto-derive
          the verdict from accumulated findings for that PR/type/SHA:
          - Any BLOCKER or MAJOR findings exist → auto-deny
          - Only MINOR/NIT findings → auto-approve
          - Zero findings emitted → leave pending (no verdict set; retriable)

          Implementation site: the PID reaper in `reap_registry_stale_entries()`
          already detects dead agents. When it reaps a reviewer with no verdict,
          it should call the findings store to enumerate accumulated findings
          for that agent's (owner_repo, pr_number, review_type, sha), compute
          the verdict, and write it via the same path as `verdict set`.

          The explicit `verdict set` call by agents becomes an optimization
          (faster verdict propagation), not a requirement for lane completion.

          Auto-verdict projection (GitHub comment posting) is best-effort and
          deferred — write the local verdict + lifecycle event synchronously,
          queue or skip the GitHub projection. This prevents the reaper hot
          path (called during enforce_pr_capacity / register_agent_spawn) from
          blocking on external API calls.

          This eliminates `decision_receipt_missing` as a failure mode.
      - id: P0_LOCAL_AUTO_MERGE
        title: "Local auto-merge into main when all verdicts approve"
        detail: |
          The local forge is authoritative. When the shared verdict finalization
          function (used by both explicit `verdict set` and the auto-verdict
          reaper) writes an approve verdict, it must check whether ALL review
          dimensions now approve for the current HEAD SHA. If so, the PR has
          reached terminal merge-ready state as a local fact — trigger local
          merge immediately without waiting for GitHub CI round-trip.

          Merge procedure:
          (a) After writing the verdict, load all dimension verdicts for
              (owner_repo, pr_number, current_head_sha).
          (b) If every active dimension (security, code-quality) is approve:
              - Resolve the worktree path from the PR identity/projection.
              - Execute `git merge --ff-only <branch>` into local main.
                ff-only is mandatory — if it can't fast-forward, the branch
                has diverged and needs human attention. Emit a lifecycle
                event `merge_failed` with reason and do not retry.
              - On success, emit lifecycle event `merged` to transition
                the PR to terminal state.
              - Fire-and-forget: spawn background `rm -rf <worktree>/target`
                to reclaim disk from build artifacts. No error propagation —
                if the worktree has no /target or cleanup fails, ignore it.
          (c) If not all dimensions approve yet, do nothing — the next
              verdict finalization will re-check.

          This is the natural terminal action in the lifecycle. GitHub
          auto-merge (already enabled by `fac push`) eventually catches up
          as a projection, but local main advances immediately.

          Edge cases:
          - Merge conflict (non-ff): emit `merge_failed` lifecycle event,
            do NOT retry. PR transitions to a stuck-like state requiring
            human/implementor rebase.
          - Worktree missing: skip /target cleanup, still merge from the
            branch ref directly.
          - Concurrent pushes: verdict is SHA-bound, so a stale verdict
            cannot trigger merge for a newer SHA. Safe by construction.
      - id: P0_DOCTOR_FIX
        title: "Doctor --fix: auto-repair broken state (absorbs `fac recover`)"
        detail: |
          Recovery is a feature of doctor, not a separate command. Doctor
          already diagnoses problems and computes recommended_action with the
          exact repair needed. `--fix` means "execute what you already computed."

          `apm2 fac doctor --pr <N> --fix` operates OUTSIDE the normal lifecycle
          reducer. It is a privileged escape hatch for broken state, not a
          normal transition.

          Without `--fix`, doctor remains purely read-only — no behavior change.

          Repair operations (executed when --fix is passed):
          (a) REAP STALE AGENTS: iterate the agent registry, check PID liveness
              for every entry scoped to this PR, mark dead-PID entries as reaped,
              auto-derive verdict from findings for reaped reviewers (ties into
              P0_AUTO_VERDICT), recompute registry HMAC. Works even if the
              current registry HMAC is invalid.
          (b) REFRESH IDENTITY: fetch the current PR HEAD SHA from GitHub API,
              overwrite local identity.json with fresh data and fresh HMAC.
              No stale-check — this IS the recovery for stale identity.
          (c) RESET LIFECYCLE: if lifecycle state is stuck/broken/corrupt,
              reset to a clean starting point (e.g. `pushed`) preserving event
              history where possible, with fresh HMAC.
          (d) Doctor decides which repairs to apply based on the health
              diagnostics it already computes. Operators don't choose
              individual recovery operations — doctor knows what's broken.

          All repair operations:
          - Skip lifecycle state machine validation (no `apply(state, event)`)
          - Recompute HMAC after writing, never verify before writing
          - Log before/after state for audit trail
          - Never fail due to existing corrupt state
          - Are reported in the JSON output as `repairs_applied` array

          Implementation: recovery.rs module stays as internal implementation,
          called by doctor's --fix path, not exposed as a CLI subcommand.

          `fac recover` becomes a deprecated alias that prints:
          "DEPRECATED: use `apm2 fac doctor --pr <N> --fix` instead."
      - id: P0_DOCTOR_AS_ORACLE
        title: "Superpower doctor --pr as the single-call orchestration oracle"
        detail: |
          `apm2 fac doctor --pr <N> --json` becomes the ONE command orchestrators
          call per PR per tick. It must return a complete, self-consistent
          snapshot with actionable recommendations — eliminating the need for
          any other status/findings call.

          NEW SECTIONS (added to existing doctor --pr output):

          RECOMMENDED_ACTION — "What should I do next?"
          (a) A deterministic `recommended_action` computed from the full PR
              state. The action vocabulary is closed:
              - wait: reviews in progress, nothing to do
              - merge: all dimensions approve, gates pass, SHA fresh
                (with P0_LOCAL_AUTO_MERGE this fires automatically, but
                doctor still reports it for observability)
              - dispatch_implementor: review denied with actionable findings
              - restart_reviews: stale SHA, crashed reviewers, no active agents
              - fix: stuck lifecycle, corrupt HMAC, error budget critical
                (i.e. re-run `doctor --fix` — doctor prescribes itself)
              - escalate: error budget exhausted, non-ff merge conflict,
                requires human intervention
          (b) Each action includes:
              - reason: human-readable explanation
              - priority: high / medium / low
              - command: the exact CLI command to run (when applicable)
          (c) This moves decision logic from the LLM orchestrator (unreliable,
              expensive, inconsistent) into deterministic Rust (testable, fast,
              same answer every time). The orchestrator becomes a thin dispatch
              loop over doctor recommendations.

          FINDINGS_SUMMARY — "What did reviewers find?"
          (d) Per-dimension findings counts:
              `{blocker: N, major: N, minor: N, nit: N}`
              Orchestrators need this to write implementor handoffs without a
              separate `fac review findings` call.
          (e) Per-dimension `formal_verdict` (from verdict store: approve/deny/
              pending) alongside `computed_verdict` (derived from findings
              severities: deny if BLOCKER/MAJOR, approve if only MINOR/NIT,
              pending if none). Once P0_AUTO_VERDICT is live, these always
              agree. The computed_verdict serves as a bridge during rollout and
              as a consistency check after.

          MERGE_READINESS — "Can I merge right now?"
          (f) A single `merge_ready: true/false` with explicit sub-checks:
              - all_verdicts_approve: bool
              - gates_pass: bool
              - sha_fresh: bool (local == remote HEAD)
              - no_merge_conflicts: bool (ff-only would succeed)
              This is the complete merge predicate in one field — not "is the
              lifecycle in the right state" but "would `git merge --ff-only`
              succeed right now, and if not, which specific condition fails?"

          AGENT ENRICHMENTS — "Who's working and what have they tried?"
          (g) `elapsed_seconds` on every agent entry (trivial: now - started_at).
              Eliminates timestamp arithmetic by LLM orchestrators.
          (h) `models_attempted` list per dimension: accumulated from restart/
              fallback events, e.g. ["gpt-5.3-codex", "gemini-3-pro",
              "gpt-5.3-codex"]. Tells the orchestrator what's been tried
              without event log archaeology.
          (i) `last_activity_seconds_ago`: time since last finding emitted,
              last lifecycle event, or last pulse for this PR. Answers "is
              this agent making progress?" without tailing logs.

          WORKTREE STATUS — "Is the workspace healthy?"
          (j) `worktree_exists: bool`, `worktree_clean: bool`,
              `merge_conflicts: N`. Orchestrators need this to decide whether
              to dispatch an implementor and what instructions to give.

          PROJECTION STATUS — "Is GitHub in sync?"
          (k) `github_projection`: auto_merge_enabled, last_comment_updated_at,
              projection_lag_seconds. Tells the orchestrator whether GitHub
              has caught up with local truth.

          STALE DATA CLEANUP
          (l) Pulse data that does not match the current run_id is excluded
              from doctor output. Eliminates ghost timestamps from previous
              runs confusing orchestrators.

          SYSTEM-LEVEL DOCTOR (no --pr flag)
          (m) `apm2 fac doctor --json` (no --pr) returns system health (existing
              behavior) PLUS a summary table of all tracked PRs with their
              recommended_action. One-line-per-PR overview for discovery +
              triage in a single call. This replaces the PR-discovery use case
              of `fac review status` without --pr.
      - id: P1_DEPRECATE_REVIEW_STATUS
        title: "Deprecate `apm2 fac review status` in favor of doctor"
        detail: |
          With doctor --pr as the complete oracle, `fac review status` is
          redundant surface area that creates contradiction problems (findings
          vs status verdict disagreement, stale pulse data, premature
          sequence_done events).

          (a) Add deprecation warning to `fac review status` output:
              "DEPRECATED: use `apm2 fac doctor --pr <N> --json` instead.
              This command will be removed in a future release."
          (b) Update orchestrator-monitor SKILL.md to use doctor exclusively
              for all per-PR state queries. Remove all references to
              `fac review status --pr`.
          (c) Keep `fac review status` functional for one release cycle.
          (d) The `--pr` discovery use case (list all PRs) is replaced by
              `apm2 fac doctor --json` system-level summary.
      - id: P1_SEQUENCE_DONE_BUG
        title: "Fix premature sequence_done event when lanes are still alive"
        detail: |
          When quality hits max_restarts_exceeded, the sequence_done event fires
          with security_state: null, security_verdict: "SKIPPED" — but security
          is actively running on restart 3. This is a bug.

          Fix: sequence_done must not fire until ALL active lanes are terminal.
          If one lane terminates while another is still alive, emit a lane-
          specific terminal event (e.g. quality_terminated), not sequence_done.
          sequence_done fires only when every lane has reached a terminal state
          (done, failed, max_restarts_exceeded).
      - id: P1_RESTART_REFRESH_IDENTITY
        title: "`fac restart --refresh-identity` as lightweight SHA drift fix"
        detail: |
          `fac restart --refresh-identity --pr <N>` should:
          (a) Fetch authoritative PR HEAD SHA from GitHub API.
          (b) If local identity SHA differs, overwrite local identity.json
              with the new SHA (fresh HMAC, new timestamp).
          (c) Proceed with normal restart logic using the refreshed SHA.

          This is a lighter-weight fix than `doctor --fix` — it doesn't
          bypass the state machine, it just fixes the identity input before
          normal restart processing. If the lifecycle state is also broken,
          the operator escalates to `apm2 fac doctor --pr <N> --fix`.
      - id: P1_PUSH_EXIT_CODE_SEPARATION
        title: "Push exit code reflects push outcome, not dispatch outcome"
        detail: |
          `fac push` performs four sequential operations:
          (1) git push
          (2) evidence gates
          (3) PR creation/update + auto-merge enablement
          (4) review dispatch

          If (1)-(3) succeed but (4) fails (stale_head_ambiguity, at_capacity,
          dispatch_spawn_failed, etc.), the command must exit 0, not exit 1.
          The dispatch failure is reported as:
          - A `"dispatch_warning"` field in the JSON output
          - A warning line on stderr
          - NOT the exit code

          Exit 1 is reserved for failures in the push itself (git push failed),
          gates (evidence gates failed), or PR creation (GitHub API error).
          This aligns with the principle that projections (review dispatch) are
          best-effort and must not block the truth plane (push + gates).
      - id: P1_PUSH_ATTEMPT_LOG
        title: "Persistent push attempt log — gate failures survive agent death"
        detail: |
          Every `fac push` invocation appends one structured NDJSON record to
          `~/.apm2/fac_projection/repos/<repo>/push_attempts/<pr>.ndjson`.

          Each record captures the outcome of every stage in the push pipeline:
            ts, sha, and per-stage: {status: pass|fail|skipped, duration_s,
            exit_code (on fail), error_hint (on fail)}.

          Stages: git_push, gate_fmt, gate_clippy, gate_test, gate_doc,
          pr_update, dispatch.

          The `error_hint` field is the key signal-to-noise lever: last line
          of stderr from the failed gate, capped at 200 characters. Enough to
          know WHAT failed without the full test log.

          Doctor reads the latest entry for the current SHA to inform
          `recommended_action`. If doctor sees the last push attempt failed
          at gate_test with exit code 1, it recommends `dispatch_implementor`
          with reason "last push: gate_test FAIL (exit 1, 261s) — test
          workspace::merge_conflicts timed out."

          This eliminates the need to dig through agent transcripts to learn
          why a push failed. Gate failures become first-class FAC evidence,
          parallel to how findings are first-class review evidence.

          Only the latest entry per SHA matters for doctor decisions, but the
          full NDJSON log is retained for audit/debugging.
      - id: P1_MACHINE_READABLE_PROJECTIONS
        title: "All GitHub projections are machine-readable — no markdown rendering"
        detail: |
          Every FAC projection to GitHub (PR body, findings comment, verdict
          comment) must be machine-readable structured data, not rendered
          markdown. Agents, CI, and tooling need to parse these projections
          programmatically.

          Current state:
          - PR body: already YAML in a code fence (machine-readable) — no change.
          - Decision/verdict comment: YAML payload in code fence (good) BUT
            appends `render_findings_markdown()` output with `## FAC Findings`
            headers, bullet lists, and prose — this is the problem.

          Required changes:
          (a) Replace `render_findings_markdown()` in verdict_projection.rs
              with a structured format. The entire comment body should be a
              single YAML (or JSON) code fence containing both the decision
              payload and the findings array.
          (b) Each finding in the projected array retains its full structured
              fields: type, severity, summary, risk, impact, location, body,
              timestamp. No lossy rendering to prose.
          (c) The HTML comment marker (`<!-- DECISION_MARKER -->`) is retained
              for comment upsert identification.
          (d) No markdown headers, no bullet lists, no prose formatting in
              any FAC-generated GitHub comment.

          This makes findings comments parseable by `yq`/`jq` after stripping
          the code fence, identical to how PR bodies are already parsed.
      - id: P2_PUSH_IDENTITY_LAST
        title: "Push persists local identity LAST — after gates and dispatch"
        detail: |
          Currently `fac push` writes the local PR identity/projection BEFORE
          running gates and dispatching reviews. When `git push --force` advances
          the remote HEAD, the local projection holds a SHA that was written
          prematurely. Subsequent `fac restart` then fails with stale identity.

          Required ordering:
          (1) git push --force
          (2) evidence gates (using the new SHA)
          (3) PR creation/update
          (4) review dispatch
          (5) ONLY NOW: persist local identity with the new SHA and fresh HMAC

          If step (2) or (4) fails, the local identity retains the previous
          (valid) SHA. The operator can re-run `fac push` without hitting stale
          identity errors, because the identity file still points to the last
          fully-processed SHA.
      - id: P2_REMOVE_BOUNDED_TEST_SHELL_WRAPPER
        title: "Remove bounded test shell wrapper and keep bounded execution in Rust"
        detail: |
          Remove `scripts/ci/run_bounded_tests.sh` and replace all FAC usage
          with Rust-native bounded command construction.

          `apm2 fac gates` and FAC pipeline execution must continue to enforce
          bounded execution (timeout, memory, pids, CPU) via Rust code using
          `systemd-run`, without shell-wrapper indirection.
      - id: P2_FINDINGS_VERDICT_CONSISTENCY
        title: "Eliminate findings/verdict status mismatch"
        detail: |
          When a reviewer emits findings (MAJOR, MINOR, NIT) but crashes before
          setting a verdict, the system reports inconsistent state:
          - `apm2 fac review findings` shows `verdict: "FAIL"` (computed from
            finding severities)
          - `apm2 fac review status` shows `quality_verdict: "UNKNOWN"`

          This is a direct consequence of the verdict ceremony being a separate
          step. The P0_AUTO_VERDICT fix resolves this structurally — once the
          reaper auto-derives verdict from findings, both sources will agree.

          Additionally, `apm2 fac review findings` should NOT report a synthetic
          `verdict` field that contradicts the authoritative verdict store. If
          no verdict has been set, findings should report `verdict: "pending"`,
          not `verdict: "FAIL"`. The verdict store is the single source of truth
          for pass/fail; findings are evidence, not authority.
      - id: P2_ORCHESTRATOR_SKILL_DOCTOR_MIGRATION
        title: "Rewrite orchestrator-monitor SKILL.md around doctor-as-oracle"
        detail: |
          With doctor --pr as the single-call oracle, the orchestrator-monitor
          SKILL.md should be dramatically simplified:

          (a) Replace all `fac review status --pr` references with
              `apm2 fac doctor --pr <N> --json`.
          (b) SNAPSHOT step becomes: call doctor --pr for each PR, read one
              JSON object. No multi-command reconciliation.
          (c) CLASSIFY step becomes: read `doctor.recommended_action.action`
              directly — the classification is already done in Rust.
          (d) PLAN_DISPATCH step becomes: filter PRs by recommended_action,
              apply tick-level bounds (max 3 actions, max 1 per PR).
          (e) EXECUTE_ACTIONS step becomes: run the `command` from each PR's
              recommended_action, or dispatch implementor with
              `doctor.findings_summary` in the handoff.
          (f) SATURATION_CHECK becomes: read `doctor.agents.active_agents` vs
              `doctor.agents.max_active_agents_per_pr` (already done).
          (g) REVIEW_GATE_DEFINITION becomes: read `doctor.merge_readiness`.
          (h) Remove all references to `fac review status`.
          (i) System-level discovery: `apm2 fac doctor --json` (no --pr) for
              the per-PR summary table with recommended actions.

          The orchestrator decision tree shrinks from ~150 lines of reasoning
          instructions to a thin dispatch loop.
      - id: DONE_ORCHESTRATOR_SKILL_CAPACITY
        title: "Orchestrator-monitor SKILL.md per-PR capacity fix"
        detail: |
          Already completed in this branch:
          - SATURATION_CHECK updated to use per-PR `apm2 fac doctor --pr <N>`
          - ENFORCE_BACKPRESSURE scoped per-PR
          - RESOLVE_PR_SCOPE clarified as discovery-only
          - REVIEW_PROGRESS_ACTION uses explicit per-PR commands
          - New invariant: capacity cap is per-PR, not global
      - id: P1_VERDICT_TRANSITION_FROM_GATES_PASSED
        title: "Allow verdict_set transition from gates_passed state"
        detail: |
          Bug: `apm2 fac review verdict set` fails with "illegal transition:
          gates_passed + verdict_set". The lifecycle reducer (lifecycle.rs:2204-2245)
          does not include `GatesPassed` in the match arm for `VerdictSet`. When the
          `reviews_dispatched` transition is missed (dispatch failure in push.rs,
          state cleared by recovery, restart after corruption), reviewers cannot set
          verdicts. This cascades into `decision_receipt_missing` on every restart
          attempt → `max_restarts_exceeded`.

          Fix: Add `S::GatesPassed` to the `VerdictSet` match arm. If gates have
          passed, it is always valid for a reviewer to set a verdict. The
          `reviews_dispatched` intermediate state is a tracking optimization, not a
          security gate.

          Also make `verdict set` idempotent for the same SHA — re-setting an
          existing verdict for the current SHA and dimension should succeed, not
          error. This prevents the restart death spiral.

          Reference: documents/work/prompts/lifecycle-verdict-transition-bug.md
      - id: P1_DOCTOR_RESTART_FORCE_GAP
        title: "Doctor recommends restart with --force after max_restarts_exceeded"
        detail: |
          Bug: After reviewers hit `max_restarts_exceeded`, doctor recommends
          `apm2 fac restart --pr <N> --refresh-identity` without `--force`.
          Without `--force`, `determine_restart_strategy()` checks completion
          receipts from a prior sequence and may noop, leaving the PR stuck.

          Fix: Pass review run state (including `terminal_reason`) into
          `build_recommended_action()`. When terminal_reason is
          `max_restarts_exceeded`, include `--force` in the recommended command
          to break the restart death spiral.

          Reference: documents/work/prompts/doctor-restart-force-gap.md
      - id: P1_DOCTOR_EDGE_CASES
        title: "Doctor edge case fixes from audit"
        detail: |
          Seven edge cases identified in the doctor command from crash analysis
          of 185 events across all PRs:

          1. recommended_action blind to terminal_reason — does not receive
             review run state, cannot distinguish max_restarts_exceeded from
             normal completion. (Overlaps P1_DOCTOR_RESTART_FORCE_GAP.)
          2. no_merge_conflicts defaults false when worktree missing — doctor
             reports merge conflicts when the real issue is a missing worktree.
             Fix: distinguish "unknown" from "has conflicts" with an enum.
          3. Lifecycle escalation on default values — verify
             retry_budget_remaining is always initialized to a positive value.
          4. Activity scan bounded to last 4096 events — event log already
             exceeds this window (~11,500 events). Doctor may report stale
             last_activity_seconds_ago for older PRs. Fix: increase window or
             index events by PR.
          5. DoctorReviewSnapshot lacks terminal_reason — orchestrators cannot
             distinguish clean completion from crash loop. Fix: add
             terminal_reason field.
          6. Stale identity with no remediation path — when GitHub API is down,
             remote_head_sha is None, sha_fresh is false, doctor silently
             reports "wait". Fix: emit health item for GitHub unavailability,
             consider local SHA authoritative.
          7. denied_with_findings checks formal OR computed verdict — may
             trigger dispatch_implementor for NIT-only findings when formal
             verdict is deny from a prior run.

          Reference: documents/work/prompts/doctor-edge-cases-audit.md
      - id: P2_PROJECTION_DECOUPLING
        title: "Decouple GitHub projection from core FAC review modules"
        detail: |
          Structural refactor: extract all GitHub projection logic (auth,
          comments, publishing, reviewer identity, CI status, verdict rendering)
          from core FAC review modules into dedicated projection modules.

          New modules:
          - github_auth.rs: auth boundary (ensure_gh_cli_ready,
            resolve_authenticated_gh_login, resolve_local_reviewer_identity).
            Deduplicates copies in barrier.rs and projection.rs.
          - github_reads.rs: read-only GitHub API queries (fetch_pr_data,
            fetch_pr_head_sha remote, fetch_default_branch,
            resolve_actor_permission, fetch_issue_comment).
          - verdict_projection.rs: verdict comment rendering/parsing/caching
            (DecisionComment types, parse/render functions, verdict show,
            termination authority resolution). Extracted from projection.rs
            (~lines 706-1024).

          After extraction, core modules (lifecycle, dispatch, state, types,
          events, evidence, gates, findings, logs, projection) must have zero
          Command::new("gh") calls and zero GitHub-specific type imports.

          Constraints: zero regressions, no logic changes (pure structural
          move), preserve pub(super) visibility, deduplicate auth helpers,
          no new crate dependencies.

          Reference: documents/work/prompts/codex-projection-decoupling.md
      - id: DONE_BOUNDED_RUNNER_KILLSIGNAL_FIX
        title: "Fix scope cleanup false-FAIL: KillSignal SIGTERM→SIGKILL"
        detail: |
          Already completed in this branch:
          - build_bounded_test_command() set KillSignal=SIGTERM, which allowed
            TERM-ignoring descendant processes (e.g. tck_00392's
            `trap '' TERM; sleep 600`) to survive scope stop, causing systemd to
            wait for TimeoutStopSec and report `Failed with result 'timeout'`
          - Changed KillSignal=SIGTERM to KillSignal=SIGKILL so scope cleanup is
            immediate and unconditional — stray processes cannot block scope stop
          - Combined with existing FinalKillSignal=SIGKILL, SendSIGKILL=yes, and
            KillMode=control-group for defense-in-depth
          - Root cause: tests intentionally spawn TERM-resistant processes to
            validate containment; the bounded runner must tolerate this
      - id: DONE_BOUNDED_RUNNER_SETENV_FIX
        title: "Fix env var forwarding gap in bounded test runner"
        detail: |
          Already completed in this branch:
          - build_bounded_test_command() now accepts extra_setenv parameter
          - Lane profile vars (NEXTEST_TEST_THREADS, CARGO_BUILD_JOBS) are
            forwarded via --setenv to the systemd-run scope
          - Both callers updated: gates.rs and evidence.rs
          - Root cause: compute_test_env() produced lane vars after the
            bounded command was built; vars were set on the parent Command
            via .env() but never forwarded via --setenv to the cgroup child
    out_of_scope:
      - "Redesigning the gate cache format or attestation scheme."
      - "Changes to the background pipeline gate execution path."
      - "Changes to MAX_ACTIVE_AGENTS_PER_PR constant value."
      - "Removing the CI workflow entirely (it remains the required status check)."
      - "Multi-model review prompt shortening (separate concern — the system should be resilient to long prompts, not require short ones)."
      - "Broker mode gate execution (removed — gates always run locally; `--direct` and `--wait-timeout` flags deleted)."
      - "Full removal of `fac review status` (deprecation only in this ticket; removal in a follow-up)."
      - "Full removal of `fac recover` (deprecation only in this ticket; removal in a follow-up)."
      - "GitHub CI re-trigger / `--ci-only` flag — local forge is authoritative; CI is a projection that catches up on its own. GitHub Actions concurrency limits are GitHub's problem, not the local system's."
      - "Workspace root resolution bug (intermittent `$PWD` / worktree boundary issue in bounded test runner) → separate investigation ticket."
  plan:
    steps:
      - id: STEP_01
        title: "Auto-verdict reaper"
        detail: |
          In `reap_registry_stale_entries()` (lifecycle.rs), when a reviewer
          agent is reaped (dead PID, expired token):
          (a) Check if a verdict exists for (owner_repo, pr_number, review_type, sha).
          (b) If no verdict, load findings from findings_store for that scope.
          (c) Compute verdict: BLOCKER/MAJOR → deny, MINOR/NIT only → approve,
              no findings → leave pending (no verdict set).
          (d) Write verdict via the existing verdict-set path (local only —
              GitHub projection is best-effort/deferred, not synchronous).
          (e) Emit a lifecycle event: `verdict_auto_derived` with source=reaper.
      - id: STEP_02
        title: "Local auto-merge on all-approve"
        detail: |
          In the shared verdict finalization function (lifecycle.rs):
          (a) After writing verdict, load all dimension verdicts for current SHA.
          (b) If all approve: resolve worktree, `git merge --ff-only` into main.
          (c) On merge success: emit `merged` lifecycle event.
          (d) On merge failure (non-ff): emit `merge_failed` event, no retry.
          (e) Fire-and-forget: spawn background `rm -rf <worktree>/target`.
          (f) This runs on both explicit verdict-set and auto-verdict paths.
      - id: STEP_03
        title: "Doctor --fix: recovery bypass implementation"
        detail: |
          Add crates/apm2-cli/src/commands/fac_review/recovery.rs with privileged
          repair operations that bypass reducer and HMAC. Called by doctor --fix,
          not exposed as a standalone CLI subcommand.
          (a) reap_stale_agents_for_pr(): PID-liveness sweep + auto-verdict for
              reaped reviewers + registry rewrite with fresh HMAC.
          (b) refresh_identity_from_authoritative(): GitHub API fetch + identity
              overwrite with fresh HMAC.
          (c) reset_lifecycle_to_pushed(): state reset preserving event history,
              fresh HMAC.
          (d) run_full_repair(): combines all three, returns RepairSummary.
          (e) All operations recompute HMAC after writing, never verify before.
          (f) All operations log before/after state for audit trail.
          (g) Add `--fix` flag to DoctorArgs in fac.rs. When set, run_doctor_inner
              executes repairs based on computed health diagnostics, then
              re-diagnoses to show post-repair state.
          (h) Add `repairs_applied` array to DoctorPrSummary JSON output.
          Recovery bypass read/write helpers must use a distinct naming convention
          (e.g. `load_registry_bypass_hmac`, `save_registry_bypass_hmac`) so that
          reviewers can immediately identify privileged paths. Normal command paths
          must never call bypass helpers.
      - id: STEP_04
        title: "Doctor --pr oracle: recommended_action"
        detail: |
          In run_doctor_inner() (mod.rs), after assembling all existing sections,
          compute recommended_action from the full state:
          (a) Define action vocabulary: wait, merge, dispatch_implementor,
              restart_reviews, fix, escalate.
          (b) Priority-ordered decision logic in Rust:
              - lifecycle stuck or error_budget exhausted → escalate
              - HMAC corrupt or lifecycle broken → fix (doctor --fix)
              - all verdicts approve + gates pass + sha fresh → merge
              - verdict deny + findings exist → dispatch_implementor
              - no active agents + no verdict → restart_reviews
              - agents alive + making progress → wait
          (c) Include reason, priority, and command in the action object.
      - id: STEP_05
        title: "Doctor --pr oracle: findings_summary + verdict consistency"
        detail: |
          Add per-dimension findings_summary to doctor output:
          (a) Load findings for each dimension at current SHA.
          (b) Count by severity: {blocker: N, major: N, minor: N, nit: N}.
          (c) Include formal_verdict (from store) and computed_verdict (from
              findings) side by side.
      - id: STEP_06
        title: "Doctor --pr oracle: merge_readiness"
        detail: |
          Add merge_readiness object:
          (a) all_verdicts_approve: bool
          (b) gates_pass: bool
          (c) sha_fresh: bool (local == remote)
          (d) no_merge_conflicts: bool (branch is ff-only mergeable)
          (e) merge_ready: all sub-checks true
      - id: STEP_07
        title: "Doctor --pr oracle: agent enrichments"
        detail: |
          Enrich agent entries:
          (a) elapsed_seconds: now - started_at for active entries.
          (b) models_attempted: list per dimension from restart/fallback events.
          (c) last_activity_seconds_ago: time since last finding/event/pulse.
      - id: STEP_08
        title: "Doctor --pr oracle: worktree + projection status"
        detail: |
          Add worktree and projection sections:
          (a) worktree_exists, worktree_clean, merge_conflicts count.
          (b) github_projection: auto_merge_enabled, last_comment_updated_at,
              projection_lag_seconds.
          (c) Filter stale pulse data: exclude pulses that don't match current run_id.
      - id: STEP_09
        title: "Doctor system-level summary (no --pr)"
        detail: |
          Extend `apm2 fac doctor --json` (no --pr flag):
          (a) Keep existing system health checks (daemon, disk, token, socket).
          (b) Add `tracked_prs` array: one entry per tracked PR with:
              pr_number, owner_repo, lifecycle_state, recommended_action,
              active_agents, last_activity_seconds_ago.
          (c) This replaces the PR-discovery use case of `fac review status`
              without --pr.
      - id: STEP_10
        title: "Fix sequence_done premature emission"
        detail: |
          In the event emission logic:
          (a) Do not emit sequence_done until ALL active lanes are terminal.
          (b) When one lane terminates while another is alive, emit a
              lane-specific event (e.g. quality_terminated), not sequence_done.
          (c) sequence_done fires only when every lane has reached terminal
              state (done, failed, max_restarts_exceeded).
      - id: STEP_11
        title: "Deprecate fac review status and fac recover"
        detail: |
          (a) Add deprecation warning to `fac review status` stderr output:
              "DEPRECATED: use `apm2 fac doctor --pr <N> --json` instead."
          (b) Add deprecation warning to `fac recover` stderr output:
              "DEPRECATED: use `apm2 fac doctor --pr <N> --fix` instead."
          (c) Update orchestrator-monitor SKILL.md: replace all status
              and recover references with doctor / doctor --fix.
      - id: STEP_12
        title: "Restart --refresh-identity"
        detail: |
          Add `--refresh-identity` flag to `fac restart`:
          (a) Fetch authoritative SHA from GitHub API.
          (b) If local identity diverges, overwrite with fresh HMAC.
          (c) Proceed with normal restart logic.
      - id: STEP_13
        title: "Push exit code separation"
        detail: |
          In push.rs `dispatch_reviews_with_lifecycle()` error handling:
          (a) Catch dispatch errors after successful push+gates+PR.
          (b) Return exit 0 with `dispatch_warning` field in JSON.
          (c) Emit warning on stderr.
          (d) Exit 1 only for push/gate/PR-creation failures.
      - id: STEP_14
        title: "Push attempt log"
        detail: |
          In push.rs, after each push invocation completes (success or failure):
          (a) Build a PushAttemptRecord with: ts, sha, and per-stage outcome
              (status: pass|fail|skipped, duration_s, exit_code, error_hint).
          (b) Stages: git_push, gate_fmt, gate_clippy, gate_test, gate_doc,
              pr_update, dispatch.
          (c) error_hint: last line of stderr from the failed stage, capped
              at 200 characters. High signal, low noise.
          (d) Append as one NDJSON line to
              ~/.apm2/fac_projection/repos/<repo>/push_attempts/<pr>.ndjson
          (e) Create parent directories if needed. Append-only — never truncate.
          (f) Doctor reads the latest entry for the current SHA to populate
              recommended_action reason (e.g. "last push: gate_test FAIL
              (exit 1, 261s) — test workspace::merge_conflicts timed out").
      - id: STEP_15
        title: "Push identity-last ordering"
        detail: |
          Reorder push.rs flow:
          (a) git push → gates → PR create/update → dispatch → THEN persist identity.
          (b) If intermediate steps fail, identity retains the previous valid SHA.
      - id: STEP_16
        title: "Remove bounded test shell wrapper"
        detail: |
          Delete `scripts/ci/run_bounded_tests.sh` and rewire FAC bounded test
          execution paths to Rust-native `systemd-run` command construction.
      - id: STEP_17
        title: "Findings verdict field consistency"
        detail: |
          In findings_store.rs / findings.rs:
          (a) Remove synthetic verdict computation from findings output.
          (b) If no verdict set, report `verdict: "pending"`, not "FAIL".
          (c) Verdict store remains single source of truth for pass/fail.
      - id: STEP_18
        title: "Machine-readable GitHub projections"
        detail: |
          In verdict_projection.rs:
          (a) Replace `render_findings_markdown()` with structured output.
              The entire decision comment body becomes a single YAML code fence
              containing both the decision payload and a `findings` array.
          (b) Each finding retains full structured fields: type, severity,
              summary, risk, impact, location, body, timestamp.
          (c) Retain the `<!-- DECISION_MARKER -->` HTML comment for upsert.
          (d) No markdown headers, bullet lists, or prose in any FAC comment.
          (e) Update tests that assert on markdown-formatted output.
      - id: STEP_19
        title: "Run formatting, clippy, docs, and full test suite"
        detail: "cargo fmt, clippy, doc, test — mandatory pre-commit."
      - id: STEP_20
        title: "Fix verdict_set transition from gates_passed"
        detail: |
          In lifecycle.rs:2204-2245, add S::GatesPassed to the VerdictSet
          match arm. Make verdict set idempotent for the same SHA/dimension
          to prevent restart death spiral.
      - id: STEP_21
        title: "Doctor restart --force for max_restarts_exceeded"
        detail: |
          Pass review run state (terminal_reason) into build_recommended_action().
          When terminal_reason is max_restarts_exceeded, recommend --force in
          the restart command.
      - id: STEP_22
        title: "Doctor edge case fixes"
        detail: |
          (a) Distinguish "unknown" from "has conflicts" in merge_readiness
              when worktree is missing.
          (b) Add terminal_reason to DoctorReviewSnapshot.
          (c) Increase event scan window beyond 4096 or add per-PR indexing.
          (d) Emit health item when GitHub API unavailable instead of
              silently setting sha_fresh=false.
          (e) Verify lifecycle budget initialization.
          (f) Tighten denied_with_findings to use formal_verdict only.
      - id: STEP_23
        title: "Grand projection decoupling"
        detail: |
          (a) Create github_auth.rs: extract and deduplicate auth helpers
              from barrier.rs and projection.rs.
          (b) Create github_reads.rs: extract read-only GitHub API queries
              from barrier.rs and logs.rs.
          (c) Create verdict_projection.rs: extract verdict comment logic
              from projection.rs (~lines 706-1024).
          (d) Clean up projection.rs to have zero gh calls.
          (e) Clean up logs.rs to have zero gh calls.
          (f) Audit and clean barrier.rs remnants.
          (g) Update all callers to use new module paths.
          (h) Verify zero regressions with full test suite.
  definition_of_done:
    evidence_ids: []
    criteria:
      - "When a reviewer process exits without calling `verdict set`, the reaper auto-derives a verdict from accumulated findings (BLOCKER/MAJOR → deny, MINOR/NIT → approve, no findings → leave pending)."
      - "`decision_receipt_missing` is no longer a terminal failure mode — the reaper closes the lane."
      - "Auto-verdict GitHub projection is best-effort/deferred, never synchronous in the reaper hot path."
      - "When all review dimensions approve for the current HEAD SHA, the branch is automatically merged into local main via `git merge --ff-only`."
      - "Non-fast-forward merge emits `merge_failed` lifecycle event and does not retry."
      - "Worktree `/target` directory is cleaned up fire-and-forget after successful merge."
      - "Auto-merge triggers on both explicit `verdict set` and reaper auto-verdict paths."
      - "`apm2 fac doctor --pr <N> --fix` auto-repairs broken state: reaps stale agents, refreshes stale identity, resets stuck lifecycle."
      - "Doctor --fix reaps dead-PID registry entries and recomputes HMAC, even when existing HMAC is invalid."
      - "Doctor --fix fetches current PR HEAD from GitHub and overwrites stale local identity."
      - "Doctor --fix resets stuck lifecycle state without going through the reducer transition validator."
      - "Doctor --fix auto-derives verdict from findings for reaped reviewers (ties into auto-verdict)."
      - "Doctor without --fix remains purely read-only — no state mutations."
      - "Doctor --fix reports all repairs in `repairs_applied` array with before/after state."
      - "Repair operations never fail due to existing corrupt HMAC or illegal transition state."
      - "Recovery bypass helpers use distinct naming convention (e.g. `_bypass_hmac` suffix)."
      - "`fac recover` is deprecated with warning directing to `fac doctor --pr <N> --fix`."
      - "`apm2 fac doctor --pr <N> --json` includes `recommended_action` with action, reason, priority, and command."
      - "Doctor recommended_action vocabulary is closed: wait, merge, dispatch_implementor, restart_reviews, fix, escalate."
      - "Doctor includes `findings_summary` per dimension with blocker/major/minor/nit counts."
      - "Doctor includes `formal_verdict` and `computed_verdict` per dimension."
      - "Doctor includes `merge_readiness` with all_verdicts_approve, gates_pass, sha_fresh, no_merge_conflicts sub-checks."
      - "Doctor agent entries include `elapsed_seconds`, `models_attempted`, and `last_activity_seconds_ago`."
      - "Doctor includes `worktree_exists`, `worktree_clean`, and `merge_conflicts` count."
      - "Doctor includes `github_projection` status (auto_merge_enabled, projection_lag_seconds)."
      - "Doctor excludes stale pulse data from previous run_ids."
      - "`apm2 fac doctor --json` (no --pr) includes `tracked_prs` summary table with per-PR recommended_action."
      - "sequence_done event does not fire until ALL active lanes are terminal."
      - "Lane-specific terminal events (e.g. quality_terminated) fire independently of sequence_done."
      - "`apm2 fac review status` emits deprecation warning directing users to `doctor --pr`."
      - "`apm2 fac recover` emits deprecation warning directing users to `doctor --fix`."
      - "Orchestrator-monitor SKILL.md uses doctor exclusively for all per-PR queries and recovery."
      - "`apm2 fac restart --refresh-identity --pr <N>` fetches authoritative SHA and updates local identity before proceeding with normal restart."
      - "Every `fac push` invocation appends a structured NDJSON record to `~/.apm2/fac_projection/repos/<repo>/push_attempts/<pr>.ndjson` with per-stage outcomes."
      - "Push attempt records include per-stage status (pass/fail/skipped), duration_s, exit_code, and error_hint (last stderr line, max 200 chars) for failed stages."
      - "Doctor reads the latest push attempt record for the current SHA and incorporates gate failure details into `recommended_action` reason."
      - "Gate failures survive agent death — orchestrators can determine why a push failed without reading agent transcripts."
      - "`apm2 fac push` exits 0 when push+gates+PR succeed but dispatch fails; dispatch failure is reported as a warning, not the exit code."
      - "`apm2 fac push` persists local identity AFTER gates pass and dispatch completes, not before."
      - "`scripts/ci/run_bounded_tests.sh` is removed."
      - "FAC bounded test execution remains enforced via Rust `systemd-run` command paths."
      - "`apm2 fac review findings` reports `verdict: \"pending\"` (not `\"FAIL\"`) when no explicit verdict has been set."
      - "Findings and verdict status are always consistent — no `verdict: FAIL` in findings with `verdict: UNKNOWN` in status."
      - "SATURATION_CHECK in orchestrator-monitor SKILL.md uses per-PR capacity checks, not global."
      - "GitHub decision/verdict comments contain a single structured YAML code fence with both the decision payload and a findings array — no markdown headers, bullet lists, or prose."
      - "Each projected finding retains full structured fields (type, severity, summary, risk, impact, location, body, timestamp) — no lossy rendering."
      - "`render_findings_markdown()` is removed; all GitHub comment rendering is machine-readable."
      - "`apm2 fac review verdict set` succeeds from `gates_passed` lifecycle state — the `reviews_dispatched` intermediate is not required."
      - "`verdict set` is idempotent for the same SHA and dimension — re-setting an existing verdict does not error."
      - "Doctor recommends `--force` when terminal_reason is `max_restarts_exceeded`, breaking the restart noop loop."
      - "`build_recommended_action()` receives review run terminal_reason and incorporates it into recommendations."
      - "Doctor merge_readiness distinguishes 'unknown' (worktree missing) from 'has conflicts' — missing worktree does not trigger merge-conflict escalation."
      - "DoctorReviewSnapshot includes terminal_reason field for crash-loop visibility."
      - "Doctor event scan window handles event logs exceeding 4096 entries without reporting stale activity timestamps."
      - "Doctor emits a health item when GitHub API is unavailable instead of silently failing sha_fresh."
      - "Core FAC modules (lifecycle, dispatch, state, types, events, evidence, gates, findings, logs, projection) contain zero `Command::new(\"gh\")` calls after projection decoupling."
      - "github_auth.rs is the single canonical location for `ensure_gh_cli_ready` and `resolve_authenticated_gh_login` — no copies in barrier.rs or projection.rs."
      - "verdict_projection.rs contains all verdict comment rendering/parsing logic previously in projection.rs."
      - "Bounded test runner uses KillSignal=SIGKILL so TERM-ignoring descendant processes (from containment tests) cannot cause false-FAIL via scope stop timeout."
      - "`build_bounded_test_command()` forwards caller-supplied lane profile env vars (NEXTEST_TEST_THREADS, CARGO_BUILD_JOBS) via --setenv to the systemd-run scope."
      - "All evidence gates and tests pass."
  notes:
    context: |
      Field evidence from multi-PR orchestration sessions with 4+ LLM backends
      (codex, gemini-3-pro, gemini-3-flash, codex-spark). Consistent failure
      pattern: happy path works, but any agent crash, SHA drift (rebase, amend,
      force-push), or partial completion puts the system in a state that requires
      manually deleting state files to recover.

      The design principle driving this ticket: the system must reach a correct
      terminal state even when agents fail at any point in the protocol. LLM
      agents are the most unreliable component in the stack — the system must
      be designed for their failure, not assume their success.

      The second design principle: move decision logic from LLM orchestrators
      into deterministic Rust code. The orchestrator should be a thin dispatch
      loop over doctor recommendations, not a complex reasoning agent parsing
      multiple inconsistent data sources.

      Priority ordering:
        P0 — auto-verdict + auto-merge + recovery bypass + doctor-as-oracle
        P1 — deprecate status, fix sequence_done, restart refresh, push exit code, push attempt log
        P2 — identity-last ordering, bounded shell wrapper removal, findings consistency, skill rewrite

      The orchestrator-monitor SKILL.md per-PR capacity fix is already done in
      this branch (SATURATION_CHECK, ENFORCE_BACKPRESSURE, invariants updated).
    amendments:
      - amendment_id: "AMD-2026-02-16-FAC-THROUGHPUT-PIVOT"
        summary: "Bounded test execution remains mandatory as containment; throughput defaults move to host-aware profile resolution."
        replacement:
          - "Use gate throughput profiles (`throughput`, `balanced`, `conservative`) for CPU/test parallelism defaults."
          - "Use queue admission as the primary contention control on high-capacity hosts."

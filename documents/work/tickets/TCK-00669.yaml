ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00669"
    title: "FAC execution queue: migrate toward ledger-backed job lifecycle; treat filesystem queue as witnessed cache and add rehydration reconciler"
    status: "IN_PROGRESS"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0032"
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_QUEUE", "DOMAIN_KERNEL", "DOMAIN_DAEMON", "DOMAIN_RUNTIME"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00656"
        reason: "Immediate lane-lease identity fixes reduce risk during migration; this ticket builds the longer-term substrate alignment."

delivery_notes:
  completed_in_related_changes:
    - "Baseline ledger-backed FAC job lifecycle events and reconciler plumbing have landed."
    - "Filesystem queue is now treated as a witnessed cache in the main execution path."
    - "Worker terminal queue transitions now retain claimed-lock ownership until commit completes, preventing cross-worker re-claim races during terminalization."
    - "Inline one-shot worker fallback now skips long-lived queue watcher/watchdog runtime primitives, preventing inotify/thread accumulation (`EMFILE`) during repeated `fac push` retry cycles."
  remaining_focus:
    - "Operational wiring hardening (doctor/fix orchestration, stale-runtime detection, bounded reconciler guarantees under restart churn)."
    - "Final removal/deprecation path for manual/legacy queue repair entrypoints that conflict with ledger-authoritative behavior."
  requirement_clarifications:
    - "Queue lifecycle authority is ledger+projection only; filesystem queue state must remain a recoverable cache and never gate authority-critical decisions without projection corroboration."
    - "Doctor/fix is the canonical operator recovery workflow; direct/manual mutation commands must not bypass the reconciler state machine."
    - "Any remaining queue health/status surfaces must read from daemon projection or daemon RPCs, not ad-hoc local state files."
    - "Claimed queue file locks must remain held for the entire terminal mutation window (no early release before move/receipt commit)."
    - "Pipeline-commit failures must leave token-bound jobs in `claimed/` for reconciler repair; do not requeue consumed-authority jobs to `pending/`."

root_cause_analysis:
  summary: |
    The current FAC queue uses filesystem directories (pending/claimed/running/done)
    as the primary state store. This creates inherent brittleness:
      - claimed-but-unpicked jobs when workers crash (directory state becomes stuck),
      - PID-based ownership drift,
      - difficulty auditing, replaying, or distributing queue state,
      - multiple sources of truth (filesystem vs daemon ledger vs pulses).

    The long-term direction (100B agents) requires the queue lifecycle to be an
    event-sourced projection over the canonical substrate:
      - ledger events define job lifecycle and authority,
      - filesystem representations are derived caches for local execution backends.

scope:
  in_scope:
    - id: "QL-R1"
      title: "Finalize doctor-driven autonomous recovery and remove conflicting manual repair assumptions"
      detail: |
        Ensure doctor/fix owns queue hygiene end-to-end for ledger-authoritative operation.
        Any legacy/manual queue repair path that can diverge from projection truth must be
        removed or redirected through doctor/fix.

    - id: "QL-R2"
      title: "Enforce bounded reconciler behavior under sustained churn"
      detail: |
        Add explicit runtime guards and tests for:
          - max events processed per tick
          - max filesystem ops per tick
          - cursor/checkpoint monotonicity under repeated crash/restart cycles

        The reconciler must remain CPU and I/O bounded under adversarial queue shapes.

    - id: "QL-R3"
      title: "Verification: divergence healing remains projection-authoritative"
      detail: |
        Add/maintain crash matrix tests for:
          - crash after filesystem mutate but before ledger append
          - crash after ledger append but before filesystem mutate
          - restart convergence to projection-defined truth (fail-closed on ambiguity)

        The correctness rule remains: ledger projection wins; filesystem is repaired to match.

  out_of_scope:
    - Full deletion of filesystem queue implementation (future phase).
    - Distributed queue scheduling beyond a single node (future; BFT-backed ledger backend becomes relevant then).

plan:
  steps:
    - Remove/redirect legacy manual queue repair paths into doctor-driven flows.
    - Add explicit boundedness assertions and regression tests for reconciler loop caps.
    - Expand crash/divergence matrix tests and prove deterministic convergence to projection truth.
    - Audit daemon wiring so queue authority reads never bypass projection state.

definition_of_done:
  criteria:
    - "Doctor/fix is the sole supported autonomous recovery path for queue divergence repair."
    - "Reconciler boundedness is enforced and regression-tested under crash/restart churn."
    - "Crash/divergence tests demonstrate restart convergence to ledger-defined truth."
    - "No authority-critical queue path depends on filesystem state without projection corroboration."

risks:
  - id: "R-QL-01"
    title: "Large refactor touches hot-path queue logic"
    mitigation: |
      Keep migration staged (dual-write behind flag). Use extensive tests + staged rollout in CI.
      Do not remove existing queue behavior until projection has parity evidence.

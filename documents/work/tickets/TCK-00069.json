{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-25",
    "template_version": "2026-01-25",
    "ticket": {
      "id": "TCK-00069",
      "title": "Refactor Reviewer Spawn Logic into Shared Module"
    },
    "binds": {
      "prd_id": "NONE",
      "rfc_id": "RFC-0006",
      "requirements": [
        {
          "requirement_id": "MAINT-016",
          "requirement_ref": "documents/rfcs/RFC-0006/01_problem_and_imports.yaml#rfc_local_requirements.requirements[10]"
        }
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_BUILD_RELEASE"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00068"
      ]
    },
    "scope": {
      "in_scope": [
        "Create ReviewerSpawner struct in xtask/src/reviewer_state.rs",
        "Consolidate temp file creation logic into ReviewerSpawner",
        "Consolidate prompt interpolation logic into ReviewerSpawner",
        "Consolidate script command construction into ReviewerSpawner",
        "Consolidate state persistence logic into ReviewerSpawner",
        "Implement single spawn() method used by all callers",
        "Update xtask/src/tasks/push.rs to use ReviewerSpawner::spawn()",
        "Update xtask/src/tasks/check.rs to use ReviewerSpawner::spawn()",
        "Update xtask/src/tasks/review.rs to use ReviewerSpawner::spawn()",
        "Remove duplicate implementations from individual task modules"
      ],
      "out_of_scope": [
        "Changes to AI reviewer prompt content",
        "Changes to health monitoring logic (already in reviewer_state.rs)",
        "Adding new reviewer types",
        "Cross-platform support (covered by TCK-00070)"
      ]
    },
    "plan": {
      "steps": [
        "Audit push.rs, check.rs, review.rs for spawn-related code patterns",
        "Identify common code: temp file creation, prompt loading, command construction, state writes",
        "Design ReviewerSpawner struct with fields: review_type, pr_url, head_sha, prompt_path",
        "Implement ReviewerSpawner::new() constructor",
        "Implement ReviewerSpawner::with_prompt() method to set prompt file path",
        "Implement ReviewerSpawner::spawn() method that handles full spawn lifecycle",
        "spawn() creates temp file for log, constructs script command using shell_escape utilities",
        "spawn() spawns process, records state in ReviewerStateFile, returns child PID",
        "Update push.rs trigger_ai_reviews() to use ReviewerSpawner",
        "Update review.rs run_ai_review() to use ReviewerSpawner",
        "Update check.rs remediate_reviewer() to use ReviewerSpawner",
        "Remove duplicate code from individual modules",
        "Verify single source of truth for spawn logic",
        "Verify cargo build succeeds",
        "Verify cargo test passes",
        "Verify cargo clippy passes with no warnings"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [],
      "criteria": [
        "ReviewerSpawner struct exists in xtask/src/reviewer_state.rs",
        "ReviewerSpawner has spawn() method that handles complete spawn lifecycle",
        "spawn() creates temp file, constructs command, spawns process, writes state",
        "push.rs uses ReviewerSpawner::spawn() for all reviewer spawning",
        "check.rs uses ReviewerSpawner::spawn() for remediation restarts",
        "review.rs uses ReviewerSpawner::spawn() for synchronous reviews",
        "No duplicate temp file creation logic exists in push.rs, check.rs, or review.rs",
        "No duplicate script command construction exists in push.rs, check.rs, or review.rs",
        "No duplicate state write logic exists in push.rs, check.rs, or review.rs",
        "Spawn logic exists in exactly one place (ReviewerSpawner)",
        "cargo build succeeds",
        "cargo test passes",
        "cargo clippy passes with no warnings"
      ]
    },
    "notes": {
      "security": "Centralized spawn logic reduces risk of inconsistent security patterns.\nAll spawn paths benefit from shell_escape utilities from TCK-00068.\n",
      "implementation_details": "ReviewerSpawner encapsulates the full spawn lifecycle:\n1. Load prompt from file path\n2. Create temp file for prompt content\n3. Create temp file for log capture (optional)\n4. Construct script command using shell_escape::build_script_command()\n5. Spawn process via Command::new()\n6. Record entry in ReviewerStateFile\n7. Return child PID for tracking\n\nThis replaces scattered implementations across:\n- push.rs: trigger_ai_reviews() function\n- review.rs: run_ai_review() function\n- check.rs: remediate_reviewer() spawn section\n\nNote: Implementers should verify sysinfo and nix crate APIs against\nthe actual installed versions as APIs may change between releases.\n\nStale reference cleanup: After this refactoring, check xtask/src/main.rs\nfor any remaining \"Codex\" references in docstrings (e.g., around line 206)\nthat should be updated to \"Gemini\" as part of TCK-00066 follow-up.\n",
      "affected_files": "Modified: xtask/src/reviewer_state.rs (add ReviewerSpawner)\nModified: xtask/src/tasks/push.rs (use ReviewerSpawner)\nModified: xtask/src/tasks/review.rs (use ReviewerSpawner)\nModified: xtask/src/tasks/check.rs (use ReviewerSpawner)\n"
    }
  }
}

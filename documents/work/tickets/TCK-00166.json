{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00166",
      "title": "Implement tool receipt generation",
      "status": "CLOSED"
    },
    "binds": {
      "rfc_id": "RFC-0013",
      "requirements": [
        {
          "requirement_id": "REQ-RECEIPT-001"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00165"
      }
    ]
  },
  "acceptance_criteria": [
    {
      "criterion": "Receipt generation per AD-RECEIPT-001",
      "verification": "Receipt contains all required fields"
    },
    {
      "criterion": "Binding to envelope and tool result hash",
      "verification": "Receipt binds envelope_hash and result_hash"
    },
    {
      "criterion": "Unsigned bytes hash for signing",
      "verification": "canonical_bytes() produces stable hash"
    }
  ],
  "implementation": {
    "code_examples": [
      {
        "description": "ToolReceipt structure",
        "code": "pub struct ToolReceipt {\n    pub kind: ReceiptKind,\n    pub envelope_hash: Hash,\n    pub policy_hash: Hash,\n    pub canonicalizer_id: CanonicalizerId,\n    pub canonicalizer_version: u32,\n    pub evidence_refs: Vec<Hash>,\n    pub unsigned_bytes_hash: Hash,\n    pub signature: Option<Signature>,\n    pub signer_identity: Option<SignerIdentity>,\n}\n\nimpl ToolReceipt {\n    pub fn canonical_bytes(&self) -> Vec<u8>;\n    pub fn unsigned_bytes(&self) -> Vec<u8>;\n    pub fn verify(&self, public_key: &PublicKey) -> Result<bool>;\n}\n"
      }
    ],
    "files_to_create": [
      {
        "path": "crates/apm2-daemon/src/evidence/receipt.rs",
        "purpose": "Receipt types and generation"
      },
      {
        "path": "crates/apm2-daemon/src/evidence/binding.rs",
        "purpose": "Evidence binding logic"
      },
      {
        "path": "crates/apm2-daemon/src/evidence/receipt_builder.rs",
        "purpose": "Builder pattern for receipt construction"
      }
    ],
    "files_to_modify": [
      {
        "changes": "Export receipt, binding, receipt_builder modules",
        "path": "crates/apm2-daemon/src/evidence/mod.rs"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Define receipt types",
        "details": "Create receipt types per AD-RECEIPT-001:\n- ReceiptKind: ToolExecution, EpisodeStart, EpisodeStop, etc.\n- Common fields: envelope_hash, policy_hash, canonicalizer\n- Type-specific fields: result_hash, decision, duration\n"
      },
      {
        "step": 2,
        "action": "Implement canonical_bytes",
        "details": "Deterministic serialization per AD-VERIFY-001:\n- Fields in tag order\n- No maps\n- Explicit defaults\n- Signature field excluded\n"
      },
      {
        "step": 3,
        "action": "Implement ReceiptBuilder",
        "details": "Builder pattern for receipt construction:\n- for_tool_execution(request_id, result)\n- with_envelope(envelope_hash)\n- with_policy(policy_hash)\n- with_evidence(evidence_refs)\n- build() -> Receipt (unsigned)\n"
      },
      {
        "step": 4,
        "action": "Implement evidence binding",
        "details": "Bind receipt to evidence:\n- Collect CAS hashes for tool args, result\n- Include envelope hash\n- Include policy hash\n- Compute unsigned_bytes_hash\n"
      },
      {
        "step": 5,
        "action": "Create golden vectors",
        "details": "Golden vectors for receipt canonicalization:\n- Various receipt kinds\n- Different evidence ref counts\n- Verify stable hashing\n"
      }
    ],
    "summary": "Implement tool receipt generation per AD-RECEIPT-001.\nReceipts bind envelope hash, policy hash, and evidence refs.\nIncludes canonical_bytes() for deterministic signing.\n"
  },
  "notes": "Phase: PHASE-2B (Tool Execution and Receipts)\nGenerated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.\nMaps to TCK-PEND-009b.\n",
  "test_requirements": [
    {
      "description": "Receipt binding",
      "test_id": "UT-00166-01",
      "verification_command": "cargo test -p apm2-daemon receipt_binding"
    },
    {
      "description": "Golden vectors",
      "test_id": "UT-00166-02",
      "verification_command": "cargo test -p apm2-daemon receipt_golden_vectors"
    },
    {
      "description": "Builder pattern",
      "test_id": "UT-00166-03",
      "verification_command": "cargo test -p apm2-daemon receipt_builder"
    }
  ]
}

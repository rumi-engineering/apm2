{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-26",
    "template_version": "2026-01-26",
    "ticket": {
      "id": "TCK-00114",
      "title": "Implement Impact Map generation",
      "status": "CLOSED"
    },
    "binds": {
      "rfc_id": "RFC-0010",
      "requirements": [
        {
          "requirement_id": "REQ-0003"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00113"
      }
    ]
  },
  "implementation": {
    "summary": "Create the impact_map module in apm2-core that parses PRD requirements,\nmaps them to CCP components, identifies duplication risks when multiple\nextension points are viable, and classifies net-new substrate. Output\nis deterministic YAML suitable for downstream RFC framing.\n",
    "files_to_create": [
      {
        "path": "crates/apm2-core/src/impact_map/mod.rs",
        "purpose": "Module root exposing public API for impact map generation"
      },
      {
        "path": "crates/apm2-core/src/impact_map/mapper.rs",
        "purpose": "Core mapping logic from PRD requirements to CCP components"
      },
      {
        "path": "crates/apm2-core/src/impact_map/adjudication.rs",
        "purpose": "Duplication risk detection and extension point adjudication"
      },
      {
        "path": "crates/apm2-core/src/impact_map/output.rs",
        "purpose": "Deterministic YAML output generation for impact maps"
      },
      {
        "path": "crates/apm2-cli/src/commands/factory/impact_map.rs",
        "purpose": "CLI command implementation for 'factory impact-map build'"
      }
    ],
    "files_to_modify": [
      {
        "path": "crates/apm2-core/src/lib.rs",
        "changes": "Add 'pub mod impact_map;' to expose the new module"
      },
      {
        "path": "crates/apm2-cli/src/main.rs",
        "changes": "Register the impact-map subcommand under factory"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Create impact_map module structure",
        "details": "Create crates/apm2-core/src/impact_map/mod.rs with:\n- pub mod mapper;\n- pub mod adjudication;\n- pub mod output;\n- Re-export key types (ImpactMap, MappedRequirement, DuplicationRisk)\n"
      },
      {
        "step": 2,
        "action": "Implement requirement parser in mapper.rs",
        "details": "Parse PRD requirements from documents/prds/<PRD-ID>/requirements/*.yaml.\nExtract requirement IDs, descriptions, and any existing component hints.\nUse serde_yaml for deserialization.\n"
      },
      {
        "step": 3,
        "action": "Implement CCP component matching in mapper.rs",
        "details": "Load CCP index from evidence/prd/<PRD-ID>/ccp/ccp_index.json.\nMatch requirements to components based on:\n- Explicit component references in requirement (highest priority)\n- Keyword matching against component descriptions (see algorithm below)\n- Extension point compatibility (check if requirement needs extension vs new module)\n\n**Keyword matching algorithm (in order of preference):**\n1. Exact substring match on component description or module names\n2. Word-level Jaccard similarity (threshold >= 0.3 for candidate inclusion)\n3. LLM-assisted matching for ambiguous cases (see rules below)\n\n**LLM fallback rules:**\n- Invoke LLM only when: (a) no exact match found AND (b) all Jaccard scores < 0.3\n- Use routing profile stage \"impact_map\" for model selection\n- Record LLM-assisted mappings in impact_map.yaml under `llm_assisted_mappings`:\n  ```yaml\n  llm_assisted_mappings:\n    - requirement_id: REQ-0003\n      matched_component: COMP-CORE\n      confidence: 0.85\n      rationale: \"Requirement mentions 'impact analysis' which aligns with core library capabilities\"\n  ```\n- LLM confidence threshold: mappings with confidence < 0.6 are flagged as \"needs_human_review\"\n\nFor each requirement, return ranked list of candidate components with\nfit_score (high/medium/low) and rationale string.\n"
      },
      {
        "step": 4,
        "action": "Implement adjudication logic",
        "details": "In adjudication.rs, detect when multiple extension points could satisfy\na requirement. Flag these as DuplicationRisk with severity levels.\nClassify unmapped requirements as \"net-new substrate\".\n"
      },
      {
        "step": 5,
        "action": "Implement deterministic output",
        "details": "In output.rs, generate impact_map.yaml with:\n- Sorted keys for determinism\n- 2-space indentation\n- Content hash of the output\nWrite to evidence/prd/<PRD-ID>/impact_map/impact_map.yaml\n"
      },
      {
        "step": 6,
        "action": "Implement CLI command",
        "details": "In impact_map.rs CLI, implement:\n- Parse --prd argument\n- Load CCP index (error if missing)\n- Call mapper with requirements\n- Write output atomically\n"
      },
      {
        "step": 7,
        "action": "Register CLI command and export module",
        "details": "Update lib.rs to export impact_map module.\nUpdate main.rs to add impact-map subcommand under factory.\n"
      }
    ],
    "code_examples": []
  },
  "acceptance_criteria": [
    {
      "criterion": "All requirements mapped or classified as net-new",
      "verification": "Run on PRD-0005 and verify every requirement has a mapping or net-new classification"
    },
    {
      "criterion": "Duplication risks flagged",
      "verification": "Verify output contains duplication_risks array when multiple extension points viable"
    },
    {
      "criterion": "Deterministic YAML output",
      "verification": "Run twice and diff output files - must be identical"
    }
  ],
  "test_requirements": [
    {
      "test_id": "UT-114-01",
      "description": "Test requirement parsing from PRD requirements directory",
      "verification_command": "cargo test -p apm2-core impact_map::mapper::tests"
    },
    {
      "test_id": "UT-114-02",
      "description": "Test CCP component matching algorithm",
      "verification_command": "cargo test -p apm2-core impact_map::mapper::tests::component_matching"
    },
    {
      "test_id": "UT-114-03",
      "description": "Test duplication risk detection",
      "verification_command": "cargo test -p apm2-core impact_map::adjudication::tests"
    },
    {
      "test_id": "UT-114-04",
      "description": "Test deterministic YAML output",
      "verification_command": "cargo test -p apm2-core impact_map::output::tests::determinism"
    },
    {
      "test_id": "IT-114-01",
      "description": "Integration test: full impact map generation",
      "verification_command": "cargo run --bin apm2 -- factory impact-map build --prd PRD-0005"
    }
  ],
  "notes": "This ticket implements Phase 2 of RFC-0010. The impact map is a critical\nartifact that bridges PRD requirements to the codebase structure via CCP.\n\nKey design decisions:\n- Use CCP index hash for cache invalidation\n- Adjudication produces warnings, not errors (human review expected)\n- Net-new classification triggers downstream RFC sections for new modules\n\nDepends on TCK-00113 (CCP index) being complete.\n"
}

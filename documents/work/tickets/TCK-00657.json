{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00657",
      "title": "FAC: Normalize LaneLease.started_at to RFC3339 (fix epoch-secs bug + legacy decode)",
      "status": "MERGED"
    },
    "binds": {
      "prd_id": "PRD-0001",
      "rfc_id": "RFC-0019",
      "requirements": [
        "REQ-0011",
        "REQ-0013"
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "Implementer",
        "Reviewer"
      ],
      "responsibility_domains": [
        "fac/lane-lease",
        "fac/reconcile"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00622",
        "TCK-00577"
      ]
    }
  },
  "context": {
    "observed_symptoms": [
      "Lane lease age warnings are frequently \"unknown\"; on-call cannot reliably reason about lane lease staleness from logs.",
      "Downstream logic that expects RFC3339 cannot safely compute lease age or enforce TTL policies.",
      "After TCK-00577, `apm2 fac push` hard-fails in user-mode (local dev) because _apm2-job is not in /etc/passwd — no service user is ever provisioned.",
      "Even when _apm2-job exists, fchown(fd, -1, _apm2-job_gid) fails for calling user (ubuntu) because it is not in the group and lacks CAP_CHOWN — broker-mediated path is broken for unprivileged users."
    ],
    "code_evidence": [
      "LaneLeaseV1 documents started_at as ISO 8601 (RFC3339):\n  crates/apm2-core/src/fac/lane.rs (LaneLeaseV1.started_at docstring)\n",
      "Worker writes started_at as epoch seconds string, not RFC3339:\n  crates/apm2-cli/src/commands/fac_worker.rs:4415\n  started_at = &current_timestamp_epoch_secs().to_string()\n",
      "Worker-side helper expects RFC3339 and returns None on epoch seconds:\n  crates/apm2-cli/src/commands/fac_worker.rs:1367-1373 (parse_started_at_age_secs)\n",
      "Service user gate fires unconditionally in check_queue_write_permission regardless of\nexecution backend mode; no user-mode bypass path exists:\n  crates/apm2-cli/src/commands/fac.rs (check_queue_write_permission)\n",
      "bootstrap never calls useradd or creates _apm2-job; RFC-0019 assigned this to bootstrap\nbut no implementation exists:\n  crates/apm2-cli/src/commands/fac.rs (bootstrap subcommand)\n"
    ]
  },
  "problem_statement": "LaneLeaseV1.started_at is semantically specified as an ISO 8601 timestamp, but at least one producer\nwrites epoch-seconds as a string. This breaks time-based reasoning and makes any future TTL-based\nreconciliation unreliable (and currently degrades operator visibility). The format mismatch also\nincreases the risk of subtle \"stale lease\" bugs because multiple call-sites make implicit assumptions\nabout started_at.\n",
  "root_cause_analysis": {
    "primary_cause": "The worker uses current_timestamp_epoch_secs().to_string() when persisting leases, while other\nparts of the system expect RFC3339 (ISO 8601). There is no validator in LaneLeaseV1::new to\nenforce the declared format.\n",
    "contributing_factors": [
      "LaneLeaseV1::new validates length but not timestamp format, so invalid started_at is silently accepted.",
      "There is no migration/backward-compat parsing path; old leases persist until manual lane reset."
    ]
  },
  "proposed_change": {
    "intent": "Make LaneLeaseV1.started_at unambiguous and machine-checkable by:\n  (1) enforcing RFC3339 on new writes,\n  (2) supporting a legacy decode path for epoch-seconds strings to avoid bricking existing lanes,\n  (3) centralizing lease age computation in apm2-core (single source of truth).\n"
  },
  "invariants": [
    {
      "id": "INV-LEASE-TS-001",
      "statement": "All newly persisted LaneLeaseV1.started_at values MUST be RFC3339 timestamps (UTC, offset Z)."
    },
    {
      "id": "INV-LEASE-TS-002",
      "statement": "LaneLeaseV1::load MUST accept legacy epoch-seconds started_at and expose a canonical RFC3339 view."
    },
    {
      "id": "INV-LEASE-TS-003",
      "statement": "Age/TTL calculations MUST be monotonic-time safe where possible (Instant), and wall-clock parsing failures MUST fail closed (no automatic reclaim) unless additional evidence proves staleness."
    }
  ],
  "scope": {
    "in_scope": [
      {
        "id": "S1",
        "description": "Add a canonical timestamp parser/normalizer in apm2-core:\n  - parse RFC3339 (preferred)\n  - parse legacy epoch-seconds (u64) and convert to RFC3339\n  - expose helpers:\n      LaneLeaseV1::started_at_rfc3339() -> Option<String>\n      LaneLeaseV1::started_at_epoch_secs() -> Option<u64>\n      LaneLeaseV1::age_secs(now_epoch_secs: u64) -> Option<u64>\nThis keeps format policy out of the CLI worker.\n"
      },
      {
        "id": "S2",
        "description": "Enforce started_at format on new writes:\n  - Update all LaneLeaseV1::new call-sites to pass RFC3339.\n    Known call-sites:\n      - crates/apm2-cli/src/commands/fac_worker.rs\n      - crates/apm2-cli/src/commands/fac.rs (lane init / reset helpers)\n      - tests that currently pass \"t\" or other placeholders\n"
      },
      {
        "id": "S3",
        "description": "Update any age/TTL logic to use apm2-core helpers:\n  - Replace parse_started_at_age_secs in fac_worker.rs with LaneLeaseV1::age_secs.\n  - Ensure reconcile warnings/logs show both raw and canonical started_at when legacy detected.\n"
      },
      {
        "id": "S4",
        "description": "Add tests:\n  - Unit: started_at RFC3339 parse/roundtrip.\n  - Unit: legacy epoch-secs parse converts to RFC3339 (stable conversion in UTC).\n  - Unit: invalid started_at is rejected by LaneLeaseV1::new OR produces None canonical view.\n    (Choose one policy; prefer \"reject on persist\" but allow load for migration.)\n  - Regression: worker lease writes RFC3339.\n"
      },
      {
        "id": "S5",
        "description": "Fix user-mode (local dev) regression introduced by TCK-00577:\n  - In check_queue_write_permission, detect when the execution backend is UserMode.\n  - When UserMode: bypass the service user gate entirely and use UnsafeLocalWrite\n    semantics automatically. No env var opt-in, no useradd required.\n  - Rationale: in user-mode, worker and CLI both run as the same user (e.g., ubuntu);\n    privilege separation is not applicable and the gate is unreachable by design.\n  - Scope covers push, gates, and warm enqueue paths (all callers of check_queue_write_permission).\n"
      },
      {
        "id": "S6",
        "description": "Implement _apm2-job service user provisioning in bootstrap --system:\n  - `apm2 fac bootstrap --system` must:\n      * Create _apm2-job system user (useradd -r -s /usr/sbin/nologin _apm2-job) if not present.\n      * chown/chgrp the FAC root directories to _apm2-job where required.\n      * Add the calling user to the _apm2-job group (usermod -aG _apm2-job $SUDO_USER).\n  - Provisioning must be idempotent (safe to re-run).\n  - bootstrap --user (local dev mode) MUST NOT attempt provisioning.\n"
      }
    ],
    "out_of_scope": [
      "Changing queue/job receipt timestamp formats (handled elsewhere).",
      "Introducing TTL-based reclaim policies (separate ticket once timestamps are trustworthy).",
      "Full redesign of the broker-mediated ownership transfer path (larger change, system-mode only)."
    ]
  },
  "plan": {
    "steps": [
      {
        "id": "P1",
        "description": "Implement timestamp parsing + normalization helpers in apm2-core (no behavior change yet)."
      },
      {
        "id": "P2",
        "description": "Switch producers to write RFC3339 and update tests accordingly."
      },
      {
        "id": "P3",
        "description": "Replace worker-local age parsing with apm2-core helper; improve log messages for legacy leases."
      },
      {
        "id": "P4",
        "description": "Run full test suite; specifically exercise fac worker reconcile paths against a legacy lease fixture."
      },
      {
        "id": "P5",
        "description": "Add UserMode bypass in check_queue_write_permission; verify push/gates/warm enqueue work in local dev without _apm2-job present."
      },
      {
        "id": "P6",
        "description": "Implement idempotent _apm2-job provisioning in bootstrap --system (useradd, chown dirs, add caller to group); add --system vs --user guard."
      }
    ]
  },
  "definition_of_done": {
    "criteria": [
      "All LaneLeaseV1 persisted by apm2 uses RFC3339 started_at (validated by unit tests + a focused integration test in fac_worker).",
      "Legacy leases with epoch-seconds started_at are readable and show a canonical RFC3339 started_at in status output/logs.",
      "No call-site performs ad-hoc parsing of lease started_at; apm2-core is the only parser."
    ],
    "evidence_ids": [
      "EVID-TCK-00657-01 (unit): lane lease timestamp normalization tests",
      "EVID-TCK-00657-02 (integration): fac_worker writes RFC3339 leases",
      "EVID-TCK-00657-03 (integration): apm2 fac push succeeds in UserMode without _apm2-job present",
      "EVID-TCK-00657-04 (integration): bootstrap --system creates _apm2-job and adds caller to group (idempotent)"
    ]
  },
  "test_plan": {
    "unit_tests": [
      "crates/apm2-core/src/fac/lane.rs: add tests for started_at parsing + normalization",
      "check_queue_write_permission: UserMode returns UnsafeLocalWrite without consulting /etc/passwd"
    ],
    "integration_tests": [
      "crates/apm2-cli/src/commands/fac_worker.rs: extend existing lane tests to assert started_at is RFC3339",
      "fac push in UserMode environment (no _apm2-job): assert success end-to-end",
      "bootstrap --system (in CI with sudo or a test double): assert _apm2-job created, dirs chowned, caller added to group; re-run asserts idempotent"
    ]
  },
  "rollout": {
    "migration_notes": "This change MUST be backward-compatible for reading existing leases, because field values are\nalready present on disk. New writes will be RFC3339; old values remain parseable.\n",
    "operational_checklist": [
      "After deploy, run: apm2 fac queue lanes --json | verify started_at is RFC3339 for newly running jobs."
    ]
  },
  "notes": {
    "security": "Timestamp parsing is not security-sensitive, but impacts reconcile correctness. Fail closed on\nparse errors when reclaim decisions would depend on age.\n",
    "risk": [
      "If LaneLeaseV1::new becomes strict, some tests and any out-of-tree tooling writing leases may break; keep load permissive.",
      "Time conversion relies on wall clock; do not introduce reclaim decisions that depend solely on started_at until combined with additional evidence (lock state, process identity, unit liveness)."
    ]
  }
}

ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00619"
    title: "Fix: PR closed instead of merged in GitHub projection; remove post-merge worktree deletion; remove --allow-legacy-cache flag"
    status: "OPEN"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME", "DOMAIN_CI", "DOMAIN_SECURITY"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00618"
        reason: "Lifecycle gate-retry and verdict-comment fixes; related projection infrastructure."

root_cause_analysis:
  summary: |
    Three issues addressed in this ticket:

    BUG 1 (Regression, introduced in TCK-00617): PRs are marked "closed" rather than "merged" on GitHub
      after a successful local fast-forward merge.
      Location: crates/apm2-cli/src/commands/fac_review/github_projection.rs:385-415
        (close_pr_if_open), called from lifecycle.rs:3018 via
        project_merge_to_github_with().
      Observed: After local merge + push to origin/main, the GitHub projection
        calls close_pr_if_open(), which issues:
          PATCH /repos/{owner/repo}/pulls/{pr_number}  {"state": "closed"}
        This sets PR state to "closed", not "merged". GitHub distinguishes
        the two: a merged PR shows the purple "Merged" badge and is recorded
        in the commit's associated-PRs list; a closed PR shows the red "Closed"
        badge and is not associated with the merge commit. This corrupts the
        audit trail and breaks any downstream tooling that filters by merged PRs.
      Cause: TCK-00617 added explicit close_pr_if_open() as a best-effort
        projection after local merge, on the theory that GitHub might not
        auto-close the PR when the branch is deleted. The correct mechanism
        to record a PR as merged is the GitHub PR merge endpoint:
          PUT /repos/{owner/repo}/pulls/{pr_number}/merge
        with sha= set to the merge commit SHA. Because the fast-forward merge
        does not create a merge commit (it advances main to the feature branch
        tip), the sha parameter should be the current HEAD of main post-merge.
        Alternatively, GitHub auto-detects a PR as merged when its head branch
        is deleted and the commits are reachable from the base branch — which
        means the delete_remote_branch_projection() step alone may be
        sufficient to trigger the "merged" state without any explicit API call.
      Fix: Replace close_pr_if_open() with a merge_pr_on_github() call that
        uses PUT /repos/{owner/repo}/pulls/{pr_number}/merge. If the PR is
        already closed or merged (idempotent guard), skip the call. If the
        merge API call fails, the projection must fail-closed (propagate error)
        rather than silently succeeding — a PR left in "open" or "closed" state
        is an unacceptable outcome for the audit trail.

    ISSUE 2 (Correctness, introduced in TCK-00617): Post-merge worktree deletion is undesirable.
      Location: lifecycle.rs:2403-2467 (cleanup_merged_branch_local_state_inner),
        called from lifecycle.rs:3394 after project_merge_to_all_sinks_with_retry().
      Detail: cleanup_merged_branch_local_state_inner() runs:
        1. maybe_cleanup_worktree_target() — removes the worktree's /target dir.
        2. git worktree remove --force {worktree_path} — deletes the worktree.
        3. git branch -D {branch} — deletes the local branch ref.
        The worktree deletion (step 2) is problematic: agent processes, editors,
        or the orchestrator itself may hold references to the worktree path.
        Silently deleting a live worktree mid-session causes path-not-found
        errors in consumers and leaves dangling worktree metadata in git.
      Fix: Remove the git worktree remove --force call from
        cleanup_merged_branch_local_state_inner(). Retain the /target removal
        (disk space hygiene) and local branch ref deletion (keeps local branch
        list clean). The worktree lifecycle is managed externally by the
        orchestrator; the merge path must not touch it.

    ISSUE 3 (Cleanup, from TCK-00540): The --allow-legacy-cache migration flag
      is no longer needed and must be removed.
      Location: fac.rs (CLI arg), fac_gates_job.rs, fac_worker.rs,
        fac_review/{mod,gates,gate_cache,evidence,push}.rs
      Background: TCK-00540 added --allow-legacy-cache as a temporary unsafe
        override allowing reuse of gate cache entries that lack RFC-0028/0029
        receipt bindings, to support migration of pre-binding cache entries.
        The migration period is now complete; all live cache entries carry
        proper receipt bindings. Retaining the flag leaves an unsafe override
        path in the security-sensitive gate evaluation stack with no legitimate
        use case. The flag threads through multiple layers of the codebase
        (CLI → job struct → worker opts → review pipeline → gate cache
        check_reuse()), adding complexity and dead-weight to every callsite.
      Fix: Delete the flag and all its infrastructure. The fail-closed default
        behavior (reject entries without both rfc0028_receipt_bound and
        rfc0029_receipt_bound) is retained; only the unsafe override branch
        (legacy_cache_override_unsafe) is removed. This is safe because the
        flag is an opt-in unsafe escape hatch — removing it hardens the default
        and eliminates the migration bypass entirely.

scope:
  in_scope:
    - id: "S1_REPLACE_CLOSE_WITH_MERGE_API"
      title: "Replace close_pr_if_open() with merge_pr_on_github()"
      detail: |
        In github_projection.rs, replace close_pr_if_open() with a new
        function merge_pr_on_github(repo, pr_number, sha) that calls:
          PUT /repos/{repo}/pulls/{pr_number}/merge
          body: { "sha": "{sha}", "merge_method": "merge" }
        The sha must be the current HEAD of local main after fast-forward
        (the feature branch tip, since no merge commit is created).
        Idempotency: if the PR is already in state "merged" or "closed",
        return Ok(()) without re-calling the API.
        Remove the close_pr_if_open function entirely.

    - id: "S2_FAIL_CLOSED_ON_MERGE_PROJECTION"
      title: "Fail closed if GitHub merge projection fails"
      detail: |
        Currently project_merge_to_github_with() aggregates errors and
        returns them but the caller (project_merge_to_all_sinks_with_retry)
        retries up to 3 times with 2 s delay. This is acceptable for the
        merge projection step, but if merge_pr_on_github() fails after all
        retries, the error must propagate to the caller of
        maybe_auto_merge_if_ready_inner() and surface in the merge receipt
        as a projection failure — not silently swallowed.
        The local Merged lifecycle event is already committed at this point,
        so the merge is authoritative locally; however, an unresolved GitHub
        projection failure must be flagged for operator attention (not just
        WARNING-logged).

    - id: "S3_REMOVE_WORKTREE_DELETION"
      title: "Remove git worktree remove --force from post-merge cleanup"
      detail: |
        In cleanup_merged_branch_local_state_inner() (lifecycle.rs:2403-2467),
        remove the block that calls:
          git worktree remove --force {worktree_path}
        (currently around line 2441).
        Retain:
        - maybe_cleanup_worktree_target() — /target dir removal for disk hygiene.
        - git branch -D {branch} — local branch ref cleanup.
        Do not retain: any call to git worktree remove, git worktree prune,
        or std::fs::remove_dir_all on the worktree root.

    - id: "S4_REGRESSION_TESTS"
      title: "Regression tests"
      detail: |
        - Test: after successful local merge, the GitHub projection calls
          PUT .../pulls/{pr}/merge (not PATCH .../pulls/{pr} with state=closed).
        - Test: if merge_pr_on_github() fails, the error propagates (not swallowed).
        - Test: if PR is already merged/closed, merge_pr_on_github() is a no-op.
        - Test: post-merge cleanup does NOT call git worktree remove.
        - Test: post-merge cleanup DOES remove the /target directory.
        - Test: post-merge cleanup DOES delete the local branch ref.
        - Test: --allow-legacy-cache is not present in the CLI surface (arg rejected).
        - Test: check_reuse() always rejects entries missing receipt bindings
          (legacy_cache_override_unsafe branch is gone; fail-closed is unconditional).

    - id: "S5_REMOVE_ALLOW_LEGACY_CACHE"
      title: "Remove --allow-legacy-cache flag and all related infrastructure"
      detail: |
        The --allow-legacy-cache flag was introduced in TCK-00540 as a
        temporary migration override. The migration is complete; remove the
        flag and every layer it touches:
          - fac.rs: delete allow_legacy_cache CLI arg definition and its
            pass-through to run_fac_worker().
          - fac_gates_job.rs: remove allow_legacy_cache field from the job
            struct and its propagation into the worker.
          - fac_worker.rs: remove from FacWorkerOpts, the test stub, and all
            call sites that thread the value into the review pipeline.
          - fac_review/mod.rs: remove from function signatures and any struct
            fields that carry the flag through the review pipeline.
          - fac_review/gates.rs: remove from GateOpts / GateContext structs
            and all gate evaluation call sites.
          - fac_review/gate_cache.rs: remove allow_legacy_cache parameter from
            check_reuse(); delete the legacy_cache_override_unsafe branch and
            the two tests that exercise it
            (legacy_entry_accepted_with_allow_legacy_cache_override and
            allow_legacy_cache_flag_changes_runtime_behaviour).
          - fac_review/evidence.rs: remove extraction of the flag from options
            and the passing of it into the reuse policy calculation.
          - fac_review/push.rs: remove allow_legacy_cache: false initializer
            from the options struct construction.
        The fail-closed default (reject entries lacking rfc0028_receipt_bound
        or rfc0029_receipt_bound) is fully retained — only the unsafe override
        branch is deleted.

  out_of_scope:
    - "Redesigning the overall post-merge projection retry strategy."
    - "Removing the /target directory cleanup or local branch ref deletion."
    - "Unifying the CLI merge path with the daemon MergeExecutor."
    - "Any changes to the local fast-forward merge or signed receipt logic."

plan:
  steps:
    - id: "STEP_01"
      title: "Replace close_pr_if_open with merge_pr_on_github in github_projection.rs"
      detail: |
        Write merge_pr_on_github(repo: &str, pr_number: u32, sha: &str) -> Result<(), String>:
          1. GET PR state; if already "merged" or "closed", return Ok(()).
          2. PUT /repos/{repo}/pulls/{pr_number}/merge with sha and merge_method=merge.
          3. Return Ok(()) on 200; return Err on any other status.
        Delete close_pr_if_open() entirely.
    - id: "STEP_02"
      title: "Thread merge SHA into project_merge_to_github"
      detail: |
        merge_pr_on_github requires the merge SHA (post-fast-forward HEAD of main).
        MergeProjectionContext already carries merge_sha (lifecycle.rs:2523).
        Update project_merge_to_github_with() signature and the close_pr_if_open
        fn-pointer slot to accept sha, passing context.merge_sha through.
    - id: "STEP_03"
      title: "Remove worktree deletion from cleanup_merged_branch_local_state_inner"
      detail: |
        Delete the git worktree remove --force block (and surrounding
        is_missing_worktree_error guard) from the function. Leave
        maybe_cleanup_worktree_target and git branch -D untouched.
    - id: "STEP_04"
      title: "Add regression tests"
      detail: |
        Cover: merge API called (not close), idempotency guard, error propagation,
        no worktree remove call, /target removal preserved, branch -D preserved,
        --allow-legacy-cache absent from CLI, check_reuse() unconditionally
        fail-closed on entries missing receipt bindings.
    - id: "STEP_05"
      title: "Remove --allow-legacy-cache flag and all infrastructure"
      detail: |
        Delete allow_legacy_cache from: fac.rs (CLI arg + pass-through),
        fac_gates_job.rs (job struct field), fac_worker.rs (FacWorkerOpts,
        test stub, call sites), fac_review/mod.rs (signatures + struct fields),
        fac_review/gates.rs (GateOpts, GateContext, eval call sites),
        fac_review/gate_cache.rs (check_reuse() parameter + legacy override
        branch + two associated tests), fac_review/evidence.rs (option
        extraction + reuse policy passing), fac_review/push.rs (struct init).
        Retain the fail-closed default in check_reuse() unchanged.
    - id: "STEP_06"
      title: "Run full workspace validation"
      detail: |
        cargo fmt --all
        cargo clippy --workspace --all-targets --all-features -- -D warnings
        cargo doc --workspace --no-deps
        cargo test --workspace

definition_of_done:
  evidence_ids:
    - "EXEC-TCK00619-MERGE-API-PROJECTION"
    - "EXEC-TCK00619-NO-WORKTREE-DELETION"
    - "EXEC-TCK00619-REMOVE-ALLOW-LEGACY-CACHE"
    - "EXEC-TCK00619-WORKSPACE-VALIDATION"
  criteria:
    - "After a successful local fast-forward merge, the GitHub PR is in 'merged'
      state (purple badge), not 'closed' state."
    - "The GitHub projection calls PUT /repos/{owner/repo}/pulls/{pr}/merge,
      not PATCH with state=closed."
    - "close_pr_if_open() is removed from the codebase entirely."
    - "If merge_pr_on_github() fails after retries, the failure is surfaced
      to the operator (not silently WARNING-logged)."
    - "Post-merge cleanup does not issue git worktree remove for the feature branch worktree."
    - "Post-merge cleanup still removes the worktree /target directory."
    - "Post-merge cleanup still deletes the local feature branch ref."
    - "The --allow-legacy-cache CLI flag is absent from the fac/fac-gates CLI surface."
    - "allow_legacy_cache is removed from every struct, function signature, and
      call site across the eight affected source files."
    - "The legacy_cache_override_unsafe branch in gate_cache::check_reuse() is deleted;
      check_reuse() is unconditionally fail-closed for entries lacking receipt bindings."
    - "Regression tests pass for all the above invariants."
    - "Workspace validation (fmt, clippy, doc, test) completes successfully."

notes:
  context: |
    The PR-closed regression was introduced in TCK-00617 (S2_PROJECT_MERGE_TO_GITHUB),
    which added close_pr_if_open() as a post-merge GitHub projection step.
    The intent was to ensure the PR is not left open if GitHub does not
    auto-detect the merge; the implementation incorrectly used the close
    endpoint instead of the merge endpoint. GitHub's PR state machine
    distinguishes "closed" from "merged": only a merge via the merge
    endpoint (or a push that makes the PR commits reachable from the base
    and triggers auto-detection) sets state to "merged".
    The worktree deletion removal is a correctness fix: the orchestrator
    owns the worktree lifecycle and must not have it deleted underneath it
    by the merge path. The /target cleanup and branch ref deletion remain
    safe and desirable.
    The allow_legacy_cache removal closes out the TCK-00540 migration: that
    ticket added --allow-legacy-cache as an explicit escape hatch so operators
    could continue using cache entries produced before RFC-0028/0029 receipt
    binding was enforced. Those entries are now either expired or re-populated
    with bound receipts. Removing the flag eliminates a permanent unsafe bypass
    in the gate evaluation stack and reduces the codebase surface that must be
    audited for security correctness.
  security: "default-deny, fail-closed on GitHub projection failure; removal of
    legacy_cache_override_unsafe hardens gate cache to unconditional fail-closed"

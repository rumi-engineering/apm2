ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00614"
    title: "FAC projection-model merge safety: required status simplification + regression tests"
    status: "OPEN"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME", "DOMAIN_SECURITY", "DOMAIN_CI"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00613"
        reason: "Continuation of FAC hardening; this ticket scopes CI/ruleset enforcement invariants for projection mode."
  root_cause_analysis:
    summary: |
      INCIDENT: INC-2026-02-17-FAC-AUTOMERGE-FAILOPEN (SEV-1)

      The structural failure was not auto-merge itself; it was that GitHub did not
      treat failing/pending FAC-related signals as required merge blockers.

      In GitHub, auto-merge only waits on REQUIRED checks. If a check is failing but
      not required, merge can still proceed when required checks are satisfied.

      For PRs #704/#709/#710, FAC/preflight signals were failing or skipped while
      merge still proceeded. In projection terms, authoritative merge state was not
      mapped to a single required status context.

      Resolution in this branch is to simplify CI wiring so GitHub is projection-only
      and blocks strictly on one authoritative status: `apm2 / Forge Admission Cycle`.

scope:
  in_scope:
    - id: "S1_REUSABLE_GATES_QUEUE_ABSTRACTION"
      title: "Extract reusable queue-backed gates path"
      detail: |
        Added queue-backed reusable abstractions in
        `crates/apm2-cli/src/commands/fac_review/gates.rs`:
        - `QueuedGatesRequest`
        - `QueuedGatesOutcome`
        - `run_queued_gates_and_collect(...)`
        - fail-closed cache loading and required gate-set verification

        This path waits for queue execution and materializes authoritative
        per-gate rows from attested gate cache for the target SHA.

    - id: "S2_FAC_PUSH_USES_QUEUE_ABSTRACTION"
      title: "Make fac push consume queued gates result (not ad-hoc gate logic)"
      detail: |
        `crates/apm2-cli/src/commands/fac_review/push.rs` now uses
        `run_queued_gates_and_collect(...)` with `require_external_worker=true`
        and blocking wait semantics.

        Push now fails closed when:
        - queue returns empty job id
        - returned head SHA differs from expected push SHA
        - required gate artifacts are missing/inconsistent

    - id: "S3_FAIL_FAST_GATE_EXECUTION"
      title: "Stop gate pipelines on first failure"
      detail: |
        `crates/apm2-cli/src/commands/fac_review/evidence.rs` gate execution was
        hardened to fail on first failing gate in both:
        - `run_evidence_gates_with_lane_context(...)`
        - `run_evidence_gates_with_status_with_lane_context(...)`

        Finalization/projection/cache persistence still runs before returning.

    - id: "S4_REGRESSION_TESTS"
      title: "Add regression tests for queue abstraction and push integration"
      detail: |
        Added/updated tests to lock behavior:
        - queue quick-mode rejection for collection path
        - external-worker-required heartbeat fail-closed
        - cache gate-set completeness enforcement
        - cache-to-result materialization order/status mapping
        - fac push queued outcome SHA mismatch fail-closed

    - id: "S5_CLEANUP_SYNTHETIC_TEST"
      title: "Remove synthetic clippy test artifact"
      detail: |
        Deleted `crates/apm2-core/tests/test_ct_eq.rs` (intentional temporary test
        artifact) and focused branch scope on production FAC queue/gate logic.

  out_of_scope:
    - "Changing GitHub rulesets/workflow policy in this ticket update."
    - "Changing GitHub auto-merge policy semantics directly."
    - "Reintroducing ad-hoc inline gate logic inside fac push."

plan:
  steps:
    - id: "STEP_01"
      title: "Implement reusable queue abstraction"
      detail: "Add reusable queue request/outcome and cache materialization path."
    - id: "STEP_02"
      title: "Route fac push through reusable queue path"
      detail: "Require external worker, wait for queue receipt, validate SHA and gates."
    - id: "STEP_03"
      title: "Harden gate execution fail-fast behavior"
      detail: "Return immediately on first failed gate after deterministic finalization."
    - id: "STEP_04"
      title: "Add regression tests"
      detail: "Cover queue fail-closed invariants and push queue integration guards."
    - id: "STEP_05"
      title: "Run full workspace validation"
      detail: |
        Validate with:
        - `cargo fmt --all`
        - `cargo clippy --workspace --all-targets --all-features -- -D warnings`
        - `cargo doc --workspace --no-deps`
        - `cargo test --workspace`

definition_of_done:
  evidence_ids: []
  criteria:
    - "`fac push` uses reusable queued gates abstraction and blocks on queue completion."
    - "Push fails closed on empty job id, SHA mismatch, and incomplete/inconsistent gate rows."
    - "Gate execution fails on first error while preserving finalization/projection/cache update behavior."
    - "Regression tests assert queue/path invariants and pass."
    - "Workspace validation commands complete successfully."

notes:
  context: |
    This ticket update is scoped only to work completed in this branch iteration:
    reusable queued gates abstraction, fac push queue integration, fail-fast gate
    execution, and corresponding regressions.

    Modified files tied to this ticket:
    - `crates/apm2-cli/src/commands/fac_review/gates.rs`
    - `crates/apm2-cli/src/commands/fac_review/push.rs`
    - `crates/apm2-cli/src/commands/fac_review/evidence.rs`
    - `crates/apm2-core/tests/test_ct_eq.rs` (deleted)
  security: "default-deny, fail-closed gate queueing and projection guards"

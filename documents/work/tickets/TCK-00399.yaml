ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00399"
    title: "Wire AdapterRegistry into SpawnEpisode to spawn agent CLI processes"
    status: "OPEN"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0018"
    requirements:
      - requirement_id: "REQ-HEF-0010"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0010.yaml#rfc_requirement"
    evidence_artifacts:
      - evidence_id: "EVID-HEF-0012"
        artifact_ref: "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0012.yaml#rfc_evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
      - "DOMAIN_ORCHESTRATION"
  dependencies:
    tickets:
      - ticket_id: "TCK-00396"
        reason: "HarnessHandle must have real PTY storage before adapters can be wired into the spawn flow."
      - ticket_id: "TCK-00397"
        reason: "SpawnEpisodeRequest must carry adapter_profile_hash so the handler knows which adapter to use."
  scope:
    in_scope:
      - "Create and wire an AdapterRegistry into the daemon's DaemonState and PrivilegedDispatcher."
      - "In handle_spawn_episode(), after episode state creation, load the adapter profile from CAS using the resolved adapter_profile_hash."
      - "Build a HarnessConfig from the adapter profile + spawn request (command, args template expansion, workspace_root as cwd, env vars, PTY flag)."
      - "Call the appropriate HarnessAdapter::spawn() to create the agent CLI process."
      - "Connect the HarnessEventStream to a bridge task that consumes events and records tool-request intents, but keeps tool execution stubbed until TCK-00401."
      - "Store the HarnessHandle in the EpisodeRuntime for lifecycle management (terminate on episode stop)."
      - "Implement episode stop flow: EpisodeRuntime::stop() calls adapter.terminate() via stored handle."
    out_of_scope:
      - "Codex-specific adapter (TCK-00402) — use RawAdapter or ClaudeCodeAdapter for now."
      - "Model selection / rotation logic (TCK-00400) — this ticket uses whatever profile hash is provided."
      - "Tool bridge protocol (TI1) between agent and kernel — stub the tool request forwarding initially."
  plan:
    steps:
      - "Edit crates/apm2-daemon/src/state.rs and dispatch dependencies so SpawnEpisode can construct an AdapterRegistry from explicit profile hash + CAS (AdapterRegistry::with_profile), not ambient defaults."
      - "Edit crates/apm2-daemon/src/protocol/dispatch.rs: add adapter_registry: AdapterRegistry field to PrivilegedDispatcher. In handle_spawn_episode(), after EpisodeRuntime::start_with_workspace() succeeds, load the AgentAdapterProfileV1 from CAS using the adapter_profile_hash."
      - "Implement build_harness_config() in dispatch.rs or a new helper module: takes AgentAdapterProfileV1 + workspace_root + session_token -> HarnessConfig. Expands {prompt}, {workspace}, {session_token} placeholders in templates, but NEVER place session_token in argv; session_token may be env-only during rollout (WVR-0002)."
      - "Call adapter_registry.get_adapter(adapter_type).spawn(config) to create (HarnessHandle, HarnessEventStream)."
      - "Edit crates/apm2-daemon/src/episode/runtime.rs: add a harness_handles: HashMap<EpisodeId, HarnessHandle> field to EpisodeRuntime. Store the handle after successful spawn."
      - "Spawn a tokio task that reads HarnessEventStream, preserves output events, and records tool-request intents with explicit stub markers (execution path disabled pending TCK-00401)."
      - "Implement EpisodeRuntime::stop_episode(): look up the HarnessHandle, call adapter.terminate(), transition episode to Terminated state, emit EpisodeStopped ledger event."
      - "Wire episode stop into the existing apm2 episode stop CLI command path."
      - "Add integration test: SpawnEpisode with a trivial agent script (echo + exit), verify the process runs and the episode transitions through Created -> Running -> Terminated."
      - "Run cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings && cargo doc --workspace --no-deps && cargo test -p apm2-daemon."
  definition_of_done:
    evidence_ids:
      - "EVID-HEF-0012"
    criteria:
      - "SpawnEpisode handler loads the adapter profile from CAS and spawns an agent CLI process."
      - "Production spawn path does not rely on AdapterRegistry::with_defaults(); adapter selection is explicit via CAS profile hash."
      - "The agent process runs in a PTY with the correct working directory, arguments, and environment."
      - "HarnessHandle is stored in EpisodeRuntime, keyed by episode ID."
      - "HarnessEventStream is consumed in a background task; tool-request intents are captured with explicit stub markers and are not executed in this ticket."
      - "EpisodeRuntime::stop_episode() terminates the agent process and transitions to Terminated state."
      - "Session token is never passed via argv; any rollout token propagation is env-only, short-lived, and redacted (WVR-0002)."
      - "apm2 episode stop <episode_id> triggers the termination flow end-to-end."
      - "An integration test demonstrates a full episode lifecycle: spawn process, process runs, process exits, episode terminates."
      - "All CI checks pass: cargo fmt, clippy (zero warnings), doc, tests."
  notes:
    context: |
      AAT evidence confirmed that SpawnEpisode succeeds at the IPC layer — sessions are registered,
      tokens are minted, ledger events are emitted — but NO agent process is actually spawned. The
      daemon has three independently-built layers that aren't connected:

      Layer 1 (IPC + State): SpawnEpisode handler in dispatch.rs validates, registers, emits events.
      Layer 2 (Adapters): HarnessAdapter trait with RawAdapter and ClaudeCodeAdapter implementations
        that can spawn PTY-backed processes via PtyRunner::spawn().
      Layer 3 (Profiles): AgentAdapterProfileV1 with 4 builtin profiles defining how to launch
        each agent CLI (command, args, env, IO modes, tool bridge config).

      This ticket connects Layer 1 -> Layer 2, using Layer 3 as the configuration source.

      The AdapterRegistry (registry.rs) already supports loading profiles from CAS via with_profile()
      and selecting adapters. The gap is that handle_spawn_episode() never instantiates or calls it.

      After this ticket, the daemon will actually launch agent processes when episodes are spawned.
      The tool bridge (agent sending tool requests back to the kernel) is initially stubbed — the
      event stream is consumed but tool requests are logged rather than executed. Full tool mediation
      requires TCK-00401 (ToolBroker initialization).
    files: |
      - crates/apm2-daemon/src/state.rs (DaemonState construction at ~line 566, no AdapterRegistry created)
      - crates/apm2-daemon/src/protocol/dispatch.rs (handle_spawn_episode at ~4427, no adapter usage)
      - crates/apm2-daemon/src/episode/runtime.rs (start_with_workspace at ~1076, no process spawn)
      - crates/apm2-daemon/src/episode/registry.rs (AdapterRegistry with with_defaults and with_profile)
      - crates/apm2-daemon/src/episode/adapter.rs (HarnessAdapter trait, HarnessConfig, HarnessHandle)
      - crates/apm2-daemon/src/episode/raw_adapter.rs (RawAdapter::spawn_internal)
      - crates/apm2-daemon/src/episode/claude_code.rs (ClaudeCodeAdapter::spawn_internal)
      - crates/apm2-core/src/fac/agent_adapter_profile.rs (AgentAdapterProfileV1 at line 607)
      - crates/apm2-core/src/fac/builtin_profiles.rs (4 builtin profiles)
    security: |
      - Adapter profile MUST be loaded from CAS by hash (no ambient profile selection).
      - HarnessConfig must sanitize workspace_root (no path traversal above the workspace).
      - Environment variables from adapter profile must not override security-critical vars (PATH, LD_PRELOAD).
      - Agent process must run with minimal privileges (no setuid, no capability escalation).
      - Session token passed to agent must be the minted HMAC token, not a forgeable value.
      - Process termination must be guaranteed (SIGTERM + timeout + SIGKILL).
      - ROLLOUT WAIVER WVR-0002: session token propagation is temporarily env-only bootstrap;
        token TTL <= 300s, token MUST be redacted from logs/evidence, and argv transport is forbidden.

{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00385",
      "title": "Session termination signal: return terminal state and exit reason in SessionStatus",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0009",
      "rfc_id": "RFC-0018"
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_ORCHESTRATION"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00383",
          "reason": "Session dispatcher must be fully wired for session lifecycle events to be recorded."
        }
      ]
    },
    "scope": {
      "in_scope": [
        "Extend SessionStatusResponse to include terminal state information when session has ended.",
        "Add `termination_reason` field (normal, crash, timeout, quarantined, budget_exhausted).",
        "Add `exit_code` field for process exit status.",
        "Add `actual_tokens_consumed` field (if available from agent adapter).",
        "Preserve session state in registry after termination (don't delete immediately) with TTL.",
        "SessionStatus query for terminated session returns TERMINATED state with exit details."
      ],
      "out_of_scope": [
        "Process exit detection (handled by supervisor/episode runtime).",
        "Session reducer quarantine logic (already implemented in apm2-core).",
        "Coordinate command changes (separate ticket TCK-00386)."
      ]
    },
    "plan": {
      "steps": [
        "Add `TerminationInfo` struct with fields: reason, exit_code, terminated_at_ns, actual_tokens_consumed.",
        "Add `termination_info: Option<TerminationInfo>` to session registry entry.",
        "When a session process exits, the episode runtime should call `session_registry.mark_terminated(session_id, info)`.",
        "In SessionStatus handler, when `termination_info` is `Some`, return state=TERMINATED with the termination details.",
        "Add a TTL (e.g., 5 minutes) for terminated session entries to prevent unbounded growth.",
        "Add `SessionClient::session_status_with_termination()` method that returns the extended response.",
        "Add integration test: spawn session, simulate termination, query status, verify TERMINATED state with reason."
      ]
    },
    "definition_of_done": {
      "criteria": [
        "SessionStatus for an active session returns state=ACTIVE (no regression).",
        "SessionStatus for a terminated session returns state=TERMINATED with termination_reason and exit_code.",
        "Terminated session entries are preserved for at least 5 minutes after termination.",
        "SessionClient can distinguish ACTIVE from TERMINATED responses.",
        "No session entry leak -- terminated entries are cleaned up after TTL."
      ]
    },
    "notes": {
      "context": "The coordinate command (coordinate.rs lines 910-1017) currently determines\nsession termination by polling heartbeat events. When the daemon rejects a\nheartbeat (session not found), the coordinate command records FAILURE because\nthere is no way to distinguish a clean exit from a crash.\n\nThe code explicitly states (line 964):\n  \"FAIL-CLOSED: Without an explicit success signal from the daemon, we record\n   as Failure. Only a future daemon API providing a 'session completed\n   successfully' status query would justify recording Success here.\"\n\nThis ticket creates that \"explicit success signal\" by extending SessionStatus\nto return terminal state information. When the coordinate command (TCK-00386)\nqueries SessionStatus and gets TERMINATED + reason=normal + exit_code=0,\nit can confidently record Success.\n\nThe session registry currently deletes session entries when sessions end. We\nneed to preserve them (with TTL) so that SessionStatus queries after\ntermination still return useful information instead of \"session not found\".\n",
      "files": "- crates/apm2-daemon/src/protocol/session_dispatch.rs (SessionStatus handler, line ~1660)\n- crates/apm2-daemon/src/session/ (session registry, entry lifecycle)\n- crates/apm2-cli/src/client/protocol.rs (SessionClient, line ~1918)\n- crates/apm2-daemon/src/episode/mod.rs (episode runtime termination callbacks)\n",
      "security": "Session termination info must only be readable by the session's own token\nor via the operator socket. Do not leak termination details to other sessions.\nThe TTL prevents memory exhaustion from accumulated terminated entries.\n"
    }
  }
}

ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00405"
    title: "Harden PR merge gates against stale SHA and conflicting AI verdicts"
    status: "OPEN"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0018"
    requirements:
      - requirement_id: "REQ-HEF-0010"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0010.yaml#rfc_requirement"
    evidence_artifacts:
      - evidence_id: "EVID-HEF-0012"
        artifact_ref: "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0012.yaml#rfc_evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
      - "AGENT_REVIEWER"
    responsibility_domains:
      - "DOMAIN_SECURITY"
      - "DOMAIN_BUILD_RELEASE"
      - "DOMAIN_RUNTIME"
  dependencies:
    tickets: []
  scope:
    in_scope:
      - "Enforce merge gating on exact PR head SHA for both security and code-quality review artifacts."
      - "Fail gate when PASS/FAIL review artifacts conflict and the newest artifact is FAIL."
      - "Require trusted reviewer identity allowlist for AI-generated verdict artifacts."
      - "Require machine-readable review metadata (pr_number, head_sha, verdict, severity counts, reviewer_id) for gate evaluation."
      - "Block stale or cross-PR review artifacts (for example, review body references a different PR number or head SHA)."
      - "Add deterministic tests for gate evaluation over real-world conflicting review timelines."
    out_of_scope:
      - "Changing business logic of individual feature PRs."
      - "Backfilling or rewriting historical review comments."
      - "Replacing GitHub review UI workflows."
  plan:
    steps:
      - "Add a gate evaluator module/script that reads PR review artifacts and computes authoritative verdict per category (security, quality)."
      - "Define and enforce trusted reviewer identities in repo configuration (codeowners-style allowlist for AI reviewers)."
      - "Update CI/workflow to run gate evaluator on every pull_request synchronize/review event and publish a blocking status."
      - "Reject merge when review artifact head_sha != PR head SHA or when artifact references a different PR number."
      - "Reject merge when latest verdict in either category is FAIL, even if an older PASS exists."
      - "Add fixture-based tests covering the incident pattern from PRs #440, #442, #443, #444, #445, #448, #449, #453, #454."
      - "Document operator override path as explicit waiver-only flow (with ticket/waiver linkage)."
      - "Run cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings && cargo test --workspace."
  definition_of_done:
    evidence_ids:
      - "EVID-HEF-0012"
    criteria:
      - "Merge gate blocks stale-SHA review artifacts."
      - "Merge gate blocks conflicting PASS/FAIL artifacts when latest is FAIL."
      - "Merge gate rejects untrusted reviewer identities."
      - "CI exposes one authoritative pass/fail decision for security and one for code quality."
      - "Fixture tests reproduce and correctly fail the previously observed rogue-approval pattern."
      - "Workflow docs clearly state required artifact fields and trust model."
  notes:
    context: |
      Incident context: a rogue or inconsistent reviewer stream approved PRs that
      were later re-reviewed as FAIL for security and/or quality. A root cause was
      weak merge gating over contradictory artifacts, stale SHAs, and cross-PR
      attribution drift.

      This ticket introduces strict head pinning and deterministic conflict
      resolution so merges cannot proceed on non-authoritative PASS artifacts.
    files: |
      - .github/workflows/ci.yml
      - xtask/src/tasks/review.rs
      - xtask/src/tasks/push.rs
      - scripts/review/verify_pr_gate.sh
      - documents/reviews/CODE_QUALITY_PROMPT.md
      - documents/reviews/SECURITY_REVIEW_PROMPT.md
    security: |
      - Gate evaluation must fail closed on parse errors or missing artifacts.
      - Reviewer identity allowlist is authoritative and repo-controlled.
      - Head SHA and PR number checks are mandatory for every verdict artifact.


{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00628",
      "title": "Implement fresh-worktree conformance suite: zero-touch, offline, and warm-path scenarios",
      "status": "OPEN"
    },
    "binds": {
      "prd_id": "PRD-PLACEHOLDER",
      "rfc_id": "RFC-0019",
      "requirements": [
        "REQ-0039"
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_CI"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00622",
          "reason": "Network isolation in EXECUTE is required for Scenario B and C."
        },
        {
          "ticket_id": "TCK-00623",
          "reason": "Closure pre-seeding for Scenario B requires GateSupplyClosureV1."
        },
        {
          "ticket_id": "TCK-00624",
          "reason": "PREP_SUPPLY_UNAVAILABLE failure code required for Scenario C assertion."
        },
        {
          "ticket_id": "TCK-00625",
          "reason": "JSONL event stream required to assert scenario outcomes."
        },
        {
          "ticket_id": "TCK-00626",
          "reason": "cache_decision in gate_finished required to assert Scenario D cache hits."
        },
        {
          "ticket_id": "TCK-00627",
          "reason": "is_warm_run field in run_summary required to assert Scenario D SLO."
        }
      ]
    }
  },
  "root_cause_analysis": {
    "summary": "The usability guarantees established in REQ-0031 through REQ-0038 have no\nformal automated test coverage that exercises the complete end-to-end paths.\nWithout a conformance suite, regressions in zero-touch bootstrap, offline\noperation, failure normalization, or warm-path performance can ship silently.\nThe four conformance scenarios are the machine-verifiable evidence that all\nusability requirements are met simultaneously.\n"
  },
  "scope": {
    "in_scope": [
      {
        "id": "S1_SCENARIO_A",
        "title": "Scenario A: zero-touch fresh worktree with network available",
        "detail": "Test setup:\n  - Create a temp dir as APM2_HOME (empty)\n  - Provide a valid FAC config pointing to a test repo\n  - Network available\nTest action: run `apm2 fac push --json` (gates executes as a phase)\nAssertions:\n  - exit code 0\n  - prep_autofix events emitted (ReadinessController auto-healed)\n  - all gates run (gate_count > 0)\n  - run_summary.phase_failed is null\n"
      },
      {
        "id": "S2_SCENARIO_B",
        "title": "Scenario B: offline run with pre-seeded closure",
        "detail": "Test setup:\n  - Pre-populated APM2_HOME with valid substrate and signed closure\n  - Network denied for EXECUTE (via test fixture)\nTest action: run `apm2 fac push --json` (gates phase runs within push)\nAssertions:\n  - exit code 0\n  - execute_started event includes network_policy confirming denial\n  - all gates run using pre-seeded closure entries\n  - run_summary.phase_failed is null\n"
      },
      {
        "id": "S3_SCENARIO_C",
        "title": "Scenario C: offline run without closure",
        "detail": "Test setup:\n  - Pre-populated APM2_HOME substrate but no closure artifact\n  - Network denied (both PREP and EXECUTE)\nTest action: run `apm2 fac push --json` (gates phase runs within push)\nAssertions:\n  - exit code non-zero\n  - run_failed event emitted with failure_code=PREP_SUPPLY_UNAVAILABLE\n  - no gate_started events emitted (zero gates ran)\n  - remediation field is non-empty and actionable\n"
      },
      {
        "id": "S4_SCENARIO_D",
        "title": "Scenario D: warm-path run (identical second execution)",
        "detail": "Test setup:\n  - run1: completed successfully, cache populated\nTest action: run `apm2 fac push --json` again (same SHA, same closure)\nAssertions:\n  - exit code 0\n  - run_summary.is_warm_run = true\n  - run_summary.cache_hit_count == gate_count\n  - run_summary.total_duration_ms <= run1.total_duration_ms * 0.20\n"
      },
      {
        "id": "S5_CI_GATE",
        "title": "Register all four scenarios as promotion-blocking CI tests",
        "detail": "Add all four scenarios to the CI test suite in a dedicated\nconformance test module. Mark them as blocking for RFC-0019\npromotion gate. They must pass before any RFC-0019 quality gate\ncan be closed.\n"
      }
    ],
    "out_of_scope": [
      "Testing individual component behaviors (each is covered by its own ticket's tests).",
      "Performance benchmarking beyond Scenario D's SLO assertion.",
      "macOS or Windows conformance (Linux only for now)."
    ]
  },
  "plan": {
    "steps": [
      {
        "id": "STEP_01",
        "title": "Create conformance test module and fixture helpers",
        "detail": "New test module: tests/fac_gates_conformance.rs (or similar).\nHelpers: temp_apm2_home(), pre_seeded_closure_fixture(), deny_network_fixture().\nEach helper is reusable across scenarios.\n"
      },
      {
        "id": "STEP_02",
        "title": "Implement Scenario A (zero-touch fresh worktree)",
        "detail": "Use temp_apm2_home(). Run gates. Parse JSONL. Assert exit 0,\nprep_autofix events, gate count > 0, phase_failed null.\n"
      },
      {
        "id": "STEP_03",
        "title": "Implement Scenario B (offline with pre-seeded closure)",
        "detail": "Use pre_seeded_closure_fixture() + deny_network_fixture() for EXECUTE.\nRun gates. Assert exit 0, network_policy in execute_started, phase_failed null.\n"
      },
      {
        "id": "STEP_04",
        "title": "Implement Scenario C (offline without closure)",
        "detail": "Use APM2_HOME with substrate but no closure. deny_network_fixture().\nRun gates. Assert exit non-zero, run_failed with PREP_SUPPLY_UNAVAILABLE,\nno gate_started events.\n"
      },
      {
        "id": "STEP_05",
        "title": "Implement Scenario D (warm-path run)",
        "detail": "Run gates twice. Capture run_summary from both. Assert is_warm_run=true,\ncache_hit_count == gate_count, duration SLO met.\n"
      },
      {
        "id": "STEP_06",
        "title": "Register scenarios as promotion-blocking and run workspace validation",
        "detail": "Add #[cfg(feature = \"conformance\")] or CI-only test gate annotation.\ncargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings\ncargo doc --workspace --no-deps && cargo test --workspace\n"
      }
    ]
  },
  "definition_of_done": {
    "evidence_ids": [
      "EXEC-TCK00628-SCENARIO-A",
      "EXEC-TCK00628-SCENARIO-B",
      "EXEC-TCK00628-SCENARIO-C",
      "EXEC-TCK00628-SCENARIO-D",
      "EXEC-TCK00628-CI-GATE",
      "EXEC-TCK00628-WORKSPACE-VALIDATION"
    ],
    "criteria": [
      "Scenario A: empty APM2_HOME + network => auto-heal + all gates pass.",
      "Scenario B: pre-seeded closure + network denied in EXECUTE => success.",
      "Scenario C: no closure + network denied => exactly PREP_SUPPLY_UNAVAILABLE, zero gates run.",
      "Scenario D: second identical run => is_warm_run=true, all cache hits, duration within SLO.",
      "All four scenarios are automated CI tests.",
      "All four scenarios are registered as promotion-blocking for RFC-0019.",
      "Workspace validation completes successfully."
    ]
  },
  "notes": {
    "context": "This is the final ticket in the REQ-0031..REQ-0039 cluster and depends on\nall preceding tickets. It is purely a test-authoring ticket: no new\nproduction code is written here. All four scenarios exercise production\ncode paths through their public command interfaces. The conformance suite\nis the official evidence artifact for the RFC-0019 quality gate closure\ncovering the usability cluster.\n",
    "security": "conformance tests use isolated temp dirs; no real credentials or keys"
  },
  "fac_security_contract": {
    "source": "documents/work/tickets/FAC_SECURITY_MODEL_INVARIANTS_V1.yaml",
    "profile": "FAC-RFC0032-BASELINE",
    "required_invariants": [
      "INV-FAC-TRUTH-001",
      "INV-FAC-WORK-BIND-001",
      "INV-FAC-CLAIM-BIND-001",
      "INV-FAC-ACTOR-BIND-001",
      "INV-FAC-IDEMP-001",
      "INV-FAC-EVID-001"
    ],
    "enforcement_requirements": [
      "Any new requirement, code path, or test added under this ticket must map to one or more required_invariants.",
      "Any invariant relaxation requires explicit amendment in this ticket and the shared security model document.",
      "Reviewer denial is expected for invariant-unmapped behavior changes."
    ]
  }
}

ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00624"
    title: "FAC doctor/review state machine unification with machine-verifiable CAC contract"
    status: "MERGED"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: ["REQ-0035"]
    evidence_artifacts:
      - "documents/reviews/fac_review_state_machine.cac.json"
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME", "DOMAIN_CI"]
  dependencies:
    tickets: []

root_cause_analysis:
  summary: |
    FAC doctor recommendation logic and wait-loop behavior accumulated into
    scattered conditional branches, which made correctness hard to prove and
    regressions easy to introduce. The resulting bugs included recommending
    reviewer restarts while evidence gates were still running, and delayed
    wait-loop exits for terminal recommended actions.

    This ticket reframes the entire flow as explicit state machines with ordered
    transition tables, guard predicates, and machine-readable requirement
    traceability so behavior is deterministic, auditable, and easy to evolve.

scope:
  in_scope:
    - id: "DR-001-GATE_FAILURE_REQUIRES_IMPLEMENTOR"
      title: "Blocking review conditions recommend dispatch_implementor"
      detail: |
        Doctor decision states that represent blocking remediation must resolve
        to `dispatch_implementor`:
          - merge conflicts,
          - terminal evidence gate failures,
          - actionable findings requiring implementor remediation.
        Recommendation command templates must direct to findings context.

    - id: "DR-002-RUNNING_GATE_SUPPRESSES_RESTART"
      title: "In-flight gate progress suppresses reviewer restarts"
      detail: |
        Gate progress derivation must classify RUNNING / NOT_RUN gates as
        `in_flight`, and doctor recommendation must return `wait` (not
        `restart_reviews`) when verdicts are pending and gate progress remains
        in-flight.

    - id: "DR-003-TERMINAL_PASS_REQUIRED_FOR_MERGE_READY"
      title: "Merge readiness requires terminal passed gates"
      detail: |
        Merge and approve outcomes must only be reachable when merge-readiness
        facts are satisfied, including terminal passed gate progress and no
        merge conflicts.

    - id: "DR-004-DOCTOR_RULE_ORDER_IS_STRICT"
      title: "Decision/gate/recommendation rules are table-driven and ordered"
      detail: |
        Doctor decision, gate progress, and recommendation logic must be derived
        from explicit rule tables with unique IDs and strictly increasing
        priority. Evaluation semantics are first-match in priority order.

    - id: "DR-005-WAIT_RETURNS_ON_TERMINAL_ACTION"
      title: "Wait loop is an explicit state machine with terminal action exit"
      detail: |
        `--wait-for-recommended-action` must evaluate transitions through a
        dedicated wait-state machine. Terminal recommended actions (including
        `dispatch_implementor`) must exit immediately by priority, ahead of
        interrupt/timeout fallback checks.

    - id: "DR-006-EVERGREEN_CAC_STATE_MACHINE_SOURCE"
      title: "Single evergreen CAC machine-spec artifact"
      detail: |
        FAC review machine spec must be published as a canonical evergreen CAC
        document at `documents/reviews/fac_review_state_machine.cac.json` and
        referenced in code as the snapshot/source contract for machine-spec
        output verification.

    - id: "DR-007-CLI_EXIT_ON_ACTION_SET_IS_CANONICAL"
      title: "--exit-on actions derive from action policy table"
      detail: |
        Supported/default `--exit-on` actions must derive from a single
        `DoctorActionPolicy` table. CLI enum choices and fac_review-supported
        actions must remain aligned via regression test.

    - id: "DR-008-MACHINE_VERIFIABLE_ARTIFACTS"
      title: "Emit reviewer-grade transition and traceability artifacts"
      detail: |
        Produce machine-verifiable outputs that enumerate states, transitions,
        guards, action policy, and requirement-to-test mapping:
          - canonical CAC machine spec JSON,
          - embedded machine_traceability section with indexes, coverage, and
            integrity checks.

  out_of_scope:
    - "Legacy ad-hoc branching paths outside FAC doctor/review scope."
    - "Non-FAC command state-machine redesign."
    - "Backwards-compatibility shims for superseded machine-spec file paths."

plan:
  steps:
    - id: "STEP_01"
      title: "Model FAC doctor, gate progress, wait loop, and lifecycle as explicit machines"
      detail: |
        Encode states, guards, priorities, and transitions as static rule tables.

    - id: "STEP_02"
      title: "Unify recommendation semantics under rule + action-policy tables"
      detail: |
        Ensure recommendation action, priority, reason, and command templates are
        derived from a single table; derive wait `--exit-on` behavior from action policy.

    - id: "STEP_03"
      title: "Publish CAC machine spec and migrate snapshot checks"
      detail: |
        Wrap machine bundle in CAC envelope, publish evergreen JSON, and point
        code snapshot validation to the canonical file.

    - id: "STEP_04"
      title: "Populate machine-traceability section inside CAC spec"
      detail: |
        Embed compact indexes, requirement coverage, decision/recommendation
        matrix, and integrity checks directly in the canonical CAC JSON.

    - id: "STEP_05"
      title: "Regression and workspace validation"
      detail: |
        cargo fmt --all
        cargo clippy --workspace --all-targets --all-features -- -D warnings
        cargo doc --workspace --no-deps
        cargo test --workspace

definition_of_done:
  evidence_ids:
    - "EXEC-TCK00624-STATE-MACHINE-CUTOVER"
    - "EXEC-TCK00624-EVERGREEN-CAC-SPEC"
    - "EXEC-TCK00624-WORKSPACE-VALIDATION"
  criteria:
    - "Doctor, gate progress, wait loop, and lifecycle transitions are represented as explicit rule/state tables."
    - "Running gates no longer permit restart recommendation; doctor returns wait in the in-flight case."
    - "Blocking conditions (merge conflict/gate failure/actionable findings) recommend dispatch_implementor."
    - "--wait-for-recommended-action exits immediately on terminal recommended actions, including dispatch_implementor."
    - "Supported/default --exit-on actions derive from DoctorActionPolicy and are CLI-aligned via test."
    - "Machine spec is published as a single evergreen CAC JSON document with no TCK path coupling."
    - "CAC machine_traceability section enumerates guards, states, transitions, and requirement/test links."
    - "Workspace validation completes successfully."

notes:
  context: |
    This ticket supersedes the prior if-branch-centric framing for FAC doctor
    behavior with state-machine-first semantics. The implementation is designed
    so recommendation logic remains evolvable by table edits rather than control
    flow rewrites.
  security: "fail-closed transition semantics; undefined paths resolve through explicit default guards"

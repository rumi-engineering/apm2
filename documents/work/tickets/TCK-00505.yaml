ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00505"
    title: "Wire economics admission gate into projection worker pre-projection path"
    status: "OPEN"
  binds:
    prd_id: "PRD-0010"
    rfc_id: "RFC-0029"
    requirements:
      - requirement_id: "REQ-0009"
        requirement_ref: "documents/rfcs/RFC-0029/requirements/REQ-0009.yaml#requirement"
      - requirement_id: "REQ-0006"
        requirement_ref: "documents/rfcs/RFC-0029/requirements/REQ-0006.yaml#requirement"
    evidence_artifacts:
      - evidence_id: "EVID-0009"
        artifact_ref: "documents/rfcs/RFC-0029/evidence_artifacts/EVID-0009.yaml#evidence_artifact"
      - evidence_id: "EVID-0006"
        artifact_ref: "documents/rfcs/RFC-0029/evidence_artifacts/EVID-0006.yaml#evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
      - "AGENT_REVIEWER"
      - "AGENT_QA"
    responsibility_domains:
      - "DOMAIN_RELIABILITY"
      - "DOMAIN_SECURITY"
      - "DOMAIN_RUNTIME"
  dependencies:
    tickets:
      - ticket_id: "TCK-00504"
        reason: "Intent buffer schema must exist before the worker can record admit/deny decisions."
      - ticket_id: "TCK-00506"
        reason: "Receipt format bridge needed to produce economics-compatible projection receipts."
      - ticket_id: "TCK-00507"
        reason: "Continuity profile resolution needed to assemble gate inputs."
  scope:
    in_scope:
      - "Insert a call to evaluate_projection_continuity() in ProjectionWorker::handle_review_receipt() before adapter.project_status()."
      - "Assemble gate inputs from the ReviewReceiptRecorded event payload: extract eval_tick, time_authority_ref, window_ref, boundary_id."
      - "On ALLOW verdict: call adapter.project_status() and record admitted intent in IntentBuffer."
      - "On DENY verdict: record denied intent in IntentBuffer with structured deny reason, skip projection, log verdict."
      - "Fail closed if gate inputs cannot be assembled (missing temporal authority, missing profile, missing snapshot)."
      - "Fail closed if economics selectors are absent — ALL events must carry selectors (no bypass path)."
      - "Fail closed if economics gate is not initialized — DENY with durable recording before ACK."
      - "Emit structured telemetry for admit/deny counts per sink, including lifecycle-denial subcategories (revoked, stale, consumed, missing_gate, missing_economics_selectors)."
    out_of_scope:
      - "Canonical PCAC lifecycle integration (join, revalidate, consume primitives) is deferred to a future ticket. Current implementation provides economics-gated admission with idempotent-insert replay prevention."
      - "Deferred replay logic for buffered intents after outage recovery (see TCK-00508)."
      - "Multi-sink dispatch routing (single GitHub sink for now)."
      - "Economics gate logic changes — this ticket only calls existing gates."
  plan:
    steps:
      - "Add apm2-core economics dependency to apm2-daemon Cargo.toml if not already present."
      - "In handle_review_receipt(), after PR metadata lookup and before adapter.project_status(), build ContinuityCheckInputs."
      - "Load continuity profile and sink snapshot via profile resolver (TCK-00507 dependency)."
      - "Call evaluate_projection_continuity() with assembled inputs."
      - "On ALLOW: call adapter.project_status() and record admitted intent in IntentBuffer."
      - "On DENY (economics gate or missing selectors or missing gate): record deny durably in IntentBuffer + skip projection."
      - "Add structured log lines (tracing) for both paths with verdict details."
      - "Write integration-style tests using mock adapter and mock profile resolver."
  definition_of_done:
    evidence_ids:
      - "EVID-0009"
      - "EVID-0006"
    criteria:
      - "No projection occurs without passing the economics admission gate."
      - "Events without economics selectors are DENIED (fail-closed: no bypass path)."
      - "Missing gate inputs (temporal authority, profile, snapshot) result in DENY, not default ALLOW."
      - "Gate init failure DENIES all events with durable recording before ACK."
      - "Already-projected intents (same work_id + changeset_digest) result in DENY via idempotent-insert replay prevention."
      - "Denied projections are logged with structured deny reason (including denial subcategory) and durably recorded in intent buffer before ACK."
      - "Existing projection behavior is preserved when the economics gate returns ALLOW."
  notes:
    security: |
      This is the critical wiring point. The gate MUST be fail-closed: if any input
      assembly step fails (missing field, deserialization error, profile not found),
      the default MUST be DENY. Never skip the gate — every projection path must
      pass through it.

      ALL events must carry economics selectors; absence results in DENY with
      durable recording (no bypass path). Gate init failure DENIES all events
      with durable recording before ACK. If the IntentBuffer is unavailable,
      the event is NOT acknowledged (returned as non-ACK error for retry).

      Canonical PCAC lifecycle integration (join, revalidate, consume primitives)
      is deferred to a future ticket. Current implementation provides
      economics-gated admission with idempotent-insert replay prevention.
    verification: |
      Include tests for: (1) normal ALLOW path preserves existing behavior,
      (2) DENY path skips projection, (3) missing temporal authority -> DENY,
      (4) missing profile -> DENY, (5) gate error -> DENY,
      (6) revoked authority (zero hash) -> DENY,
      (7) stale authority (zero window_ref) -> DENY,
      (8) already-consumed intent -> DENY (replay prevention),
      (9) missing economics selectors -> DENY (no bypass path),
      (10) missing gate with durable deny recording before ACK.
    general: |
      This is the highest-value integration ticket — it turns the economics gates
      from inert validation code into an active admission barrier on the production
      projection path.

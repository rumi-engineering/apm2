{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00157",
      "title": "Implement UDS protocol server with length-prefixed framing",
      "status": "CLOSED"
    },
    "binds": {
      "rfc_id": "RFC-0013",
      "requirements": [
        {
          "requirement_id": "REQ-PROTOCOL-001"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00156"
      }
    ]
  },
  "acceptance_criteria": [
    {
      "criterion": "UDS server listens on XDG_RUNTIME_DIR/apm2/apm2d.sock",
      "verification": "Integration test connects to socket successfully"
    },
    {
      "criterion": "Length-prefixed binary framing with max 16MB frames",
      "verification": "Unit test verifies frame encoding/decoding"
    },
    {
      "criterion": "Protocol version negotiation in handshake",
      "verification": "Unit test verifies version mismatch handling"
    }
  ],
  "implementation": {
    "code_examples": [
      {
        "description": "Frame encoding structure",
        "code": "pub struct Frame {\n    pub length: u32,  // 4-byte big-endian\n    pub payload: Bytes,\n}\n\nimpl Frame {\n    pub const MAX_SIZE: usize = 16 * 1024 * 1024; // 16MB\n\n    pub fn encode(&self, buf: &mut BytesMut) {\n        buf.put_u32(self.payload.len() as u32);\n        buf.extend_from_slice(&self.payload);\n    }\n}\n"
      }
    ],
    "files_to_create": [
      {
        "path": "crates/apm2-daemon/src/protocol/framing.rs",
        "purpose": "Length-prefixed frame codec"
      },
      {
        "path": "crates/apm2-daemon/src/protocol/server.rs",
        "purpose": "UDS server accepting connections"
      },
      {
        "path": "crates/apm2-daemon/src/protocol/handshake.rs",
        "purpose": "Protocol version negotiation"
      },
      {
        "path": "crates/apm2-daemon/src/protocol/error.rs",
        "purpose": "Protocol error types"
      }
    ],
    "files_to_modify": [
      {
        "changes": "Export framing, server, handshake modules",
        "path": "crates/apm2-daemon/src/protocol/mod.rs"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Implement Frame codec",
        "details": "Create tokio_util::codec::Decoder and Encoder implementations for\nlength-prefixed framing. Max frame size 16MB. Reject oversized frames\nwith FrameTooLarge error.\n"
      },
      {
        "step": 2,
        "action": "Implement UDS server",
        "details": "Create ProtocolServer struct that:\n- Binds to ${XDG_RUNTIME_DIR}/apm2/apm2d.sock\n- Creates directory if needed\n- Accepts connections with tokio::net::UnixListener\n- Spawns connection handler tasks\n"
      },
      {
        "step": 3,
        "action": "Implement handshake protocol",
        "details": "Hello/HelloAck exchange:\n- Client sends Hello with protocol_version, client_info\n- Server validates version compatibility\n- Server sends HelloAck with server_info, policy_hash\n- Version mismatch returns error, closes connection\n"
      },
      {
        "step": 4,
        "action": "Create error types",
        "details": "ProtocolError enum with variants:\n- FrameTooLarge, InvalidFrame, VersionMismatch,\n- HandshakeFailed, ConnectionClosed, Io(io::Error)\n"
      }
    ],
    "summary": "Implement UDS protocol server with length-prefixed framing per AD-DAEMON-002.\nServer listens on XDG_RUNTIME_DIR/apm2/apm2d.sock with binary framing\nand protocol version negotiation.\n"
  },
  "notes": "Phase: PHASE-1A (Protocol Foundation)\nGenerated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.\nMaps to TCK-PEND-001.\n",
  "test_requirements": [
    {
      "description": "Frame encoding round-trip",
      "test_id": "UT-00157-01",
      "verification_command": "cargo test -p apm2-daemon framing"
    },
    {
      "description": "Server accepts connection",
      "test_id": "IT-00157-01",
      "verification_command": "cargo test -p apm2-daemon --test integration server_accept"
    }
  ]
}

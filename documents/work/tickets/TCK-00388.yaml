ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00388"
    title: "Gate execution orchestrator: autonomous gate lifecycle after session termination"
    status: "OPEN"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0018"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
      - "DOMAIN_ORCHESTRATION"
  dependencies:
    tickets:
      - ticket_id: "TCK-00383"
        reason: "CAS and broker wiring must be operational for gate lease emission and receipt storage."
  scope:
    in_scope:
      - "Implement GateOrchestrator module in daemon that watches for session_terminated ledger events."
      - "For each terminated session with associated work, resolve policy via PolicyResolvedForChangeSet."
      - "Issue GateLeaseIssued events for each required gate (aat, quality, security)."
      - "Spawn gate executor episodes using agent adapter profiles from builtin_profiles."
      - "Collect GateReceipt results from gate executors and emit to ledger."
      - "Implement gate timeout with fail-closed semantics (expired leases block merge)."
      - "Wire GateOrchestrator into daemon main loop as a background task."
    out_of_scope:
      - "Gate execution business logic (quality/security review prompts are reviewer concerns)."
      - "xtask cutover from external Gemini spawning (TCK-00324, separate concern)."
      - "Merge automation after gate approval (TCK-00390)."
      - "Review receipt ingestion endpoint (TCK-00389)."
  plan:
    steps:
      - "Create GateOrchestrator struct in crates/apm2-daemon/src/gate/ with ledger tailer for session_terminated events."
      - "On session_terminated: look up associated work_id and changeset_digest from session state."
      - "Resolve policy for the changeset using PolicyResolvedForChangeSetBuilder, emit PolicyResolvedForChangeSet event."
      - "For each gate type (aat, quality, security): build GateLease via GateLeaseBuilder, sign with daemon signer, emit GateLeaseIssued event."
      - "Spawn bounded execution episodes via EpisodeRuntime for each gate, using appropriate agent adapter profile."
      - "Monitor spawned episodes for completion or timeout; collect GateReceipt or AatGateReceipt results."
      - "Emit gate_receipt events to ledger for each completed gate."
      - "On gate timeout: emit GateReceipt with FAIL verdict and close the lease (fail-closed)."
      - "Add integration test: terminate a session, verify GateOrchestrator emits policy resolution, leases, and receipts."
  definition_of_done:
    criteria:
      - "Session termination with associated work triggers autonomous gate lifecycle."
      - "PolicyResolvedForChangeSet event is emitted before any GateLeaseIssued event (ordering invariant)."
      - "GateLeaseIssued events are emitted for aat, quality, and security gate types."
      - "Gate executor episodes are spawned using EpisodeRuntime with correct agent adapter profiles."
      - "GateReceipt events are emitted to ledger upon gate completion."
      - "Gate timeout produces fail-closed FAIL verdict, not silent expiry."
      - "All gate leases use domain-separated Ed25519 signatures (GATE_LEASE_ISSUED: prefix)."
      - "Integration test validates full gate lifecycle from session_terminated to gate_receipt."
  notes:
    context: |
      The FAC state machine requires: session_terminated -> RUN_GATES -> gate_receipt -> AWAIT_REVIEW.
      Currently, gates are spawned by xtask as external Gemini CLI processes (xtask/src/tasks/push.rs
      line 243+), which creates PENDING GitHub status checks and spawns background Gemini processes
      outside the FAC pipeline. This means gate execution is not tracked in the ledger, leases are
      not issued, and receipts are not cryptographically bound.

      The core FAC types already exist:
      - GateLease with domain-separated Ed25519 signatures (GATE_LEASE_ISSUED: prefix)
      - GateReceipt versioned envelope for recording gate outcomes
      - AatGateReceipt for AAT-specific gate results
      - PolicyResolvedForChangeSet as the anchor event that must precede all lease issuance
      - Agent adapter profiles (Claude Code, Gemini CLI, Codex CLI) for spawning gate executors

      The episode runtime (EpisodeRuntime in crates/apm2-daemon/src/episode/mod.rs) already supports
      spawning bounded execution episodes with lifecycle management (CREATED -> RUNNING -> TERMINATED).
      The session module (crates/apm2-daemon/src/session/consume.rs) already handles SessionTerminated
      events. The gap is that no daemon component watches for session termination and orchestrates
      the gate lifecycle in response.

      The GateOrchestrator must enforce the PolicyResolvedForChangeSet ordering invariant: a policy
      resolution MUST exist before any GateLeaseIssued event for the same work_id/changeset. This
      is critical for security - it prevents policy downgrade attacks where gates run under a
      weaker policy than intended.
    files: |
      - crates/apm2-core/src/fac/lease.rs (GateLease, GateLeaseBuilder with Ed25519 domain-separated signatures)
      - crates/apm2-core/src/fac/receipt.rs (GateReceipt versioned envelope)
      - crates/apm2-core/src/fac/aat_receipt.rs (AatGateReceipt for AAT gate results)
      - crates/apm2-core/src/fac/policy_resolution.rs (PolicyResolvedForChangeSet anchor event)
      - crates/apm2-core/src/fac/builtin_profiles.rs (agent adapter profiles: Claude Code, Gemini CLI, Codex CLI)
      - crates/apm2-daemon/src/episode/mod.rs (EpisodeRuntime for spawning bounded execution episodes)
      - crates/apm2-daemon/src/session/consume.rs (SessionTerminated event handling)
      - crates/apm2-daemon/src/episode/broker.rs (episode broker dispatches session_terminated)
      - xtask/src/tasks/push.rs (current external gate spawning at line 243+, to be superseded)
    security: |
      Gate leases MUST use domain-separated Ed25519 signatures to prevent cross-domain replay.
      The PolicyResolvedForChangeSet ordering invariant is security-critical: violating it allows
      policy downgrade attacks. Gate timeout MUST be fail-closed (expired gate = FAIL verdict),
      not fail-open (expired gate = implicit PASS). The GateOrchestrator must validate that the
      changeset_digest in each lease matches the actual changeset from the terminated session,
      preventing substitution attacks. All gate receipts must be signed by the executor bound
      in the lease - receipt from a different executor must be rejected.

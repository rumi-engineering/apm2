acceptance_criteria:
  - criterion: Ed25519 signing of receipt canonical bytes
    verification: Signed receipts verify successfully
  - criterion: Verification predicate implementation
    verification: Tampered receipts fail verification
  - criterion: Signing key management in OS keychain
    verification: Keys stored/retrieved from keychain
implementation:
  code_examples:
    - description: Receipt signing
      code: |
        pub struct ReceiptSigner {
            signing_key: SigningKey,
            key_id: KeyId,
            key_version: u32,
        }

        impl ReceiptSigner {
            pub fn sign(&self, receipt: &mut Receipt) -> Result<()> {
                let unsigned_bytes = receipt.unsigned_bytes();
                let signature = self.signing_key.sign(&unsigned_bytes);
                receipt.signature = Some(signature);
                receipt.signer_identity = Some(SignerIdentity {
                    key_id: self.key_id.clone(),
                    key_version: self.key_version,
                });
                Ok(())
            }
        }

        pub fn verify_receipt(receipt: &Receipt, public_key: &PublicKey) -> Result<bool> {
            let unsigned_bytes = receipt.unsigned_bytes();
            let signature = receipt.signature.as_ref()?;
            Ok(public_key.verify(&unsigned_bytes, signature).is_ok())
        }
  files_to_create:
    - path: crates/apm2-daemon/src/evidence/signer.rs
      purpose: ReceiptSigner and signing logic
    - path: crates/apm2-daemon/src/evidence/verifier.rs
      purpose: Receipt verification predicate
    - path: crates/apm2-daemon/src/evidence/keychain.rs
      purpose: OS keychain integration for key storage
  files_to_modify:
    - changes: Export signer, verifier, keychain modules
      path: crates/apm2-daemon/src/evidence/mod.rs
  implementation_steps:
    - step: 1
      action: Implement ReceiptSigner
      details: |
        Create signer using ed25519-dalek:
        - Load signing key from keychain
        - Sign unsigned_bytes
        - Attach signature and identity to receipt
    - step: 2
      action: Implement verification predicate
      details: |
        Implement doctrine predicate per AD-RECEIPT-001:
        - VerifyReceipt(receipt): signature valid
        - EvidenceSatisfies(contract, evidence): refs exist
        - DigestBindingsHold(output, evidence): hashes match
    - step: 3
      action: Implement keychain integration
      details: |
        Use Secret Service API (Linux) or Keychain (macOS):
        - store_key(key_id, signing_key)
        - load_key(key_id) -> SigningKey
        - delete_key(key_id)
        - list_keys() -> Vec<KeyId>
    - step: 4
      action: Implement key lifecycle
      details: |
        Per AD-KEY-001:
        - Key generation with version tracking
        - 90-day rotation schedule
        - Old keys preserved for verification (1 year)
        - Compromise recovery: revoke and rotate
    - step: 5
      action: Create verification tests
      details: |
        Test cases:
        - Valid signature verifies
        - Tampered payload fails
        - Wrong key fails
        - Expired key handling
  summary: |
    Implement receipt signing and verification per AD-RECEIPT-001 and AD-KEY-001.
    Uses Ed25519 signatures with keys stored in OS keychain.
    Includes verification predicate implementation per doctrine.
notes: |
  Phase: PHASE-2B (Tool Execution and Receipts)
  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.
  Maps to TCK-PEND-010.
schema_version: "2026-01-27"
template_version: "2026-01-27"
test_requirements:
  - description: Sign and verify round-trip
    test_id: UT-00167-01
    verification_command: cargo test -p apm2-daemon sign_verify
  - description: Tampered receipt rejection
    test_id: UT-00167-02
    verification_command: cargo test -p apm2-daemon tampered_receipt
  - description: Keychain integration
    test_id: IT-00167-01
    verification_command: cargo test -p apm2-daemon --test integration keychain
ticket:
  depends_on:
    - TCK-00166
  id: TCK-00167
  requirement_ids:
    - REQ-RECEIPT-001
  rfc_id: RFC-0013
  status: READY
  title: Implement receipt signing and verification

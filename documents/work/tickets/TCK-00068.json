{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-25",
    "template_version": "2026-01-25",
    "ticket": {
      "id": "TCK-00068",
      "title": "Add Shell Command Safety Utility"
    },
    "binds": {
      "prd_id": "NONE",
      "rfc_id": "RFC-0006",
      "requirements": [
        {
          "requirement_id": "MAINT-015",
          "requirement_ref": "documents/rfcs/RFC-0006/01_problem_and_imports.yaml#rfc_local_requirements.requirements[9]"
        }
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_BUILD_RELEASE",
        "DOMAIN_SECURITY"
      ]
    },
    "dependencies": {
      "tickets": []
    },
    "scope": {
      "in_scope": [
        "Create xtask/src/shell_escape.rs utility module",
        "Implement quote_path() function using shell-escape crate or safe quoting",
        "Implement build_script_command() helper for PTY-wrapped commands",
        "Update xtask/src/tasks/push.rs to use new utilities",
        "Update xtask/src/tasks/review.rs to use new utilities",
        "Update xtask/src/tasks/check.rs to use new utilities",
        "Add unit tests for edge cases: paths with quotes, spaces, backticks, newlines",
        "Add shell-escape dependency to xtask/Cargo.toml if needed"
      ],
      "out_of_scope": [
        "Changes to AI reviewer prompt content",
        "Changes to GitHub API interactions",
        "Refactoring spawn logic (covered by TCK-00069)",
        "Cross-platform support (covered by TCK-00070)"
      ]
    },
    "plan": {
      "steps": [
        "Add shell-escape = \"0.2\" to xtask/Cargo.toml dependencies",
        "Create xtask/src/shell_escape.rs with module structure",
        "Implement quote_path(path: &Path) -> String function that safely quotes paths for shell",
        "Implement build_script_command(prompt_path: &Path, log_path: Option<&Path>) -> String helper",
        "Add comprehensive unit tests for quote_path() covering: spaces, single quotes, double quotes, backticks, newlines, dollar signs",
        "Add pub mod shell_escape; to xtask/src/main.rs",
        "Update push.rs to use quote_path() for all path formatting in shell commands",
        "Update review.rs to use quote_path() for all path formatting in shell commands",
        "Update check.rs to use quote_path() for all path formatting in shell commands",
        "Search codebase for format!() calls constructing shell commands and migrate to quote_path()",
        "Verify no raw path interpolation remains in shell command strings",
        "Verify cargo build succeeds",
        "Verify cargo test passes",
        "Verify cargo clippy passes with no warnings"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [],
      "criteria": [
        "xtask/src/shell_escape.rs exists with quote_path() and build_script_command() functions",
        "quote_path() safely escapes paths containing: spaces, single quotes, double quotes, backticks, newlines, dollar signs",
        "build_script_command() produces valid script command format for PTY-wrapped execution",
        "No raw format!() shell string construction remains in xtask (all use quote_path())",
        "push.rs uses quote_path() for all path formatting",
        "review.rs uses quote_path() for all path formatting",
        "check.rs uses quote_path() for all path formatting",
        "Unit tests cover edge cases: empty path, path with spaces, path with 'quotes', path with \"quotes\", path with `backticks`, path with $variables, path with newlines",
        "cargo build succeeds",
        "cargo test passes",
        "cargo clippy passes with no warnings"
      ]
    },
    "notes": {
      "security": "This ticket directly addresses shell injection vulnerabilities discovered during PR reviews.\nShell escaping is critical for security when constructing commands with user-controlled paths.\nThe shell-escape crate or equivalent provides battle-tested escaping logic.\n",
      "implementation_details": "quote_path() should handle all shell metacharacters:\n- Spaces: path with spaces -> 'path with spaces'\n- Single quotes: path's -> 'path'\"'\"'s' (close quote, escaped quote, open quote)\n- Double quotes: path\"s -> 'path\"s' (single quotes don't interpret double quotes)\n- Backticks: path`cmd` -> 'path`cmd`' (single quotes prevent execution)\n- Dollar signs: path$var -> 'path$var' (single quotes prevent expansion)\n- Newlines: path\\nmore -> $'path\\nmore' (ANSI-C quoting)\n\nbuild_script_command() format:\n- With log: script -q '<log_path>' -c \"gemini --yolo < '<prompt_path>'\"\n- Without log: script -qec \"gemini --yolo < '<prompt_path>'\" /dev/null\n",
      "api_versioning": "Implementers should verify shell-escape crate API against the actual\ninstalled version. The examples use shell-escape 0.2.x API which may\ndiffer in newer versions.\n",
      "affected_files": "New: xtask/src/shell_escape.rs\nModified: xtask/src/main.rs (add module)\nModified: xtask/src/tasks/push.rs (use quote_path)\nModified: xtask/src/tasks/review.rs (use quote_path)\nModified: xtask/src/tasks/check.rs (use quote_path)\nModified: xtask/Cargo.toml (add shell-escape dependency)\n"
    }
  }
}

ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00604"
    title: "FAC core lifecycle state machine refactor and operational hardening"
    status: "MERGED"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00603"
        reason: "TCK-00603 introduced inline evidence gates in push.rs without gate-cache reuse."
  root_cause_analysis:
    summary: |
      Core FAC lifecycle behavior is currently fragmented and difficult to
      verify end-to-end. There are three major bottlenecks:

      1. Gate artifact reuse broken: TCK-00603 added inline evidence gate execution
         to `apm2 fac push` via `run_evidence_gates()` (the non-caching variant).
         Previously, push did not run gates inline — the background pipeline handled
         gates using `run_evidence_gates_with_status()` which checks the gate cache
         written by `apm2 fac gates`. The result: running `gates` then `push` now
         double-executes all evidence gates instead of reusing cached results.

      2. CI workflow blocks on GitHub projection round-trip: The `forge-admission-cycle.yml`
         CI workflow's "Poll review gate" step polls GitHub issue comments every 30s
         (up to 80 minutes) waiting for review verdicts to appear as PR comments. The
         local FAC system already has the verdicts locally (via completion receipts and
         projection store). The CI workflow creates a hard dependency on the GitHub
         projection being up-to-date before merge can proceed. If comment publishing
         fails, is rate-limited, or is slow, the entire merge pipeline stalls — even
         though the local truth plane already has all necessary evidence.

      3. Lifecycle authority is split across multiple ad-hoc CLI paths
         (`push`, `pipeline`, `restart`, `review run/dispatch/terminate`, and
         verdict/finding surfaces). This prevents a single formally-verifiable
         transition model, encourages duplicate transition logic, and makes
         autonomous implementer/reviewer loops brittle under crashes, SHA drift,
         and concurrent runs.
  scope:
    in_scope:
      - "Restore gate-cache reuse in `push.rs` so that `apm2 fac push` skips evidence gates already validated by a prior `apm2 fac gates` run for the same SHA."
      - "Ensure the SHA used for cache lookup matches the SHA used for gate execution (no mutation between git push --force and gate evaluation)."
      - "Eliminate CI workflow dependency on GitHub comment polling for review verdicts. The self-hosted runner has direct access to local FAC state — use `apm2 fac review verdict show` or local receipt files instead of polling GitHub API for comments."
      - "Suppress daemon auto-start warning on stderr when `--json` output is active (corrupts machine-readable output)."
      - |
        Rename `apm2 fac review comment` to `apm2 fac review finding`. Extend with
        structured schema fields (--summary, --risk, --impact, --location) beyond the
        existing --severity and --body. Derive SHA automatically from local PR identity
        so callers don't pass --sha. Findings accumulate locally per PR/type/SHA. When
        `apm2 fac review verdict set` is called, all accumulated findings for that
        PR/type/SHA are concatenated into a single comment and projected to GitHub
        (best effort). Update reviewer prompts to emit one `finding` call per issue
        instead of a bulk `publish --body-file` markdown file.
      - |
        Fix stale local identity after force-push. Currently, `apm2 fac push`
        writes the local PR identity/projection BEFORE running gates and
        dispatching reviews. When `git push --force` advances the remote HEAD,
        the local projection store may hold a SHA that was written prematurely —
        before gates validated it and before reviews were dispatched against it.
        Subsequent `apm2 fac restart` then fails with "local PR identity head
        ... is stale relative to authoritative PR head" with no recovery path.

        Required ordering: local identity/projection update must be the LAST
        step in the push flow — after git push, after gates pass, after review
        dispatch completes, possibly even after reviews finish. The local SHA
        must only be persisted once the full pipeline for that SHA has been
        confirmed. This ensures the local identity always reflects a SHA that
        has been fully processed, not one that is mid-flight.

        Additionally, `restart` should be able to refresh stale local identity
        from the remote when the user explicitly requests recovery, rather than
        hard-failing.
      - |
        Agent concurrency bounding per PR: introduce a tracking module that
        enforces a maximum of 2 concurrent agents working on any single PR at
        any time. The module must:
        (a) Maintain a durable registry of active agent sessions per PR
            (agent type, PID, start time, SHA being worked).
        (b) Refuse to dispatch new agents when the cap is reached, returning
            a clear "at capacity" signal rather than silently queuing.
        (c) Reap stale entries — detect crashed/killed agents (PID no longer
            alive) and reclaim their slots automatically.
        (d) Be consulted by all dispatch paths: `fac push` review dispatch,
            `fac restart`, `fac review run`, and the orchestrator monitor.
        This prevents infinite loops where reviewers find issues → implementer
        pushes fix → new reviewers spawn → find new issues → cycle repeats
        unboundedly with accumulating zombie agents.
      - |
        Create a machine-readable, formally verifiable state machine definition
        for the entire FAC lifecycle. The state machine must:
        (a) Define every state a PR can be in (e.g. unpushed, pushed,
            gates-running, gates-passed, gates-failed, reviews-dispatched,
            review-in-progress, verdict-pending, verdict-approve,
            verdict-deny, merge-ready, merged, stuck, stale) with precise
            entry/exit conditions.
        (b) Define every valid transition with its trigger (command, event,
            timeout), guard conditions, and side effects.
        (c) Be expressed in a structured format (JSON/CAC) that tooling can
            parse, validate, and render — not prose documentation.
        (d) Be the single source of truth for FAC behavior: implementation
            changes are driven by updating the state machine first, then
            working backwards to code. Reviewers and the orchestrator
            monitor can reference it to understand what should happen next
            for any given state.
        (e) Include illegal/impossible transitions explicitly so that
            violations can be detected at runtime (fail-closed on
            undefined transitions).
        (f) Cover agent lifecycle states (idle, dispatched, running,
            completed, crashed, reaped) as a sub-machine composed with
            the PR lifecycle.
      - |
        Use a reducer-first architecture for lifecycle authority. Even before
        daemon integration, all state transitions must flow through a single
        reducer entrypoint (`apply(state, event) -> next_state | deny`) and
        never through direct ad-hoc status mutation in command handlers.
      - |
        Explicitly model two composed state machines:
        (a) PR/SHA lifecycle machine (gate/review/merge progression).
        (b) Agent lifecycle machine (spawned/running/completed/crashed/reaped).
        Define the composition contract for cross-machine transitions
        (e.g. verdict set -> reviewer slot reclaimed -> PR transition).
      - |
        Remove `apm2 fac done` entirely. Verdict is the sole SHA status
        authority and the only completion signal for reviewer agents.
        Specifically:
        (a) Delete FacSubcommand::Done and all supporting types
            (DoneArgs, DoneAgentTypeArg, DoneStatusArg, DoneStatus,
            CompleteAgentRequest, RunDoneRequest, DoneReceipt) from
            fac.rs and lifecycle.rs.
        (b) Remove the run_done dispatcher, complete_agent(), and all
            done-token/done-receipt persistence helpers.
        (c) Remove LifecycleEventKind::AgentDone if no longer referenced
            by any non-done path.
        (d) Remove all user-facing guidance strings that instruct agents
            to call `fac done` (push.rs, mod.rs, orchestrator.rs).
        (e) `apm2 fac review verdict set` remains the authoritative
            completion signal for reviewers. It already reclaims the
            reviewer's agent registry slot and advances the lifecycle
            reducer. Non-reviewer agents (implementer, orchestrator)
            complete via existing orchestration/reap/crash paths.
        (f) Stale agent slots are reclaimed by PID liveness reaping,
            not by explicit done calls. This eliminates the completion
            token TTL window where finished agents appear active.
      - |
        Make findings non-authoritative for review status. Findings are
        append-only evidence records; verdict is the sole source of
        PASS/FAIL decision state. Specifically:
        (a) In findings_store.rs, remove status/verdict mutation from
            append_dimension_finding() — adding a finding must not set
            dimension status to FAIL or verdict to FAIL.
        (b) In findings.rs, derive dimension status strictly from
            verdict projection: verdict PASS → status PASS, verdict
            FAIL → status FAIL, no verdict → status PENDING.
        (c) overall_status: FAIL if any dimension FAIL, PASS if all
            active dimensions PASS, PENDING otherwise.
        (d) fail_closed semantics apply only to integrity/validation
            errors (corrupt bundle, projection mismatch), not to
            missing verdicts.
      - |
        Comprehensive error handling within the FAC state machine. Every state
        must define explicit error transitions — no state may silently swallow
        failures or leave the PR in an undefined limbo. Specifically:
        (a) Agent completes without verdict: a reviewer process exits
            (or is reaped) without having called `verdict set`. The
            state machine must detect the missing verdict via PID
            liveness checks and transition to a recovery state, not
            assume success.
        (b) Agent stuck/timeout: each agent session has a configurable
            time bound. If an agent neither sets a verdict nor crashes
            within the bound, the tracking module marks it stuck, kills
            it, and transitions the PR to a retriable error state with
            a bounded retry count.
        (c) API / projection errors: GitHub API failures, rate limits,
            network timeouts during projection writes. These must be
            handled as transient errors with exponential backoff and a
            circuit-breaker. The local truth plane must never block on
            projection failures — projections are best-effort.
        (d) SHA drift mid-pipeline: a new push arrives while gates or
            reviews are in progress for an older SHA. The state machine
            must cancel in-flight work for the stale SHA, reap those
            agent slots, and restart the pipeline for the new SHA.
        (e) Corrupted / missing state files: HMAC validation failure,
            missing receipt, partial write. The state machine transitions
            to a quarantine state requiring explicit operator intervention
            (`apm2 fac recover`) rather than silently proceeding on
            broken state.
        (f) Cascading failure prevention: bounded retry counts per state
            (max 3 by default), global per-PR error budget (max 10 total
            error transitions before the PR is parked as STUCK requiring
            manual intervention). No unbounded retry loops.
      - |
        Backwards compatibility and migration requirements:
        (a) Keep a compatibility shim for `apm2 fac review comment` while
            introducing `apm2 fac review finding`.
        (b) Migrate existing local FAC artifacts and run-state files
            deterministically (including in-flight runs) with explicit
            fail-closed behavior on ambiguity/corruption.
        (c) Preserve/normalize legacy terminal reasons and status semantics.
      - |
        Introduce shadow-mode rollout for the new reducer:
        (a) Run current logic and reducer logic in parallel initially.
        (b) Compare projections/terminal outcomes per PR/SHA.
        (c) Block full cutover until divergence is zero across burn-in runs.
      - |
        Add a dedicated runtime recovery command (`apm2 fac recover`) for
        quarantine/ambiguous/corrupt state repair paths defined by the machine.
      - |
        Expand `apm2 fac doctor` to be the unified diagnostic command for
        both system health AND per-PR lifecycle status. Without `--pr`,
        it retains its current behavior (daemon, disk, token, socket
        checks). With `--pr <N>`, it produces a comprehensive single-
        source report for that PR's entire FAC lifecycle. This is the
        ONE command an operator or orchestrator agent calls to understand
        everything about a PR. Sections (when --pr is provided):

        IDENTITY — "What PR am I looking at?"
        (a) PR number, title (from projection cache or local metadata),
            branch name, worktree path, repo.
        (b) Local SHA vs authoritative remote HEAD SHA.
            If they differ: flag as STALE with both values.
            If local identity is missing entirely: flag as MISSING.
        (c) Source and timestamp of the identity record.

        LIFECYCLE — "Where is this PR in the pipeline?"
        (d) Current reducer state with human-readable label.
        (e) Time in current state (wall-clock duration since last
            transition).
        (f) Error budget: consumed / max (e.g. "2/10").
        (g) Retry budget remaining for current state.

        GATES — "Did evidence gates pass?"
        (h) Per-gate: name, status (PASS/FAIL/NOT_RUN), duration,
            SHA they were executed against.
        (i) Cache reusability: whether the cached results are valid
            for the current HEAD SHA, or stale/missing.

        REVIEWS — "What do the reviewers say?"
        (j) Per-dimension (security, code-quality):
            verdict (approve/deny/pending), reviewed SHA, timestamp.
        (k) Findings summary per dimension: blocker/major/minor/nit
            counts. Full findings via `apm2 fac review findings`.
        (l) Whether findings have been projected to GitHub (and when).

        AGENTS — "Who's working on this PR?"
        (m) Per-agent entry from the registry: type, state
            (dispatched/running/completed/crashed/reaped), PID,
            PID liveness (is the process actually alive right now?),
            SHA the agent is bound to, run_id, time active.
        (n) Concurrency: active slot count / max (e.g. "2/2").
        (o) Any agents with expired completion tokens flagged.

        EVENTS — "What happened recently?"
        (p) Last N lifecycle events (default 10) with timestamp,
            event type, SHA, and detail payload.

        HEALTH — "Are there problems?"
        (q) Actionable diagnostics derived by cross-referencing the
            sections above. Examples:
            - "identity MISSING — run: apm2 fac recover --pr N
              --refresh-identity"
            - "reviewer-security PID 712345 is dead but slot is
              still active — will be reaped on next dispatch"
            - "gate cache is stale (cached for abc123, HEAD is
              def456) — gates will re-run on next push"
            - "security verdict is deny but lifecycle state is
              verdict_pending — state inconsistency detected"
            - "error budget exhausted (10/10) — PR parked as STUCK"
            Each diagnostic includes a severity (info/warning/error)
            and, where applicable, a suggested remediation command.
        (r) If no problems: explicit "healthy" indicator.

        OUTPUT MODES
        (s) Default: human-readable sections with headers, aligned
            columns, and ANSI status indicators.
        (t) --json: single JSON object with all sections as keys,
            machine-consumable by orchestrator agents.
        (u) Optional --section <name> to show only one section
            (e.g. --section agents, --section health) for focused
            queries.

        The command MUST NOT modify any state. It is purely
        observational. All data sources are read-only.
    out_of_scope:
      - "Redesigning the gate cache format or attestation scheme."
      - "Changes to the background pipeline gate execution path."
      - "Removing the CI workflow entirely (it remains the required status check for merge)."
  plan:
    steps:
      - "Wire gate-cache reuse into push.rs: replace `run_evidence_gates` with cache-aware variant or add cache check in `run_blocking_evidence_gates`."
      - "Validate that SHA captured before `git push --force` matches the SHA used for cache lookup."
      - "Replace the CI workflow's GitHub comment polling with local verdict check: the self-hosted runner can call `apm2 fac review verdict show --json` to read local verdict state directly instead of round-tripping through GitHub API."
      - "Define FAC lifecycle machine artifact format (CAC/JSON), schema id, canonical file location, and validation command."
      - "Implement composed PR/SHA and agent lifecycle reducers with explicit event taxonomy, legal/illegal transition tables, and fail-closed undefined transition handling."
      - "Refactor FAC command handlers to emit reducer events and consume reducer outputs rather than mutating status directly."
      - "Implement durable per-PR agent registry with max-concurrency enforcement (cap=2), stale reaping, and integration across push/restart/review/orchestrator paths."
      - "Remove `apm2 fac done` full stack: CLI surface, lifecycle types, dispatcher, completion-token helpers, done-receipt persistence, and all agent-facing guidance strings."
      - "Make findings non-authoritative: remove status/verdict mutation from findings append path; derive dimension/overall status strictly from verdict projection."
      - "Introduce `apm2 fac review finding` structured interface and staged compatibility shim for `apm2 fac review comment`."
      - "Implement explicit stale identity recovery path in restart/recover flows and enforce projection-update ordering late in push lifecycle."
      - "Implement shadow-mode reducer execution + parity checks, then guarded cutover to reducer authority."
      - "Add fault-injection and crash-recovery tests for SHA drift, lock contention, partial writes, stale PID reuse, projection outage, and corrupted state artifacts."
      - "Run formatting, clippy, docs, and full test suite."
  definition_of_done:
    evidence_ids: []
    criteria:
      - "`apm2 fac gates` followed by `apm2 fac push` (with no intervening changes) reuses cached gate results instead of re-executing all gates."
      - "Gate cache lookup uses the same SHA as gate execution."
      - "CI workflow's review gate uses local FAC verdict state instead of polling GitHub comments."
      - "A machine-readable FAC lifecycle state machine artifact exists, validates against schema, and is treated as single source of truth for FAC transitions."
      - "Reducer enforces legal transitions only; undefined transitions fail closed with machine-readable denial reason."
      - "PR/SHA and agent lifecycle machines are composed and exercised in integration tests."
      - "Per-PR agent cap of 2 is enforced across all dispatch paths with deterministic at-capacity responses."
      - "Stale/dead agent entries are reaped automatically and verified by tests."
      - "`apm2 fac done` is fully removed: no CLI surface, no lifecycle types, no done-receipt paths, no agent guidance strings referencing it."
      - "Adding findings never mutates review status/verdict in storage; `apm2 fac review findings` reports dimension/overall status strictly from verdict state."
      - "Reviewer agent completion is driven by verdict set (reclaims registry slot) and PID reaping (catches crashes); no separate done signal required."
      - "SHA drift during gates/reviews cancels/supersedes stale work and restarts for the newest SHA."
      - "`apm2 fac review finding` is available; legacy `review comment` compatibility path remains functional during migration window."
      - "State migration handles existing local artifacts deterministically; ambiguous/corrupt state paths fail closed and require explicit recover flow."
      - "Shadow-mode parity runs show zero divergence across burn-in threshold before reducer cutover."
      - "Projection failures do not block local truth progression; projection retries/backoff/circuit-breaker behavior is verified."
      - "All evidence gates and tests pass."
  notes:
    context: |
      The old push.rs (pre-TCK-00603) did not run evidence gates at all — it was
      just `git push → create PR → auto-merge`. Gates were handled by the background
      pipeline via `run_evidence_gates_with_status()` which checks the gate cache.
      TCK-00603 added inline gate execution using `run_evidence_gates()` (no cache),
      breaking the `gates` → `push` artifact reuse workflow.

      The CI workflow runs on a self-hosted runner (fac-ovh label) which is the same
      VPS that has local FAC state. The "Poll review gate" step currently makes ~160
      GitHub API calls per PR (80 min / 30s interval × 2 dimensions) when it could
      read the verdict from a local file in one call.

      FAC is the system's core execution spine. This ticket intentionally combines
      operational fixes with architectural unification so lifecycle behavior becomes
      explicit, reducer-driven, and formally checkable before daemon integration.

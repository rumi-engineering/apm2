ticket_meta:
  schema_version: '2026-01-29'
  template_version: '2026-01-29'
  ticket:
    id: TCK-00648
    title: 'RFC-0032 Phase 4: WorkLoopManager reaper/nudge loop (enforce implementer terminal contract after session termination)'
    status: OPEN
  binds:
    prd_id: PRD-PLACEHOLDER
    rfc_id: RFC-0032
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles:
    - AGENT_IMPLEMENTER
    responsibility_domains:
    - DOMAIN_DAEMON
    - DOMAIN_RUNTIME
    - DOMAIN_ORCHESTRATION
  dependencies:
    tickets:
    - ticket_id: TCK-00638
      reason: Needs work_context markers
    - ticket_id: TCK-00645
      reason: Needs WorkLoopProfile budgets
    - ticket_id: TCK-00647
      reason: Needs session lifecycle events
  scope:
    in_scope:
    - Implement daemon WorkLoopManager that reacts to `session.terminated` events for implementer sessions
    - If work state remains InProgress and required terminal markers are missing (IMPLEMENTER_TERMINAL + HANDOFF_NOTE), schedule nudges/re-dispatch per WorkLoopProfile budgets
    - 'Nudge content must include: doctor status, missing markers, exact command to run (`apm2 fac push --work-id ...`)'
    - No hard-coded retry caps; use WorkLoopProfile nudge_policy/backoff_seconds
    out_of_scope:
    - Changing reducer work state machine rules (this is a daemon control-plane loop)
  plan:
    steps:
    - Add WorkLoopManager module under `crates/apm2-daemon/src/work/`
    - Subscribe to session termination notifications and query projections for terminal markers keyed by session_id
    - Schedule nudges using tokio timers and deterministic workspace reuse (via WorktreeManager)
    - Add metrics for nudges scheduled/sent and terminal contract compliance rates
    - 'Add tests: missing markers triggers nudge; markers present suppress nudge; budgets enforced'
  definition_of_done:
    evidence_ids: []
    criteria:
    - Terminal contract compliance is enforced by daemon loop (nudges/reaping) and is replayable from ledger+CAS (no local-only truth).
    - Nudge behavior is configurable via WorkLoopProfile; no hard-coded caps remain in new path.

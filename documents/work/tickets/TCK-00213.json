{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00213",
      "title": "FAC: Divergence watchdog with InterventionFreeze",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0009",
      "rfc_id": "RFC-0015",
      "requirements": [
        {
          "requirement_id": "FAC-REQ-0002",
          "requirement_ref": "documents/rfcs/RFC-0015/01_problem_and_imports.yaml#rfc_imported_requirements"
        }
      ],
      "evidence_artifacts": [
        {
          "evidence_id": "EVID-FAC-0004",
          "artifact_ref": "documents/rfcs/RFC-0015/07_test_and_evidence.yaml#evidence_requirements"
        }
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_SECURITY",
        "DOMAIN_DAEMON"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00212"
      ]
    },
    "scope": {
      "in_scope": [
        "Add InterventionFreeze and InterventionUnfreeze proto messages",
        "Implement DivergenceWatchdog",
        "Implement check_divergence() against MergeReceipt",
        "Emit DefectRecord(PROJECTION_DIVERGENCE) on divergence",
        "Add freeze checking to admission path"
      ],
      "out_of_scope": [
        "Unfreeze ceremony UI",
        "Emergency recovery procedures"
      ]
    },
    "plan": {
      "steps": [
        "Add InterventionFreeze message to proto/kernel_events.proto",
        "Add InterventionUnfreeze message",
        "Create crates/apm2-daemon/src/projection/divergence_watchdog.rs",
        "Implement DivergenceWatchdog with poll interval",
        "Implement check_divergence(latest_merge_receipt, external_trunk_head)",
        "Implement on_divergence() to emit freeze",
        "Add freeze checking to admission decision logic",
        "Write integration tests for divergence detection",
        "Write integration tests for freeze enforcement"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-FAC-0004"
      ],
      "criteria": [
        "Divergence between trunk HEAD and MergeReceipt triggers freeze",
        "InterventionFreeze halts new admissions",
        "Frozen repo returns REPO_FROZEN error",
        "Unfreeze requires adjudication",
        "cargo test -p apm2-daemon projection::divergence_watchdog::tests passes"
      ]
    },
    "notes": {
      "security": "Divergence detection is critical for maintaining ledger integrity.\nAny external modification of the trunk triggers immediate freeze\nto prevent inconsistent state.\n",
      "implementation_details": "InterventionFreeze fields:\n- scope, scope_value, trigger_defect_id\n- frozen_at, gate_actor_id, gate_signature, time_envelope_ref\n\nInterventionUnfreeze fields:\n- freeze_id, resolution_type, adjudication_id\n- unfrozen_at, gate_actor_id, gate_signature, time_envelope_ref\n",
      "affected_files": "Modified: proto/kernel_events.proto\nCreated: crates/apm2-daemon/src/projection/divergence_watchdog.rs\n"
    }
  }
}

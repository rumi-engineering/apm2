ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00627"
    title: "Instrument and verify warm-path performance SLO for repeated identical gate runs"
    status: "OPEN"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: ["REQ-0038"]
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME", "DOMAIN_CI"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00620"
        reason: "ReadinessController no-op overhead is part of the warm prep_duration_ms SLO."
      - ticket_id: "TCK-00623"
        reason: "closure_hash stability is required for warm-path cache hits."

root_cause_analysis:
  summary: |
    Repeated identical `apm2 fac push` invocations (gates phase) do not have
    a defined performance contract. There is no measurement of warm-path vs.
    cold-path duration, no SLO threshold, and no CI signal that detects
    regressions in cache reuse efficiency. Implementors running push repeatedly
    in fast iteration loops have no visibility into whether the second run is
    benefiting from caching or re-executing gates from scratch.

scope:
  in_scope:
    - id: "S1_RUN_SUMMARY_TIMING_FIELDS"
      title: "Add warm-path fields to run_summary event"
      detail: |
        Ensure run_summary (from TCK-00625) includes:
          total_duration_ms:   u64
          prep_duration_ms:    u64
          execute_duration_ms: u64
          cache_hit_count:     u32
          cache_miss_count:    u32
          is_warm_run:         bool  (true if all gates hit and prep < 500 ms)
          slo_violation:       Option<String>  (human-readable SLO breach description)
        is_warm_run and slo_violation are computed at run_summary emission time.
    - id: "S2_SLO_CHECK"
      title: "Compute SLO compliance at run end and emit warning if violated"
      detail: |
        After collecting run timing and cache counts:
          - If cache_hit_count < total_gate_count: is_warm_run = false
          - If is_warm_run and prep_duration_ms > 500: set slo_violation
          - SLO violation is a warning in run_summary, not a run failure.
        Do not fail the run on SLO violation; only surface the warning.
    - id: "S3_CI_BENCHMARK"
      title: "Add CI benchmark test verifying warm-path SLO"
      detail: |
        Add a benchmark/integration test that:
          1. Runs `apm2 fac push` (run1) and captures the gates run_summary.
          2. Runs `apm2 fac push` again (run2, same SHA) and captures run_summary.
          3. Asserts run2.cache_hit_count == run1 gate count.
          4. Asserts run2.total_duration_ms <= run1.total_duration_ms * 0.20.
          5. Asserts run2.prep_duration_ms <= 500.
          6. Asserts run2.is_warm_run == true.
        Test must be runnable in CI without external services.
    - id: "S4_REGRESSION_TESTS"
      title: "Unit regression tests for is_warm_run and slo_violation computation"
      detail: |
        - Test: all gates hit + prep < 500 ms → is_warm_run=true, slo_violation=null.
        - Test: one gate miss → is_warm_run=false.
        - Test: all hits + prep > 500 ms → is_warm_run=false, slo_violation set.
        - Test: SLO violation does NOT cause non-zero exit code.
  out_of_scope:
    - "Automatic cache warming (that is apm2 fac warm, a separate surface)."
    - "SLO enforcement (SLO is a warning only, not a gating failure)."
    - "Cross-run persistence of timing data for trend analysis."

plan:
  steps:
    - id: "STEP_01"
      title: "Add is_warm_run, slo_violation, and timing fields to run_summary event"
      detail: |
        Extend GatesEventV1::RunSummary variant (TCK-00625) with the fields.
        Compute is_warm_run and slo_violation in the run_summary builder.
    - id: "STEP_02"
      title: "Implement SLO compliance check"
      detail: |
        After gate dispatch loop: collect total_duration_ms, prep_duration_ms,
        cache_hit_count, cache_miss_count. Compute is_warm_run. If SLO
        violated, set slo_violation string. Emit run_summary.
    - id: "STEP_03"
      title: "Add CI benchmark test"
      detail: |
        Use a fixture worktree with pre-seeded closure and substrate. Run
        twice; parse JSONL; assert warm-path SLO invariants.
    - id: "STEP_04"
      title: "Run full workspace validation"
      detail: |
        cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings
        cargo doc --workspace --no-deps && cargo test --workspace

definition_of_done:
  evidence_ids:
    - "EXEC-TCK00627-WARM-PATH-SLO"
    - "EXEC-TCK00627-CI-BENCHMARK"
    - "EXEC-TCK00627-WORKSPACE-VALIDATION"
  criteria:
    - "run_summary event includes total_duration_ms, prep_duration_ms, execute_duration_ms, cache_hit_count, cache_miss_count, is_warm_run, slo_violation."
    - "is_warm_run is true iff all gates hit and prep_duration_ms <= 500 ms."
    - "SLO violation sets slo_violation warning but does not cause non-zero exit."
    - "CI benchmark: run2 is_warm_run=true, cache_hit_count equals gate count, total_duration_ms <= run1 * 0.20."
    - "Regression tests cover all is_warm_run and slo_violation computation cases."
    - "Workspace validation completes successfully."

notes:
  context: |
    This ticket is primarily instrumentation and verification — it does not
    change cache behavior, only measures and reports it. The SLO threshold
    (run2 <= 20% of run1) is ambitious but achievable when the closure is
    pre-hydrated and the substrate is warm. If the threshold proves too tight
    in practice it can be relaxed via a new requirement amendment; it must not
    be loosened ad-hoc in the implementation.
  security: "timing data is non-sensitive; no key material or user data in run_summary"

{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-24",
    "template_version": "2026-01-24",
    "ticket": {
      "id": "TCK-00064",
      "title": "Add AI Tool Invocation Tests"
    },
    "binds": {
      "prd_id": "NONE",
      "rfc_id": "RFC-0006",
      "requirements": [
        {
          "requirement_id": "MAINT-010",
          "requirement_ref": "documents/rfcs/RFC-0006/01_problem_and_imports.yaml#rfc_local_requirements.requirements[4]"
        }
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_BUILD_RELEASE"
      ]
    },
    "dependencies": {
      "tickets": []
    },
    "scope": {
      "in_scope": [
        "Add test_temp_file_security test to xtask/src/tasks/push.rs",
        "Add test_temp_file_security test to xtask/src/tasks/review.rs",
        "Verify NamedTempFile creates files with 0600 permissions",
        "Verify temp file path is unpredictable (not in fixed location)",
        "Verify temp file is cleaned up after drop",
        "Add test_script_command_format test to xtask/src/tasks/push.rs",
        "Add test_script_command_format test to xtask/src/tasks/review.rs",
        "Verify script command format is valid for PTY allocation",
        "Verify input redirection syntax is correct"
      ],
      "out_of_scope": [
        "Changes to temp file creation implementation",
        "Changes to script command invocation logic",
        "Integration tests requiring actual Gemini CLI",
        "Performance testing of temp file operations"
      ]
    },
    "plan": {
      "steps": [
        "Read xtask/src/tasks/push.rs to understand current temp file and script patterns",
        "Read xtask/src/tasks/review.rs to understand current temp file and script patterns",
        "Add test module to push.rs if not already present",
        "Implement test_temp_file_security in push.rs: create NamedTempFile, get file metadata, assert permissions are 0600",
        "Implement test_temp_file_security in push.rs: verify path is in temp directory (not predictable fixed location)",
        "Implement test_temp_file_security in push.rs: drop file and verify cleanup via path.exists() == false",
        "Implement test_script_command_format in push.rs: verify command string matches expected pattern",
        "Implement test_script_command_format in push.rs: verify input redirection uses correct < syntax",
        "Implement test_script_command_format in push.rs: verify PTY allocation via script -qec pattern",
        "Add test module to review.rs if not already present",
        "Implement test_temp_file_security in review.rs with same verification as push.rs",
        "Implement test_script_command_format in review.rs with same verification as push.rs",
        "Run cargo test -p xtask to verify all tests pass",
        "Run cargo clippy -p xtask to verify no warnings"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [],
      "criteria": [
        "test_temp_file_security exists in xtask/src/tasks/push.rs and passes",
        "test_temp_file_security exists in xtask/src/tasks/review.rs and passes",
        "test_script_command_format exists in xtask/src/tasks/push.rs and passes",
        "test_script_command_format exists in xtask/src/tasks/review.rs and passes",
        "Tests verify 0600 permissions on NamedTempFile",
        "Tests verify temp file path is not predictable",
        "Tests verify temp file cleanup after drop",
        "Tests verify script command format includes PTY allocation",
        "Tests verify input redirection syntax is correct",
        "cargo test -p xtask passes",
        "cargo clippy -p xtask passes with no warnings",
        "cargo build succeeds"
      ]
    },
    "notes": {
      "security": "Tests validate security properties of temp file creation (0600 permissions, unpredictable paths, cleanup)",
      "test_approach": "Unit tests only - no integration tests requiring actual AI CLI tools",
      "permission_check": "Use std::os::unix::fs::PermissionsExt to check mode bits on Unix platforms"
    }
  }
}

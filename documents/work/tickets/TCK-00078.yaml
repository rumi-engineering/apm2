ticket_meta:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"
  ticket:
    id: "TCK-00078"
    title: "Add Evidence Script and PR Format Validation"
  binds:
    prd_id: "NONE"
    rfc_id: "RFC-0006"
    requirements:
      - requirement_id: "AAT-006"
        requirement_ref: "documents/rfcs/RFC-0006/01_problem_and_imports.yaml#rfc_local_requirements.requirements[19]"
    evidence_artifacts: []
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_BUILD_RELEASE"
  dependencies:
    tickets: []
  scope:
    in_scope:
      - "Validate evidence script path exists and is executable"
      - "Validate Usage section contains at least 1 code block"
      - "Validate Expected Outcomes contain BOTH When AND Then keywords"
      - "Return actionable errors for each validation failure"
    out_of_scope:
      - "Execution of evidence script during validation"
      - "Schema validation of PR description YAML"
      - "Auto-fix for malformed PR descriptions"
  plan:
    steps:
      - "Add validate_evidence_script() to parser.rs"
      - "Check path exists using std::path::Path::exists()"
      - "Check executable bit using std::os::unix::fs::PermissionsExt"
      - "Add validate_usage_section() to parser.rs"
      - "Check for at least 1 markdown code block (``` delimiters)"
      - "Add validate_expected_outcomes() to parser.rs"
      - "Check outcomes contain BOTH When AND Then keywords"
      - "Create ValidationError enum with specific variants"
      - "Return Vec<ValidationError> with actionable messages"
      - "Integrate validation into aat.rs after parsing"
      - "Display validation errors before proceeding"
      - "Verify cargo build succeeds"
      - "Verify cargo test passes"
      - "Verify cargo clippy passes with no warnings"
  definition_of_done:
    evidence_ids: []
    criteria:
      - "validate_evidence_script() checks existence and executable"
      - "validate_usage_section() requires at least 1 code block"
      - "validate_expected_outcomes() requires BOTH When AND Then keywords"
      - "Actionable error messages for each validation failure"
      - "Validation integrated into AAT run flow"
      - "cargo build succeeds"
      - "cargo test passes"
      - "cargo clippy passes with no warnings"
  notes:
    implementation_details: |
      ```rust
      // xtask/src/aat/parser.rs additions

      use std::path::Path;

      #[derive(Debug, Clone)]
      pub enum ValidationError {
          EvidenceScriptNotFound { path: String },
          EvidenceScriptNotExecutable { path: String },
          UsageMissingCodeBlock,
          OutcomeMissingWhenThen { outcome: String },
      }

      impl ValidationError {
          pub fn message(&self) -> String {
              match self {
                  Self::EvidenceScriptNotFound { path } => {
                      format!(
                          "Evidence script not found: {}\n\
                           Fix: Create the script or update the path in PR description",
                          path
                      )
                  }
                  Self::EvidenceScriptNotExecutable { path } => {
                      format!(
                          "Evidence script not executable: {}\n\
                           Fix: Run `chmod +x {}`",
                          path, path
                      )
                  }
                  Self::UsageMissingCodeBlock => {
                      "Usage section missing code block\n\
                       Fix: Add a code block with usage example:\n\
                       ```bash\n\
                       cargo xtask aat <PR_URL>\n\
                       ```".to_string()
                  }
                  Self::OutcomeMissingWhenThen { outcome } => {
                      format!(
                          "Expected outcome missing When/Then format: {}\n\
                           Fix: Use format like: \"When X, then Y\"",
                          outcome
                      )
                  }
              }
          }
      }

      pub fn validate_pr_description(
          parsed: &ParsedPRDescription,
          repo_root: &Path,
      ) -> Vec<ValidationError> {
          let mut errors = Vec::new();

          // Validate evidence script
          if let Some(script_path) = &parsed.evidence_script {
              let full_path = repo_root.join(script_path);
              if !full_path.exists() {
                  errors.push(ValidationError::EvidenceScriptNotFound {
                      path: script_path.clone(),
                  });
              } else {
                  #[cfg(unix)]
                  {
                      use std::os::unix::fs::PermissionsExt;
                      if let Ok(metadata) = full_path.metadata() {
                          let mode = metadata.permissions().mode();
                          if mode & 0o111 == 0 {
                              errors.push(ValidationError::EvidenceScriptNotExecutable {
                                  path: script_path.clone(),
                              });
                          }
                      }
                  }
              }
          }

          // Validate usage has code block
          if !parsed.usage.contains("```") {
              errors.push(ValidationError::UsageMissingCodeBlock);
          }

          // Validate outcomes have both When AND Then (require both keywords)
          for outcome in &parsed.expected_outcomes {
              let text_lower = outcome.text.to_lowercase();
              if !text_lower.contains("when") || !text_lower.contains("then") {
                  errors.push(ValidationError::OutcomeMissingWhenThen {
                      outcome: outcome.text.clone(),
                  });
              }
          }

          errors
      }
      ```
    affected_files: |
      Modified: xtask/src/aat/parser.rs (add validation functions)
      Modified: xtask/src/tasks/aat.rs (integrate validation)

{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-24",
    "template_version": "2026-01-24",
    "ticket": {
      "id": "TCK-00309",
      "title": "HEF: Close xtask/GitHub status bypass surface",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0009",
      "rfc_id": "RFC-0018",
      "requirements": [
        {
          "requirement_id": "REQ-HEF-0001",
          "requirement_ref": "documents/rfcs/RFC-0018/requirements/REQ-HEF-0001.yaml#requirement"
        }
      ],
      "evidence_artifacts": [
        {
          "evidence_id": "EVID-HEF-0001",
          "artifact_ref": "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0001.yaml#evidence_artifact"
        }
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_KERNEL"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00294",
          "reason": "Depends on prerequisite infrastructure changes"
        },
        {
          "ticket_id": "TCK-00295",
          "reason": "Depends on prerequisite infrastructure changes"
        },
        {
          "ticket_id": "TCK-00296",
          "reason": "Depends on prerequisite infrastructure changes"
        },
        {
          "ticket_id": "TCK-00297",
          "reason": "Depends on prerequisite infrastructure changes"
        }
      ]
    },
    "scope": {
      "in_scope": [
        "Search repository for direct GitHub status writes (gh api /statuses)",
        "Add feature flag USE_HEF_PROJECTION (default: false) to gate routing behavior",
        "When USE_HEF_PROJECTION=false, existing xtask writes continue unchanged",
        "When USE_HEF_PROJECTION=true, route writes through daemon projection-only logic",
        "Update xtask/src/tasks/aat.rs to check feature flag before status writes",
        "Update xtask/src/tasks/push.rs to check feature flag before status writes",
        "Update xtask/src/tasks/review.rs to check feature flag before status writes",
        "Update xtask/src/tasks/security_review_exec.rs to check feature flag before status writes",
        "Document migration path: enable flag only after HEF projection is validated"
      ],
      "out_of_scope": [
        "Removing xtask status writes (deferred until HEF projection validated)",
        "Enabling USE_HEF_PROJECTION by default (requires separate validation ticket)",
        "Non-FAC-adjacent GitHub status writes",
        "GitHub checks API modifications",
        "GitHub PR review API modifications"
      ]
    },
    "plan": {
      "steps": [
        "Search repo for all direct GitHub status writes (grep for 'gh api' + 'statuses')",
        "Identify which writes are FAC-adjacent signals vs non-FAC signals",
        "Add USE_HEF_PROJECTION feature flag (env var or config) defaulting to false",
        "For each FAC-adjacent write in xtask/src/tasks/aat.rs, wrap in feature flag check",
        "For each FAC-adjacent write in xtask/src/tasks/push.rs, wrap in feature flag check",
        "For each FAC-adjacent write in xtask/src/tasks/review.rs, wrap in feature flag check",
        "For each FAC-adjacent write in xtask/src/tasks/security_review_exec.rs, wrap in feature flag check",
        "When flag enabled, route writes through daemon projection-only logic",
        "Add tests verifying both paths work (flag=false uses xtask, flag=true uses projection)",
        "Document migration path: flag stays false until HEF projection validated end-to-end"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-HEF-0001"
      ],
      "criteria": [
        "USE_HEF_PROJECTION feature flag exists and defaults to false (xtask unchanged).",
        "When USE_HEF_PROJECTION=true, status writes route through daemon projection.",
        "Existing xtask functionality preserved when flag is disabled."
      ]
    },
    "notes": {
      "security": "default-deny, least privilege, fail-closed",
      "verification": "Test both flag states; xtask writes work when flag=false",
      "deferral": "Removal of xtask writes deferred until HEF projection validated in production"
    }
  }
}

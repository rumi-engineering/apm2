{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00614",
      "title": "FAC projection-model merge safety: required status simplification + regression tests",
      "status": "MERGED",
      "merge_evidence": [
        {
          "pr": 712,
          "merge_commit": "13749691cc6c72922196a719da894ab6375ccbbc",
          "merged_at": "2026-02-17T04:39:18Z"
        }
      ]
    },
    "binds": {
      "prd_id": "PRD-PLACEHOLDER",
      "rfc_id": "RFC-0019",
      "requirements": [],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_SECURITY",
        "DOMAIN_CI"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00613",
          "reason": "Continuation of FAC hardening; this ticket scopes CI/ruleset enforcement invariants for projection mode."
        }
      ]
    },
    "root_cause_analysis": {
      "summary": "INCIDENT: INC-2026-02-17-FAC-AUTOMERGE-FAILOPEN (SEV-1)\n\nThe structural failure was not auto-merge itself; it was that GitHub did not\ntreat failing/pending FAC-related signals as required merge blockers.\n\nIn GitHub, auto-merge only waits on REQUIRED checks. If a check is failing but\nnot required, merge can still proceed when required checks are satisfied.\n\nFor PRs #704/#709/#710, FAC/preflight signals were failing or skipped while\nmerge still proceeded. In projection terms, authoritative merge state was not\nmapped to a single required status context.\n\nResolution in this branch is to simplify CI wiring so GitHub is projection-only\nand blocks strictly on one authoritative status: `apm2 / Forge Admission Cycle`.\n"
    }
  },
  "scope": {
    "in_scope": [
      {
        "id": "S1_REUSABLE_GATES_QUEUE_ABSTRACTION",
        "title": "Extract reusable queue-backed gates path",
        "detail": "Added queue-backed reusable abstractions in\n`crates/apm2-cli/src/commands/fac_review/gates.rs`:\n- `QueuedGatesRequest`\n- `QueuedGatesOutcome`\n- `run_queued_gates_and_collect(...)`\n- fail-closed cache loading and required gate-set verification\n- persisted `merge_conflict_main` into the write-through gate cache so\n  queue consumers and push validation see a complete required gate set\n\nThis path waits for queue execution and materializes authoritative\nper-gate rows from attested gate cache for the target SHA.\n"
      },
      {
        "id": "S2_FAC_PUSH_USES_QUEUE_ABSTRACTION",
        "title": "Make fac push consume queued gates result (not ad-hoc gate logic)",
        "detail": "`crates/apm2-cli/src/commands/fac_review/push.rs` now uses\n`run_queued_gates_and_collect(...)` with `require_external_worker=true`\nand blocking wait semantics.\n\nPush now fails closed when:\n- queue returns empty job id\n- returned head SHA differs from expected push SHA\n- required gate artifacts are missing/inconsistent\n"
      },
      {
        "id": "S3_FAIL_FAST_GATE_EXECUTION",
        "title": "Stop gate pipelines on first failure",
        "detail": "`crates/apm2-cli/src/commands/fac_review/evidence.rs` gate execution was\nhardened to fail on first failing gate in both:\n- `run_evidence_gates_with_lane_context(...)`\n- `run_evidence_gates_with_status_with_lane_context(...)`\n\nFinalization/projection/cache persistence still runs before returning.\n"
      },
      {
        "id": "S4_REGRESSION_TESTS",
        "title": "Add regression tests for queue abstraction and push integration",
        "detail": "Added/updated tests to lock behavior:\n- queue quick-mode rejection for collection path\n- external-worker-required heartbeat fail-closed\n- cache gate-set completeness enforcement\n- cache-to-result materialization order/status mapping\n- fac push queued outcome SHA mismatch fail-closed\n"
      },
      {
        "id": "S5_CLEANUP_SYNTHETIC_TEST",
        "title": "Remove synthetic clippy test artifact",
        "detail": "Deleted `crates/apm2-core/tests/test_ct_eq.rs` (intentional temporary test\nartifact) and focused branch scope on production FAC queue/gate logic.\n"
      }
    ],
    "out_of_scope": [
      "Changing GitHub rulesets/workflow policy in this ticket update.",
      "Changing GitHub auto-merge policy semantics directly.",
      "Reintroducing ad-hoc inline gate logic inside fac push."
    ]
  },
  "plan": {
    "steps": [
      {
        "id": "STEP_01",
        "title": "Implement reusable queue abstraction",
        "detail": "Add reusable queue request/outcome and cache materialization path."
      },
      {
        "id": "STEP_02",
        "title": "Route fac push through reusable queue path",
        "detail": "Require external worker, wait for queue receipt, validate SHA and gates."
      },
      {
        "id": "STEP_03",
        "title": "Harden gate execution fail-fast behavior",
        "detail": "Return immediately on first failed gate after deterministic finalization."
      },
      {
        "id": "STEP_04",
        "title": "Add regression tests",
        "detail": "Cover queue fail-closed invariants and push queue integration guards."
      },
      {
        "id": "STEP_05",
        "title": "Run full workspace validation",
        "detail": "Validate with:\n- `cargo fmt --all`\n- `cargo clippy --workspace --all-targets --all-features -- -D warnings`\n- `cargo doc --workspace --no-deps`\n- `cargo test --workspace`\n"
      }
    ]
  },
  "definition_of_done": {
    "evidence_ids": [
      "EXEC-2026-02-17-CI-MERGE-POLICY",
      "EXEC-2026-02-17-WORKSPACE-VALIDATION"
    ],
    "criteria": [
      "`fac push` uses reusable queued gates abstraction and blocks on queue completion.",
      "Push fails closed on empty job id, SHA mismatch, and incomplete/inconsistent gate rows.",
      "Gate execution fails on first error while preserving finalization/projection/cache update behavior.",
      "Regression tests assert queue/path invariants and pass.",
      "Workspace validation commands complete successfully."
    ]
  },
  "notes": {
    "context": "This ticket update is scoped only to work completed in this branch iteration:\nqueued-gates fail-closed validation hardening in `fac push`, sandbox-hash\nbinding for queued gates worker receipts, and CI projection-policy regression\ntest hardening with machine-verifiable execution receipts.\n\nModified files tied to this ticket:\n- `crates/apm2-cli/src/commands/fac_review/push.rs`\n- `crates/apm2-cli/src/commands/fac_worker.rs`\n- `crates/apm2-cli/tests/ci_merge_policy_invariants.rs`\n- `documents/work/reports/tck-00614.validation.2026-02-17.json`\n",
    "security": "default-deny, fail-closed gate queueing and projection guards",
    "verification_evidence": {
      "artifact": "documents/work/reports/tck-00614.validation.2026-02-17.json",
      "receipts": [
        {
          "id": "EXEC-2026-02-17-CI-MERGE-POLICY",
          "command_receipt_id": "cmd_ci_merge_policy",
          "command": "cargo test -p apm2-cli --test ci_merge_policy_invariants",
          "exit_code": 0,
          "stdout_stderr_sha256": "7791cee5a9470b3a7cde9c9ecf68b37af4f42921941d9cb9ae878ec3dc331286"
        },
        {
          "id": "EXEC-2026-02-17-WORKSPACE-VALIDATION",
          "command_receipt_ids": [
            "cmd_fmt_all",
            "cmd_test_apm2_cli",
            "cmd_clippy_workspace",
            "cmd_doc_workspace",
            "cmd_test_workspace"
          ],
          "commands": [
            "cargo fmt --all",
            "cargo test -p apm2-cli",
            "cargo clippy --workspace --all-targets --all-features -- -D warnings",
            "cargo doc --workspace --no-deps",
            "cargo test --workspace"
          ],
          "exit_code": 0
        }
      ]
    }
  }
}

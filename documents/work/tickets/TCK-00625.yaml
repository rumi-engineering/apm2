ticket_meta:
  schema_version: "2026-02-20"
  template_version: "2026-02-20"
  ticket:
    id: "TCK-00625"
    title: "Technical handoff: FAC push INV-PADOPT-004 debug, binary alignment, and verified recovery"
    status: "MERGED"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements:
      - "REQ-HANDOFF-0001"
      - "REQ-HANDOFF-0002"
      - "REQ-HANDOFF-0003"
    evidence_artifacts:
      - "EVID-TCK00625-FAILURE-INV-PADOPT-004"
      - "EVID-TCK00625-BINARY-ALIGNMENT"
      - "EVID-TCK00625-PUSH-SUCCESS-2026-02-20"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
      - "AGENT_OPERATOR"
    responsibility_domains:
      - "DOMAIN_FAC_RUNTIME"
      - "DOMAIN_RELEASE_OPERATIONS"
      - "DOMAIN_SYSTEMD_EXECUTION"
  dependencies:
    tickets: []

requirements:
  - id: "REQ-HANDOFF-0001"
    statement: "Handoff MUST include concrete reproduction evidence for the INV-PADOPT-004 failure."
  - id: "REQ-HANDOFF-0002"
    statement: "Handoff MUST include all applied remediation steps with machine-verifiable commands."
  - id: "REQ-HANDOFF-0003"
    statement: "Handoff MUST include successful post-fix FAC push evidence with timestamp and PR linkage."

incident:
  summary: |
    On Friday, February 20, 2026, `apm2 fac push --json` failed in gates with:
    `policy hash not admitted (INV-PADOPT-004)`.
    Error payload showed `worker policy_hash=b3-256:13697...` while admitted policy root was
    `b3-256:5f2ab9...`.
  observed_failure:
    timestamp_utc: "2026-02-20T08:03:18Z"
    command: "apm2 fac push --json"
    failing_job_id: "gates-1771574593-045229956-3267145-0"
    failing_receipt_hash: "b3-256:f47bb5510b4bf261b834dfc96f840da9d33371e9a3e164e3a9da391d8be96f98"
    denial_reason_code: "policy_admission_denied"
    denial_reason: "policy hash not admitted (INV-PADOPT-004): worker policy_hash=b3-256:13697be984905c6330699b289429bd6aa3b3b7c0f203ac10c51e26d5ac08a365 is not the currently admitted digest"
  control_evidence:
    admitted_policy_root_hash: "b3-256:5f2ab9efb9be3e23f6bc6c10d4e13363d16453fad7050657981fead3394ea00d"
    policy_file_hash_via_validate: "b3-256:5f2ab9efb9be3e23f6bc6c10d4e13363d16453fad7050657981fead3394ea00d"
    token_binding_fac_policy_hash_for_failed_job: "b3-256:5f2ab9efb9be3e23f6bc6c10d4e13363d16453fad7050657981fead3394ea00d"

root_cause_analysis:
  primary_cause: |
    Runtime binary drift: interactive CLI resolution (`/home/ubuntu/.local/bin/apm2`) and
    systemd service execution (`/home/ubuntu/.cargo/bin/apm2`) were different binaries.
    This created non-deterministic behavior across producer/worker paths during gates orchestration.
  contributing_factors:
    - "Both binaries reported the same semantic version (`apm2 0.3.0`), masking drift."
    - "FAC gates wait logic can route work through external worker and inline worker fallback; path differences amplify binary mismatch impact."
  disproven_hypotheses:
    - "Admitted policy root corruption (root files were valid and matched expected admitted hash)."
    - "Policy file parse instability (repeated `apm2 fac policy validate` yielded stable hash 5f2ab9...)."

applied_remediation:
  timestamp_utc: "2026-02-20T08:02:00Z"
  steps:
    - id: "FIX-001"
      action: "Install current worktree binary globally to canonical service path."
      command: "cargo install --path crates/apm2-cli --force"
      result: "Replaced `/home/ubuntu/.cargo/bin/apm2` with worktree build."
    - id: "FIX-002"
      action: "Unify interactive CLI path with service path."
      command: "ln -sf /home/ubuntu/.cargo/bin/apm2 /home/ubuntu/.local/bin/apm2"
      result: "Both paths resolved to same executable digest."
    - id: "FIX-003"
      action: "Restart FAC daemon and worker services to pick up aligned binary."
      command: "systemctl --user restart apm2-daemon.service apm2-worker.service"
      result: "Both active PIDs executing `/home/ubuntu/.cargo/bin/apm2`."

machine_verification:
  binary_alignment:
    which_apm2: "/home/ubuntu/.local/bin/apm2"
    local_symlink: "/home/ubuntu/.local/bin/apm2 -> /home/ubuntu/.cargo/bin/apm2"
    sha256:
      cargo_bin: "dda22ac285af374fea329b5dadc6c4f3074aa72f14328123aef0b1c6d4a2ce22"
      local_bin: "dda22ac285af374fea329b5dadc6c4f3074aa72f14328123aef0b1c6d4a2ce22"
  service_execution_paths:
    daemon_execstart: "/home/ubuntu/.cargo/bin/apm2 daemon --no-daemon"
    worker_execstart: "/home/ubuntu/.cargo/bin/apm2 fac worker --poll-interval-secs 10"
    daemon_status: "active (running)"
    worker_status: "active (running)"
  post_fix_push:
    timestamp_utc: "2026-02-20T08:14:54Z"
    command: "apm2 fac push --json"
    result_status: "pass"
    pr_number: 769
    pr_url: "https://github.com/guardian-intelligence/apm2/pull/769"
    branch: "ticket/RFC-0019/TCK-00624"
    head_sha: "08ed9a1ad75d394b6f481930380629ad1a9a5954"
    gate_summary:
      merge_conflict_main: "PASS"
      rustfmt: "PASS"
      doc: "PASS"
      clippy: "PASS"
      test_safety_guard: "PASS"
      test: "PASS"
      workspace_integrity: "PASS"
      review_artifact_lint: "PASS"

commands_executed:
  - "which apm2"
  - "systemctl --user cat apm2-worker.service"
  - "systemctl --user cat apm2-daemon.service"
  - "cargo install --path crates/apm2-cli --force"
  - "ln -sf /home/ubuntu/.cargo/bin/apm2 /home/ubuntu/.local/bin/apm2"
  - "systemctl --user restart apm2-daemon.service"
  - "systemctl --user restart apm2-worker.service"
  - "apm2 fac config show --json"
  - "apm2 fac policy validate ~/.apm2/private/fac/policy/fac_policy.v1.json --json"
  - "apm2 fac push --json"

residual_risks:
  - id: "RISK-001"
    level: "MEDIUM"
    detail: "No explicit doctor invariant currently fails when interactive CLI and systemd binaries diverge by digest."
  - id: "RISK-002"
    level: "LOW"
    detail: "Inline worker fallback path still increases behavioral surface area during worker heartbeat transitions."

recommended_followups:
  - id: "FU-001"
    detail: "Add doctor check: compare digest of `which apm2` vs digest of service `ExecStart` binary and fail when mismatched."
  - id: "FU-002"
    detail: "Add explicit `apm2 fac install --global` (or equivalent) to enforce one canonical runtime binary path."
  - id: "FU-003"
    detail: "Emit runtime binary path+digest at worker startup in JSON event stream for postmortem correlation."

definition_of_done:
  evidence_ids:
    - "EVID-TCK00625-FAILURE-INV-PADOPT-004"
    - "EVID-TCK00625-BINARY-ALIGNMENT"
    - "EVID-TCK00625-PUSH-SUCCESS-2026-02-20"
  criteria:
    - "Failure and recovery are documented with concrete timestamps, job IDs, and receipt hashes."
    - "Remediation steps are reproducible via listed commands."
    - "At least one post-remediation `apm2 fac push --json` run completed with status `pass`."

notes:
  operator_runbook: |
    If INV-PADOPT-004 reappears with inconsistent policy hash evidence:
    1) verify binary digests for `which apm2` and service ExecStart targets;
    2) reinstall current binary to canonical path;
    3) relink interactive path;
    4) restart daemon/worker;
    5) rerun `apm2 fac push --json` and capture new receipt hash.

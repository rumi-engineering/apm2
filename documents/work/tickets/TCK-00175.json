{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00175",
      "title": "Implement E2E lifecycle and budget tests",
      "status": "CLOSED"
    },
    "binds": {
      "rfc_id": "RFC-0013",
      "requirements": [
        {
          "requirement_id": "REQ-EPISODE-001"
        },
        {
          "requirement_id": "REQ-DAEMON-001"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00174"
      }
    ]
  },
  "acceptance_criteria": [
    {
      "criterion": "E2E test suite covering episode lifecycle",
      "verification": "Tests pass with create/start/stop cycle"
    },
    {
      "criterion": "Budget exhaustion scenarios",
      "verification": "Episode terminates on budget limit"
    },
    {
      "criterion": "Termination enforcement",
      "verification": "Stop order terminates running episode"
    }
  ],
  "implementation": {
    "code_examples": [
      {
        "description": "E2E lifecycle test",
        "code": "#[tokio::test]\nasync fn test_episode_lifecycle() {\n    let daemon = TestDaemon::start().await;\n    let client = daemon.client();\n\n    // Create episode\n    let envelope = test_envelope();\n    let episode_id = client.create(envelope).await.unwrap();\n\n    // Start episode\n    let handle = client.start(&episode_id).await.unwrap();\n    assert_eq!(client.status(&episode_id).await.unwrap(), EpisodeState::Running);\n\n    // Stop episode\n    client.stop(&episode_id, StopReason::Normal).await.unwrap();\n    assert_eq!(client.status(&episode_id).await.unwrap(), EpisodeState::Terminated);\n}\n"
      }
    ],
    "files_to_create": [
      {
        "path": "crates/apm2-daemon/tests/e2e_lifecycle.rs",
        "purpose": "E2E episode lifecycle tests"
      },
      {
        "path": "crates/apm2-daemon/tests/common/mod.rs",
        "purpose": "Test utilities and helpers"
      },
      {
        "path": "crates/apm2-daemon/tests/common/daemon.rs",
        "purpose": "TestDaemon helper for E2E tests"
      }
    ],
    "files_to_modify": [
      {
        "changes": "Add test dependency on tempfile, tokio-test",
        "path": "crates/apm2-daemon/Cargo.toml"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Create TestDaemon helper",
        "details": "TestDaemon struct:\n- start(): spawn daemon in temp directory\n- client(): get test client\n- stop(): terminate daemon\n- cleanup(): remove temp files\n"
      },
      {
        "step": 2,
        "action": "Implement lifecycle tests",
        "details": "Test scenarios:\n- Happy path: create -> start -> stop\n- Concurrent episodes\n- Episode status queries\n- Invalid transitions (start twice, stop twice)\n"
      },
      {
        "step": 3,
        "action": "Implement budget exhaustion tests",
        "details": "Test scenarios:\n- Token budget exhaustion\n- Wall time exhaustion\n- CPU time exhaustion\n- Verify BUDGET_EXHAUSTED event\n"
      },
      {
        "step": 4,
        "action": "Implement termination tests",
        "details": "Test scenarios:\n- Normal stop\n- Signal delivery (SIGTERM, SIGKILL)\n- Quarantine on crash\n- Evidence pinning on failure\n"
      },
      {
        "step": 5,
        "action": "Verify event emission",
        "details": "Assert events emitted:\n- episode.created\n- episode.started\n- episode.stopped / episode.quarantined\n- budget.exhausted (when applicable)\n"
      }
    ],
    "summary": "Implement E2E test suite covering episode lifecycle and budget enforcement.\nTests create/start/stop cycles, budget exhaustion, and termination enforcement.\nUses TestDaemon helper for isolated test environment.\n"
  },
  "notes": "Phase: PHASE-4 (Integration and CLI)\nGenerated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.\nMaps to TCK-PEND-018a.\n",
  "test_requirements": [
    {
      "description": "Lifecycle E2E",
      "test_id": "E2E-00175-01",
      "verification_command": "cargo test -p apm2-daemon --test e2e_lifecycle"
    },
    {
      "description": "Budget exhaustion E2E",
      "test_id": "E2E-00175-02",
      "verification_command": "cargo test -p apm2-daemon --test e2e_budget"
    }
  ]
}

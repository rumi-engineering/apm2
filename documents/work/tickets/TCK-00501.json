{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00501",
      "title": "Crash-safe effect execution: effect journal + RequestId idempotency key propagation + fail-closed in-doubt handling",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0010",
      "rfc_id": "RFC-0019",
      "requirements": [
        {
          "requirement_id": "REQ-0029",
          "requirement_ref": "documents/rfcs/RFC-0019/requirements/REQ-0029.yaml#requirement"
        }
      ],
      "evidence_artifacts": [
        {
          "evidence_id": "EVID-0024",
          "artifact_ref": "documents/rfcs/RFC-0019/evidence_artifacts/EVID-0024.yaml#evidence_artifact"
        }
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER",
        "AGENT_REVIEWER",
        "AGENT_QA"
      ],
      "responsibility_domains": [
        "DOMAIN_SECURITY",
        "DOMAIN_RUNTIME"
      ]
    },
    "dependencies": {
      "tickets": [
        {
          "ticket_id": "TCK-00488",
          "reason": "Kernel defines plan/execute phases and effect boundary."
        }
      ]
    },
    "scope": {
      "in_scope": [
        "Define effect execution journal keyed by RequestId with states: NotStarted/Started/Completed/Unknown.",
        "Persist journal transitions with sufficient binding data to resume deterministically after restart:",
        "  - request digest, as_of anchor, policy root digest/epoch, witness seeds (or derivation params), boundary profile + tier, join id/selectors.",
        "Persist transitions atomically with consume/execute phases as required to classify crash windows.",
        "Propagate an idempotency key derived from RequestId into tool/broker calls where supported.",
        "For fail-closed tiers, define fail-closed behavior for Unknown state:",
        "  - no output release (including streaming),",
        "  - containment/quarantine per policy,",
        "  - deny re-execution unless effect is declared idempotent and boundary confirms not executed."
      ],
      "out_of_scope": [
        "Guaranteeing exactly-once semantics for external systems that do not support idempotency keys (future)."
      ]
    },
    "plan": {
      "steps": [
        "Define journal storage (bounded, indexed, restart-safe).",
        "Integrate journal transitions into AdmissionKernel execute phase.",
        "Add tool/broker adapter support for RequestId idempotency key propagation.",
        "Add crash-window tests:",
        "  - crash after consume before effect,",
        "  - crash during effect,",
        "  - crash after effect before receipts."
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-0024"
      ],
      "criteria": [
        "Restart tests classify crash windows deterministically.",
        "Fail-closed tiers fail closed on Unknown and do not leak outputs.",
        "Where adapters support it, external calls carry RequestId idempotency key."
      ]
    },
    "notes": {
      "security": "Consume-before-effect is only safe if restarts do not create effect duplication or silent leakage.\nThis ticket makes the crash window explicit and enforceable.\n"
    }
  }
}

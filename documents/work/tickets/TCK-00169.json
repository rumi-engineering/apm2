{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00169",
      "title": "Implement TelemetryCollector and frame streaming",
      "status": "CLOSED"
    },
    "binds": {
      "rfc_id": "RFC-0013",
      "requirements": [
        {
          "requirement_id": "REQ-TEL-001"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00168"
      }
    ]
  },
  "acceptance_criteria": [
    {
      "criterion": "TelemetryCollector per CTR-DAEMON-005",
      "verification": "All methods implemented and tested"
    },
    {
      "criterion": "Configurable sample interval",
      "verification": "Frames emitted at configured rate"
    },
    {
      "criterion": "Integration with budget accounting",
      "verification": "Telemetry informs budget consumption"
    }
  ],
  "implementation": {
    "code_examples": [
      {
        "description": "TelemetryCollector structure",
        "code": "pub struct TelemetryCollector {\n    cgroup_reader: CgroupReader,\n    sample_interval_ms: u64,\n    ring_buffer: RingBuffer<TelemetryFrame>,\n}\n\nimpl TelemetryCollector {\n    pub fn start(&self, episode_id: EpisodeId, pid: Pid) -> TelemetryHandle;\n    pub async fn collect(&self, handle: &TelemetryHandle) -> TelemetryFrame;\n    pub fn apply_policy(&mut self, policy: TelemetryPolicy);\n}\n\npub struct TelemetryFrame {\n    pub episode_id: EpisodeId,\n    pub seq: u64,\n    pub ts_mono: u64,\n    pub cpu_ns: u64,\n    pub mem_rss_bytes: u64,\n    pub io_read_bytes: u64,\n    pub io_write_bytes: u64,\n    pub o11y_flags: O11yFlags,\n}\n"
      }
    ],
    "files_to_create": [
      {
        "path": "crates/apm2-daemon/src/telemetry/collector.rs",
        "purpose": "TelemetryCollector implementation"
      },
      {
        "path": "crates/apm2-daemon/src/telemetry/frame.rs",
        "purpose": "TelemetryFrame type"
      },
      {
        "path": "crates/apm2-daemon/src/telemetry/policy.rs",
        "purpose": "TelemetryPolicy configuration"
      },
      {
        "path": "crates/apm2-daemon/src/telemetry/handle.rs",
        "purpose": "TelemetryHandle for active collection"
      }
    ],
    "files_to_modify": [
      {
        "changes": "Export collector, frame, policy, handle modules",
        "path": "crates/apm2-daemon/src/telemetry/mod.rs"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Define TelemetryFrame",
        "details": "Create frame type per CTR-DAEMON-005:\n- episode_id, seq, ts_mono\n- cpu_ns, cpu_user_ns, cpu_system_ns\n- mem_rss_bytes, mem_peak_bytes\n- io metrics, net metrics (optional)\n- o11y_flags for sampling mode\n"
      },
      {
        "step": 2,
        "action": "Implement TelemetryCollector",
        "details": "Create collector per CTR-DAEMON-005:\n- start(): begin collection for episode\n- collect(): read metrics, emit frame\n- apply_policy(): configure sampling\n"
      },
      {
        "step": 3,
        "action": "Implement collection loop",
        "details": "Spawn async task for collection:\n- Sleep for sample_interval\n- Read metrics from CgroupReader\n- Compute deltas from previous\n- Push to ring buffer\n- Send to output channel\n"
      },
      {
        "step": 4,
        "action": "Implement TelemetryPolicy",
        "details": "Create policy configuration:\n- sample_period_ms: collection interval\n- promote_triggers: when to persist full buffer\n- ring_buffer_limits: size per tier\n"
      },
      {
        "step": 5,
        "action": "Integrate with budget accounting",
        "details": "Report consumption to BudgetTracker:\n- cpu_ms from telemetry\n- bytes_io from telemetry\n- Check limits, trigger stop if exhausted\n"
      }
    ],
    "summary": "Implement TelemetryCollector and frame streaming per CTR-DAEMON-005.\nCollects resource metrics at configurable intervals with ring buffer.\nIntegrates with budget accounting for limit enforcement.\n"
  },
  "notes": "Phase: PHASE-2C (Telemetry Collection)\nGenerated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.\nMaps to TCK-PEND-012.\n",
  "test_requirements": [
    {
      "description": "Frame collection",
      "test_id": "UT-00169-01",
      "verification_command": "cargo test -p apm2-daemon telemetry_collect"
    },
    {
      "description": "Sample interval",
      "test_id": "UT-00169-02",
      "verification_command": "cargo test -p apm2-daemon sample_interval"
    },
    {
      "description": "Budget integration",
      "test_id": "IT-00169-01",
      "verification_command": "cargo test -p apm2-daemon --test integration telemetry_budget"
    }
  ]
}

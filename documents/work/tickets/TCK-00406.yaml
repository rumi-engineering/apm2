ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00406"
    title: "Close model-only security changes by enforcing authoritative runtime wiring"
    status: "OPEN"
  binds:
    prd_id: "PRD-0010"
    rfc_id: "RFC-0020"
    requirements:
      - requirement_id: "REQ-0030"
        requirement_ref: "documents/rfcs/RFC-0020/requirements/REQ-0030.yaml#requirement"
      - requirement_id: "REQ-0004"
        requirement_ref: "documents/rfcs/RFC-0020/requirements/REQ-0004.yaml#requirement"
    evidence_artifacts:
      - evidence_id: "EVID-0001"
        artifact_ref: "documents/rfcs/RFC-0020/evidence_artifacts/EVID-0001.yaml#evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
      - "AGENT_REVIEWER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
      - "DOMAIN_SECURITY"
      - "DOMAIN_ORCHESTRATION"
  dependencies:
    tickets:
      - ticket_id: "TCK-00339"
        reason: "Taint model exists but fail reviews identified missing production-path enforcement."
      - ticket_id: "TCK-00350"
        reason: "Envelope/binding model exists but fail reviews identified missing spawn/resume enforcement."
      - ticket_id: "TCK-00393"
        reason: "Watchdog logic exists but fail reviews identified missing durable freeze/runtime closure."
      - ticket_id: "TCK-00391"
        reason: "Lifecycle tests exist but fail reviews identified missing authoritative IPC-path coverage."
  scope:
    in_scope:
      - "Require authoritative runtime callsites for new security-critical models before merge."
      - "Wire taint-policy flow checks into production ingress/context paths (not module-only exports)."
      - "Wire envelope gate validation into production spawn/resume path (fail closed on missing/malformed bindings)."
      - "Wire divergence freeze/unfreeze behavior into durable ledger-backed runtime path."
      - "Require at least one in-process daemon integration test per touched security boundary (IPC -> dispatcher -> ledger/CAS effect)."
      - "Add a review checklist gate that blocks PRs when security code changes have no non-test runtime callsite."
    out_of_scope:
      - "New taint taxonomy design."
      - "New protocol surface unrelated to the identified runtime-wiring gaps."
      - "Performance benchmarking beyond functional closure."
  plan:
    steps:
      - "Create a runtime-closure checklist artifact consumed by CI/review scripts for SECURITY/QCP=YES PRs."
      - "Implement production-path taint enforcement hooks and emit deny records for forbidden flows."
      - "Invoke envelope gate checks from spawn/resume dispatch path before episode creation."
      - "Persist watchdog freeze state transitions as durable ledger events and assert fail-closed startup when required dependencies are absent."
      - "Add integration tests that drive real protocol handlers and assert runtime side effects for each closure path."
      - "Add static check ensuring security modules changed in PR diff have at least one production callsite diff unless explicitly waived."
      - "Run cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings && cargo test --workspace."
  definition_of_done:
    evidence_ids:
      - "EVID-0001"
    criteria:
      - "Security model changes cannot merge without authoritative runtime wiring or explicit waiver."
      - "Taint policy enforcement is exercised by production-path integration tests."
      - "Spawn/resume envelope gate validation is exercised by production-path integration tests."
      - "Watchdog freeze path is durably persisted and tested in daemon runtime context."
      - "CI fails when SECURITY/QCP=YES PRs modify security modules without production-path coverage."
  notes:
    context: |
      Multiple failed re-reviews showed the same pattern: strong model-layer changes
      merged without closing the runtime boundary loop. This ticket addresses the
      root pattern by making authoritative wiring and integration evidence mandatory.

      Triggering PRs from incident set include #442, #448, #449, #453.
    files: |
      - crates/apm2-daemon/src/protocol/dispatch.rs
      - crates/apm2-daemon/src/protocol/session_dispatch.rs
      - crates/apm2-daemon/src/main.rs
      - crates/apm2-core/src/fac/taint.rs
      - crates/apm2-daemon/tests/
      - scripts/review/
    security: |
      - Missing enforcement dependency must deny by default.
      - Runtime-closure checks are mandatory for SECURITY/QCP=YES changes.
      - Waiver path must be explicit, auditable, and time-bounded.


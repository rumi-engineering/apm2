{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00140",
      "title": "Implement TargetProfile schema",
      "status": "CLOSED"
    },
    "binds": {
      "prd_id": "PRD-0007",
      "rfc_id": "RFC-0011",
      "requirements": [
        {
          "requirement_id": "CAC-REQ-0005",
          "requirement_ref": "documents/prds/PRD-0007/requirements/REQ-0005.yaml#prd_requirement"
        },
        {
          "requirement_id": "CAC-REQ-0013",
          "requirement_ref": "documents/prds/PRD-0007/requirements/REQ-0013.yaml#prd_requirement"
        }
      ],
      "evidence_artifacts": [
        "EVID-0006",
        "EVID-0009"
      ]
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_KERNEL",
        "DOMAIN_COMPILER"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00128"
      ]
    },
    "scope": {
      "in_scope": [
        "Define TargetProfile struct with rendering, budget, and retrieval policies",
        "Define RenderingPolicy with stage taxonomy (plan/implement/review/ops)",
        "Define BudgetPolicy with typed quantities for token/artifact/byte limits",
        "Define RetrievalPolicy with max_fetch_bytes and inline_threshold",
        "Define DeliveryConstraints for vendor-specific output requirements",
        "Implement JSON Schema validation via existing CAC validator",
        "Use #[serde(deny_unknown_fields)] for strict parsing",
        "Implement validated constructors per CTR-1205"
      ],
      "out_of_scope": [
        "Export pipeline implementation (TCK-00141)",
        "Conformance testing framework",
        "CLI commands"
      ]
    },
    "plan": {
      "steps": [
        "Create crates/apm2-core/src/cac/target_profile.rs module",
        "Define TargetProfile struct with profile_id, version, description",
        "Define RenderingPolicy struct with stage enum and format constraints",
        "Define BudgetPolicy struct with TypedQuantity fields per DD-0007",
        "Define RetrievalPolicy struct with max_fetch_bytes, inline_threshold defaults",
        "Define DeliveryConstraints struct with output_format, provenance_embed settings",
        "Implement TargetProfileBuilder with validate() returning Result<TargetProfile, Error>",
        "Add serde attributes: deny_unknown_fields, default for optional policies",
        "Write unit tests for all policy combinations",
        "Write validation tests for invalid configurations"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [
        "EVID-0006",
        "EVID-0009"
      ],
      "criteria": [
        "TargetProfile struct compiles with all required fields",
        "RenderingPolicy supports plan/implement/review/ops stages",
        "BudgetPolicy uses typed quantities (tokens, bytes, count)",
        "Unknown fields in JSON/YAML rejected with clear error",
        "Builder validates budget limits are non-negative",
        "All tests pass: cargo test target_profile"
      ]
    },
    "notes": {
      "security": "Strict parsing prevents hidden field injection in target profiles",
      "architecture": "DD-0005 specifies TargetProfile decouples CAC-JSON from vendor layouts.\nFollow RoutingProfile patterns in crates/apm2-core/src/model_router/profile.rs:\n- Use HashMap<String, ProviderConfig> pattern for stage mappings\n- Apply RetryPolicy/timeout validation patterns\n- Use #[serde(deny_unknown_fields)] consistently\n\nFollow Policy schema patterns in crates/apm2-core/src/policy/schema.rs:\n- Use #[non_exhaustive] on enums for forward compatibility\n- Use typed wrappers (BudgetType, Decision) for constraint enforcement\n",
      "rust_textbook_refs": [
        {
          "file": ".claude/skills/rust-textbook/12_api_design_stdlib_quality.md",
          "rules": [
            "CTR-1201: Public API Contract Must Be Explicit",
            "CTR-1205: Construction Protocols Must Be Validated"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/16_io_protocol_boundaries.md",
          "rules": [
            "CTR-1604: Strict Serde for Audit and Ledger Types (#[serde(deny_unknown_fields)])"
          ]
        },
        {
          "file": ".claude/skills/rust-textbook/07_errors_panics_diagnostics.md",
          "rules": [
            "CTR-0703: Error Types Must Be Structured When Callers Branch on Cause"
          ]
        }
      ],
      "codebase_context": {
        "files_to_reference": [
          {
            "path": "crates/apm2-core/src/model_router/profile.rs",
            "purpose": "Pattern for profile struct with stages HashMap, validation, #[serde(deny_unknown_fields)]"
          },
          {
            "path": "crates/apm2-core/src/policy/schema.rs",
            "purpose": "Pattern for RuleType enum, BudgetType, #[non_exhaustive] usage"
          }
        ],
        "files_to_create": [
          {
            "path": "crates/apm2-core/src/cac/target_profile.rs",
            "purpose": "TargetProfile schema implementation"
          }
        ],
        "files_to_modify": [
          {
            "path": "crates/apm2-core/src/cac/mod.rs",
            "purpose": "Export target_profile module"
          }
        ]
      }
    }
  }
}

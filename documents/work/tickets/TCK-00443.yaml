ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00443"
    title: "Dispatch idempotency, join semantics, and SHA-drift-safe resume"
    status: "OPEN"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0018"
    requirements:
      - requirement_id: "REQ-HEF-0021"
        requirement_ref: "documents/rfcs/RFC-0018/requirements/REQ-HEF-0021.yaml#rfc_requirement"
    evidence_artifacts:
      - evidence_id: "EVID-HEF-0018"
        artifact_ref: "documents/rfcs/RFC-0018/evidence_artifacts/EVID-HEF-0018.yaml#rfc_evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
      - "AGENT_REVIEWER"
      - "AGENT_QA"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
      - "DOMAIN_RELIABILITY"
  dependencies:
    tickets:
      - ticket_id: "TCK-00441"
        reason: "Dispatch identity/state schemas must be stable first."
  scope:
    in_scope:
      - "Implement idempotent dispatch keys for `(repo, pr_number, review_type, head_sha)`."
      - "Implement join semantics so concurrent equivalent requests attach to one authoritative run."
      - "Implement SHA drift detection and kill+resume with explicit old/new SHA lineage bindings."
      - "Emit fail-closed terminal state for ambiguous dispatch ownership or stale-head ambiguity."
    out_of_scope:
      - "Workflow trust preflight policy."
      - "Telemetry projection formatting and 1Hz status output."
  plan:
    steps:
      - "Define dispatch identity key canonicalization and storage contract."
      - "Implement in-flight run registry and join behavior for duplicate dispatches."
      - "Add head-SHA monitoring and deterministic resume transitions."
      - "Add concurrency tests for duplicate and race dispatch scenarios."
      - "Run required runtime and CI checks."
  definition_of_done:
    evidence_ids:
      - "EVID-HEF-0018"
    criteria:
      - "Equivalent dispatches are deduplicated and return a shared run identity."
      - "SHA movement terminates stale run and resumes with explicit lineage evidence."
      - "Ambiguous dispatch state denies with structured error codes."
  notes:
    security: |
      Dispatch ambiguity must be fail-closed to prevent split-brain reviewer authority.
    verification: |
      Include adversarial concurrency and SHA-churn integration tests.
    general: |
      This ticket provides deterministic lifecycle identity for higher-level monitoring and workflow projection.

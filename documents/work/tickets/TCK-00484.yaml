ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00484"
    title: "Extract PrivilegedPcacInputBuilder for reusable join-input construction"
    status: "OPEN"
  binds:
    prd_id: "PRD-0009"
    rfc_id: "RFC-0027"
    requirements:
      - requirement_id: "REQ-0006"
        requirement_ref: "documents/rfcs/RFC-0027/requirements/REQ-0006.yaml#requirement"
    evidence_artifacts:
      - evidence_id: "EVID-0003"
        artifact_ref: "documents/rfcs/RFC-0027/evidence_artifacts/EVID-0003.yaml#evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
      - "DOMAIN_SECURITY"
  dependencies:
    tickets:
      - ticket_id: "TCK-00482"
        reason: "DelegateSublease cutover reveals the shared domain-tagged hash construction pattern."
      - ticket_id: "TCK-00483"
        reason: "IngestReviewReceipt cutover reveals the same pattern; extraction follows both cutovers."
  scope:
    in_scope:
      - "Extract a PrivilegedPcacInputBuilder (or equivalent typed builder) that standardizes domain-tagged BLAKE3 hash construction for privileged handler join inputs."
      - "Currently each handler manually constructs 5-6 domain-tagged hashes (capability, scope, freshness, stop-budget, intent) with handler-specific domain separation tags â€” ~55 lines per hash, ~275 lines per handler."
      - "Builder should accept typed handler context (lease, identity, delegation chain, intent fields) and produce a validated AuthorityJoinInputV1."
      - "Domain separation tags remain handler-specific (builder parameterized by handler class, not generic)."
      - "Refactor DelegateSublease and IngestReviewReceipt to use the builder."
      - "Ensure any future authority-bearing handler can adopt PCAC via builder + 3 kernel calls (~20-50 lines total)."
    out_of_scope:
      - "Changes to the PCAC kernel API or core types."
      - "RequestTool handler refactoring (its join input construction is session-path specific)."
      - "Distributed admission family or federation paths."
  plan:
    steps:
      - "Analyze domain-tagged hash construction patterns across DelegateSublease and IngestReviewReceipt post-cutover."
      - "Define PrivilegedPcacInputBuilder with handler-class-parameterized domain tags and typed input slots."
      - "Implement builder with validation (fail-closed on missing required fields, zero-length inputs, unresolvable hashes)."
      - "Refactor both handlers to use builder; verify identical join inputs via round-trip test."
      - "Run cargo fmt --all && cargo clippy --workspace --all-targets --all-features -- -D warnings && cargo doc --workspace --no-deps && cargo test --workspace."
  definition_of_done:
    evidence_ids:
      - "EVID-0003"
    criteria:
      - "Shared builder produces identical AuthorityJoinInputV1 as the current inline construction for both handlers."
      - "Handler-specific domain separation tags are preserved (no cross-handler tag collisions)."
      - "Future handlers can adopt PCAC with builder + 3 kernel calls in ~20-50 lines."
      - "Estimated ~250-400 lines of duplicated hash construction deleted across both handlers."
  notes:
    security: |
      Builder must preserve domain separation invariants. Handler-class-specific domain tags prevent
      cross-handler confused-deputy attacks where a join input for one handler class could be replayed
      against another. Builder parameterization by handler class makes this structural.
    verification: |
      Round-trip test: inline construction and builder construction must produce byte-identical
      AuthorityJoinInputV1 for the same inputs. Property test: builder rejects all-zero and
      over-length inputs.
    general: |
      This is the code-reduction payoff ticket. After TCK-00482 and TCK-00483 make PCAC mandatory
      and delete scattered checks, this ticket collapses the remaining duplicated hash construction
      into a shared builder. Combined with the cutover tickets, total estimated reduction is
      ~500-800 lines across both handlers, and new handlers start at ~20-50 lines instead of ~400.

ticket_meta:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"
  ticket:
    id: "TCK-00085"
    title: "Implement GitHub webhook handler for workflow_run.completed"
  binds:
    prd_id: "PRD-0004"
    rfc_id: "RFC-0008"
    requirements:
      - requirement_id: "REQ-0015"
        requirement_ref: "documents/prds/PRD-0004/requirements/REQ-0015.yaml#prd_requirement"
    evidence_artifacts:
      - "EVID-8001"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
      - "DOMAIN_SECURITY"
  dependencies:
    tickets: []
  scope:
    in_scope:
      - "Create HTTP endpoint POST /webhooks/github using axum"
      - "Implement HMAC-SHA256 signature validation"
      - "Parse X-Hub-Signature-256 header"
      - "Parse X-GitHub-Event and X-GitHub-Delivery headers"
      - "Parse workflow_run.completed payload structure"
      - "Add rate limiting to prevent abuse"
      - "Add feature flag WEBHOOK_HANDLER_ENABLED"
      - "Return appropriate HTTP status codes (200, 202, 400, 401, 429)"
      - "Log webhook requests for audit trail"
    out_of_scope:
      - "Ledger event emission (TCK-00086)"
      - "Task queue integration (TCK-00087)"
      - "Other webhook event types (check_run, pull_request, etc.)"
      - "Webhook redelivery handling"
  plan:
    steps:
      - "Add axum, hmac, sha2 dependencies to apm2-core/Cargo.toml"
      - "Create webhook module structure: crates/apm2-core/src/webhook/"
      - "Implement SignatureValidator with HMAC-SHA256 verification"
      - "Create WebhookPayload structs for workflow_run.completed"
      - "Implement axum handler with signature extraction from headers"
      - "Add rate limiting middleware"
      - "Add feature flag check at handler entry"
      - "Write unit tests for signature validation"
      - "Write unit tests for payload parsing"
      - "Write integration test for full handler flow"
  definition_of_done:
    evidence_ids:
      - "EVID-8001"
    criteria:
      - "Webhook endpoint accepts POST requests"
      - "X-Hub-Signature-256 header is parsed and validated"
      - "Valid signatures return 200 or 202"
      - "Invalid signatures return 401 Unauthorized"
      - "Malformed payloads return 400 Bad Request"
      - "Rate limit exceeded returns 429 Too Many Requests"
      - "Feature flag WEBHOOK_HANDLER_ENABLED controls endpoint"
      - "All webhook requests are logged with IP and delivery_id"
      - "Unit tests pass for signature validation"
      - "Integration test passes for handler flow"
  notes:
    security: |
      This ticket establishes the security foundation for the webhook system.
      Key security properties:
      - Signature validation uses constant-time comparison to prevent timing attacks
      - Secret is loaded from environment variable (not hardcoded)
      - Logging excludes the secret and signature (prevent accidental exposure)
      - Rate limiting prevents denial of service

      The webhook secret MUST be:
      - At least 32 bytes of cryptographically random data
      - Stored securely (environment variable or secrets manager)
      - Never logged or exposed in error messages
    implementation_details: |
      Axum handler structure:
      ```rust
      async fn webhook_handler(
          State(config): State<WebhookConfig>,
          headers: HeaderMap,
          body: Bytes,
      ) -> Result<StatusCode, WebhookError> {
          // 1. Check feature flag
          if !config.webhook_handler_enabled {
              return Err(WebhookError::Disabled);
          }

          // 2. Extract and validate signature
          let signature = headers
              .get("X-Hub-Signature-256")
              .ok_or(WebhookError::MissingSignature)?;
          config.validator.verify(&body, signature)?;

          // 3. Parse payload
          let event_type = headers.get("X-GitHub-Event");
          let delivery_id = headers.get("X-GitHub-Delivery");
          let payload: WorkflowRunPayload = serde_json::from_slice(&body)?;

          // 4. Process (Phase 0: just log and return)
          tracing::info!(delivery_id = ?delivery_id, "Webhook received");

          Ok(StatusCode::ACCEPTED)
      }
      ```
    affected_files: |
      New:
        - crates/apm2-core/src/webhook/mod.rs
        - crates/apm2-core/src/webhook/signature.rs
        - crates/apm2-core/src/webhook/handler.rs
        - crates/apm2-core/src/webhook/payload.rs
      Modified:
        - crates/apm2-core/src/lib.rs (add webhook module)
        - crates/apm2-core/Cargo.toml (add axum, hmac, sha2)

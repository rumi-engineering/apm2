acceptance_criteria:
  - criterion: Per-episode ring buffers for PTY, tool I/O, telemetry
    verification: Buffers maintain bounded size per episode
  - criterion: Configurable buffer sizes per risk tier
    verification: Tier 3 gets larger buffers than tier 1
  - criterion: Persistence on trigger events
    verification: Buffer contents written to CAS on trigger
implementation:
  code_examples:
    - description: FlightRecorder structure
      code: |
        pub struct FlightRecorder {
            pty_buffer: RingBuffer<PtyOutput>,
            tool_buffer: RingBuffer<ToolEvent>,
            telemetry_buffer: RingBuffer<TelemetryFrame>,
            config: RecorderConfig,
        }

        impl FlightRecorder {
            pub fn new(risk_tier: RiskTier) -> Self;
            pub fn push_pty(&mut self, output: PtyOutput);
            pub fn push_tool(&mut self, event: ToolEvent);
            pub fn push_telemetry(&mut self, frame: TelemetryFrame);
            pub async fn persist(&self, cas: &ContentAddressedStore) -> Result<Vec<Hash>>;
            pub fn clear(&mut self);
        }
  files_to_create:
    - path: crates/apm2-daemon/src/evidence/recorder.rs
      purpose: FlightRecorder implementation
    - path: crates/apm2-daemon/src/evidence/config.rs
      purpose: RecorderConfig per risk tier
    - path: crates/apm2-daemon/src/evidence/trigger.rs
      purpose: Trigger conditions for persistence
  files_to_modify:
    - changes: Export recorder, config, trigger modules
      path: crates/apm2-daemon/src/evidence/mod.rs
  implementation_steps:
    - step: 1
      action: Define RecorderConfig
      details: |
        Configuration per risk tier per AD-EVID-001:
        - Tier 1: pty=1MB, tool=512KB, telemetry=256KB
        - Tier 2: pty=4MB, tool=2MB, telemetry=1MB
        - Tier 3+: pty=16MB, tool=8MB, telemetry=4MB
    - step: 2
      action: Implement FlightRecorder
      details: |
        Create recorder with:
        - Three ring buffers (PTY, tool, telemetry)
        - push_* methods for each type
        - persist() flushes to CAS
        - clear() empties all buffers
    - step: 3
      action: Implement persistence
      details: |
        persist() method:
        - Serialize each buffer to bytes
        - Store in CAS with content hash
        - Return evidence hashes
        - Emit evidence.pinned events
    - step: 4
      action: Define trigger conditions
      details: |
        Per AD-EVID-001, persist on:
        - Gate failure
        - Policy violation
        - Budget exhaustion
        - Crash/kill
        - Explicit pin request
    - step: 5
      action: Integrate with episode lifecycle
      details: |
        EpisodeRuntime integration:
        - Create recorder on episode create
        - Push data during execution
        - Persist on triggers
        - Clear on normal termination
  summary: |
    Implement flight recorder with ring buffers per AD-EVID-001.
    Per-episode buffers for PTY, tool I/O, and telemetry with configurable
    sizes per risk tier. Persistence triggered on failures/violations.
notes: |
  Phase: PHASE-3A (Evidence Economics)
  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.
  Maps to TCK-PEND-013.
schema_version: "2026-01-27"
template_version: "2026-01-27"
test_requirements:
  - description: Ring buffer bounds
    test_id: UT-00170-01
    verification_command: cargo test -p apm2-daemon recorder_bounds
  - description: Persistence to CAS
    test_id: UT-00170-02
    verification_command: cargo test -p apm2-daemon recorder_persist
  - description: Tier configuration
    test_id: UT-00170-03
    verification_command: cargo test -p apm2-daemon recorder_config
ticket:
  depends_on:
    - TCK-00161
    - TCK-00169
  id: TCK-00170
  requirement_ids:
    - REQ-EVID-001
  rfc_id: RFC-0013
  status: READY
  title: Implement flight recorder with ring buffers

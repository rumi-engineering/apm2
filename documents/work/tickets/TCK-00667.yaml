ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00667"
    title: "FAC review CLI: switch orchestration to daemon DispatchReviewer + pulse wait; deprecate systemd-run detached dispatch and PID-based liveness"
    status: "OPEN"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0032"
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_CLI", "DOMAIN_DAEMON", "DOMAIN_PROTOCOL", "DOMAIN_RUNTIME"]
  dependencies:
    tickets:
      - ticket_id: "TCK-00647"
        reason: "DispatchReviewer provides daemon-owned workspace + reviewer episode boundary."
      - ticket_id: "TCK-00654"
        reason: "CLI wait integration should use pulse subscriptions instead of ad-hoc polling."
      - ticket_id: "TCK-00666"
        reason: "CLI should consume kernel-native review status projection rather than local state."

root_cause_analysis:
  summary: |
    fac_review currently orchestrates reviewer runs by spawning detached systemd units,
    tracking PIDs in review_state.json, and inferring liveness from PID existence + pulse
    files. This causes multiple classes of brittleness:

      - PID reuse / dead PID ambiguity causes 'alive' false positives.
      - Orchestrator crashes leave stale state that blocks progress.
      - Multiple sources of truth (state.json, pulse files, GitHub) diverge.
      - The orchestration does not naturally compose with daemon-side work/lease/session
        logic introduced by RFC-0032.

    The kernel-native direction is: CLI requests dispatch; daemon owns execution and
    durability; CLI observes progress via pulses/projections.

scope:
  in_scope:
    - id: "DRP-001"
      title: "Replace systemd-run detached dispatch with daemon DispatchReviewer"
      detail: |
        Update CLI review dispatch paths to call the daemon DispatchReviewer RPC instead of
        spawning `systemd-run ... apm2 fac review run ...`.

        Requirements:
          - dispatch must be idempotent (stable dispatch_idempotency_key derived from work_id + head_sha + review_kind + attempt)
          - daemon returns a session_id / run_id that CLI can observe via pulses/projection
          - CLI retains an operator-friendly output that links to work_id/session_id

    - id: "DRP-002"
      title: "Replace PID/pulse-file liveness with pulse subscriptions + status projection"
      detail: |
        For wait/resume/restart flows:
          - use SubscribePulse/WaitForPulse to wait on reviewer terminal topics
          - use GetReviewStatus (or WorkStatus extension) to decide whether a reviewer is pending/alive/done/blocked
          - eliminate the need to read review_state.json or check /proc for liveness

        Local pulse files may remain temporarily as derived UX, but must not be used to make authority decisions.

    - id: "DRP-003"
      title: "Update restart logic to be lease/session-driven"
      detail: |
        Replace restart heuristics that rely on local timestamps with:
          - lease expiry / renewal signals
          - session termination reasons recorded by daemon
          - WorkLoopManager reaper outputs (RFC-0032 Phase 4)

        Ensure that `apm2 fac restart` does not restart if a reviewer session is still legitimately running.

    - id: "DRP-004"
      title: "Compatibility shim: keep legacy `apm2 fac review run` as a thin wrapper (temporary)"
      detail: |
        During cutover, keep `apm2 fac review run` but redefine it as:
          - dispatch via daemon
          - wait via pulses
          - print terminal outcome

        Any remaining local state files become derived telemetry only.

  out_of_scope:
    - Rewriting reviewer model backends (Codex/Gemini/Claude) beyond what is necessary to run under daemon-owned episodes.
    - Removing all GitHub caching immediately.

plan:
  steps:
    - Implement dispatch call path and output formatting (work_id + session/run id).
    - Implement wait path using pulses and projection query.
    - Convert restart logic to lease/session signals.
    - Add integration tests that simulate:
        * CLI crash mid-wait and resume still succeeds
        * duplicate dispatch requests do not spawn duplicate sessions

definition_of_done:
  criteria:
    - "CLI review orchestration does not depend on systemd-run detached dispatch for correctness."
    - "CLI liveness and wait behavior uses pulse subscriptions + daemon projection, not PID/pulse-file inference."
    - "Restart logic is lease/session-driven and idempotent."
    - "Integration tests cover crash/resume and duplicate-dispatch idempotency."

risks:
  - id: "R-DRP-01"
    title: "Operator workflows rely on existing review_state.json artifacts"
    mitigation: |
      Provide derived/compat output (read-only) for a transition period, but keep it non-authoritative.
      Document that the canonical truth is now daemon projections.

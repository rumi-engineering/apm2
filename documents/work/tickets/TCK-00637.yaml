ticket_meta:
  schema_version: '2026-01-29'
  template_version: '2026-01-29'
  ticket:
    id: TCK-00637
    title: 'RFC-0032 Phase 2: implement ClaimWorkV2 (claim existing work_id; lease issuance; authority bindings anchor)'
    status: OPEN
  binds:
    prd_id: PRD-PLACEHOLDER
    rfc_id: RFC-0032
    requirements: []
    evidence_artifacts: []
  custody:
    agent_roles:
    - AGENT_IMPLEMENTER
    responsibility_domains:
    - DOMAIN_DAEMON
    - DOMAIN_PROTOCOL
    - DOMAIN_CORE
    - DOMAIN_EVIDENCE
  dependencies:
    tickets:
    - ticket_id: TCK-00635
      reason: Work must exist via OpenWork
    - ticket_id: TCK-00633
      reason: AuthorityBindings schema
    - ticket_id: TCK-00634
      reason: EvidenceCategory extensions
  scope:
    in_scope:
    - Add `ClaimWorkV2Request`/response to runtime proto and implement handler in `dispatch.rs`
    - 'Idempotency: same actor re-claim returns existing lease; different actor fails with FAILED_PRECONDITION'
    - Emit `work.transitioned(Open -> Claimed)` for implementer claims and `work.transitioned(ReadyForReview -> Review)` for reviewer claims (no new `work.claimed` event type)
    - Create and publish `apm2.work_authority_bindings.v1` to CAS and anchor via `evidence.published` with category WORK_AUTHORITY_BINDINGS
    - Ensure actor_id is daemon-derived from peer credentials (ignore client hints)
    out_of_scope:
    - Dependency closure enforcement and work graph logic (Phase 3 tickets)
    - Removing legacy ClaimWork v1 immediately (bridge keeps v1 temporarily)
  plan:
    steps:
    - Define new proto messages and wire into operator dispatch table (alongside existing ClaimWork)
    - 'Implement claim handler: validate work exists, compute correct previous_transition_count, transition state, issue lease'
    - Derive TransitionAuthorityBindings from current policy resolution code paths; serialize into WorkAuthorityBindings CAS doc (deny_unknown_fields)
    - Anchor bindings via `evidence.published` using deterministic evidence_id per RFC-0032 (WAB- prefix)
    - Add tests for idempotency + conflict behavior
  definition_of_done:
    evidence_ids: []
    criteria:
    - ClaimWorkV2 does not create a new work_id; it claims an existing one.
    - All authority-relevant pins needed for SpawnEpisode are reconstructible from ledger+CAS (no SQLite-only authority).
    - Idempotency semantics are enforced and tested.
  notes:
    security: Do not accept empty dedupe keys where required; ensure lease/role mismatch fails with CAPABILITY_DENIED-class errors.

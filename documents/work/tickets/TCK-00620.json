{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-29",
    "template_version": "2026-01-29",
    "ticket": {
      "id": "TCK-00620",
      "title": "Implement daemon-owned readiness controller for zero-touch gates auto-bootstrap",
      "status": "MERGED"
    },
    "binds": {
      "prd_id": "PRD-PLACEHOLDER",
      "rfc_id": "RFC-0019",
      "requirements": [
        "REQ-0031"
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_RUNTIME",
        "DOMAIN_CI",
        "DOMAIN_SECURITY"
      ]
    },
    "dependencies": {
      "tickets": []
    }
  },
  "root_cause_analysis": {
    "summary": "`apm2 fac gates` currently fails silently or with raw system errors on a\nfresh worktree because the FAC substrate (directory tree, lane pool, policy\nroot, economics profile, worker readiness) is not initialized automatically.\nOperators must manually run `apm2 fac bootstrap` and related adopt commands\nbefore gates are usable. This requirement for a specific manual setup\nsequence is undocumented from the implementor agent perspective, causes\nfirst-run failures that appear as gate bugs rather than infrastructure gaps,\nand prevents autonomous agent operation on freshly provisioned worktrees.\n\nCompounding bug: `apm2 daemon doctor` falsely reports broker_socket ERROR\neven when the daemon is healthy and running under systemd. Root cause is a\nsocket path mismatch between ecosystem.toml and the systemd socket unit:\n\n  - The systemd .socket unit uses ListenStream=%t/apm2/operator.sock\n    (i.e., $XDG_RUNTIME_DIR/apm2/operator.sock, e.g. /run/user/1000/apm2/operator.sock).\n  - ecosystem.toml hardcodes operator_socket = \"/tmp/apm2/operator.sock\".\n  - main.rs has a correct XDG-aware default_operator_socket() fallback but\n    it is never reached when ecosystem.toml is present and parses successfully.\n  - The generated apm2-daemon.service also sets PrivateTmp=yes, making all\n    /tmp/ paths written by the daemon invisible to the CLI (private tmpfs).\n    Any pid file, log dir, or state file under /tmp/ in ecosystem.toml is\n    equally unreachable.\n\nAs a result, the ReadinessController's broker/worker health check would\nprobe /tmp/apm2/operator.sock, find nothing, and falsely emit PREP_NOT_READY\n— even on a healthy system. The socket path must be derived from\nXDG_RUNTIME_DIR at runtime, not read from ecosystem.toml.\n"
  },
  "scope": {
    "in_scope": [
      {
        "id": "S1_READINESS_CONTROLLER",
        "title": "Implement ReadinessController with check/autofix/recheck loop",
        "detail": "Define a ReadinessController struct with a run() method that:\n  1. Checks each substrate component in dependency order.\n  2. For any component that is missing or invalid, invokes the\n     corresponding autofix routine (idempotent, same as bootstrap).\n  3. Rechecks the fixed component; on failure emits PREP_NOT_READY.\nComponents (in check order):\n  - FAC root directory tree + permissions\n  - Lane pool (at least one lane initialized)\n  - Admitted canonicalizer tuple (policy root hash, toolchain, resolver)\n  - Admitted economics profile\n  - Worker and broker process readiness (ping/health check)\n  - Managed cargo_home directory and local dependency substrate\n"
      },
      {
        "id": "S2_GATES_INTEGRATION",
        "title": "Wire ReadinessController as the first step of apm2 fac gates",
        "detail": "Before any gate is enqueued or executed, call ReadinessController::run().\nGate execution proceeds only after run() returns Ok(()).\nOn Err, emit structured PREP_NOT_READY failure (per REQ-0035 taxonomy)\nand exit. Do not start any gate processes on readiness failure.\n"
      },
      {
        "id": "S3_IDEMPOTENCY",
        "title": "Ensure controller is a no-op on a ready substrate",
        "detail": "On a substrate that is already fully ready, ReadinessController::run()\nMUST complete in under 100 ms and make no observable mutations.\nWrite a benchmark/test that measures controller overhead on a ready system.\n"
      },
      {
        "id": "S4_REGRESSION_TESTS",
        "title": "Regression tests covering fresh-substrate and partial-substrate scenarios",
        "detail": "- Test: empty APM2_HOME → controller auto-heals → gates succeed.\n- Test: missing lane pool → controller creates lanes → gates succeed.\n- Test: autofix failure → PREP_NOT_READY emitted → no gates run.\n- Test: fully ready substrate → controller is a no-op.\n- Test: daemon running on XDG socket + ecosystem.toml with /tmp path →\n  broker/worker check succeeds (uses XDG path, not ecosystem.toml path).\n- Test: PrivateTmp=yes service environment → no /tmp paths are probed.\n"
      },
      {
        "id": "S5_FIX_DAEMON_SOCKET_PATH",
        "title": "Fix socket path resolution: derive from XDG_RUNTIME_DIR, not ecosystem.toml",
        "detail": "Root cause: ecosystem.toml hardcodes /tmp/apm2/operator.sock but the\nsystemd socket unit uses $XDG_RUNTIME_DIR/apm2/operator.sock, and\nPrivateTmp=yes makes /tmp invisible to the CLI process.\n\nFix (option 3 from bug report — correct long-term):\n  - Remove operator_socket (and any other /tmp-based paths: pid_file,\n    log_dir, state_file) from the [daemon] section of ecosystem.toml.\n    Make these fields optional in EcosystemConfig; they should not be\n    present in the generated or checked-in ecosystem.toml.\n  - In all code that resolves the operator socket path, always use\n    default_operator_socket() (the XDG-aware function that already\n    exists in main.rs) regardless of whether ecosystem.toml is present.\n  - If ecosystem.toml still needs to override the socket path for\n    non-systemd setups, accept $XDG_RUNTIME_DIR as a literal variable\n    in the path string and expand it at read time — never a bare /tmp\n    path.\n  - Update ecosystem.toml (checked-in example/default) to remove the\n    [daemon] socket/tmp path fields entirely.\n\nSecondary fix: audit all ecosystem.toml-sourced paths for /tmp prefixes.\nAny path used by the daemon process that has PrivateTmp=yes must not\nlive under /tmp/. Redirect pid_file, log_dir, and state_file to\n$XDG_RUNTIME_DIR/apm2/ or $HOME/.local/share/apm2/ as appropriate.\n"
      },
      {
        "id": "S6_VERDICT_COMMENT_RESYNC",
        "title": "Fix: second reviewer decision fails to appear in GitHub verdict comment",
        "detail": "Observed on PR #746: the GitHub verdict comment is created correctly\nwith the first reviewer's decision, but when the second reviewer's\ndecision lands the comment is not updated to show both decisions.\n\nLocation: verdict_projection.rs project_decision_comment_with()\n  (lines 788-924), persist_verdict_projection_impl() (lines 568-719).\n\nKey invariants confirmed during initial investigation:\n  - DecisionProjectionRecord stored at:\n      ~/.apm2/fac_projection/repos/{owner_repo}/pr-{N}/verdict_projection.json\n      and SHA-specific copy at sha-{sha}/verdict_projection.json.\n  - Both reviewers on the same machine share ~/.apm2 and the fs2 lock.\n  - projection_record_to_payload() copies all record.dimensions.\n  - VERDICT_MARKER and DECISION_MARKER are the same value\n    (\"apm2-review-verdict:v1\"); tombstone markers also match.\n  - On the happy path (same machine, serialised by lock), the code\n    appears correct: second reviewer loads record with first\n    reviewer's dimension already present, renders body with both.\n\nLikely root cause (not yet confirmed):\n  When the second reviewer has no local projection record (cross-\n  APM2_HOME, integrity HMAC failure, or SHA mismatch), commit 0edac29c\n  added a \"discover existing remote comment and update\" path via\n  fetch_latest_live_verdict_comment_id(). This path correctly finds\n  and updates the existing GitHub comment, but renders the body from\n  a fresh record containing only the current reviewer's single\n  dimension — overwriting the first reviewer's verdict on GitHub.\n\nPossible root causes still to confirm:\n  A. Integrity HMAC verification failure on record load causes\n     load_decision_projection_for_home() to return Err, propagating\n     an error to the caller (second verdict silently fails).\n  B. SHA mismatch between reviewers (new commit pushed between\n     reviews) → record load returns None → fresh record → single-\n     dimension body overwrites comment.\n  C. Cross-APM2_HOME: second reviewer has no local record → finds\n     existing GitHub comment → updates with single-dimension body.\n  D. Race condition: record loaded before first reviewer saves\n     despite the fs2 lock (e.g., lock not held across the full\n     load-modify-save cycle).\n\nFix direction (to be confirmed after deeper investigation):\n  - If C/D: when updating an existing remote comment discovered via\n    fetch_latest_live_verdict_comment_id(), parse the existing\n    comment body to extract prior dimensions, merge with the incoming\n    dimension, render the merged body, then update.\n  - If A: surface the integrity verification error clearly.\n  - If B: no fix needed (SHA mismatch is correct behaviour).\n"
      },
      {
        "id": "S7_V3_NON_STATUS_EVIDENCE_REUSE",
        "title": "Harden non-status evidence path to reuse v3 gate cache deterministically",
        "detail": "In `run_evidence_gates_with_lane_context`, load native v3 gate cache\nmaterial (compound key + signatures) and apply v3-first reuse decisions\nconsistently across all non-status phases:\n  - rustfmt, clippy, doc\n  - test_safety_guard\n  - test\n  - workspace_integrity\n  - review_artifact_lint\nReuse behavior remains fail-closed: if v3 cache context or payload\nresolution is unavailable, treat as cache miss and execute gate.\n"
      },
      {
        "id": "S8_CACHE_HIT_MARKER_LOGS",
        "title": "Emit lane-local cache-hit marker logs for deterministic evidence artifacts",
        "detail": "For non-status cache-hit paths, write marker logs using\n`write_cached_gate_log_marker` and store lane-local log paths in\n`EvidenceGateResult`. This ensures deterministic log-bundle hashing\nand prevents stale/non-local cached paths from weakening evidence\nreproducibility.\n"
      },
      {
        "id": "S9_EVIDENCE_REGRESSION_SUITE",
        "title": "Add regression tests for v3 cache integration points",
        "detail": "Add/maintain targeted regressions proving:\n  - non-status evidence path reuses persisted v3 entries across all phases\n    (including workspace_integrity),\n  - v3-only cache hits succeed without v2 presence,\n  - receipt-bound rebinding promotes cache entries for reuse.\n"
      },
      {
        "id": "S10_GATES_FAILURE_O11Y",
        "title": "Improve queued gates failure observability",
        "detail": "Preserve gate-level failure context when worker-executed gates fail:\n  - propagate deterministic failure summaries from `fac_review::gates`\n    into queued worker denial reasons,\n  - include failed gate names and first actionable failure hint/log pointer,\n  - parse propagated `failed_gates=...` markers in push fallback paths\n    so `gate_error` telemetry no longer degrades to `gate=unknown` when\n    cache artifacts are unavailable,\n  - enforce UTF-8-safe bounded reason strings for FAC receipt compatibility\n    (512-char cap),\n  - add regression tests for summary propagation and truncation behavior.\n"
      }
    ],
    "out_of_scope": [
      "Gate ordering changes or broad gate algorithm redesign.",
      "Network-independence enforcement (REQ-0033, TCK-00622).",
      "Structured stdout JSONL schema (REQ-0036, TCK-00625).",
      "Any manual operator bootstrap sequence exposed to implementors."
    ]
  },
  "plan": {
    "steps": [
      {
        "id": "STEP_01",
        "title": "Define ReadinessController struct and component check interface",
        "detail": "In fac_review/ or a new fac_readiness module, define:\n  - SubstrateComponent enum (FacRoot, LanePool, Canonicalizer,\n    EconomicsProfile, WorkerBroker, CargoDeps)\n  - ComponentStatus: Ready | Missing | Invalid | FixFailed(String)\n  - ReadinessController::check_all() -> Vec<(SubstrateComponent, ComponentStatus)>\n  - ReadinessController::autofix(component) -> Result<(), String>\n  - ReadinessController::run() -> Result<(), ReadinessError>\n"
      },
      {
        "id": "STEP_02",
        "title": "Implement autofix routines for each component",
        "detail": "Reuse bootstrap logic from fac_bootstrap.rs for directory creation,\npolicy initialization, and lane pool creation. Wire worker/broker\nping from existing health-check paths. Make each routine idempotent.\n"
      },
      {
        "id": "STEP_03",
        "title": "Integrate ReadinessController into apm2 fac gates entry point",
        "detail": "In fac.rs gates subcommand handler: call ReadinessController::run()\nbefore dispatching to the gate evaluation pipeline. On error, emit\nstructured failure and return non-zero exit code.\n"
      },
      {
        "id": "STEP_04",
        "title": "Fix daemon socket path resolution (XDG-aware, /tmp-free)",
        "detail": "Remove operator_socket, pid_file, log_dir, and state_file /tmp paths\nfrom ecosystem.toml [daemon] section. Make EcosystemConfig fields\noptional. Update all call sites that resolve operator socket path to\nuse default_operator_socket() unconditionally (ignoring ecosystem.toml\nfor this field). Redirect daemon-written paths from /tmp/ to\n$XDG_RUNTIME_DIR/apm2/ or $HOME/.local/share/apm2/. Update the\ngenerated ecosystem.toml example to omit [daemon] path fields.\n"
      },
      {
        "id": "STEP_05",
        "title": "Add regression tests",
        "detail": "Cover: empty APM2_HOME auto-heal, partial substrate, autofix failure,\nno-op on ready substrate. Daemon-on-XDG-socket + /tmp-in-ecosystem\n→ broker check succeeds. PrivateTmp fixture → no /tmp probe.\nUse temp dir fixtures for isolation.\n"
      },
      {
        "id": "STEP_06",
        "title": "Run full workspace validation",
        "detail": "cargo fmt --all\ncargo clippy --workspace --all-targets --all-features -- -D warnings\ncargo doc --workspace --no-deps\ncargo test --workspace\n"
      },
      {
        "id": "STEP_07",
        "title": "Backfill non-status v3 cache reuse on all gate phases",
        "detail": "Ensure v3 reuse path is wired for workspace_integrity and all\nnon-status gate phases, using the same v3-first decision and payload\nresolution flow as status-path execution.\n"
      },
      {
        "id": "STEP_08",
        "title": "Lock deterministic cache-hit evidence + regressions",
        "detail": "Emit lane-local cache-hit marker logs and add integration tests that\nreproduce historical non-status reuse failures and verify the fix.\n"
      }
    ]
  },
  "definition_of_done": {
    "evidence_ids": [
      "EXEC-TCK00620-READINESS-CONTROLLER",
      "EXEC-TCK00620-FRESH-WORKTREE-SUCCESS",
      "EXEC-TCK00620-SOCKET-PATH-FIX",
      "EXEC-TCK00620-VERDICT-RESYNC-FIX",
      "EXEC-TCK00620-EVIDENCE-V3-REUSE",
      "EXEC-TCK00620-EVIDENCE-V3-REGRESSIONS",
      "EXEC-TCK00620-WORKSPACE-VALIDATION"
    ],
    "criteria": [
      "ReadinessController is implemented with check/autofix/recheck for all six substrate components.",
      "apm2 fac gates invokes ReadinessController before any gate runs.",
      "Fresh APM2_HOME with valid config: apm2 fac gates succeeds on first invocation.",
      "Autofix failure produces structured PREP_NOT_READY output with no raw system errors.",
      "Controller is a no-op (< 100 ms) on a fully ready substrate.",
      "operator_socket and /tmp-based path fields are removed from ecosystem.toml [daemon] section.",
      "All broker/worker socket path resolution uses default_operator_socket() (XDG-aware) unconditionally.",
      "apm2 daemon doctor reports broker_socket OK when daemon is running on the XDG socket path.",
      "No daemon-written paths (pid file, log dir, state file) remain under /tmp/ in ecosystem.toml.",
      "Regression tests pass for XDG socket resolution and PrivateTmp isolation invariants.",
      "Regression tests pass for all fresh/partial/failure scenarios.",
      "Root cause of verdict comment resync failure is confirmed and fixed.",
      "After both reviewer decisions land, the GitHub verdict comment shows all dimensions — no dimension is silently overwritten or lost.",
      "Non-status evidence path reuses valid v3 cache entries across all phases, including workspace_integrity.",
      "Cache-hit evidence artifacts use lane-local marker logs and remain deterministic for log-bundle hashing.",
      "Regression tests pass for v3-only cache hits, receipt-rebind promotion, and full non-status v3 reuse integration coverage.",
      "Queued gates denial reasons include deterministic gate-level failure summaries when available and remain UTF-8-safe within receipt bounds.",
      "Push telemetry emits concrete failed gate identifiers when failure summaries include `failed_gates=...` markers.",
      "Workspace validation (fmt, clippy, doc, test) completes successfully."
    ]
  },
  "notes": {
    "context": "This is the foundation ticket for the gates usability redesign. All\nsubsequent tickets in the REQ-0031..REQ-0039 cluster depend on the\nReadinessController being in place. The autofix routines should reuse\nthe existing fac_bootstrap.rs logic rather than duplicating it.\n\nThe daemon socket path bug (S5) is included here because the ReadinessController's\nbroker/worker health check is the first consumer of the socket path in the gates\nflow. If the path is wrong, the controller emits a false PREP_NOT_READY — making\nthe fix a prerequisite for correct broker readiness checking. The fix removes\nsocket/tmp path fields from ecosystem.toml entirely and makes all path resolution\nXDG-aware unconditionally, matching the invariant enforced by the systemd socket\nunit (ListenStream=%t/apm2/operator.sock) and the PrivateTmp=yes service sandbox.\n",
    "amendments": [
      {
        "amendment_id": "AMD-2026-02-18-EVIDENCE-V3-SCOPE-REALIGN",
        "summary": "Record executed v3 evidence-cache hardening work to prevent scope ambiguity after PR741/PR746 integration.",
        "supersedes": [
          "Out-of-scope statement excluding all gate execution logic changes."
        ],
        "replacement": [
          "Gate ordering remains unchanged, while targeted evidence execution-path hardening for deterministic v3 cache reuse and regression prevention is in-scope."
        ]
      },
      {
        "amendment_id": "AMD-2026-02-18-GATES-O11Y",
        "summary": "Scope explicitly includes gate-failure observability hardening for queued worker execution.",
        "supersedes": [
          "Implicit assumption that gate failure reasons can remain exit-code only."
        ],
        "replacement": [
          "Queued gate failures must surface deterministic per-gate failure context in denial receipts while preserving bounded, replay-safe reason strings."
        ]
      }
    ],
    "security": "default-deny; readiness failure is fail-closed (no gates run); XDG socket path removes /tmp TOCTOU surface from PrivateTmp=yes sandbox"
  }
}

{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-25",
    "template_version": "2026-01-25",
    "ticket": {
      "id": "TCK-00071",
      "title": "Improve Temp File Lifecycle Management"
    },
    "binds": {
      "prd_id": "NONE",
      "rfc_id": "RFC-0006",
      "requirements": [
        {
          "requirement_id": "MAINT-018",
          "requirement_ref": "documents/rfcs/RFC-0006/01_problem_and_imports.yaml#rfc_local_requirements.requirements[12]"
        }
      ],
      "evidence_artifacts": []
    },
    "custody": {
      "agent_roles": [
        "AGENT_IMPLEMENTER"
      ],
      "responsibility_domains": [
        "DOMAIN_BUILD_RELEASE",
        "DOMAIN_SECURITY"
      ]
    },
    "dependencies": {
      "tickets": [
        "TCK-00067",
        "TCK-00069"
      ]
    },
    "scope": {
      "in_scope": [
        "Create ManagedTempFile wrapper struct that tracks files in state",
        "Register temp files in reviewer_state.json for cleanup on remediation",
        "Add cleanup sweep on cargo xtask check for orphaned temp files older than 1 hour",
        "Remove rm -f from shell command strings throughout codebase",
        "Implement temp file tracking in ReviewerEntry struct",
        "Add orphan detection and cleanup logic",
        "Update push.rs and review.rs to use ManagedTempFile"
      ],
      "out_of_scope": [
        "Changes to tempfile crate usage (still use tempfile for creation)",
        "Persistent log storage",
        "Changes to reviewer health monitoring logic",
        "Changes to AI reviewer prompt content"
      ]
    },
    "plan": {
      "steps": [
        "Audit codebase for rm -f in shell command strings",
        "Design ManagedTempFile struct with fields: path, created_at, review_type",
        "Add temp_files: Vec<PathBuf> field to ReviewerEntry in reviewer_state.rs",
        "Implement ManagedTempFile::new() that creates temp file and registers in state",
        "Implement ManagedTempFile::cleanup() that removes file and updates state",
        "Add cleanup_orphaned_temp_files() function to reviewer_state.rs",
        "Orphan detection: temp files in state but no associated running reviewer",
        "Age threshold: clean up temp files older than 1 hour",
        "Update push.rs to register temp files (prompt, log) in ReviewerEntry",
        "Update review.rs to register temp files in ReviewerEntry",
        "Update check.rs remediate_reviewer() to clean up old temp files before restart",
        "Add orphan cleanup call to check.rs run_check() function",
        "Remove all rm -f from shell command construction in codebase",
        "Add unit tests for temp file registration and cleanup",
        "Add integration test for orphan cleanup",
        "Verify cargo build succeeds",
        "Verify cargo test passes",
        "Verify cargo clippy passes with no warnings"
      ]
    },
    "definition_of_done": {
      "evidence_ids": [],
      "criteria": [
        "ManagedTempFile struct exists for tracking temp files in state",
        "ReviewerEntry includes temp_files field tracking associated files",
        "No rm -f in shell command construction anywhere in xtask codebase",
        "Temp files registered in reviewer_state.json on creation",
        "Temp files cleaned up on successful review completion",
        "Temp files cleaned up on remediation (before restart)",
        "Orphaned temp files (>1 hour old, no running reviewer) cleaned up by cargo xtask check",
        "push.rs registers prompt and log temp files in state",
        "review.rs registers prompt and log temp files in state",
        "cleanup_orphaned_temp_files() called during check command execution",
        "Unit tests verify temp file registration works",
        "Unit tests verify cleanup removes files and updates state",
        "cargo build succeeds",
        "cargo test passes",
        "cargo clippy passes with no warnings"
      ]
    },
    "notes": {
      "security": "Proper temp file lifecycle management prevents:\n- Disk space leaks from orphaned temp files\n- Potential information disclosure from lingering temp files\n- Race conditions from manual rm -f in shell commands\n\nState-tracked cleanup is more reliable than shell-based cleanup because:\n- Works even if process is killed (SIGKILL)\n- Handles partial failures gracefully\n- Provides audit trail of temp file usage\n",
      "implementation_details": "ManagedTempFile structure:\n```rust\npub struct ManagedTempFile {\n    path: PathBuf,\n    created_at: DateTime<Utc>,\n    review_type: String,\n}\n```\n\nReviewerEntry with temp files:\n```rust\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ReviewerEntry {\n    pub pid: u32,\n    pub started_at: DateTime<Utc>,\n    pub log_file: PathBuf,\n    pub prompt_file: PathBuf,  // Added\n    pub pr_url: String,\n    pub head_sha: String,\n    pub temp_files: Vec<PathBuf>,  // Added\n}\n```\n\nOrphan cleanup logic:\n```rust\npub fn cleanup_orphaned_temp_files(state: &mut ReviewerStateFile) -> Result<Vec<PathBuf>> {\n    let mut cleaned = Vec::new();\n    let one_hour_ago = Utc::now() - chrono::Duration::hours(1);\n\n    for (name, entry) in &state.reviewers {\n        // Skip if reviewer is still alive\n        if entry.check_health() != HealthStatus::Dead {\n            continue;\n        }\n\n        // Clean up temp files for dead reviewers older than 1 hour\n        if entry.started_at < one_hour_ago {\n            for path in &entry.temp_files {\n                if path.exists() {\n                    let _ = std::fs::remove_file(path);\n                    cleaned.push(path.clone());\n                }\n            }\n        }\n    }\n\n    // Remove dead entries older than 1 hour\n    state.reviewers.retain(|_, e| {\n        e.check_health() != HealthStatus::Dead || e.started_at >= one_hour_ago\n    });\n\n    state.save()?;\n    Ok(cleaned)\n}\n```\n",
      "api_versioning": "This ticket builds on structures from TCK-00067 (ReviewerEntry) and\nTCK-00069 (ReviewerSpawner). Ensure compatibility with those implementations.\n",
      "affected_files": "Modified: xtask/src/reviewer_state.rs (ManagedTempFile, temp_files field, cleanup logic)\nModified: xtask/src/tasks/push.rs (register temp files, remove rm -f)\nModified: xtask/src/tasks/review.rs (register temp files, remove rm -f)\nModified: xtask/src/tasks/check.rs (call orphan cleanup, remove rm -f in restart_review())\n"
    }
  }
}

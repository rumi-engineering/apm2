acceptance_criteria:
  - criterion: TelemetryCollector per CTR-DAEMON-005
    verification: All methods implemented and tested
  - criterion: Configurable sample interval
    verification: Frames emitted at configured rate
  - criterion: Integration with budget accounting
    verification: Telemetry informs budget consumption
implementation:
  code_examples:
    - description: TelemetryCollector structure
      code: |
        pub struct TelemetryCollector {
            cgroup_reader: CgroupReader,
            sample_interval_ms: u64,
            ring_buffer: RingBuffer<TelemetryFrame>,
        }

        impl TelemetryCollector {
            pub fn start(&self, episode_id: EpisodeId, pid: Pid) -> TelemetryHandle;
            pub async fn collect(&self, handle: &TelemetryHandle) -> TelemetryFrame;
            pub fn apply_policy(&mut self, policy: TelemetryPolicy);
        }

        pub struct TelemetryFrame {
            pub episode_id: EpisodeId,
            pub seq: u64,
            pub ts_mono: u64,
            pub cpu_ns: u64,
            pub mem_rss_bytes: u64,
            pub io_read_bytes: u64,
            pub io_write_bytes: u64,
            pub o11y_flags: O11yFlags,
        }
  files_to_create:
    - path: crates/apm2-daemon/src/telemetry/collector.rs
      purpose: TelemetryCollector implementation
    - path: crates/apm2-daemon/src/telemetry/frame.rs
      purpose: TelemetryFrame type
    - path: crates/apm2-daemon/src/telemetry/policy.rs
      purpose: TelemetryPolicy configuration
    - path: crates/apm2-daemon/src/telemetry/handle.rs
      purpose: TelemetryHandle for active collection
  files_to_modify:
    - changes: Export collector, frame, policy, handle modules
      path: crates/apm2-daemon/src/telemetry/mod.rs
  implementation_steps:
    - step: 1
      action: Define TelemetryFrame
      details: |
        Create frame type per CTR-DAEMON-005:
        - episode_id, seq, ts_mono
        - cpu_ns, cpu_user_ns, cpu_system_ns
        - mem_rss_bytes, mem_peak_bytes
        - io metrics, net metrics (optional)
        - o11y_flags for sampling mode
    - step: 2
      action: Implement TelemetryCollector
      details: |
        Create collector per CTR-DAEMON-005:
        - start(): begin collection for episode
        - collect(): read metrics, emit frame
        - apply_policy(): configure sampling
    - step: 3
      action: Implement collection loop
      details: |
        Spawn async task for collection:
        - Sleep for sample_interval
        - Read metrics from CgroupReader
        - Compute deltas from previous
        - Push to ring buffer
        - Send to output channel
    - step: 4
      action: Implement TelemetryPolicy
      details: |
        Create policy configuration:
        - sample_period_ms: collection interval
        - promote_triggers: when to persist full buffer
        - ring_buffer_limits: size per tier
    - step: 5
      action: Integrate with budget accounting
      details: |
        Report consumption to BudgetTracker:
        - cpu_ms from telemetry
        - bytes_io from telemetry
        - Check limits, trigger stop if exhausted
  summary: |
    Implement TelemetryCollector and frame streaming per CTR-DAEMON-005.
    Collects resource metrics at configurable intervals with ring buffer.
    Integrates with budget accounting for limit enforcement.
notes: |
  Phase: PHASE-2C (Telemetry Collection)
  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.
  Maps to TCK-PEND-012.
schema_version: "2026-01-27"
template_version: "2026-01-27"
test_requirements:
  - description: Frame collection
    test_id: UT-00169-01
    verification_command: cargo test -p apm2-daemon telemetry_collect
  - description: Sample interval
    test_id: UT-00169-02
    verification_command: cargo test -p apm2-daemon sample_interval
  - description: Budget integration
    test_id: IT-00169-01
    verification_command: cargo test -p apm2-daemon --test integration telemetry_budget
ticket:
  depends_on:
    - TCK-00168
  id: TCK-00169
  requirement_ids:
    - REQ-TEL-001
  rfc_id: RFC-0013
  status: READY
  title: Implement TelemetryCollector and frame streaming

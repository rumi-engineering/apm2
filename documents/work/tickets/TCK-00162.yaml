acceptance_criteria:
  - criterion: HarnessAdapter trait definition per CTR-DAEMON-003
    verification: Trait compiles with all required methods
  - criterion: AdapterRegistry for adapter lookup by type
    verification: Registry returns correct adapter for type
  - criterion: RawAdapter emitting unstructured output events
    verification: Raw adapter streams PTY output as events
implementation:
  code_examples:
    - description: HarnessAdapter trait
      code: |
        #[async_trait]
        pub trait HarnessAdapter: Send + Sync {
            fn adapter_type(&self) -> AdapterType;

            async fn spawn(
                &self,
                config: HarnessConfig,
                pty: PtyHandle,
            ) -> Result<HarnessHandle, Error>;

            async fn send_input(&self, handle: &HarnessHandle, input: &[u8]) -> Result<()>;

            fn output_stream(&self, handle: &HarnessHandle) -> impl Stream<Item = HarnessEvent>;

            async fn terminate(&self, handle: &HarnessHandle) -> Result<ExitStatus>;
        }
  files_to_create:
    - path: crates/apm2-daemon/src/episode/adapter.rs
      purpose: HarnessAdapter trait and HarnessEvent types
    - path: crates/apm2-daemon/src/episode/registry.rs
      purpose: AdapterRegistry for adapter lookup
    - path: crates/apm2-daemon/src/episode/raw_adapter.rs
      purpose: RawAdapter baseline implementation
  files_to_modify:
    - changes: Export adapter, registry, raw_adapter modules
      path: crates/apm2-daemon/src/episode/mod.rs
  implementation_steps:
    - step: 1
      action: Define HarnessAdapter trait
      details: |
        Create trait per CTR-DAEMON-003 with methods:
        - adapter_type() -> AdapterType
        - spawn(config, pty) -> HarnessHandle
        - send_input(handle, input) -> Result
        - output_stream(handle) -> Stream<HarnessEvent>
        - terminate(handle) -> ExitStatus
    - step: 2
      action: Define HarnessEvent enum
      details: |
        Create event types:
        - Output { chunk, kind, seq, ts }
        - ToolRequest { request_id, tool, args }
        - Progress { message, percent }
        - Error { code, message }
        - Terminated { exit_code, classification }
    - step: 3
      action: Implement AdapterRegistry
      details: |
        Create registry struct:
        - register(adapter: Box<dyn HarnessAdapter>)
        - get(adapter_type: AdapterType) -> Option<&dyn HarnessAdapter>
        - Default adapters: Raw, ClaudeCode (future)
    - step: 4
      action: Implement RawAdapter
      details: |
        Baseline adapter that:
        - Spawns process via PtyRunner
        - Emits all PTY output as Output events
        - Does not parse tool calls (raw mode)
        - Forwards termination status
    - step: 5
      action: Implement Holon trait for adapter
      details: |
        Per AD-ADAPT-001, HarnessAdapter implements Holon:
        - Input = HarnessConfig
        - Output = EpisodeReceipt
        - State = AdapterState
        - execute_episode() wraps PTY I/O
  summary: |
    Implement HarnessAdapter trait and AdapterRegistry per CTR-DAEMON-003.
    Defines adapter interface for normalizing harness behavior. Includes
    RawAdapter as baseline that emits unstructured output events.
notes: |
  Phase: PHASE-1C (PTY Runner and Basic Adapter)
  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.
  Maps to TCK-PEND-006.
schema_version: "2026-01-27"
template_version: "2026-01-27"
test_requirements:
  - description: Adapter registry lookup
    test_id: UT-00162-01
    verification_command: cargo test -p apm2-daemon adapter_registry
  - description: Raw adapter output stream
    test_id: IT-00162-01
    verification_command: cargo test -p apm2-daemon --test integration raw_adapter
  - description: HarnessEvent serialization
    test_id: UT-00162-02
    verification_command: cargo test -p apm2-daemon harness_event
ticket:
  depends_on:
    - TCK-00161
  id: TCK-00162
  requirement_ids:
    - REQ-ADAPTER-001
  rfc_id: RFC-0013
  status: READY
  title: Implement basic HarnessAdapter trait and registry

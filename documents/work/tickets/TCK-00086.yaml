ticket_meta:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"
  ticket:
    id: "TCK-00086"
    title: "Define CIWorkflowCompleted ledger event schema"
  binds:
    prd_id: "PRD-0004"
    rfc_id: "RFC-0008"
    requirements:
      - requirement_id: "REQ-0009"
        requirement_ref: "documents/prds/PRD-0004/requirements/REQ-0009.yaml#prd_requirement"
      - requirement_id: "REQ-0025"
        requirement_ref: "documents/prds/PRD-0004/requirements/REQ-0025.yaml#prd_requirement"
    evidence_artifacts:
      - "EVID-8002"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
  dependencies:
    tickets:
      - "TCK-00085"
  scope:
    in_scope:
      - "Define CIWorkflowCompleted event struct with all required fields"
      - "Implement event serialization/deserialization"
      - "Add event emission from webhook handler after validation"
      - "Track delivery_id for idempotency"
      - "Persist events to ledger storage"
      - "Add feature flag CI_EVENTS_ENABLED"
      - "Add event query capability"
    out_of_scope:
      - "Task queue integration (TCK-00087)"
      - "Processing events for phase transitions"
      - "Event streaming/subscription (future enhancement)"
  plan:
    steps:
      - "Define CIWorkflowCompleted event struct in events module"
      - "Add fields: event_id, timestamp, pr_number, commit_sha, conclusion, checks[]"
      - "Add signature_verified and delivery_id fields for audit"
      - "Implement serde serialization with JSON format"
      - "Create delivery_id tracking store (in-memory initially, with TTL)"
      - "Modify webhook handler to emit event on valid webhook"
      - "Implement ledger persistence for events"
      - "Add event query by type, time range, and pr_number"
      - "Write unit tests for event creation and serialization"
      - "Write integration test for idempotency"
  definition_of_done:
    evidence_ids:
      - "EVID-8002"
    criteria:
      - "CIWorkflowCompleted event struct defined with all fields"
      - "Event serializes to JSON matching contract schema"
      - "Webhook handler emits event on valid webhook"
      - "Duplicate delivery_ids result in no duplicate events"
      - "Events are persisted to ledger"
      - "Events can be queried from ledger"
      - "Feature flag CI_EVENTS_ENABLED controls emission"
      - "Unit tests pass for event serialization"
      - "Integration test passes for idempotency"
  notes:
    implementation_details: |
      Event schema:
      ```rust
      #[derive(Debug, Clone, Serialize, Deserialize)]
      pub struct CIWorkflowCompleted {
          pub event_id: Uuid,
          pub event_type: String, // Always "CIWorkflowCompleted"
          pub timestamp: DateTime<Utc>,
          pub source: String, // Always "github_webhook"
          pub payload: CIWorkflowPayload,
          pub signature_verified: bool,
          pub delivery_id: String,
      }

      #[derive(Debug, Clone, Serialize, Deserialize)]
      pub struct CIWorkflowPayload {
          pub pr_number: u64,
          pub commit_sha: String,
          pub conclusion: CIConclusion, // success, failure, cancelled
          pub workflow_name: String,
          pub workflow_run_id: u64,
          pub checks: Vec<CheckResult>,
      }

      #[derive(Debug, Clone, Serialize, Deserialize)]
      pub struct CheckResult {
          pub name: String,
          pub conclusion: CheckConclusion, // success, failure, skipped
          pub started_at: DateTime<Utc>,
          pub completed_at: DateTime<Utc>,
      }
      ```

      Idempotency implementation:
      - Use a HashSet<String> to track seen delivery_ids
      - TTL of 24 hours (configurable)
      - Before emitting event, check if delivery_id already seen
      - If seen, return success but don't emit duplicate event
    affected_files: |
      New:
        - crates/apm2-core/src/events/ci.rs
        - crates/apm2-core/src/events/mod.rs (if not exists)
      Modified:
        - crates/apm2-core/src/webhook/handler.rs (add event emission)
        - crates/apm2-core/src/lib.rs (add events module)

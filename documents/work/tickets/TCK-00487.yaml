ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00487"
    title: "Ledger hash-chain signature verification and incremental startup validation"
    status: "OPEN"
  binds:
    prd_id: "PRD-0010"
    rfc_id: "RFC-0028"
    requirements:
      - requirement_id: "REQ-0004"
        requirement_ref: "documents/rfcs/RFC-0028/requirements/REQ-0004.yaml#requirement"
    evidence_artifacts:
      - evidence_id: "EVID-0004"
        artifact_ref: "documents/rfcs/RFC-0028/evidence_artifacts/EVID-0004.yaml#evidence_artifact"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
      - "AGENT_REVIEWER"
    responsibility_domains:
      - "DOMAIN_SECURITY"
      - "DOMAIN_RUNTIME"
      - "DOMAIN_RELIABILITY"
  dependencies:
    tickets:
      - ticket_id: "TCK-00486"
        reason: "Namespace isolation defines which events carry governance signatures; chain verification must validate those signatures."
  scope:
    in_scope:
      - "Problem 1: derive_event_chain_hash_from_db() validates prev_hash linkage and recomputed event_hash, but never verifies that stored signatures are valid under a trusted key. DB-level attacker can rewrite payload+signature and recompute hashes."
      - "Problem 2: Startup chain verification is O(N) — full table scan and re-hash of every event. Production ledgers with millions of events cause multi-minute startup hangs (DoS)."
      - "Problem 3: backfill_hash_chain 'blesses' potentially tampered legacy history on first run (trust-on-first-use migration). Loads all rows into memory (OOM risk on large ledgers)."
      - "Fix 1: During chain verification, verify each event signature against the trusted daemon verifying key (or keyset with key-id binding). Fail closed on any signature mismatch."
      - "Fix 2: Implement incremental startup validation. On startup, verify only from the last trusted checkpoint to the current tip (O(K) where K = events since last checkpoint). Full-chain verification becomes an explicit admin maintenance command, not an automatic startup routine."
      - "Fix 3: Process backfill migration in chunks (LIMIT/OFFSET or streaming iterator), wrapped in a single transaction. Add a genesis checkpoint for legacy history or require operator confirmation before blessing large histories."
      - "Fix 4: Replace dummy signatures (vec![0u8; 64]) on SqliteLeaseValidator events with real daemon-key signatures."
    out_of_scope:
      - "Policy-root namespace isolation (TCK-00486)."
      - "Distributed/federated ledger integrity (future)."
  plan:
    steps:
      - "Add signature verification to derive_event_chain_hash_from_db: for each event, verify signature against trusted daemon verifying key. Fail closed on mismatch."
      - "Implement checkpointed startup validation: store last-verified chain checkpoint (rowid + event_hash + signature). On startup, verify only events after checkpoint. Update checkpoint on success."
      - "Move full-chain verification to explicit admin command (apm2 daemon verify-chain or equivalent)."
      - "Refactor backfill_hash_chain: chunk-based processing (stream or LIMIT/OFFSET), single wrapping transaction, OOM-safe."
      - "Sign all ledger events with daemon authority key. Replace dummy signatures on lease events."
      - "Add tests: (a) tampered event payload detected via signature mismatch, (b) tampered event hash detected via chain break, (c) startup verification is O(K) not O(N), (d) backfill processes large ledgers without OOM, (e) full-chain admin command catches mid-chain tampering."
      - "Run mandatory pre-commit checks."
  definition_of_done:
    evidence_ids:
      - "EVID-0004"
    criteria:
      - "All event signatures verified against trusted key during chain validation."
      - "Startup validation is incremental (checkpoint-based), not O(N)."
      - "Backfill migration is chunk-based, transaction-wrapped, and OOM-safe."
      - "No dummy signatures remain on authority-bearing events."
      - "Admin full-chain verification command exists for integrity audits."
  notes:
    security: |
      This is a substrate integrity ticket — it's BELOW PCAC in the trust stack. PCAC's
      as_of_ledger_anchor is only meaningful if the ledger itself is tamper-evident. Without
      signature verification, an attacker with DB access can forge history, and PCAC will
      bind to the forged anchor without detecting it.

      The O(N) startup DoS is also security-critical: if restarting the daemon takes minutes,
      it creates an availability attack vector and discourages restarts that would clear
      in-memory state (relevant to declassification receipt single-use before TCK-00485).
    verification: |
      Tampering test: modify a mid-chain event's payload in the DB, restart daemon, verify
      that chain validation catches it and fails closed (not just at tip, but at the tampered
      event's position). Timing test: measure startup time with 100K events; must be bounded
      by checkpoint-to-tip distance, not total ledger size.

{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-26",
    "template_version": "2026-01-26",
    "ticket": {
      "id": "TCK-00112",
      "title": "Implement CCP crate graph generation",
      "status": "READY"
    },
    "binds": {
      "rfc_id": "RFC-0010",
      "requirements": [
        {
          "requirement_id": "REQ-0002"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00110"
      }
    ]
  },
  "implementation": {
    "summary": "Create the CCP crate graph generator that invokes cargo metadata to build\na deterministic dependency graph of all workspace crates. The graph captures\ninter-crate dependencies with version constraints, enabling impact analysis\nwhen changes propagate through the dependency tree.\n",
    "files_to_modify": [],
    "files_to_create": [
      {
        "path": "crates/apm2-core/src/ccp/crate_graph.rs",
        "purpose": "Crate graph generation: invoke cargo metadata, parse output, produce deterministic graph structure"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Define crate graph data structures",
        "details": "In crate_graph.rs, define:\n\npub struct CrateGraph {\n    pub schema_version: String,\n    pub generated_at: DateTime<Utc>,\n    pub workspace_root: PathBuf,\n    pub crates: Vec<CrateNode>,\n    pub edges: Vec<DependencyEdge>,\n}\n\npub struct CrateNode {\n    pub id: String,           // Matches component ID from atlas\n    pub name: String,         // Crate name from Cargo.toml\n    pub version: String,      // Version from Cargo.toml\n    pub path: PathBuf,        // Crate root path\n    pub crate_type: CrateType,\n    pub features: Vec<String>,\n}\n\npub enum CrateType { Lib, Bin, ProcMacro }\n\npub struct DependencyEdge {\n    pub from: String,         // Source crate ID\n    pub to: String,           // Target crate ID\n    pub dep_type: DependencyType,\n    pub version_req: String,  // Version requirement (e.g., \"0.1\", \"^1.0\")\n    pub features: Vec<String>,\n    pub optional: bool,\n}\n\npub enum DependencyType { Normal, Dev, Build }\n"
      },
      {
        "step": 2,
        "action": "Implement cargo metadata invocation",
        "details": "fn invoke_cargo_metadata(repo_root: &Path) -> Result<serde_json::Value, CrateGraphError>\n- Run: cargo metadata --format-version 1 --manifest-path <repo_root>/Cargo.toml\n- Capture stdout as JSON\n- Handle errors: cargo not found, invalid manifest, etc.\n- Consider using cargo_metadata crate if available, or raw Command\n"
      },
      {
        "step": 3,
        "action": "Implement metadata parsing",
        "details": "fn parse_cargo_metadata(metadata: &serde_json::Value) -> Result<(Vec<CrateNode>, Vec<DependencyEdge>), CrateGraphError>\n- Extract workspace_root from metadata\n- Extract packages array, filter to workspace members only\n- For each package, create CrateNode with stable ID\n- Extract dependencies from resolve.nodes for edges\n- Handle optional dependencies and feature flags\n"
      },
      {
        "step": 4,
        "action": "Implement deterministic sorting",
        "details": "fn sort_graph(crates: &mut Vec<CrateNode>, edges: &mut Vec<DependencyEdge>)\n- Sort crates by ID (lexicographic)\n- Sort edges by (from, to, dep_type) tuple\n- This ensures cargo metadata output order variations don't affect output\n"
      },
      {
        "step": 5,
        "action": "Implement build_crate_graph",
        "details": "pub fn build_crate_graph(repo_root: &Path) -> Result<CrateGraph, CrateGraphError>\n1. Invoke cargo metadata\n2. Parse metadata into nodes and edges\n3. Sort deterministically\n4. Return CrateGraph with schema_version and generated_at\n"
      },
      {
        "step": 6,
        "action": "Add to CCP module",
        "details": "Update crates/apm2-core/src/ccp/mod.rs:\npub mod crate_graph;\npub use crate_graph::{CrateGraph, CrateNode, DependencyEdge, CrateGraphError};\n"
      }
    ],
    "code_examples": [
      {
        "description": "Building a crate graph",
        "code": "use apm2_core::ccp::build_crate_graph;\nuse std::path::Path;\n\nlet graph = build_crate_graph(Path::new(\"/repo/root\"))?;\nprintln!(\"Workspace has {} crates\", graph.crates.len());\nfor edge in &graph.edges {\n    println!(\"{} -> {} ({})\", edge.from, edge.to, edge.version_req);\n}\n"
      },
      {
        "description": "Finding dependents of a crate",
        "code": "fn find_dependents(graph: &CrateGraph, crate_id: &str) -> Vec<&str> {\n    graph.edges.iter()\n        .filter(|e| e.to == crate_id)\n        .map(|e| e.from.as_str())\n        .collect()\n}\n"
      }
    ]
  },
  "acceptance_criteria": [
    {
      "criterion": "Crate graph matches cargo metadata output structure",
      "verification": "Integration test compares crate graph nodes/edges against direct cargo metadata parsing - all workspace crates and their dependencies present"
    },
    {
      "criterion": "Output is deterministic (stable key ordering)",
      "verification": "Unit test runs build_crate_graph twice - serialized YAML output must be byte-identical"
    }
  ],
  "test_requirements": [
    {
      "test_id": "UT-112-01",
      "description": "Test cargo metadata invocation succeeds",
      "verification_command": "cargo test -p apm2-core ccp::crate_graph::tests::test_cargo_metadata_invocation"
    },
    {
      "test_id": "UT-112-02",
      "description": "Test metadata parsing extracts all workspace crates",
      "verification_command": "cargo test -p apm2-core ccp::crate_graph::tests::test_parse_workspace_crates"
    },
    {
      "test_id": "UT-112-03",
      "description": "Test dependency edges are correctly extracted",
      "verification_command": "cargo test -p apm2-core ccp::crate_graph::tests::test_dependency_edges"
    },
    {
      "test_id": "UT-112-04",
      "description": "Test output is deterministically sorted",
      "verification_command": "cargo test -p apm2-core ccp::crate_graph::tests::test_deterministic_output"
    },
    {
      "test_id": "UT-112-05",
      "description": "Test optional dependencies are marked correctly",
      "verification_command": "cargo test -p apm2-core ccp::crate_graph::tests::test_optional_dependencies"
    },
    {
      "test_id": "IT-112-01",
      "description": "Integration test: full crate graph build",
      "verification_command": "cargo test -p apm2-core ccp::crate_graph"
    }
  ],
  "notes": "The crate graph provides structural information about how crates depend on\neach other. Combined with the component atlas (which provides semantic\ninformation), this enables accurate impact analysis.\n\nThe cargo_metadata crate (https://crates.io/crates/cargo_metadata) can be\nused instead of raw Command invocation if it's already a dependency or\nacceptable to add. It provides type-safe parsing of cargo metadata output.\n\nBlocked by TCK-00110 because crate graph output must use canonical YAML\nfrom the determinism module. This ticket can be implemented in parallel\nwith TCK-00111 (component atlas) as they are independent.\n"
}

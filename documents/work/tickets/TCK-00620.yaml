ticket_meta:
  schema_version: "2026-01-29"
  template_version: "2026-01-29"
  ticket:
    id: "TCK-00620"
    title: "Implement daemon-owned readiness controller for zero-touch gates auto-bootstrap"
    status: "CLOSED"
  binds:
    prd_id: "PRD-PLACEHOLDER"
    rfc_id: "RFC-0019"
    requirements: ["REQ-0031"]
    evidence_artifacts: []
  custody:
    agent_roles: ["AGENT_IMPLEMENTER"]
    responsibility_domains: ["DOMAIN_RUNTIME", "DOMAIN_CI", "DOMAIN_SECURITY"]
  dependencies:
    tickets: []

root_cause_analysis:
  summary: |
    `apm2 fac gates` currently fails silently or with raw system errors on a
    fresh worktree because the FAC substrate (directory tree, lane pool, policy
    root, economics profile, worker readiness) is not initialized automatically.
    Operators must manually run `apm2 fac bootstrap` and related adopt commands
    before gates are usable. This requirement for a specific manual setup
    sequence is undocumented from the implementor agent perspective, causes
    first-run failures that appear as gate bugs rather than infrastructure gaps,
    and prevents autonomous agent operation on freshly provisioned worktrees.

    Compounding bug: `apm2 daemon doctor` falsely reports broker_socket ERROR
    even when the daemon is healthy and running under systemd. Root cause is a
    socket path mismatch between ecosystem.toml and the systemd socket unit:

      - The systemd .socket unit uses ListenStream=%t/apm2/operator.sock
        (i.e., $XDG_RUNTIME_DIR/apm2/operator.sock, e.g. /run/user/1000/apm2/operator.sock).
      - ecosystem.toml hardcodes operator_socket = "/tmp/apm2/operator.sock".
      - main.rs has a correct XDG-aware default_operator_socket() fallback but
        it is never reached when ecosystem.toml is present and parses successfully.
      - The generated apm2-daemon.service also sets PrivateTmp=yes, making all
        /tmp/ paths written by the daemon invisible to the CLI (private tmpfs).
        Any pid file, log dir, or state file under /tmp/ in ecosystem.toml is
        equally unreachable.

    As a result, the ReadinessController's broker/worker health check would
    probe /tmp/apm2/operator.sock, find nothing, and falsely emit PREP_NOT_READY
    — even on a healthy system. The socket path must be derived from
    XDG_RUNTIME_DIR at runtime, not read from ecosystem.toml.

scope:
  in_scope:
    - id: "S1_READINESS_CONTROLLER"
      title: "Implement ReadinessController with check/autofix/recheck loop"
      detail: |
        Define a ReadinessController struct with a run() method that:
          1. Checks each substrate component in dependency order.
          2. For any component that is missing or invalid, invokes the
             corresponding autofix routine (idempotent, same as bootstrap).
          3. Rechecks the fixed component; on failure emits PREP_NOT_READY.
        Components (in check order):
          - FAC root directory tree + permissions
          - Lane pool (at least one lane initialized)
          - Admitted canonicalizer tuple (policy root hash, toolchain, resolver)
          - Admitted economics profile
          - Worker and broker process readiness (ping/health check)
          - Managed cargo_home directory and local dependency substrate
    - id: "S2_GATES_INTEGRATION"
      title: "Wire ReadinessController as the first step of apm2 fac gates"
      detail: |
        Before any gate is enqueued or executed, call ReadinessController::run().
        Gate execution proceeds only after run() returns Ok(()).
        On Err, emit structured PREP_NOT_READY failure (per REQ-0035 taxonomy)
        and exit. Do not start any gate processes on readiness failure.
    - id: "S3_IDEMPOTENCY"
      title: "Ensure controller is a no-op on a ready substrate"
      detail: |
        On a substrate that is already fully ready, ReadinessController::run()
        MUST complete in under 100 ms and make no observable mutations.
        Write a benchmark/test that measures controller overhead on a ready system.
    - id: "S4_REGRESSION_TESTS"
      title: "Regression tests covering fresh-substrate and partial-substrate scenarios"
      detail: |
        - Test: empty APM2_HOME → controller auto-heals → gates succeed.
        - Test: missing lane pool → controller creates lanes → gates succeed.
        - Test: autofix failure → PREP_NOT_READY emitted → no gates run.
        - Test: fully ready substrate → controller is a no-op.
        - Test: daemon running on XDG socket + ecosystem.toml with /tmp path →
          broker/worker check succeeds (uses XDG path, not ecosystem.toml path).
        - Test: PrivateTmp=yes service environment → no /tmp paths are probed.

    - id: "S5_FIX_DAEMON_SOCKET_PATH"
      title: "Fix socket path resolution: derive from XDG_RUNTIME_DIR, not ecosystem.toml"
      detail: |
        Root cause: ecosystem.toml hardcodes /tmp/apm2/operator.sock but the
        systemd socket unit uses $XDG_RUNTIME_DIR/apm2/operator.sock, and
        PrivateTmp=yes makes /tmp invisible to the CLI process.

        Fix (option 3 from bug report — correct long-term):
          - Remove operator_socket (and any other /tmp-based paths: pid_file,
            log_dir, state_file) from the [daemon] section of ecosystem.toml.
            Make these fields optional in EcosystemConfig; they should not be
            present in the generated or checked-in ecosystem.toml.
          - In all code that resolves the operator socket path, always use
            default_operator_socket() (the XDG-aware function that already
            exists in main.rs) regardless of whether ecosystem.toml is present.
          - If ecosystem.toml still needs to override the socket path for
            non-systemd setups, accept $XDG_RUNTIME_DIR as a literal variable
            in the path string and expand it at read time — never a bare /tmp
            path.
          - Update ecosystem.toml (checked-in example/default) to remove the
            [daemon] socket/tmp path fields entirely.

        Secondary fix: audit all ecosystem.toml-sourced paths for /tmp prefixes.
        Any path used by the daemon process that has PrivateTmp=yes must not
        live under /tmp/. Redirect pid_file, log_dir, and state_file to
        $XDG_RUNTIME_DIR/apm2/ or $HOME/.local/share/apm2/ as appropriate.
    - id: "S6_VERDICT_COMMENT_RESYNC"
      title: "Fix: second reviewer decision fails to appear in GitHub verdict comment"
      detail: |
        Observed on PR #746: the GitHub verdict comment is created correctly
        with the first reviewer's decision, but when the second reviewer's
        decision lands the comment is not updated to show both decisions.

        Location: verdict_projection.rs project_decision_comment_with()
          (lines 788-924), persist_verdict_projection_impl() (lines 568-719).

        Key invariants confirmed during initial investigation:
          - DecisionProjectionRecord stored at:
              ~/.apm2/fac_projection/repos/{owner_repo}/pr-{N}/verdict_projection.json
              and SHA-specific copy at sha-{sha}/verdict_projection.json.
          - Both reviewers on the same machine share ~/.apm2 and the fs2 lock.
          - projection_record_to_payload() copies all record.dimensions.
          - VERDICT_MARKER and DECISION_MARKER are the same value
            ("apm2-review-verdict:v1"); tombstone markers also match.
          - On the happy path (same machine, serialised by lock), the code
            appears correct: second reviewer loads record with first
            reviewer's dimension already present, renders body with both.

        Likely root cause (not yet confirmed):
          When the second reviewer has no local projection record (cross-
          APM2_HOME, integrity HMAC failure, or SHA mismatch), commit 0edac29c
          added a "discover existing remote comment and update" path via
          fetch_latest_live_verdict_comment_id(). This path correctly finds
          and updates the existing GitHub comment, but renders the body from
          a fresh record containing only the current reviewer's single
          dimension — overwriting the first reviewer's verdict on GitHub.

        Possible root causes still to confirm:
          A. Integrity HMAC verification failure on record load causes
             load_decision_projection_for_home() to return Err, propagating
             an error to the caller (second verdict silently fails).
          B. SHA mismatch between reviewers (new commit pushed between
             reviews) → record load returns None → fresh record → single-
             dimension body overwrites comment.
          C. Cross-APM2_HOME: second reviewer has no local record → finds
             existing GitHub comment → updates with single-dimension body.
          D. Race condition: record loaded before first reviewer saves
             despite the fs2 lock (e.g., lock not held across the full
             load-modify-save cycle).

        Fix direction (to be confirmed after deeper investigation):
          - If C/D: when updating an existing remote comment discovered via
            fetch_latest_live_verdict_comment_id(), parse the existing
            comment body to extract prior dimensions, merge with the incoming
            dimension, render the merged body, then update.
          - If A: surface the integrity verification error clearly.
          - If B: no fix needed (SHA mismatch is correct behaviour).
    - id: "S7_V3_NON_STATUS_EVIDENCE_REUSE"
      title: "Harden non-status evidence path to reuse v3 gate cache deterministically"
      detail: |
        In `run_evidence_gates_with_lane_context`, load native v3 gate cache
        material (compound key + signatures) and apply v3-first reuse decisions
        consistently across all non-status phases:
          - rustfmt, clippy, doc
          - test_safety_guard
          - test
          - workspace_integrity
          - review_artifact_lint
        Reuse behavior remains fail-closed: if v3 cache context or payload
        resolution is unavailable, treat as cache miss and execute gate.
    - id: "S8_CACHE_HIT_MARKER_LOGS"
      title: "Emit lane-local cache-hit marker logs for deterministic evidence artifacts"
      detail: |
        For non-status cache-hit paths, write marker logs using
        `write_cached_gate_log_marker` and store lane-local log paths in
        `EvidenceGateResult`. This ensures deterministic log-bundle hashing
        and prevents stale/non-local cached paths from weakening evidence
        reproducibility.
    - id: "S9_EVIDENCE_REGRESSION_SUITE"
      title: "Add regression tests for v3 cache integration points"
      detail: |
        Add/maintain targeted regressions proving:
          - non-status evidence path reuses persisted v3 entries across all phases
            (including workspace_integrity),
          - v3-only cache hits succeed without v2 presence,
          - receipt-bound rebinding promotes cache entries for reuse.
    - id: "S10_GATES_FAILURE_O11Y"
      title: "Improve queued gates failure observability"
      detail: |
        Preserve gate-level failure context when worker-executed gates fail:
          - propagate deterministic failure summaries from `fac_review::gates`
            into queued worker denial reasons,
          - include failed gate names and first actionable failure hint/log pointer,
          - parse propagated `failed_gates=...` markers in push fallback paths
            so `gate_error` telemetry no longer degrades to `gate=unknown` when
            cache artifacts are unavailable,
          - enforce UTF-8-safe bounded reason strings for FAC receipt compatibility
            (512-char cap),
          - add regression tests for summary propagation and truncation behavior.

  out_of_scope:
    - "Gate ordering changes or broad gate algorithm redesign."
    - "Network-independence enforcement (REQ-0033, TCK-00622)."
    - "Structured stdout JSONL schema (REQ-0036, TCK-00625)."
    - "Any manual operator bootstrap sequence exposed to implementors."

plan:
  steps:
    - id: "STEP_01"
      title: "Define ReadinessController struct and component check interface"
      detail: |
        In fac_review/ or a new fac_readiness module, define:
          - SubstrateComponent enum (FacRoot, LanePool, Canonicalizer,
            EconomicsProfile, WorkerBroker, CargoDeps)
          - ComponentStatus: Ready | Missing | Invalid | FixFailed(String)
          - ReadinessController::check_all() -> Vec<(SubstrateComponent, ComponentStatus)>
          - ReadinessController::autofix(component) -> Result<(), String>
          - ReadinessController::run() -> Result<(), ReadinessError>
    - id: "STEP_02"
      title: "Implement autofix routines for each component"
      detail: |
        Reuse bootstrap logic from fac_bootstrap.rs for directory creation,
        policy initialization, and lane pool creation. Wire worker/broker
        ping from existing health-check paths. Make each routine idempotent.
    - id: "STEP_03"
      title: "Integrate ReadinessController into apm2 fac gates entry point"
      detail: |
        In fac.rs gates subcommand handler: call ReadinessController::run()
        before dispatching to the gate evaluation pipeline. On error, emit
        structured failure and return non-zero exit code.
    - id: "STEP_04"
      title: "Fix daemon socket path resolution (XDG-aware, /tmp-free)"
      detail: |
        Remove operator_socket, pid_file, log_dir, and state_file /tmp paths
        from ecosystem.toml [daemon] section. Make EcosystemConfig fields
        optional. Update all call sites that resolve operator socket path to
        use default_operator_socket() unconditionally (ignoring ecosystem.toml
        for this field). Redirect daemon-written paths from /tmp/ to
        $XDG_RUNTIME_DIR/apm2/ or $HOME/.local/share/apm2/. Update the
        generated ecosystem.toml example to omit [daemon] path fields.
    - id: "STEP_05"
      title: "Add regression tests"
      detail: |
        Cover: empty APM2_HOME auto-heal, partial substrate, autofix failure,
        no-op on ready substrate. Daemon-on-XDG-socket + /tmp-in-ecosystem
        → broker check succeeds. PrivateTmp fixture → no /tmp probe.
        Use temp dir fixtures for isolation.
    - id: "STEP_06"
      title: "Run full workspace validation"
      detail: |
        cargo fmt --all
        cargo clippy --workspace --all-targets --all-features -- -D warnings
        cargo doc --workspace --no-deps
        cargo test --workspace
    - id: "STEP_07"
      title: "Backfill non-status v3 cache reuse on all gate phases"
      detail: |
        Ensure v3 reuse path is wired for workspace_integrity and all
        non-status gate phases, using the same v3-first decision and payload
        resolution flow as status-path execution.
    - id: "STEP_08"
      title: "Lock deterministic cache-hit evidence + regressions"
      detail: |
        Emit lane-local cache-hit marker logs and add integration tests that
        reproduce historical non-status reuse failures and verify the fix.

definition_of_done:
  evidence_ids:
    - "EXEC-TCK00620-READINESS-CONTROLLER"
    - "EXEC-TCK00620-FRESH-WORKTREE-SUCCESS"
    - "EXEC-TCK00620-SOCKET-PATH-FIX"
    - "EXEC-TCK00620-VERDICT-RESYNC-FIX"
    - "EXEC-TCK00620-EVIDENCE-V3-REUSE"
    - "EXEC-TCK00620-EVIDENCE-V3-REGRESSIONS"
    - "EXEC-TCK00620-WORKSPACE-VALIDATION"
  criteria:
    - "ReadinessController is implemented with check/autofix/recheck for all six substrate components."
    - "apm2 fac gates invokes ReadinessController before any gate runs."
    - "Fresh APM2_HOME with valid config: apm2 fac gates succeeds on first invocation."
    - "Autofix failure produces structured PREP_NOT_READY output with no raw system errors."
    - "Controller is a no-op (< 100 ms) on a fully ready substrate."
    - "operator_socket and /tmp-based path fields are removed from ecosystem.toml [daemon] section."
    - "All broker/worker socket path resolution uses default_operator_socket() (XDG-aware) unconditionally."
    - "apm2 daemon doctor reports broker_socket OK when daemon is running on the XDG socket path."
    - "No daemon-written paths (pid file, log dir, state file) remain under /tmp/ in ecosystem.toml."
    - "Regression tests pass for XDG socket resolution and PrivateTmp isolation invariants."
    - "Regression tests pass for all fresh/partial/failure scenarios."
    - "Root cause of verdict comment resync failure is confirmed and fixed."
    - "After both reviewer decisions land, the GitHub verdict comment shows
      all dimensions — no dimension is silently overwritten or lost."
    - "Non-status evidence path reuses valid v3 cache entries across all phases,
      including workspace_integrity."
    - "Cache-hit evidence artifacts use lane-local marker logs and remain
      deterministic for log-bundle hashing."
    - "Regression tests pass for v3-only cache hits, receipt-rebind promotion,
      and full non-status v3 reuse integration coverage."
    - "Queued gates denial reasons include deterministic gate-level failure
      summaries when available and remain UTF-8-safe within receipt bounds."
    - "Push telemetry emits concrete failed gate identifiers when failure
      summaries include `failed_gates=...` markers."
    - "Workspace validation (fmt, clippy, doc, test) completes successfully."

notes:
  context: |
    This is the foundation ticket for the gates usability redesign. All
    subsequent tickets in the REQ-0031..REQ-0039 cluster depend on the
    ReadinessController being in place. The autofix routines should reuse
    the existing fac_bootstrap.rs logic rather than duplicating it.

    The daemon socket path bug (S5) is included here because the ReadinessController's
    broker/worker health check is the first consumer of the socket path in the gates
    flow. If the path is wrong, the controller emits a false PREP_NOT_READY — making
    the fix a prerequisite for correct broker readiness checking. The fix removes
    socket/tmp path fields from ecosystem.toml entirely and makes all path resolution
    XDG-aware unconditionally, matching the invariant enforced by the systemd socket
    unit (ListenStream=%t/apm2/operator.sock) and the PrivateTmp=yes service sandbox.
  amendments:
    - amendment_id: "AMD-2026-02-18-EVIDENCE-V3-SCOPE-REALIGN"
      summary: "Record executed v3 evidence-cache hardening work to prevent scope ambiguity after PR741/PR746 integration."
      supersedes:
        - "Out-of-scope statement excluding all gate execution logic changes."
      replacement:
        - "Gate ordering remains unchanged, while targeted evidence execution-path hardening for deterministic v3 cache reuse and regression prevention is in-scope."
    - amendment_id: "AMD-2026-02-18-GATES-O11Y"
      summary: "Scope explicitly includes gate-failure observability hardening for queued worker execution."
      supersedes:
        - "Implicit assumption that gate failure reasons can remain exit-code only."
      replacement:
        - "Queued gate failures must surface deterministic per-gate failure context in denial receipts while preserving bounded, replay-safe reason strings."
  security: "default-deny; readiness failure is fail-closed (no gates run); XDG socket path removes /tmp TOCTOU surface from PrivateTmp=yes sandbox"

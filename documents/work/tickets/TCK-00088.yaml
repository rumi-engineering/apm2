ticket_meta:
  schema_version: "2026-01-25"
  template_version: "2026-01-25"
  ticket:
    id: "TCK-00088"
    title: "Define agent exit protocol and session cleanup"
  binds:
    prd_id: "PRD-0004"
    rfc_id: "RFC-0008"
    requirements:
      - requirement_id: "REQ-0008"
        requirement_ref: "documents/prds/PRD-0004/requirements/REQ-0008.yaml#prd_requirement"
    evidence_artifacts:
      - "EVID-8004"
  custody:
    agent_roles:
      - "AGENT_IMPLEMENTER"
    responsibility_domains:
      - "DOMAIN_RUNTIME"
  dependencies:
    tickets:
      - "TCK-00087"
  scope:
    in_scope:
      - "Define agent exit signal JSON schema"
      - "Implement exit signal parsing and validation"
      - "Emit AgentSessionCompleted event on valid exit signal"
      - "Update work item phase based on exit signal"
      - "Release lease on session cleanup"
      - "Document exit protocol for agent implementers"
      - "Add feature flag AGENT_EXIT_PROTOCOL_ENABLED"
    out_of_scope:
      - "Modifying existing agent implementations (separate effort)"
      - "Integration tests (TCK-00089)"
      - "Agent crash/timeout handling (future enhancement)"
  plan:
    steps:
      - "Define ExitSignal struct matching JSON schema in contract"
      - "Implement serde deserialization with validation"
      - "Create exit signal handler that validates and processes signals"
      - "Implement AgentSessionCompleted event emission"
      - "Update work item phase based on phase_completed field"
      - "Implement lease release on session end"
      - "Add feature flag check before validation"
      - "Write protocol documentation with examples"
      - "Write unit tests for exit signal parsing"
      - "Write unit tests for session cleanup"
  definition_of_done:
    evidence_ids:
      - "EVID-8004"
    criteria:
      - "ExitSignal struct defined with all required fields"
      - "Exit signal validates protocol field is 'apm2_agent_exit'"
      - "Exit signal validates version field"
      - "Invalid exit signals return clear error messages"
      - "AgentSessionCompleted event emitted on valid exit"
      - "Work item phase updated based on exit signal"
      - "Lease released on session cleanup"
      - "Protocol documentation complete with examples"
      - "Feature flag AGENT_EXIT_PROTOCOL_ENABLED controls validation"
      - "Unit tests pass for parsing and cleanup"
  notes:
    implementation_details: |
      Exit signal schema:
      ```rust
      #[derive(Debug, Clone, Serialize, Deserialize)]
      pub struct ExitSignal {
          pub protocol: String, // Must be "apm2_agent_exit"
          pub version: String,  // "1.0.0"
          pub phase_completed: WorkPhase,
          pub exit_reason: ExitReason,
          #[serde(skip_serializing_if = "Option::is_none")]
          pub pr_url: Option<String>,
          #[serde(skip_serializing_if = "Option::is_none")]
          pub evidence_bundle_ref: Option<String>,
          #[serde(skip_serializing_if = "Option::is_none")]
          pub notes: Option<String>,
      }

      #[derive(Debug, Clone, Serialize, Deserialize)]
      #[serde(rename_all = "snake_case")]
      pub enum ExitReason {
          Completed,
          Blocked,
          Error,
      }

      impl ExitSignal {
          pub fn validate(&self) -> Result<(), ExitSignalError> {
              if self.protocol != "apm2_agent_exit" {
                  return Err(ExitSignalError::UnknownProtocol(self.protocol.clone()));
              }
              if !self.version.starts_with("1.") {
                  return Err(ExitSignalError::UnsupportedVersion(self.version.clone()));
              }
              Ok(())
          }
      }
      ```

      Session cleanup:
      ```rust
      async fn handle_session_end(
          session_id: Uuid,
          exit_signal: Option<ExitSignal>,
          session_store: &SessionStore,
          work_store: &WorkStore,
          lease_store: &LeaseStore,
      ) -> Result<(), Error> {
          let session = session_store.get(session_id).await?;

          // Release lease
          if let Some(lease_id) = session.lease_id {
              lease_store.release(lease_id).await?;
          }

          // Update work item if exit signal provided
          if let Some(signal) = exit_signal {
              if let Some(work_id) = session.work_id {
                  let next_phase = match signal.phase_completed {
                      WorkPhase::Implementation => WorkPhase::CIPending,
                      WorkPhase::Review => WorkPhase::ReadyForMerge,
                      _ => signal.phase_completed, // Keep same for others
                  };
                  work_store.transition(&work_id, next_phase).await?;
              }
          }

          // Mark session as ended
          session_store.end(session_id).await?;

          Ok(())
      }
      ```
    protocol_documentation: |
      # Agent Exit Protocol

      When an agent completes a work phase, it MUST emit a structured exit signal
      to enable clean handoff to the next agent.

      ## JSON Schema

      ```json
      {
        "protocol": "apm2_agent_exit",
        "version": "1.0.0",
        "phase_completed": "IMPLEMENTATION",
        "exit_reason": "completed",
        "pr_url": "https://github.com/org/repo/pull/123",
        "evidence_bundle_ref": "evidence/work/W-00042/phase_implementation.yaml",
        "notes": "Implementation complete, ready for CI"
      }
      ```

      ## Required Fields

      - `protocol`: Must be "apm2_agent_exit"
      - `version`: Protocol version (currently "1.0.0")
      - `phase_completed`: The work phase that was just completed
      - `exit_reason`: Why the session is ending
        - "completed": Work phase finished successfully
        - "blocked": Cannot proceed due to external blocker
        - "error": Session ending due to error

      ## Optional Fields

      - `pr_url`: GitHub PR URL if a PR was created
      - `evidence_bundle_ref`: Path to evidence bundle for this phase
      - `notes`: Human-readable notes about the exit

      ## Example: Implementation Complete

      ```json
      {
        "protocol": "apm2_agent_exit",
        "version": "1.0.0",
        "phase_completed": "IMPLEMENTATION",
        "exit_reason": "completed",
        "pr_url": "https://github.com/org/repo/pull/123",
        "notes": "Implemented feature X, all tests passing locally"
      }
      ```

      ## What Happens After Exit

      1. System validates the exit signal
      2. AgentSessionCompleted event is emitted to ledger
      3. Work item transitions to next phase (IMPLEMENTATION -> CI_PENDING)
      4. Lease is released
      5. CI runs (for CI_PENDING work)
      6. Fresh agent claims work when ready
    affected_files: |
      New:
        - crates/apm2-core/src/agent/exit.rs
        - crates/apm2-core/src/agent/mod.rs
        - documents/protocols/AGENT_EXIT_PROTOCOL.md
      Modified:
        - crates/apm2-core/src/lib.rs (add agent module)
        - crates/apm2-core/src/session/mod.rs (add cleanup logic)

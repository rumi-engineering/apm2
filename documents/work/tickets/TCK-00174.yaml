acceptance_criteria:
  - criterion: apm2 episode create/start/stop/status commands
    verification: All commands execute successfully
  - criterion: JSON output for machine readability
    verification: --json flag produces valid JSON
  - criterion: Integration with daemon via UDS
    verification: CLI connects to daemon socket
implementation:
  code_examples:
    - description: CLI commands
      code: |
        // apm2 episode create --envelope envelope.yaml
        // apm2 episode start <episode_id>
        // apm2 episode stop <episode_id> [--reason <reason>]
        // apm2 episode status <episode_id>
        // apm2 episode list [--state <state>]

        pub fn episode_create(envelope_path: &Path) -> Result<EpisodeId>;
        pub fn episode_start(episode_id: &EpisodeId) -> Result<SessionHandle>;
        pub fn episode_stop(episode_id: &EpisodeId, reason: StopReason) -> Result<()>;
        pub fn episode_status(episode_id: &EpisodeId) -> Result<EpisodeState>;
  files_to_create:
    - path: crates/apm2-cli/src/commands/episode.rs
      purpose: Episode CLI commands
    - path: crates/apm2-cli/src/client/daemon.rs
      purpose: Daemon client for UDS communication
    - path: crates/apm2-cli/src/output/json.rs
      purpose: JSON output formatting
  files_to_modify:
    - changes: Add episode subcommand
      path: crates/apm2-cli/src/main.rs
    - changes: Export episode, client modules
      path: crates/apm2-cli/src/lib.rs
  implementation_steps:
    - step: 1
      action: Implement daemon client
      details: |
        Create client for daemon communication:
        - Connect to ${XDG_RUNTIME_DIR}/apm2/apm2d.sock
        - Frame messages with length prefix
        - Handle version negotiation
        - Async request/response
    - step: 2
      action: Implement episode create
      details: |
        Command: apm2 episode create --envelope <path>
        - Load envelope from YAML file
        - Send CreateEpisode to daemon
        - Print episode_id on success
    - step: 3
      action: Implement episode start/stop
      details: |
        Commands:
        - apm2 episode start <id>: Start episode, print session info
        - apm2 episode stop <id> [--reason]: Stop episode
        - Handle errors gracefully
    - step: 4
      action: Implement episode status
      details: |
        Command: apm2 episode status <id>
        - Query daemon for episode state
        - Print state, budget remaining, telemetry summary
        - --json for machine-readable output
    - step: 5
      action: Implement JSON output
      details: |
        --json flag on all commands:
        - Serialize response to JSON
        - Include all relevant fields
        - Exit codes: 0=success, 1=error
  summary: |
    Implement apm2 episode CLI commands for episode management.
    Commands: create, start, stop, status, list.
    Includes JSON output mode and daemon UDS integration.
notes: |
  Phase: PHASE-4 (Integration and CLI)
  Generated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.
  Maps to TCK-PEND-017.
schema_version: "2026-01-27"
template_version: "2026-01-27"
test_requirements:
  - description: CLI create command
    test_id: IT-00174-01
    verification_command: cargo test -p apm2-cli --test integration episode_create
  - description: CLI start/stop
    test_id: IT-00174-02
    verification_command: cargo test -p apm2-cli --test integration episode_lifecycle
  - description: JSON output
    test_id: UT-00174-01
    verification_command: cargo test -p apm2-cli json_output
ticket:
  depends_on:
    - TCK-00173
    - TCK-00172
  id: TCK-00174
  requirement_ids: []
  rfc_id: RFC-0013
  status: READY
  title: Implement apm2 episode CLI commands

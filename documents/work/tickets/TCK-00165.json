{
  "schema": "apm2.ticket.v1",
  "ticket_meta": {
    "schema_version": "2026-01-27",
    "template_version": "2026-01-27",
    "ticket": {
      "id": "TCK-00165",
      "title": "Implement tool execution and budget charging",
      "status": "CLOSED"
    },
    "binds": {
      "rfc_id": "RFC-0013",
      "requirements": [
        {
          "requirement_id": "REQ-TOOL-001"
        }
      ]
    }
  },
  "dependencies": {
    "tickets": [
      {
        "ticket_id": "TCK-00164"
      }
    ]
  },
  "acceptance_criteria": [
    {
      "criterion": "Tool executor with budget charging",
      "verification": "Budget decremented after execution"
    },
    {
      "criterion": "CAS storage for tool results",
      "verification": "Results stored with content hash"
    },
    {
      "criterion": "OCAP enforcement during execution",
      "verification": "Capability violations prevented"
    }
  ],
  "implementation": {
    "code_examples": [
      {
        "description": "Tool execution flow",
        "code": "pub struct ToolExecutor {\n    budget_tracker: Arc<BudgetTracker>,\n    cas: Arc<ContentAddressedStore>,\n    executors: HashMap<ToolClass, Box<dyn ToolHandler>>,\n}\n\nimpl ToolExecutor {\n    pub async fn execute(\n        &self,\n        episode_id: EpisodeId,\n        decision: ToolDecision,\n        args: ToolArgs,\n    ) -> Result<ToolResult> {\n        // Charge budget\n        self.budget_tracker.charge(&decision.budget_delta)?;\n\n        // Execute tool\n        let handler = self.executors.get(&decision.tool_class)?;\n        let result = handler.execute(args).await?;\n\n        // Store result in CAS\n        let result_hash = self.cas.store(&result)?;\n\n        Ok(ToolResult {\n            request_id: decision.request_id,\n            outcome: ToolOutcome::Success,\n            result_hash,\n            duration_ms: elapsed,\n        })\n    }\n}\n"
      }
    ],
    "files_to_create": [
      {
        "path": "crates/apm2-daemon/src/episode/executor.rs",
        "purpose": "ToolExecutor and execution logic"
      },
      {
        "path": "crates/apm2-daemon/src/episode/budget_tracker.rs",
        "purpose": "Episode budget tracking and charging"
      },
      {
        "path": "crates/apm2-daemon/src/episode/tool_handler.rs",
        "purpose": "ToolHandler trait for tool implementations"
      }
    ],
    "files_to_modify": [
      {
        "changes": "Export executor, budget_tracker, tool_handler modules",
        "path": "crates/apm2-daemon/src/episode/mod.rs"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "action": "Define ToolHandler trait",
        "details": "Create trait for tool implementations:\n- tool_class() -> ToolClass\n- execute(args: ToolArgs) -> Result<ToolResultData>\n- validate(args: &ToolArgs) -> Result<()>\n"
      },
      {
        "step": 2,
        "action": "Implement BudgetTracker",
        "details": "Create budget tracking per episode:\n- from_envelope(budget: EpisodeBudget) -> BudgetTracker\n- charge(delta: &BudgetDelta) -> Result<()>\n- remaining() -> EpisodeBudget\n- is_exhausted() -> bool\n"
      },
      {
        "step": 3,
        "action": "Implement ToolExecutor",
        "details": "Create executor with:\n- Registry of ToolHandlers by class\n- Budget charging before execution\n- Result storage in CAS\n- Duration tracking\n"
      },
      {
        "step": 4,
        "action": "Implement basic tool handlers",
        "details": "Create handlers for core tools:\n- ReadFileHandler: reads files within scope\n- WriteFileHandler: writes files within scope\n- ExecuteHandler: runs commands\nAll validate against capability scope\n"
      },
      {
        "step": 5,
        "action": "Emit ToolExecuted event",
        "details": "After execution, emit event:\n- request_id, result_hash\n- duration_ms, outcome\n- budget_remaining\n"
      }
    ],
    "summary": "Implement tool execution and budget charging per AD-TOOL-001.\nToolExecutor charges budget before execution, stores results in CAS,\nand enforces OCAP throughout the execution flow.\n"
  },
  "notes": "Phase: PHASE-2B (Tool Execution and Receipts)\nGenerated from RFC RFC-0013 DECOMPOSE session on 2026-01-27.\nMaps to TCK-PEND-009a.\n",
  "test_requirements": [
    {
      "description": "Budget charging",
      "test_id": "UT-00165-01",
      "verification_command": "cargo test -p apm2-daemon budget_charge"
    },
    {
      "description": "CAS storage",
      "test_id": "UT-00165-02",
      "verification_command": "cargo test -p apm2-daemon tool_cas_storage"
    },
    {
      "description": "Budget exhaustion",
      "test_id": "UT-00165-03",
      "verification_command": "cargo test -p apm2-daemon budget_exhaustion"
    }
  ]
}

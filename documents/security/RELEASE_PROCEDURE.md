## Release Procedure

The following procedure is the required operational sequence for publishing an APM2 release under **MODE_HIGH_ASSURANCE**. If any mandatory step fails, the correct response is to stop, remediate, and restart the procedure.

1. **Confirm release intent and scope**

   * Identify the release type (patch/minor/major) and the exact commit range to be included.
   * Confirm that the release corresponds to a known baseline (e.g., main branch HEAD or a designated release branch).

2. **Confirm the repository is in High Assurance posture**

   * Ensure the release is executed under the release workflow that enforces **MODE_HIGH_ASSURANCE** (the default release posture).
   * Do not rely on local `APM2_SECURITY_MODE=developer` behavior for release validation.

3. **Ensure the mainline is green**

   * Confirm all required CI checks are green on the commit you intend to release.
   * If any check is failing, do not proceed.

4. **Re-validate security gates (release-candidate confidence check)**

   * Confirm the CI results include the required security gates:

     * `cargo clippy --all-targets -- -D warnings`
     * `cargo deny check`
     * `cargo audit`
   * Ensure the results are for the exact commit to be released (not a prior commit).

5. **Confirm dependency policy compliance**

   * Inspect `Cargo.lock` changes included in the release scope.
   * Confirm there are no unexpected dependency additions or feature flag expansions that violate policy.
   * If the release includes dependency upgrades, confirm `cargo-deny` and `cargo-audit` were run successfully for that exact lockfile.

6. **Confirm secret hygiene prerequisites**

   * Review for accidental secret commits (use `git log -p -S` for targeted searches).
   * If release artifacts are built outside CI for any reason, stop; releases should be produced only by the controlled CI pipeline.

7. **Prepare release metadata**

   * Update versioning and changelog/release notes according to your projectâ€™s release conventions (if applicable).
   * Ensure release notes do not include secrets or sensitive operational details.

8. **Create the release tag**

   * Create an annotated tag for the release (recommended) pointing to the release commit.
   * Push the tag to the canonical repository so that the release automation triggers from the authoritative source.

9. **Trigger the release workflow**

   * Confirm that the GitHub Actions release workflow runs for the pushed tag.
   * Monitor the workflow execution until completion.

10. **Verify Sigstore signing outputs**

    * Confirm that each release artifact has:

      * a corresponding `.sig` signature file
      * a corresponding `.pem` certificate file
    * Confirm these files are attached/published alongside the artifacts as required.

11. **Verify SLSA provenance outputs**

    * Confirm that SLSA Level 3 provenance was generated by `slsa-github-generator`.
    * Confirm the provenance is attached to the GitHub release (or otherwise published in the expected location).

12. **Verify SBOM outputs**

    * Confirm SBOM generation completed successfully via `syft`.
    * Confirm both CycloneDX and SPDX formats are present and attached to the release artifacts.

13. **Perform cryptographic verification of at least one artifact (spot-check)**

    * Using the published `.pem` and `.sig`, verify the artifact signature using `cosign verify-blob` with the required identity and issuer constraints:

      ```bash
      cosign verify-blob \
        --certificate <artifact>.pem \
        --signature <artifact>.sig \
        --certificate-identity-regexp "https://github.com/.*/apm2/.*" \
        --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
        <artifact>
      ```
    * If verification fails, treat as a release integrity incident and halt publication.

14. **Confirm artifact set completeness**

    * Ensure the release contains all expected build outputs for supported targets.
    * Ensure each artifact has its associated signature, certificate, provenance, and SBOMs as required.

15. **Final publication**

    * Publish the GitHub release if it is still in draft state.
    * Ensure release notes and assets match the verified artifacts.

16. **Post-release integrity check (administrative)**

    * Record the release tag, artifact digests, and verification evidence (e.g., output of `cosign verify-blob`) in your release tracking system.
    * Confirm no subsequent edits were made to release assets that would invalidate published signatures or provenance.

17. **If a security issue is discovered during or after release**
    * Stop further releases.
    * Open a GitHub Security Advisory if appropriate.
    * Classify severity and follow the response-time table (Critical: 24h; High: 7d; Medium: 30d; Low: 90d).
    * Coordinate disclosure per policy: acknowledge within 48h and disclose publicly after a patch is available.
syntax = "proto3";

package apm2.daemon.v1;

// CTR-PROTO-001: Handshake
message Hello {
  uint32 protocol_version = 1;
  ClientInfo client_info = 2;
  repeated string requested_caps = 3;
}

message HelloAck {
  ServerInfo server_info = 1;
  repeated string granted_caps = 2;
  bytes policy_hash = 3;
  map<string, uint32> canonicalizer_versions = 4;
}

message ClientInfo {
  string name = 1;
  string version = 2;
}

message ServerInfo {
  string name = 1;
  string version = 2;
}

// CTR-PROTO-002: Episode Control
message CreateEpisode {
  bytes envelope_hash = 1;
}

message EpisodeCreated {
  string episode_id = 1;
  string session_id = 2;
}

message StartEpisode {
  string episode_id = 1;
}

message EpisodeStarted {
  uint32 session_pid = 1;
  string io_stream_id = 2;
}

message StopEpisode {
  string episode_id = 1;
  StopReason reason = 2;
}

message EpisodeStopped {
  TerminationClass termination_class = 1;
}

message SignalEpisode {
  string episode_id = 1;
  int32 signal = 2;
}

message ResizePty {
  string episode_id = 1;
  uint32 cols = 2;
  uint32 rows = 3;
}

// Minimal v1 vocabulary for evidence economics
message EpisodeQuarantined {
  string episode_id = 1;
  string reason = 2;
  repeated bytes evidence_pinned = 3;
}

enum StopReason {
  STOP_REASON_UNSPECIFIED = 0;
  GOAL_SATISFIED = 1;
  BUDGET_EXHAUSTED = 2;
  POLICY_VIOLATION = 3;
  USER_REQUEST = 4;
  HARNESS_CRASH = 5;
  ADAPTER_FAILURE = 6;
}

enum TerminationClass {
  TERMINATION_CLASS_UNSPECIFIED = 0;
  CLEAN_EXIT = 1;
  ERROR_EXIT = 2;
  QUARANTINED = 3;
}

// CTR-PROTO-003: I/O
message SendInput {
  string episode_id = 1;
  bytes data = 2;
}

message StreamOutput {
  bytes chunk = 1;
  StreamKind kind = 2;
  uint64 seq = 3;
  uint64 ts = 4;
}

enum StreamKind {
  STDOUT = 0;
  STDERR = 1;
}

// CTR-PROTO-004: Tool Mediation
message ToolRequest {
  string episode_id = 1;
  string request_id = 2;
  string tool = 3;
  bytes dedupe_key = 4;
  bytes args_hash = 5;
  optional bytes inline_args = 6;
}

message ToolDecision {
  string request_id = 1;
  DecisionType decision = 2;
  optional string rule_id = 3;
  bytes policy_hash = 4;
  BudgetDelta budget_delta = 5;
}

enum DecisionType {
  ALLOW = 0;
  DENY = 1;
  DEDUPE_HIT = 2;
}

message ToolResult {
  string request_id = 1;
  ToolOutcome outcome = 2;
  bytes result_hash = 3;
  optional bytes inline_result = 4;
}

message BudgetDelta {
  uint64 tokens = 1;
  uint32 tool_calls = 2;
  uint64 cpu_ms = 3;
}

enum ToolOutcome {
  TOOL_OUTCOME_UNSPECIFIED = 0;
  SUCCESS = 1;
  FAILURE = 2;
  ERROR = 3;
}

// CTR-PROTO-005: Telemetry
message TelemetryFrame {
  string episode_id = 1;
  uint64 seq = 2;
  uint64 ts_mono = 3;
  uint64 cpu_ns = 4;
  uint64 mem_rss_bytes = 5;
  uint64 io_read_bytes = 6;
  uint64 io_write_bytes = 7;
  optional CgroupStats cgroup_stats = 8;
  uint32 o11y_flags = 9;
}

message CgroupStats {
  uint64 cpu_usage_usec = 1;
  uint64 memory_current = 2;
  uint64 memory_max = 3;
}

message TelemetryPolicy {
  uint64 sample_period_ms = 1;
  repeated PromoteTrigger promote_triggers = 2;
  RingBufferLimits ring_buffer_limits = 3;
}

message PromoteTrigger {
  string metric = 1;
  double threshold = 2;
}

message RingBufferLimits {
  uint64 max_pty_bytes = 1;
  uint64 max_tool_bytes = 2;
  uint64 max_tel_frames = 3;
}

// CTR-PROTO-006: Receipts and Evidence
message PublishEvidence {
  bytes artifact_hash = 1;
  EvidenceKind kind = 2;
  RetentionHint retention_hint = 3;
}

message Receipt {
  ReceiptKind kind = 1;
  bytes unsigned_bytes_hash = 2;
  bytes signature = 3;
  repeated bytes evidence_refs = 4;
  bytes policy_hash = 5;
  bytes envelope_hash = 6;
  optional string issuer_id = 7;
  optional bytes issuer_signature = 8;
}

// Minimal v1 vocabulary events for evidence economics
message EvidencePinned {
  bytes artifact_hash = 1;
  string reason = 2;
  optional string defect_id = 3;
}

message EvidenceTtlExpired {
  bytes artifact_hash = 1;
  uint64 timestamp = 2;
}

message CompactionCompleted {
  bytes summary_receipt_hash = 1;
  repeated bytes tombstoned_hashes = 2;
}

enum ReceiptKind {
  TOOL_EXECUTION = 0;
  EPISODE_START = 1;
  EPISODE_STOP = 2;
  GATE = 3;
  TELEMETRY = 4;
  COMPACTION = 5;
  STOP_ORDER = 6;
}

enum EvidenceKind {
  EVIDENCE_KIND_UNSPECIFIED = 0;
  EVIDENCE_KIND_PTY_TRANSCRIPT = 1;
  EVIDENCE_KIND_TOOL_IO = 2;
  EVIDENCE_KIND_TELEMETRY_RAW = 3;
  EVIDENCE_KIND_ADAPTER_FAILURE = 4;
  EVIDENCE_KIND_INCIDENT_SNAPSHOT = 5;
}

enum RetentionHint {
  RETENTION_HINT_UNSPECIFIED = 0;
  EPHEMERAL = 1;
  STANDARD = 2;
  ARCHIVAL = 3;
}
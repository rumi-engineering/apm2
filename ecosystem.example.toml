# apm2 ecosystem configuration example
# Copy this file to ecosystem.toml and customize for your setup

[daemon]
pid_file = "/var/run/apm2/apm2.pid"
operator_socket = "/var/run/apm2/operator.sock"
session_socket = "/var/run/apm2/session.sock"
log_dir = "/var/log/apm2"
state_file = "/var/lib/apm2/state.json"

# Durable content-addressed storage (CAS) directory (TCK-00383).
# When provided alongside --ledger-db, enables full session dispatcher wiring:
# tool execution, event emission, and evidence publishing.
# The directory is created with mode 0700 if it does not exist.
cas_path = "/var/lib/apm2/cas"

# Divergence watchdog configuration (TCK-00393).
# Monitors external trunk HEAD against ledger MergeReceipt HEAD.
# On divergence: emits DefectRecorded + InterventionFreeze to halt admissions.
[daemon.divergence_watchdog]
enabled = false
github_owner = "rumi-engineering"
github_repo = "apm2"
trunk_branch = "main"
github_api_url = "https://api.github.com"
github_token_env = "$GITHUB_TOKEN"
poll_interval_secs = 30

# Adapter profile rotation (TCK-00400).
# Default rollout is operability-first: 100% claude-code-v1.
# Additional profiles can be enabled once their adapters are production-ready.
[daemon.adapter_rotation]
strategy = "weighted_random"
rate_limit_backoff_secs = 300

[[daemon.adapter_rotation.profiles]]
profile_id = "claude-code-v1"
weight = 100
enabled = true
fallback_priority = 0

[[daemon.adapter_rotation.profiles]]
profile_id = "gemini-cli-v1"
weight = 0
enabled = false
fallback_priority = 1

[[daemon.adapter_rotation.profiles]]
profile_id = "codex-cli-v1"
weight = 0
enabled = false
fallback_priority = 2

[[daemon.adapter_rotation.profiles]]
profile_id = "local-inference-v1"
weight = 0
enabled = false
fallback_priority = 3

# Credential profiles (stored securely in OS keyring)
# Use `apm2 creds add` to create profiles and store credentials

[[credentials]]
id = "claude-work"
provider = "claude"
auth_method = "session_token"

[[credentials]]
id = "claude-personal"
provider = "claude"
auth_method = "api_key"

[[credentials]]
id = "gemini-main"
provider = "gemini"
auth_method = "oauth"
refresh_before_expiry = "5m"

# Process definitions

[[processes]]
name = "claude-code-1"
command = "claude"
args = ["--session", "project-alpha"]
cwd = "/home/user/projects/alpha"
instances = 1

# Bind to credential profile (hot-swappable)
[processes.credentials]
profile = "claude-work"
hot_swap = true
hot_swap_signal = "SIGHUP"

[processes.restart]
max_restarts = 5
restart_window = "60s"
min_uptime = "30s"

[processes.restart.backoff]
type = "exponential"
initial_delay = "1s"
max_delay = "5m"

[processes.log]
out_file = "/var/log/apm2/claude-1.out.log"
err_file = "/var/log/apm2/claude-1.err.log"
timestamp = true

[processes.shutdown]
timeout = "30s"
signal = "SIGTERM"
force_kill = true

# Another process example
[[processes]]
name = "gemini-cli-1"
command = "gemini"
args = ["--project", "beta"]
cwd = "/home/user/projects/beta"

[processes.credentials]
profile = "gemini-main"
hot_swap = true
auto_refresh = true  # Auto-refresh OAuth token

[processes.restart]
max_restarts = 3
min_uptime = "10s"

# Health check example (future feature)
# [processes.health]
# type = "http"
# url = "http://localhost:8080/health"
# interval = "30s"
# timeout = "5s"
# unhealthy_threshold = 3

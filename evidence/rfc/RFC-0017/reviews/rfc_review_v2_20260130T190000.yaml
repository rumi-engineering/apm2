schema_version: "1.0.0"
rfc_id: RFC-0017
review_timestamp: "2026-01-30T19:00:00Z"
review_depth: COUNCIL
review_type: EXPLORE
phase_transition: "v0 -> v2"

# =============================================================================
# RFC-0017 COUNCIL EXPLORE REVIEW: v0 -> v2 (Grounded)
# =============================================================================
# This review documents the codebase exploration performed to transition
# RFC-0017 from v0 (Discovery) to v2 (Grounded) phase.
# =============================================================================

exploration_summary:
  total_open_questions: 7
  resolved: 7
  unresolved: 0
  deferred: 0

open_question_resolutions:
  - id: OQ-001
    question: "What existing Unix socket infrastructure exists in apm2-daemon?"
    status: RESOLVED
    prior_review: "rfc_review_20260130T120000.yaml"
    finding: |
      Two IPC stacks found: JSON IPC (apm2_core::ipc) and Protobuf Runtime
      Protocol (apm2_daemon::protocol). Protocol decision made: OPTION A
      (Adopt Protobuf Runtime Protocol) per DD-008.

  - id: OQ-001a
    question: "Which IPC protocol stack becomes the Phase 1 control plane?"
    status: RESOLVED
    decision: "OPTION A - Adopt Protobuf Runtime Protocol"
    decision_date: "2026-01-30"
    decision_by: "Human (operator)"
    evidence_ref: "02_design_decisions.yaml#DD-008"

  - id: OQ-002
    question: "How does daemon currently interact with governance components?"
    status: RESOLVED
    finding: |
      Daemon does NOT currently interact with governance. PolicyEngine exists
      in apm2-core/src/policy/engine.rs but is NOT wired into daemon.
      PolicyIntegratedValidator (episode/capability.rs:1160-1330) has TODO
      comments for future integration.
    evidence:
      - crates/apm2-core/src/policy/engine.rs
      - crates/apm2-core/src/fac/policy_resolution.rs
      - crates/apm2-daemon/src/episode/capability.rs
      - crates/apm2-daemon/src/handlers.rs

  - id: OQ-003
    question: "What existing capability/permission structures exist?"
    status: RESOLVED
    finding: |
      Five existing structures found:
      1. ContextPackManifest (context/manifest.rs) - OCAP file allowlist
      2. Capability lease-backed (lease/capability.rs) - delegation chain
      3. CapabilityManifest daemon (episode/capability.rs) - tool classes
      4. CapabilityScope (episode/scope.rs) - fine-grained restrictions
      5. CapabilityManifest CAC (cac/manifest.rs) - binary capabilities
      ANTI-COUSIN ANALYSIS: No new abstractions needed. Extend existing.
    evidence:
      - crates/apm2-core/src/context/manifest.rs
      - crates/apm2-core/src/lease/capability.rs
      - crates/apm2-daemon/src/episode/capability.rs
      - crates/apm2-daemon/src/episode/scope.rs
      - crates/apm2-core/src/cac/manifest.rs

  - id: OQ-004
    question: "How does current tool execution work in apm2?"
    status: RESOLVED
    finding: |
      Five-layer architecture:
      1. Protocol (tool/mod.rs) - ToolRequest with session_token
      2. Adapter (adapter/claude_code.rs) - PreToolUse/PostToolUse hooks
      3. Handlers (tool/shell.rs, tool/fs.rs) - workspace sandboxing
      4. Session Firewall (session/consume.rs:412-442) - ContextPack validation
      5. Daemon Mediation (protocol/messages.rs) - ToolRequest/ToolDecision
      PreToolUse hook provides mediation point for DD-004 broker pattern.
    evidence:
      - crates/apm2-core/src/tool/mod.rs
      - crates/apm2-core/src/adapter/claude_code.rs
      - crates/apm2-daemon/src/session/consume.rs
      - crates/apm2-daemon/src/protocol/messages.rs

  - id: OQ-005
    question: "Does daemon have persistent state for session tracking?"
    status: RESOLVED
    finding: |
      LEDGER-DRIVEN persistence model:
      - SQLite-backed ledger (ledger/storage.rs) with WAL mode
      - Session recovery via replay_session_state() in session/recovery.rs
      - SessionState includes resume_cursor for recovery positioning
      - DaemonStateHandle (state.rs) is in-memory only (ephemeral)
      Implementation gap: LEASE_REVOKED signaling not yet implemented.
    evidence:
      - crates/apm2-core/src/ledger/storage.rs
      - crates/apm2-core/src/session/recovery.rs
      - crates/apm2-core/src/session/state.rs
      - crates/apm2-daemon/src/state.rs

  - id: OQ-006
    question: "What signing infrastructure exists in apm2-core?"
    status: RESOLVED
    finding: |
      Comprehensive Ed25519 infrastructure exists:
      - Signer (crypto/sign.rs) - ed25519_dalek, generate/sign/verify
      - KeyManager (crypto/keys.rs) - secure file storage (0600 perms)
      - Canonicalize trait (events/canonical.rs) - deterministic serialization
      - Hash chain (crypto/hash.rs) - Blake3 event linking
      - ReceiptSigner (evidence/signer.rs) - tool receipt signing
      DD-006 hypothesis ACHIEVABLE with existing infrastructure.
    evidence:
      - crates/apm2-core/src/crypto/sign.rs
      - crates/apm2-core/src/crypto/keys.rs
      - crates/apm2-core/src/events/canonical.rs
      - crates/apm2-daemon/src/evidence/signer.rs

  - id: OQ-007
    question: "What xtask commands exist and what are their daemon CLI equivalents?"
    status: RESOLVED
    finding: |
      15 xtask commands found in xtask/src/main.rs:
      - 4 daemon operations (in scope): work claim/start, fac ingest, work status
      - 8 GitHub/SCM workflow tools (out of scope): start-ticket, commit, push, etc.
      - 3 development tools (out of scope): lint, capabilities, selftest
      DD-007 deprecation applies to daemon operations ONLY.
    evidence:
      - xtask/src/main.rs
      - crates/apm2-cli/src/main.rs
      - documents/rfcs/RFC-0017/04_contracts_and_versioning.yaml

gates:
  - gate_id: GATE-TCK-SCHEMA
    type: TRUSTED
    status: PASSED
    evidence:
      files_validated: 10
      parse_errors: 0

  - gate_id: GATE-TCK-CCP-MAPPING
    type: DETERMINISTIC
    status: PASSED
    evidence:
      note: "All design decisions grounded in codebase evidence with file paths"
      files_mapped: 25

  - gate_id: GATE-TCK-ANTI-COUSIN
    type: LLM-ASSISTED
    status: PASSED
    evidence:
      note: |
        OQ-003 confirmed: 5 existing capability structures found.
        No new abstractions needed - extend existing patterns.
        Protocol decision (DD-008) prevents 3rd protocol stack.

findings: []

verdict: APPROVED
verdict_reason: |
  RFC-0017 EXPLORE phase (v0 -> v2) completed successfully.

  All 7 open questions resolved with codebase evidence:
  - OQ-001/001a: Protocol decision made (Protobuf Runtime Protocol)
  - OQ-002: Governance not wired; PolicyEngine exists but integration pending
  - OQ-003: 5 capability structures found; no cousins needed
  - OQ-004: 5-layer tool architecture mapped; mediation point identified
  - OQ-005: Ledger-driven persistence; LEASE_REVOKED signaling is gap
  - OQ-006: Comprehensive Ed25519 + canonicalization exists
  - OQ-007: 4 of 15 xtask commands in scope for deprecation

  RFC-0017 is now v2 (Grounded) and ready for FINALIZE phase (v2 -> v4).

council_metadata:
  session_id: COUNCIL-RFC-0017-EXPLORE-20260130-190000
  subagents:
    - agent_id: SA-1
      emergent_role: Structural Rigorist
      focus: "OQ-002 (governance), OQ-005 (persistence)"
    - agent_id: SA-2
      emergent_role: Implementation Feasibility
      focus: "OQ-003 (capabilities), OQ-004 (tool execution)"
    - agent_id: SA-3
      emergent_role: Anti-Cousin Guardian
      focus: "OQ-006 (signing), OQ-007 (xtask inventory)"
  cycles_completed: 1
  total_questions_investigated: 7
  questions_resolved: 7
  elapsed_time_seconds: 0  # Exploration via parallel agents

next_steps:
  - action: "Invoke FINALIZE mode to advance v2 -> v4"
    command: "/rfc-council RFC-0017"
    expected_mode: FINALIZE
  - action: "After v4, invoke DECOMPOSE to generate tickets"
    command: "/rfc-council RFC-0017"
    expected_mode: DECOMPOSE

schema_version: "1.0.0"
rfc_id: RFC-0017
review_timestamp: "2026-01-30T21:00:00Z"
review_depth: COUNCIL
review_mode: REVIEW
rfc_version: "v4"

# =============================================================================
# RFC-0017 Council Review: Pre-Ticketing Quality Assurance
# =============================================================================
# This review addresses critical consistency issues identified before ticket
# decomposition. Findings MUST be remediated before DECOMPOSE phase proceeds.
# =============================================================================

gates:
  - gate_id: GATE-TCK-SCHEMA
    type: TRUSTED
    status: PASSED
    findings: []
    evidence:
      files_parsed: 10
      yaml_errors: 0

  - gate_id: GATE-TCK-DEPENDENCY-ACYCLICITY
    type: DETERMINISTIC
    status: NOT_APPLICABLE
    findings: []
    evidence:
      note: "No tickets exist yet; RFC is at v4 pre-DECOMPOSE"

  - gate_id: GATE-TCK-SCOPE-COVERAGE
    type: DETERMINISTIC
    status: NOT_APPLICABLE
    findings: []
    evidence:
      note: "No tickets exist yet; requirement coverage assessed at DECOMPOSE"

  - gate_id: GATE-TCK-CCP-MAPPING
    type: DETERMINISTIC
    status: NEEDS_REMEDIATION
    findings:
      - FND-RFC-0017-101
    evidence:
      ccp_exists: true
      ccp_path: "evidence/prd/PRD-0010/ccp/ccp_index.json"

  - gate_id: GATE-TCK-ATOMICITY
    type: LLM-ASSISTED
    status: NOT_APPLICABLE
    findings: []
    evidence:
      note: "No tickets exist yet"

  - gate_id: GATE-TCK-IMPLEMENTABILITY
    type: LLM-ASSISTED
    status: NEEDS_REMEDIATION
    findings:
      - FND-RFC-0017-102
      - FND-RFC-0017-103
      - FND-RFC-0017-104
      - FND-RFC-0017-105
      - FND-RFC-0017-106
      - FND-RFC-0017-107
    evidence:
      note: "Multiple ambiguities that would poison ticket implementation"

  - gate_id: GATE-TCK-SECURITY-AND-INTEGRITY
    type: LLM-ASSISTED
    status: NEEDS_REMEDIATION
    findings:
      - FND-RFC-0017-108
      - FND-RFC-0017-109
      - FND-RFC-0017-110
    evidence:
      note: "Authorization boundary underspecified"

  - gate_id: GATE-TCK-REQUIREMENT-FIDELITY
    type: LLM-ASSISTED
    status: PASSED
    findings: []
    evidence:
      note: "RFC requirements faithfully trace to PRD-0010"

  - gate_id: GATE-TCK-ANTI-COUSIN
    type: LLM-ASSISTED
    status: NEEDS_REMEDIATION
    findings:
      - FND-RFC-0017-111
    evidence:
      note: "Architecture location drift creates cousin risk"

findings:
  # ===========================================================================
  # BLOCKER FINDINGS - Must fix before tickets
  # ===========================================================================

  - finding_id: FND-RFC-0017-101
    gate_id: GATE-TCK-IMPLEMENTABILITY
    category: STRUCTURE_DEFECT
    subcategory: DECISION_CONFLICT
    severity: BLOCKER
    location:
      file: documents/rfcs/RFC-0017/02_design_decisions.yaml
      yaml_path: "design_hypotheses[7].status vs design_hypotheses[7].open_questions[0].status"
    description: |
      DD-008 has contradictory status fields:
      - Line 400: `status: DECIDED`
      - Line 488: `open_questions[0].status: PENDING_HUMAN_DECISION`

      This contradiction will cause implementers to question whether the protocol
      decision is actually final, potentially forking interpretation.
    remediation: |
      Change DD-008.open_questions[0].status to RESOLVED and add resolution text
      referencing the DECIDED status above. The decision IS made (OPTION A - Protobuf).
    signature: "dd008-status-contradiction"
    source_agent: "Operator Review"
    source_mode: "Document Consistency"

  - finding_id: FND-RFC-0017-102
    gate_id: GATE-TCK-IMPLEMENTABILITY
    category: IMPLEMENTABILITY_DEFECT
    subcategory: AMBIGUOUS_SCOPE
    severity: BLOCKER
    location:
      file: documents/rfcs/RFC-0017/02_design_decisions.yaml
      yaml_path: "design_hypotheses[2].evidence"
    description: |
      DD-003 claims "5 structures found" but only lists 4 numbered structures:
      1. CONTEXT-LEVEL FILE ACCESS (ContextPack)
      2. LEASE-BACKED CAPABILITIES
      3. DAEMON-SIDE TOOL CAPABILITY MANIFESTS
      4. BINARY CAPABILITY ENUMERATION (CAC v1)

      The evidence section lists 5 files, but the enumerated list has 4 items.
      This mismatch will confuse implementers about which structures to extend.
    remediation: |
      Either:
      A) Add the 5th structure (CapabilityScope from episode/scope.rs) as item 5
      B) Correct the claim to "4 structures found"

      Recommend option A since evidence lists scope.rs separately.
    signature: "dd003-count-mismatch"
    source_agent: "Operator Review"
    source_mode: "Document Consistency"

  - finding_id: FND-RFC-0017-103
    gate_id: GATE-TCK-ANTI-COUSIN
    category: COUSIN_DEFECT
    subcategory: CCP_MISMATCH
    severity: BLOCKER
    location:
      file: documents/rfcs/RFC-0017/02_design_decisions.yaml
      yaml_path: "architecture_overview.components[0].location_hypothesis"
    description: |
      Architecture overview specifies hypothetical location:
        `location_hypothesis: "crates/apm2-daemon/src/ipc/"`

      But actual daemon IPC implementation lives in:
        - `crates/apm2-daemon/src/ipc_server.rs` (JSON IPC server, 167 lines)
        - `crates/apm2-daemon/src/protocol/*` (Protobuf runtime, ~3000 lines)

      Creating `src/ipc/` would be a COUSIN MODULE introducing parallel hierarchy.
      The decision (DD-008) chose protobuf, so implementation should extend
      `protocol/*` and retire/wrap `ipc_server.rs`.
    remediation: |
      Update architecture_overview.components[0].location_hypothesis to:
        "crates/apm2-daemon/src/protocol/ (extend ProtocolServer; wrap ipc_server.rs)"

      Add explicit note: "Do NOT create new src/ipc/ directory"
    signature: "arch-location-cousin-risk"
    source_agent: "SA-3"
    source_mode: "Anti-Cousin"

  # ===========================================================================
  # MAJOR FINDINGS - Must fix before tickets
  # ===========================================================================

  - finding_id: FND-RFC-0017-104
    gate_id: GATE-TCK-IMPLEMENTABILITY
    category: IMPLEMENTABILITY_DEFECT
    subcategory: INCOMPLETE_PLAN
    severity: MAJOR
    location:
      file: documents/rfcs/RFC-0017/02_design_decisions.yaml
      yaml_path: "design_hypotheses[0].evidence.json_ipc.lines"
    description: |
      Evidence states `lines: 525` for crates/apm2-core/src/ipc/mod.rs
      Actual line count is 524.

      Minor numerical error, but "grounded in evidence" claims should be exact.
    remediation: |
      Change `lines: 525` to `lines: 524`
    signature: "line-count-ipc-mod"
    source_agent: "Operator Review"
    source_mode: "Evidence Verification"

  - finding_id: FND-RFC-0017-105
    gate_id: GATE-TCK-SECURITY-AND-INTEGRITY
    category: SECURITY_DEFECT
    subcategory: BOUNDARY_VIOLATION
    severity: MAJOR
    location:
      file: documents/rfcs/RFC-0017/02_design_decisions.yaml
      yaml_path: "design_hypotheses[0]"
    description: |
      DD-001 treats SO_PEERCRED as "authentication" but this is necessary but
      not sufficient for privilege separation on a single-user workstation.

      Problem: On a single workstation, daemon, CLI, and spawned sessions are
      likely all running as the same UID. SO_PEERCRED gives identity/locality,
      NOT authorization.

      If privileged endpoints are gated only by UID/GID match, a compromised
      session process can call privileged RPCs (ClaimWork, SpawnEpisode).

      Need explicit privilege predicate:
      - Privileged endpoints: require operator credential signature OR privileged
        socket FD/path not available to sessions
      - Session endpoints: require daemon-minted session token bound to lease
    remediation: |
      Add to DD-001:

      ```yaml
      privilege_predicate:
        privileged_endpoints:
          requirement: |
            SO_PEERCRED validates locality (same host) PLUS one of:
            - Operator credential signature on request
            - Connection on privileged socket path (e.g., operator.sock)
            - Session tokens are NOT valid for privileged endpoints
        session_endpoints:
          requirement: |
            Connection authenticated via session_token minted at spawn time.
            Session token binds (session_id, lease_id, spawn_time).
            Tokens have short TTL and are not transferable.
      ```
    signature: "auth-vs-authz-gap"
    source_agent: "Operator Review"
    source_mode: "Security Analysis"

  - finding_id: FND-RFC-0017-106
    gate_id: GATE-TCK-SECURITY-AND-INTEGRITY
    category: SECURITY_DEFECT
    subcategory: SECRET_EXPOSURE
    severity: MAJOR
    location:
      file: documents/rfcs/RFC-0017/04_contracts_and_versioning.yaml
      yaml_path: "ipc_contracts.privileged_endpoints.endpoints[0]"
    description: |
      ClaimWork flow accepts user-supplied `actor_id` parameter.
      If daemon accepts arbitrary actor_id, this creates impersonation vector.

      A malicious operator could claim work as any actor_id, violating
      audit integrity and potentially SoD enforcement.
    remediation: |
      Add constraint to ClaimWork contract:

      ```yaml
      validation:
        - "actor_id MUST be derived from operator credential (public key fingerprint)"
        - "User-supplied actor_id is display-only hint; authoritative id from credential"
      ```

      OR require request signature binding actor_id to credential.
    signature: "actor-id-impersonation"
    source_agent: "Operator Review"
    source_mode: "Security Analysis"

  - finding_id: FND-RFC-0017-107
    gate_id: GATE-TCK-IMPLEMENTABILITY
    category: IMPLEMENTABILITY_DEFECT
    subcategory: AMBIGUOUS_SCOPE
    severity: MAJOR
    location:
      file: documents/rfcs/RFC-0017/02_design_decisions.yaml
      yaml_path: "design_hypotheses[7]"
    description: |
      DD-008 protocol decision is correct but does not specify cutover topology.

      Current state:
      - Daemon runs JSON IPC server (ipc_server.rs) as primary ingress in main.rs
      - Protobuf runtime protocol exists but not integrated into main dispatcher

      Ambiguity: How do we transition?
      - Pattern A: Protobuf-only socket (cleanest)
      - Pattern B: Two sockets temporarily (JSON + protobuf)

      Critical invariant: "No control-plane behavior implemented twice"
      Without explicit pattern choice, implementers may create divergent handlers.
    remediation: |
      Add to DD-008.decision:

      ```yaml
      cutover_topology:
        pattern: A  # or B
        description: |
          Pattern A (RECOMMENDED): Protobuf is the only daemon control-plane socket.
          - Daemon listens only with ProtocolServer
          - CLI migrates to protobuf (or CLI-side adapter exists)
          - JSON IPC retired for control-plane

          Invariant: No control-plane behavior is implemented in both JSON and
          protobuf handlers. All enforcement logic lives in ProtocolServer handlers.
      ```
    signature: "cutover-topology-ambiguous"
    source_agent: "Operator Review"
    source_mode: "Implementation Feasibility"

  - finding_id: FND-RFC-0017-108
    gate_id: GATE-TCK-SECURITY-AND-INTEGRITY
    category: SECURITY_DEFECT
    subcategory: INVARIANT_FAILURE
    severity: MAJOR
    location:
      file: documents/rfcs/RFC-0017/02_design_decisions.yaml
      yaml_path: "design_hypotheses[5]"
    description: |
      DD-006 (Event Signing) references both:
      - apm2_core::events::canonical.rs (Canonicalize trait)
      - daemon runtime protocol canonicalization (protocol/messages.rs)

      Need ONE authoritative canonicalization rule. If events are sometimes
      signed via apm2-core and sometimes via daemon protocol, signature
      verification becomes fragile.

      Risk: Silently signing raw proto bytes for some flows and apm2-core
      canonical bytes for others creates verification failures.
    remediation: |
      Add to DD-006:

      ```yaml
      canonicalization_authority:
        rule: |
          ALL kernel events (WorkClaimed, EpisodeSpawned, ToolDecided, etc.)
          are canonicalized via apm2_core::events::canonical::Canonicalize trait.

          The daemon protocol messages transport these events as payloads.
          Signing happens on canonical event bytes, NOT on protocol wrapper bytes.

          Canonical form is the ONLY form that may be signed.
        governed_artifact: |
          apm2_core::events::canonical.rs is the governed artifact.
          Schema evolution requires golden vector updates and migration plan.
      ```
    signature: "canonicalization-authority-ambiguous"
    source_agent: "Operator Review"
    source_mode: "Security Analysis"

  - finding_id: FND-RFC-0017-109
    gate_id: GATE-TCK-IMPLEMENTABILITY
    category: IMPLEMENTABILITY_DEFECT
    subcategory: INCOMPLETE_PLAN
    severity: MAJOR
    location:
      file: documents/rfcs/RFC-0017/02_design_decisions.yaml
      yaml_path: "design_hypotheses[4]"
    description: |
      DD-005 (Session Lifecycle and Recovery) says:
      "daemon restarts, emits LEASE_REVOKED to each session within 5s"

      But if daemon crashed, sessions may have no live channel to receive anything.
      The current design is not implementable without a reconnect/reject rule.

      Scenarios not addressed:
      1. Session is blocked on I/O when daemon crashes - no signal received
      2. Session process is orphaned with no socket to daemon
      3. Daemon cannot SIGTERM sessions it didn't spawn (different PIDs)
    remediation: |
      Clarify DD-005 with implementable recovery:

      ```yaml
      crash_recovery_mechanics:
        on_daemon_startup:
          - "Mark all active leases/sessions as REVOKED in ledger"
          - "Any reconnecting session gets hard deny + terminate instruction"
          - "Offline sessions are inert (no credentials, no tool execution)"

        proactive_termination:
          option_a: |
            Sessions run under daemon's process group. Daemon persists PID mapping.
            On restart, daemon kills PIDs from state file.
          option_b: |
            Sessions have watchdog thread pinging daemon. Loss of ping = self-terminate.
            (This is heartbeat, which was rejected - reconsider?)
          option_c: |
            Sessions cannot execute tools without daemon mediation.
            Offline session is effectively dead even if process runs.
            Next tool call fails with DAEMON_UNAVAILABLE, session exits.

        chosen: option_c
        rationale: |
          Sessions are inert without daemon. No proactive kill needed.
          Tool mediation failure on reconnect attempt is sufficient.
      ```
    signature: "crash-recovery-not-implementable"
    source_agent: "Operator Review"
    source_mode: "Implementation Feasibility"

  - finding_id: FND-RFC-0017-110
    gate_id: GATE-TCK-SECURITY-AND-INTEGRITY
    category: SECURITY_DEFECT
    subcategory: UNMITIGATED_THREAT
    severity: MAJOR
    location:
      file: documents/rfcs/RFC-0017/02_design_decisions.yaml
      yaml_path: "design_hypotheses[3]"
    description: |
      DD-004 (Tool Broker Mediation) says "validate args against allowlists"
      for all tools including Shell.

      For Shell tool, "validate args against allowlists" is either:
      A) Extremely restrictive (allowlist of specific commands) - security theater
         since shell command composition is Turing-complete
      B) Sandbox boundary (Landlock/seccomp/container) - higher scope

      Without explicit decision, Phase-1 ends with "enforcement layer" that
      doesn't actually enforce Shell restrictions.
    remediation: |
      Add to DD-004:

      ```yaml
      shell_mediation:
        phase_1_decision: |
          Shell tool is RESTRICTED in capability manifests by default.
          Only explicitly allowlisted shell commands may execute.

          Allowlist semantics:
          - Command must match pattern exactly (no shell expansion before check)
          - Arguments validated against path allowlist (for file-touching commands)
          - Commands not in allowlist: DENY + terminate

          Future (Phase 2): Landlock/seccomp sandbox for shell execution.

        default_shell_allowlist: []  # Empty = no shell commands allowed

        extension_mechanism: |
          Governance policy can grant shell_allowlist capabilities for
          specific roles (e.g., IMPLEMENTER may run `cargo build`).
      ```
    signature: "shell-mediation-underspecified"
    source_agent: "Operator Review"
    source_mode: "Security Analysis"

  - finding_id: FND-RFC-0017-111
    gate_id: GATE-TCK-ANTI-COUSIN
    category: COUSIN_DEFECT
    subcategory: CCP_MISMATCH
    severity: MAJOR
    location:
      file: documents/rfcs/RFC-0017/02_design_decisions.yaml
      yaml_path: "architecture_overview.components"
    description: |
      Multiple components list hypothetical locations that don't match CCP:
      - "crates/apm2-daemon/src/ipc/" - doesn't exist
      - "crates/apm2-daemon/src/work/" - doesn't exist
      - "crates/apm2-daemon/src/tools/" - doesn't exist
      - "crates/apm2-core/src/signing/" - doesn't exist

      These are NEW directory structures that would create cousin modules
      parallel to existing structures.
    remediation: |
      Update location_hypothesis fields to reference actual CCP paths:

      - Daemon IPC Handler: "crates/apm2-daemon/src/protocol/" (extend existing)
      - Work Orchestrator: "crates/apm2-daemon/src/handlers.rs" (extend existing)
      - Episode Spawner: "crates/apm2-daemon/src/episode/" (exists)
      - Tool Broker: "crates/apm2-daemon/src/session/" (extend consume.rs)
      - Session Manager: "crates/apm2-daemon/src/session/" (exists)
      - Event Signer: "crates/apm2-core/src/crypto/" (extend sign.rs)
    signature: "multiple-cousin-locations"
    source_agent: "SA-3"
    source_mode: "Anti-Cousin"

verdict: APPROVED_WITH_REMEDIATION
verdict_reason: |
  RFC-0017 v4 initially had 3 BLOCKER and 8 MAJOR findings. ALL FINDINGS
  HAVE BEEN REMEDIATED in this review session.

  BLOCKERS REMEDIATED (3):
  - DD-008 status: Changed open_questions[0].status to RESOLVED ✓
  - DD-003 count: Added 5th structure (CapabilityScope) to enumeration ✓
  - Architecture locations: Updated to actual CCP paths with extension notes ✓

  MAJORS REMEDIATED (8):
  - Line count: Changed 525 to 524 ✓
  - Auth vs authz: Added privilege_predicate with socket topology to DD-001 ✓
  - actor_id: Added credential_signature requirement and security_note to ClaimWork ✓
  - Cutover topology: Added cutover_topology section to DD-008 ✓
  - Canonicalization: Added canonicalization_authority section to DD-006 ✓
  - Crash recovery: Added crash_recovery_mechanics section to DD-005 ✓
  - Shell mediation: Added shell_mediation section to DD-004 ✓
  - Cousin locations: Updated all location_hypothesis to actual CCP paths ✓

  RFC-0017 is now ready for DECOMPOSE phase.

remediation_status:
  all_findings_remediated: true
  remediation_timestamp: "2026-01-30T21:30:00Z"
  files_modified:
    - documents/rfcs/RFC-0017/02_design_decisions.yaml
    - documents/rfcs/RFC-0017/04_contracts_and_versioning.yaml
    - documents/rfcs/RFC-0017/08_risks_and_open_questions.yaml
  changes_summary:
    - "DD-008.open_questions[0].status: PENDING_HUMAN_DECISION -> RESOLVED"
    - "DD-001.evidence.json_ipc.lines: 525 -> 524"
    - "DD-008.evidence.json_ipc.lines: 525 -> 524"
    - "OQ-003.resolution: Added 5th structure (CapabilityScope)"
    - "architecture_overview.components: location_hypothesis -> location (actual CCP paths)"
    - "DD-001: Added privilege_predicate section"
    - "DD-004: Added shell_mediation section"
    - "DD-005: Added crash_recovery_mechanics section"
    - "DD-006: Added canonicalization_authority section"
    - "DD-008: Added cutover_topology section"
    - "IPC-PRIV-001 (ClaimWork): Added credential_signature and security_note"

council_metadata:
  session_id: "COUNCIL-RFC-0017-20260130-REVIEW"
  review_type: "Pre-Ticketing Quality Assurance"
  triggered_by: "Operator manual review request"
  subagents:
    - agent_id: "Operator"
      role: "Document Consistency"
      findings_contributed: 4
    - agent_id: "SA-3"
      role: "Anti-Cousin Guardian"
      findings_contributed: 2
    - agent_id: "Security Reviewer"
      role: "Trust Boundary Analysis"
      findings_contributed: 5
  elapsed_time_seconds: "~300"

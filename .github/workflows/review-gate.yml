# Authoritative AI review gate workflow
# Runs gate evaluation with trusted base-branch code.

name: Review Gate

on:
  pull_request_target:
    branches: [main]
  issue_comment:
    types: [created, edited]

concurrency:
  group: review-gate-${{ github.event_name == 'pull_request_target' && github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read
  statuses: write

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: -D warnings
  RUST_BACKTRACE: 1

jobs:
  # Pre-filter for issue_comment events: only run for comments from trusted
  # actors on pull requests, preventing unbounded CI-trigger DoS from arbitrary
  # commenters.
  pre-filter:
    name: Pre-filter
    if: >-
      github.event_name == 'pull_request_target' ||
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        (
          github.event.comment.author_association == 'OWNER' ||
          github.event.comment.author_association == 'MEMBER' ||
          github.event.comment.author_association == 'COLLABORATOR'
        )
      )
    runs-on: ubuntu-24.04
    steps:
      - run: echo "Pre-filter passed"

  review-gate:
    name: Review Gate
    needs: [pre-filter]
    runs-on: ubuntu-24.04
    steps:
      # pull_request_target already executes in base-branch context, so this
      # checks out trusted evaluator code from the PR base branch.
      - name: Checkout trusted base branch code
        if: github.event_name == 'pull_request_target'
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      # For issue_comment, resolve the PR base ref first, then checkout that
      # branch so evaluator code matches the PR's target branch policy.
      - name: Resolve PR base ref for issue_comment
        if: github.event_name == 'issue_comment'
        id: ic-base
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number }}"
          BASE_REF=$(gh api "/repos/${{ github.repository }}/pulls/${PR_NUMBER}" --jq '.base.ref')
          echo "base_ref=${BASE_REF}" >> "$GITHUB_OUTPUT"

      - name: Checkout trusted base branch code (issue_comment)
        if: github.event_name == 'issue_comment'
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ steps.ic-base.outputs.base_ref }}

      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2

      # Resolve PR number and head SHA.
      # For pull_request_target these come from the event payload directly.
      # For issue_comment we resolve via the GitHub API.
      - name: Resolve PR context
        id: pr-ctx
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
            echo "head_sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            echo "base_ref=${{ github.event.pull_request.base.ref }}" >> "$GITHUB_OUTPUT"
          else
            PR_NUMBER="${{ github.event.issue.number }}"
            PR_DATA=$(gh api "/repos/${{ github.repository }}/pulls/${PR_NUMBER}")
            HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
            BASE_REF=$(echo "$PR_DATA" | jq -r '.base.ref')
            echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
            echo "head_sha=${HEAD_SHA}" >> "$GITHUB_OUTPUT"
            echo "base_ref=${BASE_REF}" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch trusted-reviewers from base branch
        run: |
          git fetch origin "${{ steps.pr-ctx.outputs.base_ref }}" --depth=1
          git show "origin/${{ steps.pr-ctx.outputs.base_ref }}:.github/review-gate/trusted-reviewers.json" \
            > /tmp/trusted-reviewers-base.json

      - name: Evaluate review gate
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cargo xtask review-gate \
            --repo "${{ github.repository }}" \
            --pr-number "${{ steps.pr-ctx.outputs.pr_number }}" \
            --head-sha "${{ steps.pr-ctx.outputs.head_sha }}" \
            --trusted-reviewers "/tmp/trusted-reviewers-base.json"

  review-gate-success:
    name: Review Gate Success
    needs: [pre-filter, review-gate]
    if: always()
    runs-on: ubuntu-24.04
    steps:
      - name: Check review gate result
        id: gate
        run: |
          # If pre-filter was skipped (untrusted commenter), gate is not
          # applicable. Do NOT post any status â€” an untrusted actor must
          # never be able to write a passing required status.
          if [[ "${{ needs.pre-filter.result }}" == "skipped" ]]; then
            echo "Pre-filter skipped (not a trusted actor or not a PR comment)"
            echo "should_post=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "should_post=true" >> "$GITHUB_OUTPUT"
          if [[ "${{ needs.review-gate.result }}" != "success" ]]; then
            echo "Review gate failed"
            echo "state=failure" >> "$GITHUB_OUTPUT"
            echo "description=Review gate evaluation failed" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          echo "Review gate passed"
          echo "state=success" >> "$GITHUB_OUTPUT"
          echo "description=Review gate passed" >> "$GITHUB_OUTPUT"

      # Resolve the PR head SHA so we can post a commit status to it.
      # Only resolve when the gate actually ran (avoids API calls on
      # non-PR issue_comment events where pre-filter was skipped).
      - name: Resolve PR head SHA
        id: head
        if: always() && steps.gate.outputs.should_post == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          else
            PR_NUMBER="${{ github.event.issue.number }}"
            HEAD_SHA=$(gh api "/repos/${{ github.repository }}/pulls/${PR_NUMBER}" --jq '.head.sha')
            echo "sha=${HEAD_SHA}" >> "$GITHUB_OUTPUT"
          fi

      # Post a commit status to the PR head SHA so branch protection can
      # find the check on the correct commit (pull_request_target runs
      # report on the base SHA, not the PR head).
      # Only post when the gate actually ran (trusted actor triggered it).
      - name: Post review gate status to PR head
        if: >-
          always() &&
          steps.gate.outputs.should_post == 'true' &&
          steps.head.outputs.sha != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api --method POST "/repos/${{ github.repository }}/statuses/${{ steps.head.outputs.sha }}" \
            -f state="${{ steps.gate.outputs.state || 'failure' }}" \
            -f context="Review Gate Success" \
            -f description="${{ steps.gate.outputs.description || 'Review gate evaluation failed' }}"

# Fuzzing workflow
# Runs cargo-fuzz with corpus caching

name: Fuzz

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Saturdays at midnight UTC
    - cron: '0 0 * * 6'
  workflow_dispatch:
    inputs:
      fuzz_time:
        description: 'Fuzzing duration per target (seconds)'
        required: false
        default: '300'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  # Short run on PRs (10s) to validate fuzz targets compile and work; full run on main (300s)
  FUZZ_TIME: ${{ github.event.inputs.fuzz_time || (github.event_name == 'pull_request' && '10') || '300' }}

jobs:
  fuzz:
    name: Fuzz
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # nightly
        with:
          toolchain: nightly
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Restore corpus
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4
        with:
          path: fuzz/corpus
          key: fuzz-corpus-${{ github.sha }}
          restore-keys: |
            fuzz-corpus-

      - name: List fuzz targets
        id: targets
        run: |
          cd fuzz
          if [ -f Cargo.toml ]; then
            targets=$(cargo fuzz list 2>/dev/null | tr '\n' ' ' || echo "")
            echo "targets=$targets" >> $GITHUB_OUTPUT
          else
            echo "targets=" >> $GITHUB_OUTPUT
          fi

      - name: Run fuzzing
        if: steps.targets.outputs.targets != ''
        run: |
          cd fuzz
          for target in ${{ steps.targets.outputs.targets }}; do
            echo "Fuzzing $target for $FUZZ_TIME seconds..."
            cargo fuzz run "$target" -- -max_total_time=$FUZZ_TIME || true
          done

      - name: Save corpus
        uses: actions/cache/save@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4
        if: always()
        with:
          path: fuzz/corpus
          key: fuzz-corpus-${{ github.sha }}

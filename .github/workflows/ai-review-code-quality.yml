# AI Code Quality Review (PR branch)
# Runs in PR-branch context (push semantics) so prompt/evaluator changes in the
# PR apply immediately.

name: AI Review (Code Quality)

on:
  push:
    branches-ignore: [main]
  workflow_dispatch: {}

concurrency:
  group: ai-review-code-quality-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: -D warnings
  RUST_BACKTRACE: 1

jobs:
  code-quality-review:
    name: Code Quality Review
    runs-on: [self-hosted, linux, x64, fac-ovh]
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2

      - name: Add Cargo bin to PATH
        run: |
          if [[ -n "${CARGO_HOME:-}" ]]; then
            echo "${CARGO_HOME}/bin" >> "$GITHUB_PATH"
          else
            echo "${HOME}/.cargo/bin" >> "$GITHUB_PATH"
          fi

      - name: Resolve PR context from branch
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          OWNER_REPO="${{ github.repository }}"
          OWNER="${OWNER_REPO%%/*}"
          BRANCH="${{ github.ref_name }}"

          PR_DATA=$(gh api "/repos/${OWNER_REPO}/pulls?head=${OWNER}:${BRANCH}&state=open&per_page=10")
          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number // empty')
          if [[ -z "$PR_NUMBER" ]]; then
            echo "No open PR found for ${OWNER}:${BRANCH}; skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.[0].head.sha')
          BASE_REF=$(echo "$PR_DATA" | jq -r '.[0].base.ref')
          HEAD_REPO=$(echo "$PR_DATA" | jq -r '.[0].head.repo.full_name')

          if [[ "$HEAD_REPO" != "$OWNER_REPO" ]]; then
            echo "Refusing to run on non-local head repo: ${HEAD_REPO}"
            exit 1
          fi

          if [[ -z "$BASE_REF" ]]; then
            echo "::error::Could not resolve PR base ref; refusing to evaluate with mutable PR-branch policy."
            exit 1
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "head_sha=${HEAD_SHA}" >> "$GITHUB_OUTPUT"
          echo "base_ref=${BASE_REF}" >> "$GITHUB_OUTPUT"
          echo "pr_url=https://github.com/${OWNER_REPO}/pull/${PR_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Fetch trusted reviewers from base branch
        if: steps.pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          git fetch origin "${{ steps.pr.outputs.base_ref }}" --depth=1
          git show "origin/${{ steps.pr.outputs.base_ref }}:.github/review-gate/trusted-reviewers.json" \
            > /tmp/trusted-reviewers-base.json

      - name: Validate review bot identity is allowlisted
        if: steps.pr.outputs.skip != 'true'
        env:
          REVIEW_BOT_TOKEN: ${{ secrets.AUTO_APPROVE_PAT }}
        run: |
          set -euo pipefail

          if [[ -z "${REVIEW_BOT_TOKEN:-}" ]]; then
            echo "::error::Missing required secret AUTO_APPROVE_PAT (must map to an allowlisted reviewer identity)."
            exit 1
          fi

          BOT_LOGIN=$(GH_TOKEN="${REVIEW_BOT_TOKEN}" gh api user --jq '.login')
          echo "Using review bot login: ${BOT_LOGIN}"

          jq -e --arg login "$BOT_LOGIN" \
            '[.reviewers.code_quality[].github_logins[] | ascii_downcase] | index($login|ascii_downcase) != null' \
            /tmp/trusted-reviewers-base.json >/dev/null

      - name: Post pending review gate status (early)
        if: steps.pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          sha="${{ steps.pr.outputs.head_sha }}"

          gh api --method POST "/repos/${{ github.repository }}/statuses/${sha}" \
            -f state="pending" \
            -f context="Review Gate Success" \
            -f description="Waiting for AI reviews"

      - name: Delete prior code quality review artifacts for this head (dedupe)
        if: steps.pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.AUTO_APPROVE_PAT }}
        run: |
          set -euo pipefail
          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "::error::Missing required secret AUTO_APPROVE_PAT (authoritative reviewer identity token)."
            exit 1
          fi

          OWNER_REPO="${{ github.repository }}"
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          HEAD_SHA="${{ steps.pr.outputs.head_sha }}"
          BOT_LOGIN=$(gh api user --jq '.login')
          MARKER="<!-- apm2-review-metadata:v1:code-quality -->"

          IDS=$(gh api "/repos/${OWNER_REPO}/issues/${PR_NUMBER}/comments?per_page=100" --paginate --jq \
            "[.[] | select(.user.login == \"$BOT_LOGIN\") | select((.body // \"\") | contains(\"$MARKER\")) | select((.body // \"\") | contains(\"$HEAD_SHA\")) | .id] | .[]")

          if [[ -z "${IDS:-}" ]]; then
            exit 0
          fi

          while IFS= read -r id; do
            if [[ -n "${id}" ]]; then
              gh api --method DELETE "/repos/${OWNER_REPO}/issues/comments/${id}"
            fi
          done <<< "$IDS"

      - name: Run code quality review
        if: steps.pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.AUTO_APPROVE_PAT }}
        run: |
          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "::error::Missing required secret AUTO_APPROVE_PAT (authoritative reviewer identity token)."
            exit 1
          fi
          cargo xtask review quality "${{ steps.pr.outputs.pr_url }}" \
            --expected-head-sha "${{ steps.pr.outputs.head_sha }}"

      - name: Evaluate and post review gate status
        if: steps.pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          EXPECTED_HEAD_SHA="${{ steps.pr.outputs.head_sha }}"

          CURRENT_HEAD_SHA=$(gh api "/repos/${{ github.repository }}/pulls/${PR_NUMBER}" --jq '.head.sha')
          if [[ "$CURRENT_HEAD_SHA" != "$EXPECTED_HEAD_SHA" ]]; then
            echo "PR head moved during review: expected $EXPECTED_HEAD_SHA, current $CURRENT_HEAD_SHA"
            echo "Skipping gate evaluation/status post; push-triggered workflows will run on the new head."
            exit 0
          fi

          set +e
          cargo xtask review-gate \
            --repo "${{ github.repository }}" \
            --pr-number "${PR_NUMBER}" \
            --head-sha "${EXPECTED_HEAD_SHA}" \
            --trusted-reviewers "/tmp/trusted-reviewers-base.json" \
            | tee /tmp/review-gate-evaluation.json
          code=${PIPESTATUS[0]}
          set -e

          qual_verdict=$(jq -r '.code_quality.authoritative_verdict // empty' /tmp/review-gate-evaluation.json || true)
          if [[ -z "${qual_verdict}" ]]; then
            echo "::error::Code quality review did not produce an authoritative artifact for head ${EXPECTED_HEAD_SHA}."
            echo "::error::Review-gate evaluation summary:"
            cat /tmp/review-gate-evaluation.json || true
            code=1
          fi

          if [ "$code" -eq 0 ]; then
            state="success"
            description="Review gate passed"
            exit_code=0
          elif [ "$code" -eq 2 ]; then
            state="pending"
            description="Waiting for AI reviews"
            exit_code=0
          else
            state="failure"
            description="Review gate failed"
            exit_code=1
          fi

          gh api --method POST "/repos/${{ github.repository }}/statuses/${EXPECTED_HEAD_SHA}" \
            -f state="${state}" \
            -f context="Review Gate Success" \
            -f description="${description}"

          exit "$exit_code"

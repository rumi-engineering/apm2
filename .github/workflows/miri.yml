# Miri workflow
# Detects undefined behavior in unsafe code

name: Miri

on:
  schedule:
    # Run every 2 hours on the default branch
    - cron: '0 */2 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  # -Zmiri-disable-isolation: Allow clock/filesystem access for integration tests
  # -Zmiri-strict-provenance: Strict pointer provenance checking
  MIRIFLAGS: -Zmiri-disable-isolation -Zmiri-strict-provenance

jobs:
  miri:
    name: Miri
    runs-on: &primary_runner [self-hosted, linux, x64, fac-ovh]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # nightly
        with:
          toolchain: nightly
          components: miri
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2
      - name: Setup Miri
        run: cargo miri setup
      - name: Run Miri
        run: cargo miri test --workspace --all-features

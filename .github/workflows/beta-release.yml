# Beta release workflow
# Promotes artifacts from dev to beta via manual dispatch
# No rebuild - same bytes as dev

name: Beta Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Beta version (e.g., 0.2.0-beta.1)'
        required: true
        type: string

permissions:
  contents: write

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  promote:
    name: Promote to Beta
    runs-on: &primary_runner [self-hosted, linux, x64, fac-ovh]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z-beta.N (e.g., 0.2.0-beta.1)"
            exit 1
          fi
          echo "Version format valid: $VERSION"

      - name: Download dev release artifacts
        run: |
          mkdir -p artifacts
          cd artifacts
          echo "Downloading artifacts from dev release..."
          gh release download dev --pattern '*'
          ls -la

      - name: Verify checksums
        run: |
          cd artifacts
          echo "Verifying artifact checksums..."
          sha256sum -c checksums-sha256.txt
          echo "All checksums verified successfully"

      - name: Create beta release
        run: |
          VERSION="v${{ inputs.version }}"

          # Get the commit SHA from the dev release
          DEV_TAG_SHA=$(git rev-parse dev 2>/dev/null || echo "${{ github.sha }}")

          gh release create "$VERSION" \
            --title "v${{ inputs.version }}" \
            --prerelease \
            --notes "## Beta Release v${{ inputs.version }}

          This is a pre-release build promoted from the dev channel.

          **Source:** dev release
          **Promoted:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ### Changes

          See the [changelog](../../blob/main/CHANGELOG.md) for details.

          ### Verification

          Verify checksums match the dev release:
          \`\`\`bash
          sha256sum -c checksums-sha256.txt --ignore-missing
          \`\`\`

          ### Note

          This is a pre-release for testing upcoming stable features.
          For production use, download a [stable release](../../releases/latest)." \
            artifacts/*

          echo "Created beta release: $VERSION"

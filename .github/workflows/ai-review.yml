# Unified FAC-first AI review projection workflow
# Runs trusted base-branch workflow logic (`pull_request_target`) and treats
# GitHub as a projection surface over VPS-executed FAC review agents.

name: AI Review

on:
  pull_request_target:
    branches: [main]
    types: [opened, reopened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to dispatch/project"
        required: true
        type: string

concurrency:
  group: ai-review-${{ github.event_name == 'pull_request_target' && github.event.pull_request.number || github.event.inputs.pr_number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: -D warnings
  RUST_BACKTRACE: 1

jobs:
  fac-review:
    name: FAC Review
    runs-on: [self-hosted, linux, x64, fac-ovh]
    timeout-minutes: 20

    steps:
      # pull_request_target executes workflow code from base-branch context.
      - name: Checkout trusted base branch code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2

      - name: Add Cargo bin to PATH
        run: |
          if [[ -n "${CARGO_HOME:-}" ]]; then
            echo "${CARGO_HOME}/bin" >> "$GITHUB_PATH"
          else
            echo "${HOME}/.cargo/bin" >> "$GITHUB_PATH"
          fi

      - name: Resolve PR context
        id: pr
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
            echo "pr_url=${{ github.event.pull_request.html_url }}" >> "$GITHUB_OUTPUT"
            echo "head_sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            echo "base_ref=${{ github.event.pull_request.base.ref }}" >> "$GITHUB_OUTPUT"
            echo "author_login=${{ github.event.pull_request.user.login }}" >> "$GITHUB_OUTPUT"
            echo "author_assoc=${{ github.event.pull_request.author_association }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PR_NUMBER='${{ github.event.inputs.pr_number }}'
          if [[ -z "${PR_NUMBER}" ]] || ! [[ "${PR_NUMBER}" =~ ^[0-9]+$ ]]; then
            echo "::error::workflow_dispatch requires numeric input `pr_number`"
            exit 1
          fi
          PR_JSON=$(gh api "/repos/${{ github.repository }}/pulls/${PR_NUMBER}")
          echo "pr_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "pr_url=$(jq -r '.html_url' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "head_sha=$(jq -r '.head.sha' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "base_ref=$(jq -r '.base.ref' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "author_login=$(jq -r '.user.login' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"
          echo "author_assoc=$(jq -r '.author_association' <<<"${PR_JSON}")" >> "$GITHUB_OUTPUT"

      - name: Authorize PR author identity (fail closed)
        run: |
          set -euo pipefail
          AUTHOR_LOGIN='${{ steps.pr.outputs.author_login }}'
          AUTHOR_ASSOC='${{ steps.pr.outputs.author_assoc }}'
          case "${AUTHOR_ASSOC}" in
            OWNER|MEMBER|COLLABORATOR)
              echo "Authorized PR author: ${AUTHOR_LOGIN} (${AUTHOR_ASSOC})"
              ;;
            *)
              echo "::error::Unauthorized PR author identity: ${AUTHOR_LOGIN} (${AUTHOR_ASSOC})"
              exit 1
              ;;
          esac

      - name: Fetch trusted reviewers from base branch
        run: |
          set -euo pipefail
          git fetch origin "${{ steps.pr.outputs.base_ref }}" --depth=1
          git show "origin/${{ steps.pr.outputs.base_ref }}:.github/review-gate/trusted-reviewers.json" \
            > /tmp/trusted-reviewers-base.json

      - name: Validate reviewer identity is allowlisted
        run: |
          set -euo pipefail

          if ! gh auth status >/dev/null 2>&1; then
            echo "::error::No gh authentication available on runner; cannot determine reviewer identity."
            exit 1
          fi

          BOT_LOGIN=$(gh api user --jq '.login')
          echo "Using reviewer login: ${BOT_LOGIN}"

          jq -e --arg login "$BOT_LOGIN" \
            '[.reviewers.security[].github_logins[] | ascii_downcase] | index($login|ascii_downcase) != null' \
            /tmp/trusted-reviewers-base.json >/dev/null

          jq -e --arg login "$BOT_LOGIN" \
            '[.reviewers.code_quality[].github_logins[] | ascii_downcase] | index($login|ascii_downcase) != null' \
            /tmp/trusted-reviewers-base.json >/dev/null

      - name: Build apm2 CLI
        run: cargo build --locked -p apm2-cli

      - name: Dispatch FAC reviewers (idempotent start-or-join)
        id: dispatch
        run: |
          set -euo pipefail

          if ! gh auth status >/dev/null 2>&1; then
            echo "::error::No gh authentication available on runner; detached reviewers cannot access GitHub APIs."
            exit 1
          fi

          FAC_BIN="${PWD}/target/debug/apm2"
          PR_URL='${{ steps.pr.outputs.pr_url }}'
          HEAD_SHA='${{ steps.pr.outputs.head_sha }}'

          DISPATCH_JSON=$("${FAC_BIN}" fac --json review dispatch "${PR_URL}" --type all --expected-head-sha "${HEAD_SHA}")
          echo "dispatch_json<<EOF" >> "$GITHUB_OUTPUT"
          echo "$DISPATCH_JSON" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          DISPATCH_EPOCH=$(jq -r '.dispatch_epoch // 0' <<<"${DISPATCH_JSON}")
          if [[ "${DISPATCH_EPOCH}" == "0" ]]; then
            echo "::error::FAC dispatch did not return a valid dispatch_epoch"
            exit 1
          fi
          echo "dispatch_epoch=${DISPATCH_EPOCH}" >> "$GITHUB_OUTPUT"

          jq -r '.results[] | "dispatch review_type=\(.review_type) mode=\(.mode)" +
            (if .unit then " unit=\(.unit)" else "" end) +
            (if .pid then " pid=\(.pid|tostring)" else "" end)' <<<"${DISPATCH_JSON}"

      - name: Project 1Hz reviewer health window
        run: |
          set -euo pipefail

          FAC_BIN="${PWD}/target/debug/apm2"
          PR_NUMBER='${{ steps.pr.outputs.pr_number }}'
          HEAD_SHA='${{ steps.pr.outputs.head_sha }}'
          DISPATCH_EPOCH='${{ steps.dispatch.outputs.dispatch_epoch }}'

          terminal_failure=0
          after_seq=0

          for _ in $(seq 1 30); do
            PROJECT_JSON=$("${FAC_BIN}" fac --json review project \
              --pr "${PR_NUMBER}" \
              --head-sha "${HEAD_SHA}" \
              --since-epoch "${DISPATCH_EPOCH}" \
              --after-seq "${after_seq}")

            if [[ -z "${PROJECT_JSON}" ]] || ! jq -e . >/dev/null 2>&1 <<<"${PROJECT_JSON}"; then
              NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              echo "ts=${NOW} security=unknown quality=unknown events=-"
              sleep 1
              continue
            fi

            NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            jq -r --arg now "${NOW}" '.line // ("ts=" + $now + " security=unknown quality=unknown events=-")' <<<"${PROJECT_JSON}"
            jq -r '.errors[]? | "ERROR ts=\(.ts) event=\(.event) review=\(.review_type) seq=\(.seq) detail=\(.detail)"' <<<"${PROJECT_JSON}"

            next_seq=$(jq -r '.last_seq // 0' <<<"${PROJECT_JSON}")
            if [[ "${next_seq}" =~ ^[0-9]+$ ]]; then
              after_seq="${next_seq}"
            fi

            if jq -e '.terminal_failure == true' >/dev/null 2>&1 <<<"${PROJECT_JSON}"; then
              terminal_failure=1
              break
            fi

            sleep 1
          done

          if [[ "${terminal_failure}" -ne 0 ]]; then
            echo "::error::Terminal FAC reviewer failure detected in projection window."
            exit 1
          fi

      # Review Gate Success status is posted exclusively by
      # .github/workflows/review-gate.yml (trusted base-branch evaluator).
      # This workflow only projects FAC execution state and review comments.

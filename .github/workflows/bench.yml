# Benchmark workflow
# Runs manually, on releases, or via PR comments
# Never blocks releases - continue-on-error is enabled

name: Benchmark

on:
  workflow_dispatch:
    inputs:
      baseline:
        description: 'Git ref to compare against (branch, tag, or SHA)'
        required: false
        default: 'main'
  push:
    tags:
      - 'v*'
  issue_comment:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  CARGO_TERM_COLOR: always

jobs:
  # Check if the comment is a benchmark trigger
  check-comment:
    name: Check Comment
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-24.04
    outputs:
      triggered: ${{ steps.check.outputs.triggered }}
      pr_number: ${{ github.event.issue.number }}
    steps:
      - name: Check for /benchmark command
        id: check
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          AUTHOR_ASSOC: ${{ github.event.comment.author_association }}
        run: |
          if [[ "$COMMENT_BODY" == "/benchmark"* ]] && \
             [[ "$AUTHOR_ASSOC" == "MEMBER" || "$AUTHOR_ASSOC" == "OWNER" || "$AUTHOR_ASSOC" == "COLLABORATOR" ]]; then
            echo "triggered=true" >> $GITHUB_OUTPUT
          else
            echo "triggered=false" >> $GITHUB_OUTPUT
          fi

  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-24.04
    # Run if: manual trigger, release tag, or /benchmark comment
    if: |
      always() && (
        github.event_name == 'workflow_dispatch' ||
        github.event_name == 'push' ||
        (github.event_name == 'issue_comment' && needs.check-comment.outputs.triggered == 'true')
      )
    needs: [check-comment]
    # Never block on failure
    continue-on-error: true
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Get PR head ref
        id: pr-ref
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.issue.number }}
            });
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          ref: ${{ steps.pr-ref.outputs.ref || github.ref }}
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # stable
        with:
          toolchain: stable

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2
        with:
          cache-on-failure: true

      - name: Install critcmp
        run: cargo install critcmp --locked

      - name: Restore baseline from cache
        id: cache-baseline
        uses: actions/cache/restore@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4
        with:
          path: target/criterion-baseline
          key: bench-baseline-main
          restore-keys: |
            bench-baseline-

      - name: Run current benchmarks
        run: |
          cargo bench --package apm2-core -- --save-baseline current

      - name: Compare with baseline
        id: compare
        run: |
          if [ -d "target/criterion-baseline" ]; then
            echo "Comparing with baseline..."
            # Copy baseline to criterion directory for comparison
            cp -r target/criterion-baseline/* target/criterion/ 2>/dev/null || true

            # Run critcmp and capture output
            COMPARISON=$(critcmp baseline current 2>&1) || true
            echo "comparison<<EOF" >> $GITHUB_OUTPUT
            echo "$COMPARISON" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "No baseline found, skipping comparison"
            echo "comparison=No baseline available for comparison" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment with results
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const comparison = `${{ steps.compare.outputs.comparison }}`;
            const body = `## Benchmark Results

            <details>
            <summary>Click to expand benchmark comparison</summary>

            \`\`\`
            ${comparison}
            \`\`\`

            </details>

            Benchmark run triggered by @${{ github.event.comment.user.login }}
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: body
            });

      - name: Upload Criterion HTML report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: criterion-report-${{ github.sha }}
          path: target/criterion
          retention-days: 30

      - name: Save baseline for main
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        run: |
          mkdir -p target/criterion-baseline
          cp -r target/criterion/* target/criterion-baseline/ 2>/dev/null || true

      - name: Update baseline cache
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        uses: actions/cache/save@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4
        with:
          path: target/criterion-baseline
          key: bench-baseline-main-${{ github.sha }}

  # Store historical data on releases
  store-history:
    name: Store Historical Data
    runs-on: ubuntu-24.04
    needs: [benchmark]
    if: startsWith(github.ref, 'refs/tags/v')
    continue-on-error: true
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Download benchmark artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: criterion-report-${{ github.sha }}
          path: benchmarks/${{ github.ref_name }}

      - name: Update history
        run: |
          VERSION="${{ github.ref_name }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Append to history file
          echo "{\"version\": \"$VERSION\", \"timestamp\": \"$TIMESTAMP\", \"sha\": \"${{ github.sha }}\"}" >> benchmarks/history.jsonl

          # Update index if it exists, or create minimal one
          if [ ! -f benchmarks/index.html ]; then
            cat > benchmarks/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>apm2 Benchmark History</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
              h1 { color: #333; }
              ul { list-style: none; padding: 0; }
              li { margin: 0.5rem 0; padding: 0.5rem; background: #f5f5f5; border-radius: 4px; }
              a { color: #0066cc; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .timestamp { color: #666; font-size: 0.9em; }
            </style>
          </head>
          <body>
            <h1>apm2 Benchmark History</h1>
            <p>Historical benchmark reports for each release.</p>
            <ul id="releases"></ul>
            <script>
              fetch('history.jsonl')
                .then(r => r.text())
                .then(text => {
                  const releases = text.trim().split('\n').map(JSON.parse).reverse();
                  const ul = document.getElementById('releases');
                  releases.forEach(r => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${r.version}/report/index.html">${r.version}</a> <span class="timestamp">${new Date(r.timestamp).toLocaleDateString()}</span>`;
                    ul.appendChild(li);
                  });
                });
            </script>
          </body>
          </html>
          HTMLEOF
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "integrations.anveio@gmail.com"
          git add benchmarks/
          git commit -m "Add benchmark results for ${{ github.ref_name }}" || echo "No changes to commit"
          git push

name: Forge Admission Cycle

on:
  pull_request_target:
    branches: [main]
    types: [opened, reopened, synchronize, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to process"
        required: true
        type: string

concurrency:
  group: forge-admission-cycle-${{ github.event_name == 'pull_request_target' && github.event.pull_request.number || github.event.inputs.pr_number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: -D warnings
  RUST_BACKTRACE: 1

jobs:
  barrier:
    name: Guardian Intelligence / Barrier
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - name: Validate trigger trust boundary (fast path)
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail

          fail() {
            echo "barrier: $1" >&2
            exit 1
          }

          event_name="$GITHUB_EVENT_NAME"
          repo="$GITHUB_REPOSITORY"
          actor="$GITHUB_ACTOR"

          case "$event_name" in
            pull_request_target)
              pr_number="$(jq -r '.pull_request.number // 0' "$GITHUB_EVENT_PATH")"
              association="$(jq -r '.pull_request.author_association // ""' "$GITHUB_EVENT_PATH")"
              [[ "$pr_number" != "0" ]] || fail "missing pull_request.number in event payload"
              case "$association" in
                OWNER|MEMBER|COLLABORATOR) ;;
                *)
                  fail "unauthorized pull_request_target author_association=$association for PR #$pr_number"
                  ;;
              esac
              echo "barrier: authorized pull_request_target pr=$pr_number association=$association"
              ;;
            workflow_dispatch)
              pr_number="$(jq -r '.inputs.pr_number // .client_payload.pr_number // empty' "$GITHUB_EVENT_PATH")"
              [[ -n "$pr_number" ]] || fail "workflow_dispatch requires inputs.pr_number"

              pr_json="$(gh api "repos/$repo/pulls/$pr_number")" || fail "failed to load PR #$pr_number"
              base_ref="$(jq -r '.base.ref // empty' <<<"$pr_json")"
              [[ -n "$base_ref" ]] || fail "PR #$pr_number missing base.ref"

              default_branch="$(gh api "repos/$repo" --jq '.default_branch')"
              dispatch_ref="${GITHUB_REF_NAME:-}"
              [[ -n "$dispatch_ref" ]] || fail "missing GITHUB_REF_NAME for workflow_dispatch"
              if [[ "$dispatch_ref" != "$base_ref" && "$dispatch_ref" != "$default_branch" ]]; then
                fail "workflow_dispatch ref=$dispatch_ref is not trusted (base=$base_ref default=$default_branch)"
              fi

              permission="$(gh api "repos/$repo/collaborators/$actor/permission" --jq '.permission // empty' 2>/dev/null || true)"
              case "$permission" in
                admin|maintain|write) ;;
                *)
                  fail "workflow_dispatch actor=$actor lacks permission (need write|maintain|admin, got ${permission:-none})"
                  ;;
              esac
              echo "barrier: authorized workflow_dispatch pr=$pr_number ref=$dispatch_ref actor_permission=$permission"
              ;;
            *)
              fail "unsupported event_name=$event_name"
              ;;
          esac

  forge-admission-cycle:
    name: apm2 / Forge Admission Cycle
    needs: [barrier]
    runs-on: [self-hosted, linux, x64, fac-ovh]
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2

      - name: Kick off FAC and project health
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          # SECURITY-CRITICAL LOGGING BOUNDARY:
          # GitHub Actions logs are a public projection surface. Treat stdout as
          # untrusted egress and fail closed if any non-health line appears.
          private_log_dir="${HOME}/.apm2/private/fac"
          mkdir -p "${private_log_dir}"
          chmod 700 "${private_log_dir}"
          private_log="${private_log_dir}/github-run-${GITHUB_RUN_ID:-unknown}-${GITHUB_RUN_ATTEMPT:-0}.log"
          : >"${private_log}"
          chmod 600 "${private_log}"

          health_line_re='^ts=[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z security=[^[:space:]]+ quality=[^[:space:]]+ events=.*$'

          set +e
          cargo run --locked --quiet -p apm2-cli -- fac kickoff \
            --repo "${{ github.repository }}" \
            --event "${{ github.event_path }}" \
            --event-name "${{ github.event_name }}" \
            --max-wait-seconds 3600 \
            --public-projection-only \
            2>>"${private_log}" | \
            awk -v health_line_re="${health_line_re}" '
              $0 ~ health_line_re {
                print $0
                fflush(stdout)
                next
              }
              {
                # SECURITY-CRITICAL: never echo rejected lines (possible secret egress).
                print "ERROR: FAC output boundary violation (non-health line blocked)." > "/dev/stderr"
                exit 42
              }
            '
          fac_rc=${PIPESTATUS[0]}
          filter_rc=${PIPESTATUS[1]}
          set -e

          if [[ "${filter_rc}" -ne 0 ]]; then
            echo "ERROR: FAC projection boundary violation. See private runner log: ${private_log}" >&2
            exit 1
          fi
          if [[ "${fac_rc}" -ne 0 ]]; then
            echo "ERROR: FAC failed. See private runner log: ${private_log}" >&2
            exit "${fac_rc}"
          fi
